<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generating Documents â€” HenryAI</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Instrument+Serif:ital@0;1&family=DM+Sans:opsz,wght@9..40,400;9..40,500;9..40,600&display=swap" rel="stylesheet">
    <style>
        :root {
            --color-bg: #0a0a0b;
            --color-text: #fafafa;
            --color-text-secondary: #a1a1aa;
            --font-display: 'Instrument Serif', Georgia, serif;
            --font-body: 'DM Sans', -apple-system, sans-serif;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-body);
            background: var(--color-bg);
            color: var(--color-text);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            -webkit-font-smoothing: antialiased;
        }

        .logo-container {
            margin-bottom: 48px;
        }

        .logo-svg {
            width: 160px;
            height: 160px;
        }

        /* Dot animation - bounces in and out of circle */
        @keyframes dotBounce {
            0%, 100% {
                transform: translate(0, 0);
            }
            25% {
                transform: translate(12px, -12px);
            }
            50% {
                transform: translate(0, 0);
            }
            75% {
                transform: translate(-8px, 8px);
            }
        }

        .peak-dot {
            animation: dotBounce 2.5s ease-in-out infinite;
            transform-origin: center;
        }

        /* Subtle pulse on the ring */
        @keyframes ringPulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.7;
            }
        }

        .ring-circle {
            animation: ringPulse 3s ease-in-out infinite;
        }

        .status-container {
            text-align: center;
        }

        .status-text {
            font-size: 1.1rem;
            color: var(--color-text);
            margin-bottom: 12px;
            min-height: 28px;
        }

        .status-subtext {
            font-size: 0.9rem;
            color: var(--color-text-secondary);
        }

        /* Progress dots */
        .progress-dots {
            display: flex;
            gap: 8px;
            justify-content: center;
            margin-top: 32px;
        }

        .progress-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
        }

        .progress-dot.active {
            background: #764ba2;
        }

        .progress-dot.completed {
            background: #667eea;
        }

        /* Error state */
        .error-message {
            display: none;
            text-align: center;
            margin-top: 24px;
        }

        .error-message.show {
            display: block;
        }

        .error-message p {
            color: #f87171;
            margin-bottom: 16px;
        }

        .error-message button {
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: var(--color-text);
            padding: 10px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-family: var(--font-body);
            font-size: 0.9rem;
            transition: all 0.2s ease;
        }

        .error-message button:hover {
            border-color: rgba(255, 255, 255, 0.4);
            background: rgba(255, 255, 255, 0.05);
        }
    </style>
    <link rel="stylesheet" href="css/mobile.css">
</head>
<body>
    <div class="logo-container">
        <svg class="logo-svg" viewBox="0 0 200 200" fill="none" xmlns="http://www.w3.org/2000/svg">
            <defs>
                <linearGradient id="ringGradient" x1="0%" y1="100%" x2="100%" y2="0%">
                    <stop offset="0%" style="stop-color:#667eea;stop-opacity:1" />
                    <stop offset="100%" style="stop-color:#764ba2;stop-opacity:1" />
                </linearGradient>

                <linearGradient id="strokeGradient" x1="0%" y1="100%" x2="100%" y2="0%">
                    <stop offset="0%" style="stop-color:#667eea;stop-opacity:1" />
                    <stop offset="100%" style="stop-color:#764ba2;stop-opacity:1" />
                </linearGradient>
            </defs>

            <!-- Thin ring -->
            <circle class="ring-circle" cx="100" cy="100" r="85"
                    stroke="url(#ringGradient)"
                    stroke-width="4"
                    fill="none"/>

            <!-- Left vertical (grounded) -->
            <path d="M55 130 L55 70"
                  stroke="#667eea"
                  stroke-width="9"
                  stroke-linecap="round"
                  fill="none"/>

            <!-- Right vertical (ascending) -->
            <path d="M145 130 L145 50"
                  stroke="url(#strokeGradient)"
                  stroke-width="9"
                  stroke-linecap="round"
                  fill="none"/>

            <!-- Horizontal connector -->
            <path d="M55 100 L145 100"
                  stroke="#764ba2"
                  stroke-width="9"
                  stroke-linecap="round"
                  fill="none"/>

            <!-- Peak dot (animated) -->
            <circle class="peak-dot" cx="145" cy="50" r="9" fill="#764ba2"/>
        </svg>
    </div>

    <div class="status-container">
        <div class="status-text" id="statusText">Crafting your resume...</div>
        <div class="status-subtext" id="statusSubtext">This usually takes 30-60 seconds</div>

        <div class="progress-dots">
            <div class="progress-dot active" id="dot1"></div>
            <div class="progress-dot" id="dot2"></div>
            <div class="progress-dot" id="dot3"></div>
            <div class="progress-dot" id="dot4"></div>
        </div>
    </div>

    <div class="error-message" id="errorMessage">
        <p id="errorText">Something went wrong. Please try again.</p>
        <button onclick="goBack()">Go Back</button>
    </div>

    <script>
        const API_BASE_URL = window.location.hostname === 'localhost'
            ? 'http://localhost:8000'
            : 'https://henryai-app-production.up.railway.app';

        const statusText = document.getElementById('statusText');
        const statusSubtext = document.getElementById('statusSubtext');
        const errorMessage = document.getElementById('errorMessage');
        const errorText = document.getElementById('errorText');

        const stages = [
            { text: 'Crafting your resume...', subtext: 'Tailoring content to the role', dot: 1 },
            { text: 'Writing your cover letter...', subtext: 'Highlighting your strengths', dot: 2 },
            { text: 'Preparing interview talking points...', subtext: 'Building your story', dot: 3 },
            { text: 'Finalizing your package...', subtext: 'Almost there', dot: 4 }
        ];

        let currentStage = 0;

        function updateStage(stageIndex) {
            if (stageIndex >= stages.length) return;

            const stage = stages[stageIndex];
            statusText.textContent = stage.text;
            statusSubtext.textContent = stage.subtext;

            // Update dots
            for (let i = 1; i <= 4; i++) {
                const dot = document.getElementById(`dot${i}`);
                dot.classList.remove('active', 'completed');
                if (i < stage.dot) {
                    dot.classList.add('completed');
                } else if (i === stage.dot) {
                    dot.classList.add('active');
                }
            }
        }

        function showError(message) {
            errorText.textContent = message;
            errorMessage.classList.add('show');
            statusText.textContent = 'Generation failed';
            statusSubtext.textContent = '';
        }

        function goBack() {
            window.location.href = 'strengthen.html';
        }

        // Progress through stages while waiting
        function startProgressAnimation() {
            // Stage 2 after 8 seconds
            setTimeout(() => updateStage(1), 8000);
            // Stage 3 after 20 seconds
            setTimeout(() => updateStage(2), 20000);
            // Stage 4 after 40 seconds
            setTimeout(() => updateStage(3), 40000);
        }

        async function generateDocuments() {
            // Get analysis data
            const analysisDataStr = sessionStorage.getItem('analysisData');
            if (!analysisDataStr) {
                showError('No analysis data found. Please start over.');
                return;
            }

            const analysisData = JSON.parse(analysisDataStr);

            // Get supplements from sessionStorage
            const supplementsStr = sessionStorage.getItem('supplements');
            const supplements = supplementsStr ? JSON.parse(supplementsStr) : [];

            startProgressAnimation();

            try {
                // Build request payload for document generation
                const requestPayload = {
                    resume: analysisData._resume_json || {},
                    jd_analysis: {
                        role_title: analysisData.role_title || analysisData._role || '',
                        company_name: analysisData._company_name || analysisData._company || '',
                        job_description: analysisData._jd_text || '',
                        fit_score: analysisData.fit_score || 50,
                        strengths: analysisData.strengths || [],
                        gaps: analysisData.gaps || [],
                        intelligence_layer: analysisData.intelligence_layer || {}
                    },
                    preferences: analysisData._profile || {},
                    supplements: supplements.length > 0 ? supplements : undefined
                };

                console.log('Generating documents with payload:', requestPayload);

                const response = await fetch(`${API_BASE_URL}/api/documents/generate`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestPayload)
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.detail || `Document generation failed (${response.status})`);
                }

                const documentsData = await response.json();
                console.log('Documents generated:', documentsData);

                // Store documents data in sessionStorage
                sessionStorage.setItem('documentsData', JSON.stringify(documentsData));

                // Also persist to localStorage for later access
                const companyName = analysisData._company_name || analysisData._company || 'Unknown';
                const roleTitle = analysisData.role_title || analysisData._role || 'Unknown';
                const documentsKey = `documents_${companyName}_${roleTitle}`.toLowerCase().replace(/[^a-z0-9_]/g, '_');
                localStorage.setItem(documentsKey, JSON.stringify({
                    ...documentsData,
                    _company: companyName,
                    _role: roleTitle,
                    _generatedAt: new Date().toISOString()
                }));

                // Clear supplements after use
                sessionStorage.removeItem('supplements');
                sessionStorage.removeItem('originalGaps');

                // Go to Application Strategy Overview
                window.location.href = 'overview.html';

            } catch (error) {
                console.error('Error generating documents:', error);

                let errorMsg = 'Something went wrong. Please try again.';
                if (error.name === 'TypeError' && error.message === 'Failed to fetch') {
                    errorMsg = 'Unable to connect to the server. Please check your connection and try again.';
                } else if (error.message) {
                    errorMsg = error.message;
                }

                showError(errorMsg);
            }
        }

        // Start generation when page loads
        generateDocuments();
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Analyze a Role ‚Äî HenryAI</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Instrument+Serif:ital@0;1&family=DM+Sans:opsz,wght@9..40,400;9..40,500;9..40,600&display=swap" rel="stylesheet">

  <style>
    :root {
      --color-bg: #0a0a0b;
      --color-surface: #141416;
      --color-surface-elevated: #1c1c1f;
      --color-border: rgba(255, 255, 255, 0.08);
      --color-border-hover: rgba(255, 255, 255, 0.15);
      --color-text: #fafafa;
      --color-text-secondary: #a1a1aa;
      --color-accent: #22d3ee;
      --color-accent-muted: rgba(34, 211, 238, 0.15);
      --color-success: #4ade80;
      --color-warning: #fbbf24;
      --color-error: #f87171;
      --font-display: 'Instrument Serif', Georgia, serif;
      --font-body: 'DM Sans', -apple-system, sans-serif;
      --ease-out: cubic-bezier(0.16, 1, 0.3, 1);
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: var(--font-body);
      background: var(--color-bg);
      color: var(--color-text);
      line-height: 1.6;
      -webkit-font-smoothing: antialiased;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    .container {
      max-width: 700px;
      margin: 0 auto;
      padding: 0 20px;
      width: 100%;
    }

    /* ========== HEADER ========== */
    header {
      padding: 24px 0;
      border-bottom: 1px solid var(--color-border);
    }

    header .container {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .logo {
      font-family: var(--font-display);
      font-size: 1.5rem;
      color: var(--color-text);
      text-decoration: none;
    }

    .logo em {
      font-style: italic;
      color: var(--color-accent);
    }

    .header-nav {
      display: flex;
      gap: 24px;
      align-items: center;
    }

    .nav-link {
      color: var(--color-text-secondary);
      text-decoration: none;
      font-size: 0.9rem;
      transition: color 0.2s ease;
    }

    .nav-link:hover {
      color: var(--color-accent);
    }

    /* ========== PROFILE BANNER ========== */
    .profile-banner {
      background: var(--color-surface);
      border: 1px solid var(--color-border);
      border-radius: 12px;
      padding: 16px 20px;
      margin-bottom: 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .profile-info {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .profile-avatar {
      width: 44px;
      height: 44px;
      background: var(--color-accent-muted);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.3rem;
    }

    .profile-details {
      display: flex;
      flex-direction: column;
    }

    .profile-name {
      font-weight: 600;
      font-size: 1rem;
      color: var(--color-text);
    }

    .profile-meta {
      font-size: 0.85rem;
      color: var(--color-text-secondary);
    }

    .profile-change {
      color: var(--color-text-secondary);
      text-decoration: none;
      font-size: 0.85rem;
      padding: 8px 16px;
      border: 1px solid var(--color-border);
      border-radius: 8px;
      transition: all 0.2s;
    }

    .profile-change:hover {
      color: var(--color-accent);
      border-color: var(--color-accent);
    }

    /* ========== NO PROFILE STATE ========== */
    .no-profile {
      background: var(--color-surface);
      border: 1px solid var(--color-border);
      border-radius: 16px;
      padding: 40px;
      text-align: center;
      margin-bottom: 24px;
    }

    .no-profile-icon {
      font-size: 3rem;
      margin-bottom: 16px;
    }

    .no-profile h2 {
      font-family: var(--font-display);
      font-size: 1.5rem;
      font-weight: 400;
      margin-bottom: 12px;
    }

    .no-profile p {
      color: var(--color-text-secondary);
      margin-bottom: 24px;
      max-width: 400px;
      margin-left: auto;
      margin-right: auto;
    }

    .no-profile .btn-primary {
      width: auto;
      padding: 16px 48px;
      cursor: pointer;
    }

    /* ========== MAIN ========== */
    main {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 60px 0;
    }

    .analyzer-card {
      width: 100%;
      text-align: center;
    }

    .analyzer-card .profile-banner {
      text-align: left;
    }

    .analyzer-card h1 {
      font-family: var(--font-display);
      font-size: clamp(1.75rem, 5vw, 2.5rem);
      font-weight: 400;
      margin-bottom: 12px;
    }

    .analyzer-card h1 em {
      font-style: italic;
      color: var(--color-accent);
    }

    .analyzer-card > p {
      color: var(--color-text-secondary);
      font-size: 1.05rem;
      margin-bottom: 32px;
    }

    /* ========== INPUT AREA ========== */
    .input-area {
      background: var(--color-surface);
      border: 1px solid var(--color-border);
      border-radius: 16px;
      padding: 28px;
      margin-bottom: 24px;
      text-align: left;
    }

    .input-group {
      margin-bottom: 24px;
    }

    .input-group:last-child {
      margin-bottom: 0;
    }

    .input-group label {
      display: block;
      font-size: 0.9rem;
      font-weight: 500;
      color: var(--color-text-secondary);
      margin-bottom: 10px;
    }

    textarea {
      width: 100%;
      min-height: 200px;
      padding: 16px;
      background: var(--color-bg);
      border: 1px solid var(--color-border);
      border-radius: 10px;
      color: var(--color-text);
      font-family: var(--font-body);
      font-size: 0.95rem;
      line-height: 1.6;
      resize: vertical;
      transition: border-color 0.2s ease;
    }

    textarea:focus {
      outline: none;
      border-color: var(--color-accent);
    }

    textarea::placeholder {
      color: var(--color-text-secondary);
      opacity: 0.7;
    }

    /* ========== INPUT METHOD TOGGLE ========== */
    .input-method-toggle {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
    }

    .input-method-btn {
      flex: 1;
      padding: 12px 16px;
      background: var(--color-bg);
      border: 1px solid var(--color-border);
      border-radius: 8px;
      color: var(--color-text-secondary);
      font-family: var(--font-body);
      font-size: 0.9rem;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .input-method-btn:hover {
      border-color: var(--color-border-hover);
      color: var(--color-text);
    }

    .input-method-btn.active {
      background: var(--color-accent-muted);
      border-color: var(--color-accent);
      color: var(--color-accent);
    }

    .input-method-btn .icon {
      font-size: 1.1rem;
    }

    /* URL Input */
    .url-input-wrapper {
      display: none;
    }

    .url-input-wrapper.active {
      display: block;
    }

    .url-input {
      width: 100%;
      padding: 16px;
      background: var(--color-bg);
      border: 1px solid var(--color-border);
      border-radius: 10px;
      color: var(--color-text);
      font-family: var(--font-body);
      font-size: 0.95rem;
      transition: border-color 0.2s ease;
    }

    .url-input:focus {
      outline: none;
      border-color: var(--color-accent);
    }

    .url-input::placeholder {
      color: var(--color-text-secondary);
      opacity: 0.7;
    }

    .url-warning {
      margin-top: 12px;
      padding: 12px 16px;
      background: rgba(251, 191, 36, 0.1);
      border: 1px solid rgba(251, 191, 36, 0.3);
      border-radius: 8px;
      font-size: 0.85rem;
      color: var(--color-warning);
      line-height: 1.5;
    }

    .url-warning-icon {
      margin-right: 6px;
    }

    .extract-btn {
      margin-top: 12px;
      width: 100%;
      padding: 14px 20px;
      background: var(--color-surface-elevated);
      border: 1px solid var(--color-border);
      border-radius: 8px;
      color: var(--color-text);
      font-family: var(--font-body);
      font-size: 0.9rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .extract-btn:hover:not(:disabled) {
      border-color: var(--color-accent);
      color: var(--color-accent);
    }

    .extract-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .extract-btn .spinner-small {
      width: 16px;
      height: 16px;
      border: 2px solid var(--color-border);
      border-top-color: var(--color-accent);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    .extraction-status {
      margin-top: 12px;
      padding: 12px 16px;
      border-radius: 8px;
      font-size: 0.85rem;
      line-height: 1.5;
      display: none;
    }

    .extraction-status.success {
      display: block;
      background: rgba(74, 222, 128, 0.1);
      border: 1px solid rgba(74, 222, 128, 0.3);
      color: var(--color-success);
    }

    .extraction-status.error {
      display: block;
      background: rgba(248, 113, 113, 0.1);
      border: 1px solid rgba(248, 113, 113, 0.3);
      color: var(--color-error);
    }

    .textarea-wrapper {
      display: block;
    }

    .textarea-wrapper.hidden {
      display: none;
    }

    /* ========== BUTTONS ========== */
    .btn-primary {
      width: 100%;
      padding: 16px 28px;
      background: var(--color-accent);
      color: #0a0a0b;
      border: none;
      border-radius: 10px;
      font-family: var(--font-body);
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s var(--ease-out), box-shadow 0.2s var(--ease-out);
    }

    .btn-primary:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(34, 211, 238, 0.25);
    }

    .btn-primary:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    /* ========== LOADING & ERROR ========== */
    .loading {
      display: none;
      flex-direction: column;
      align-items: center;
      gap: 16px;
      margin-top: 24px;
    }

    .loading.active {
      display: flex;
    }

    .spinner {
      width: 36px;
      height: 36px;
      border: 3px solid var(--color-border);
      border-top-color: var(--color-accent);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .loading-text {
      color: var(--color-text-secondary);
      font-size: 0.95rem;
    }

    .error {
      display: none;
      margin-top: 16px;
      padding: 14px 18px;
      background: rgba(248, 113, 113, 0.1);
      border: 1px solid rgba(248, 113, 113, 0.3);
      border-radius: 10px;
      color: var(--color-error);
      font-size: 0.9rem;
      text-align: left;
    }

    .error.active {
      display: block;
    }

    @media (max-width: 640px) {
      main {
        padding: 40px 0;
      }

      .profile-banner {
        flex-direction: column;
        gap: 16px;
        text-align: center;
      }

      .profile-info {
        flex-direction: column;
      }
    }

    /* ========== CLARIFYING QUESTIONS MODAL ========== */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.85);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 20px;
      overflow-y: auto;
    }

    .modal-overlay.show {
      display: flex;
    }

    .modal.clarifying-modal {
      background: var(--color-surface);
      border: 1px solid var(--color-border);
      border-radius: 16px;
      padding: 32px;
      max-width: 600px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
    }

    .modal-header {
      text-align: center;
      margin-bottom: 24px;
    }

    .modal-icon {
      font-size: 2.5rem;
      margin-bottom: 12px;
    }

    .modal-header h2 {
      font-family: var(--font-display);
      font-size: 1.5rem;
      font-weight: 400;
      color: var(--color-text);
      margin-bottom: 8px;
    }

    .modal-subtitle {
      color: var(--color-text-secondary);
      font-size: 0.95rem;
      line-height: 1.6;
    }

    .clarifying-questions-container {
      display: flex;
      flex-direction: column;
      gap: 20px;
      margin-bottom: 24px;
    }

    .clarifying-question-card {
      background: var(--color-surface-elevated);
      border: 1px solid var(--color-border);
      border-radius: 12px;
      padding: 20px;
    }

    .clarifying-question-label {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--color-accent);
      margin-bottom: 8px;
      font-weight: 600;
    }

    .clarifying-question-text {
      font-size: 1rem;
      color: var(--color-text);
      line-height: 1.6;
      margin-bottom: 12px;
    }

    .clarifying-question-hint {
      font-size: 0.85rem;
      color: var(--color-text-secondary);
      margin-bottom: 12px;
      font-style: italic;
    }

    .clarifying-question-input {
      width: 100%;
      min-height: 80px;
      padding: 12px 16px;
      background: var(--color-bg);
      border: 1px solid var(--color-border);
      border-radius: 8px;
      color: var(--color-text);
      font-family: var(--font-body);
      font-size: 0.9rem;
      line-height: 1.6;
      resize: vertical;
    }

    .clarifying-question-input:focus {
      outline: none;
      border-color: var(--color-accent);
    }

    .clarifying-question-input::placeholder {
      color: var(--color-text-secondary);
    }

    .modal-actions {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-bottom: 16px;
    }

    .modal-actions .btn-primary {
      background: var(--color-accent);
      color: var(--color-bg);
    }

    .modal-actions .btn-primary:hover:not(:disabled) {
      background: #5eead4;
      transform: translateY(-2px);
    }

    .modal-actions .btn-secondary {
      background: transparent;
      color: var(--color-text-secondary);
      border: 1px solid var(--color-border);
    }

    .modal-actions .btn-secondary:hover {
      color: var(--color-text);
      border-color: var(--color-text-secondary);
    }

    .clarifying-note {
      text-align: center;
      font-size: 0.8rem;
      color: var(--color-text-secondary);
    }

    @media (max-width: 600px) {
      .modal.clarifying-modal {
        padding: 20px;
        margin: 10px;
      }

      .modal-actions {
        flex-direction: column;
      }
    }
  </style>
  <link rel="stylesheet" href="css/mobile.css">
  <!-- Beta Access Gate -->
  <script>
      if (localStorage.getItem('beta_verified') !== 'true') {
          window.location.href = 'beta-access.html';
      }
  </script>
</head>

<body>

  <!-- ========== HEADER ========== -->
  <header>
    <div class="container">
      <a href="index.html" class="logo"><em>Henry</em>AI</a>
    </div>
  </header>

  <!-- ========== MAIN ========== -->
  <main>
    <div class="container">
      <!-- No Profile State (shown if no profile) -->
      <div class="no-profile" id="noProfileState" style="display: none;">
        <div class="no-profile-icon">üëã</div>
        <h2>Before we dive in...</h2>
        <p>I need to know a bit about you and where you're at. This helps me give you advice that actually fits your situation, not generic career-coach nonsense.</p>
        <button class="btn-primary" id="goToProfileBtn">Let's go</button>
      </div>

      <!-- Analyzer Card (shown if profile exists) -->
      <div class="analyzer-card" id="analyzerCard" style="display: none;">
        <h1>Should you apply to <em>this role</em>?</h1>
        <p>Paste the job description. I will tell you if it is worth your time and build your application if it is.</p>

        <!-- Profile Banner -->
        <div class="profile-banner" id="profileBanner">
          <div class="profile-info">
            <div class="profile-avatar">üë§</div>
            <div class="profile-details">
              <div class="profile-name" id="profileName">Loading...</div>
              <div class="profile-meta" id="profileMeta">Profile loaded</div>
            </div>
          </div>
        </div>

        <div class="input-area">
          <!-- Input Method Toggle -->
          <div class="input-method-toggle">
            <button type="button" class="input-method-btn active" id="pasteMethodBtn" data-method="paste">
              <span class="icon">üìã</span>
              <span>Paste Text</span>
            </button>
            <button type="button" class="input-method-btn" id="urlMethodBtn" data-method="url">
              <span class="icon">üîó</span>
              <span>Job URL</span>
            </button>
          </div>

          <!-- Job Description Input -->
          <div class="input-group">
            <label for="jobDescription">Job Description</label>

            <!-- Paste method (default) -->
            <div class="textarea-wrapper" id="pasteWrapper">
              <textarea
                id="jobDescription"
                placeholder="Paste the full job description here..."
              ></textarea>
            </div>

            <!-- URL method -->
            <div class="url-input-wrapper" id="urlWrapper">
              <input
                type="url"
                class="url-input"
                id="jobUrl"
                placeholder="https://jobs.lever.co/company/job-id or linkedin.com/jobs/..."
              />
              <div class="url-warning">
                <span class="url-warning-icon">‚ö†Ô∏è</span>
                <strong>Heads up:</strong> URL extraction works best with LinkedIn, Lever, Greenhouse, and most job boards. Some sites may block automated access. For best results, review the extracted text before analyzing.
              </div>
              <button type="button" class="extract-btn" id="extractBtn">
                <span class="extract-text">Extract Job Description</span>
              </button>
              <div class="extraction-status" id="extractionStatus"></div>
            </div>
          </div>
        </div>

        <button id="analyzeBtn" class="btn-primary">Analyze This Role</button>

        <div class="loading" id="loading">
          <div class="spinner"></div>
          <p class="loading-text">Analyzing fit and building your strategy...</p>
        </div>

        <div class="error" id="error"></div>
      </div>
    </div>
  </main>

  <!-- CLARIFYING QUESTIONS MODAL -->
  <div class="modal-overlay" id="clarifyingModal">
    <div class="modal clarifying-modal">
      <div class="modal-header">
        <div class="modal-icon">üí°</div>
        <h2 id="clarifyingTitle">Quick questions</h2>
        <p id="clarifyingIntro" class="modal-subtitle">Help me understand your background better...</p>
      </div>

      <div class="clarifying-questions-container" id="clarifyingQuestionsContainer">
        <!-- Questions will be dynamically inserted here -->
      </div>

      <div class="modal-actions">
        <button class="btn-primary" id="submitClarifyingBtn">Update My Fit Score</button>
        <button class="btn-secondary" id="skipClarifyingBtn">Skip - Use Current Score</button>
      </div>

      <p class="clarifying-note">Your answers help create a more accurate fit score and better-tailored documents.</p>
    </div>
  </div>

  <script>
    // ========================================================================
    // CONFIGURATION
    // ========================================================================
    const API_BASE_URL = window.location.hostname === 'localhost'
      ? 'http://localhost:8000'
      : 'https://henryai-app-production.up.railway.app';

    // ========================================================================
    // PROFILE MANAGEMENT
    // ========================================================================
    let userProfile = null;

    function loadProfile() {
      try {
        const stored = localStorage.getItem('userProfile');
        if (!stored) {
          showNoProfileState();
          return null;
        }

        userProfile = JSON.parse(stored);
        
        // Validate profile has required data
        if (!userProfile.resume || !userProfile.resume.contact) {
          showNoProfileState();
          return null;
        }

        showAnalyzerState();
        return userProfile;

      } catch (e) {
        console.error('Error loading profile:', e);
        showNoProfileState();
        return null;
      }
    }

    function showNoProfileState() {
      document.getElementById('noProfileState').style.display = 'block';
      document.getElementById('analyzerCard').style.display = 'none';
      const editLink = document.getElementById('editProfileLink');
      if (editLink) editLink.style.display = 'none';
    }

    function showAnalyzerState() {
      document.getElementById('noProfileState').style.display = 'none';
      document.getElementById('analyzerCard').style.display = 'block';
      const editLink = document.getElementById('editProfileLink');
      if (editLink) editLink.style.display = 'block';

      // Populate profile banner
      const resume = userProfile.resume;
      const contact = resume.contact || {};
      
      const name = contact.full_name || resume.full_name || 'Your Profile';
      document.getElementById('profileName').textContent = name;

      // Build meta text: Comp ¬∑ Level ¬∑ Function Area
      const metaParts = [];
      
      // Add compensation target
      if (userProfile.compensation && userProfile.compensation.target) {
        metaParts.push(`$${(userProfile.compensation.target / 1000).toFixed(0)}K target`);
      }

      // Infer level from title
      const title = resume.current_title || (resume.experience && resume.experience[0]?.title) || '';
      const titleLower = title.toLowerCase();
      
      let level = null;
      if (titleLower.includes('chief') || titleLower.includes('ceo') || titleLower.includes('cto') || titleLower.includes('cfo') || titleLower.includes('coo') || titleLower.includes('cmo')) {
        level = 'C-Level';
      } else if (titleLower.includes('vp') || titleLower.includes('vice president')) {
        level = 'VP';
      } else if (titleLower.includes('senior director')) {
        level = 'Senior Director';
      } else if (titleLower.includes('director') || titleLower.includes('head of')) {
        level = 'Director';
      } else if (titleLower.includes('senior manager')) {
        level = 'Senior Manager';
      } else if (titleLower.includes('manager') || titleLower.includes('lead')) {
        level = 'Manager';
      } else if (titleLower.includes('senior') || titleLower.includes('staff') || titleLower.includes('principal')) {
        level = 'Senior IC';
      } else if (titleLower.includes('associate') || titleLower.includes('junior') || titleLower.includes('entry')) {
        level = 'Entry Level';
      } else if (title) {
        level = 'IC';
      }
      
      if (level) {
        metaParts.push(level);
      }

      // Infer function area from title or industries
      let functionArea = null;
      const functionKeywords = {
        'Talent Acquisition': ['talent acquisition', 'recruiting', 'recruiter', 'ta ', 'sourcing'],
        'Human Resources': ['human resources', 'hr ', 'people operations', 'people ops', 'hrbp'],
        'Engineering': ['engineer', 'engineering', 'developer', 'software', 'swe', 'backend', 'frontend', 'fullstack'],
        'Product': ['product manager', 'product management', 'pm', 'product lead'],
        'Design': ['design', 'ux', 'ui', 'creative'],
        'Marketing': ['marketing', 'growth', 'brand', 'content'],
        'Sales': ['sales', 'account executive', 'ae ', 'business development', 'bd '],
        'Finance': ['finance', 'accounting', 'fp&a', 'controller'],
        'Operations': ['operations', 'ops', 'supply chain', 'logistics'],
        'Data': ['data scientist', 'data analyst', 'analytics', 'data engineer', 'ml ', 'machine learning'],
        'Legal': ['legal', 'counsel', 'attorney', 'lawyer'],
        'Customer Success': ['customer success', 'cs ', 'client success', 'account manager']
      };
      
      for (const [func, keywords] of Object.entries(functionKeywords)) {
        if (keywords.some(kw => titleLower.includes(kw))) {
          functionArea = func;
          break;
        }
      }
      
      // Fallback to industries if no function found
      if (!functionArea && resume.industries && resume.industries.length > 0) {
        functionArea = resume.industries[0];
      }
      
      if (functionArea) {
        metaParts.push(functionArea);
      }

      document.getElementById('profileMeta').textContent = metaParts.join(' ¬∑ ') || 'Profile loaded';
    }

    // ========================================================================
    // HELPERS
    // ========================================================================
    function showError(message) {
      const errorDiv = document.getElementById('error');
      errorDiv.textContent = message;
      errorDiv.classList.add('active');
    }

    function hideError() {
      document.getElementById('error').classList.remove('active');
    }

    function extractCompanyAndRole(jdText) {
      let company = '';
      let role = '';
      
      // Extract company from JD text
      const companyMatch = jdText.match(/(?:About|Join|At)\s+([A-Z][A-Za-z0-9\s&]+?)(?:\s+is|\s+we|\s*,|\s*\.)/);
      if (companyMatch) {
        company = companyMatch[1].trim();
      } else {
        company = 'Company';
      }
      
      // Extract role from JD text
      const roleMatch = jdText.match(/(?:Title|Position|Role):\s*([^\n]+)/i);
      if (roleMatch) {
        role = roleMatch[1].trim();
      } else {
        const lines = jdText.split('\n').slice(0, 10);
        for (const line of lines) {
          if (line.match(/\b(Manager|Director|Lead|Engineer|Recruiter|Specialist|Analyst|Head|VP|Chief|Coordinator)\b/i)) {
            role = line.trim().substring(0, 60);
            break;
          }
        }
        if (!role) role = 'Role';
      }
      
      return { company, role };
    }

    // ========================================================================
    // ANALYZE BUTTON HANDLER
    // ========================================================================
    document.getElementById('analyzeBtn').addEventListener('click', async () => {
      hideError();

      // Get resume from profile (ONLY source of resume data)
      if (!userProfile || !userProfile.resume) {
        showError('Profile not loaded. Please set up your profile first.');
        return;
      }

      const resumeJson = userProfile.resume;
      const jobDescription = document.getElementById('jobDescription').value.trim();

      if (!jobDescription) {
        showError('Please paste the job description.');
        return;
      }

      // Extract company and role from JD
      const { company, role } = extractCompanyAndRole(jobDescription);
      const candidateName = resumeJson.contact?.full_name || 'Candidate';

      console.log('Analyzing for:', candidateName, '|', company, '|', role);

      // Build request payload using new accuracy pipeline structure
      const requestPayload = {
        company: company,
        role_title: role,
        job_description: jobDescription,
        resume: {
          ...resumeJson,
          resume_text: buildResumeTextFromJson(resumeJson),
          full_name: candidateName
        },
        preferences: {
          compensation: userProfile.compensation,
          location: userProfile.location,
          pronouns: userProfile.pronouns,
          situation: userProfile.situation  // For tone calibration
        },
        profile: {
          compensation: userProfile.compensation,
          location: userProfile.location,
          pronouns: userProfile.pronouns,
          urgency: userProfile.urgency,
          employment_status: userProfile.employment_status,
          risk_tolerance: userProfile.risk_tolerance,
          career_stage: userProfile.career_stage
        }
      };

      // Store data for the analyzing page to use
      const pendingData = {
        requestPayload,
        resumeJson,
        candidateName,
        company,
        role,
        jobDescription
      };
      sessionStorage.setItem('pendingAnalysis', JSON.stringify(pendingData));

      // Navigate to the analyzing page with animated logo
      window.location.href = 'analyzing.html';
    });

    // ========================================================================
    // HELPER: Build resume text from JSON
    // ========================================================================
    function buildResumeTextFromJson(resume) {
      let text = '';
      
      const contact = resume.contact || {};
      if (contact.full_name) text += contact.full_name + '\n';
      if (contact.email) text += contact.email + '\n';
      if (contact.phone) text += contact.phone + '\n';
      text += '\n';

      if (resume.summary_text) {
        text += 'SUMMARY\n' + resume.summary_text + '\n\n';
      }
      
      if (resume.experience && resume.experience.length > 0) {
        text += 'EXPERIENCE\n';
        for (const exp of resume.experience) {
          text += `${exp.role || exp.title} at ${exp.company}`;
          if (exp.start_date || exp.end_date) {
            text += ` (${exp.start_date || ''} - ${exp.end_date || 'Present'})`;
          }
          text += '\n';
          if (exp.bullets && exp.bullets.length > 0) {
            for (const bullet of exp.bullets) {
              text += `‚Ä¢ ${bullet}\n`;
            }
          }
          text += '\n';
        }
      }
      
      if (resume.skills && resume.skills.length > 0) {
        text += 'SKILLS\n' + resume.skills.join(', ') + '\n\n';
      }
      
      if (resume.education && resume.education.length > 0) {
        text += 'EDUCATION\n';
        for (const edu of resume.education) {
          text += (typeof edu === 'string' ? edu : JSON.stringify(edu)) + '\n';
        }
        text += '\n';
      }

      if (resume.certifications && resume.certifications.length > 0) {
        text += 'CERTIFICATIONS\n';
        for (const cert of resume.certifications) {
          text += (typeof cert === 'string' ? cert : JSON.stringify(cert)) + '\n';
        }
      }
      
      return text;
    }

    // ========================================================================
    // CLARIFYING QUESTIONS FUNCTIONS
    // ========================================================================

    async function fetchAndShowClarifyingQuestions(resumeJson, jobDescription, company, role, gaps, fitScore) {
      try {
        const response = await fetch(`${API_BASE_URL}/api/experience/clarifying-questions`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            resume_json: resumeJson,
            job_description: jobDescription,
            company: company,
            role_title: role,
            gaps: gaps,
            fit_score: fitScore
          })
        });

        if (!response.ok) {
          console.error('Failed to fetch clarifying questions, proceeding to results');
          proceedToResults();
          return;
        }

        const data = await response.json();
        console.log('Clarifying questions received:', data);

        // Store questions for later use
        window.clarifyingQuestions = data.questions;

        // Populate and show modal
        populateClarifyingModal(data);
        document.getElementById('clarifyingModal').classList.add('show');

      } catch (error) {
        console.error('Error fetching clarifying questions:', error);
        proceedToResults();
      }
    }

    function populateClarifyingModal(data) {
      // Set intro message
      document.getElementById('clarifyingIntro').textContent = data.intro_message || 'Help me understand your background better...';

      // Populate questions
      const container = document.getElementById('clarifyingQuestionsContainer');
      container.innerHTML = '';

      data.questions.forEach((q, index) => {
        const card = document.createElement('div');
        card.className = 'clarifying-question-card';
        card.innerHTML = `
          <div class="clarifying-question-label">${q.gap_area}</div>
          <div class="clarifying-question-text">${q.question}</div>
          <div class="clarifying-question-hint">Example: ${q.example_answer}</div>
          <textarea
            class="clarifying-question-input"
            id="clarifyingAnswer_${index}"
            placeholder="Your answer..."
            data-gap-area="${q.gap_area}"
            data-question="${q.question}"
          ></textarea>
        `;
        container.appendChild(card);
      });
    }

    function proceedToResults() {
      const fullData = window.pendingAnalysisData;
      if (fullData) {
        sessionStorage.setItem('analysisData', JSON.stringify(fullData));
      }
      window.location.href = 'results.html';
    }

    // Submit clarifying answers
    document.getElementById('submitClarifyingBtn').addEventListener('click', async () => {
      const btn = document.getElementById('submitClarifyingBtn');
      const originalText = btn.textContent;
      btn.disabled = true;
      btn.textContent = 'Updating fit score...';

      try {
        // Collect answers
        const supplements = [];
        const questions = window.clarifyingQuestions || [];

        questions.forEach((q, index) => {
          const textarea = document.getElementById(`clarifyingAnswer_${index}`);
          const answer = textarea ? textarea.value.trim() : '';

          if (answer) {
            supplements.push({
              gap_area: q.gap_area,
              question: q.question,
              answer: answer
            });
          }
        });

        // If no answers provided, just proceed with original data
        if (supplements.length === 0) {
          proceedToResults();
          return;
        }

        const ctx = window.pendingRequestContext;

        // Call reanalyze endpoint
        const response = await fetch(`${API_BASE_URL}/api/experience/reanalyze`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            resume_json: ctx.resumeJson,
            job_description: ctx.jobDescription,
            company: ctx.company,
            role_title: ctx.role,
            original_gaps: ctx.gaps,
            original_fit_score: ctx.fitScore,
            supplements: supplements
          })
        });

        if (!response.ok) {
          console.error('Reanalyze failed, proceeding with original data');
          proceedToResults();
          return;
        }

        const reanalysisData = await response.json();
        console.log('Reanalysis complete:', reanalysisData);

        // Update the analysis data with new fit score and updated resume
        const updatedData = {
          ...window.pendingAnalysisData,
          fit_score: reanalysisData.new_fit_score,
          strengths: reanalysisData.updated_strengths,
          gaps: reanalysisData.remaining_gaps,
          _resume_json: reanalysisData.updated_resume_json,
          _supplemented: true,
          _score_change: reanalysisData.score_change,
          _addressed_gaps: reanalysisData.addressed_gaps,
          _supplement_summary: reanalysisData.summary
        };

        sessionStorage.setItem('analysisData', JSON.stringify(updatedData));
        window.location.href = 'results.html';

      } catch (error) {
        console.error('Error during reanalysis:', error);
        proceedToResults();
      } finally {
        btn.disabled = false;
        btn.textContent = originalText;
      }
    });

    // Skip clarifying questions
    document.getElementById('skipClarifyingBtn').addEventListener('click', () => {
      document.getElementById('clarifyingModal').classList.remove('show');
      proceedToResults();
    });

    // Close modal on background click
    document.getElementById('clarifyingModal').addEventListener('click', (e) => {
      if (e.target.id === 'clarifyingModal') {
        // Don't close on background click - user must make a choice
      }
    });

    // ========================================================================
    // INPUT METHOD TOGGLE (Paste vs URL)
    // ========================================================================
    let currentInputMethod = 'paste';

    function setInputMethod(method) {
      currentInputMethod = method;

      // Update button states
      document.getElementById('pasteMethodBtn').classList.toggle('active', method === 'paste');
      document.getElementById('urlMethodBtn').classList.toggle('active', method === 'url');

      // Show/hide input areas
      document.getElementById('pasteWrapper').classList.toggle('hidden', method !== 'paste');
      document.getElementById('urlWrapper').classList.toggle('active', method === 'url');

      // Clear extraction status when switching
      const statusEl = document.getElementById('extractionStatus');
      statusEl.className = 'extraction-status';
      statusEl.textContent = '';
    }

    document.getElementById('pasteMethodBtn').addEventListener('click', () => setInputMethod('paste'));
    document.getElementById('urlMethodBtn').addEventListener('click', () => setInputMethod('url'));

    // ========================================================================
    // URL EXTRACTION
    // ========================================================================
    document.getElementById('extractBtn').addEventListener('click', async () => {
      const urlInput = document.getElementById('jobUrl');
      const url = urlInput.value.trim();
      const extractBtn = document.getElementById('extractBtn');
      const statusEl = document.getElementById('extractionStatus');

      if (!url) {
        statusEl.className = 'extraction-status error';
        statusEl.textContent = 'Please enter a job posting URL.';
        return;
      }

      // Show loading state
      extractBtn.disabled = true;
      extractBtn.innerHTML = '<span class="spinner-small"></span><span>Extracting...</span>';
      statusEl.className = 'extraction-status';
      statusEl.textContent = '';

      try {
        const response = await fetch(`${API_BASE_URL}/api/jd/extract-from-url`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ url })
        });

        const data = await response.json();

        if (data.success) {
          // Populate the job description textarea
          document.getElementById('jobDescription').value = data.job_description;

          // Switch to paste view to show the extracted text
          setInputMethod('paste');

          // Show success message
          statusEl.className = 'extraction-status success';
          let successMsg = `Extracted ${data.job_description.length.toLocaleString()} characters`;
          if (data.company) successMsg += ` from ${data.company}`;
          if (data.role_title) successMsg += ` - ${data.role_title}`;
          successMsg += '. Please review the text below before analyzing.';
          statusEl.textContent = successMsg;

          // Show warning if present
          if (data.warning) {
            console.log('Extraction warning:', data.warning);
          }
        } else {
          statusEl.className = 'extraction-status error';
          statusEl.textContent = data.error || 'Failed to extract job description. Please paste it manually.';
        }
      } catch (error) {
        console.error('URL extraction error:', error);
        statusEl.className = 'extraction-status error';
        statusEl.textContent = 'Network error. Please check your connection and try again.';
      } finally {
        extractBtn.disabled = false;
        extractBtn.innerHTML = '<span class="extract-text">Extract Job Description</span>';
      }
    });

    // Allow Enter key to trigger extraction
    document.getElementById('jobUrl').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        document.getElementById('extractBtn').click();
      }
    });

    // ========================================================================
    // INITIALIZE
    // ========================================================================
    loadProfile();

    // Go to profile button handler
    const goToProfileBtn = document.getElementById('goToProfileBtn');
    if (goToProfileBtn) {
      goToProfileBtn.addEventListener('click', function() {
        console.log('Button clicked, redirecting to resume-builder.html');
        window.location.href = 'resume-builder.html';
      });
    }
  </script>
<script src="components/ask-henry.js"></script>
<script src="components/strategy-nav.js"></script>
</body>
</html>

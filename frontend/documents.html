<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Your Tailored Documents - HenryHQ</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Instrument+Serif:ital@0;1&family=DM+Sans:opsz,wght@9..40,400;9..40,500;9..40,600&display=swap" rel="stylesheet">
    <!-- docx.js for client-side DOCX generation -->
    <script src="https://unpkg.com/docx@8.2.2/build/index.umd.js"></script>
    <!-- FileSaver.js for downloading -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <style>
        :root {
            --color-bg: #0a0a0b;
            --color-surface: #141416;
            --color-surface-elevated: #1c1c1f;
            --color-border: rgba(255, 255, 255, 0.08);
            --color-border-hover: rgba(255, 255, 255, 0.15);
            --color-text: #fafafa;
            --color-text-secondary: #a1a1aa;
            --color-accent: #22d3ee;
            --color-accent-muted: rgba(34, 211, 238, 0.15);
            --color-success: #4ade80;
            --color-warning: #fbbf24;
            --color-error: #f87171;
            --font-display: 'Instrument Serif', Georgia, serif;
            --font-body: 'DM Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            --ease-out: cubic-bezier(0.16, 1, 0.3, 1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-body);
            background: var(--color-bg);
            color: var(--color-text);
            min-height: 100vh;
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
            padding: 40px 20px;
        }

        .container {
            max-width: 1100px;
            margin: 0 auto;
        }

        /* â”€â”€ Page Header â”€â”€ */
        .page-header {
            margin-bottom: 24px;
        }

        .role-title {
            color: var(--color-accent);
            font-size: 0.95rem;
            font-weight: 500;
            margin-bottom: 4px;
            letter-spacing: 0.2px;
        }

        .page-title {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 6px;
        }

        .page-title h1 {
            font-family: var(--font-display);
            font-size: 2rem;
            font-weight: 400;
            color: var(--color-text);
            margin: 0;
        }

        .subtitle {
            color: var(--color-text-secondary);
            font-size: 0.9rem;
            margin: 0;
        }

        /* â”€â”€ Tabs â”€â”€ */
        .tabs {
            display: inline-flex;
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: 10px;
            padding: 4px;
            margin-bottom: 24px;
        }

        .tab {
            padding: 10px 24px;
            background: transparent;
            border: none;
            color: var(--color-text-secondary);
            font-size: 0.95rem;
            font-weight: 500;
            font-family: var(--font-body);
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.2s ease;
        }

        .tab:hover {
            color: var(--color-text);
            background: rgba(255, 255, 255, 0.05);
        }

        .tab.active {
            background: var(--color-accent);
            color: #000;
            font-weight: 600;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* â”€â”€ Two-Column Document Layout â”€â”€ */
        .document-layout {
            display: grid;
            grid-template-columns: 1fr 280px;
            gap: 24px;
            align-items: start;
        }

        .document-main {
            min-width: 0;
        }

        .document-preview {
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: 16px;
            padding: 24px;
            width: 100%;
            max-height: 85vh;
            overflow-y: auto;
            overflow-x: hidden;
        }

        .document-preview::-webkit-scrollbar {
            width: 6px;
        }

        .document-preview::-webkit-scrollbar-track {
            background: transparent;
        }

        .document-preview::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
        }

        .document-preview::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        /* â”€â”€ WYSIWYG Resume Preview â”€â”€ */
        .resume-preview-html {
            width: 100%;
            display: flex;
            justify-content: center;
        }

        .resume-preview-html .resume-page {
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.15);
            transform-origin: top center;
        }

        /* Scale down the 816px resume page when main column is narrow */
        @media (max-width: 1200px) {
            .resume-preview-html .resume-page {
                transform: scale(0.82);
                margin-bottom: -120px;
            }
        }

        @media (max-width: 960px) {
            .resume-preview-html .resume-page {
                transform: scale(1);
                margin-bottom: 0;
            }
        }

        /* â”€â”€ Document Text (cover letter / fallback) â”€â”€ */
        .document-text {
            width: 100%;
            background: #ffffff;
            border: none;
            border-radius: 4px;
            color: #1f2937;
            font-family: 'Calibri', 'Arial', 'Helvetica', sans-serif;
            font-size: 12px;
            line-height: 1.15;
            resize: none;
            min-height: 600px;
            overflow-y: auto;
            height: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
            padding: 48px 62px;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.15);
        }

        .document-text:focus {
            outline: none;
        }

        /* â”€â”€ Sidebar â”€â”€ */
        .document-sidebar {
            position: sticky;
            top: 80px;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        /* â”€â”€ Download Card â”€â”€ */
        .download-card {
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: 16px;
            padding: 20px;
        }

        .btn-download {
            width: 100%;
            padding: 14px 20px;
            background: var(--color-text);
            color: var(--color-bg);
            border: none;
            border-radius: 12px;
            font-size: 0.95rem;
            font-weight: 600;
            font-family: var(--font-body);
            cursor: pointer;
            transition: all 0.25s var(--ease-out);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-download:hover {
            background: var(--color-accent);
            transform: translateY(-2px);
            box-shadow: 0 8px 32px rgba(34, 211, 238, 0.25);
        }

        .btn-download:disabled {
            background: var(--color-surface-elevated);
            color: var(--color-text-secondary);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .download-hint {
            font-size: 0.75rem;
            color: var(--color-text-secondary);
            text-align: center;
            margin-top: 10px;
        }

        /* â”€â”€ Keywords Card â”€â”€ */
        .keywords-card {
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: 16px;
            padding: 20px;
        }

        .keywords-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            user-select: none;
        }

        .keywords-card-header.expanded {
            margin-bottom: 14px;
        }

        .keywords-label {
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--color-text-secondary);
        }

        .keywords-count {
            font-size: 0.7rem;
            color: var(--color-accent);
            background: var(--color-accent-muted);
            padding: 2px 8px;
            border-radius: 10px;
            font-weight: 600;
        }

        .keywords-toggle {
            background: none;
            border: none;
            color: var(--color-text-secondary);
            font-size: 0.7rem;
            cursor: pointer;
            transition: transform 0.2s ease;
            padding: 4px;
        }

        .keywords-toggle.expanded {
            transform: rotate(180deg);
        }

        .keywords-body {
            display: none;
        }

        .keywords-body.expanded {
            display: block;
        }

        .keywords {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .keyword-tag {
            padding: 4px 10px;
            background: var(--color-accent-muted);
            border: 1px solid rgba(34, 211, 238, 0.25);
            border-radius: 6px;
            font-size: 0.78rem;
            color: var(--color-accent);
            font-weight: 500;
        }

        /* â”€â”€ Fit Score Delta â”€â”€ */
        .fit-score-delta {
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: 16px;
            padding: 20px;
        }

        .fit-score-delta .delta-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .fit-score-delta .delta-label {
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--color-text-secondary);
        }

        .fit-score-delta .delta-badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .fit-score-delta .delta-badge.improved {
            background: rgba(74, 222, 128, 0.15);
            color: var(--color-success);
        }

        .fit-score-delta .delta-badge.unchanged {
            background: rgba(156, 163, 175, 0.15);
            color: var(--color-text-secondary);
        }

        .fit-score-delta .delta-scores {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }

        .fit-score-delta .score-before,
        .fit-score-delta .score-after {
            display: flex;
            flex-direction: column;
            align-items: center;
            flex: 1;
        }

        .fit-score-delta .score-label {
            font-size: 0.7rem;
            color: var(--color-text-secondary);
            margin-bottom: 4px;
        }

        .fit-score-delta .score-value {
            font-size: 1.3rem;
            font-weight: 700;
        }

        .fit-score-delta .score-before .score-value {
            color: var(--color-text-secondary);
        }

        .fit-score-delta .score-after .score-value {
            color: var(--color-accent);
        }

        .fit-score-delta .score-verdict {
            font-size: 0.65rem;
            color: var(--color-text-secondary);
            margin-top: 2px;
        }

        .fit-score-delta .score-arrow {
            font-size: 1rem;
            color: var(--color-text-secondary);
        }

        .fit-score-delta .delta-summary {
            font-size: 0.8rem;
            color: var(--color-text-secondary);
            margin: 0;
            font-style: italic;
        }

        .btn-recalculate {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            width: 100%;
            padding: 8px 14px;
            background: transparent;
            color: var(--color-accent);
            border: 1px solid rgba(34, 211, 238, 0.3);
            border-radius: 8px;
            font-size: 0.8rem;
            font-weight: 600;
            font-family: var(--font-body);
            cursor: pointer;
            transition: all 0.2s;
            margin-top: 12px;
        }

        .btn-recalculate:hover {
            background: var(--color-accent-muted);
            border-color: var(--color-accent);
        }

        .btn-recalculate:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-recalculate .spinner {
            display: none;
            width: 14px;
            height: 14px;
            border: 2px solid rgba(34, 211, 238, 0.3);
            border-top-color: var(--color-accent);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        .btn-recalculate.loading .spinner {
            display: inline-block;
        }

        .btn-recalculate.loading .btn-text {
            display: none;
        }

        /* â”€â”€ Loading & States â”€â”€ */
        .loading-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--color-text-secondary);
        }

        .loading-spinner {
            border: 3px solid var(--color-surface-elevated);
            border-top: 3px solid var(--color-accent);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--color-error);
        }

        .error-state p {
            margin-bottom: 20px;
        }

        .error-state a {
            color: var(--color-accent);
            text-decoration: none;
        }

        .error-state a:hover {
            text-decoration: underline;
        }

        /* â”€â”€ Success Message â”€â”€ */
        .success-message {
            position: fixed;
            top: 80px;
            right: 20px;
            background: var(--color-success);
            color: #000;
            padding: 14px 24px;
            border-radius: 12px;
            font-weight: 600;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
            opacity: 0;
            transform: translateY(-20px);
            transition: all 0.3s;
            z-index: 1000;
        }

        .success-message.show {
            opacity: 1;
            transform: translateY(0);
        }

        /* â”€â”€ Disclaimer â”€â”€ */
        .disclaimer {
            color: var(--color-text-secondary);
            font-size: 0.8rem;
            font-style: italic;
            margin-top: 24px;
            text-align: center;
            opacity: 0.7;
        }

        /* â”€â”€ Warning Banner â”€â”€ */
        .job-fit-warning-banner {
            background: linear-gradient(135deg, rgba(248, 113, 113, 0.08), rgba(248, 113, 113, 0.04));
            border: 1px solid rgba(248, 113, 113, 0.3);
            border-radius: 12px;
            padding: 16px 20px;
            margin-bottom: 20px;
            display: flex;
            align-items: flex-start;
            gap: 12px;
        }

        .job-fit-warning-banner.proceeded {
            background: linear-gradient(135deg, rgba(251, 191, 36, 0.1), rgba(251, 191, 36, 0.05));
            border-color: rgba(251, 191, 36, 0.3);
        }

        .job-fit-warning-banner .warning-icon {
            font-size: 1.5rem;
            flex-shrink: 0;
        }

        .job-fit-warning-banner .warning-content {
            flex: 1;
        }

        .job-fit-warning-banner strong {
            display: block;
            color: var(--color-error);
            margin-bottom: 4px;
        }

        .job-fit-warning-banner.proceeded strong {
            color: var(--color-warning);
        }

        .job-fit-warning-banner p {
            color: var(--color-text-secondary);
            font-size: 0.9rem;
            margin: 0;
            line-height: 1.5;
        }

        /* â”€â”€ Post-Download Modal â”€â”€ */
        .post-download-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .post-download-modal.show {
            display: flex;
        }

        .modal-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(4px);
        }

        .post-download-modal .modal-content {
            position: relative;
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: 20px;
            padding: 40px;
            max-width: 480px;
            width: 90%;
            text-align: center;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
            animation: modalSlideIn 0.3s ease;
        }

        @keyframes modalSlideIn {
            from { opacity: 0; transform: translateY(20px) scale(0.95); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }

        .modal-close {
            position: absolute;
            top: 16px;
            right: 16px;
            background: none;
            border: none;
            color: var(--color-text-secondary);
            font-size: 24px;
            cursor: pointer;
            transition: color 0.2s;
        }

        .modal-close:hover {
            color: var(--color-text);
        }

        .modal-icon {
            font-size: 48px;
            margin-bottom: 20px;
        }

        .post-download-modal h3 {
            font-size: 1.5rem;
            color: var(--color-text);
            margin-bottom: 16px;
        }

        .modal-stat {
            color: #d1d5db;
            font-size: 1rem;
            margin-bottom: 12px;
        }

        .modal-stat strong {
            color: var(--color-accent);
        }

        .modal-insight {
            color: var(--color-text-secondary);
            font-size: 0.95rem;
            margin-bottom: 28px;
            line-height: 1.6;
        }

        .modal-actions {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .modal-btn-primary {
            padding: 14px 28px;
            background: var(--color-text);
            color: var(--color-bg);
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            font-family: var(--font-body);
            cursor: pointer;
            text-decoration: none;
            transition: all 0.25s var(--ease-out);
            display: inline-block;
        }

        .modal-btn-primary:hover {
            background: var(--color-accent);
            transform: translateY(-2px);
            box-shadow: 0 8px 32px rgba(34, 211, 238, 0.25);
        }

        .modal-btn-secondary {
            padding: 12px 24px;
            background: transparent;
            color: var(--color-text-secondary);
            border: 1px solid var(--color-border);
            border-radius: 12px;
            font-size: 0.95rem;
            font-family: var(--font-body);
            cursor: pointer;
            transition: all 0.2s;
        }

        .modal-btn-secondary:hover {
            background: rgba(255, 255, 255, 0.05);
            color: var(--color-text);
        }

        /* â”€â”€ Header / Logo â”€â”€ */
        header {
            padding: 24px 0;
            border-bottom: 1px solid var(--color-border);
            margin-bottom: 32px;
        }

        header .header-container {
            max-width: 900px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .logo {
            font-family: var(--font-display);
            font-size: 1.8rem;
            color: var(--color-text);
            text-decoration: none;
            position: fixed;
            left: 90px;
            top: 24px;
            z-index: 100;
        }

        body.has-strategy-nav header,
        body.has-strategy-nav .logo {
            display: none !important;
        }

        .logo em {
            font-style: italic;
            color: var(--color-accent);
        }

        /* â”€â”€ Responsive â”€â”€ */
        @media (max-width: 960px) {
            .document-layout {
                grid-template-columns: 1fr;
            }

            .document-sidebar {
                position: static;
                order: -1;
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 12px;
            }

            .keywords-card {
                grid-column: 1 / -1;
            }

            .resume-preview-html .resume-page {
                transform: none;
                margin-bottom: 0;
            }
        }

        @media (max-width: 640px) {
            body {
                padding: 20px 12px;
            }

            .document-sidebar {
                grid-template-columns: 1fr;
            }

            .document-preview {
                padding: 12px;
                max-height: 70vh;
            }

            .page-title h1 {
                font-size: 1.5rem;
            }

            .tab {
                padding: 8px 16px;
                font-size: 0.85rem;
            }
        }
    </style>
    <link rel="stylesheet" href="css/mobile.css">
    <!-- Supabase Auth -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/supabase-client.js"></script>
</head>
<body>
    <!-- HEADER -->
    <header>
        <div class="header-container">
            <a href="/index" class="logo"><em>Henry</em>HQ</a>
        </div>
    </header>

    <div class="container">
        <!-- Job Fit Warning Banner (conditional) -->
        <div id="jobFitWarningBanner" class="job-fit-warning-banner" style="display: none;">
            <div class="warning-icon">&#9888;&#65039;</div>
            <div class="warning-content">
                <strong id="warningTitle">HenryHQ Guidance</strong>
                <p id="warningMessage"></p>
            </div>
        </div>

        <!-- Page Header -->
        <div class="page-header">
            <div class="role-title" id="roleTitle"></div>
            <div class="page-title">
                <h1>Tailored Documents</h1>
            </div>
            <p class="subtitle">ATS-optimized resume and custom cover letter for this role</p>
        </div>

        <!-- Tabs -->
        <div class="tabs">
            <button class="tab active" onclick="switchTab('resume')">Resume</button>
            <button class="tab" onclick="switchTab('coverLetter')">Cover Letter</button>
        </div>

        <!-- Resume Tab -->
        <div id="resumeTab" class="tab-content active">
            <div class="document-layout">
                <!-- Main Preview -->
                <div class="document-main">
                    <div class="document-preview">
                        <div id="resumeLoading" class="loading-state">
                            <div class="loading-spinner"></div>
                            <div>Loading resume...</div>
                        </div>
                        <!-- WYSIWYG HTML preview matching DOCX layout -->
                        <div class="resume-preview-html" id="resumePreview" style="display: none;"></div>
                        <!-- Hidden plain text for legacy fallback and recalculate -->
                        <textarea class="document-text" id="resumeText" style="display: none;"></textarea>
                    </div>
                </div>

                <!-- Sidebar -->
                <div class="document-sidebar">
                    <!-- Download Action -->
                    <div class="download-card">
                        <button class="btn-download" id="downloadResumeBtn" onclick="downloadResume()">
                            <span>&#8595;</span> Download Resume
                        </button>
                        <div class="download-hint">Downloads as .docx</div>
                    </div>

                    <!-- Fit Score Delta (conditionally shown) -->
                    <div id="fitScoreDelta" class="fit-score-delta" style="display: none;">
                        <div class="delta-header">
                            <span class="delta-label">Job Fit Impact</span>
                            <span class="delta-badge" id="deltaBadge"></span>
                        </div>
                        <div class="delta-scores">
                            <div class="score-before">
                                <span class="score-label">Before</span>
                                <span class="score-value" id="scoreBefore">--</span>
                                <span class="score-verdict" id="verdictBefore"></span>
                            </div>
                            <div class="score-arrow">&rarr;</div>
                            <div class="score-after">
                                <span class="score-label">After</span>
                                <span class="score-value" id="scoreAfter">--</span>
                                <span class="score-verdict" id="verdictAfter"></span>
                            </div>
                        </div>
                        <p class="delta-summary" id="deltaSummary"></p>
                        <button class="btn-recalculate" id="recalculateBtn" onclick="recalculateFitScore()">
                            <span class="spinner"></span>
                            <span class="btn-text">&#8635; Recalculate</span>
                        </button>
                    </div>

                    <!-- ATS Keywords (collapsible) -->
                    <div class="keywords-card">
                        <div class="keywords-card-header expanded" onclick="toggleKeywords()">
                            <div style="display:flex;align-items:center;gap:8px;">
                                <span class="keywords-label">ATS Keywords</span>
                                <span class="keywords-count" id="keywordsCount"></span>
                            </div>
                            <button class="keywords-toggle expanded" aria-label="Toggle keywords">&#9660;</button>
                        </div>
                        <div class="keywords-body expanded" id="keywordsBody">
                            <div class="keywords" id="resumeKeywords"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Cover Letter Tab -->
        <div id="coverLetterTab" class="tab-content">
            <div class="document-layout">
                <div class="document-main">
                    <div class="document-preview">
                        <div id="coverLetterLoading" class="loading-state">
                            <div class="loading-spinner"></div>
                            <div>Loading cover letter...</div>
                        </div>
                        <textarea class="document-text" id="coverLetterText" style="display: none;"></textarea>
                    </div>
                </div>
                <div class="document-sidebar">
                    <div class="download-card">
                        <button class="btn-download" id="downloadCoverLetterBtn" onclick="downloadCoverLetter()">
                            <span>&#8595;</span> Download Cover Letter
                        </button>
                        <div class="download-hint">Downloads as .docx</div>
                    </div>
                </div>
            </div>
        </div>

        <p class="disclaimer">* We strongly encourage proofreading your documents before submitting.</p>
    </div>

    <!-- Success Message -->
    <div class="success-message" id="successMessage">Downloaded Successfully</div>

    <!-- Post-Download Modal -->
    <div class="post-download-modal" id="postDownloadModal">
        <div class="modal-overlay" onclick="closePostDownloadModal()"></div>
        <div class="modal-content">
            <button class="modal-close" onclick="closePostDownloadModal()">&times;</button>
            <div class="modal-icon">&#129309;</div>
            <h3>Great, your documents are ready!</h3>
            <p class="modal-stat">But here's the reality: <strong>70% of jobs are filled through referrals.</strong></p>
            <p class="modal-insight" id="networkModalInsight">
                Direct outreach to the hiring team could significantly improve your chances of landing an interview.
            </p>
            <div class="modal-actions">
                <a href="/outreach" class="modal-btn-primary">View Outreach Strategy</a>
                <button class="modal-btn-secondary" onclick="closePostDownloadModal()">Maybe Later</button>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const API_BASE = window.location.hostname === 'localhost' ? 'http://localhost:8000' : 'https://henryai-app-production.up.railway.app';

        // Get the docx library from the global scope
        const { Document, Packer, Paragraph, TextRun, HeadingLevel, AlignmentType } = docx;

        let documentsData = null;
        let analysisData = null;

        // Switch tabs
        function switchTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');

            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            if (tabName === 'resume') {
                document.getElementById('resumeTab').classList.add('active');
            } else if (tabName === 'coverLetter') {
                document.getElementById('coverLetterTab').classList.add('active');
            }
        }

        // Toggle keywords collapse/expand
        function toggleKeywords() {
            const header = document.querySelector('.keywords-card-header');
            const body = document.getElementById('keywordsBody');
            const toggle = document.querySelector('.keywords-toggle');
            header.classList.toggle('expanded');
            body.classList.toggle('expanded');
            toggle.classList.toggle('expanded');
        }

        // Show success message
        function showSuccess() {
            const msg = document.getElementById('successMessage');
            msg.classList.add('show');
            setTimeout(() => msg.classList.remove('show'), 3000);

            // Show post-download modal after a brief delay (only once per session)
            const modalShown = sessionStorage.getItem('networkModalShown');
            if (!modalShown) {
                setTimeout(() => {
                    showPostDownloadModal();
                }, 1500);
            }
        }

        // Post-download modal functions
        function showPostDownloadModal() {
            const modal = document.getElementById('postDownloadModal');
            modal.classList.add('show');
            sessionStorage.setItem('networkModalShown', 'true');

            // Update modal insight with personalized content if available
            const insightEl = document.getElementById('networkModalInsight');
            if (analysisData) {
                const outreach = analysisData.outreach_intelligence || {};
                const company = analysisData._company_name || analysisData.company_name || 'this company';

                if (outreach.hiring_manager_likely_title) {
                    insightEl.textContent = `I found the likely hiring manager (${outreach.hiring_manager_likely_title}) at ${company}. Direct outreach could significantly improve your chances.`;
                } else {
                    insightEl.textContent = `I can help you identify who to contact at ${company} and craft personalized outreach messages.`;
                }
            }
        }

        function closePostDownloadModal() {
            const modal = document.getElementById('postDownloadModal');
            modal.classList.remove('show');
        }

        // Create a DOCX document from text
        function createDocxFromText(text, title) {
            const paragraphs = text.split('\n').map(line => {
                const isHeader = /^[A-Z\s&]+$/.test(line.trim()) ||
                                 (line.trim().endsWith(':') && line.trim().length < 50);
                const isBullet = line.trim().startsWith('â€¢') || line.trim().startsWith('-');

                if (isHeader && line.trim().length > 0) {
                    return new Paragraph({
                        children: [
                            new TextRun({ text: line.trim(), bold: true, size: 24 })
                        ],
                        spacing: { before: 240, after: 120 }
                    });
                } else if (isBullet) {
                    return new Paragraph({
                        children: [
                            new TextRun({ text: line.trim(), size: 22 })
                        ],
                        spacing: { after: 60 },
                        indent: { left: 360 }
                    });
                } else {
                    return new Paragraph({
                        children: [
                            new TextRun({ text: line, size: 22 })
                        ],
                        spacing: { after: 120 }
                    });
                }
            });

            return new Document({
                sections: [{
                    properties: {},
                    children: paragraphs
                }]
            });
        }

        // Download resume as DOCX - USES CANONICAL DOCUMENT (single source of truth)
        async function downloadResume() {
            console.log('ðŸ“¥ Download resume clicked');
            console.log('documentsData:', documentsData);
            console.log('canonical_document:', documentsData?.canonical_document);

            if (!documentsData || !documentsData.resume_output) {
                alert('Resume not available. Please go back and regenerate.');
                return;
            }

            const btn = document.getElementById('downloadResumeBtn');
            const originalText = btn.innerHTML;

            try {
                btn.disabled = true;
                btn.innerHTML = '<span>&#9203;</span> Generating...';

                // CHECK FOR CANONICAL DOCUMENT - single source of truth
                if (documentsData.canonical_document) {
                    console.log('âœ… Using canonical download endpoint (preview === download)');
                    console.log('API_BASE:', API_BASE);
                    const response = await fetch(`${API_BASE}/api/download/canonical`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            canonical_document: documentsData.canonical_document,
                            document_type: 'resume',
                            expected_hash: documentsData.canonical_document?.metadata?.content_hash
                        })
                    });

                    if (!response.ok) {
                        const error = await response.json().catch(() => ({}));
                        if (error.error === 'integrity_mismatch') {
                            alert('Document has changed. Please refresh the page and try again.');
                            return;
                        }
                        if (error.error === 'integrity_failed') {
                            const issues = error.issues?.map(i => i.message).join('\n') || 'Unknown issue';
                            alert(`Cannot download: ${issues}`);
                            return;
                        }
                        console.warn(`âš ï¸ Canonical download failed (${response.status}), falling back to legacy`);
                    } else {
                        const blob = await response.blob();
                        const contentHash = response.headers.get('X-Document-Hash');
                        console.log(`âœ… Downloaded with hash: ${contentHash}`);

                        lockFitScoreAtDownload();

                        const candidateName = documentsData.canonical_document?.resume?.contact?.name || 'Resume';
                        const filename = `${candidateName.replace(/\s+/g, '_')}_Resume.docx`;
                        saveAs(blob, filename);
                        showSuccess();
                        return;
                    }
                }

                // FALLBACK: Legacy download path (deprecated)
                console.log('âš ï¸ Using legacy download endpoint (may differ from preview)');

                const candidateName = analysisData?._candidate_name ||
                                     analysisData?._profile?.full_name ||
                                     analysisData?._resume_json?.candidate?.name ||
                                     'Candidate';
                const resumeData = analysisData?._resume_json || {};
                const profile = analysisData?._profile || {};

                console.log('Building resume with data:', { candidateName, resumeData, profile, analysisData });

                let normalizedSkills = {};
                const skillsSource = resumeData.skills || profile.skills;
                if (skillsSource) {
                    if (Array.isArray(skillsSource)) {
                        normalizedSkills = { "Skills": skillsSource };
                    } else if (typeof skillsSource === 'object') {
                        for (const [key, value] of Object.entries(skillsSource)) {
                            normalizedSkills[key] = Array.isArray(value) ? value : [value];
                        }
                    }
                }

                let normalizedEducation = {};
                const eduSource = resumeData.education || profile.education || analysisData?._profile?.education;
                if (eduSource) {
                    if (Array.isArray(eduSource) && eduSource.length > 0) {
                        const edu = eduSource[0];
                        let eduDetails = edu.details || edu.highlights || edu.activities || '';
                        if (Array.isArray(eduDetails)) { eduDetails = eduDetails.join(', '); }
                        normalizedEducation = {
                            school: edu.school || edu.institution || edu.university || edu.name || '',
                            degree: edu.degree || edu.qualification || edu.field_of_study ||
                                    (edu.degree_name ? `${edu.degree_name}${edu.field_of_study ? ', ' + edu.field_of_study : ''}` : ''),
                            details: eduDetails
                        };
                    } else if (typeof eduSource === 'object' && !Array.isArray(eduSource)) {
                        let eduDetails = eduSource.details || eduSource.highlights || '';
                        if (Array.isArray(eduDetails)) { eduDetails = eduDetails.join(', '); }
                        normalizedEducation = {
                            school: eduSource.school || eduSource.institution || eduSource.university || eduSource.name || '',
                            degree: eduSource.degree || eduSource.qualification || eduSource.field_of_study || '',
                            details: eduDetails
                        };
                    } else if (typeof eduSource === 'string') {
                        const parts = eduSource.split(/[,\-\u2013]/).map(p => p.trim());
                        if (parts.length >= 2) {
                            const degreeKeywords = ['bachelor', 'master', 'phd', 'b.a.', 'b.s.', 'm.a.', 'm.s.', 'mba', 'degree'];
                            const firstIsDegree = degreeKeywords.some(kw => parts[0].toLowerCase().includes(kw));
                            if (firstIsDegree) {
                                normalizedEducation = { school: parts.slice(1).join(', '), degree: parts[0], details: '' };
                            } else {
                                normalizedEducation = { school: parts[0], degree: parts.slice(1).join(', '), details: '' };
                            }
                        } else {
                            normalizedEducation = { school: '', degree: eduSource, details: '' };
                        }
                    }
                }

                const safeString = (val) => {
                    if (val === null || val === undefined) return '';
                    if (typeof val === 'string') return val;
                    if (typeof val === 'object') {
                        if (val.city && val.state) return `${val.city}, ${val.state}`;
                        if (val.location) return String(val.location);
                        if (val.name) return String(val.name);
                        return '';
                    }
                    return String(val);
                };

                const contactPhone = safeString(profile.phone || resumeData.contact?.phone || resumeData.candidate?.contact?.phone);
                const contactEmail = safeString(profile.email || resumeData.contact?.email || resumeData.candidate?.contact?.email);
                const contactLinkedin = safeString(profile.linkedin || resumeData.contact?.linkedin || resumeData.candidate?.contact?.linkedin);
                let contactLocation = safeString(profile.location || resumeData.contact?.location || resumeData.candidate?.contact?.location);
                if (!contactLocation) {
                    contactLocation = safeString(analysisData?.job_location ||
                                                 analysisData?._profile?.location ||
                                                 resumeData.experience?.[0]?.location);
                }

                const experienceSections = documentsData.resume_output?.experience_sections || [];
                const mergedExperience = experienceSections.map(job => {
                    return {
                        company: safeString(job.company || ''),
                        title: safeString(job.title || ''),
                        location: safeString(job.location || ''),
                        dates: safeString(job.dates || ''),
                        overview: safeString(job.overview || job.company_overview || ''),
                        bullets: Array.isArray(job.bullets) ? job.bullets : []
                    };
                });

                let tagline = safeString(profile.tagline || resumeData.tagline || profile.current_title || '');
                if (!tagline) {
                    const targetRole = analysisData?._role || analysisData?.role_title || '';
                    const apiHeadline = analysisData?.resume_output?.headline || documentsData?.resume_output?.headline || '';
                    if (apiHeadline && apiHeadline.includes('|')) {
                        tagline = apiHeadline;
                    } else if (targetRole) {
                        const competencies = resumeData.core_competencies || profile.core_competencies ||
                                            analysisData?.required_skills || analysisData?.ats_keywords || [];
                        const topCompetencies = competencies.slice(0, 3).map(c => {
                            return String(c).trim().split(' ')
                                .map(w => w.charAt(0).toUpperCase() + w.slice(1).toLowerCase())
                                .join(' ');
                        });
                        if (topCompetencies.length > 0) {
                            tagline = targetRole + ' | ' + topCompetencies.join(' | ');
                        } else {
                            tagline = targetRole;
                        }
                    }
                }

                const tailoredCompetencies = documentsData.resume_output?.core_competencies ||
                                            documentsData.resume_output?.competencies ||
                                            analysisData?.core_competencies ||
                                            resumeData.core_competencies ||
                                            profile.core_competencies ||
                                            [];

                let tailoredSkills = normalizedSkills;
                const apiSkills = documentsData.resume_output?.skills || analysisData?.skills;
                if (apiSkills) {
                    if (typeof apiSkills === 'object' && !Array.isArray(apiSkills)) {
                        tailoredSkills = {};
                        for (const [key, value] of Object.entries(apiSkills)) {
                            tailoredSkills[key] = Array.isArray(value) ? value : [value];
                        }
                    } else if (Array.isArray(apiSkills)) {
                        tailoredSkills = { "Skills": apiSkills };
                    }
                }

                const requestPayload = {
                    candidate_name: candidateName,
                    tagline: tagline,
                    contact: {
                        phone: contactPhone,
                        email: contactEmail,
                        linkedin: contactLinkedin,
                        location: contactLocation
                    },
                    summary: safeString(documentsData.resume_output?.summary || resumeData.summary || ''),
                    competencies: Array.isArray(tailoredCompetencies) ? tailoredCompetencies : [],
                    experience: mergedExperience,
                    skills: tailoredSkills,
                    education: normalizedEducation
                };

                console.log('Resume download payload:', requestPayload);

                const response = await fetch(`${API_BASE}/api/download/resume`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestPayload)
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    console.error('Server error details:', errorData);
                    throw new Error(`Failed to generate resume: ${response.status} - ${JSON.stringify(errorData.detail || errorData)}`);
                }

                const blob = await response.blob();
                const filename = `${candidateName.replace(/\s+/g, '_')}_Resume.docx`;
                saveAs(blob, filename);
                showSuccess();

            } catch (error) {
                console.error('Error downloading resume:', error);
                alert('Error downloading resume: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }

        // Download cover letter as DOCX - USES CANONICAL DOCUMENT (single source of truth)
        async function downloadCoverLetter() {
            if (!documentsData || !documentsData.cover_letter) {
                alert('Cover letter not available. Please go back and regenerate.');
                return;
            }

            const btn = document.getElementById('downloadCoverLetterBtn');
            const originalText = btn.innerHTML;

            try {
                btn.disabled = true;
                btn.innerHTML = '<span>&#9203;</span> Generating...';

                if (documentsData.canonical_document) {
                    console.log('âœ… Using canonical download for cover letter');
                    const response = await fetch(`${API_BASE}/api/download/canonical`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            canonical_document: documentsData.canonical_document,
                            document_type: 'cover_letter',
                            expected_hash: documentsData.canonical_document?.metadata?.content_hash
                        })
                    });

                    if (!response.ok) {
                        const error = await response.json().catch(() => ({}));
                        if (error.error === 'integrity_mismatch') {
                            alert('Document has changed. Please refresh the page and try again.');
                            return;
                        }
                        if (error.error === 'integrity_failed') {
                            const issues = error.issues?.map(i => i.message).join('\n') || 'Unknown issue';
                            alert(`Cannot download: ${issues}`);
                            return;
                        }
                        throw new Error(`Download failed: ${response.status}`);
                    }

                    const blob = await response.blob();
                    const candidateName = documentsData.canonical_document?.cover_letter?.contact?.name || 'Cover_Letter';
                    const filename = `${candidateName.replace(/\s+/g, '_')}_Cover_Letter.docx`;
                    saveAs(blob, filename);
                    showSuccess();
                    return;
                }

                // FALLBACK: Legacy download path
                console.log('âš ï¸ Using legacy cover letter download');

                const candidateName = analysisData?._candidate_name ||
                                     analysisData?._profile?.full_name ||
                                     analysisData?._resume_json?.candidate?.name ||
                                     'Candidate';
                const resumeData = analysisData?._resume_json || {};
                const profile = analysisData?._profile || {};

                const safeString = (val) => {
                    if (val === null || val === undefined) return '';
                    if (typeof val === 'string') return val;
                    if (typeof val === 'object') {
                        if (val.city && val.state) return `${val.city}, ${val.state}`;
                        if (val.location) return String(val.location);
                        if (val.name) return String(val.name);
                        return '';
                    }
                    return String(val);
                };

                const apiHeadline = documentsData?.resume_output?.headline ||
                                   analysisData?.resume_output?.headline ||
                                   analysisData?.headline || '';
                const targetRole = analysisData?._role || analysisData?.role_title || '';

                let tagline = '';
                if (apiHeadline) {
                    tagline = apiHeadline;
                } else if (profile.tagline || resumeData.tagline || profile.current_title) {
                    tagline = safeString(profile.tagline || resumeData.tagline || profile.current_title);
                } else if (targetRole) {
                    const competencies = resumeData.core_competencies || profile.core_competencies ||
                                        analysisData?.required_skills || analysisData?.ats_keywords || [];
                    const topCompetencies = competencies.slice(0, 3).map(c => {
                        return String(c).trim().split(' ')
                            .map(w => w.charAt(0).toUpperCase() + w.slice(1).toLowerCase())
                            .join(' ');
                    });
                    if (topCompetencies.length > 0) {
                        tagline = targetRole + ' | ' + topCompetencies.join(' | ');
                    } else {
                        tagline = targetRole;
                    }
                }

                const contactPhone = safeString(profile.phone || resumeData.contact?.phone || resumeData.candidate?.contact?.phone);
                const contactEmail = safeString(profile.email || resumeData.contact?.email || resumeData.candidate?.contact?.email);
                const contactLinkedin = safeString(profile.linkedin || resumeData.contact?.linkedin || resumeData.candidate?.contact?.linkedin);
                let contactLocation = safeString(profile.location || resumeData.contact?.location || resumeData.candidate?.contact?.location);
                if (!contactLocation) {
                    contactLocation = safeString(analysisData?.job_location ||
                                                 analysisData?._profile?.location ||
                                                 resumeData.experience?.[0]?.location);
                }

                const coverLetterText = documentsData.cover_letter?.full_text || '';
                const paragraphs = coverLetterText
                    .split(/\n\n+/)
                    .map(p => p.trim())
                    .filter(p => p.length > 0 && !p.toLowerCase().startsWith('dear') && !p.toLowerCase().startsWith('sincerely'));

                const requestPayload = {
                    candidate_name: String(candidateName),
                    tagline: tagline,
                    contact: {
                        phone: contactPhone,
                        email: contactEmail,
                        linkedin: contactLinkedin,
                        location: contactLocation
                    },
                    recipient_name: null,
                    paragraphs: paragraphs.map(p => String(p))
                };

                console.log('Cover letter download payload:', requestPayload);

                const response = await fetch(`${API_BASE}/api/download/cover-letter`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestPayload)
                });

                if (!response.ok) {
                    throw new Error(`Failed to generate cover letter: ${response.status}`);
                }

                const blob = await response.blob();
                const filename = `${candidateName.replace(/\s+/g, '_')}_Cover_Letter.docx`;
                saveAs(blob, filename);
                showSuccess();

            } catch (error) {
                console.error('Error downloading cover letter:', error);
                alert('Error downloading cover letter: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }

        // Show error state
        function showError(elementId, message) {
            const el = document.getElementById(elementId);
            el.innerHTML = `
                <div class="error-state">
                    <p>${message}</p>
                    <a href="/results">&larr; Go back and try again</a>
                </div>
            `;
        }

        /**
         * SINGLE SOURCE OF TRUTH: Display Job Fit warning banner
         */
        function checkAndDisplayJobFitWarning(analysisData) {
            const banner = document.getElementById('jobFitWarningBanner');
            const title = document.getElementById('warningTitle');
            const message = document.getElementById('warningMessage');

            if (!banner) return;

            const recommendation = (analysisData.recommendation || '').toLowerCase();
            const lockedReason = analysisData.experience_analysis?.locked_reason ||
                                 analysisData.locked_reason || '';
            const proceededDespiteGuidance = sessionStorage.getItem('proceeded_despite_guidance') === 'true';
            const targetRole = analysisData.role_title || analysisData._role || 'this role';

            if (recommendation === 'do not apply' || recommendation === 'skip') {
                banner.style.display = 'flex';

                if (proceededDespiteGuidance) {
                    banner.classList.add('proceeded');
                    title.textContent = 'You Chose to Proceed Despite Guidance';
                    message.textContent = `HenryHQ recommended "Do Not Apply" for "${targetRole}". ` +
                        `These documents are generated, but we recommend focusing your energy on higher-fit roles.`;
                } else {
                    title.textContent = 'Not Recommended for This Role';
                    message.textContent = lockedReason ||
                        `HenryHQ recommends "Do Not Apply" for "${targetRole}". ` +
                        `Generating documents for this role is not advised.`;
                }
            } else {
                banner.style.display = 'none';
            }
        }

        // Load documents on page load
        window.addEventListener('DOMContentLoaded', async () => {
            // Auto-resize textareas on input
            document.querySelectorAll('.document-text').forEach(textarea => {
                textarea.addEventListener('input', function() {
                    this.style.height = 'auto';
                    this.style.height = this.scrollHeight + 'px';
                });
            });

            // Get analysis data
            let analysisDataStr = sessionStorage.getItem('analysisData');
            if (!analysisDataStr) {
                analysisDataStr = localStorage.getItem('analysisData_backup');
                if (analysisDataStr) {
                    console.log('Safari fallback: loaded analysisData from localStorage');
                    sessionStorage.setItem('analysisData', analysisDataStr);
                }
            }

            if (!analysisDataStr) {
                window.location.href = '/index';
                return;
            }
            analysisData = JSON.parse(analysisDataStr);

            // Set role title in header
            const roleTitleEl = document.getElementById('roleTitle');
            if (roleTitleEl) {
                const targetRole = analysisData._role || analysisData.role_title || '';
                const company = analysisData._company_name || analysisData._company || '';
                if (targetRole && company) {
                    roleTitleEl.textContent = `${targetRole} at ${company}`;
                } else if (targetRole) {
                    roleTitleEl.textContent = targetRole;
                }
            }

            // Check and display Job Fit decision
            checkAndDisplayJobFitWarning(analysisData);

            // Get documents data
            let documentsDataStr = sessionStorage.getItem('documentsData');

            if (!documentsDataStr) {
                const company = analysisData._company || analysisData.company_name || '';
                const role = analysisData._role || analysisData.role_title || '';

                if (typeof HenryData !== 'undefined' && company && role) {
                    try {
                        const apps = await HenryData.getApplications();
                        const matchingApp = apps.find(app =>
                            app.company.toLowerCase() === company.toLowerCase() &&
                            app.role.toLowerCase() === role.toLowerCase()
                        );
                        if (matchingApp && matchingApp.documentsData && Object.keys(matchingApp.documentsData).length > 0) {
                            documentsDataStr = JSON.stringify(matchingApp.documentsData);
                            sessionStorage.setItem('documentsData', documentsDataStr);
                            console.log('Loaded documents from Supabase');
                        }
                    } catch (err) {
                        console.log('Could not load from Supabase:', err);
                    }
                }

                if (!documentsDataStr && company && role) {
                    const documentsKey = `documents_${company}_${role}`.toLowerCase().replace(/[^a-z0-9_]/g, '_');
                    documentsDataStr = localStorage.getItem(documentsKey);
                    console.log('Loaded documents from localStorage:', documentsKey, !!documentsDataStr);
                    if (documentsDataStr) {
                        sessionStorage.setItem('documentsData', documentsDataStr);
                    }
                }
            }

            if (!documentsDataStr) {
                console.error('No documents data found in sessionStorage or localStorage');
                showError('resumeLoading', 'Documents not generated yet. Please go back to <a href="/results">Results</a> and click "Build my application" to generate your tailored documents.');
                showError('coverLetterLoading', 'Documents not generated yet. Please go back to <a href="/results">Results</a> and click "Build my application" to generate your tailored documents.');
                document.getElementById('downloadResumeBtn').disabled = true;
                document.getElementById('downloadCoverLetterBtn').disabled = true;
                return;
            }

            try {
                documentsData = JSON.parse(documentsDataStr);
                console.log('Documents data loaded:', documentsData);
            } catch (e) {
                console.error('Error parsing documents data:', e);
                showError('resumeLoading', 'Error loading documents. Please go back and regenerate.');
                showError('coverLetterLoading', 'Error loading documents. Please go back and regenerate.');
                return;
            }

            // ATS Keywords
            const keywordsContainer = document.getElementById('resumeKeywords');
            const changesSummary = documentsData.changes_summary || {};
            const resumeChanges = changesSummary.resume || {};
            const keywords = resumeChanges.ats_keywords ||
                            documentsData.resume_output?.ats_keywords ||
                            [];

            if (keywords.length === 0) {
                keywordsContainer.innerHTML = '<span style="color: var(--color-text-secondary); font-style: italic; font-size: 0.8rem;">Keywords extracted from job description</span>';
            } else {
                keywords.forEach(keyword => {
                    const tag = document.createElement('div');
                    tag.className = 'keyword-tag';
                    tag.textContent = keyword;
                    keywordsContainer.appendChild(tag);
                });
            }

            // Update keywords count badge
            const countEl = document.getElementById('keywordsCount');
            if (countEl && keywords.length > 0) {
                countEl.textContent = keywords.length;
            }

            // Helper to safely extract string value
            const safeStr = (val) => {
                if (val === null || val === undefined) return '';
                if (typeof val === 'string') return val;
                if (typeof val === 'object') {
                    if (val.city && val.state) return `${val.city}, ${val.state}`;
                    if (val.location) return String(val.location);
                    if (val.name) return String(val.name);
                    return '';
                }
                return String(val);
            };

            // Get candidate info for header
            const candidateName = analysisData?._candidate_name ||
                                 analysisData?._profile?.full_name ||
                                 analysisData?._resume_json?.candidate?.name ||
                                 'Candidate';
            const resumeData = analysisData?._resume_json || {};
            const profile = analysisData?._profile || {};

            // Build tagline
            const apiHeadline = documentsData?.resume_output?.headline ||
                               analysisData?.resume_output?.headline ||
                               analysisData?.headline || '';
            const targetRole = analysisData?._role || analysisData?.role_title || '';

            let tagline = '';
            if (apiHeadline) {
                tagline = apiHeadline;
            } else if (profile.tagline || resumeData.tagline || profile.current_title) {
                tagline = safeStr(profile.tagline || resumeData.tagline || profile.current_title);
            } else if (targetRole) {
                tagline = targetRole;
            }

            const contact = resumeData.contact || {};
            const phone = safeStr(profile.phone || contact.phone);
            const email = safeStr(profile.email || contact.email);
            const linkedin = safeStr(profile.linkedin || contact.linkedin);
            const location = safeStr(profile.location || contact.location);

            const contactParts = [phone, email, linkedin, location].filter(p => p);
            const contactLine = contactParts.join(' | ');

            const resumeHeader = `${candidateName.toUpperCase()}
${tagline}
${contactLine}

${'â”€'.repeat(60)}

`;

            // Resume preview - USE CANONICAL HTML IF AVAILABLE (WYSIWYG)
            const resumePreviewDiv = document.getElementById('resumePreview');
            const resumeTextarea = document.getElementById('resumeText');

            if (documentsData.resume_output?.canonical_html) {
                resumePreviewDiv.innerHTML = documentsData.resume_output.canonical_html;
                resumePreviewDiv.style.display = 'block';
                resumeTextarea.style.display = 'none';
                console.log('âœ… Using WYSIWYG HTML resume preview (single source of truth)');

                if (documentsData.resume_output?.canonical_full_text) {
                    resumeTextarea.value = documentsData.resume_output.canonical_full_text;
                }
            } else if (documentsData.resume_output?.canonical_full_text) {
                resumePreviewDiv.style.display = 'none';
                resumeTextarea.style.display = 'block';
                resumeTextarea.value = documentsData.resume_output.canonical_full_text;
                resumeTextarea.style.height = 'auto';
                resumeTextarea.style.height = resumeTextarea.scrollHeight + 'px';
                console.log('âš ï¸ Using canonical text preview (no HTML available)');
            } else {
                const resumeBody = documentsData.resume_output?.full_text ||
                            documentsData.resume?.full_text ||
                            'Resume content not available.';
                const resumeText = resumeHeader + resumeBody;
                resumePreviewDiv.style.display = 'none';
                resumeTextarea.style.display = 'block';
                resumeTextarea.value = resumeText;
                resumeTextarea.style.height = 'auto';
                resumeTextarea.style.height = resumeTextarea.scrollHeight + 'px';
                console.log('âš ï¸ Using legacy resume preview (may differ from download)');
            }

            document.getElementById('resumeLoading').style.display = 'none';
            document.getElementById('downloadResumeBtn').disabled = false;

            // Check document integrity
            if (documentsData.document_integrity && !documentsData.document_integrity.passed) {
                const issues = documentsData.document_integrity.issues || [];
                console.warn('âš ï¸ Document integrity issues:', issues);
                const criticalIssues = issues.filter(i =>
                    i.type === 'missing_name' || i.type === 'missing_email'
                );
                if (criticalIssues.length > 0) {
                    showIntegrityWarning(criticalIssues);
                }
            }

            // Cover letter header
            const coverLetterHeader = `${candidateName.toUpperCase()}
${tagline}
${contactLine}

${'â”€'.repeat(60)}

COVER LETTER

`;

            // Cover letter preview
            let coverLetterBody;
            if (documentsData.cover_letter?.canonical_full_text) {
                coverLetterBody = documentsData.cover_letter.canonical_full_text;
                console.log('âœ… Using canonical cover letter preview');
            } else {
                coverLetterBody = documentsData.cover_letter?.full_text ||
                                 'Cover letter content not available.';
                console.log('âš ï¸ Using legacy cover letter preview');
            }
            const coverLetterText = coverLetterHeader + coverLetterBody;

            document.getElementById('coverLetterLoading').style.display = 'none';
            const coverLetterTextarea = document.getElementById('coverLetterText');
            coverLetterTextarea.style.display = 'block';
            coverLetterTextarea.value = coverLetterText;
            coverLetterTextarea.style.height = 'auto';
            coverLetterTextarea.style.height = coverLetterTextarea.scrollHeight + 'px';
            document.getElementById('downloadCoverLetterBtn').disabled = false;
        });

        // Show integrity warning banner
        function showIntegrityWarning(issues) {
            const banner = document.getElementById('jobFitWarningBanner');
            if (banner) {
                const title = document.getElementById('warningTitle');
                const message = document.getElementById('warningMessage');

                title.textContent = 'Document Issue Detected';
                message.innerHTML = issues.map(i =>
                    `<strong>${i.message}</strong>: ${i.fix}`
                ).join('<br>');

                banner.style.display = 'flex';
                banner.style.background = 'linear-gradient(135deg, rgba(248, 113, 113, 0.15), rgba(248, 113, 113, 0.08))';
            }
        }

        // Show Job Fit Impact delta
        function showFitScoreDelta(fitScoreDelta) {
            if (!fitScoreDelta) return;

            const container = document.getElementById('fitScoreDelta');
            if (!container) return;

            document.getElementById('scoreBefore').textContent = `${fitScoreDelta.original_score}%`;
            document.getElementById('scoreAfter').textContent = `${fitScoreDelta.final_score}%`;
            document.getElementById('verdictBefore').textContent = fitScoreDelta.original_verdict;
            document.getElementById('verdictAfter').textContent = fitScoreDelta.final_verdict;
            document.getElementById('deltaSummary').textContent = fitScoreDelta.improvement_summary;

            const badge = document.getElementById('deltaBadge');
            if (fitScoreDelta.delta > 0) {
                badge.textContent = `+${fitScoreDelta.delta}%`;
                badge.className = 'delta-badge improved';
            } else if (fitScoreDelta.delta === 0) {
                badge.textContent = 'No change';
                badge.className = 'delta-badge unchanged';
            } else {
                badge.textContent = `${fitScoreDelta.delta}%`;
                badge.className = 'delta-badge unchanged';
            }

            container.style.display = 'block';
            console.log('âœ… Showing fit score delta:', fitScoreDelta);
        }

        // Recalculate fit score after user edits
        async function recalculateFitScore() {
            const btn = document.getElementById('recalculateBtn');
            if (!btn) return;

            const resumeTextarea = document.getElementById('resumeText');
            const editedResumeText = resumeTextarea?.value || '';

            if (!editedResumeText.trim()) {
                showSuccessMessage('No resume content to analyze');
                return;
            }

            const currentAnalysisData = JSON.parse(sessionStorage.getItem('analysisData') || localStorage.getItem('analysisData_backup') || '{}');
            const jobId = currentAnalysisData._job_id;

            if (!jobId) {
                showSuccessMessage('Job context not found');
                return;
            }

            btn.classList.add('loading');
            btn.disabled = true;

            try {
                const response = await fetch('/api/fit-score/recalculate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        job_id: jobId,
                        edited_resume_text: editedResumeText
                    })
                });

                if (!response.ok) {
                    throw new Error('Failed to recalculate fit score');
                }

                const result = await response.json();

                if (result.fit_score_delta) {
                    showFitScoreDelta(result.fit_score_delta);

                    const documentsData = JSON.parse(sessionStorage.getItem('documentsData') || '{}');
                    if (documentsData.canonical_document?.metadata) {
                        documentsData.canonical_document.metadata.fit_score_delta = result.fit_score_delta;
                        sessionStorage.setItem('documentsData', JSON.stringify(documentsData));
                    }

                    const improvement = result.fit_score_delta.delta;
                    if (improvement > 0) {
                        showSuccessMessage(`Score improved by ${improvement}%!`);
                    } else if (improvement === 0) {
                        showSuccessMessage('Score unchanged');
                    } else {
                        showSuccessMessage('Score recalculated');
                    }
                }
            } catch (error) {
                console.error('Fit score recalculation error:', error);
                showSuccessMessage('Could not recalculate score');
            } finally {
                btn.classList.remove('loading');
                btn.disabled = false;
            }
        }

        // Lock fit score at download
        function lockFitScoreAtDownload() {
            const documentsData = JSON.parse(sessionStorage.getItem('documentsData') || '{}');
            if (documentsData.canonical_document?.metadata?.fit_score_delta) {
                documentsData.canonical_document.metadata.fit_score_delta.score_locked = true;
                documentsData.canonical_document.metadata.fit_score_delta.locked_at = new Date().toISOString();
                sessionStorage.setItem('documentsData', JSON.stringify(documentsData));

                const deltaLabel = document.querySelector('.fit-score-delta .delta-label');
                if (deltaLabel) {
                    deltaLabel.innerHTML = 'Job Fit Impact <span style="font-size: 0.7rem; color: var(--color-success);">&#10003; Final</span>';
                }
                console.log('âœ… Fit score locked at download');
            }
        }

        // Initialize fit score delta on page load
        document.addEventListener('DOMContentLoaded', () => {
            const documentsData = JSON.parse(sessionStorage.getItem('documentsData') || '{}');
            const fitScoreDelta = documentsData.canonical_document?.metadata?.fit_score_delta;
            if (fitScoreDelta) {
                showFitScoreDelta(fitScoreDelta);

                if (fitScoreDelta.score_locked) {
                    const deltaLabel = document.querySelector('.fit-score-delta .delta-label');
                    if (deltaLabel) {
                        deltaLabel.innerHTML = 'Job Fit Impact <span style="font-size: 0.7rem; color: var(--color-success);">&#10003; Final</span>';
                    }
                }
            }

            // Auto-switch tab if requested (e.g. from Document Library)
            const requestedTab = sessionStorage.getItem('switchToTab');
            if (requestedTab) {
                sessionStorage.removeItem('switchToTab');
                switchTab(requestedTab);
            }
        });
    </script>
<script src="components/analytics.js"></script>
<script src="components/hey-henry.js"></script>
<script src="components/admin-alerts.js"></script>
<script src="components/strategy-nav.js"></script>
    <script src="components/status-banner.js"></script>
<script src="components/top-nav.js"></script>
</body>
</html>

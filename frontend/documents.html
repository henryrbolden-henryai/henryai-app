<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Your Tailored Documents - HenryHQ</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Instrument+Serif:ital@0;1&display=swap" rel="stylesheet">
    <!-- docx.js for client-side DOCX generation -->
    <script src="https://unpkg.com/docx@8.2.2/build/index.umd.js"></script>
    <!-- FileSaver.js for downloading -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 100%);
            color: #e0e0e0;
            padding: 20px;
            min-height: 100vh;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .back-link {
            display: inline-flex;
            align-items: center;
            color: #60a5fa;
            text-decoration: none;
            margin-bottom: 30px;
            font-size: 14px;
            transition: color 0.2s;
        }

        .back-link:hover {
            color: #93c5fd;
        }

        h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .subtitle {
            color: #9ca3af;
            margin-bottom: 40px;
            font-size: 1.1rem;
        }

        .disclaimer {
            color: #6b7280;
            font-size: 0.85rem;
            font-style: italic;
            margin-top: 20px;
            margin-bottom: 10px;
            text-align: center;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            border-bottom: 2px solid #374151;
        }

        .tab {
            padding: 12px 24px;
            background: transparent;
            border: none;
            color: #9ca3af;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
        }

        .tab:hover {
            color: #e0e0e0;
        }

        .tab.active {
            color: #60a5fa;
            border-bottom-color: #60a5fa;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .document-section {
            background: #1f2937;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
            border: 1px solid #374151;
        }

        .document-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }

        .document-title {
            font-size: 1.5rem;
            color: #60a5fa;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .btn-download {
            padding: 12px 24px;
            background: #60a5fa;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-download:hover {
            background: #3b82f6;
            transform: translateY(-2px);
        }

        .btn-download:disabled {
            background: #4b5563;
            cursor: not-allowed;
            transform: none;
        }

        .keywords-section {
            margin-bottom: 25px;
        }

        .keywords-label {
            font-size: 0.9rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: #9ca3af;
            margin-bottom: 12px;
        }

        .keywords {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .keyword-tag {
            padding: 6px 14px;
            background: rgba(96, 165, 250, 0.2);
            border: 1px solid #60a5fa;
            border-radius: 20px;
            font-size: 0.9rem;
            color: #60a5fa;
        }

        .document-preview {
            background: #ffffff;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            padding: 40px;
            max-height: 600px;
            overflow-y: auto;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        .document-preview::-webkit-scrollbar {
            width: 8px;
        }

        .document-preview::-webkit-scrollbar-track {
            background: #f3f4f6;
        }

        .document-preview::-webkit-scrollbar-thumb {
            background: #9ca3af;
            border-radius: 4px;
        }

        .document-text {
            width: 100%;
            background: transparent;
            border: none;
            color: #1f2937;
            font-family: 'Georgia', 'Times New Roman', serif;
            font-size: 13px;
            line-height: 1.7;
            resize: vertical;
            min-height: 500px;
        }

        .document-text:focus {
            outline: none;
        }

        .loading-state {
            text-align: center;
            padding: 60px 20px;
            color: #9ca3af;
        }

        .loading-spinner {
            border: 3px solid #374151;
            border-top: 3px solid #60a5fa;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .success-message {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #10b981;
            color: white;
            padding: 16px 24px;
            border-radius: 8px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
            opacity: 0;
            transform: translateY(-20px);
            transition: all 0.3s;
            z-index: 1000;
        }

        .success-message.show {
            opacity: 1;
            transform: translateY(0);
        }

        /* Post-Download Modal */
        .post-download-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .post-download-modal.show {
            display: flex;
        }

        .modal-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(4px);
        }

        .post-download-modal .modal-content {
            position: relative;
            background: linear-gradient(135deg, #1f2937 0%, #111827 100%);
            border: 1px solid #374151;
            border-radius: 20px;
            padding: 40px;
            max-width: 480px;
            width: 90%;
            text-align: center;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
            animation: modalSlideIn 0.3s ease;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(20px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .modal-close {
            position: absolute;
            top: 16px;
            right: 16px;
            background: none;
            border: none;
            color: #9ca3af;
            font-size: 24px;
            cursor: pointer;
            transition: color 0.2s;
        }

        .modal-close:hover {
            color: #ffffff;
        }

        .modal-icon {
            font-size: 48px;
            margin-bottom: 20px;
        }

        .post-download-modal h3 {
            font-size: 1.5rem;
            color: #ffffff;
            margin-bottom: 16px;
        }

        .modal-stat {
            color: #d1d5db;
            font-size: 1rem;
            margin-bottom: 12px;
        }

        .modal-stat strong {
            color: #22d3ee;
        }

        .modal-insight {
            color: #9ca3af;
            font-size: 0.95rem;
            margin-bottom: 28px;
            line-height: 1.6;
        }

        .modal-actions {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .modal-btn-primary {
            padding: 14px 28px;
            background: #22d3ee;
            color: #000;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            text-decoration: none;
            transition: all 0.2s;
        }

        .modal-btn-primary:hover {
            background: #06b6d4;
            transform: translateY(-2px);
        }

        .modal-btn-secondary {
            padding: 12px 24px;
            background: transparent;
            color: #9ca3af;
            border: 1px solid #4b5563;
            border-radius: 10px;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .modal-btn-secondary:hover {
            background: rgba(255, 255, 255, 0.05);
            color: #e0e0e0;
        }

        .error-state {
            text-align: center;
            padding: 40px 20px;
            color: #f87171;
        }

        .error-state p {
            margin-bottom: 20px;
        }

        .error-state a {
            color: #60a5fa;
            text-decoration: none;
        }

        .error-state a:hover {
            text-decoration: underline;
        }

        .navigation {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 40px;
            padding-top: 30px;
            border-top: 1px solid #374151;
        }

        .btn {
            padding: 14px 28px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            border: none;
            transition: all 0.2s;
            text-decoration: none;
            display: inline-block;
        }

        .btn-primary {
            background: #60a5fa;
            color: white;
        }

        .btn-primary:hover {
            background: #3b82f6;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: transparent;
            color: #9ca3af;
            border: 1px solid #4b5563;
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.05);
            color: #e0e0e0;
        }

        @media (max-width: 768px) {
            h1 {
                font-size: 2rem;
            }

            .document-header {
                flex-direction: column;
                gap: 15px;
                align-items: stretch;
            }

            .btn-download {
                width: 100%;
                justify-content: center;
            }

            .navigation {
                flex-direction: column-reverse;
                gap: 15px;
            }

            .btn {
                width: 100%;
                text-align: center;
            }
        }

        /* HEADER */
        header {
            padding: 24px 0;
            border-bottom: 1px solid #374151;
            margin-bottom: 32px;
        }

        header .header-container {
            max-width: 900px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .logo {
            font-family: 'Instrument Serif', Georgia, serif;
            font-size: 1.8rem;
            color: #ffffff;
            text-decoration: none;
            position: fixed;
            left: 90px;
            top: 24px;
            z-index: 100;
        }

        /* Hide page header when strategy-nav is present */
        body.has-strategy-nav header,
        body.has-strategy-nav .logo {
            display: none !important;
        }

        .logo em {
            font-style: italic;
            color: #22d3ee;
        }

        .header-nav {
            display: flex;
            gap: 24px;
            align-items: center;
        }

        .nav-link {
            color: #9ca3af;
            text-decoration: none;
            font-size: 0.9rem;
            transition: color 0.2s ease;
        }

        .nav-link:hover {
            color: #22d3ee;
        }

        /* SINGLE SOURCE OF TRUTH: Job Fit Warning Banner */
        .job-fit-warning-banner {
            background: linear-gradient(135deg, rgba(248, 113, 113, 0.15), rgba(248, 113, 113, 0.08));
            border: 1px solid rgba(248, 113, 113, 0.4);
            border-radius: 12px;
            padding: 16px 20px;
            margin-bottom: 24px;
            display: flex;
            align-items: flex-start;
            gap: 12px;
        }

        .job-fit-warning-banner.proceeded {
            background: linear-gradient(135deg, rgba(251, 191, 36, 0.1), rgba(251, 191, 36, 0.05));
            border-color: rgba(251, 191, 36, 0.3);
        }

        .job-fit-warning-banner .warning-icon {
            font-size: 1.5rem;
            flex-shrink: 0;
        }

        .job-fit-warning-banner .warning-content {
            flex: 1;
        }

        .job-fit-warning-banner strong {
            display: block;
            color: #f87171;
            margin-bottom: 4px;
        }

        .job-fit-warning-banner.proceeded strong {
            color: #fbbf24;
        }

        .job-fit-warning-banner p {
            color: #a1a1aa;
            font-size: 0.9rem;
            margin: 0;
            line-height: 1.5;
        }
    </style>
    <link rel="stylesheet" href="css/mobile.css">
    <!-- Supabase Auth -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/supabase-client.js"></script>
</head>
<body>
    <!-- HEADER -->
    <header>
        <div class="header-container">
            <a href="index.html" class="logo"><em>Henry</em>HQ</a>
        </div>
    </header>

    <div class="container">
        <!-- SINGLE SOURCE OF TRUTH: Job Fit Accountability Banner -->
        <div id="jobFitWarningBanner" class="job-fit-warning-banner" style="display: none;">
            <div class="warning-icon">‚ö†Ô∏è</div>
            <div class="warning-content">
                <strong id="warningTitle">HenryHQ Guidance</strong>
                <p id="warningMessage"></p>
            </div>
        </div>

        <h1>
            <span>üìÑ</span> Your Tailored Documents
        </h1>
        <p class="subtitle">ATS-optimized resume and custom cover letter for this role</p>

        <!-- Tabs -->
        <div class="tabs">
            <button class="tab active" onclick="switchTab('resume')">Resume</button>
            <button class="tab" onclick="switchTab('coverLetter')">Cover Letter</button>
            <button class="tab" onclick="switchTab('linkedin')">LinkedIn</button>
        </div>

        <!-- Resume Tab -->
        <div id="resumeTab" class="tab-content active">
            <div class="document-section">
                <div class="document-header">
                    <div class="document-title">
                        <span>üìù</span> Tailored Resume
                    </div>
                    <button class="btn-download" id="downloadResumeBtn" onclick="downloadResume()">
                        <span>‚Üì</span> Download Resume
                    </button>
                </div>

                <div class="keywords-section">
                    <div class="keywords-label">ATS Keywords Incorporated</div>
                    <div class="keywords" id="resumeKeywords">
                        <!-- Keywords will be inserted here -->
                    </div>
                </div>

                <div class="document-preview">
                    <div id="resumeLoading" class="loading-state">
                        <div class="loading-spinner"></div>
                        <div>Loading resume...</div>
                    </div>
                    <textarea class="document-text" id="resumeText" style="display: none;"></textarea>
                </div>
            </div>
        </div>

        <!-- Cover Letter Tab -->
        <div id="coverLetterTab" class="tab-content">
            <div class="document-section">
                <div class="document-header">
                    <div class="document-title">
                        <span>‚úâÔ∏è</span> Cover Letter
                    </div>
                    <button class="btn-download" id="downloadCoverLetterBtn" onclick="downloadCoverLetter()">
                        <span>‚Üì</span> Download Cover Letter
                    </button>
                </div>

                <div class="document-preview">
                    <div id="coverLetterLoading" class="loading-state">
                        <div class="loading-spinner"></div>
                        <div>Loading cover letter...</div>
                    </div>
                    <textarea class="document-text" id="coverLetterText" style="display: none;"></textarea>
                </div>
            </div>
        </div>

        <!-- LinkedIn Tab -->
        <div id="linkedinTab" class="tab-content">
            <div class="document-section linkedin-document-section">
                <div class="document-header">
                    <div class="document-title">
                        <span>üíº</span> LinkedIn Optimization Strategy
                    </div>
                </div>
                <p class="section-subtitle" style="color: var(--color-text-secondary); margin-bottom: 20px;">Tailored recommendations to maximize recruiter visibility</p>

                <div id="linkedin-optimized-content">
                    <!-- Populated dynamically by linkedin-upload.js -->
                </div>
            </div>
        </div>

        <p class="disclaimer">* Preview formatting may differ from downloaded document. We strongly encourage proofreading before submitting.</p>
    </div>

    <!-- Success Message -->
    <div class="success-message" id="successMessage">Downloaded Successfully</div>

    <!-- Post-Download Modal -->
    <div class="post-download-modal" id="postDownloadModal">
        <div class="modal-overlay" onclick="closePostDownloadModal()"></div>
        <div class="modal-content">
            <button class="modal-close" onclick="closePostDownloadModal()">&times;</button>
            <div class="modal-icon">ü§ù</div>
            <h3>Great, your documents are ready!</h3>
            <p class="modal-stat">But here's the reality: <strong>70% of jobs are filled through referrals.</strong></p>
            <p class="modal-insight" id="networkModalInsight">
                Direct outreach to the hiring team could significantly improve your chances of landing an interview.
            </p>
            <div class="modal-actions">
                <a href="outreach.html" class="modal-btn-primary">View Outreach Strategy</a>
                <button class="modal-btn-secondary" onclick="closePostDownloadModal()">Maybe Later</button>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const API_BASE = window.location.hostname === 'localhost' ? 'http://localhost:8000' : 'https://henryai-app-production.up.railway.app';

        // Get the docx library from the global scope
        const { Document, Packer, Paragraph, TextRun, HeadingLevel, AlignmentType } = docx;

        let documentsData = null;
        let analysisData = null;

        // Switch tabs
        function switchTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');

            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            if (tabName === 'resume') {
                document.getElementById('resumeTab').classList.add('active');
            } else if (tabName === 'coverLetter') {
                document.getElementById('coverLetterTab').classList.add('active');
            } else if (tabName === 'linkedin') {
                document.getElementById('linkedinTab').classList.add('active');
            }
        }

        // Show success message
        function showSuccess() {
            const msg = document.getElementById('successMessage');
            msg.classList.add('show');
            setTimeout(() => msg.classList.remove('show'), 3000);

            // Show post-download modal after a brief delay (only once per session)
            const modalShown = sessionStorage.getItem('networkModalShown');
            if (!modalShown) {
                setTimeout(() => {
                    showPostDownloadModal();
                }, 1500);
            }
        }

        // Post-download modal functions
        function showPostDownloadModal() {
            const modal = document.getElementById('postDownloadModal');
            modal.classList.add('show');
            sessionStorage.setItem('networkModalShown', 'true');

            // Update modal insight with personalized content if available
            const insightEl = document.getElementById('networkModalInsight');
            if (analysisData) {
                const outreach = analysisData.outreach_intelligence || {};
                const company = analysisData._company_name || analysisData.company_name || 'this company';

                if (outreach.hiring_manager_likely_title) {
                    insightEl.textContent = `I found the likely hiring manager (${outreach.hiring_manager_likely_title}) at ${company}. Direct outreach could significantly improve your chances.`;
                } else {
                    insightEl.textContent = `I can help you identify who to contact at ${company} and craft personalized outreach messages.`;
                }
            }
        }

        function closePostDownloadModal() {
            const modal = document.getElementById('postDownloadModal');
            modal.classList.remove('show');
        }

        // Create a DOCX document from text
        function createDocxFromText(text, title) {
            const paragraphs = text.split('\n').map(line => {
                // Check if it's a section header (ALL CAPS or ends with colon)
                const isHeader = /^[A-Z\s&]+$/.test(line.trim()) ||
                                 (line.trim().endsWith(':') && line.trim().length < 50);

                // Check if it's a bullet point
                const isBullet = line.trim().startsWith('‚Ä¢') || line.trim().startsWith('-');

                if (isHeader && line.trim().length > 0) {
                    return new Paragraph({
                        children: [
                            new TextRun({
                                text: line.trim(),
                                bold: true,
                                size: 24 // 12pt
                            })
                        ],
                        spacing: { before: 240, after: 120 }
                    });
                } else if (isBullet) {
                    return new Paragraph({
                        children: [
                            new TextRun({
                                text: line.trim(),
                                size: 22 // 11pt
                            })
                        ],
                        spacing: { after: 60 },
                        indent: { left: 360 }
                    });
                } else {
                    return new Paragraph({
                        children: [
                            new TextRun({
                                text: line,
                                size: 22 // 11pt
                            })
                        ],
                        spacing: { after: 120 }
                    });
                }
            });

            return new Document({
                sections: [{
                    properties: {},
                    children: paragraphs
                }]
            });
        }

        // Download resume as DOCX (using server-side professional formatter)
        async function downloadResume() {
            if (!documentsData || !documentsData.resume_output) {
                alert('Resume not available. Please go back and regenerate.');
                return;
            }

            const btn = document.getElementById('downloadResumeBtn');
            const originalText = btn.innerHTML;

            try {
                btn.disabled = true;
                btn.innerHTML = '<span>‚è≥</span> Generating...';

                // Get candidate data from multiple possible sources
                const candidateName = analysisData?._candidate_name ||
                                     analysisData?._profile?.full_name ||
                                     analysisData?._resume_json?.candidate?.name ||
                                     'Candidate';
                const resumeData = analysisData?._resume_json || {};
                const profile = analysisData?._profile || {};

                console.log('Building resume with data:', { candidateName, resumeData, profile, analysisData });

                // Normalize skills to Dict[str, List[str]] format
                let normalizedSkills = {};
                const skillsSource = resumeData.skills || profile.skills;
                if (skillsSource) {
                    if (Array.isArray(skillsSource)) {
                        // If skills is an array, convert to object
                        normalizedSkills = { "Skills": skillsSource };
                    } else if (typeof skillsSource === 'object') {
                        // Ensure each value is an array
                        for (const [key, value] of Object.entries(skillsSource)) {
                            normalizedSkills[key] = Array.isArray(value) ? value : [value];
                        }
                    }
                }

                // Normalize education to proper format
                let normalizedEducation = {};
                const eduSource = resumeData.education || profile.education || analysisData?._profile?.education;
                if (eduSource) {
                    if (Array.isArray(eduSource) && eduSource.length > 0) {
                        const edu = eduSource[0];
                        normalizedEducation = {
                            school: edu.school || edu.institution || edu.university || edu.name || '',
                            degree: edu.degree || edu.qualification || edu.field_of_study ||
                                    (edu.degree_name ? `${edu.degree_name}${edu.field_of_study ? ', ' + edu.field_of_study : ''}` : ''),
                            details: edu.details || edu.highlights || edu.activities || []
                        };
                    } else if (typeof eduSource === 'object' && !Array.isArray(eduSource)) {
                        normalizedEducation = {
                            school: eduSource.school || eduSource.institution || eduSource.university || eduSource.name || '',
                            degree: eduSource.degree || eduSource.qualification || eduSource.field_of_study || '',
                            details: eduSource.details || eduSource.highlights || []
                        };
                    } else if (typeof eduSource === 'string') {
                        // If education is just a string, try to parse school and degree
                        // Common format: "School Name, Degree" or "Degree - School"
                        const parts = eduSource.split(/[,\-‚Äì]/).map(p => p.trim());
                        if (parts.length >= 2) {
                            // Try to identify which is school vs degree
                            const degreeKeywords = ['bachelor', 'master', 'phd', 'b.a.', 'b.s.', 'm.a.', 'm.s.', 'mba', 'degree'];
                            const firstIsDegree = degreeKeywords.some(kw => parts[0].toLowerCase().includes(kw));
                            if (firstIsDegree) {
                                normalizedEducation = { school: parts.slice(1).join(', '), degree: parts[0], details: [] };
                            } else {
                                normalizedEducation = { school: parts[0], degree: parts.slice(1).join(', '), details: [] };
                            }
                        } else {
                            normalizedEducation = { school: '', degree: eduSource, details: [] };
                        }
                    }
                }

                // Helper to safely extract string value
                const safeString = (val) => {
                    if (val === null || val === undefined) return '';
                    if (typeof val === 'string') return val;
                    if (typeof val === 'object') {
                        // Try common location object patterns
                        if (val.city && val.state) return `${val.city}, ${val.state}`;
                        if (val.location) return String(val.location);
                        if (val.name) return String(val.name);
                        return '';
                    }
                    return String(val);
                };

                // Extract contact info carefully
                const contactPhone = safeString(profile.phone || resumeData.contact?.phone || resumeData.candidate?.contact?.phone);
                const contactEmail = safeString(profile.email || resumeData.contact?.email || resumeData.candidate?.contact?.email);
                const contactLinkedin = safeString(profile.linkedin || resumeData.contact?.linkedin || resumeData.candidate?.contact?.linkedin);
                // Try multiple sources for location - profile, contact, job posting location, first experience location
                let contactLocation = safeString(profile.location || resumeData.contact?.location || resumeData.candidate?.contact?.location);
                if (!contactLocation) {
                    // Try to get from job posting or first experience
                    contactLocation = safeString(analysisData?.job_location ||
                                                 analysisData?._profile?.location ||
                                                 resumeData.experience?.[0]?.location);
                }

                // Get the tailored experience from documentsData - this is already in STRATEGIC order
                // Use experience_sections which contains the strategic ordering from Claude
                const experienceSections = documentsData.resume_output?.experience_sections || [];

                // Map experience_sections to the format expected by backend
                const mergedExperience = experienceSections.map(job => {
                    return {
                        company: safeString(job.company || ''),
                        title: safeString(job.title || ''),
                        location: safeString(job.location || ''),
                        dates: safeString(job.dates || ''),
                        overview: safeString(job.overview || job.company_overview || ''),
                        bullets: Array.isArray(job.bullets) ? job.bullets : []
                    };
                });

                // Build tagline from target role and competencies (like package.html does)
                let tagline = safeString(profile.tagline || resumeData.tagline || profile.current_title || '');
                if (!tagline) {
                    // Build from role and competencies
                    const targetRole = analysisData?._role || analysisData?.role_title || '';
                    const apiHeadline = analysisData?.resume_output?.headline || documentsData?.resume_output?.headline || '';

                    if (apiHeadline && apiHeadline.includes('|')) {
                        // Use the API-provided headline
                        tagline = apiHeadline;
                    } else if (targetRole) {
                        // Build from role + competencies
                        const competencies = resumeData.core_competencies || profile.core_competencies ||
                                            analysisData?.required_skills || analysisData?.ats_keywords || [];
                        const topCompetencies = competencies.slice(0, 3).map(c => {
                            // Clean and title case
                            return String(c).trim().split(' ')
                                .map(w => w.charAt(0).toUpperCase() + w.slice(1).toLowerCase())
                                .join(' ');
                        });
                        if (topCompetencies.length > 0) {
                            tagline = targetRole + ' | ' + topCompetencies.join(' | ');
                        } else {
                            tagline = targetRole;
                        }
                    }
                }

                // Get tailored competencies from API response (priority) or fall back to resume data
                const tailoredCompetencies = documentsData.resume_output?.core_competencies ||
                                            documentsData.resume_output?.competencies ||
                                            analysisData?.core_competencies ||
                                            resumeData.core_competencies ||
                                            profile.core_competencies ||
                                            [];

                // Get tailored skills from API response
                let tailoredSkills = normalizedSkills;
                const apiSkills = documentsData.resume_output?.skills || analysisData?.skills;
                if (apiSkills) {
                    if (typeof apiSkills === 'object' && !Array.isArray(apiSkills)) {
                        // Already in correct format
                        tailoredSkills = {};
                        for (const [key, value] of Object.entries(apiSkills)) {
                            tailoredSkills[key] = Array.isArray(value) ? value : [value];
                        }
                    } else if (Array.isArray(apiSkills)) {
                        tailoredSkills = { "Skills": apiSkills };
                    }
                }

                // Build request payload for professional formatter
                const requestPayload = {
                    candidate_name: candidateName,
                    tagline: tagline,
                    contact: {
                        phone: contactPhone,
                        email: contactEmail,
                        linkedin: contactLinkedin,
                        location: contactLocation
                    },
                    summary: safeString(documentsData.resume_output?.summary || resumeData.summary || ''),
                    competencies: Array.isArray(tailoredCompetencies) ? tailoredCompetencies : [],
                    experience: mergedExperience,
                    skills: tailoredSkills,
                    education: normalizedEducation
                };

                console.log('Resume download payload:', requestPayload);

                const response = await fetch(`${API_BASE}/api/download/resume`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestPayload)
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    console.error('Server error details:', errorData);
                    throw new Error(`Failed to generate resume: ${response.status} - ${JSON.stringify(errorData.detail || errorData)}`);
                }

                // Download the file
                const blob = await response.blob();
                const filename = `${candidateName.replace(/\s+/g, '_')}_Resume.docx`;
                saveAs(blob, filename);
                showSuccess();

            } catch (error) {
                console.error('Error downloading resume:', error);
                alert('Error downloading resume: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }

        // Download cover letter as DOCX (using server-side professional formatter)
        async function downloadCoverLetter() {
            if (!documentsData || !documentsData.cover_letter) {
                alert('Cover letter not available. Please go back and regenerate.');
                return;
            }

            const btn = document.getElementById('downloadCoverLetterBtn');
            const originalText = btn.innerHTML;

            try {
                btn.disabled = true;
                btn.innerHTML = '<span>‚è≥</span> Generating...';

                const candidateName = analysisData?._candidate_name ||
                                     analysisData?._profile?.full_name ||
                                     analysisData?._resume_json?.candidate?.name ||
                                     'Candidate';
                const resumeData = analysisData?._resume_json || {};
                const profile = analysisData?._profile || {};

                // Helper to safely extract string value
                const safeString = (val) => {
                    if (val === null || val === undefined) return '';
                    if (typeof val === 'string') return val;
                    if (typeof val === 'object') {
                        if (val.city && val.state) return `${val.city}, ${val.state}`;
                        if (val.location) return String(val.location);
                        if (val.name) return String(val.name);
                        return '';
                    }
                    return String(val);
                };

                // Build tagline - prioritize API headline from job analysis
                const apiHeadline = documentsData?.resume_output?.headline ||
                                   analysisData?.resume_output?.headline ||
                                   analysisData?.headline || '';
                const targetRole = analysisData?._role || analysisData?.role_title || '';

                let tagline = '';

                // Priority 1: API-generated headline (most accurate to job description)
                if (apiHeadline) {
                    tagline = apiHeadline;
                }
                // Priority 2: Profile/resume tagline
                else if (profile.tagline || resumeData.tagline || profile.current_title) {
                    tagline = safeString(profile.tagline || resumeData.tagline || profile.current_title);
                }
                // Priority 3: Build from job role + competencies
                else if (targetRole) {
                    const competencies = resumeData.core_competencies || profile.core_competencies ||
                                        analysisData?.required_skills || analysisData?.ats_keywords || [];
                    const topCompetencies = competencies.slice(0, 3).map(c => {
                        return String(c).trim().split(' ')
                            .map(w => w.charAt(0).toUpperCase() + w.slice(1).toLowerCase())
                            .join(' ');
                    });
                    if (topCompetencies.length > 0) {
                        tagline = targetRole + ' | ' + topCompetencies.join(' | ');
                    } else {
                        tagline = targetRole;
                    }
                }

                console.log('Tagline sources:', { apiHeadline, targetRole, profileTagline: profile.tagline, tagline });

                // Extract contact info
                const contactPhone = safeString(profile.phone || resumeData.contact?.phone || resumeData.candidate?.contact?.phone);
                const contactEmail = safeString(profile.email || resumeData.contact?.email || resumeData.candidate?.contact?.email);
                const contactLinkedin = safeString(profile.linkedin || resumeData.contact?.linkedin || resumeData.candidate?.contact?.linkedin);
                let contactLocation = safeString(profile.location || resumeData.contact?.location || resumeData.candidate?.contact?.location);
                if (!contactLocation) {
                    contactLocation = safeString(analysisData?.job_location ||
                                                 analysisData?._profile?.location ||
                                                 resumeData.experience?.[0]?.location);
                }

                // Split cover letter into paragraphs
                const coverLetterText = documentsData.cover_letter?.full_text || '';
                const paragraphs = coverLetterText
                    .split(/\n\n+/)
                    .map(p => p.trim())
                    .filter(p => p.length > 0 && !p.toLowerCase().startsWith('dear') && !p.toLowerCase().startsWith('sincerely'));

                // Build request payload for professional formatter
                const requestPayload = {
                    candidate_name: String(candidateName),
                    tagline: tagline,
                    contact: {
                        phone: contactPhone,
                        email: contactEmail,
                        linkedin: contactLinkedin,
                        location: contactLocation
                    },
                    recipient_name: null,
                    paragraphs: paragraphs.map(p => String(p))
                };

                console.log('Cover letter download payload:', requestPayload);

                const response = await fetch(`${API_BASE}/api/download/cover-letter`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestPayload)
                });

                if (!response.ok) {
                    throw new Error(`Failed to generate cover letter: ${response.status}`);
                }

                // Download the file
                const blob = await response.blob();
                const filename = `${candidateName.replace(/\s+/g, '_')}_Cover_Letter.docx`;
                saveAs(blob, filename);
                showSuccess();

            } catch (error) {
                console.error('Error downloading cover letter:', error);
                alert('Error downloading cover letter: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }

        // Show error state
        function showError(elementId, message) {
            const el = document.getElementById(elementId);
            el.innerHTML = `
                <div class="error-state">
                    <p>${message}</p>
                    <a href="results.html">‚Üê Go back and try again</a>
                </div>
            `;
        }

        /**
         * SINGLE SOURCE OF TRUTH: Display Job Fit warning banner
         * Per QA Spec: Documents page MUST reference Job Fit decision
         */
        function checkAndDisplayJobFitWarning(analysisData) {
            const banner = document.getElementById('jobFitWarningBanner');
            const title = document.getElementById('warningTitle');
            const message = document.getElementById('warningMessage');

            if (!banner) return;

            const recommendation = (analysisData.recommendation || '').toLowerCase();
            const lockedReason = analysisData.experience_analysis?.locked_reason ||
                                 analysisData.locked_reason || '';
            const proceededDespiteGuidance = sessionStorage.getItem('proceeded_despite_guidance') === 'true';
            const targetRole = analysisData.role_title || analysisData._role || 'this role';

            // Check for "Do Not Apply" recommendation
            if (recommendation === 'do not apply' || recommendation === 'skip') {
                banner.style.display = 'flex';

                if (proceededDespiteGuidance) {
                    banner.classList.add('proceeded');
                    title.textContent = 'You Chose to Proceed Despite Guidance';
                    message.textContent = `HenryHQ recommended "Do Not Apply" for "${targetRole}". ` +
                        `These documents are generated, but we recommend focusing your energy on higher-fit roles.`;
                } else {
                    title.textContent = 'Not Recommended for This Role';
                    message.textContent = lockedReason ||
                        `HenryHQ recommends "Do Not Apply" for "${targetRole}". ` +
                        `Generating documents for this role is not advised.`;
                }
            } else {
                banner.style.display = 'none';
            }
        }

        // Load documents on page load
        window.addEventListener('DOMContentLoaded', async () => {
            // Get analysis data for candidate name
            const analysisDataStr = sessionStorage.getItem('analysisData');
            if (!analysisDataStr) {
                window.location.href = 'index.html';
                return;
            }
            analysisData = JSON.parse(analysisDataStr);

            // =========================================================================
            // SINGLE SOURCE OF TRUTH: Check and display Job Fit decision
            // Per QA Spec Rule 6: Documents page MUST reference Job Fit decision
            // =========================================================================
            checkAndDisplayJobFitWarning(analysisData);

            // Get documents data - try sessionStorage first, then Supabase, then localStorage fallback
            let documentsDataStr = sessionStorage.getItem('documentsData');

            // If not in sessionStorage, try to load from Supabase or localStorage
            if (!documentsDataStr) {
                const company = analysisData._company || analysisData.company_name || '';
                const role = analysisData._role || analysisData.role_title || '';

                // Try Supabase first
                if (typeof HenryData !== 'undefined' && company && role) {
                    try {
                        const apps = await HenryData.getApplications();
                        const matchingApp = apps.find(app =>
                            app.company.toLowerCase() === company.toLowerCase() &&
                            app.role.toLowerCase() === role.toLowerCase()
                        );
                        if (matchingApp && matchingApp.documentsData && Object.keys(matchingApp.documentsData).length > 0) {
                            documentsDataStr = JSON.stringify(matchingApp.documentsData);
                            sessionStorage.setItem('documentsData', documentsDataStr);
                            console.log('Loaded documents from Supabase');
                        }
                    } catch (err) {
                        console.log('Could not load from Supabase:', err);
                    }
                }

                // Fallback to localStorage
                if (!documentsDataStr && company && role) {
                    const documentsKey = `documents_${company}_${role}`.toLowerCase().replace(/[^a-z0-9_]/g, '_');
                    documentsDataStr = localStorage.getItem(documentsKey);
                    console.log('Loaded documents from localStorage:', documentsKey, !!documentsDataStr);

                    // Also restore to sessionStorage for consistency
                    if (documentsDataStr) {
                        sessionStorage.setItem('documentsData', documentsDataStr);
                    }
                }
            }

            if (!documentsDataStr) {
                console.error('No documents data found in sessionStorage or localStorage');
                showError('resumeLoading', 'Documents not generated yet. Please go back to <a href="results.html">Results</a> and click "Build my application" to generate your tailored documents.');
                showError('coverLetterLoading', 'Documents not generated yet. Please go back to <a href="results.html">Results</a> and click "Build my application" to generate your tailored documents.');
                document.getElementById('downloadResumeBtn').disabled = true;
                document.getElementById('downloadCoverLetterBtn').disabled = true;
                return;
            }

            try {
                documentsData = JSON.parse(documentsDataStr);
                console.log('Documents data loaded:', documentsData);
            } catch (e) {
                console.error('Error parsing documents data:', e);
                showError('resumeLoading', 'Error loading documents. Please go back and regenerate.');
                showError('coverLetterLoading', 'Error loading documents. Please go back and regenerate.');
                return;
            }

            // ATS Keywords
            const keywordsContainer = document.getElementById('resumeKeywords');
            const changesSummary = documentsData.changes_summary || {};
            const resumeChanges = changesSummary.resume || {};
            const keywords = resumeChanges.ats_keywords ||
                            documentsData.resume_output?.ats_keywords ||
                            [];

            if (keywords.length === 0) {
                keywordsContainer.innerHTML = '<span style="color: #9ca3af; font-style: italic;">Keywords extracted from job description</span>';
            } else {
                keywords.forEach(keyword => {
                    const tag = document.createElement('div');
                    tag.className = 'keyword-tag';
                    tag.textContent = keyword;
                    keywordsContainer.appendChild(tag);
                });
            }

            // Helper to safely extract string value
            const safeStr = (val) => {
                if (val === null || val === undefined) return '';
                if (typeof val === 'string') return val;
                if (typeof val === 'object') {
                    if (val.city && val.state) return `${val.city}, ${val.state}`;
                    if (val.location) return String(val.location);
                    if (val.name) return String(val.name);
                    return '';
                }
                return String(val);
            };

            // Get candidate info for header
            const candidateName = analysisData?._candidate_name ||
                                 analysisData?._profile?.full_name ||
                                 analysisData?._resume_json?.candidate?.name ||
                                 'Candidate';
            const resumeData = analysisData?._resume_json || {};
            const profile = analysisData?._profile || {};

            // Build tagline - prioritize API headline from job analysis
            const apiHeadline = documentsData?.resume_output?.headline ||
                               analysisData?.resume_output?.headline ||
                               analysisData?.headline || '';
            const targetRole = analysisData?._role || analysisData?.role_title || '';

            let tagline = '';
            if (apiHeadline) {
                tagline = apiHeadline;
            } else if (profile.tagline || resumeData.tagline || profile.current_title) {
                tagline = safeStr(profile.tagline || resumeData.tagline || profile.current_title);
            } else if (targetRole) {
                tagline = targetRole;
            }

            const contact = resumeData.contact || {};
            const phone = safeStr(profile.phone || contact.phone);
            const email = safeStr(profile.email || contact.email);
            const linkedin = safeStr(profile.linkedin || contact.linkedin);
            const location = safeStr(profile.location || contact.location);

            // Build contact line
            const contactParts = [phone, email, linkedin, location].filter(p => p);
            const contactLine = contactParts.join(' | ');

            // Build resume header
            const resumeHeader = `${candidateName.toUpperCase()}
${tagline}
${contactLine}

${'‚îÄ'.repeat(60)}

`;

            // Resume preview with header
            const resumeBody = documentsData.resume_output?.full_text ||
                              documentsData.resume?.full_text ||
                              'Resume content not available.';
            const resumeText = resumeHeader + resumeBody;

            document.getElementById('resumeLoading').style.display = 'none';
            document.getElementById('resumeText').style.display = 'block';
            document.getElementById('resumeText').value = resumeText;
            document.getElementById('downloadResumeBtn').disabled = false;

            // Build cover letter header (same format)
            const coverLetterHeader = `${candidateName.toUpperCase()}
${tagline}
${contactLine}

${'‚îÄ'.repeat(60)}

COVER LETTER

`;

            // Cover letter preview with header
            const coverLetterBody = documentsData.cover_letter?.full_text ||
                                   'Cover letter content not available.';
            const coverLetterText = coverLetterHeader + coverLetterBody;

            document.getElementById('coverLetterLoading').style.display = 'none';
            document.getElementById('coverLetterText').style.display = 'block';
            document.getElementById('coverLetterText').value = coverLetterText;
            document.getElementById('downloadCoverLetterBtn').disabled = false;
        });
    </script>
<script src="components/hey-henry.js"></script>
<script src="components/strategy-nav.js"></script>
    <script src="components/status-banner.js"></script>

    <!-- LinkedIn Upload Feature -->
    <link rel="stylesheet" href="css/linkedin.css">
    <script src="js/linkedin-upload.js"></script>
    <script>
        // Initialize LinkedIn section on documents page
        document.addEventListener('DOMContentLoaded', () => {
            // Render LinkedIn optimized sections (or upload prompt)
            if (window.linkedInUpload) {
                // Get job context from session storage
                const analysisData = JSON.parse(sessionStorage.getItem('analysisData') || '{}');
                const documentsData = JSON.parse(sessionStorage.getItem('documentsData') || '{}');
                const linkedinScoringResults = JSON.parse(sessionStorage.getItem('linkedinScoringResults') || '{}');

                // Get optimized LinkedIn sections if profile is uploaded
                const profile = window.linkedInUpload.getUserProfile();
                if (profile && profile.linkedin_profile_uploaded) {
                    // Fetch optimized sections from API
                    window.linkedInUpload.getOptimizedSections(analysisData._job_id)
                        .then(optimizedData => {
                            if (optimizedData && !optimizedData.error) {
                                // Enhance with scoring data
                                const enhancedData = enhanceWithScoringData(optimizedData, linkedinScoringResults);
                                window.linkedInUpload.renderOptimizedSections('linkedin-optimized-content', enhancedData);
                            } else {
                                // Fallback: generate from existing data + scoring insights
                                const fallbackData = generateFallbackOptimizedSections(analysisData, documentsData, linkedinScoringResults);
                                window.linkedInUpload.renderOptimizedSections('linkedin-optimized-content', fallbackData);
                            }
                        })
                        .catch(err => {
                            console.error('Error loading LinkedIn optimizations:', err);
                            // Fallback: generate from existing data + scoring insights
                            const fallbackData = generateFallbackOptimizedSections(analysisData, documentsData, linkedinScoringResults);
                            window.linkedInUpload.renderOptimizedSections('linkedin-optimized-content', fallbackData);
                        });
                } else {
                    // Show upload prompt
                    window.linkedInUpload.renderOptimizedSections('linkedin-optimized-content', null);
                }
            }
        });

        // Enhance API data with scoring insights
        function enhanceWithScoringData(optimizedData, scoringResults) {
            if (!scoringResults || !scoringResults.painPoints) return optimizedData;

            return {
                ...optimizedData,
                pain_points: scoringResults.painPoints,
                recommendations: scoringResults.recommendations,
                has_issues: scoringResults.painPoints?.length > 0
            };
        }

        // Generate fallback optimized sections from analysis/documents data + scoring insights
        function generateFallbackOptimizedSections(analysisData, documentsData, scoringResults) {
            const resumeOutput = documentsData?.resume_output || {};
            const profile = JSON.parse(localStorage.getItem('userProfile') || '{}');
            const linkedinParsed = profile.linkedin_parsed || {};

            const role = analysisData?._role || analysisData?.role_title || '';
            const company = analysisData?._company_name || analysisData?.company_name || '';
            const level = analysisData?._level || resumeOutput?.detected_level || 'Senior';

            // Get current LinkedIn content for comparison
            const currentHeadline = linkedinParsed.headline || '';
            const currentSummary = linkedinParsed.summary || linkedinParsed.about || '';

            // Generate comprehensive headline with keywords and metrics
            const headline = generateComprehensiveHeadline(linkedinParsed, resumeOutput, analysisData, level);

            // Generate headline explanation
            const headlineWhy = generateHeadlineWhy(headline, analysisData);

            // Generate comprehensive summary/about section
            const summary = generateComprehensiveSummary(linkedinParsed, resumeOutput, analysisData);

            // Generate summary explanation
            const summaryWhy = generateSummaryWhy(summary, analysisData);

            // Get skills with add/remove recommendations
            const skillsData = getSkillsRecommendations(linkedinParsed, resumeOutput, analysisData);

            // Get experience optimizations with full structure
            const experienceOptimizations = getExperienceOptimizations(linkedinParsed, resumeOutput, analysisData);

            // Determine severity based on how much needs updating
            const severity = determineSeverity(currentHeadline, headline, currentSummary, summary, linkedinParsed);

            return {
                // Severity banner
                severity: severity,
                summary_message: getSeverityMessage(severity, role, company),
                benefits: getSeverityBenefits(severity),

                // Headline section (Critical)
                current_headline: currentHeadline,
                headline: headline,
                headline_why: headlineWhy,
                headline_update_reason: currentHeadline ? 'Your current headline may not be optimized for recruiter searches' : 'A strong headline is critical for appearing in LinkedIn searches',

                // About section (Critical)
                current_summary: currentSummary,
                summary: summary,
                summary_why: summaryWhy,
                summary_update_reason: 'First 3 lines show before "see more" - make them count',

                // Experience section (High)
                experience_optimizations: experienceOptimizations,

                // Skills section (High)
                top_skills: skillsData.topSkills,
                skills_to_add: skillsData.skillsToAdd,
                skills_to_remove: skillsData.skillsToRemove,
                skills_why: skillsData.skillsWhy,

                // Optional sections
                featured_recommendation: getFeaturedRecommendation(resumeOutput, analysisData),
                featured_suggestions: getFeaturedSuggestions(resumeOutput, analysisData),
                recommendations_advice: 'Request recommendations from people who can speak to specific achievements. Quality over quantity.',
                who_to_ask: getWhoToAsk(resumeOutput, analysisData),
                activity_guidance: getActivityGuidance(analysisData, level),

                // Metadata
                has_issues: severity === 'CRITICAL' || severity === 'HIGH',
                pain_points: scoringResults?.painPoints || [],
                recommendations: scoringResults?.recommendations || {},
                generated_at: new Date().toISOString()
            };
        }

        // Generate comprehensive headline with role, expertise, and differentiators
        // FORMULA: [Seniority] [Function] | [Specialization] | Ex-[Companies] | [Domain Expertise]
        // HARD LIMIT: 220 characters (LinkedIn will truncate anything longer)
        // NEVER include: years of experience, number of hires, parenthetical explanations
        function generateComprehensiveHeadline(linkedinParsed, resumeOutput, analysisData, level) {
            const MAX_CHARS = 220;
            const role = analysisData?._role || analysisData?.role_title || '';

            // Get experience data for brand signals
            const experience = linkedinParsed.experience || [];
            const companies = experience.map(e => e.company).filter(Boolean);

            // Build headline following the formula
            const functionalArea = getBroadFunctionalArea(analysisData, resumeOutput) || role;

            // PART 1: Seniority + Function (required, 20-40 chars)
            let part1 = '';
            if (level && functionalArea) {
                part1 = `${level} ${functionalArea}`;
            } else if (role) {
                part1 = role;
            } else {
                part1 = 'Talent Acquisition Leader';
            }

            // PART 2: Specialization (15-35 chars) - MUST be role-appropriate
            let part2 = '';
            // Detect actual role type from role AND current title
            const isRecruiter = /recruit|talent acquisition|sourcer|headhunter/i.test(role);
            const isEngineer = /engineer|developer|software|technical|architect/i.test(role);
            const isProduct = /product manager|product lead|pm\b/i.test(role);
            const isMarketing = /marketing|growth|brand/i.test(role);
            const isSales = /sales|account|business development|revenue/i.test(role);
            const isExecutive = /executive|director|vp|c-suite|head of|chief/i.test(role);

            if (isRecruiter && isExecutive) {
                part2 = 'Executive Search & Leadership Talent';
            } else if (isRecruiter) {
                part2 = 'Full-Cycle Talent Acquisition';
            } else if (isEngineer) {
                part2 = 'Building Scalable Systems';
            } else if (isProduct) {
                part2 = 'Product Strategy & Execution';
            } else if (isMarketing) {
                part2 = 'Growth & Brand Strategy';
            } else if (isSales) {
                part2 = 'Revenue Growth & GTM';
            } else if (isExecutive) {
                part2 = 'Strategic Leadership';
            } else {
                // Use ATS keywords or functional area
                const topKeyword = (resumeOutput.ats_keywords || [])[0];
                part2 = topKeyword ? topKeyword.split(' ').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ') : 'Strategic Execution';
            }

            // PART 3: Brand Signals - Clean company names only
            // Rules:
            // - Max 3 companies
            // - Skip unknown consultancies, stealth startups, self-employed
            // - Remove parenthetical explanations like "(Independent Consultancy)"
            // - Format: "Ex-Company1, Company2, Company3"
            const skipPatterns = /stealth|independent|self-employed|freelance|consultant|consulting|advisory|contract/i;
            const cleanCompanies = companies
                .map(c => {
                    // Remove suffixes and parenthetical content
                    return c
                        .replace(/\s*\([^)]*\)/g, '') // Remove (anything in parens)
                        .replace(/\s*(Inc\.|LLC|Corp\.?|Limited|Ltd\.?|GmbH|SA|BV)$/i, '')
                        .trim();
                })
                .filter(c => c.length > 0 && c.length < 25 && !skipPatterns.test(c))
                .slice(0, 3);

            let part3 = '';
            if (cleanCompanies.length > 0) {
                part3 = `Ex-${cleanCompanies.join(', ')}`;
            }

            // PART 4: Domain Expertise - Specific scope/level (NOT lowercase skill dump)
            // Must be capitalized and specific - ROLE APPROPRIATE
            let part4 = '';
            if (isRecruiter && isExecutive) {
                part4 = 'Fortune 500 & C-Suite Hires';
            } else if (isRecruiter) {
                part4 = 'Enterprise & Growth-Stage';
            } else if (isEngineer) {
                part4 = 'Distributed Systems & Scale';
            } else if (isProduct) {
                part4 = '0-1 & Growth Products';
            } else if (isMarketing) {
                part4 = 'B2B & B2C Growth';
            } else if (isSales) {
                part4 = 'Enterprise & Mid-Market';
            } else if (isExecutive) {
                part4 = 'Strategy & Operations';
            } else {
                // Use second ATS keyword or generic
                const secondKeyword = (resumeOutput.ats_keywords || [])[1];
                part4 = secondKeyword ? secondKeyword.split(' ').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ') : 'Cross-Functional Leadership';
            }

            // Build headline with strict character validation
            // Start with all 4 parts
            let parts = [part1, part2, part3, part4].filter(p => p.length > 0);
            let headline = parts.join(' | ');

            // If over limit, progressively remove parts from the end
            while (headline.length > MAX_CHARS && parts.length > 2) {
                parts.pop();
                headline = parts.join(' | ');
            }

            // If still over limit (unlikely), truncate domain expertise
            if (headline.length > MAX_CHARS) {
                // Try shorter domain expertise
                if (parts.length >= 3) {
                    parts[parts.length - 1] = 'VP & Director Hires';
                    headline = parts.join(' | ');
                }
            }

            // Final safety check - hard truncate if somehow still over
            if (headline.length > MAX_CHARS) {
                headline = headline.substring(0, MAX_CHARS - 3) + '...';
            }

            // VALIDATION: Log warning if headline is suboptimal
            if (headline.length < 100) {
                console.warn('Headline may be too short:', headline.length, 'chars');
            }

            return headline;
        }

        // Generate explanation for why the headline works
        function generateHeadlineWhy(headline, analysisData) {
            const reasons = [];

            if (headline.includes('|')) {
                reasons.push('Uses pipe separators for scannability in search results');
            }
            if (/\d+/.test(headline)) {
                reasons.push('Includes quantified achievements that build credibility');
            }
            if (headline.length >= 100) {
                reasons.push('Uses available character space effectively (220 max)');
            }

            const role = analysisData?._role || '';
            if (role && headline.toLowerCase().includes(role.toLowerCase().split(' ')[0])) {
                reasons.push('Contains keywords recruiters search for');
            }

            if (reasons.length === 0) {
                reasons.push('Clearly communicates your professional identity');
                reasons.push('Optimized for recruiter search visibility');
            }

            return reasons;
        }

        // Generate comprehensive About/Summary section (4 paragraphs, 600-800 words)
        // CRITICAL: Must be role-agnostic and use ONLY the candidate's actual data
        function generateComprehensiveSummary(linkedinParsed, resumeOutput, analysisData) {
            const role = analysisData?._role || analysisData?.role_title || 'professional';
            const years = extractYearsExperience(linkedinParsed, resumeOutput) || 10;
            const functionalArea = getBroadFunctionalArea(analysisData, resumeOutput) || role;
            const metrics = extractKeyMetrics(resumeOutput);
            const atsKeywords = resumeOutput.ats_keywords || analysisData?.ats_keywords || analysisData?.required_skills || [];

            // Get experience data from LinkedIn or resume
            const experience = linkedinParsed.experience || [];
            const currentRole = experience[0] || {};
            const previousRoles = experience.slice(1, 3);

            // Extract key information from ACTUAL candidate data
            const currentTitle = currentRole.title || resumeOutput.experience_sections?.[0]?.title || role;
            const currentCompany = currentRole.company || resumeOutput.experience_sections?.[0]?.company || '';
            const allBullets = [];
            (resumeOutput.experience_sections || []).forEach(exp => {
                if (exp.bullets) allBullets.push(...exp.bullets);
            });

            // Detect role type for appropriate language
            const isRecruiter = /recruit|talent acquisition|sourcer|headhunter/i.test(role) ||
                               /recruit|talent acquisition/i.test(currentTitle);
            const isEngineer = /engineer|developer|software|technical|architect/i.test(role) ||
                              /engineer|developer/i.test(currentTitle);
            const isProduct = /product manager|product lead|pm\b/i.test(role) ||
                             /product/i.test(currentTitle);
            const isMarketing = /marketing|growth|brand/i.test(role) ||
                               /marketing/i.test(currentTitle);
            const isSales = /sales|account|business development|revenue/i.test(role) ||
                           /sales|account/i.test(currentTitle);

            // PARAGRAPH 1: Value Proposition (role-specific hook)
            let para1 = '';
            if (isRecruiter) {
                para1 = `I build ${functionalArea.toLowerCase()} functions that become competitive advantages, not bottlenecks. `;
                para1 += `With ${years}+ years of experience across high-growth startups to Fortune 500 companies, I've learned that the best talent strategies are about building organizations that can execute on ambitious goals. `;
                para1 += `My approach combines strategic vision with operational excellence: I architect scalable processes, instrument everything for continuous improvement, and partner with leadership to ensure talent strategy aligns with business outcomes.`;
            } else if (isEngineer) {
                para1 = `I build systems that scale and teams that ship. `;
                para1 += `With ${years}+ years of experience in software engineering, I've developed expertise in designing, building, and operating complex technical systems. `;
                para1 += `My approach balances technical excellence with pragmatic delivery: I focus on solving real problems, writing maintainable code, and building systems that can evolve with business needs.`;
            } else if (isProduct) {
                para1 = `I build products that customers love and businesses depend on. `;
                para1 += `With ${years}+ years in product management, I've shipped features and products across different stages and scales. `;
                para1 += `My approach combines deep customer empathy with business acumen: I start with the problem, validate assumptions with data, and ship iteratively to maximize learning and impact.`;
            } else if (isMarketing) {
                para1 = `I build brands and drive growth through strategic marketing initiatives. `;
                para1 += `With ${years}+ years of marketing experience, I've developed expertise in building awareness, generating demand, and driving measurable business results. `;
                para1 += `My approach combines creative storytelling with data-driven optimization: I believe the best marketing connects authentic brand narrative with customer needs.`;
            } else if (isSales) {
                para1 = `I build relationships and close deals that drive business growth. `;
                para1 += `With ${years}+ years in sales and business development, I've developed expertise in identifying opportunities, building trust, and delivering value to customers. `;
                para1 += `My approach combines consultative selling with systematic execution: I focus on understanding customer needs and aligning solutions that create mutual value.`;
            } else {
                para1 = `I deliver results in ${functionalArea.toLowerCase()} by combining strategic thinking with hands-on execution. `;
                para1 += `With ${years}+ years of experience, I've developed expertise across multiple aspects of my field. `;
                para1 += `My approach balances big-picture strategy with attention to detail: I focus on what matters, iterate based on feedback, and deliver outcomes that move the business forward.`;
            }

            // PARAGRAPH 2: Methodology/Approach (role-specific)
            let para2 = '';
            if (isRecruiter) {
                para2 = `My approach is ruthlessly prioritized and data-informed. `;
                para2 += `I don't chase requisitions. I chase outcomes that move the business forward. `;
                para2 += `I start with the business problem, pressure-test assumptions with market data, and build processes that deliver quality hires at scale. `;
                para2 += `When something isn't working, I iterate quickly, ego aside.`;
            } else if (isEngineer) {
                para2 = `My approach is grounded in fundamentals and focused on outcomes. `;
                para2 += `I believe good engineering is about making the right tradeoffs: balancing speed with quality, simplicity with flexibility, and innovation with reliability. `;
                para2 += `I write code that's readable, testable, and maintainable. I document decisions so others can understand the context. `;
                para2 += `When something breaks, I fix the root cause, not just the symptom.`;
            } else if (isProduct) {
                para2 = `My approach is customer-obsessed and outcome-driven. `;
                para2 += `I believe the best product decisions come from deeply understanding user problems before jumping to solutions. `;
                para2 += `I use data to inform decisions but recognize that qualitative insight often reveals what metrics miss. `;
                para2 += `I prioritize ruthlessly: I'd rather ship one great feature than three mediocre ones.`;
            } else if (isMarketing) {
                para2 = `My approach balances creativity with accountability. `;
                para2 += `I believe great marketing tells authentic stories that resonate with the right audience at the right time. `;
                para2 += `I measure what matters and optimize based on results, not vanity metrics. `;
                para2 += `I build campaigns that scale: repeatable processes, clear attribution, and continuous learning.`;
            } else if (isSales) {
                para2 = `My approach is consultative and relationship-focused. `;
                para2 += `I believe the best sales outcomes come from genuinely understanding customer challenges and providing real solutions. `;
                para2 += `I qualify opportunities rigorously, invest time where it matters, and follow up relentlessly. `;
                para2 += `I track my pipeline systematically and forecast accurately.`;
            } else {
                para2 = `My approach is practical and results-oriented. `;
                para2 += `I believe in understanding the problem deeply before proposing solutions. `;
                para2 += `I communicate clearly, collaborate effectively, and deliver what I commit to. `;
                para2 += `When facing challenges, I stay focused on outcomes and adapt my approach as needed.`;
            }

            // PARAGRAPH 3: Track Record (use ACTUAL candidate data)
            let para3 = '';
            if (currentCompany) {
                para3 += `At ${currentCompany}, I've `;
                // Use role-appropriate language for metrics
                if (metrics.hires && isRecruiter) {
                    para3 += `personally sourced and closed ${metrics.hires}+ hires while maintaining quality standards. `;
                } else if (metrics.revenue) {
                    para3 += `contributed to ${metrics.revenue} in business impact. `;
                } else if (metrics.reduction) {
                    para3 += `achieved ${metrics.reduction} improvement in key metrics. `;
                } else {
                    para3 += `delivered meaningful results and grown my impact over time. `;
                }
            }

            // Add previous experience from ACTUAL data
            if (previousRoles.length > 0) {
                const prevCompanies = previousRoles.map(r => r.company).filter(Boolean).join(' and ');
                if (prevCompanies) {
                    para3 += `Previously at ${prevCompanies}, I built on my experience and took on increasing responsibility. `;
                }
            }

            // Add achievement bullet if available from ACTUAL resume data
            const topBullet = allBullets.find(b => /\d+%|\$\d+|\d+\s*(hires|team|users|customers|revenue|growth)/i.test(b));
            if (topBullet) {
                para3 += topBullet + ' ';
            } else if (allBullets.length > 0) {
                // Use first actual bullet from their resume
                para3 += allBullets[0] + ' ';
            } else {
                // Generic fallback only if no data available
                para3 += `My track record demonstrates consistent delivery and progressive responsibility. `;
            }

            // PARAGRAPH 4: Current Focus + Call to Action (role-specific)
            let para4 = `Currently focused on: `;

            // Add ATS keywords as focus areas if available
            if (atsKeywords.length > 0) {
                const focusAreas = atsKeywords.slice(0, 4).map(kw =>
                    kw.charAt(0).toUpperCase() + kw.slice(1).toLowerCase()
                );
                para4 += focusAreas.join(', ') + '. ';
            } else {
                // Role-specific fallback
                if (isRecruiter) {
                    para4 += `Building scalable talent acquisition strategies and developing high-performing recruiting teams. `;
                } else if (isEngineer) {
                    para4 += `Building scalable systems, improving engineering practices, and mentoring the next generation of developers. `;
                } else if (isProduct) {
                    para4 += `Shipping products that solve real customer problems and drive measurable business outcomes. `;
                } else if (isMarketing) {
                    para4 += `Driving growth through strategic marketing initiatives and building memorable brand experiences. `;
                } else if (isSales) {
                    para4 += `Building pipeline, closing deals, and developing customer relationships that drive long-term value. `;
                } else {
                    para4 += `Delivering results in my field and continuing to grow my expertise. `;
                }
            }

            // Role-appropriate closing
            if (isRecruiter) {
                para4 += `If you're building something ambitious and need someone who can turn talent strategy into competitive advantage, let's connect.`;
            } else if (isEngineer) {
                para4 += `If you're building something technically interesting and need someone who can ship, let's connect.`;
            } else if (isProduct) {
                para4 += `If you're building products that matter and need someone who can drive them forward, let's connect.`;
            } else if (isMarketing) {
                para4 += `If you're building a brand that needs to break through the noise, let's connect.`;
            } else if (isSales) {
                para4 += `If you're building a sales organization that needs to hit ambitious targets, let's connect.`;
            } else {
                para4 += `If you're looking for someone who delivers results, let's connect.`;
            }

            // Combine all paragraphs with double newlines
            return `${para1}\n\n${para2}\n\n${para3}\n\n${para4}`;
        }

        // Generate explanation for why the summary works
        function generateSummaryWhy(summary, analysisData) {
            const reasons = [];

            if (summary.includes('\n\n')) {
                reasons.push('Uses white space for easy scanning');
            }
            if (/\d+/.test(summary)) {
                reasons.push('Includes quantified achievements that prove your value');
            }
            if (summary.toLowerCase().includes('connect') || summary.toLowerCase().includes('reach out')) {
                reasons.push('Ends with a clear call to action');
            }
            if (summary.includes('‚Ä¢') || summary.includes('-')) {
                reasons.push('Uses bullet points for key information');
            }

            // Check for keyword density
            const atsKeywords = analysisData?.ats_keywords || [];
            const keywordsFound = atsKeywords.filter(kw =>
                summary.toLowerCase().includes(kw.toLowerCase())
            ).length;

            if (keywordsFound >= 3) {
                reasons.push('Naturally incorporates searchable keywords');
            }

            if (reasons.length === 0) {
                reasons.push('First 3 lines hook the reader before "see more"');
                reasons.push('Tells your professional story with impact');
            }

            return reasons;
        }

        // Extract key metrics from resume output
        function extractKeyMetrics(resumeOutput) {
            const metrics = {};
            const allBullets = [];

            // Gather all bullets from experience sections
            (resumeOutput.experience_sections || []).forEach(exp => {
                if (exp.bullets) allBullets.push(...exp.bullets);
            });

            for (const bullet of allBullets) {
                // Look for hire/placement numbers
                const hireMatch = bullet.match(/(\d+)\+?\s*(hires|placements|candidates|positions)/i);
                if (hireMatch && !metrics.hires) {
                    metrics.hires = hireMatch[1];
                }

                // Look for team size
                const teamMatch = bullet.match(/team\s*of\s*(\d+)|(\d+)\s*(person|member|people)\s*team/i);
                if (teamMatch && !metrics.teamSize) {
                    metrics.teamSize = teamMatch[1] || teamMatch[2];
                }

                // Look for revenue/savings
                const revenueMatch = bullet.match(/\$[\d.]+[MKB]|\d+%\s*(increase|growth|reduction|savings)/i);
                if (revenueMatch && !metrics.revenue) {
                    metrics.revenue = revenueMatch[0];
                }

                // Look for reduction percentages
                const reductionMatch = bullet.match(/(\d+%)\s*(reduction|decrease|faster|improvement)/i);
                if (reductionMatch && !metrics.reduction) {
                    metrics.reduction = reductionMatch[1];
                }

                // Look for pipeline numbers
                if (/pipeline|talent pool|candidate pool/i.test(bullet)) {
                    metrics.pipeline = true;
                }
            }

            return metrics;
        }

        // Get top achievement from resume
        function getTopAchievement(resumeOutput) {
            const bullets = resumeOutput.experience_sections?.[0]?.bullets || [];

            // Find bullet with best metrics
            for (const bullet of bullets) {
                if (/\$[\d.]+[MKB]|\d+%|\d+\s*(hires|placements|team)/i.test(bullet)) {
                    return bullet;
                }
            }

            return bullets[0] || null;
        }

        // Get skills recommendations with add/remove
        // Skills must be SHORT KEYWORDS (2-5 words), not sentences
        // CRITICAL: Must be role-appropriate - no recruiter skills for engineers, etc.
        function getSkillsRecommendations(linkedinParsed, resumeOutput, analysisData) {
            const currentSkills = linkedinParsed.skills || [];
            const role = analysisData?._role || analysisData?.role_title || '';

            // Detect actual role type
            const isRecruiter = /recruit|talent acquisition|sourcer|headhunter/i.test(role);
            const isEngineer = /engineer|developer|software|technical|architect/i.test(role);
            const isProduct = /product manager|product lead|pm\b/i.test(role);
            const isMarketing = /marketing|growth|brand/i.test(role);
            const isSales = /sales|account|business development|revenue/i.test(role);
            const isExecutive = /executive|director|vp|c-suite|head of|chief/i.test(role);

            // Define skill keyword libraries by ACTUAL role type
            const recruiterSkills = [
                'Talent Acquisition', 'Full-Cycle Recruiting', 'Employer Branding',
                'Candidate Experience', 'Diversity Recruiting', 'Boolean Search',
                'LinkedIn Recruiter', 'ATS Systems', 'Sourcing Strategy',
                'Interview Training', 'Offer Negotiation', 'Workforce Planning'
            ];

            const executiveRecruiterSkills = [
                'Executive Search', 'C-Suite Recruiting', 'Board-Level Search',
                'Leadership Assessment', 'Succession Planning', 'Retained Search',
                'Talent Mapping', 'Executive Compensation', 'Stakeholder Management',
                'Organizational Design', 'Global Recruiting', 'VP-Level Hiring'
            ];

            const engineerSkills = [
                'Software Development', 'System Design', 'API Development',
                'Cloud Architecture', 'Microservices', 'CI/CD',
                'Code Review', 'Technical Leadership', 'Agile Development',
                'Performance Optimization', 'Database Design', 'DevOps'
            ];

            const productSkills = [
                'Product Strategy', 'Product Roadmapping', 'User Research',
                'A/B Testing', 'Data Analysis', 'Agile Methodology',
                'Stakeholder Management', 'Go-to-Market', 'Product Analytics',
                'User Experience', 'Feature Prioritization', 'Product Discovery'
            ];

            const marketingSkills = [
                'Digital Marketing', 'Content Strategy', 'SEO',
                'Marketing Analytics', 'Brand Strategy', 'Demand Generation',
                'Marketing Automation', 'Social Media Marketing', 'Campaign Management',
                'Lead Generation', 'Growth Marketing', 'Email Marketing'
            ];

            const salesSkills = [
                'Sales Strategy', 'Account Management', 'Pipeline Management',
                'Negotiation', 'CRM Systems', 'Sales Forecasting',
                'Business Development', 'Client Relations', 'Sales Enablement',
                'Contract Negotiation', 'Consultative Selling', 'Revenue Growth'
            ];

            const leadershipSkills = [
                'Strategic Planning', 'Team Leadership', 'Change Management',
                'Cross-functional Leadership', 'Executive Communication', 'P&L Management',
                'Organizational Development', 'Business Strategy', 'Board Relations',
                'Stakeholder Management', 'Budget Management', 'Operations Management'
            ];

            // Select appropriate skill library based on ACTUAL role
            let skillLibrary = leadershipSkills; // default
            if (isRecruiter && isExecutive) {
                skillLibrary = executiveRecruiterSkills;
            } else if (isRecruiter) {
                skillLibrary = recruiterSkills;
            } else if (isEngineer) {
                skillLibrary = engineerSkills;
            } else if (isProduct) {
                skillLibrary = productSkills;
            } else if (isMarketing) {
                skillLibrary = marketingSkills;
            } else if (isSales) {
                skillLibrary = salesSkills;
            } else if (isExecutive) {
                skillLibrary = leadershipSkills;
            }

            // Get current skills that are actually short keywords (filter out sentences)
            const currentShortSkills = currentSkills.filter(s => s.split(' ').length <= 5);

            // TOP 3: Best skills for recruiter searches (must be different from current)
            const currentLower = currentShortSkills.map(s => s.toLowerCase());
            const topSkills = skillLibrary
                .filter(s => !currentLower.includes(s.toLowerCase()))
                .slice(0, 3);

            // ADD THESE: More skills to add (different from top 3)
            const topSkillsLower = topSkills.map(s => s.toLowerCase());
            const skillsToAdd = skillLibrary
                .filter(s => !currentLower.includes(s.toLowerCase()) && !topSkillsLower.includes(s.toLowerCase()))
                .slice(0, 8);

            // REMOVE THESE: Generic low-signal skills
            const genericPatterns = [
                'microsoft office', 'ms word', 'ms excel', 'typing', 'data entry',
                'communication', 'teamwork', 'leadership', 'problem solving',
                'time management', 'hard working', 'team player', 'email'
            ];
            const skillsToRemove = currentSkills
                .filter(s => genericPatterns.some(p => s.toLowerCase().includes(p)))
                .slice(0, 5);

            return {
                topSkills,
                skillsToAdd,
                skillsToRemove,
                skillsWhy: [
                    'Top 3 are the most recruiter-searched terms for this role type',
                    'Added skills are specialized competencies that differentiate you',
                    'Removed skills are generic terms that don\'t improve search ranking'
                ]
            };
        }

        // Get experience optimizations with full structure
        function getExperienceOptimizations(linkedinParsed, resumeOutput, analysisData) {
            const experienceSections = resumeOutput.experience_sections || [];

            if (experienceSections.length === 0) {
                return [];
            }

            // Take top 2-3 most relevant experiences
            return experienceSections.slice(0, 3).map(exp => {
                // Filter to best bullets (with metrics)
                const optimizedBullets = (exp.bullets || [])
                    .filter(b => /\d+%|\$[\d.]+|\d+\s*(hires|team|people|candidates)/i.test(b) || b.length > 30)
                    .slice(0, 4);

                // If no metric bullets, take first 3
                const finalBullets = optimizedBullets.length > 0 ? optimizedBullets : (exp.bullets || []).slice(0, 3);

                return {
                    title: exp.title || 'Position',
                    company: exp.company || 'Company',
                    dates: exp.dates || '',
                    company_context: exp.overview || '',
                    bullets: finalBullets,
                    why_these_work: [
                        'Lead with impact and results',
                        'Include specific numbers and metrics',
                        'Match language from job descriptions'
                    ]
                };
            });
        }

        // Determine severity level
        function determineSeverity(currentHeadline, newHeadline, currentSummary, newSummary, linkedinParsed) {
            let score = 0;

            // No headline or very short = critical
            if (!currentHeadline || currentHeadline.length < 20) score += 3;
            else if (currentHeadline.length < 50) score += 1;

            // No summary = critical
            if (!currentSummary || currentSummary.length < 50) score += 3;
            else if (currentSummary.length < 200) score += 1;

            // No experience entries
            if (!linkedinParsed.experience || linkedinParsed.experience.length === 0) score += 2;

            // No skills
            if (!linkedinParsed.skills || linkedinParsed.skills.length < 5) score += 1;

            if (score >= 5) return 'CRITICAL';
            if (score >= 3) return 'HIGH';
            if (score >= 1) return 'MEDIUM';
            return 'LOW';
        }

        // Get severity message
        function getSeverityMessage(severity, role, company) {
            const target = role ? `for ${role} roles` : 'for your target roles';

            switch (severity) {
                case 'CRITICAL':
                    return `Your LinkedIn profile needs significant updates to be competitive ${target}. These changes could dramatically improve your visibility to recruiters.`;
                case 'HIGH':
                    return `Several key sections need optimization ${target}. Making these updates will help you appear in more recruiter searches.`;
                case 'MEDIUM':
                    return `Your profile is decent but could be stronger ${target}. These refinements will help you stand out.`;
                case 'LOW':
                    return `Your profile is in good shape! These minor tweaks will help maximize your visibility ${target}.`;
                default:
                    return `Update your LinkedIn to align with ${target}.`;
            }
        }

        // Get severity benefits
        function getSeverityBenefits(severity) {
            return [
                'Appear in more recruiter searches',
                'Make a stronger first impression',
                'Stand out from other candidates',
                'Align your profile with your tailored resume'
            ];
        }

        // Get featured section recommendation
        function getFeaturedRecommendation(resumeOutput, analysisData) {
            const role = analysisData?._role || '';

            if (/recruit|talent/i.test(role)) {
                return 'Showcase hiring metrics, case studies of successful placements, or testimonials from hiring managers you\'ve partnered with.';
            }
            if (/engineer|developer/i.test(role)) {
                return 'Feature your best projects, open source contributions, technical blog posts, or conference talks.';
            }
            if (/marketing|sales/i.test(role)) {
                return 'Highlight campaign results, case studies, press coverage, or thought leadership content.';
            }

            return 'Add proof of work: case studies, presentations, press mentions, or portfolio pieces that demonstrate your expertise.';
        }

        // Get featured suggestions
        function getFeaturedSuggestions(resumeOutput, analysisData) {
            return [
                'Add a link to a relevant project or case study',
                'Share a presentation or document showcasing your work',
                'Include any press mentions or awards'
            ];
        }

        // Get who to ask for recommendations
        function getWhoToAsk(resumeOutput, analysisData) {
            const role = analysisData?._role || '';

            if (/recruit|talent/i.test(role)) {
                return [
                    { person_type: 'Hiring Manager', what_to_emphasize: 'your strategic partnership and quality of hires' },
                    { person_type: 'Candidate you placed', what_to_emphasize: 'your professionalism and career guidance' },
                    { person_type: 'Team member', what_to_emphasize: 'your leadership and mentorship' }
                ];
            }

            return [
                { person_type: 'Direct manager', what_to_emphasize: 'specific achievements and leadership' },
                { person_type: 'Cross-functional partner', what_to_emphasize: 'collaboration and impact' },
                { person_type: 'Client or stakeholder', what_to_emphasize: 'results delivered' }
            ];
        }

        // Get activity guidance based on role and seniority
        function getActivityGuidance(analysisData, level) {
            const role = analysisData?._role || '';
            const isSenior = /senior|director|vp|head|lead|principal|chief/i.test(level || '');

            // Base recommendation based on seniority
            let recommendation = isSenior
                ? 'For senior roles, position yourself as a strategic advisor. 2-3 thoughtful posts or comments per month beats daily generic engagement.'
                : 'Engaging with industry content showcases your expertise. Comment with your POV, not just "Great post!"';

            // Topics based on role type
            let topics = [];
            if (/recruit|talent/i.test(role)) {
                topics = [
                    'Executive search trends and market dynamics',
                    'Leadership assessment methodologies',
                    'Talent market intelligence (hiring patterns, compensation shifts)',
                    'Recruiting technology and AI in hiring',
                    'Diversity recruiting and inclusive hiring practices'
                ];
            } else if (/engineer|developer|software/i.test(role)) {
                topics = [
                    'Distributed systems architecture and scaling challenges',
                    'Best practices for your tech stack',
                    'Engineering culture and team collaboration',
                    'Technical leadership and mentorship',
                    'Industry trends in your domain'
                ];
            } else if (/product/i.test(role)) {
                topics = [
                    'Product-led growth and go-to-market strategies',
                    'User research and customer discovery',
                    'AI/ML product development patterns',
                    'Cross-functional leadership in product orgs',
                    'Product strategy and roadmapping'
                ];
            } else if (/marketing|sales|gtm/i.test(role)) {
                topics = [
                    'Go-to-market strategies and pipeline generation',
                    'Customer acquisition and retention tactics',
                    'Sales enablement and revenue operations',
                    'Brand building and thought leadership',
                    'Market trends in your industry'
                ];
            } else {
                topics = [
                    'Industry trends and best practices in your domain',
                    'Leadership and team management insights',
                    'Professional development and career growth',
                    'Cross-functional collaboration strategies',
                    'Innovation and emerging technologies'
                ];
            }

            // Engagement tips (universal)
            const engagementTips = [
                'Comment with your POV, not just "Great post!"',
                'Share what you learned from experience',
                'Post about trends you are seeing in your domain',
                'Tag people thoughtfully (colleagues, mentors, industry experts)'
            ];

            // What to avoid (universal)
            const avoidList = [
                'Political content or controversial hot-takes',
                'Complaining about your industry, clients, or "the market"',
                'Obvious engagement bait ("Agree or disagree?")',
                'Over-posting (daily posts look desperate; 2-3/month looks strategic)'
            ];

            // Positioning statement based on role
            let positioning = '';
            if (/recruit|talent/i.test(role)) {
                positioning = 'Senior recruiters are trusted advisors. Your LinkedIn activity should position you as someone who understands talent strategy, not just fills roles.';
            } else if (/engineer|developer/i.test(role)) {
                positioning = 'Strong engineers are known for their technical depth. Your activity should showcase your expertise and thought process.';
            } else if (/product/i.test(role)) {
                positioning = 'Great PMs are strategic thinkers. Your activity should demonstrate product sense and customer empathy.';
            } else {
                positioning = 'Your LinkedIn activity should position you as a strategic thinker in your domain, not just someone doing the job.';
            }

            return {
                recommendation,
                topics,
                engagementTips,
                avoidList,
                positioning
            };
        }

        // Extract expertise from profile without narrowing to one niche
        function extractExpertise(linkedinParsed, resumeOutput) {
            const expertise = [];

            // From LinkedIn headline
            if (linkedinParsed.headline) {
                expertise.push(linkedinParsed.headline);
            }

            // From experience titles - look for common threads
            if (linkedinParsed.experience?.length > 0) {
                const titles = linkedinParsed.experience.map(e => e.title).filter(Boolean);
                if (titles.length > 0) expertise.push(titles[0]);
            }

            // From resume summary
            if (resumeOutput.summary) {
                expertise.push(resumeOutput.summary.split('.')[0]);
            }

            return expertise;
        }

        // Generate headline that shows expertise without limiting future opportunities
        function generateFlexibleHeadline(currentExpertise, level, analysisData) {
            const resumeOutput = JSON.parse(sessionStorage.getItem('documentsData') || '{}').resume_output || {};

            // Start with actual level/seniority
            let prefix = level || 'Senior';

            // Use broader functional area, not specific niche
            const functionalArea = getBroadFunctionalArea(analysisData, resumeOutput);

            // Add differentiator from experience
            const differentiator = getDifferentiator(resumeOutput);

            if (functionalArea && differentiator) {
                return `${prefix} ${functionalArea} | ${differentiator}`;
            } else if (functionalArea) {
                return `${prefix} ${functionalArea}`;
            } else {
                return resumeOutput.headline || 'Your headline here';
            }
        }

        // Get broader functional area instead of niche role
        function getBroadFunctionalArea(analysisData, resumeOutput) {
            const role = analysisData?._role || analysisData?.role_title || '';

            // Map specific roles to broader functional areas
            const broadAreas = {
                'executive recruiter': 'Talent Acquisition Leader',
                'technical recruiter': 'Talent Acquisition',
                'talent acquisition': 'Talent Acquisition',
                'recruiter': 'Talent Acquisition',
                'sourcer': 'Talent Acquisition',
                'recruiting manager': 'Talent Acquisition Leader',
                'hr business partner': 'HR & People Operations',
                'people operations': 'HR & People Operations'
            };

            const roleLower = role.toLowerCase();
            for (const [key, value] of Object.entries(broadAreas)) {
                if (roleLower.includes(key)) return value;
            }

            return role;
        }

        // Get a differentiator that shows expertise without narrowing
        function getDifferentiator(resumeOutput) {
            // Look for quantified achievements
            const highlights = resumeOutput.experience_sections?.[0]?.bullets || [];

            for (const bullet of highlights) {
                // Look for scope indicators
                if (/\d+\s*(hires|placements|team|engineers|people)/i.test(bullet)) {
                    const match = bullet.match(/\d+\s*(hires|placements|team|engineers|people)/i);
                    if (match) return `${match[0]} track record`;
                }
                if (/built|scaled|grew/i.test(bullet)) {
                    return 'Built & Scaled Teams';
                }
            }

            return null;
        }

        // Generate summary that tells career story without pigeonholing
        function generateFlexibleSummary(linkedinParsed, resumeOutput, analysisData) {
            // Start with what they do (broad)
            // Then what they're great at (specific achievements)
            // Then what they bring (value prop)

            const years = extractYearsExperience(linkedinParsed, resumeOutput);
            const expertise = getBroadFunctionalArea(analysisData, resumeOutput);
            const achievements = getKeyAchievements(resumeOutput);

            let summary = '';

            if (years && expertise) {
                summary += `${expertise} professional with ${years}+ years of experience. `;
            }

            if (achievements.length > 0) {
                summary += achievements.join(' ');
            }

            if (!summary) {
                summary = resumeOutput.summary || 'Your optimized summary will appear here.';
            }

            return summary;
        }

        function extractYearsExperience(linkedinParsed, resumeOutput) {
            // Try to calculate from experience
            if (linkedinParsed.experience?.length > 0) {
                const earliest = linkedinParsed.experience[linkedinParsed.experience.length - 1];
                const dates = earliest.dates || '';
                const yearMatch = dates.match(/\d{4}/);
                if (yearMatch) {
                    const startYear = parseInt(yearMatch[0]);
                    return new Date().getFullYear() - startYear;
                }
            }
            return null;
        }

        function getKeyAchievements(resumeOutput) {
            const achievements = [];
            const bullets = resumeOutput.experience_sections?.[0]?.bullets || [];

            for (const bullet of bullets.slice(0, 2)) {
                if (/\d+%|\$\d+|\d+x|\d+ (people|hires|team)/i.test(bullet)) {
                    achievements.push(bullet);
                }
            }

            return achievements;
        }

        // Get transferable skills (not just role-specific)
        function getTransferableSkills(resumeOutput, analysisData) {
            const atsKeywords = resumeOutput.ats_keywords || analysisData.ats_keywords || [];
            const requiredSkills = analysisData.required_skills || [];

            // Prioritize skills that transfer across roles
            const transferable = atsKeywords.filter(skill => {
                const lower = skill.toLowerCase();
                return !lower.includes('executive search') && // Don't narrow to niche
                       !lower.includes('retained search') &&
                       !lower.includes('contingent');
            });

            return transferable.slice(0, 5);
        }

        // Get quantified highlights
        function getQuantifiedHighlights(resumeOutput, linkedinParsed) {
            const highlights = [];
            const bullets = resumeOutput.experience_sections?.[0]?.bullets || [];

            for (const bullet of bullets) {
                if (/\d+%|\$\d+|\d+ (hires|placements|team|people)/i.test(bullet)) {
                    highlights.push(bullet);
                    if (highlights.length >= 3) break;
                }
            }

            // Fallback to first 3 bullets if no quantified ones
            if (highlights.length === 0) {
                highlights.push(...bullets.slice(0, 3));
            }

            return highlights;
        }
    </script>
</body>
</html>

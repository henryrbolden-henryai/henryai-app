<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Conversation with Henry - HenryAI</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Instrument+Serif:ital@0;1&family=DM+Sans:opsz,wght@9..40,400;9..40,500;9..40,600&display=swap" rel="stylesheet">
    <style>
        :root {
            --color-bg: #0a0a0b;
            --color-surface: #141416;
            --color-surface-elevated: #1c1c1f;
            --color-border: rgba(255, 255, 255, 0.08);
            --color-border-hover: rgba(255, 255, 255, 0.15);
            --color-text: #fafafa;
            --color-text-secondary: #a1a1aa;
            --color-accent: #22d3ee;
            --color-accent-muted: rgba(34, 211, 238, 0.15);
            --color-success: #4ade80;
            --color-warning: #fbbf24;
            --color-error: #f87171;
            --font-display: 'Instrument Serif', Georgia, serif;
            --font-body: 'DM Sans', -apple-system, sans-serif;
            --ease-out: cubic-bezier(0.16, 1, 0.3, 1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-body);
            background: var(--color-bg);
            color: var(--color-text);
            min-height: 100vh;
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
            display: flex;
            flex-direction: column;
        }

        /* Header */
        header {
            padding: 16px 20px;
            border-bottom: 1px solid var(--color-border);
            display: flex;
            align-items: center;
            gap: 16px;
            position: sticky;
            top: 0;
            background: var(--color-bg);
            z-index: 100;
        }

        .back-btn {
            color: var(--color-text-secondary);
            text-decoration: none;
            font-size: 1.5rem;
            padding: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: color 0.2s;
        }

        .back-btn:hover {
            color: var(--color-accent);
        }

        .header-title {
            flex: 1;
            font-family: var(--font-display);
            font-size: 1.2rem;
            font-weight: 400;
        }

        .progress-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.85rem;
            color: var(--color-text-secondary);
        }

        .progress-dots {
            display: flex;
            gap: 4px;
        }

        .progress-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--color-border);
            transition: background 0.3s;
        }

        .progress-dot.active {
            background: var(--color-accent);
        }

        .progress-dot.completed {
            background: var(--color-success);
        }

        /* Chat container */
        .chat-container {
            flex: 1;
            overflow-y: auto;
            padding: 24px 20px;
            max-width: 700px;
            margin: 0 auto;
            width: 100%;
        }

        .messages {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        /* Message bubbles */
        .message {
            display: flex;
            gap: 12px;
            max-width: 85%;
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.henry {
            align-self: flex-start;
        }

        .message.user {
            align-self: flex-end;
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            flex-shrink: 0;
        }

        .message.henry .message-avatar {
            background: var(--color-accent-muted);
            border-color: rgba(34, 211, 238, 0.3);
        }

        .message-content {
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: 16px;
            padding: 14px 18px;
            font-size: 0.95rem;
            line-height: 1.5;
        }

        .message.henry .message-content {
            border-radius: 4px 16px 16px 16px;
        }

        .message.user .message-content {
            background: var(--color-accent-muted);
            border-color: rgba(34, 211, 238, 0.3);
            border-radius: 16px 4px 16px 16px;
        }

        /* Typing indicator */
        .typing-indicator {
            display: none;
            align-items: center;
            gap: 12px;
            max-width: 85%;
        }

        .typing-indicator.show {
            display: flex;
        }

        .typing-dots {
            display: flex;
            gap: 4px;
            padding: 16px 20px;
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: 4px 16px 16px 16px;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--color-text-secondary);
            animation: typingBounce 1.4s infinite ease-in-out;
        }

        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }

        @keyframes typingBounce {
            0%, 80%, 100% { transform: scale(0.8); opacity: 0.5; }
            40% { transform: scale(1); opacity: 1; }
        }

        /* Suggested responses */
        .suggestions {
            display: none;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 12px;
            animation: fadeIn 0.3s ease-out;
        }

        .suggestions.show {
            display: flex;
        }

        .suggestion-btn {
            padding: 10px 16px;
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: 20px;
            color: var(--color-text);
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .suggestion-btn:hover {
            border-color: var(--color-accent);
            background: var(--color-accent-muted);
        }

        /* Skills extracted panel */
        .skills-panel {
            display: none;
            margin-top: 16px;
            padding: 16px;
            background: rgba(74, 222, 128, 0.1);
            border: 1px solid rgba(74, 222, 128, 0.3);
            border-radius: 12px;
            animation: fadeIn 0.3s ease-out;
        }

        .skills-panel.show {
            display: block;
        }

        .skills-panel-header {
            font-size: 0.85rem;
            color: var(--color-success);
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .extracted-skills {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .skill-tag {
            padding: 4px 10px;
            background: rgba(74, 222, 128, 0.2);
            border-radius: 12px;
            font-size: 0.8rem;
            color: var(--color-success);
        }

        /* Input area */
        .input-area {
            padding: 16px 20px;
            border-top: 1px solid var(--color-border);
            background: var(--color-bg);
            position: sticky;
            bottom: 0;
        }

        .input-container {
            max-width: 700px;
            margin: 0 auto;
            display: flex;
            gap: 12px;
            align-items: flex-end;
        }

        /* Voice button */
        .voice-btn {
            width: 60px;
            height: 60px;
            background: var(--color-accent);
            border: none;
            border-radius: 50%;
            color: #000;
            font-size: 1.5rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s, box-shadow 0.2s, background 0.2s;
            flex-shrink: 0;
        }

        .voice-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 20px rgba(34, 211, 238, 0.3);
        }

        .voice-btn.recording {
            background: var(--color-error);
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.08); }
        }

        .voice-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .input-wrapper {
            flex: 1;
            position: relative;
        }

        #messageInput {
            width: 100%;
            padding: 14px 18px;
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: 24px;
            color: var(--color-text);
            font-family: var(--font-body);
            font-size: 1rem;
            resize: none;
            min-height: 50px;
            max-height: 150px;
            line-height: 1.4;
            transition: border-color 0.2s;
        }

        #messageInput:focus {
            outline: none;
            border-color: var(--color-accent);
        }

        #messageInput::placeholder {
            color: var(--color-text-secondary);
        }

        .send-btn {
            width: 50px;
            height: 50px;
            background: var(--color-surface-elevated);
            border: 1px solid var(--color-border);
            border-radius: 50%;
            color: var(--color-text);
            font-size: 1.2rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            flex-shrink: 0;
        }

        .send-btn:hover {
            border-color: var(--color-accent);
            color: var(--color-accent);
        }

        .send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Type instead toggle */
        .input-mode-toggle {
            text-align: center;
            margin-top: 12px;
        }

        .toggle-link {
            color: var(--color-text-secondary);
            font-size: 0.85rem;
            cursor: pointer;
            text-decoration: underline;
            background: none;
            border: none;
        }

        .toggle-link:hover {
            color: var(--color-accent);
        }

        /* Recording status */
        .recording-status {
            display: none;
            text-align: center;
            padding: 8px;
            color: var(--color-error);
            font-size: 0.9rem;
            animation: fadeIn 0.3s ease-out;
        }

        .recording-status.show {
            display: block;
        }

        /* Henry speaking indicator */
        .speaking-indicator {
            display: none;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: var(--color-accent-muted);
            border-radius: 20px;
            font-size: 0.85rem;
            color: var(--color-accent);
            margin-bottom: 12px;
        }

        .speaking-indicator.show {
            display: inline-flex;
        }

        .speaking-bars {
            display: flex;
            gap: 2px;
            align-items: center;
        }

        .speaking-bar {
            width: 3px;
            height: 12px;
            background: var(--color-accent);
            border-radius: 2px;
            animation: speakingBar 0.8s ease-in-out infinite;
        }

        .speaking-bar:nth-child(1) { animation-delay: 0s; }
        .speaking-bar:nth-child(2) { animation-delay: 0.2s; }
        .speaking-bar:nth-child(3) { animation-delay: 0.4s; }

        @keyframes speakingBar {
            0%, 100% { height: 4px; }
            50% { height: 16px; }
        }

        /* Continue to skills button */
        .continue-section {
            display: none;
            padding: 20px;
            text-align: center;
        }

        .continue-section.show {
            display: block;
        }

        .continue-btn {
            padding: 16px 32px;
            background: var(--color-accent);
            border: none;
            border-radius: 12px;
            color: #000;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .continue-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(34, 211, 238, 0.3);
        }

        /* Microphone permission prompt */
        .mic-permission {
            display: none;
            text-align: center;
            padding: 24px;
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: 16px;
            margin-bottom: 16px;
        }

        .mic-permission.show {
            display: block;
        }

        .mic-permission p {
            color: var(--color-text-secondary);
            margin-bottom: 16px;
        }

        .mic-permission-btn {
            padding: 12px 24px;
            background: var(--color-accent);
            border: none;
            border-radius: 8px;
            color: #000;
            font-weight: 600;
            cursor: pointer;
        }

        /* Start conversation overlay */
        .start-overlay {
            position: fixed;
            inset: 0;
            background: var(--color-bg);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
            text-align: center;
        }

        .start-overlay.hidden {
            display: none;
        }

        .start-overlay h2 {
            font-family: var(--font-display);
            font-size: 2rem;
            font-weight: 400;
            margin-bottom: 16px;
        }

        .start-overlay p {
            color: var(--color-text-secondary);
            margin-bottom: 32px;
            max-width: 400px;
        }

        .start-btn {
            padding: 18px 48px;
            background: var(--color-accent);
            border: none;
            border-radius: 30px;
            color: #000;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .start-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 30px rgba(34, 211, 238, 0.4);
        }

        .start-btn .icon {
            font-size: 1.3rem;
        }

        .start-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .name-form {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 24px;
            width: 100%;
            max-width: 320px;
        }

        .name-row {
            display: flex;
            gap: 12px;
        }

        .name-input {
            flex: 1;
            padding: 14px 16px;
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: 12px;
            color: var(--color-text);
            font-size: 1rem;
            font-family: var(--font-body);
            transition: border-color 0.2s;
        }

        .name-input:focus {
            outline: none;
            border-color: var(--color-accent);
        }

        .name-input::placeholder {
            color: var(--color-text-secondary);
        }

        .name-input.full-width {
            width: 100%;
        }

        .nickname-label {
            font-size: 0.85rem;
            color: var(--color-text-secondary);
            text-align: left;
            margin-top: 4px;
        }

        /* Responsive */
        @media (max-width: 640px) {
            .progress-indicator span {
                display: none;
            }

            .message {
                max-width: 90%;
            }

            .voice-btn {
                width: 56px;
                height: 56px;
            }
        }
    </style>
    <link rel="stylesheet" href="css/mobile.css">
</head>
<body>
    <!-- Start overlay - requires click to enable audio -->
    <div class="start-overlay" id="startOverlay">
        <h2>Ready to Chat with Henry?</h2>
        <p>I will guide you through sharing your experience and help identify your skills.<br>This works best with sound on.</p>

        <div class="name-form">
            <div class="name-row">
                <input type="text" id="firstNameInput" class="name-input" placeholder="First name" required>
                <input type="text" id="lastNameInput" class="name-input" placeholder="Last name" required>
            </div>
            <div>
                <input type="text" id="nicknameInput" class="name-input full-width" placeholder="Nickname (optional)">
                <div class="nickname-label">What should Henry call you?</div>
            </div>
        </div>

        <button class="start-btn" id="startBtn" onclick="beginConversation()" disabled>
            <span class="icon">üéôÔ∏è</span>
            Start Conversation
        </button>
    </div>

    <header>
        <a href="resume-builder.html" class="back-btn">‚Üê</a>
        <div class="header-title">Conversation with Henry</div>
        <div class="progress-indicator">
            <div class="progress-dots">
                <div class="progress-dot active" data-step="1"></div>
                <div class="progress-dot" data-step="2"></div>
                <div class="progress-dot" data-step="3"></div>
                <div class="progress-dot" data-step="4"></div>
                <div class="progress-dot" data-step="5"></div>
            </div>
            <span id="progressLabel">Getting started</span>
        </div>
    </header>

    <div class="chat-container" id="chatContainer">
        <div class="speaking-indicator" id="speakingIndicator">
            <div class="speaking-bars">
                <div class="speaking-bar"></div>
                <div class="speaking-bar"></div>
                <div class="speaking-bar"></div>
            </div>
            Henry is speaking...
        </div>

        <div class="messages" id="messages">
            <!-- Messages will be inserted here -->
        </div>

        <div class="typing-indicator" id="typingIndicator">
            <div class="message-avatar">üéØ</div>
            <div class="typing-dots">
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
            </div>
        </div>

        <div class="suggestions" id="suggestions">
            <!-- Suggested responses will be inserted here -->
        </div>

        <div class="skills-panel" id="skillsPanel">
            <div class="skills-panel-header">
                <span>‚ú®</span> Skills I have noticed
            </div>
            <div class="extracted-skills" id="extractedSkills">
                <!-- Extracted skills will be inserted here -->
            </div>
        </div>
    </div>

    <div class="continue-section" id="continueSection">
        <button class="continue-btn" onclick="goToSkillsAnalysis()">
            View My Skills Analysis ‚Üí
        </button>
    </div>

    <div class="input-area" id="inputArea">
        <div class="recording-status" id="recordingStatus">
            üî¥ Recording... Tap to stop
        </div>
        <div class="input-container">
            <button class="voice-btn" id="voiceBtn" onclick="toggleRecording()">
                üéôÔ∏è
            </button>
            <div class="input-wrapper">
                <textarea
                    id="messageInput"
                    placeholder="Or type your response here..."
                    rows="1"
                ></textarea>
            </div>
            <button class="send-btn" id="sendBtn" onclick="sendMessage()">
                ‚Üë
            </button>
        </div>
        <div class="input-mode-toggle">
            <button class="toggle-link" id="toggleMode" onclick="toggleInputMode()">
                Prefer to type? Click here
            </button>
        </div>
    </div>

    <script>
        const API_BASE = window.location.hostname === 'localhost' ? 'http://localhost:8000' : 'https://henryai-app-production.up.railway.app';

        // Conversation state
        let conversationState = {
            state: 'START',
            messages: [],
            extracted_data: {
                contact: {},
                experiences: [],
                skills: [],
                education: [],
                certifications: []
            }
        };

        // UI state
        let isProcessing = false;
        let allExtractedSkills = [];
        let isRecording = false;
        let mediaRecorder = null;
        let audioChunks = [];
        let currentAudio = null;
        let autoListenEnabled = true; // Auto-start recording after Henry speaks
        let silenceTimeout = null;
        let audioContext = null;
        let analyser = null;

        // Progress steps mapping
        const progressSteps = {
            'START': { step: 1, label: 'Getting started' },
            'GET_NAME': { step: 1, label: 'Getting started' },
            'CURRENT_ROLE': { step: 1, label: 'Current role' },
            'RESPONSIBILITIES': { step: 2, label: 'Responsibilities' },
            'ACHIEVEMENTS': { step: 2, label: 'Achievements' },
            'PREVIOUS_ROLES': { step: 3, label: 'Previous experience' },
            'EDUCATION': { step: 3, label: 'Education' },
            'SKILLS_SUMMARY': { step: 4, label: 'Skills summary' },
            'ROLE_GOALS': { step: 4, label: 'Career goals' },
            'ADJACENT_ROLES': { step: 5, label: 'Role suggestions' },
            'GENERATE_RESUME': { step: 5, label: 'Generating resume' },
            'COMPLETE': { step: 5, label: 'Complete!' }
        };

        // Elements
        const messagesContainer = document.getElementById('messages');
        const typingIndicator = document.getElementById('typingIndicator');
        const suggestionsContainer = document.getElementById('suggestions');
        const skillsPanel = document.getElementById('skillsPanel');
        const extractedSkillsContainer = document.getElementById('extractedSkills');
        const messageInput = document.getElementById('messageInput');
        const sendBtn = document.getElementById('sendBtn');
        const voiceBtn = document.getElementById('voiceBtn');
        const chatContainer = document.getElementById('chatContainer');
        const continueSection = document.getElementById('continueSection');
        const inputArea = document.getElementById('inputArea');
        const recordingStatus = document.getElementById('recordingStatus');
        const speakingIndicator = document.getElementById('speakingIndicator');

        // Name inputs
        const firstNameInput = document.getElementById('firstNameInput');
        const lastNameInput = document.getElementById('lastNameInput');
        const nicknameInput = document.getElementById('nicknameInput');
        const startButton = document.getElementById('startBtn');

        // User name info
        let userName = {
            firstName: '',
            lastName: '',
            nickname: '',
            displayName: '' // What Henry calls them
        };

        // Enable start button when first and last name are filled
        function validateNameInputs() {
            const hasFirstName = firstNameInput.value.trim().length > 0;
            const hasLastName = lastNameInput.value.trim().length > 0;
            startButton.disabled = !(hasFirstName && hasLastName);
        }

        firstNameInput.addEventListener('input', validateNameInputs);
        lastNameInput.addEventListener('input', validateNameInputs);

        // Allow Enter to start conversation when form is valid
        [firstNameInput, lastNameInput, nicknameInput].forEach(input => {
            input.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !startButton.disabled) {
                    e.preventDefault();
                    beginConversation();
                }
            });
        });

        // Auto-resize textarea
        messageInput.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 150) + 'px';
        });

        // Send on Enter (but Shift+Enter for new line)
        messageInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        // Toggle input mode
        function toggleInputMode() {
            const toggle = document.getElementById('toggleMode');
            const voiceBtn = document.getElementById('voiceBtn');

            if (voiceBtn.style.display === 'none') {
                voiceBtn.style.display = 'flex';
                toggle.textContent = 'Prefer to type? Click here';
            } else {
                voiceBtn.style.display = 'none';
                toggle.textContent = 'Prefer to speak? Click here';
            }
        }

        // Voice recording
        async function toggleRecording() {
            if (isRecording) {
                stopRecording();
            } else {
                await startRecording();
            }
        }

        async function startRecording(isAutoListen = false) {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];

                // Set up audio analysis for silence detection
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                analyser = audioContext.createAnalyser();
                const source = audioContext.createMediaStreamSource(stream);
                source.connect(analyser);
                analyser.fftSize = 512;

                let silenceStart = null;
                let hasSpoken = false;
                const silenceThreshold = 15; // Audio level below this is silence
                const silenceDuration = 1000; // Stop after 1 second of silence

                mediaRecorder.ondataavailable = (event) => {
                    audioChunks.push(event.data);
                };

                mediaRecorder.onstop = async () => {
                    if (silenceTimeout) {
                        clearInterval(silenceTimeout);
                        silenceTimeout = null;
                    }
                    if (audioContext) {
                        audioContext.close();
                        audioContext = null;
                    }

                    const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                    stream.getTracks().forEach(track => track.stop());

                    // Only transcribe if user actually spoke
                    if (hasSpoken && audioChunks.length > 0) {
                        await transcribeAudio(audioBlob);
                    } else if (isAutoListen) {
                        // If auto-listening and no speech detected, restart listening after a pause
                        setTimeout(() => {
                            if (autoListenEnabled && !isProcessing && !currentAudio && messageInput.value.trim() === '') {
                                startRecording(true);
                            }
                        }, 1000);
                    }
                };

                mediaRecorder.start(100); // Collect data every 100ms
                isRecording = true;
                voiceBtn.classList.add('recording');
                voiceBtn.innerHTML = '‚èπÔ∏è';
                recordingStatus.textContent = isAutoListen ? 'üéôÔ∏è Listening... (speak now)' : 'üî¥ Recording... Tap to stop';
                recordingStatus.classList.add('show');

                // Monitor audio levels for silence detection
                const dataArray = new Uint8Array(analyser.frequencyBinCount);
                silenceTimeout = setInterval(() => {
                    analyser.getByteFrequencyData(dataArray);
                    const average = dataArray.reduce((a, b) => a + b) / dataArray.length;

                    if (average > silenceThreshold) {
                        // User is speaking
                        hasSpoken = true;
                        silenceStart = null;
                        recordingStatus.textContent = 'üî¥ Recording...';
                    } else if (hasSpoken) {
                        // Silence after speaking
                        if (!silenceStart) {
                            silenceStart = Date.now();
                        } else if (Date.now() - silenceStart > silenceDuration) {
                            // Enough silence, stop recording
                            stopRecording();
                        }
                    }
                }, 100);

            } catch (error) {
                console.error('Microphone access denied:', error);
                alert('Please allow microphone access to use voice input. You can also type your response instead.');
            }
        }

        function stopRecording() {
            if (silenceTimeout) {
                clearInterval(silenceTimeout);
                silenceTimeout = null;
            }
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
            }
            isRecording = false;
            voiceBtn.classList.remove('recording');
            voiceBtn.innerHTML = 'üéôÔ∏è';
            recordingStatus.classList.remove('show');
        }

        async function transcribeAudio(audioBlob) {
            showTyping();

            try {
                const formData = new FormData();
                formData.append('audio', audioBlob, 'recording.webm');

                const response = await fetch(`${API_BASE}/api/transcribe`, {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    throw new Error('Transcription failed');
                }

                const data = await response.json();
                hideTyping();

                if (data.text && data.text.trim()) {
                    messageInput.value = data.text;
                    sendMessage();
                } else {
                    addMessageToUI('henry', "I did not catch that. Could you try again or type your response?");
                }
            } catch (error) {
                console.error('Transcription error:', error);
                hideTyping();
                addMessageToUI('henry', "I had trouble hearing that. Could you try again or type your response instead?");
            }
        }

        // Text-to-speech for Henry's responses
        async function speakResponse(text) {
            try {
                speakingIndicator.classList.add('show');

                const response = await fetch(`${API_BASE}/api/speak`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text })
                });

                if (!response.ok) {
                    throw new Error('TTS failed');
                }

                const audioBlob = await response.blob();
                const audioUrl = URL.createObjectURL(audioBlob);

                if (currentAudio) {
                    currentAudio.pause();
                }

                currentAudio = new Audio(audioUrl);
                currentAudio.onended = () => {
                    speakingIndicator.classList.remove('show');
                    URL.revokeObjectURL(audioUrl);
                    currentAudio = null;

                    // Auto-start listening after Henry finishes speaking
                    // Longer delay (1.5s) to give user time to start speaking naturally
                    if (autoListenEnabled && !isProcessing && conversationState.state !== 'COMPLETE') {
                        setTimeout(() => {
                            // Only start if user hasn't already started typing or speaking
                            if (!isRecording && messageInput.value.trim() === '') {
                                startRecording(true);
                            }
                        }, 1500);
                    }
                };
                currentAudio.onerror = () => {
                    speakingIndicator.classList.remove('show');
                    currentAudio = null;
                };

                await currentAudio.play();
            } catch (error) {
                console.error('TTS error:', error);
                speakingIndicator.classList.remove('show');
                // Silently fail - text is still displayed
                // Don't auto-listen if TTS failed - let user initiate
            }
        }

        // Begin conversation after user clicks start button
        function beginConversation() {
            // Capture name info from form
            userName.firstName = firstNameInput.value.trim();
            userName.lastName = lastNameInput.value.trim();
            userName.nickname = nicknameInput.value.trim();
            userName.displayName = userName.nickname || userName.firstName;

            // Store name in extracted_data
            conversationState.extracted_data.contact = {
                firstName: userName.firstName,
                lastName: userName.lastName,
                nickname: userName.nickname,
                fullName: `${userName.firstName} ${userName.lastName}`
            };

            document.getElementById('startOverlay').classList.add('hidden');

            // Check if we have an existing conversation
            const stored = sessionStorage.getItem('resumeConversation');
            if (stored) {
                try {
                    const parsed = JSON.parse(stored);
                    conversationState = parsed.conversationState;
                    allExtractedSkills = parsed.allExtractedSkills || [];

                    // Restore userName from stored data
                    if (conversationState.extracted_data?.contact) {
                        userName.firstName = conversationState.extracted_data.contact.firstName || '';
                        userName.lastName = conversationState.extracted_data.contact.lastName || '';
                        userName.nickname = conversationState.extracted_data.contact.nickname || '';
                        userName.displayName = userName.nickname || userName.firstName;
                    }

                    // Restore messages to UI
                    conversationState.messages.forEach(msg => {
                        addMessageToUI(msg.role === 'assistant' ? 'henry' : 'user', msg.content, false);
                    });

                    // Restore skills panel
                    if (allExtractedSkills.length > 0) {
                        updateSkillsPanel();
                    }

                    updateProgress();
                    scrollToBottom();
                    return;
                } catch (e) {
                    console.error('Failed to restore conversation:', e);
                }
            }

            // Start fresh conversation
            startConversation();
        }

        // Restore conversation from session if exists (called on page load)
        function loadConversation() {
            const stored = sessionStorage.getItem('resumeConversation');
            if (stored) {
                // We have an existing conversation - skip overlay and restore
                document.getElementById('startOverlay').classList.add('hidden');
                try {
                    const parsed = JSON.parse(stored);
                    conversationState = parsed.conversationState;
                    allExtractedSkills = parsed.allExtractedSkills || [];

                    // Restore messages to UI
                    conversationState.messages.forEach(msg => {
                        addMessageToUI(msg.role === 'assistant' ? 'henry' : 'user', msg.content, false);
                    });

                    // Restore skills panel
                    if (allExtractedSkills.length > 0) {
                        updateSkillsPanel();
                    }

                    updateProgress();
                    scrollToBottom();
                    return;
                } catch (e) {
                    console.error('Failed to restore conversation:', e);
                }
            }

            // No existing conversation - show the start overlay
            // Don't auto-start, wait for user click
        }

        // Save conversation to session
        function saveConversation() {
            sessionStorage.setItem('resumeConversation', JSON.stringify({
                conversationState,
                allExtractedSkills
            }));
        }

        // Start the conversation with Henry's opening message
        async function startConversation() {
            const openingMessage = `Hi ${userName.displayName}! I am Henry, your job search strategist. I am going to help you build a resume that shows off your real skills. No fluff, just the truth.

Let us start with what you are doing now. What is your current job or most recent role?`;

            conversationState.messages.push({
                role: 'assistant',
                content: openingMessage
            });

            addMessageToUI('henry', openingMessage);

            // Try to speak the opening message
            speakResponse(openingMessage);

            // Show helpful suggestions for current role
            showSuggestions([
                "I work as a...",
                "I am currently between jobs",
                "I am a student"
            ]);

            // Skip GET_NAME since we collected it upfront
            conversationState.state = 'CURRENT_ROLE';
            updateProgress();
            saveConversation();
        }

        // Send user message
        async function sendMessage() {
            const message = messageInput.value.trim();
            if (!message || isProcessing) return;

            isProcessing = true;
            sendBtn.disabled = true;
            voiceBtn.disabled = true;

            // Stop any playing audio
            if (currentAudio) {
                currentAudio.pause();
                speakingIndicator.classList.remove('show');
            }

            // Add user message to UI and state
            addMessageToUI('user', message);
            conversationState.messages.push({
                role: 'user',
                content: message
            });

            // Clear input
            messageInput.value = '';
            messageInput.style.height = 'auto';

            // Hide suggestions
            hideSuggestions();

            // Show typing indicator
            showTyping();

            try {
                // Call API
                const response = await fetch(`${API_BASE}/api/resume-chat`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        conversation_history: conversationState.messages,
                        current_state: conversationState.state,
                        extracted_data: conversationState.extracted_data
                    })
                });

                if (!response.ok) {
                    throw new Error('Failed to get response');
                }

                const data = await response.json();

                // Hide typing
                hideTyping();

                // Update state
                conversationState.state = data.next_state || conversationState.state;
                if (data.extracted_data) {
                    conversationState.extracted_data = data.extracted_data;
                }

                // Add Henry's response
                addMessageToUI('henry', data.response);
                conversationState.messages.push({
                    role: 'assistant',
                    content: data.response
                });

                // Speak the response
                speakResponse(data.response);

                // Handle extracted skills
                if (data.skills_extracted && data.skills_extracted.length > 0) {
                    data.skills_extracted.forEach(skill => {
                        if (!allExtractedSkills.find(s => s.skill_name === skill.skill_name)) {
                            allExtractedSkills.push(skill);
                        }
                    });
                    updateSkillsPanel();
                }

                // Show suggested responses
                if (data.suggested_responses && data.suggested_responses.length > 0) {
                    showSuggestions(data.suggested_responses);
                }

                // Update progress
                updateProgress();

                // Check if conversation is complete
                if (conversationState.state === 'COMPLETE') {
                    showContinueButton();
                }

                // Save state
                saveConversation();

            } catch (error) {
                console.error('Error:', error);
                hideTyping();
                addMessageToUI('henry', "I am having trouble connecting right now. Please check your internet connection and try again.");
            }

            isProcessing = false;
            sendBtn.disabled = false;
            voiceBtn.disabled = false;
            scrollToBottom();
        }

        // Add message to UI
        function addMessageToUI(type, content, animate = true) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            if (!animate) messageDiv.style.animation = 'none';

            const avatar = type === 'henry' ? 'üéØ' : 'üë§';

            // Convert newlines to <br> for display
            const formattedContent = content.replace(/\n/g, '<br>');

            messageDiv.innerHTML = `
                <div class="message-avatar">${avatar}</div>
                <div class="message-content">${formattedContent}</div>
            `;

            messagesContainer.appendChild(messageDiv);
            if (animate) scrollToBottom();
        }

        // Suggestions
        function showSuggestions(suggestions) {
            suggestionsContainer.innerHTML = suggestions.map(s =>
                `<button class="suggestion-btn" onclick="selectSuggestion('${s.replace(/'/g, "\\'")}')">${s}</button>`
            ).join('');
            suggestionsContainer.classList.add('show');
        }

        function hideSuggestions() {
            suggestionsContainer.classList.remove('show');
        }

        function selectSuggestion(text) {
            messageInput.value = text;
            sendMessage();
        }

        // Typing indicator
        function showTyping() {
            typingIndicator.classList.add('show');
            scrollToBottom();
        }

        function hideTyping() {
            typingIndicator.classList.remove('show');
        }

        // Skills panel
        function updateSkillsPanel() {
            if (allExtractedSkills.length === 0) {
                skillsPanel.classList.remove('show');
                return;
            }

            extractedSkillsContainer.innerHTML = allExtractedSkills.map(skill =>
                `<span class="skill-tag">${skill.skill_name}</span>`
            ).join('');
            skillsPanel.classList.add('show');
        }

        // Progress
        function updateProgress() {
            const progress = progressSteps[conversationState.state] || progressSteps['START'];

            document.querySelectorAll('.progress-dot').forEach((dot, index) => {
                const step = index + 1;
                dot.classList.remove('active', 'completed');
                if (step < progress.step) {
                    dot.classList.add('completed');
                } else if (step === progress.step) {
                    dot.classList.add('active');
                }
            });

            document.getElementById('progressLabel').textContent = progress.label;
        }

        // Show continue button when complete
        function showContinueButton() {
            inputArea.style.display = 'none';
            continueSection.classList.add('show');
        }

        // Navigate to skills analysis
        function goToSkillsAnalysis() {
            // Save final extracted data
            sessionStorage.setItem('resumeExtractedData', JSON.stringify({
                extracted_data: conversationState.extracted_data,
                skills: allExtractedSkills
            }));
            window.location.href = 'skills-analysis.html';
        }

        // Utility
        function scrollToBottom() {
            setTimeout(() => {
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }, 100);
        }

        // Initialize
        loadConversation();
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pipeline Command Center | HenryHQ</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Instrument+Serif:ital@0;1&display=swap" rel="stylesheet">
    <style>
        :root {
            /* Core Colors */
            --color-bg: #0a0a0b;
            --color-surface: #141416;
            --color-surface-elevated: #1c1c1f;
            --color-border: rgba(255, 255, 255, 0.08);
            --color-border-hover: rgba(255, 255, 255, 0.15);
            --color-text: #fafafa;
            --color-text-secondary: #71717a;
            --color-text-muted: #52525b;

            /* Status Colors */
            --color-hot: #FF6B35;
            --color-hot-muted: rgba(255, 107, 53, 0.15);
            --color-active: #4CAF50;
            --color-active-muted: rgba(76, 175, 80, 0.15);
            --color-cooling: #546E7A;
            --color-cooling-muted: rgba(84, 110, 122, 0.15);
            --color-dead: #E57373;
            --color-dead-muted: rgba(229, 115, 115, 0.15);
            --color-leverage: #FFD700;
            --color-leverage-muted: rgba(255, 215, 0, 0.15);

            /* Accent */
            --color-accent: #22d3ee;
            --color-accent-muted: rgba(34, 211, 238, 0.15);

            /* Command Center: Confidence Colors */
            --color-confidence-high: #10b981;
            --color-confidence-medium: #f59e0b;
            --color-confidence-low: #ef4444;

            /* Command Center: Priority Colors */
            --color-priority-high: #ef4444;
            --color-priority-medium: #f59e0b;
            --color-priority-low: #71717a;
            --color-priority-archive: #52525b;

            /* Command Center: Urgency Colors */
            --color-urgent: #dc2626;
            --color-urgent-muted: rgba(220, 38, 38, 0.15);

            /* Command Center: Override Indicator */
            --color-override: #f59e0b;
            --color-override-muted: rgba(251, 191, 36, 0.2);

            /* Command Center: Pipeline Health */
            --color-healthy: #10b981;
            --color-caution: #f59e0b;
            --color-stalled: #ef4444;

            /* Command Center: Spacing */
            --space-xs: 4px;
            --space-sm: 8px;
            --space-md: 12px;
            --space-lg: 16px;
            --space-xl: 24px;
            --space-xxl: 32px;

            /* Command Center: Border Radius */
            --radius-sm: 6px;
            --radius-md: 8px;
            --radius-lg: 12px;
            --radius-xl: 16px;

            /* Command Center: Shadows */
            --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.2);
            --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.3);
            --shadow-lg: 0 8px 24px rgba(0, 0, 0, 0.4);

            /* Command Center: Transitions */
            --transition-fast: 150ms ease-out;
            --transition-base: 200ms ease-out;
            --transition-slow: 300ms ease-out;

            /* Typography */
            --font-display: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            --font-body: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-body);
            background: var(--color-bg);
            color: var(--color-text);
            min-height: 100vh;
            line-height: 1.6;
        }

        /* HEADER */
        header {
            padding: 20px 0;
            border-bottom: 1px solid var(--color-border);
            background: var(--color-bg);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        header .header-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 24px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .logo {
            font-family: 'Instrument Serif', Georgia, serif;
            font-size: 1.8rem;
            color: #ffffff;
            text-decoration: none;
            position: fixed;
            left: 90px;
            top: 24px;
            z-index: 100;
        }

        .logo em {
            font-style: italic;
            color: #22d3ee;
        }

        .header-nav {
            display: flex;
            gap: 24px;
            align-items: center;
        }

        .nav-link {
            color: var(--color-text-secondary);
            text-decoration: none;
            font-size: 0.9rem;
            transition: color 0.2s ease;
        }

        .nav-link:hover {
            color: var(--color-accent);
        }

        /* MAIN CONTAINER */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 32px 24px;
        }

        /* PAGE HEADER */
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 32px;
        }

        .page-header h1 {
            font-size: 2.25rem;
            font-weight: 700;
            letter-spacing: -0.02em;
        }

        .page-header .subtitle {
            color: var(--color-text-secondary);
            font-size: 0.95rem;
            margin-top: 4px;
        }

        .header-actions {
            display: flex;
            gap: 12px;
        }

        .header-btn {
            padding: 10px 16px;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid var(--color-border);
            background: var(--color-surface);
            color: var(--color-text);
        }

        .header-btn:hover {
            border-color: var(--color-border-hover);
            background: var(--color-surface-elevated);
        }

        .header-btn.primary {
            background: var(--color-accent);
            color: #000;
            border-color: var(--color-accent);
        }

        .header-btn.primary:hover {
            opacity: 0.9;
        }

        /* BOTTOM CTA */
        .bottom-cta {
            display: flex;
            justify-content: center;
            padding: 40px 0;
            margin-top: 20px;
        }

        .analyze-btn {
            padding: 14px 28px;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            background: var(--color-accent);
            color: #000;
            border: none;
            text-decoration: none;
        }

        .analyze-btn:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }

        /* DAILY PULSE BANNER */
        .daily-pulse {
            background: linear-gradient(135deg, rgba(34, 211, 238, 0.1) 0%, rgba(96, 165, 250, 0.1) 100%);
            border: 1px solid rgba(34, 211, 238, 0.3);
            border-radius: 16px;
            padding: 20px 24px;
            margin-bottom: 24px;
        }

        .pulse-header {
            margin-bottom: 16px;
        }

        .pulse-greeting {
            font-size: 1.1rem;
            color: var(--color-text);
            font-weight: 500;
        }

        .pulse-stats {
            display: flex;
            gap: 32px;
            margin-bottom: 16px;
        }

        .pulse-stat {
            display: flex;
            align-items: baseline;
            gap: 8px;
        }

        .pulse-stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--color-accent);
        }

        .pulse-stat.highlight .pulse-stat-value {
            color: var(--color-hot);
        }

        .pulse-stat-label {
            font-size: 0.9rem;
            color: var(--color-text-secondary);
        }

        .pulse-action {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            padding: 14px 18px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .pulse-action-text {
            color: var(--color-text);
            font-size: 0.95rem;
        }

        .pulse-action-text strong {
            color: var(--color-accent);
        }

        .pulse-action-btn {
            padding: 8px 16px;
            background: var(--color-accent);
            color: #000;
            border: none;
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            text-decoration: none;
            transition: all 0.2s;
        }

        .pulse-action-btn:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }

        /* PIPELINE INTELLIGENCE DASHBOARD */
        .pipeline-dashboard {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 16px;
            margin-bottom: 32px;
        }

        .metric-card {
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: 10px;
            padding: 14px 12px;
            text-align: center;
        }

        .metric-card.highlight {
            border-color: rgba(212, 175, 55, 0.3);
            background: rgba(212, 175, 55, 0.08);
        }

        .metric-value {
            font-size: 1.4rem;
            font-weight: 600;
            font-variant-numeric: tabular-nums;
            line-height: 1.2;
            color: var(--color-text);
        }

        .metric-value.green { color: var(--color-active); }
        .metric-value.amber { color: var(--color-hot); }
        .metric-value.gold { color: var(--color-leverage); }
        .metric-value.blue { color: var(--color-accent); }
        .metric-value.gray { color: var(--color-text-secondary); }
        .metric-value.red { color: var(--color-dead); }

        .metric-label {
            font-size: 0.65rem;
            color: var(--color-text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-top: 4px;
        }

        .metric-sublabel {
            font-size: 0.6rem;
            color: var(--color-text-muted);
            margin-top: 2px;
        }

        /* STRATEGIC PRIORITIES */
        .strategic-priorities {
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 32px;
        }

        .priorities-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .priorities-title {
            font-size: 1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .priority-item {
            display: flex;
            align-items: flex-start;
            gap: 16px;
            padding: 16px;
            background: var(--color-bg);
            border-radius: 12px;
            margin-bottom: 12px;
            border-left: 3px solid transparent;
            transition: all 0.2s;
        }

        .priority-item:last-child {
            margin-bottom: 0;
        }

        .priority-item:hover {
            background: var(--color-surface-elevated);
        }

        .priority-item.hot {
            border-left-color: var(--color-hot);
        }

        .priority-item.active {
            border-left-color: var(--color-active);
        }

        .priority-item.cooling {
            border-left-color: var(--color-cooling);
        }

        .priority-item.leverage {
            border-left-color: var(--color-leverage);
        }

        .priority-badge {
            font-size: 0.7rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding: 4px 8px;
            border-radius: 4px;
            flex-shrink: 0;
        }

        .priority-badge.hot {
            background: var(--color-hot-muted);
            color: var(--color-hot);
        }

        .priority-badge.active {
            background: var(--color-active-muted);
            color: var(--color-active);
        }

        .priority-badge.cooling {
            background: var(--color-cooling-muted);
            color: var(--color-cooling);
        }

        .priority-badge.leverage {
            background: var(--color-leverage-muted);
            color: var(--color-leverage);
        }

        .priority-content {
            flex: 1;
            min-width: 0;
        }

        .priority-role {
            font-weight: 600;
            font-size: 0.95rem;
            margin-bottom: 4px;
        }

        .priority-role.clickable-title {
            cursor: pointer;
            transition: color 0.2s;
        }

        .priority-role.clickable-title:hover {
            color: var(--color-accent);
        }

        .priority-company {
            color: var(--color-text-secondary);
            font-size: 0.85rem;
        }

        .priority-action {
            font-size: 0.85rem;
            color: var(--color-text-muted);
            margin-top: 8px;
            padding-left: 12px;
            border-left: 2px solid var(--color-border);
        }

        .priority-meta {
            display: flex;
            gap: 16px;
            align-items: center;
            flex-shrink: 0;
        }

        .priority-fit {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--color-active);
        }

        .priority-days {
            font-size: 0.8rem;
            color: var(--color-text-muted);
        }

        /* VIEW TOGGLE */
        .view-toggle-container {
            display: flex;
            justify-content: center;
            margin-bottom: 24px;
        }

        .view-toggle {
            display: flex;
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: 8px;
            padding: 4px;
            gap: 4px;
        }

        .view-toggle-btn {
            padding: 8px 20px;
            border: none;
            background: transparent;
            color: var(--color-text-secondary);
            font-size: 0.85rem;
            font-weight: 500;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .view-toggle-btn:hover {
            color: var(--color-text);
        }

        .view-toggle-btn.active {
            background: var(--color-accent);
            color: #000;
        }

        .view-section {
            display: none;
        }

        .view-section.active {
            display: block;
        }

        /* FILTERS BAR */
        .filters-bar {
            display: flex;
            gap: 12px;
            margin-bottom: 24px;
            flex-wrap: wrap;
            align-items: center;
        }

        .filter-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .filter-label {
            font-size: 0.8rem;
            color: var(--color-text-muted);
        }

        .filter-select {
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            color: var(--color-text);
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 0.85rem;
            cursor: pointer;
        }

        .filter-select:hover {
            border-color: var(--color-border-hover);
        }

        .filter-select:focus {
            outline: none;
            border-color: var(--color-accent);
        }

        /* BULK SELECT */
        .bulk-select-btn {
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            color: var(--color-text);
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .bulk-select-btn:hover {
            background: var(--color-bg);
            border-color: var(--color-accent);
        }

        .bulk-select-btn.active {
            background: var(--color-accent);
            border-color: var(--color-accent);
            color: white;
        }

        .bulk-actions-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: var(--color-surface);
            border: 1px solid var(--color-accent);
            border-radius: 8px;
            margin-bottom: 16px;
        }

        .bulk-actions-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .bulk-actions-left input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .bulk-actions-left label {
            cursor: pointer;
            font-size: 0.9rem;
        }

        .selected-count {
            color: var(--color-text-muted);
            font-size: 0.85rem;
        }

        .bulk-actions-right {
            display: flex;
            gap: 8px;
        }

        .bulk-action-btn {
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 0.85rem;
            cursor: pointer;
            border: none;
            transition: all 0.2s;
        }

        .bulk-action-btn.archive {
            background: var(--color-hot-muted);
            color: var(--color-hot);
        }

        .bulk-action-btn.archive:hover {
            background: var(--color-hot);
            color: white;
        }

        .bulk-action-btn.delete {
            background: var(--color-dead-muted);
            color: var(--color-dead);
        }

        .bulk-action-btn.delete:hover {
            background: var(--color-dead);
            color: white;
        }

        .bulk-action-btn.cancel {
            background: transparent;
            color: var(--color-text-muted);
            border: 1px solid var(--color-border);
        }

        .bulk-action-btn.cancel:hover {
            background: var(--color-surface);
        }

        /* App card in select mode */
        .app-card.select-mode {
            cursor: pointer;
        }

        .app-card.select-mode:hover {
            border-color: var(--color-accent);
        }

        .app-card.selected {
            border-color: var(--color-accent);
            background: rgba(59, 130, 246, 0.1);
        }

        .app-card-checkbox {
            position: absolute;
            top: 16px;
            left: 16px;
            width: 22px;
            height: 22px;
            cursor: pointer;
            z-index: 10;
            display: none;
        }

        .app-card.select-mode .app-card-checkbox {
            display: block;
        }

        /* VIEW MODE TOGGLE */
        .view-mode-toggle {
            display: flex;
            gap: 4px;
            margin-left: auto;
            background: var(--color-surface);
            border-radius: 8px;
            padding: 4px;
            border: 1px solid var(--color-border);
        }

        .view-mode-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border: none;
            background: transparent;
            color: var(--color-text-muted);
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.2s;
        }

        .view-mode-btn:hover {
            color: var(--color-text);
            background: rgba(255,255,255,0.05);
        }

        .view-mode-btn.active {
            background: var(--color-accent);
            color: white;
        }

        .view-mode-btn svg {
            opacity: 0.8;
        }

        /* TABLE VIEW */
        .table-view-container {
            overflow-x: auto;
            margin-bottom: 24px;
        }

        .applications-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }

        .applications-table thead {
            position: sticky;
            top: 0;
            background: var(--color-bg);
            z-index: 10;
        }

        .applications-table th {
            text-align: left;
            padding: 12px 16px;
            font-weight: 500;
            color: var(--color-text-muted);
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 1px solid var(--color-border);
            white-space: nowrap;
        }

        .applications-table td {
            padding: 12px 16px;
            border-bottom: 1px solid var(--color-border);
            vertical-align: middle;
        }

        .applications-table tbody tr {
            transition: background 0.15s;
        }

        .applications-table tbody tr:hover {
            background: rgba(255,255,255,0.02);
        }

        .applications-table tbody tr.selected {
            background: rgba(34, 211, 238, 0.1);
        }

        .applications-table tbody tr.ghost-risk {
            background: rgba(239, 68, 68, 0.05);
        }

        .col-checkbox {
            width: 40px;
            text-align: center;
        }

        .col-checkbox input {
            width: 16px;
            height: 16px;
            cursor: pointer;
        }

        .col-company {
            min-width: 140px;
            max-width: 180px;
        }

        .col-role {
            min-width: 180px;
            max-width: 250px;
        }

        .col-status {
            width: 140px;
        }

        .col-fit {
            width: 70px;
            text-align: center;
        }

        .col-stage {
            width: 100px;
        }

        .col-days {
            width: 60px;
            text-align: center;
        }

        .col-action {
            min-width: 200px;
        }

        .col-actions {
            width: 100px;
            text-align: right;
        }

        .table-company {
            font-weight: 500;
            color: var(--color-text);
        }

        .table-role {
            color: var(--color-text);
            cursor: pointer;
        }

        .table-role:hover {
            color: var(--color-accent);
        }

        .table-status-select {
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            color: var(--color-text);
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 0.8rem;
            cursor: pointer;
            max-width: 130px;
        }

        .table-fit-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .table-fit-badge.high {
            background: var(--color-active-muted);
            color: var(--color-active);
        }

        .table-fit-badge.medium {
            background: var(--color-hot-muted);
            color: var(--color-hot);
        }

        .table-fit-badge.low {
            background: var(--color-dead-muted);
            color: var(--color-dead);
        }

        .table-fit-badge.none {
            background: rgba(128,128,128,0.2);
            color: var(--color-text-muted);
        }

        .table-stage {
            font-size: 0.8rem;
            color: var(--color-text-muted);
        }

        .table-stage-indicator {
            display: flex;
            gap: 3px;
            align-items: center;
        }

        .table-stage-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--color-border);
        }

        .table-stage-dot.completed {
            background: var(--color-active);
        }

        .table-stage-dot.current {
            background: var(--color-accent);
            box-shadow: 0 0 6px var(--color-accent);
        }

        .table-days {
            font-size: 0.85rem;
            color: var(--color-text-muted);
        }

        .table-days.urgent {
            color: var(--color-dead);
            font-weight: 500;
        }

        .table-action {
            font-size: 0.8rem;
            color: var(--color-text-secondary);
            max-width: 250px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .table-action-btn {
            padding: 4px 10px;
            border: none;
            background: var(--color-accent);
            color: white;
            border-radius: 4px;
            font-size: 0.75rem;
            cursor: pointer;
            white-space: nowrap;
        }

        .table-action-btn:hover {
            opacity: 0.9;
        }

        .table-action-btn.secondary {
            background: var(--color-surface);
            color: var(--color-text-muted);
            border: 1px solid var(--color-border);
        }

        .table-actions-menu {
            display: flex;
            gap: 6px;
            justify-content: flex-end;
        }

        .table-icon-btn {
            padding: 6px;
            background: transparent;
            border: none;
            color: var(--color-text-muted);
            cursor: pointer;
            border-radius: 4px;
            transition: all 0.15s;
        }

        .table-icon-btn:hover {
            background: rgba(255,255,255,0.1);
            color: var(--color-text);
        }

        .table-icon-btn.danger:hover {
            color: var(--color-dead);
        }

        /* Empty table state */
        .table-empty {
            text-align: center;
            padding: 48px 24px;
            color: var(--color-text-muted);
        }

        /* APPLICATION CARDS */
        .applications-grid {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .app-card {
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: 16px;
            overflow: hidden;
            transition: all 0.2s;
        }

        .app-card:hover {
            border-color: var(--color-border-hover);
        }

        .app-card.hot {
            border-color: rgba(255, 255, 255, 0.3);
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.1);
        }

        .app-card.inactive {
            opacity: 0.6;
        }

        .app-card.ghost-risk {
            border-color: var(--color-dead);
            box-shadow: 0 0 20px var(--color-dead-muted);
        }

        /* Card Header */
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding: 20px 24px 16px;
        }

        .card-title-section {
            flex: 1;
            min-width: 0;
        }

        .card-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: color 0.2s;
        }

        .card-title:hover {
            color: var(--color-accent);
        }

        .leverage-badge {
            font-size: 0.65rem;
            font-weight: 700;
            text-transform: uppercase;
            padding: 3px 6px;
            border-radius: 4px;
            background: var(--color-leverage-muted);
            color: var(--color-leverage);
        }

        .card-subtitle {
            color: var(--color-text-secondary);
            font-size: 0.9rem;
        }

        .editable-company {
            cursor: pointer;
            padding: 2px 4px;
            margin: -2px -4px;
            border-radius: 4px;
            transition: background 0.2s;
        }

        .editable-company:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .company-edit-input {
            background: var(--color-surface);
            border: 1px solid var(--color-accent);
            border-radius: 4px;
            padding: 4px 8px;
            color: var(--color-text);
            font-size: 0.9rem;
            min-width: 150px;
        }

        .company-edit-input:focus {
            outline: none;
        }

        .card-meta {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .fit-badge {
            font-size: 0.9rem;
            font-weight: 600;
            padding: 6px 12px;
            border-radius: 8px;
        }

        .fit-badge.high {
            background: var(--color-active-muted);
            color: var(--color-active);
        }

        .fit-badge.medium {
            background: var(--color-hot-muted);
            color: var(--color-hot);
        }

        .fit-badge.low {
            background: var(--color-dead-muted);
            color: var(--color-dead);
        }

        .fit-badge.none {
            background: rgba(128, 128, 128, 0.2);
            color: var(--color-text-muted);
            font-size: 0.7rem;
        }

        /* Next Action Section */
        .next-action {
            margin: 0 24px 16px;
            padding: 16px;
            background: var(--color-bg);
            border-radius: 12px;
            border-left: 3px solid var(--color-accent);
        }

        .next-action.urgent {
            border-left-color: var(--color-hot);
            background: var(--color-hot-muted);
        }

        .next-action.positive {
            border-left-color: var(--color-active);
            background: var(--color-active-muted);
        }

        .next-action.dead {
            border-left-color: var(--color-dead);
            background: var(--color-dead-muted);
        }

        .next-action-label {
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--color-accent);
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .next-action.urgent .next-action-label { color: var(--color-hot); }
        .next-action.positive .next-action-label { color: var(--color-active); }
        .next-action.dead .next-action-label { color: var(--color-dead); }

        .next-action-text {
            font-size: 0.9rem;
            line-height: 1.5;
            margin-bottom: 8px;
        }

        .next-action-cta {
            font-size: 0.85rem;
            color: var(--color-text);
            font-weight: 500;
        }

        /* Timeline Section */
        .timeline-section {
            padding: 0 24px 16px;
        }

        .timeline-bar {
            display: flex;
            align-items: center;
            gap: 4px;
            margin-bottom: 8px;
        }

        .timeline-stage {
            flex: 1;
            height: 6px;
            background: var(--color-border);
            border-radius: 3px;
            position: relative;
            cursor: pointer;
            transition: transform 0.15s, opacity 0.15s;
        }

        .timeline-stage:hover {
            transform: scaleY(1.5);
            opacity: 0.8;
        }

        .timeline-stage.completed {
            background: var(--color-active);
        }

        .timeline-stage.current {
            background: var(--color-active);
            position: relative;
        }

        .timeline-stage.current::after {
            content: '';
            position: absolute;
            top: -4px;
            left: 50%;
            transform: translateX(-50%);
            width: 14px;
            height: 14px;
            background: var(--color-active);
            border: 2px solid var(--color-bg);
            border-radius: 50%;
            box-shadow: 0 0 0 2px var(--color-active);
        }

        .timeline-stage.awaiting {
            background: var(--color-hot);
            animation: pulse-awaiting 2s ease-in-out infinite;
        }

        @keyframes pulse-awaiting {
            0%, 100% { opacity: 0.7; }
            50% { opacity: 1; }
        }

        .you-are-here {
            text-align: center;
            font-size: 0.65rem;
            color: var(--color-active);
            font-weight: 600;
            margin-top: 4px;
            letter-spacing: 0.5px;
        }

        .timeline-labels {
            display: flex;
            justify-content: space-between;
            font-size: 0.7rem;
            color: var(--color-text-muted);
        }

        /* Card Stats Grid */
        .card-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1px;
            background: var(--color-border);
            margin: 0 24px 16px;
            border-radius: 8px;
            overflow: hidden;
        }

        .card-stat {
            background: var(--color-bg);
            padding: 12px;
            text-align: center;
        }

        .card-stat-value {
            font-size: 0.85rem;
            font-weight: 600;
        }

        .card-stat-value.fast { color: var(--color-active); }
        .card-stat-value.medium { color: var(--color-hot); }
        .card-stat-value.slow { color: var(--color-cooling); }

        .card-stat-label {
            font-size: 0.7rem;
            color: var(--color-text-muted);
            margin-top: 2px;
        }

        /* Card Actions */
        .card-actions {
            display: flex;
            gap: 8px;
            padding: 16px 24px;
            border-top: 1px solid var(--color-border);
            background: var(--color-bg);
        }

        .card-action-btn {
            flex: 1;
            padding: 10px;
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid var(--color-border);
            background: var(--color-surface);
            color: var(--color-text-secondary);
        }

        .card-action-btn:hover {
            background: var(--color-surface-elevated);
            color: var(--color-text);
        }

        .card-action-btn.primary {
            background: var(--color-accent);
            color: #000;
            border-color: var(--color-accent);
        }

        .card-action-btn.done {
            color: var(--color-active);
            border-color: var(--color-active-muted);
        }

        .card-action-btn.danger:hover {
            background: var(--color-dead-muted);
            color: var(--color-dead);
            border-color: var(--color-dead);
        }

        .card-action-btn.ask-henry {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff;
            border-color: #667eea;
        }

        .card-action-btn.ask-henry:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }

        /* Delete link (subtle, only for archived apps) */
        .card-action-link {
            color: var(--color-text-muted);
            font-size: 0.85rem;
            text-decoration: none;
            padding: 8px 12px;
            display: inline-flex;
            align-items: center;
        }

        .card-action-link:hover {
            color: var(--color-dead);
            text-decoration: underline;
        }

        /* Reach Out Modal Options */
        .reach-out-option {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 16px;
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: 12px;
            cursor: pointer;
            text-align: left;
            transition: all 0.2s;
            color: var(--color-text);
        }

        .reach-out-option:hover {
            background: var(--color-surface-elevated);
            border-color: var(--color-accent);
            transform: translateX(4px);
        }

        .reach-out-icon {
            font-size: 1.5rem;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--color-bg);
            border-radius: 10px;
        }

        .reach-out-option-text {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .reach-out-option-text strong {
            font-size: 1rem;
        }

        .reach-out-option-text span {
            font-size: 0.85rem;
            color: var(--color-text-muted);
        }

        /* Import Option Buttons */
        .import-option-btn {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 16px;
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: 12px;
            cursor: pointer;
            text-align: left;
            transition: all 0.2s;
            color: var(--color-text);
            width: 100%;
        }

        .import-option-btn:hover {
            background: var(--color-surface-elevated);
            border-color: var(--color-accent);
            transform: translateX(4px);
        }

        .import-option-icon {
            font-size: 1.5rem;
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--color-bg);
            border-radius: 10px;
        }

        .import-option-text {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .import-option-text strong {
            font-size: 1rem;
        }

        .import-option-text span {
            font-size: 0.85rem;
            color: var(--color-text-muted);
        }

        /* Screenshot Upload Area */
        .screenshot-upload-area {
            margin-top: 20px;
            border: 2px dashed var(--color-border);
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .screenshot-upload-area:hover,
        .screenshot-upload-area.dragover {
            border-color: var(--color-accent);
            background: rgba(102, 126, 234, 0.05);
        }

        .screenshot-upload-area.has-image {
            padding: 20px;
            border-style: solid;
        }

        /* Processing Spinner */
        .processing-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--color-border);
            border-top-color: var(--color-accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Extracted Job Item */
        .extracted-job-item {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 12px;
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: 8px;
            margin-bottom: 8px;
        }

        .extracted-job-item:hover {
            border-color: var(--color-border-hover);
        }

        .extracted-job-checkbox {
            margin-top: 4px;
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .extracted-job-details {
            flex: 1;
        }

        .extracted-job-title {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .extracted-job-company {
            color: var(--color-text-muted);
            font-size: 0.9rem;
        }

        .extracted-job-meta {
            display: flex;
            gap: 16px;
            margin-top: 8px;
            font-size: 0.85rem;
            color: var(--color-text-muted);
        }

        /* Status Selector */
        .status-selector {
            position: relative;
        }

        .status-btn {
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.85rem;
            cursor: pointer;
            border: 1px solid var(--color-border);
            background: var(--color-surface);
            color: var(--color-text);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .status-btn:hover {
            border-color: var(--color-border-hover);
        }

        .status-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 4px;
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: 12px;
            padding: 8px;
            z-index: 100;
            min-width: 200px;
            display: none;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
        }

        .status-dropdown.show {
            display: block;
        }

        .status-option {
            padding: 10px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: background 0.15s;
        }

        .status-option:hover {
            background: var(--color-surface-elevated);
        }

        .status-category-header {
            padding: 8px 12px 4px;
            font-size: 0.7rem;
            font-weight: 600;
            color: var(--color-text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            border-top: 1px solid var(--color-border);
            margin-top: 4px;
        }

        .status-category-header:first-child {
            border-top: none;
            margin-top: 0;
        }

        .status-option.current {
            background: var(--color-accent-muted);
            color: var(--color-accent);
        }

        /* Expandable Sections */
        .expandable-section {
            padding: 0 24px;
            margin-bottom: 16px;
        }

        .expandable-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--color-text-secondary);
            font-size: 0.85rem;
            cursor: pointer;
            padding: 8px 0;
        }

        .expandable-toggle:hover {
            color: var(--color-text);
        }

        .expandable-content {
            display: none;
            padding: 12px 0;
        }

        .expandable-content.show {
            display: block;
        }

        /* Notes */
        .notes-textarea {
            width: 100%;
            background: var(--color-bg);
            border: 1px solid var(--color-border);
            border-radius: 8px;
            padding: 12px;
            color: var(--color-text);
            font-family: inherit;
            font-size: 0.9rem;
            resize: vertical;
            min-height: 80px;
        }

        .notes-textarea:focus {
            outline: none;
            border-color: var(--color-accent);
        }

        /* Interview Notes */
        .interview-notes {
            background: var(--color-bg);
            border-radius: 8px;
            padding: 16px;
        }

        /* Pre-Interview Rejection Debrief */
        .rejection-debrief {
            margin: 0 24px 16px;
            padding: 20px;
            background: linear-gradient(135deg, rgba(229, 115, 115, 0.08) 0%, rgba(229, 115, 115, 0.03) 100%);
            border: 1px solid rgba(229, 115, 115, 0.2);
            border-radius: 12px;
        }

        .debrief-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 16px;
        }

        .debrief-title {
            font-size: 0.95rem;
            font-weight: 600;
            color: var(--color-text);
        }

        .debrief-subtitle {
            font-size: 0.85rem;
            color: var(--color-text-secondary);
            margin-bottom: 16px;
            line-height: 1.6;
        }

        .debrief-factors {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .debrief-factor {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 12px;
            background: var(--color-bg);
            border-radius: 8px;
        }

        .factor-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-top: 6px;
            flex-shrink: 0;
        }

        .factor-indicator.high { background: var(--color-dead); }
        .factor-indicator.medium { background: var(--color-hot); }
        .factor-indicator.low { background: var(--color-cooling); }

        .factor-content {
            flex: 1;
        }

        .factor-title {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--color-text);
            margin-bottom: 4px;
        }

        .factor-explanation {
            font-size: 0.8rem;
            color: var(--color-text-secondary);
            line-height: 1.5;
        }

        .debrief-insight {
            margin-top: 16px;
            padding: 14px;
            background: var(--color-surface);
            border-radius: 8px;
            border-left: 3px solid var(--color-accent);
        }

        .insight-label {
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--color-accent);
            margin-bottom: 6px;
        }

        .insight-text {
            font-size: 0.85rem;
            color: var(--color-text);
            line-height: 1.6;
        }

        /* Pattern Alert */
        .pattern-alert {
            margin: 0 24px 16px;
            padding: 16px 20px;
            background: linear-gradient(135deg, rgba(255, 107, 53, 0.15) 0%, rgba(255, 107, 53, 0.05) 100%);
            border: 1px solid rgba(255, 107, 53, 0.3);
            border-radius: 12px;
        }

        .pattern-alert-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
        }

        .pattern-alert-title {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--color-hot);
        }

        .pattern-alert-content {
            font-size: 0.85rem;
            color: var(--color-text-secondary);
            line-height: 1.6;
        }

        .pattern-recommendations {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid rgba(255, 107, 53, 0.2);
        }

        .pattern-recommendations ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .pattern-recommendations li {
            font-size: 0.8rem;
            color: var(--color-text);
            padding: 6px 0;
            padding-left: 20px;
            position: relative;
        }

        .pattern-recommendations li::before {
            content: 'â†’';
            position: absolute;
            left: 0;
            color: var(--color-hot);
        }

        /* Desperation Intervention Modal */
        .intervention-modal {
            max-width: 640px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .intervention-modal .modal-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--color-border);
        }

        .intervention-modal .modal-header-icon {
            font-size: 1.5rem;
        }

        .intervention-modal .modal-header-text h2 {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .intervention-modal .modal-header-text .severity {
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
        }

        .intervention-modal .modal-header-text .severity.high { color: var(--color-dead); }
        .intervention-modal .modal-header-text .severity.critical { color: #dc2626; }
        .intervention-modal .modal-header-text .severity.medium { color: var(--color-hot); }

        .intervention-intro {
            color: var(--color-text-secondary);
            font-size: 0.9rem;
            line-height: 1.7;
            margin-bottom: 20px;
        }

        .intervention-intro strong {
            color: var(--color-text);
        }

        .intervention-stats {
            background: var(--color-bg);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 20px;
        }

        .intervention-stats-title {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--color-text-muted);
            margin-bottom: 12px;
        }

        .intervention-stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
        }

        .intervention-stat {
            text-align: center;
        }

        .intervention-stat-value {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .intervention-stat-value.bad { color: var(--color-dead); }
        .intervention-stat-value.warn { color: var(--color-hot); }
        .intervention-stat-value.neutral { color: var(--color-text-secondary); }

        .intervention-stat-label {
            font-size: 0.75rem;
            color: var(--color-text-muted);
            margin-top: 4px;
        }

        .intervention-diagnosis {
            margin-bottom: 20px;
        }

        .intervention-diagnosis-title {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--color-text);
            margin-bottom: 12px;
        }

        .intervention-diagnosis-item {
            display: flex;
            gap: 12px;
            padding: 12px;
            background: var(--color-bg);
            border-radius: 8px;
            margin-bottom: 8px;
        }

        .intervention-diagnosis-item:last-child {
            margin-bottom: 0;
        }

        .diagnosis-number {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--color-dead-muted);
            color: var(--color-dead);
            font-size: 0.75rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .diagnosis-content {
            flex: 1;
        }

        .diagnosis-title {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--color-text);
            margin-bottom: 4px;
        }

        .diagnosis-detail {
            font-size: 0.8rem;
            color: var(--color-text-secondary);
            line-height: 1.5;
        }

        .intervention-action-plan {
            background: linear-gradient(135deg, rgba(34, 211, 238, 0.1) 0%, rgba(34, 211, 238, 0.03) 100%);
            border: 1px solid rgba(34, 211, 238, 0.2);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 20px;
        }

        .intervention-action-title {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--color-accent);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .intervention-action-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .intervention-action-list li {
            font-size: 0.85rem;
            color: var(--color-text);
            padding: 8px 0;
            padding-left: 24px;
            position: relative;
            border-bottom: 1px solid rgba(34, 211, 238, 0.1);
        }

        .intervention-action-list li:last-child {
            border-bottom: none;
        }

        .intervention-action-list li::before {
            content: 'â†’';
            position: absolute;
            left: 0;
            color: var(--color-accent);
            font-weight: 600;
        }

        .intervention-insight {
            background: var(--color-surface-elevated);
            border-left: 3px solid var(--color-accent);
            padding: 14px;
            border-radius: 0 8px 8px 0;
            margin-bottom: 24px;
        }

        .intervention-insight-text {
            font-size: 0.85rem;
            color: var(--color-text);
            line-height: 1.6;
            font-style: italic;
        }

        .intervention-choice {
            margin-bottom: 20px;
        }

        .intervention-choice-label {
            font-size: 0.85rem;
            color: var(--color-text-secondary);
            margin-bottom: 12px;
        }

        .intervention-choice-options {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .intervention-choice-option {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            background: var(--color-bg);
            border: 1px solid var(--color-border);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .intervention-choice-option:hover {
            border-color: var(--color-border-hover);
        }

        .intervention-choice-option.selected {
            border-color: var(--color-accent);
            background: var(--color-accent-muted);
        }

        .intervention-choice-option.recommended {
            border-color: var(--color-active);
        }

        .intervention-choice-option input[type="radio"] {
            display: none;
        }

        .intervention-radio {
            width: 18px;
            height: 18px;
            border: 2px solid var(--color-border);
            border-radius: 50%;
            position: relative;
            flex-shrink: 0;
        }

        .intervention-choice-option.selected .intervention-radio {
            border-color: var(--color-accent);
        }

        .intervention-choice-option.selected .intervention-radio::after {
            content: '';
            position: absolute;
            top: 3px;
            left: 3px;
            width: 8px;
            height: 8px;
            background: var(--color-accent);
            border-radius: 50%;
        }

        .intervention-choice-text {
            flex: 1;
        }

        .intervention-choice-text strong {
            display: block;
            font-size: 0.9rem;
            margin-bottom: 2px;
        }

        .intervention-choice-text span {
            font-size: 0.8rem;
            color: var(--color-text-muted);
        }

        .intervention-badge {
            font-size: 0.65rem;
            font-weight: 700;
            text-transform: uppercase;
            padding: 3px 8px;
            border-radius: 4px;
        }

        .intervention-badge.recommended {
            background: var(--color-active-muted);
            color: var(--color-active);
        }

        .intervention-badge.not-recommended {
            background: var(--color-dead-muted);
            color: var(--color-dead);
        }

        .intervention-modal .modal-actions {
            padding-top: 16px;
            border-top: 1px solid var(--color-border);
        }

        .intervention-modal .modal-btn {
            flex: 1;
        }

        .intervention-modal .modal-btn.primary {
            background: var(--color-accent);
            color: #000;
        }

        /* Low-fit application samples */
        .sample-applications {
            margin-bottom: 16px;
        }

        .sample-applications-title {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--color-text-muted);
            margin-bottom: 12px;
        }

        .sample-app {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 12px;
            background: var(--color-bg);
            border-radius: 8px;
            margin-bottom: 6px;
            font-size: 0.85rem;
        }

        .sample-app:last-child {
            margin-bottom: 0;
        }

        .sample-app-role {
            color: var(--color-text);
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .sample-app-fit {
            font-weight: 600;
            margin-left: 12px;
        }

        .sample-app-fit.low { color: var(--color-dead); }
        .sample-app-fit.medium { color: var(--color-hot); }

        .sample-app-note {
            font-size: 0.75rem;
            color: var(--color-text-muted);
            margin-left: 8px;
        }

        .interview-date {
            font-size: 0.8rem;
            color: var(--color-text-muted);
            margin-bottom: 12px;
        }

        .interview-section {
            margin-bottom: 12px;
        }

        .interview-section:last-child {
            margin-bottom: 0;
        }

        .interview-section-label {
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 6px;
        }

        .interview-section-label.nailed { color: var(--color-active); }
        .interview-section-label.fumbled { color: var(--color-hot); }
        .interview-section-label.signals { color: var(--color-accent); }

        .interview-bullets {
            list-style: none;
            font-size: 0.85rem;
            color: var(--color-text-secondary);
        }

        .interview-bullets li {
            padding: 4px 0;
            padding-left: 16px;
            position: relative;
        }

        .interview-bullets li::before {
            content: 'â€¢';
            position: absolute;
            left: 0;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 80px 40px;
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: 16px;
        }

        .empty-state h2 {
            font-size: 1.25rem;
            font-weight: 500;
            margin-bottom: 8px;
        }

        .empty-state p {
            color: var(--color-text-secondary);
            margin-bottom: 24px;
            max-width: 400px;
            margin-left: auto;
            margin-right: auto;
        }

        .empty-state a {
            display: inline-block;
            background: var(--color-accent);
            color: #000;
            padding: 14px 28px;
            border-radius: 8px;
            text-decoration: none;
            font-weight: 600;
        }

        /* Modals */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.85);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
        }

        .modal-overlay.show {
            display: flex;
        }

        .modal {
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: 16px;
            padding: 32px;
            max-width: 500px;
            width: 100%;
        }

        .modal h2 {
            font-size: 1.25rem;
            margin-bottom: 12px;
        }

        .modal p {
            color: var(--color-text-secondary);
            margin-bottom: 24px;
            line-height: 1.6;
        }

        .modal-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        .modal-btn {
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            border: none;
            transition: all 0.2s;
        }

        .modal-btn.secondary {
            background: var(--color-surface-elevated);
            color: var(--color-text);
        }

        .modal-btn.secondary:hover {
            background: var(--color-border);
        }

        .modal-btn.danger {
            background: var(--color-dead);
            color: white;
        }

        .modal-btn.danger:hover {
            opacity: 0.9;
        }

        .modal-btn.primary {
            background: var(--color-accent);
            color: #000;
        }

        .modal-btn.primary:hover {
            opacity: 0.9;
        }

        /* Date Edit Modal */
        .date-edit-modal {
            max-width: 480px;
        }

        .date-edit-modal h2 {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .date-field-group {
            margin-bottom: 20px;
        }

        .date-field-label {
            display: block;
            font-size: 0.85rem;
            color: var(--color-text-secondary);
            margin-bottom: 8px;
        }

        .date-field-input {
            width: 100%;
            padding: 12px 16px;
            background: var(--color-surface-elevated);
            border: 1px solid var(--color-border);
            border-radius: 8px;
            color: var(--color-text);
            font-size: 1rem;
            cursor: pointer;
        }

        .date-field-input:focus {
            outline: none;
            border-color: var(--color-accent);
        }

        .date-field-input::-webkit-calendar-picker-indicator {
            filter: invert(1);
            cursor: pointer;
        }

        .date-warning {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            padding: 12px 16px;
            background: var(--color-hot-muted);
            border: 1px solid var(--color-hot);
            border-radius: 8px;
            margin-top: 16px;
            font-size: 0.85rem;
            color: var(--color-text);
        }

        .date-warning-icon {
            font-size: 1.2rem;
        }

        .date-warning-text {
            line-height: 1.5;
        }

        .ghost-check-section {
            margin-top: 16px;
            padding: 16px;
            background: var(--color-surface-elevated);
            border-radius: 8px;
        }

        .ghost-check-title {
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 12px;
        }

        .ghost-check-options {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .ghost-check-option {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            padding: 8px 12px;
            border-radius: 6px;
            transition: background 0.2s;
        }

        .ghost-check-option:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .ghost-check-option input {
            accent-color: var(--color-accent);
        }

        .timeline-edit-section {
            margin-top: 24px;
            padding-top: 24px;
            border-top: 1px solid var(--color-border);
        }

        .timeline-edit-title {
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .timeline-date-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid var(--color-border);
        }

        .timeline-date-row:last-child {
            border-bottom: none;
        }

        .timeline-date-label {
            font-size: 0.85rem;
            color: var(--color-text-secondary);
        }

        .timeline-date-value {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .timeline-date-value input {
            padding: 6px 10px;
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: 6px;
            color: var(--color-text);
            font-size: 0.85rem;
        }

        .timeline-date-value input:focus {
            outline: none;
            border-color: var(--color-accent);
        }

        .timeline-date-value input::-webkit-calendar-picker-indicator {
            filter: invert(1);
            cursor: pointer;
            font-size: 0.8rem;
        }

        .clear-date-btn {
            background: none;
            border: none;
            color: var(--color-text-muted);
            cursor: pointer;
            font-size: 0.8rem;
            padding: 4px;
        }

        .clear-date-btn:hover {
            color: var(--color-dead);
        }

        /* Inline Date Edit in Card */
        .timeline-date-edit {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 24px;
            background: var(--color-surface-elevated);
            border-bottom: 1px solid var(--color-border);
            font-size: 0.8rem;
        }

        .timeline-date-edit-left {
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--color-text-secondary);
        }

        .timeline-date-display {
            color: var(--color-text);
        }

        .timeline-days-ago {
            color: var(--color-text-muted);
        }

        .edit-date-btn {
            background: none;
            border: none;
            color: var(--color-accent);
            cursor: pointer;
            font-size: 0.8rem;
            padding: 4px 8px;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .edit-date-btn:hover {
            background: var(--color-accent-muted);
        }

        /* Ghost Risk Alert */
        .ghost-risk-alert {
            padding: 16px 24px;
            background: var(--color-hot-muted);
            border-left: 3px solid var(--color-hot);
            margin: 0 24px 16px;
            border-radius: 0 8px 8px 0;
        }

        .ghost-risk-title {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--color-hot);
            margin-bottom: 6px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .ghost-risk-text {
            font-size: 0.85rem;
            color: var(--color-text-secondary);
            line-height: 1.5;
        }

        /* Responsive */
        @media (max-width: 900px) {
            .pipeline-dashboard {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        @media (max-width: 640px) {
            .container {
                padding: 20px 16px;
            }

            .pipeline-dashboard {
                grid-template-columns: repeat(2, 1fr);
            }

            .page-header {
                flex-direction: column;
                gap: 16px;
            }

            .header-actions {
                width: 100%;
            }

            .header-btn {
                flex: 1;
            }

            .filters-bar {
                flex-direction: column;
                align-items: stretch;
            }

            .view-toggle {
                margin-left: 0;
            }

            .card-header {
                flex-direction: column;
                gap: 12px;
            }

            .card-meta {
                width: 100%;
                justify-content: space-between;
            }

            .card-stats {
                grid-template-columns: 1fr;
            }

            .card-actions {
                flex-wrap: wrap;
            }

            .priority-item {
                flex-direction: column;
                gap: 12px;
            }

            .priority-meta {
                width: 100%;
                justify-content: space-between;
            }
        }

        /* Candidate Experience Score Badge */
        .experience-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            font-size: 0.75rem;
            font-weight: 600;
            padding: 4px 8px;
            border-radius: 6px;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .experience-badge.grade-a {
            background: var(--color-active-muted);
            color: var(--color-active);
        }

        .experience-badge.grade-b {
            background: rgba(96, 165, 250, 0.15);
            color: #60a5fa;
        }

        .experience-badge.grade-c {
            background: var(--color-hot-muted);
            color: var(--color-hot);
        }

        .experience-badge.grade-d {
            background: var(--color-dead-muted);
            color: var(--color-dead);
        }

        .experience-badge.grade-f {
            background: rgba(220, 38, 38, 0.15);
            color: #dc2626;
        }

        /* Experience Signals Section */
        .experience-signals {
            background: var(--color-bg);
            border-radius: 12px;
            padding: 16px;
            margin-top: 12px;
        }

        .experience-signals-title {
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--color-text-muted);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .experience-signal {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            padding: 10px 0;
            border-bottom: 1px solid var(--color-border);
        }

        .experience-signal:last-child {
            border-bottom: none;
            padding-bottom: 0;
        }

        .experience-signal:first-child {
            padding-top: 0;
        }

        .signal-icon {
            font-size: 1rem;
            flex-shrink: 0;
        }

        .signal-content {
            flex: 1;
        }

        .signal-title {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--color-text);
            margin-bottom: 2px;
        }

        .signal-detail {
            font-size: 0.8rem;
            color: var(--color-text-secondary);
            line-height: 1.5;
        }

        /* Company Behavior Analysis Modal */
        .behavior-analysis-modal {
            max-width: 640px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .behavior-timeline {
            display: flex;
            justify-content: space-between;
            padding: 16px;
            background: var(--color-bg);
            border-radius: 8px;
            margin-bottom: 16px;
        }

        .timeline-item {
            text-align: center;
        }

        .timeline-label {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--color-text-muted);
            margin-bottom: 4px;
        }

        .timeline-value {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--color-text);
        }

        .behavior-insight {
            background: var(--color-surface-elevated);
            border-left: 3px solid var(--color-hot);
            padding: 14px;
            border-radius: 0 8px 8px 0;
            margin-bottom: 16px;
        }

        .behavior-insight-title {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--color-hot);
            margin-bottom: 8px;
        }

        .behavior-insight-text {
            font-size: 0.85rem;
            color: var(--color-text);
            line-height: 1.6;
        }

        .behavior-principle {
            background: linear-gradient(135deg, rgba(34, 211, 238, 0.1) 0%, rgba(34, 211, 238, 0.03) 100%);
            border: 1px solid rgba(34, 211, 238, 0.2);
            border-radius: 12px;
            padding: 16px;
            margin-top: 16px;
            text-align: center;
        }

        .behavior-principle-label {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--color-accent);
            margin-bottom: 8px;
        }

        .behavior-principle-text {
            font-size: 0.95rem;
            font-weight: 500;
            color: var(--color-text);
            font-style: italic;
        }

        /* Interview Rounds Warning */
        .rounds-warning {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 16px;
            background: var(--color-hot-muted);
            border: 1px solid var(--color-hot);
            border-radius: 8px;
            margin-bottom: 16px;
        }

        .rounds-warning-icon {
            font-size: 1.2rem;
        }

        .rounds-warning-text {
            font-size: 0.85rem;
            color: var(--color-text);
        }

        .rounds-warning-text strong {
            color: var(--color-hot);
        }

        /* ================================================================== */
        /* COMMAND CENTER COMPONENTS (v2.0)                                   */
        /* ================================================================== */

        /* Daily Pulse Banner - Intelligence Hub */
        .daily-pulse-v2 {
            background: linear-gradient(135deg, rgba(34, 211, 238, 0.1), rgba(96, 165, 250, 0.1));
            border: 1px solid rgba(34, 211, 238, 0.3);
            border-radius: var(--radius-xl);
            padding: var(--space-xl);
            margin-bottom: var(--space-xxl);
        }

        .pulse-greeting-v2 {
            font-size: 1.1rem;
            font-weight: 500;
            color: var(--color-text);
            margin-bottom: var(--space-lg);
        }

        .pulse-actions-row {
            display: flex;
            gap: var(--space-lg);
            margin-bottom: var(--space-lg);
            flex-wrap: wrap;
        }

        .pulse-action-card {
            background: rgba(0, 0, 0, 0.2);
            border-radius: var(--radius-lg);
            padding: var(--space-lg);
            min-width: 200px;
            flex: 1;
            max-width: 280px;
        }

        .pulse-action-icon {
            font-size: 1.5rem;
            margin-bottom: var(--space-sm);
        }

        .pulse-action-company {
            font-weight: 600;
            font-size: 1rem;
            color: var(--color-text);
            margin-bottom: var(--space-xs);
        }

        .pulse-action-text {
            font-size: 0.9rem;
            color: var(--color-text-secondary);
            margin-bottom: var(--space-md);
        }

        .pulse-action-btn {
            background: var(--color-accent);
            color: #000;
            padding: var(--space-sm) var(--space-lg);
            border-radius: var(--radius-md);
            font-weight: 600;
            font-size: 0.85rem;
            border: none;
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .pulse-action-btn:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }

        .pulse-health {
            font-size: 0.95rem;
            display: flex;
            align-items: center;
            gap: var(--space-sm);
        }

        .pulse-health.healthy { color: var(--color-healthy); }
        .pulse-health.caution { color: var(--color-caution); }
        .pulse-health.urgent { color: var(--color-stalled); }

        .pulse-health-reason {
            color: var(--color-text-secondary);
            font-size: 0.9rem;
            margin-left: var(--space-sm);
        }

        /* View Selector */
        .view-selector {
            display: flex;
            gap: var(--space-xs);
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: 10px;
            padding: var(--space-xs);
            margin-bottom: var(--space-xl);
            width: fit-content;
        }

        .view-selector-btn {
            padding: 10px 20px;
            border-radius: var(--radius-md);
            background: transparent;
            color: var(--color-text-secondary);
            font-weight: 500;
            font-size: 0.9rem;
            cursor: pointer;
            border: none;
            transition: all var(--transition-base);
        }

        .view-selector-btn:hover {
            background: rgba(255, 255, 255, 0.05);
            color: var(--color-text);
        }

        .view-selector-btn.active {
            background: var(--color-accent-muted);
            color: var(--color-accent);
            font-weight: 600;
        }

        /* Board View */
        .board-container {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: var(--space-lg);
            min-height: 600px;
        }

        @media (max-width: 1024px) {
            .board-container {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .board-container {
                grid-template-columns: 1fr;
            }
        }

        .board-column {
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-lg);
            padding: var(--space-lg);
        }

        .board-column-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-lg);
        }

        .board-column-title {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--color-text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .board-column-count {
            background: var(--color-border);
            color: var(--color-text);
            padding: 2px var(--space-sm);
            border-radius: 12px;
            font-size: 0.75rem;
        }

        .board-cards {
            display: flex;
            flex-direction: column;
            gap: var(--space-md);
            min-height: 100px;
            transition: background 0.2s ease;
        }

        /* Drag and drop styles */
        .board-column.drag-over {
            background: rgba(34, 211, 238, 0.05);
            border-color: var(--color-accent);
        }

        .board-cards.drag-over {
            background: rgba(34, 211, 238, 0.08);
            border-radius: var(--radius-md);
        }

        .app-card-v2.dragging {
            opacity: 0.5;
            transform: rotate(2deg);
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }

        .app-card-v2[draggable="true"] {
            cursor: grab;
        }

        .app-card-v2[draggable="true"]:active {
            cursor: grabbing;
        }

        .drop-indicator {
            height: 4px;
            background: var(--color-accent);
            border-radius: 2px;
            margin: var(--space-sm) 0;
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .drop-indicator.visible {
            opacity: 1;
        }

        /* Application Card with UI Signals */
        .app-card-v2 {
            background: var(--color-surface-elevated);
            border: 2px solid var(--color-confidence-medium);
            border-radius: var(--radius-lg);
            padding: var(--space-lg);
            transition: all var(--transition-base);
            cursor: pointer;
        }

        .app-card-v2:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .app-card-v2.confidence-high { border-color: var(--color-confidence-high); }
        .app-card-v2.confidence-medium { border-color: var(--color-confidence-medium); }
        .app-card-v2.confidence-low { border-color: var(--color-confidence-low); }

        .app-card-v2.dimmed {
            opacity: 0.3;
            pointer-events: none;
        }

        .app-card-v2.priority-high:not(.dimmed) {
            box-shadow: 0 4px 20px rgba(34, 211, 238, 0.2);
        }

        .card-header-v2 {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: var(--space-md);
        }

        .card-title-row {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
        }

        .card-icon {
            font-size: 1.2rem;
        }

        .card-icon.urgent {
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.8; transform: scale(1.05); }
        }

        .card-title-v2 {
            font-size: 1rem;
            font-weight: 600;
            color: var(--color-text);
            line-height: 1.3;
        }

        .card-header-actions {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
        }

        .card-badge {
            background: rgba(34, 211, 238, 0.15);
            color: var(--color-accent);
            padding: 2px var(--space-sm);
            border-radius: var(--radius-sm);
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .card-override-btn {
            background: transparent;
            border: none;
            cursor: pointer;
            font-size: 0.9rem;
            padding: var(--space-xs);
            border-radius: var(--radius-sm);
            opacity: 0.5;
            transition: opacity var(--transition-fast), background var(--transition-fast);
        }

        .card-override-btn:hover {
            opacity: 1;
            background: var(--color-surface-elevated);
        }

        .app-card-v2:hover .card-override-btn {
            opacity: 0.8;
        }

        .card-stats-v2 {
            display: flex;
            gap: var(--space-lg);
            flex-wrap: wrap;
            margin-bottom: var(--space-md);
            font-size: 0.85rem;
            color: var(--color-text-secondary);
        }

        .card-stat-v2 {
            display: inline-flex;
            align-items: center;
            gap: var(--space-xs);
        }

        /* Next Action Section */
        .next-action-section {
            background: rgba(34, 211, 238, 0.08);
            border-left: 3px solid var(--color-accent);
            padding: var(--space-md);
            border-radius: var(--radius-sm);
            margin-bottom: var(--space-md);
        }

        .next-action-text {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--color-text);
            margin-bottom: var(--space-xs);
        }

        .next-action-reason {
            font-size: 0.85rem;
            color: var(--color-text-secondary);
            line-height: 1.4;
        }

        /* One-Click Action Button */
        .one-click-btn {
            background: var(--color-accent);
            color: #000;
            border: none;
            padding: 10px var(--space-lg);
            border-radius: var(--radius-md);
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            transition: all var(--transition-base);
        }

        .one-click-btn:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }

        .one-click-btn.secondary {
            background: var(--color-surface);
            color: var(--color-text);
            border: 1px solid var(--color-border);
        }

        /* Override Badge */
        .override-badge {
            position: absolute;
            top: var(--space-sm);
            right: var(--space-sm);
            background: var(--color-override-muted);
            border: 1px solid var(--color-override);
            padding: var(--space-xs) var(--space-sm);
            border-radius: var(--radius-sm);
            font-size: 0.7rem;
            font-weight: 600;
            color: var(--color-override);
        }

        /* Strategic Stop Warning */
        .strategic-stop {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.15), rgba(220, 38, 38, 0.15));
            border: 2px solid #ef4444;
            border-radius: var(--radius-lg);
            padding: var(--space-xl);
            margin-bottom: var(--space-xxl);
        }

        .strategic-stop-header {
            font-size: 1.3rem;
            font-weight: 700;
            color: #ef4444;
            display: flex;
            align-items: center;
            gap: var(--space-md);
            margin-bottom: var(--space-lg);
        }

        .strategic-stop-body {
            font-size: 0.95rem;
            color: var(--color-text);
            line-height: 1.6;
            margin-bottom: var(--space-lg);
        }

        .strategic-stop-actions {
            list-style: disc;
            padding-left: var(--space-xl);
            font-size: 0.9rem;
            color: var(--color-text-secondary);
            margin-bottom: var(--space-lg);
        }

        .strategic-stop-pause {
            font-size: 0.85rem;
            color: #fca5a5;
            font-weight: 600;
            margin-bottom: var(--space-lg);
        }

        .strategic-stop-buttons {
            display: flex;
            gap: var(--space-md);
        }

        .strategic-stop-btn-primary {
            background: #ef4444;
            color: #fff;
            padding: var(--space-md) var(--space-xl);
            border: none;
            border-radius: var(--radius-md);
            font-weight: 600;
            cursor: pointer;
        }

        .strategic-stop-btn-secondary {
            background: transparent;
            color: var(--color-text-secondary);
            border: 1px solid var(--color-border);
            padding: var(--space-md) var(--space-xl);
            border-radius: var(--radius-md);
            font-weight: 500;
            cursor: pointer;
        }

        /* Focus Mode */
        .focus-mode-toggle {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            padding: var(--space-sm) var(--space-lg);
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            cursor: pointer;
            font-size: 0.9rem;
            color: var(--color-text-secondary);
            transition: all var(--transition-base);
        }

        .focus-mode-toggle:hover {
            border-color: var(--color-accent);
            color: var(--color-accent);
        }

        .focus-mode-toggle.active {
            background: var(--color-accent-muted);
            border-color: var(--color-accent);
            color: var(--color-accent);
        }

        .view-all-btn {
            background: transparent;
            border: 1px dashed var(--color-border);
            padding: var(--space-md);
            border-radius: var(--radius-md);
            color: var(--color-text-secondary);
            font-size: 0.9rem;
            cursor: pointer;
            text-align: center;
            width: 100%;
            margin-top: var(--space-lg);
            transition: all var(--transition-base);
        }

        .view-all-btn:hover {
            border-color: var(--color-accent);
            color: var(--color-accent);
        }

        /* Confidence Pill */
        .confidence-pill {
            padding: var(--space-xs) 10px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .confidence-pill.high {
            background: rgba(16, 185, 129, 0.15);
            color: var(--color-confidence-high);
        }

        .confidence-pill.medium {
            background: rgba(245, 158, 11, 0.15);
            color: var(--color-confidence-medium);
        }

        .confidence-pill.low {
            background: rgba(239, 68, 68, 0.15);
            color: var(--color-confidence-low);
        }

        /* Card entrance animation */
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .app-card-v2 {
            animation: slideIn 200ms ease-out;
        }

        /* Timeline View */
        .timeline-container {
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-lg);
            padding: var(--space-xl);
            min-height: 400px;
        }

        .timeline-chart-wrapper {
            height: 300px;
            margin-bottom: var(--space-xl);
        }

        .timeline-insights {
            display: flex;
            gap: var(--space-lg);
            justify-content: center;
            margin-bottom: var(--space-lg);
            flex-wrap: wrap;
        }

        .timeline-insight {
            background: var(--color-surface-elevated);
            border: 1px solid var(--color-border);
            padding: var(--space-lg) var(--space-xl);
            border-radius: var(--radius-md);
            text-align: center;
            min-width: 120px;
        }

        .timeline-insight .insight-value {
            display: block;
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--color-accent);
            margin-bottom: var(--space-xs);
        }

        .timeline-insight .insight-label {
            display: block;
            font-size: 0.8rem;
            color: var(--color-text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .timeline-insight-highlight {
            color: var(--color-accent);
            font-weight: 600;
        }

        .timeline-legend {
            display: flex;
            gap: var(--space-xl);
            justify-content: center;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            font-size: 0.85rem;
            color: var(--color-text-secondary);
        }

        .legend-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        .legend-dot.applied { background: #60a5fa; }
        .legend-dot.interview { background: #f59e0b; }
        .legend-dot.offer { background: #10b981; }
        .legend-dot.rejection { background: #ef4444; }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px var(--space-xl);
            background: var(--color-surface);
            border: 1px dashed var(--color-border);
            border-radius: var(--radius-lg);
        }

        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: var(--space-lg);
        }

        .empty-state-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--color-text);
            margin-bottom: var(--space-sm);
        }

        .empty-state-text {
            color: var(--color-text-secondary);
            font-size: 0.95rem;
            margin-bottom: var(--space-xl);
            max-width: 400px;
            margin-left: auto;
            margin-right: auto;
        }

        .empty-state-btn {
            display: inline-block;
            background: var(--color-accent);
            color: #000;
            padding: var(--space-md) var(--space-xl);
            border-radius: var(--radius-md);
            font-weight: 600;
            text-decoration: none;
            transition: all var(--transition-base);
        }

        .empty-state-btn:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }

        /* Error State */
        .error-state {
            text-align: center;
            padding: 40px var(--space-xl);
            background: var(--color-urgent-muted);
            border: 1px solid var(--color-urgent);
            border-radius: var(--radius-lg);
        }

        .error-state-icon {
            font-size: 2.5rem;
            margin-bottom: var(--space-md);
        }

        .error-state-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--color-text);
            margin-bottom: var(--space-sm);
        }

        .error-state-text {
            color: var(--color-text-secondary);
            font-size: 0.9rem;
            margin-bottom: var(--space-lg);
        }

        .error-state-btn {
            background: var(--color-urgent);
            color: #fff;
            padding: var(--space-sm) var(--space-xl);
            border: none;
            border-radius: var(--radius-md);
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition-base);
        }

        .error-state-btn:hover {
            opacity: 0.9;
        }

        /* Loading Skeleton */
        .loading-skeleton {
            padding: var(--space-xl);
        }

        .skeleton-pulse {
            height: 120px;
            background: linear-gradient(90deg, var(--color-surface) 25%, var(--color-surface-elevated) 50%, var(--color-surface) 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
            border-radius: var(--radius-lg);
            margin-bottom: var(--space-xl);
        }

        .skeleton-cards {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: var(--space-lg);
        }

        .skeleton-card {
            height: 200px;
            background: linear-gradient(90deg, var(--color-surface) 25%, var(--color-surface-elevated) 50%, var(--color-surface) 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
            border-radius: var(--radius-lg);
        }

        @keyframes shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        @media (max-width: 768px) {
            .skeleton-cards {
                grid-template-columns: 1fr;
            }
        }

        /* Offline Indicator */
        .offline-indicator {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--color-caution);
            color: #000;
            padding: var(--space-sm) var(--space-lg);
            border-radius: var(--radius-md);
            font-size: 0.85rem;
            font-weight: 600;
            z-index: 1000;
            box-shadow: var(--shadow-md);
            display: flex;
            align-items: center;
            gap: var(--space-sm);
        }

        /* User Override Tooltip */
        .override-badge {
            position: absolute;
            top: var(--space-sm);
            right: var(--space-sm);
            background: var(--color-override-muted);
            border: 1px solid var(--color-override);
            padding: var(--space-xs) var(--space-sm);
            border-radius: var(--radius-sm);
            font-size: 0.7rem;
            font-weight: 600;
            color: var(--color-override);
            cursor: help;
        }

        .override-tooltip {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: var(--space-xs);
            background: var(--color-surface-elevated);
            border: 1px solid var(--color-border);
            padding: var(--space-sm) var(--space-md);
            border-radius: var(--radius-md);
            max-width: 200px;
            font-size: 0.85rem;
            box-shadow: var(--shadow-md);
            z-index: 100;
            opacity: 0;
            visibility: hidden;
            transition: all var(--transition-fast);
        }

        .override-badge:hover + .override-tooltip,
        .override-tooltip:hover {
            opacity: 1;
            visibility: visible;
        }

        .override-tooltip-title {
            font-weight: 600;
            color: var(--color-override);
            margin-bottom: var(--space-xs);
        }

        .override-tooltip-reason {
            color: var(--color-text-secondary);
            line-height: 1.4;
        }

        /* User Override Modal */
        .override-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all var(--transition-base);
        }

        .override-modal.active {
            opacity: 1;
            visibility: visible;
        }

        .override-modal-content {
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-lg);
            padding: var(--space-xl);
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .override-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-lg);
        }

        .override-modal-title {
            font-size: 1.1rem;
            font-weight: 600;
        }

        .override-modal-close {
            background: none;
            border: none;
            color: var(--color-text-secondary);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0;
            line-height: 1;
        }

        .override-form-group {
            margin-bottom: var(--space-lg);
        }

        .override-form-label {
            display: block;
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--color-text-secondary);
            margin-bottom: var(--space-sm);
        }

        .override-form-select,
        .override-form-textarea {
            width: 100%;
            background: var(--color-bg);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            padding: var(--space-md);
            color: var(--color-text);
            font-size: 0.9rem;
        }

        .override-form-textarea {
            min-height: 80px;
            resize: vertical;
        }

        .override-form-select:focus,
        .override-form-textarea:focus {
            outline: none;
            border-color: var(--color-accent);
        }

        .override-modal-actions {
            display: flex;
            gap: var(--space-md);
            justify-content: flex-end;
        }

        .override-btn-cancel {
            background: var(--color-surface-elevated);
            color: var(--color-text);
            border: 1px solid var(--color-border);
            padding: var(--space-sm) var(--space-lg);
            border-radius: var(--radius-md);
            font-weight: 500;
            cursor: pointer;
        }

        .override-btn-save {
            background: var(--color-accent);
            color: #000;
            border: none;
            padding: var(--space-sm) var(--space-lg);
            border-radius: var(--radius-md);
            font-weight: 600;
            cursor: pointer;
        }

        .override-modal-body {
            padding: var(--space-lg) 0;
        }

        .override-modal-current {
            background: var(--color-surface-elevated);
            padding: var(--space-md);
            border-radius: var(--radius-md);
            margin-bottom: var(--space-lg);
            font-size: 0.9rem;
        }

        .override-form {
            display: flex;
            flex-direction: column;
            gap: var(--space-md);
        }

        .override-label {
            font-size: 0.85rem;
            font-weight: 500;
            color: var(--color-text-secondary);
        }

        .override-select {
            width: 100%;
            padding: var(--space-sm) var(--space-md);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            background: var(--color-surface-elevated);
            color: var(--color-text);
            font-size: 0.9rem;
            cursor: pointer;
        }

        .override-select:focus {
            outline: none;
            border-color: var(--color-accent);
        }

        .override-custom-input {
            width: 100%;
            padding: var(--space-sm) var(--space-md);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            background: var(--color-surface-elevated);
            color: var(--color-text);
            font-size: 0.9rem;
        }

        .override-textarea {
            width: 100%;
            min-height: 80px;
            padding: var(--space-sm) var(--space-md);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            background: var(--color-surface-elevated);
            color: var(--color-text);
            font-size: 0.9rem;
            resize: vertical;
        }

        .override-textarea:focus,
        .override-custom-input:focus {
            outline: none;
            border-color: var(--color-accent);
        }

        .override-checkbox-label {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            font-size: 0.85rem;
            color: var(--color-text-secondary);
            cursor: pointer;
        }

        .override-checkbox-label input[type="checkbox"] {
            width: 16px;
            height: 16px;
            accent-color: var(--color-accent);
        }

        /* Keyboard Focus Styles */
        .app-card-v2:focus-visible,
        .pulse-action-btn:focus-visible,
        .one-click-btn:focus-visible,
        .view-selector-btn:focus-visible,
        .focus-mode-toggle:focus-visible {
            outline: 2px solid var(--color-accent);
            outline-offset: 2px;
        }

        /* Skip to content link for accessibility */
        .skip-link {
            position: absolute;
            top: -40px;
            left: 0;
            background: var(--color-accent);
            color: #000;
            padding: var(--space-sm) var(--space-md);
            z-index: 1001;
            transition: top var(--transition-fast);
        }

        .skip-link:focus {
            top: 0;
        }

    </style>
    <link rel="stylesheet" href="css/mobile.css">
    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <!-- Chart.js for Timeline View -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <!-- Command Center Intelligence Module -->
    <script src="js/command-center.js"></script>
    <!-- Beta Access Gate -->
    <script>
        if (localStorage.getItem('beta_verified') !== 'true') {
            window.location.href = 'beta-access.html';
        }
    </script>
</head>
<body>
    <!-- HEADER -->
    <header>
        <div class="header-container">
            <a href="index.html" class="logo"><em>Henry</em>HQ</a>
        </div>
    </header>

    <div class="container">
        <!-- PAGE HEADER -->
        <div class="page-header">
            <div>
                <h1>Pipeline Command Center</h1>
                <p class="subtitle">Your strategic view of every opportunity in play</p>
            </div>
            <div class="header-actions">
                <button class="header-btn primary" onclick="openScheduleInterviewModal()" title="Add an interview you've scheduled">
                    <span>ðŸŽ‰</span> Got an Interview
                </button>
                <button class="header-btn" onclick="exportBackup()" title="Download all your data as a backup file">
                    <span>ðŸ“¥</span> Export Backup
                </button>
                <button class="header-btn" onclick="showImportOptions()" title="Import applications">
                    <span>ðŸ“¤</span> Import
                </button>
                <input type="file" id="importFile" accept=".json,.csv,.xlsx,.xls" style="display: none;" onchange="handleImport(event)">
                <input type="file" id="screenshotFile" accept="image/*" style="display: none;" onchange="handleScreenshotImport(event)">
            </div>
        </div>

        <!-- PIPELINE INTELLIGENCE DASHBOARD -->
        <div class="pipeline-dashboard" id="pipelineDashboard">
            <div class="metric-card">
                <div class="metric-value green" id="metricActive">0</div>
                <div class="metric-label">Active</div>
            </div>
            <div class="metric-card">
                <div class="metric-value" id="metricMomentum">--</div>
                <div class="metric-label">Momentum</div>
                <div class="metric-sublabel" id="metricMomentumDetail">High: 0 | Med: 0</div>
            </div>
            <div class="metric-card highlight">
                <div class="metric-value gold" id="metricLeverage">--</div>
                <div class="metric-label">Leverage</div>
            </div>
            <div class="metric-card">
                <div class="metric-value blue" id="metricTimeToScreen">--</div>
                <div class="metric-label">Avg Time to Screen</div>
            </div>
            <div class="metric-card">
                <div class="metric-value green" id="metricConversion">0%</div>
                <div class="metric-label">Interview Rate</div>
            </div>
            <div class="metric-card">
                <div class="metric-value gray" id="metricGhost">0%</div>
                <div class="metric-label">Ghost Rate</div>
            </div>
        </div>

        <!-- COMMAND CENTER: STRATEGIC STOP WARNING (conditionally shown) -->
        <div class="strategic-stop" id="strategicStopBanner" style="display: none;">
            <div class="strategic-stop-header">
                <span>â›”</span> Strategic Stop Triggered
            </div>
            <div class="strategic-stop-body" id="strategicStopReason">
                <!-- Dynamically populated -->
            </div>
            <div class="strategic-stop-actions" id="strategicStopActions">
                <!-- Dynamically populated -->
            </div>
            <div class="strategic-stop-pause" id="strategicStopPause"></div>
            <div class="strategic-stop-buttons">
                <button class="strategic-stop-btn-primary" onclick="navigateToStrategy()">Review Strategy</button>
                <button class="strategic-stop-btn-secondary" onclick="overrideStrategicStop()">Override (not recommended)</button>
            </div>
        </div>

        <!-- COMMAND CENTER: DAILY PULSE BANNER -->
        <div class="daily-pulse-v2" id="dailyPulseV2" style="display: none;">
            <div class="pulse-greeting-v2" id="pulseGreetingV2">Good morning! Here's what matters today:</div>

            <div class="pulse-actions-row" id="pulseActionsRow">
                <!-- Dynamically populated with priority action cards -->
            </div>

            <div class="pulse-health" id="pulseHealthStatus">
                <span id="pulseHealthIcon">âœ…</span>
                <span>Pipeline Health: <strong id="pulseHealthLabel">Healthy</strong></span>
                <span class="pulse-health-reason" id="pulseHealthReason"></span>
            </div>
        </div>

        <!-- COMMAND CENTER: VIEW SELECTOR -->
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
            <div class="view-selector" id="commandCenterViewSelector">
                <button class="view-selector-btn active" data-view="board" onclick="setCommandCenterView('board')">Board</button>
                <button class="view-selector-btn" data-view="list" onclick="setCommandCenterView('list')">List</button>
                <button class="view-selector-btn" data-view="timeline" onclick="setCommandCenterView('timeline')">Timeline</button>
            </div>

            <button class="focus-mode-toggle" id="focusModeToggle" onclick="toggleFocusMode()">
                <span>ðŸŽ¯</span> Focus Mode
            </button>
        </div>

        <!-- COMMAND CENTER: BOARD VIEW -->
        <div class="board-container" id="boardViewContainer" style="display: none;">
            <div class="board-column" data-status="applied">
                <div class="board-column-header">
                    <span class="board-column-title">Applied</span>
                    <span class="board-column-count" id="boardCountApplied">0</span>
                </div>
                <div class="board-cards" id="boardCardsApplied">
                    <!-- Dynamically populated -->
                </div>
            </div>
            <div class="board-column" data-status="screening">
                <div class="board-column-header">
                    <span class="board-column-title">Screening</span>
                    <span class="board-column-count" id="boardCountScreening">0</span>
                </div>
                <div class="board-cards" id="boardCardsScreening">
                    <!-- Dynamically populated -->
                </div>
            </div>
            <div class="board-column" data-status="interviewing">
                <div class="board-column-header">
                    <span class="board-column-title">Interviews</span>
                    <span class="board-column-count" id="boardCountInterviewing">0</span>
                </div>
                <div class="board-cards" id="boardCardsInterviewing">
                    <!-- Dynamically populated -->
                </div>
            </div>
            <div class="board-column" data-status="final">
                <div class="board-column-header">
                    <span class="board-column-title">Final</span>
                    <span class="board-column-count" id="boardCountFinal">0</span>
                </div>
                <div class="board-cards" id="boardCardsFinal">
                    <!-- Dynamically populated -->
                </div>
            </div>
        </div>

        <!-- COMMAND CENTER: TIMELINE VIEW -->
        <div class="timeline-container" id="timelineViewContainer" style="display: none;">
            <div class="timeline-chart-wrapper">
                <canvas id="timelineChart"></canvas>
            </div>
            <div class="timeline-insights" id="timelineInsights">
                <!-- Dynamically populated with insights -->
            </div>
            <div class="timeline-legend">
                <span class="legend-item"><span class="legend-dot applied"></span> Applied</span>
                <span class="legend-item"><span class="legend-dot interview"></span> Interview</span>
                <span class="legend-item"><span class="legend-dot offer"></span> Offer</span>
                <span class="legend-item"><span class="legend-dot rejection"></span> Rejection</span>
            </div>
        </div>

        <!-- COMMAND CENTER: EMPTY STATE -->
        <div class="empty-state" id="emptyState" style="display: none;">
            <div class="empty-state-icon">ðŸ“‹</div>
            <h3 class="empty-state-title">No applications yet</h3>
            <p class="empty-state-text">Start tracking your job applications to see your pipeline intelligence here.</p>
            <a href="analyze.html" class="empty-state-btn">Analyze a Job</a>
        </div>

        <!-- COMMAND CENTER: ERROR STATE -->
        <div class="error-state" id="errorState" style="display: none;">
            <div class="error-state-icon">âš ï¸</div>
            <h3 class="error-state-title">Unable to load intelligence</h3>
            <p class="error-state-text" id="errorStateText">Check your connection and try again.</p>
            <button class="error-state-btn" onclick="retryLoadIntelligence()">Retry</button>
        </div>

        <!-- COMMAND CENTER: LOADING SKELETON -->
        <div class="loading-skeleton" id="loadingSkeleton" style="display: none;">
            <div class="skeleton-pulse"></div>
            <div class="skeleton-cards">
                <div class="skeleton-card"></div>
                <div class="skeleton-card"></div>
                <div class="skeleton-card"></div>
                <div class="skeleton-card"></div>
            </div>
        </div>

        <!-- COMMAND CENTER: OFFLINE INDICATOR -->
        <div class="offline-indicator" id="offlineIndicator" style="display: none;">
            <span>ðŸ“¡</span> You're offline. Showing cached data.
        </div>

        <!-- COMMAND CENTER: USER OVERRIDE MODAL -->
        <div class="override-modal" id="overrideModal">
            <div class="override-modal-content">
                <div class="override-modal-header">
                    <span class="override-modal-title">Override System Recommendation</span>
                    <button class="override-modal-close" onclick="closeOverrideModal()">&times;</button>
                </div>
                <div class="override-modal-body">
                    <div class="override-modal-current">
                        <strong>System Suggests:</strong>
                        <span id="overrideCurrentAction">-</span>
                    </div>
                    <div class="override-form">
                        <label class="override-label">Select your action:</label>
                        <select class="override-select" id="overrideActionSelect">
                            <option value="">-- Choose action --</option>
                            <option value="wait">Wait (I have inside info)</option>
                            <option value="follow_up">Follow up now</option>
                            <option value="archive">Archive this application</option>
                            <option value="keep_active">Keep as active</option>
                            <option value="custom">Custom action...</option>
                        </select>
                        <div class="override-custom-action" id="overrideCustomWrapper" style="display: none;">
                            <input type="text" class="override-custom-input" id="overrideCustomAction" placeholder="Enter your custom action...">
                        </div>
                        <label class="override-label">Reason (optional):</label>
                        <textarea class="override-textarea" id="overrideReason" placeholder="Why are you overriding? (e.g., Spoke to recruiter, they said 2 more weeks)"></textarea>
                        <label class="override-checkbox-label">
                            <input type="checkbox" id="overrideLock">
                            Lock this (prevent system from changing until I update)
                        </label>
                    </div>
                </div>
                <div class="override-modal-actions">
                    <button class="btn-secondary" onclick="closeOverrideModal()">Cancel</button>
                    <button class="btn-primary" onclick="saveUserOverride()">Save Override</button>
                </div>
            </div>
        </div>

        <!-- VIEW TOGGLE (Legacy) -->
        <div class="view-toggle-container" id="viewToggleContainer" style="display: none;">
            <div class="view-toggle">
                <button class="view-toggle-btn active" data-view="priorities" onclick="switchView('priorities')">Priorities</button>
                <button class="view-toggle-btn" data-view="details" onclick="switchView('details')">All Applications</button>
            </div>
        </div>

        <!-- PRIORITIES VIEW -->
        <div class="view-section active" id="prioritiesView">
            <div class="strategic-priorities" id="strategicPriorities" style="display: none;">
                <div class="priorities-header">
                    <div class="priorities-title">
                        <span>ðŸŽ¯</span> Strategic Priorities
                    </div>
                </div>
                <div id="prioritiesContent">
                    <!-- Dynamically populated -->
                </div>
            </div>
        </div>

        <!-- DETAILS VIEW -->
        <div class="view-section" id="detailsView">
            <!-- FILTERS BAR -->
            <div class="filters-bar" id="filtersBar" style="display: none;">
            <div class="filter-group">
                <span class="filter-label">Status:</span>
                <select class="filter-select" id="filterStatus">
                    <option value="all">All</option>
                    <option value="active">Active Only</option>
                    <option value="hot">ðŸ”¥ Hot</option>
                    <option value="interviewing">Interviewing</option>
                    <option value="waiting">Waiting</option>
                    <option value="stale">Stale</option>
                </select>
            </div>
            <div class="filter-group">
                <span class="filter-label">Fit:</span>
                <select class="filter-select" id="filterFit">
                    <option value="all">All</option>
                    <option value="high">80%+ Strong</option>
                    <option value="medium">60-79%</option>
                    <option value="low">Below 60%</option>
                </select>
            </div>
            <div class="filter-group">
                <span class="filter-label">Sort:</span>
                <select class="filter-select" id="sortBy">
                    <option value="urgency">Urgency</option>
                    <option value="fit">Fit Score</option>
                    <option value="recent">Most Recent</option>
                    <option value="timeline">Timeline</option>
                </select>
            </div>
            <div class="filter-group view-mode-toggle">
                <button class="view-mode-btn active" id="tableViewBtn" onclick="setViewMode('table')">
                    <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor"><path d="M0 2a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V2zm15 2h-4v3h4V4zm0 4h-4v3h4V8zm0 4h-4v3h3a1 1 0 0 0 1-1v-2zm-5 3v-3H6v3h4zm-5 0v-3H1v2a1 1 0 0 0 1 1h3zm-4-4h4V8H1v3zm0-4h4V4H1v3zm5-3v3h4V4H6zm4 4H6v3h4V8z"/></svg>
                    Summary
                </button>
                <button class="view-mode-btn" id="cardViewBtn" onclick="setViewMode('cards')">
                    <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor"><path d="M1 2.5A1.5 1.5 0 0 1 2.5 1h3A1.5 1.5 0 0 1 7 2.5v3A1.5 1.5 0 0 1 5.5 7h-3A1.5 1.5 0 0 1 1 5.5v-3zm8 0A1.5 1.5 0 0 1 10.5 1h3A1.5 1.5 0 0 1 15 2.5v3A1.5 1.5 0 0 1 13.5 7h-3A1.5 1.5 0 0 1 9 5.5v-3zm-8 8A1.5 1.5 0 0 1 2.5 9h3A1.5 1.5 0 0 1 7 10.5v3A1.5 1.5 0 0 1 5.5 15h-3A1.5 1.5 0 0 1 1 13.5v-3zm8 0A1.5 1.5 0 0 1 10.5 9h3a1.5 1.5 0 0 1 1.5 1.5v3a1.5 1.5 0 0 1-1.5 1.5h-3A1.5 1.5 0 0 1 9 13.5v-3z"/></svg>
                    Detailed
                </button>
            </div>
        </div>

        <!-- BULK ACTIONS BAR -->
        <div class="bulk-actions-bar" id="bulkActionsBar" style="display: none;">
            <div class="bulk-actions-left">
                <input type="checkbox" id="selectAllCheckbox" onclick="toggleSelectAll()">
                <label for="selectAllCheckbox">Select All Visible</label>
                <span class="selected-count" id="selectedCount">0 selected</span>
            </div>
            <div class="bulk-actions-right">
                <button class="bulk-action-btn archive" onclick="bulkArchive()">ðŸ“¦ Archive</button>
                <button class="bulk-action-btn delete" onclick="bulkDelete()">ðŸ—‘ï¸ Delete</button>
                <button class="bulk-action-btn cancel" onclick="exitBulkSelectMode()">Cancel</button>
            </div>
        </div>

        <!-- TABLE VIEW (default) -->
        <div id="tableViewContainer" class="table-view-container">
            <table class="applications-table" id="applicationsTable">
                <thead>
                    <tr>
                        <th class="col-checkbox"><input type="checkbox" id="tableSelectAll" onclick="toggleSelectAll()"></th>
                        <th class="col-company">Company</th>
                        <th class="col-role">Role</th>
                        <th class="col-status">Status</th>
                        <th class="col-fit">Fit</th>
                        <th class="col-stage">Stage</th>
                        <th class="col-days">Days</th>
                        <th class="col-action">Next Action</th>
                        <th class="col-actions"></th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                    <!-- Populated by JS -->
                </tbody>
            </table>
        </div>

        <!-- CARD VIEW (legacy) -->
        <div id="applicationsContainer" style="display: none;">
            <!-- Dynamically populated -->
        </div>

        <!-- ANALYZE NEW ROLE BUTTON -->
        <div class="bottom-cta">
            <a href="analyze.html" class="analyze-btn">Analyze New Role</a>
        </div>
        </div>

    <!-- ARCHIVE MODAL -->
    <!-- IMPORT OPTIONS MODAL -->
    <div class="modal-overlay" id="importOptionsModal">
        <div class="modal" style="max-width: 500px;">
            <h2>ðŸ“¤ Import Applications</h2>
            <p style="color: var(--color-text-muted);">Choose how you'd like to import your applications</p>

            <div style="margin-top: 24px; display: flex; flex-direction: column; gap: 12px;">
                <button class="import-option-btn" onclick="closeImportOptions(); document.getElementById('screenshotFile').click();">
                    <span class="import-option-icon">ðŸ“¸</span>
                    <div class="import-option-text">
                        <strong>From Screenshot</strong>
                        <span>Screenshot your Greenhouse, Lever, or any ATS job list</span>
                    </div>
                </button>

                <button class="import-option-btn" onclick="closeImportOptions(); document.getElementById('importFile').click();">
                    <span class="import-option-icon">ðŸ“„</span>
                    <div class="import-option-text">
                        <strong>From File</strong>
                        <span>Import from CSV, Excel, or JSON backup</span>
                    </div>
                </button>

                <button class="import-option-btn" onclick="closeImportOptions(); showManualAddModal();">
                    <span class="import-option-icon">âœï¸</span>
                    <div class="import-option-text">
                        <strong>Add Manually</strong>
                        <span>Enter job details by hand</span>
                    </div>
                </button>
            </div>

            <div class="modal-actions" style="margin-top: 24px;">
                <button class="modal-btn secondary" onclick="closeImportOptions()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- SCREENSHOT IMPORT MODAL -->
    <div class="modal-overlay" id="screenshotImportModal">
        <div class="modal" style="max-width: 700px;">
            <h2>ðŸ“¸ Import from Screenshot</h2>
            <p style="color: var(--color-text-muted);">Upload a screenshot of your job applications from Greenhouse, Lever, Workday, or any other ATS</p>

            <!-- Upload Area -->
            <div id="screenshotUploadArea" class="screenshot-upload-area">
                <div class="screenshot-upload-content">
                    <span style="font-size: 3rem;">ðŸ“·</span>
                    <p style="margin-top: 12px;"><strong>Drop screenshot here</strong></p>
                    <p style="color: var(--color-text-muted); font-size: 0.9rem;">or click to select, or paste (Ctrl/Cmd+V)</p>
                </div>
                <img id="screenshotPreview" style="display: none; max-width: 100%; max-height: 300px; border-radius: 8px;">
            </div>

            <!-- Processing State -->
            <div id="screenshotProcessing" style="display: none; text-align: center; padding: 40px;">
                <div class="processing-spinner"></div>
                <p style="margin-top: 16px;">Analyzing screenshot with AI...</p>
                <p style="color: var(--color-text-muted); font-size: 0.85rem;">Extracting job titles, companies, and dates</p>
            </div>

            <!-- Results -->
            <div id="screenshotResults" style="display: none;">
                <h3 style="margin-bottom: 12px;">Found <span id="extractedJobCount">0</span> applications</h3>
                <p style="color: var(--color-text-muted); font-size: 0.9rem; margin-bottom: 16px;">Select which ones to import and fill in any missing details</p>

                <div id="extractedJobsList" style="max-height: 400px; overflow-y: auto;">
                    <!-- Dynamically populated -->
                </div>
            </div>

            <div class="modal-actions" style="margin-top: 20px;">
                <button class="modal-btn secondary" onclick="closeScreenshotImport()">Cancel</button>
                <button class="modal-btn primary" id="importSelectedBtn" style="display: none;" onclick="importSelectedJobs()">
                    Import Selected
                </button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="archiveModal">
        <div class="modal">
            <h2>ðŸ“¦ Archive this application?</h2>
            <p>This will move the role out of your active pipeline but <strong>preserve all data</strong> for future reference and coaching insights.</p>
            <div style="margin-top: 16px;">
                <label style="display: block; margin-bottom: 8px; color: var(--color-text-muted);">Why are you archiving this role?</label>
                <select id="archiveReason" style="width: 100%; padding: 10px; background: var(--color-surface); border: 1px solid var(--color-border); border-radius: 8px; color: var(--color-text);">
                    <option value="">Select a reason...</option>
                    <option value="no_response">No response from company</option>
                    <option value="rejected">Received rejection</option>
                    <option value="withdrew">I withdrew my application</option>
                    <option value="found_role">Accepted another role</option>
                    <option value="not_interested">No longer interested</option>
                    <option value="role_closed">Role was closed/filled</option>
                    <option value="other">Other reason</option>
                </select>
            </div>
            <div class="modal-actions" style="margin-top: 20px;">
                <button class="modal-btn secondary" onclick="closeArchiveModal()">Cancel</button>
                <button class="modal-btn primary" id="confirmArchiveBtn">Archive Role</button>
            </div>
        </div>
    </div>

    <!-- DELETE MODAL (for archived apps only) -->
    <div class="modal-overlay" id="deleteModal">
        <div class="modal">
            <h2>âš ï¸ Permanently Delete?</h2>
            <p>This will <strong>permanently remove</strong> this role and all its data. This cannot be undone.</p>
            <p style="color: var(--color-text-muted); font-size: 0.9rem; margin-top: 8px;">Archived data helps track patterns and improve coaching. Are you sure you want to delete?</p>

            <div style="margin-top: 16px;">
                <label style="display: block; margin-bottom: 8px; color: var(--color-text-muted);">Why are you deleting this data?</label>
                <select id="deleteReason" style="width: 100%; padding: 10px; background: var(--color-surface); border: 1px solid var(--color-border); border-radius: 8px; color: var(--color-text);">
                    <option value="">Select a reason...</option>
                    <option value="duplicate">Duplicate entry</option>
                    <option value="test">Test/practice entry</option>
                    <option value="wrong_data">Wrong data entered</option>
                    <option value="privacy">Privacy reasons</option>
                    <option value="other">Other</option>
                </select>
            </div>

            <div style="margin-top: 16px;">
                <label style="display: block; margin-bottom: 8px; color: var(--color-text-muted);">Type DELETE to confirm:</label>
                <input type="text" id="deleteConfirmInput" placeholder="Type DELETE here" style="width: 100%; padding: 10px; background: var(--color-surface); border: 1px solid var(--color-border); border-radius: 8px; color: var(--color-text);">
            </div>

            <div class="modal-actions" style="margin-top: 20px;">
                <button class="modal-btn secondary" onclick="closeDeleteModal()">Cancel</button>
                <button class="modal-btn danger" id="confirmDeleteBtn" disabled>Delete Permanently</button>
            </div>
        </div>
    </div>

    <!-- REACH OUT MODAL -->
    <div class="modal-overlay" id="reachOutModal">
        <div class="modal" style="max-width: 600px;">
            <h2>ðŸ’¬ Reach Out</h2>
            <p id="reachOutDescription">Select who you're reaching out to and get a personalized message template.</p>

            <!-- Step 1: Select Contact Type -->
            <div id="reachOutStep1">
                <div style="margin-top: 20px;">
                    <label style="display: block; margin-bottom: 12px; color: var(--color-text-muted);">Who are you contacting?</label>
                    <div style="display: flex; flex-direction: column; gap: 10px;">
                        <button class="reach-out-option" onclick="selectReachOutType('hiring_manager')">
                            <span class="reach-out-icon">ðŸ‘”</span>
                            <div class="reach-out-option-text">
                                <strong>Hiring Manager</strong>
                                <span>Direct message to the person who would be your boss</span>
                            </div>
                        </button>
                        <button class="reach-out-option" onclick="selectReachOutType('recruiter')">
                            <span class="reach-out-icon">ðŸ“ž</span>
                            <div class="reach-out-option-text">
                                <strong>Recruiter</strong>
                                <span>Message to internal or external recruiter</span>
                            </div>
                        </button>
                        <button class="reach-out-option" onclick="selectReachOutType('other')">
                            <span class="reach-out-icon">ðŸ¤</span>
                            <div class="reach-out-option-text">
                                <strong>Other Contact</strong>
                                <span>Someone at the company who can refer or introduce you</span>
                            </div>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Step 2: Custom Contact Info (for 'other' type) -->
            <div id="reachOutStep2" style="display: none;">
                <div style="margin-top: 16px;">
                    <label style="display: block; margin-bottom: 8px;">Contact's Name</label>
                    <input type="text" id="reachOutContactName" placeholder="e.g., Sarah Johnson"
                        style="width: 100%; padding: 10px; background: var(--color-surface); border: 1px solid var(--color-border); border-radius: 8px; color: var(--color-text);">
                </div>
                <div style="margin-top: 12px;">
                    <label style="display: block; margin-bottom: 8px;">Their Role/Connection</label>
                    <input type="text" id="reachOutContactRole" placeholder="e.g., Senior Engineer, Former colleague"
                        style="width: 100%; padding: 10px; background: var(--color-surface); border: 1px solid var(--color-border); border-radius: 8px; color: var(--color-text);">
                </div>
                <div style="margin-top: 16px; display: flex; gap: 12px;">
                    <button class="modal-btn secondary" onclick="showReachOutStep1()">â† Back</button>
                    <button class="modal-btn primary" onclick="generateCustomMessage()">Generate Message</button>
                </div>
            </div>

            <!-- Step 3: Message Display -->
            <div id="reachOutStep3" style="display: none;">
                <div style="margin-top: 16px;">
                    <label style="display: block; margin-bottom: 8px;">
                        <span id="reachOutMessageLabel">Message Template</span>
                        <span style="color: var(--color-text-muted); font-size: 0.85rem;"> (edit as needed)</span>
                    </label>
                    <textarea id="reachOutMessage" style="width: 100%; min-height: 200px; padding: 12px; background: var(--color-surface); border: 1px solid var(--color-border); border-radius: 8px; color: var(--color-text); font-size: 0.95rem; line-height: 1.5; resize: vertical;"></textarea>
                </div>
                <div style="margin-top: 16px; display: flex; gap: 12px; justify-content: space-between;">
                    <button class="modal-btn secondary" onclick="showReachOutStep1()">â† Back</button>
                    <div style="display: flex; gap: 12px;">
                        <button class="modal-btn primary" onclick="copyReachOutMessage()">ðŸ“‹ Copy to Clipboard</button>
                        <button class="modal-btn" onclick="markReachOutComplete()">âœ“ Done</button>
                    </div>
                </div>
            </div>

            <div class="modal-actions" style="margin-top: 20px; border-top: 1px solid var(--color-border); padding-top: 16px;">
                <button class="modal-btn secondary" onclick="closeReachOutModal()">Close</button>
            </div>
        </div>
    </div>

    <!-- DESPERATION INTERVENTION MODAL -->
    <div class="modal-overlay" id="interventionModal">
        <div class="modal intervention-modal" id="interventionContent">
            <!-- Dynamically populated -->
        </div>
    </div>

    <!-- DATE EDIT MODAL -->
    <div class="modal-overlay" id="dateEditModal">
        <div class="modal date-edit-modal">
            <h2><span>ðŸ“…</span> Edit Timeline</h2>
            <p id="dateEditDescription">Update the dates for this application to ensure accurate tracking and recommendations.</p>

            <div id="dateEditContent">
                <!-- Dynamically populated -->
            </div>

            <div class="modal-actions">
                <button class="modal-btn secondary" onclick="closeDateEditModal()">Cancel</button>
                <button class="modal-btn primary" onclick="saveDateEdits()">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- SCHEDULE INTERVIEW MODAL -->
    <div class="modal-overlay" id="scheduleInterviewModal">
        <div class="modal" style="max-width: 500px;">
            <h2><span>ðŸŽ‰</span> Add Interview</h2>
            <p style="color: var(--color-text-secondary); margin-bottom: 20px;">Track an interview you've scheduled for an existing application, or add a new one.</p>

            <div id="scheduleInterviewContent">
                <!-- Application selector -->
                <div style="margin-bottom: 20px;">
                    <label style="display: block; color: var(--color-text-secondary); font-size: 0.9rem; margin-bottom: 8px;">Select Application</label>
                    <select id="interviewAppSelect" style="width: 100%; padding: 12px; background: var(--color-bg); border: 1px solid var(--color-border); border-radius: 8px; color: var(--color-text); font-size: 0.95rem;">
                        <option value="">-- Select an application --</option>
                        <!-- Dynamically populated -->
                    </select>
                </div>

                <div style="text-align: center; color: var(--color-text-muted); margin: 16px 0;">or</div>

                <div style="text-align: center;">
                    <button class="modal-btn" onclick="createNewInterview()" style="background: transparent; border: 1px solid var(--color-accent); color: var(--color-accent);">
                        + Add New Interview Manually
                    </button>
                </div>
            </div>

            <div class="modal-actions" style="margin-top: 24px;">
                <button class="modal-btn secondary" onclick="closeScheduleInterviewModal()">Cancel</button>
                <button class="modal-btn primary" onclick="proceedToInterviewIntelligence()" id="proceedInterviewBtn" disabled>Continue to Schedule</button>
            </div>
        </div>
    </div>

    <!-- JOB DESCRIPTION MODAL -->
    <div class="modal-overlay" id="jobDescriptionModal">
        <div class="modal" style="max-width: 700px; max-height: 80vh; display: flex; flex-direction: column;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                <h2 id="jobDescriptionTitle" style="margin: 0;">ðŸ“„ Job Description</h2>
                <button onclick="closeJobDescriptionModal()" style="background: none; border: none; color: var(--color-text-muted); font-size: 1.5rem; cursor: pointer;">&times;</button>
            </div>
            <div id="jobDescriptionContent" style="flex: 1; overflow-y: auto; background: var(--color-bg); border-radius: 8px; padding: 20px;">
                <!-- JD content will be inserted here -->
            </div>
            <div class="modal-actions" style="margin-top: 16px;">
                <button class="modal-btn secondary" onclick="closeJobDescriptionModal()">Close</button>
            </div>
        </div>
    </div>

    <!-- REJECTION MODAL -->
    <div class="modal-overlay" id="rejectModal">
        <div class="modal" style="max-width: 500px;">
            <h2><span>âŒ</span> Mark as Rejected</h2>
            <p style="color: var(--color-text-secondary); margin-bottom: 20px;">Understanding what happened helps improve your strategy.</p>

            <div id="rejectContent">
                <div style="margin-bottom: 20px;">
                    <label style="display: block; color: var(--color-text-secondary); font-size: 0.9rem; margin-bottom: 8px;">When were you rejected?</label>
                    <select id="rejectStage" style="width: 100%; padding: 12px; background: var(--color-bg); border: 1px solid var(--color-border); border-radius: 8px; color: var(--color-text); font-size: 0.95rem;">
                        <option value="pre-screen">Before any interviews (auto-rejection)</option>
                        <option value="after-screen">After recruiter screen</option>
                        <option value="after-hiring-manager">After hiring manager interview</option>
                        <option value="after-technical">After technical round</option>
                        <option value="after-final">After final round</option>
                        <option value="no-response">Never heard back (ghosted)</option>
                    </select>
                </div>

                <div style="margin-bottom: 20px;">
                    <label style="display: block; color: var(--color-text-secondary); font-size: 0.9rem; margin-bottom: 8px;">Did they give any feedback?</label>
                    <textarea id="rejectFeedback" placeholder="What feedback did you receive, if any?" style="width: 100%; min-height: 80px; padding: 12px; background: var(--color-bg); border: 1px solid var(--color-border); border-radius: 8px; color: var(--color-text); font-size: 0.95rem; resize: vertical;"></textarea>
                </div>
            </div>

            <div class="modal-actions" style="margin-top: 24px;">
                <button class="modal-btn secondary" onclick="closeRejectModal()">Cancel</button>
                <button class="modal-btn primary" onclick="confirmRejection()" style="background: #ef4444;">Mark Rejected</button>
            </div>
        </div>
    </div>

    <!-- REJECTION DEBRIEF MODAL -->
    <div class="modal-overlay" id="rejectionDebriefModal">
        <div class="modal" style="max-width: 600px; max-height: 80vh; display: flex; flex-direction: column;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                <h2 id="debriefTitle" style="margin: 0;">ðŸ“‹ Rejection Debrief</h2>
                <button onclick="closeRejectionDebriefModal()" style="background: none; border: none; color: var(--color-text-muted); font-size: 1.5rem; cursor: pointer;">&times;</button>
            </div>
            <div id="debriefContent" style="flex: 1; overflow-y: auto;">
                <!-- Debrief content will be inserted here -->
            </div>
            <div class="modal-actions" style="margin-top: 16px;">
                <button class="modal-btn secondary" onclick="closeRejectionDebriefModal()">Close</button>
            </div>
        </div>
    </div>

    <script>
        // ========================================================================
        // STATUS DEFINITIONS WITH STAGE WEIGHTS
        // Organized by category for cleaner dropdown display
        // ========================================================================

        // Status categories for grouped dropdown with visual prefixes
        const STATUS_CATEGORIES = {
            'ðŸ“‹ Application': ['Preparing', 'Applied', 'Networking'],
            'ðŸ“ž Screening': ['Recruiter Screen', 'Awaiting Screen Result'],
            'ðŸŽ¯ Interview': ['Hiring Manager', 'Technical Round', 'Panel Interview', 'Final Round', 'Executive Interview', 'Awaiting Decision'],
            'âœ… Outcome': ['Offer Received', 'Negotiating', 'Accepted'],
            'âŒ Closed': ['Rejected: No Fit', 'Rejected: Experience Gap', 'Rejected: Culture Fit', 'Rejected: Went Internal', 'Rejected: Other', 'Withdrawn', 'No Response', 'Ghosted']
        };

        const STATUSES = {
            // Application Stage (stage: 0)
            'Preparing': { label: 'ðŸ“  Preparing', active: true, stage: 0, stageWeight: 5, awaiting: false, category: 'Application' },
            'Applied': { label: 'ðŸ“¤  Applied', active: true, stage: 1, stageWeight: 15, awaiting: true, category: 'Application' },
            'Networking': { label: 'ðŸ¤  Networking', active: true, stage: 1, stageWeight: 20, awaiting: false, category: 'Application' },

            // Screening Stage (stage: 2)
            'Recruiter Screen': { label: 'ðŸ“ž  Recruiter Screen', active: true, stage: 2, stageWeight: 30, awaiting: false, category: 'Screening' },
            'Awaiting Screen Result': { label: 'â³  Awaiting Screen Result', active: true, stage: 2, stageWeight: 28, awaiting: true, category: 'Screening' },

            // Interview Stage (stage: 3-4)
            'Hiring Manager': { label: 'ðŸ‘”  Hiring Manager', active: true, stage: 3, stageWeight: 40, awaiting: false, category: 'Interview' },
            'Technical Round': { label: 'ðŸ’»  Technical Round', active: true, stage: 3, stageWeight: 45, awaiting: false, category: 'Interview' },
            'Panel Interview': { label: 'ðŸ‘¥  Panel Interview', active: true, stage: 3, stageWeight: 50, awaiting: false, category: 'Interview' },
            'Final Round': { label: 'ðŸ  Final Round', active: true, stage: 4, stageWeight: 55, awaiting: false, category: 'Interview' },
            'Executive Interview': { label: 'ðŸŽ–ï¸  Executive Interview', active: true, stage: 4, stageWeight: 60, awaiting: false, category: 'Interview' },
            'Awaiting Decision': { label: 'â³  Awaiting Decision', active: true, stage: 4, stageWeight: 58, awaiting: true, category: 'Interview' },

            // Positive Outcome Stage (stage: 5)
            'Offer Received': { label: 'ðŸŽ‰  Offer Received', active: true, stage: 5, stageWeight: 70, awaiting: false, category: 'Outcome' },
            'Negotiating': { label: 'ðŸ’°  Negotiating', active: true, stage: 5, stageWeight: 72, awaiting: false, category: 'Outcome' },
            'Accepted': { label: 'ðŸ†  Accepted', active: false, stage: 5, stageWeight: 80, awaiting: false, category: 'Outcome' },

            // Closed Stage - Rejection reasons for coaching insights
            'Rejected: No Fit': { label: 'âŒ  No Fit', active: false, stage: -1, stageWeight: 0, awaiting: false, category: 'Closed', coachingArea: 'targeting' },
            'Rejected: Experience Gap': { label: 'âŒ  Experience Gap', active: false, stage: -1, stageWeight: 0, awaiting: false, category: 'Closed', coachingArea: 'skills' },
            'Rejected: Culture Fit': { label: 'âŒ  Culture Fit', active: false, stage: -1, stageWeight: 0, awaiting: false, category: 'Closed', coachingArea: 'interview' },
            'Rejected: Went Internal': { label: 'âŒ  Went Internal', active: false, stage: -1, stageWeight: 0, awaiting: false, category: 'Closed', coachingArea: 'none' },
            'Rejected: Other': { label: 'âŒ  Other', active: false, stage: -1, stageWeight: 0, awaiting: false, category: 'Closed', coachingArea: 'unknown' },
            'Withdrawn': { label: 'ðŸšª  Withdrawn', active: false, stage: -1, stageWeight: 0, awaiting: false, category: 'Closed' },
            'No Response': { label: 'ðŸ“­  No Response', active: false, stage: -1, stageWeight: 0, awaiting: false, category: 'Closed', coachingArea: 'outreach' },
            'Ghosted': { label: 'ðŸ‘»  Ghosted', active: false, stage: -1, stageWeight: 0, awaiting: false, category: 'Closed', coachingArea: 'follow-up' }
        };

        // Interview stages for timeline
        const INTERVIEW_STAGES = ['Applied', 'Screen', 'Interview', 'Final', 'Offer'];

        // Legacy status mapping for existing data migration
        const LEGACY_STATUS_MAP = {
            'To Apply': 'Preparing',
            'Reached Out': 'Networking',
            'Response Received': 'Recruiter Screen',
            'Awaiting Screen': 'Awaiting Screen Result',
            'Awaiting Next Round': 'Awaiting Decision',
            'Interviewed': 'Awaiting Decision',
            'Rejected': 'Rejected: Other'  // Map old generic Rejected to new specific one
        };

        // ========================================================================
        // STATE
        // ========================================================================
        let currentStatusFilter = 'all';
        let currentFitFilter = 'all';
        let currentSort = 'urgency';

        // ========================================================================
        // HELPER FUNCTIONS
        // ========================================================================

        // Check if a status is a rejection status (any of the rejection subcategories)
        function isRejectedStatus(status) {
            return status && status.startsWith('Rejected:');
        }

        // Check if a status is any closed/negative outcome
        function isClosedStatus(status) {
            return isRejectedStatus(status) || ['Withdrawn', 'No Response', 'Ghosted'].includes(status);
        }

        function getDaysSince(dateString) {
            if (!dateString) return 0;
            // Parse as local date to avoid timezone issues
            const datePart = dateString.includes('T') ? dateString.split('T')[0] : dateString;
            const [year, month, day] = datePart.split('-').map(Number);
            const date = new Date(year, month - 1, day, 12, 0, 0);
            const now = new Date();
            // Set "now" to noon as well for consistent comparison
            const todayNoon = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 12, 0, 0);
            return Math.floor((todayNoon - date) / (1000 * 60 * 60 * 24));
        }

        function formatDate(dateString) {
            if (!dateString) return '';
            // Parse as local date to avoid timezone shifts
            const localDate = isoToLocalDate(dateString);
            return localDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        }

        // Convert ISO date string to local date (fixing timezone issues)
        // This ensures dates display correctly regardless of timezone
        function isoToLocalDate(dateString) {
            if (!dateString) return null;
            // If it's a full ISO string with time, extract just the date part
            // and create a local date at noon to avoid any timezone issues
            const datePart = dateString.includes('T') ? dateString.split('T')[0] : dateString;
            const [year, month, day] = datePart.split('-').map(Number);
            return new Date(year, month - 1, day, 12, 0, 0);
        }

        // Convert ISO date to YYYY-MM-DD format for date inputs (preserving intended date)
        function isoToDateInputValue(dateString) {
            if (!dateString) return '';
            const datePart = dateString.includes('T') ? dateString.split('T')[0] : dateString;
            return datePart;
        }

        // Global current apps cache - attached to window for guaranteed global scope
        window.trackerAppsCache = null;

        function getApplications() {
            // If we have a cache from Supabase, use it
            if (window.trackerAppsCache !== null) {
                console.log('getApplications: returning cache with', window.trackerAppsCache.length, 'apps');
                return window.trackerAppsCache;
            }
            console.log('getApplications: cache is null, falling back to localStorage');
            // Fallback to localStorage
            const apps = JSON.parse(localStorage.getItem('trackedApplications') || '[]');
            // Migrate legacy statuses to new structure
            let needsSave = false;
            apps.forEach(app => {
                if (LEGACY_STATUS_MAP[app.status]) {
                    app.status = LEGACY_STATUS_MAP[app.status];
                    needsSave = true;
                }
            });
            if (needsSave) {
                localStorage.setItem('trackedApplications', JSON.stringify(apps));
            }
            return apps;
        }

        function saveApplications(apps) {
            // Update the cache
            window.trackerAppsCache = apps;
            // Save to localStorage as backup
            localStorage.setItem('trackedApplications', JSON.stringify(apps));
            // If Supabase is available, also save there
            if (typeof HenryData !== 'undefined' && window.supabaseSession) {
                HenryData.saveAllApplications(apps).catch(err => {
                    console.error('Error saving to Supabase:', err);
                });
            }
        }

        function parseSalary(salaryStr) {
            if (!salaryStr) return 0;
            const match = salaryStr.match(/\$?([\d,]+)/);
            return match ? parseInt(match[1].replace(/,/g, '')) : 0;
        }

        /**
         * Calculate the accurate timeline stage for an app
         * Timeline visual stages: 0=Applied, 1=Screen, 2=Interview, 3=Final, 4=Offer
         *
         * Note: STATUSES.stage values don't match timeline stages:
         * - STATUSES stage 0 = Preparing (pre-application, not shown on timeline)
         * - STATUSES stage 1 = Applied/Networking -> Timeline stage 0
         * - STATUSES stage 2 = Screen -> Timeline stage 1
         * - STATUSES stage 3 = Interview -> Timeline stage 2
         * - STATUSES stage 4 = Final -> Timeline stage 3
         * - STATUSES stage 5 = Offer/Outcome -> Timeline stage 4
         */
        function getTimelineStageForApp(app) {
            const statusDef = STATUSES[app.status] || { stage: -1, awaiting: false };
            const statusStage = statusDef.stage;

            // Map STATUSES stage to visual timeline stage
            // Status stage 0 (Preparing) -> Timeline -1 (not on timeline)
            // Status stage 1 (Applied) -> Timeline 0
            // Status stage 2 (Screen) -> Timeline 1
            // Status stage 3 (Interview) -> Timeline 2
            // Status stage 4 (Final) -> Timeline 3
            // Status stage 5 (Offer) -> Timeline 4
            function mapStatusStageToTimeline(stage) {
                if (stage <= 0) return -1;  // Preparing or closed
                if (stage >= 5) return 4;   // Offer stage
                return stage - 1;           // Shift down by 1
            }

            // If it's an awaiting status, find the last completed interview stage
            if (app.status === 'Awaiting Decision') {
                // Check statusHistory or interviewRounds to determine where they actually are
                const screenStatuses = ['Recruiter Screen', 'Awaiting Screen Result'];
                const interviewStatuses = ['Hiring Manager', 'Technical Round', 'Panel Interview'];
                const finalStatuses = ['Final Round', 'Executive Interview'];

                let maxTimelineStage = 1; // Default to Screen (timeline stage 1)

                if (app.statusHistory) {
                    app.statusHistory.forEach(s => {
                        if (finalStatuses.includes(s)) maxTimelineStage = Math.max(maxTimelineStage, 3);
                        else if (interviewStatuses.includes(s)) maxTimelineStage = Math.max(maxTimelineStage, 2);
                        else if (screenStatuses.includes(s)) maxTimelineStage = Math.max(maxTimelineStage, 1);
                    });
                }

                // Also check interviewRounds count
                const rounds = app.interviewRounds || 0;
                if (rounds >= 4) maxTimelineStage = Math.max(maxTimelineStage, 3);
                else if (rounds >= 2) maxTimelineStage = Math.max(maxTimelineStage, 2);
                else if (rounds >= 1) maxTimelineStage = Math.max(maxTimelineStage, 1);

                return { stage: maxTimelineStage, isAwaiting: true };
            }

            // For 'Awaiting Screen Result', show at Screen stage
            if (app.status === 'Awaiting Screen Result') {
                return { stage: 1, isAwaiting: true }; // Timeline stage 1 = Screen
            }

            // For other statuses, use the mapped stage
            const timelineStage = mapStatusStageToTimeline(statusStage);
            return {
                stage: timelineStage,
                isAwaiting: statusDef.awaiting || false
            };
        }

        // ========================================================================
        // MOMENTUM CALCULATION
        // ========================================================================
        function getMomentum(app) {
            const daysSinceContact = getDaysSince(app.lastUpdated || app.dateAdded);
            if (daysSinceContact <= 3) return 'fast';
            if (daysSinceContact <= 7) return 'medium';
            if (daysSinceContact <= 14) return 'slow';
            return 'stalled';
        }

        function getMomentumLabel(momentum) {
            const labels = { fast: 'Fast', medium: 'Medium', slow: 'Slow', stalled: 'Stalled' };
            return labels[momentum] || 'Unknown';
        }

        // ========================================================================
        // STATUS LABEL (Hot, Active, Cooling, Dead)
        // ========================================================================
        function getStatusLabel(app) {
            const status = STATUSES[app.status];
            if (!status || !status.active) return 'dead';

            const daysSinceContact = getDaysSince(app.lastUpdated || app.dateAdded);
            const isInterviewing = ['Recruiter Screen', 'Hiring Manager', 'Technical Round', 'Panel Interview', 'Final Round', 'Executive Interview'].includes(app.status);

            // Hot: Interview stage OR offer expected soon OR urgent follow-up
            if (isInterviewing || app.status === 'Offer Received') return 'hot';
            if (daysSinceContact <= 3 && status.stageWeight >= 20) return 'hot';

            // Active: Movement within 7 days
            if (daysSinceContact <= 7) return 'active';

            // Cooling: No activity 8-13 days
            if (daysSinceContact <= 13) return 'cooling';

            // Stagnant/Dead: 14+ days
            return 'dead';
        }

        // ========================================================================
        // URGENCY SCORE (for sorting and prioritization)
        // ========================================================================
        function calculateUrgencyScore(app) {
            const status = STATUSES[app.status] || {};
            const daysSinceContact = getDaysSince(app.lastUpdated || app.dateAdded);
            const fitScore = app.fitScore || 50;

            // Penalize inactive early
            if (!status.active) return -100;

            let urgency = 0;

            // 1. Stage progression multiplier (interview stages get big boost)
            // Stage 0 (Preparing): 1x, Stage 1 (Applied): 1.2x, Stage 2 (Screen): 1.5x
            // Stage 3 (Interview): 2x, Stage 4 (Final): 2.5x
            const stageMultiplier = [1, 1.2, 1.5, 2, 2.5][status.stage] || 1;

            // 2. Base score from fit (0-100)
            urgency += fitScore * stageMultiplier;

            // 3. Awaiting status bonus (need to follow up!)
            if (status.awaiting) {
                // More urgent if awaiting for longer, but caps out
                const awaitingBonus = Math.min(40, daysSinceContact * 5);
                urgency += awaitingBonus;
            }

            // 4. Recency bonus for active interview stages
            if (status.stage >= 2 && daysSinceContact <= 3) {
                urgency += 30; // Hot interview needs attention now
            }

            // 5. Follow-up window detection (5-10 days post-contact is prime time)
            if (['Applied', 'Networking'].includes(app.status)) {
                if (daysSinceContact >= 5 && daysSinceContact <= 10) {
                    urgency += 25; // Prime follow-up window
                } else if (daysSinceContact > 10) {
                    urgency -= 10; // Getting stale
                }
            }

            // 6. Network leverage bonus
            if (app.networkLeverage === '1st_degree') urgency += 20;
            else if (app.networkLeverage === '2nd_degree') urgency += 10;
            else if (app.networkLeverage === 'referral') urgency += 15;

            // 7. High-fit + late-stage = leverage opportunity
            if (fitScore >= 75 && status.stage >= 3) {
                urgency += 35; // Leverage play - don't lose these!
            }

            return Math.round(urgency);
        }

        // ========================================================================
        // NEXT ACTION ENGINE
        // ========================================================================
        function generateNextAction(app) {
            const status = app.status;
            const daysSinceContact = getDaysSince(app.lastUpdated || app.dateAdded);
            const daysSinceApplied = getDaysSince(app.dateApplied);
            const daysSinceInterview = getDaysSince(app.dateInterviewed);

            // Preparing
            if (status === 'Preparing') {
                return {
                    type: 'default',
                    context: "You're building your application materials.",
                    action: "Review your tailored documents and submit your application."
                };
            }

            // To Apply
            if (status === 'Preparing') {
                if (daysSinceContact > 3) {
                    return {
                        type: 'urgent',
                        context: `Added ${daysSinceContact} days ago. Roles get 300+ applicants in 48 hours.`,
                        action: "Apply today or archive it and focus elsewhere."
                    };
                }
                return {
                    type: 'default',
                    context: "Best results come from applying within 24-48 hours of posting.",
                    action: "Submit your application, then reach out directly on LinkedIn."
                };
            }

            // Applied
            if (status === 'Applied') {
                if (daysSinceApplied < 3) {
                    return {
                        type: 'default',
                        context: `Applied ${daysSinceApplied === 0 ? 'today' : daysSinceApplied + ' days ago'}. The ATS is a black hole.`,
                        action: "Find the hiring manager on LinkedIn and send a personalized message."
                    };
                } else if (daysSinceApplied < 7) {
                    return {
                        type: 'default',
                        context: `${daysSinceApplied} days since you applied.`,
                        action: "If you haven't reached out directly, now's the time. Find someone at the company."
                    };
                } else if (daysSinceApplied < 14) {
                    return {
                        type: 'urgent',
                        context: `${daysSinceApplied} days with no response.`,
                        action: "Send a follow-up or move on. In this market, silence usually means no."
                    };
                } else {
                    return {
                        type: 'dead',
                        context: `${daysSinceApplied} days since applying. Likely ghosted.`,
                        action: "Archive and focus on active opportunities. Not personal. This market is brutal."
                    };
                }
            }

            // Reached Out
            if (status === 'Networking') {
                if (daysSinceContact < 5) {
                    return {
                        type: 'default',
                        context: `Outreach sent ${daysSinceContact === 0 ? 'today' : daysSinceContact + ' days ago'}. Give them 3-5 business days.`,
                        action: "Keep applying to other roles. Never wait on one opportunity."
                    };
                } else if (daysSinceContact < 10) {
                    return {
                        type: 'urgent',
                        context: `No response to outreach after ${daysSinceContact} days.`,
                        action: "Send a brief follow-up: 'Circling back on my note about [Role]. Still very interested.'"
                    };
                } else {
                    return {
                        type: 'dead',
                        context: `${daysSinceContact} days since outreach. This one's cold.`,
                        action: "Mark as 'No Response' and redirect your energy."
                    };
                }
            }

            // Response Received
            if (status === 'Recruiter Screen') {
                return {
                    type: 'positive',
                    context: "You got a response. Speed signals interest.",
                    action: "Respond within 24 hours. Be flexible on scheduling. Research the interviewer."
                };
            }

            // Interview stages
            if (['Recruiter Screen', 'Hiring Manager', 'Technical Round', 'Panel Interview', 'Final Round', 'Executive Interview'].includes(status)) {
                return {
                    type: 'positive',
                    context: `${status} scheduled. You're in the running.`,
                    action: "Prep your stories, research your interviewers, have questions ready."
                };
            }

            // Awaiting Decision (post-interview)
            if (status === 'Awaiting Decision') {
                if (daysSinceInterview < 1) {
                    return {
                        type: 'default',
                        context: "Interview complete. The follow-up matters.",
                        action: "Send a thank-you within 24 hours. Keep it brief but specific."
                    };
                } else if (daysSinceInterview < 7) {
                    return {
                        type: 'default',
                        context: "Thank-you sent. Now wait.",
                        action: "Follow up after 5-7 business days if you haven't heard back."
                    };
                } else {
                    return {
                        type: 'urgent',
                        context: `${daysSinceInterview} days since your interview.`,
                        action: "Send a check-in: 'Wanted to follow up on the timeline for [Role].'"
                    };
                }
            }

            // Offer
            if (status === 'Offer Received') {
                return {
                    type: 'positive',
                    context: "Congratulations. Take 24-48 hours to review carefully.",
                    action: "Research market rates. Prepare negotiation points. Consider the full package."
                };
            }

            // Inactive statuses
            if (isClosedStatus(status)) {
                return {
                    type: 'dead',
                    context: isRejectedStatus(status) ? "This one didn't work out." : status === 'Withdrawn' ? "You withdrew from this one." : status === 'Ghosted' ? "They went silent on you." : "No response received.",
                    action: "Archive it mentally and keep moving. Every silence gets you closer to the right fit."
                };
            }

            return {
                type: 'default',
                context: "Keep this one moving.",
                action: "Check for any pending follow-ups."
            };
        }

        // ========================================================================
        // PRE-INTERVIEW REJECTION DEBRIEF
        // ========================================================================
        function isPreInterviewRejection(app) {
            // Check if rejected without ever getting an interview
            if (!isRejectedStatus(app.status)) return false;

            // Never had an interview if no interview date and highest stage was Applied/Screening
            const hasInterviewed = app.dateInterviewed ||
                ['Recruiter Screen', 'Hiring Manager', 'Technical Round', 'Panel Interview',
                 'Final Round', 'Executive Interview', 'Awaiting Decision', 'Offer Received', 'Negotiating', 'Accepted'].some(
                    stage => app.statusHistory?.includes(stage)
                );

            return !hasInterviewed;
        }

        function getPreInterviewRejectionCount(apps) {
            return apps.filter(isPreInterviewRejection).length;
        }

        function generatePreInterviewRejectionDebrief(app, allApps) {
            const factors = [];
            const preInterviewRejections = getPreInterviewRejectionCount(allApps);

            // Factor 1: Fit Score Gaps
            if (app.fitScore) {
                if (app.fitScore < 60) {
                    factors.push({
                        severity: 'high',
                        title: 'Significant Fit Gap',
                        explanation: `Your fit score was ${app.fitScore}%. When fit is below 60%, applications are often filtered out early. The ATS may have flagged missing must-have requirements.`
                    });
                } else if (app.fitScore < 75) {
                    factors.push({
                        severity: 'medium',
                        title: 'Moderate Fit Gap',
                        explanation: `Your fit score was ${app.fitScore}%. In competitive roles, candidates above 75% typically advance. You may have been edged out by candidates with closer matches.`
                    });
                }
            }

            // Factor 2: Gaps analysis (if available)
            if (app.gaps && app.gaps.length > 0) {
                const criticalGaps = app.gaps.filter(g =>
                    g.toLowerCase().includes('required') ||
                    g.toLowerCase().includes('must') ||
                    g.toLowerCase().includes('years') ||
                    g.toLowerCase().includes('experience')
                );

                if (criticalGaps.length > 0) {
                    factors.push({
                        severity: 'high',
                        title: 'Hard Requirements Mismatch',
                        explanation: `Key gaps identified: ${criticalGaps.slice(0, 2).join('; ')}. These are often non-negotiable filters that eliminate candidates before human review.`
                    });
                } else if (app.gaps.length >= 3) {
                    factors.push({
                        severity: 'medium',
                        title: 'Multiple Skill Gaps',
                        explanation: `${app.gaps.length} gaps were identified. While individually addressable, multiple gaps can create a cumulative concern for hiring teams.`
                    });
                }
            }

            // Factor 3: Time since application (proxy for competition/volume)
            const daysToReject = getDaysSince(app.dateApplied || app.dateAdded) - getDaysSince(app.lastUpdated);
            if (app.dateApplied) {
                const daysSinceApply = getDaysSince(app.dateApplied);
                if (daysSinceApply <= 3) {
                    factors.push({
                        severity: 'medium',
                        title: 'High-Volume Role',
                        explanation: `Rejected within ${daysSinceApply} day(s) of applying. Fast rejections often indicate high applicant volume or strict ATS filtering, not necessarily a reflection of your qualifications.`
                    });
                } else if (daysSinceApply > 21) {
                    factors.push({
                        severity: 'low',
                        title: 'Extended Timeline',
                        explanation: `${daysSinceApply} days between application and rejection. This often means you were in consideration but ultimately passed over, possibly due to internal candidates or budget changes.`
                    });
                }
            }

            // Factor 4: Overqualification check
            if (app.fitScore >= 80 && app.gaps?.length === 0) {
                factors.push({
                    severity: 'medium',
                    title: 'Possible Overqualification',
                    explanation: `High fit (${app.fitScore}%) but no interview suggests concern about seniority match. Companies sometimes worry experienced candidates will leave quickly or want higher comp than budgeted.`
                });
            }

            // Factor 5: Career transition signal
            const hasCareerTransition = app.positioningStrategy?.toLowerCase().includes('transition') ||
                app.positioningStrategy?.toLowerCase().includes('pivot') ||
                app.positioningStrategy?.toLowerCase().includes('different');
            if (hasCareerTransition) {
                factors.push({
                    severity: 'medium',
                    title: 'Career Transition Pattern',
                    explanation: `Your positioning suggests a career shift. Transitioning candidates face higher scrutiny. Direct experience often wins at the resume screen stage.`
                });
            }

            // Factor 6: No outreach signal
            if (!app.dateReachedOut) {
                factors.push({
                    severity: 'low',
                    title: 'Application-Only Approach',
                    explanation: `No outreach was logged. Applications without networking have significantly lower success rates. Direct contact can bypass ATS filters entirely.`
                });
            }

            // Generate emotionally intelligent insight based on rejection count
            let insight = '';
            if (preInterviewRejections === 1) {
                insight = `One silent rejection is data, not a verdict. This market is brutal. Companies ghost even strong candidates. Use this analysis to refine your approach, not to question your worth.`;
            } else if (preInterviewRejections <= 3) {
                insight = `${preInterviewRejections} rejections without interviews is frustrating, but it's still within normal range for this market. Focus on roles where your fit score is 75%+ and always pair applications with direct outreach.`;
            } else if (preInterviewRejections <= 5) {
                insight = `You've had ${preInterviewRejections} rejections without interviews. Time to audit your approach. Are you applying to roles that match your profile? Is your resume making it past ATS filters? Consider getting a resume review.`;
            } else {
                insight = `${preInterviewRejections} rejections without interviews signals a pattern that needs attention. This isn't about your abilities. It's about matching your profile to the right opportunities. Let's look at common threads across these rejections.`;
            }

            // If no factors identified, provide a default
            if (factors.length === 0) {
                factors.push({
                    severity: 'low',
                    title: 'Limited Data Available',
                    explanation: `We don't have enough information to pinpoint specific factors. This rejection may have been due to internal candidates, budget changes, or simply high competition.`
                });
            }

            return { factors, insight, preInterviewRejections };
        }

        function detectRejectionPattern(apps) {
            const preInterviewRejections = apps.filter(isPreInterviewRejection);

            if (preInterviewRejections.length < 3) return null;

            // Analyze patterns across rejections
            const patterns = {
                lowFitCommon: 0,
                noOutreachCommon: 0,
                quickRejects: 0,
                gapsCommon: []
            };

            preInterviewRejections.forEach(app => {
                if (app.fitScore < 70) patterns.lowFitCommon++;
                if (!app.dateReachedOut) patterns.noOutreachCommon++;

                const daysSinceApply = getDaysSince(app.dateApplied || app.dateAdded);
                if (daysSinceApply <= 5) patterns.quickRejects++;

                if (app.gaps) {
                    app.gaps.forEach(gap => {
                        const existing = patterns.gapsCommon.find(g =>
                            g.gap.toLowerCase().includes(gap.toLowerCase().split(' ')[0])
                        );
                        if (existing) existing.count++;
                        else patterns.gapsCommon.push({ gap, count: 1 });
                    });
                }
            });

            // Generate pattern analysis
            const total = preInterviewRejections.length;
            const recommendations = [];
            let primaryPattern = '';

            if (patterns.lowFitCommon >= total * 0.6) {
                primaryPattern = `${Math.round(patterns.lowFitCommon/total*100)}% of your pre-interview rejections were for roles with fit scores below 70%.`;
                recommendations.push('Focus on roles where your fit score is 75% or higher');
                recommendations.push('Review job descriptions more carefully before applying');
            }

            if (patterns.noOutreachCommon >= total * 0.7) {
                if (!primaryPattern) {
                    primaryPattern = `${Math.round(patterns.noOutreachCommon/total*100)}% of these applications had no direct outreach.`;
                }
                recommendations.push('Pair every application with LinkedIn outreach to the hiring manager');
                recommendations.push('A personal connection can bypass ATS filters entirely');
            }

            if (patterns.quickRejects >= total * 0.5) {
                if (!primaryPattern) {
                    primaryPattern = `${Math.round(patterns.quickRejects/total*100)}% of rejections came within 5 days, suggesting ATS filtering.`;
                }
                recommendations.push('Run your resume through an ATS checker');
                recommendations.push('Ensure key terms from job descriptions appear in your resume');
            }

            // Find recurring gaps
            const recurringGaps = patterns.gapsCommon.filter(g => g.count >= 2).sort((a, b) => b.count - a.count);
            if (recurringGaps.length > 0 && !primaryPattern) {
                primaryPattern = `"${recurringGaps[0].gap}" appeared as a gap in ${recurringGaps[0].count} rejected applications.`;
                recommendations.push(`Address the "${recurringGaps[0].gap}" gap through projects, courses, or reframing`);
            }

            if (!primaryPattern) {
                primaryPattern = `No single factor dominates. Rejections may be due to high competition or internal candidates.`;
                recommendations.push('Continue applying but diversify your target companies');
                recommendations.push('Consider roles at smaller companies with less competition');
            }

            return {
                count: total,
                primaryPattern,
                recommendations: recommendations.slice(0, 3)
            };
        }

        // ========================================================================
        // DESPERATION DETECTION SYSTEM
        // ========================================================================

        // Check if intervention was recently acknowledged (don't nag)
        function getInterventionState() {
            const state = JSON.parse(localStorage.getItem('interventionState') || '{}');
            return state;
        }

        function saveInterventionState(state) {
            localStorage.setItem('interventionState', JSON.stringify(state));
        }

        function detectDesperationPattern(apps, timeframeDays = 14) {
            const now = new Date();
            const cutoff = new Date(now - timeframeDays * 24 * 60 * 60 * 1000);

            // Get recent applications
            const recentApps = apps.filter(app => {
                const addedDate = new Date(app.dateAdded);
                return addedDate >= cutoff;
            });

            if (recentApps.length < 5) return null; // Not enough data

            // Calculate metrics
            const avgFit = recentApps.reduce((sum, a) => sum + (a.fitScore || 50), 0) / recentApps.length;
            const lowFitCount = recentApps.filter(a => (a.fitScore || 50) < 65).length;
            const interviewCount = apps.filter(a =>
                ['Recruiter Screen', 'Awaiting Screen Result', 'Hiring Manager', 'Technical Round',
                 'Panel Interview', 'Final Round', 'Executive Interview', 'Awaiting Decision', 'Offer Received', 'Negotiating', 'Accepted'].includes(a.status)
            ).length;
            const interviewRate = recentApps.length > 0 ? (interviewCount / apps.filter(a => !['Preparing'].includes(a.status)).length) : 0;

            // Extract role types (simplified categorization)
            const roleTypes = new Set();
            recentApps.forEach(app => {
                const role = (app.role || '').toLowerCase();
                if (role.includes('product manager') || role.includes('pm')) roleTypes.add('Product Manager');
                else if (role.includes('engineer') || role.includes('developer')) roleTypes.add('Engineering');
                else if (role.includes('design')) roleTypes.add('Design');
                else if (role.includes('marketing')) roleTypes.add('Marketing');
                else if (role.includes('sales')) roleTypes.add('Sales');
                else if (role.includes('operations') || role.includes('ops')) roleTypes.add('Operations');
                else if (role.includes('data')) roleTypes.add('Data');
                else roleTypes.add('Other');
            });

            // Check weekly fit trajectory
            const weeklyFits = [];
            for (let w = 0; w < 3; w++) {
                const weekStart = new Date(now - (w + 1) * 7 * 24 * 60 * 60 * 1000);
                const weekEnd = new Date(now - w * 7 * 24 * 60 * 60 * 1000);
                const weekApps = apps.filter(a => {
                    const d = new Date(a.dateAdded);
                    return d >= weekStart && d < weekEnd;
                });
                if (weekApps.length > 0) {
                    weeklyFits.push(weekApps.reduce((sum, a) => sum + (a.fitScore || 50), 0) / weekApps.length);
                }
            }

            // Detect declining trajectory
            const isDecliningSpiralPattern = weeklyFits.length >= 2 &&
                weeklyFits[0] < weeklyFits[1] - 10;

            // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            // PATTERN 1: Volume Over Quality (High Severity)
            // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            if (recentApps.length >= 10 && avgFit < 65 && lowFitCount >= 7) {
                return {
                    pattern: 'volume_over_quality',
                    severity: 'high',
                    trigger: `${recentApps.length} applications in ${timeframeDays} days, avg fit ${Math.round(avgFit)}%`,
                    stats: {
                        totalApps: recentApps.length,
                        avgFit: Math.round(avgFit),
                        lowFitCount,
                        interviewRate: Math.round(interviewRate * 100)
                    },
                    lowFitSamples: recentApps.filter(a => (a.fitScore || 50) < 65).slice(0, 4),
                    diagnosis: [
                        {
                            title: 'Low Fit Targeting',
                            detail: `You're applying below your capability. ${lowFitCount} of ${recentApps.length} applications are under 65% fit.`
                        },
                        {
                            title: 'Volume Trap',
                            detail: `More volume won't fix a targeting problem. Low-fit apps = low interview rates = more rejection = more desperation.`
                        }
                    ],
                    actions: [
                        'Pause new applications for 48 hours',
                        'Run a fit audit on your last 15 applications',
                        'Identify your 75%+ fit zone (role, level, industry)',
                        'Apply ONLY to 70%+ fit roles going forward'
                    ],
                    insight: `I get it. The market is brutal, and you need momentum. But you're applying to roles where you're not competitive. This is a spiral, not a strategy. Quality beats volume. Always.`
                };
            }

            // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            // PATTERN 2: Desperation Spiral (High Severity)
            // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            if (isDecliningSpiralPattern && weeklyFits.length >= 2) {
                return {
                    pattern: 'desperation_spiral',
                    severity: 'high',
                    trigger: `Fit scores declining: ${weeklyFits.map(f => Math.round(f) + '%').reverse().join(' â†’ ')}`,
                    stats: {
                        totalApps: recentApps.length,
                        avgFit: Math.round(avgFit),
                        weeklyTrend: weeklyFits.reverse().map(f => Math.round(f)),
                        interviewRate: Math.round(interviewRate * 100)
                    },
                    diagnosis: [
                        {
                            title: 'Declining Standards',
                            detail: `Your fit scores dropped from ${Math.round(weeklyFits[0])}% to ${Math.round(weeklyFits[weeklyFits.length - 1])}% week over week. This is panic, not strategy.`
                        },
                        {
                            title: 'Confidence Spiral',
                            detail: `Rejections pile up â†’ confidence tanks â†’ you apply lower â†’ more rejections. This is a spiral.`
                        }
                    ],
                    actions: [
                        'Stop applying for 48 hours',
                        'Review your Week 1 applications (highest fit)',
                        'Double down on that profile, not below it',
                        'Get warm intros for high-fit roles (bypass volume)'
                    ],
                    insight: `You started with a clear strategy. You're applying down now. This happens when rejections pile up and timeline pressure increases. I get it, but applying to roles you're not competitive for won't speed things up. It'll just add more rejections.`
                };
            }

            // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            // PATTERN 3: Scattered/Unfocused (Medium Severity)
            // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            if (roleTypes.size >= 4 && recentApps.length >= 8) {
                return {
                    pattern: 'scattered_unfocused',
                    severity: 'medium',
                    trigger: `Applying across ${roleTypes.size} different role types`,
                    stats: {
                        totalApps: recentApps.length,
                        avgFit: Math.round(avgFit),
                        roleTypes: Array.from(roleTypes),
                        interviewRate: Math.round(interviewRate * 100)
                    },
                    diagnosis: [
                        {
                            title: 'Scattered Focus',
                            detail: `You've applied to ${Array.from(roleTypes).join(', ')} roles. Generalists lose to specialists in resume screening.`
                        },
                        {
                            title: 'Diluted Positioning',
                            detail: `Your resume can't optimize for every role type. Recruiters see "unfocused" or "desperate."`
                        }
                    ],
                    actions: [
                        'Pick ONE role type to focus on for the next 2 weeks',
                        'Tailor your resume specifically for that role',
                        'Build targeted outreach for that function',
                        'Deprioritize roles outside your focus area'
                    ],
                    insight: `Focus wins. Scatter loses. Based on your applications, identify where you have the highest fit scores and double down there. Trying to be everything makes you nothing to recruiters.`
                };
            }

            // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            // PATTERN 4: Volume Without Results (Critical Severity)
            // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            if (recentApps.length >= 15 && interviewRate === 0) {
                const noOutreachCount = recentApps.filter(a => !a.dateReachedOut).length;

                return {
                    pattern: 'volume_no_results',
                    severity: 'critical',
                    trigger: `${recentApps.length} applications, 0 interviews`,
                    stats: {
                        totalApps: recentApps.length,
                        avgFit: Math.round(avgFit),
                        interviewCount: 0,
                        noOutreachCount
                    },
                    lowFitSamples: recentApps.filter(a => (a.fitScore || 50) < 70).slice(0, 4),
                    diagnosis: [
                        {
                            title: 'Strategy Failure',
                            detail: `${recentApps.length} applications with zero interviews means something is systematically wrong.`
                        },
                        {
                            title: 'ATS or Targeting Issue',
                            detail: `Your resume may not be passing ATS filters, or you're targeting roles where you're not competitive.`
                        },
                        {
                            title: 'No Outreach',
                            detail: `${noOutreachCount} of ${recentApps.length} applications had no direct networking. Cold applications have ~2% response rates.`
                        }
                    ],
                    actions: [
                        'STOP applying. Fix the foundation first.',
                        'Run your resume through an ATS checker',
                        'Adjust targeting to 75%+ fit roles only',
                        'Pair EVERY application with direct outreach'
                    ],
                    insight: `This isn't working. More volume won't fix it. Strategy will. You're qualified, but something in your approach has systemic issues. Let's diagnose and fix before you burn more energy.`
                };
            }

            return null;
        }

        function shouldShowIntervention(apps) {
            const state = getInterventionState();

            // Don't intervene if they acknowledged within 7 days
            if (state.lastAcknowledged) {
                const daysSince = getDaysSince(state.lastAcknowledged);
                if (daysSince < 7) return null;
            }

            // Check for exception: high volume but good interview rate
            const totalApps = apps.length;
            const interviewedApps = apps.filter(a =>
                ['Recruiter Screen', 'Awaiting Screen Result', 'Hiring Manager', 'Technical Round',
                 'Panel Interview', 'Final Round', 'Executive Interview', 'Awaiting Decision', 'Offer Received', 'Negotiating', 'Accepted'].includes(a.status)
            ).length;

            if (totalApps >= 20 && (interviewedApps / totalApps) >= 0.20) {
                // They're doing fine despite volume - don't intervene
                return null;
            }

            return detectDesperationPattern(apps);
        }

        function renderInterventionModal(pattern) {
            const modal = document.getElementById('interventionContent');

            const severityLabels = {
                critical: 'Strategic Intervention Required',
                high: 'Strategic Pause Recommended',
                medium: 'Focus Needed'
            };

            const severityIcons = {
                critical: 'ðŸ›‘',
                high: 'âš ï¸',
                medium: 'ðŸ¤”'
            };

            let samplesHtml = '';
            if (pattern.lowFitSamples && pattern.lowFitSamples.length > 0) {
                samplesHtml = `
                    <div class="sample-applications">
                        <div class="sample-applications-title">Recent Low-Fit Applications</div>
                        ${pattern.lowFitSamples.map(app => `
                            <div class="sample-app">
                                <span class="sample-app-role">${app.role}, ${app.company}</span>
                                <span class="sample-app-fit ${app.fitScore < 60 ? 'low' : 'medium'}">${app.fitScore}%</span>
                            </div>
                        `).join('')}
                    </div>
                `;
            }

            modal.innerHTML = `
                <div class="modal-header">
                    <span class="modal-header-icon">${severityIcons[pattern.severity]}</span>
                    <div class="modal-header-text">
                        <h2>${severityLabels[pattern.severity]}</h2>
                        <div class="severity ${pattern.severity}">${pattern.trigger}</div>
                    </div>
                </div>

                <div class="intervention-intro">
                    <strong>I get it. The market is brutal, and you need momentum.</strong><br>
                    But here's what's happening:
                </div>

                <div class="intervention-stats">
                    <div class="intervention-stats-title">What the Data Shows</div>
                    <div class="intervention-stats-grid">
                        <div class="intervention-stat">
                            <div class="intervention-stat-value ${pattern.stats.avgFit < 65 ? 'bad' : pattern.stats.avgFit < 75 ? 'warn' : 'neutral'}">${pattern.stats.avgFit}%</div>
                            <div class="intervention-stat-label">Avg Fit Score</div>
                        </div>
                        <div class="intervention-stat">
                            <div class="intervention-stat-value neutral">${pattern.stats.totalApps}</div>
                            <div class="intervention-stat-label">Recent Applications</div>
                        </div>
                        ${pattern.stats.interviewRate !== undefined ? `
                        <div class="intervention-stat">
                            <div class="intervention-stat-value ${pattern.stats.interviewRate === 0 ? 'bad' : pattern.stats.interviewRate < 10 ? 'warn' : 'neutral'}">${pattern.stats.interviewRate}%</div>
                            <div class="intervention-stat-label">Interview Rate</div>
                        </div>
                        ` : ''}
                        ${pattern.stats.lowFitCount !== undefined ? `
                        <div class="intervention-stat">
                            <div class="intervention-stat-value bad">${pattern.stats.lowFitCount}</div>
                            <div class="intervention-stat-label">Below 65% Fit</div>
                        </div>
                        ` : ''}
                    </div>
                </div>

                ${samplesHtml}

                <div class="intervention-diagnosis">
                    <div class="intervention-diagnosis-title">Diagnosis</div>
                    ${pattern.diagnosis.map((d, i) => `
                        <div class="intervention-diagnosis-item">
                            <div class="diagnosis-number">${i + 1}</div>
                            <div class="diagnosis-content">
                                <div class="diagnosis-title">${d.title}</div>
                                <div class="diagnosis-detail">${d.detail}</div>
                            </div>
                        </div>
                    `).join('')}
                </div>

                <div class="intervention-action-plan">
                    <div class="intervention-action-title">
                        <span>ðŸ’¡</span> Here's What To Do
                    </div>
                    <ul class="intervention-action-list">
                        ${pattern.actions.map(a => `<li>${a}</li>`).join('')}
                    </ul>
                </div>

                <div class="intervention-insight">
                    <div class="intervention-insight-text">${pattern.insight}</div>
                </div>

                <div class="intervention-choice">
                    <div class="intervention-choice-label">I understand the warning and want to:</div>
                    <div class="intervention-choice-options">
                        <label class="intervention-choice-option recommended selected" onclick="selectInterventionChoice('pause')">
                            <input type="radio" name="intervention-choice" value="pause" checked>
                            <div class="intervention-radio"></div>
                            <div class="intervention-choice-text">
                                <strong>Pause and adjust my strategy</strong>
                                <span>Take 48 hours to audit and refocus</span>
                            </div>
                            <span class="intervention-badge recommended">Recommended</span>
                        </label>
                        <label class="intervention-choice-option" onclick="selectInterventionChoice('continue')">
                            <input type="radio" name="intervention-choice" value="continue">
                            <div class="intervention-radio"></div>
                            <div class="intervention-choice-text">
                                <strong>Continue with current approach</strong>
                                <span>I understand the risks</span>
                            </div>
                            <span class="intervention-badge not-recommended">Not Recommended</span>
                        </label>
                    </div>
                </div>

                <div class="modal-actions">
                    <button class="modal-btn primary" onclick="confirmInterventionChoice()">Confirm Choice</button>
                </div>
            `;

            document.getElementById('interventionModal').classList.add('show');
        }

        let selectedInterventionChoice = 'pause';

        function selectInterventionChoice(choice) {
            selectedInterventionChoice = choice;
            document.querySelectorAll('.intervention-choice-option').forEach(opt => {
                opt.classList.remove('selected');
                if (opt.querySelector(`input[value="${choice}"]`)) {
                    opt.classList.add('selected');
                }
            });
        }

        function confirmInterventionChoice() {
            const state = getInterventionState();
            state.lastAcknowledged = new Date().toISOString();
            state.choice = selectedInterventionChoice;
            saveInterventionState(state);

            document.getElementById('interventionModal').classList.remove('show');

            if (selectedInterventionChoice === 'pause') {
                // Could navigate to a fit audit page or show inline guidance
                // For now, just close and let them reflect
            }
        }

        function closeInterventionModal() {
            document.getElementById('interventionModal').classList.remove('show');
        }

        // Close modal on background click
        document.getElementById('interventionModal')?.addEventListener('click', (e) => {
            // Don't allow dismissing without acknowledging - they need to make a choice
            // Only close if clicking outside modal content AND they've seen it before
            if (e.target.id === 'interventionModal') {
                const state = getInterventionState();
                if (state.lastAcknowledged) {
                    closeInterventionModal();
                }
            }
        });

        // ========================================================================
        // CLOSE-BUT-NOT-CLOSING DETECTION
        // ========================================================================

        const LATE_STAGE_STATUSES = ['Final Round', 'Executive Interview', 'Panel Interview'];
        const INTERVIEW_STATUSES = ['Recruiter Screen', 'Hiring Manager', 'Technical Round', 'Panel Interview', 'Final Round', 'Executive Interview', 'Awaiting Decision'];

        function detectCloseButNotClosing(apps) {
            // Get applications that reached late stages
            const lateStageApps = apps.filter(app => {
                // Check if they reached a late stage (either current status or in history)
                const reachedLateStage = LATE_STAGE_STATUSES.includes(app.status) ||
                    app.statusHistory?.some(s => LATE_STAGE_STATUSES.includes(s)) ||
                    (isRejectedStatus(app.status) && app.statusHistory?.some(s => LATE_STAGE_STATUSES.includes(s)));

                // Also count applications that were rejected after being interviewed
                const rejectedAfterInterview = isRejectedStatus(app.status) && app.dateInterviewed;

                return reachedLateStage || rejectedAfterInterview;
            });

            // Count offers
            const offers = apps.filter(a => a.status === 'Offer Received').length;

            // Check for interview notes/transcripts
            const appsWithNotes = lateStageApps.filter(a => a.interviewNotes || a.interviewTranscript || (a.notes && a.notes.length > 100)).length;

            // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            // CRITICAL: 3+ late-stage interviews, 0 offers, no diagnostic data
            // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            if (lateStageApps.length >= 3 && offers === 0) {
                // No data to diagnose with
                if (appsWithNotes < 2) {
                    return {
                        pattern: 'close_not_closing_no_data',
                        severity: 'critical',
                        trigger: `${lateStageApps.length} final rounds, 0 offers, no interview data captured`,
                        stats: {
                            lateStageCount: lateStageApps.length,
                            offerCount: 0,
                            notesCount: appsWithNotes
                        },
                        lateStageApps: lateStageApps.slice(0, 4),
                        diagnosis: [
                            {
                                title: 'Pattern Detected',
                                detail: `You're reaching final rounds but not converting. Something systemic is costing you offers at the final stage.`
                            },
                            {
                                title: 'No Diagnostic Data',
                                detail: `Without interview transcripts or detailed notes, we can't diagnose what's happening in those final conversations.`
                            }
                        ],
                        possibleCauses: [
                            'Technical depth questions falling flat',
                            'Executive presence mismatch to role level',
                            'Compensation expectations misaligned',
                            'Gap mitigation unconvincing',
                            'References not backing up your narrative',
                            'Culture fit concerns not addressed'
                        ],
                        actions: [
                            'Record your next interview (Grain, Otter.ai, or voice memo)',
                            'Capture detailed notes immediately after each interview',
                            'Note: What questions stumped you? What answers felt weak?',
                            'Run a mock final-round interview to identify gaps'
                        ],
                        insight: `You're doing the hard part, getting there. But something systemic is costing you offers. Without interview data, we can't diagnose what's happening. Let's fix that.`
                    };
                }

                // Has some data - coaching intervention
                return {
                    pattern: 'close_not_closing_with_data',
                    severity: 'high',
                    trigger: `${lateStageApps.length} final rounds, 0 offers`,
                    stats: {
                        lateStageCount: lateStageApps.length,
                        offerCount: 0,
                        notesCount: appsWithNotes
                    },
                    lateStageApps: lateStageApps.slice(0, 4),
                    diagnosis: [
                        {
                            title: 'Conversion Problem',
                            detail: `You're reaching final rounds but not closing. This is more frustrating than not getting interviews at all.`
                        },
                        {
                            title: 'Data Available',
                            detail: `You have some interview notes. Let's analyze them to find patterns.`
                        }
                    ],
                    actions: [
                        'Review notes from all final rounds - look for common themes',
                        'Identify questions that tripped you up repeatedly',
                        'Practice your weak areas with mock interviews',
                        'Consider: Are references backing up your narrative?'
                    ],
                    insight: `You've captured some data. Now let's analyze: What questions come up repeatedly? What answers feel weak? Where do interviewers seem to cool off? The pattern is in the details.`
                };
            }

            // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            // EARLY WARNING: 2 late-stage losses
            // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            if (lateStageApps.length === 2 && offers === 0) {
                const rejectedLateStage = lateStageApps.filter(a => isRejectedStatus(a.status)).length;
                if (rejectedLateStage >= 2) {
                    return {
                        pattern: 'potential_close_pattern',
                        severity: 'medium',
                        trigger: '2 final rounds without conversion',
                        stats: {
                            lateStageCount: 2,
                            offerCount: 0
                        },
                        lateStageApps: lateStageApps,
                        diagnosis: [
                            {
                                title: 'Pattern Forming',
                                detail: `You've reached final rounds at 2 companies without offers. This might be coincidence, or it might be a pattern.`
                            }
                        ],
                        actions: [
                            'For your next final-round: record it or take detailed notes',
                            'This gives us data to diagnose if the pattern continues'
                        ],
                        insight: `If you convert your next final round? Great, ignore this. If you don't? We'll have the intel to figure out why.`
                    };
                }
            }

            return null;
        }

        function shouldShowCloseButNotClosingIntervention(apps) {
            const state = getInterventionState();

            // Check if this specific pattern was recently acknowledged
            if (state.closePatternAcknowledged) {
                const daysSince = getDaysSince(state.closePatternAcknowledged);
                if (daysSince < 14) return null; // 14-day cooldown for this pattern
            }

            return detectCloseButNotClosing(apps);
        }

        function renderCloseButNotClosingModal(pattern) {
            const modal = document.getElementById('interventionContent');

            const severityLabels = {
                critical: 'Critical Pattern Detected',
                high: 'Coaching Opportunity',
                medium: 'Pattern Forming'
            };

            const severityIcons = {
                critical: 'ðŸ”',
                high: 'ðŸ“Š',
                medium: 'ðŸ¤”'
            };

            // Build late-stage apps list
            let appsHtml = '';
            if (pattern.lateStageApps && pattern.lateStageApps.length > 0) {
                appsHtml = `
                    <div class="sample-applications">
                        <div class="sample-applications-title">Final Round Applications</div>
                        ${pattern.lateStageApps.map(app => `
                            <div class="sample-app">
                                <span class="sample-app-role">${app.role}, ${app.company}</span>
                                <span class="sample-app-fit ${isRejectedStatus(app.status) ? 'low' : 'medium'}">${isRejectedStatus(app.status) ? 'Rejected' : app.status}</span>
                            </div>
                        `).join('')}
                    </div>
                `;
            }

            // Build possible causes section (for no-data version)
            let causesHtml = '';
            if (pattern.possibleCauses) {
                causesHtml = `
                    <div class="intervention-diagnosis" style="margin-bottom: 16px;">
                        <div class="intervention-diagnosis-title">It could be:</div>
                        <ul class="intervention-action-list" style="background: var(--color-bg); padding: 16px; border-radius: 8px; margin: 0;">
                            ${pattern.possibleCauses.map(c => `<li style="color: var(--color-text-secondary);">${c}</li>`).join('')}
                        </ul>
                    </div>
                    <div style="text-align: center; color: var(--color-text-muted); font-size: 0.85rem; margin-bottom: 20px;">
                        We need data to figure out which one.
                    </div>
                `;
            }

            modal.innerHTML = `
                <div class="modal-header">
                    <span class="modal-header-icon">${severityIcons[pattern.severity]}</span>
                    <div class="modal-header-text">
                        <h2>${severityLabels[pattern.severity]}</h2>
                        <div class="severity ${pattern.severity}">${pattern.trigger}</div>
                    </div>
                </div>

                ${appsHtml}

                <div class="intervention-intro">
                    <strong>You're doing the hard part, getting to final rounds.</strong><br>
                    But something is costing you offers at the last stage.
                </div>

                <div class="intervention-diagnosis">
                    <div class="intervention-diagnosis-title">The Problem</div>
                    ${pattern.diagnosis.map((d, i) => `
                        <div class="intervention-diagnosis-item">
                            <div class="diagnosis-number">${i + 1}</div>
                            <div class="diagnosis-content">
                                <div class="diagnosis-title">${d.title}</div>
                                <div class="diagnosis-detail">${d.detail}</div>
                            </div>
                        </div>
                    `).join('')}
                </div>

                ${causesHtml}

                <div class="intervention-action-plan">
                    <div class="intervention-action-title">
                        <span>ðŸ’¡</span> What To Do Next
                    </div>
                    <ul class="intervention-action-list">
                        ${pattern.actions.map(a => `<li>${a}</li>`).join('')}
                    </ul>
                </div>

                <div class="intervention-insight">
                    <div class="intervention-insight-text">${pattern.insight}</div>
                </div>

                ${pattern.severity === 'critical' ? `
                <div style="background: var(--color-surface); border: 1px solid var(--color-border); border-radius: 12px; padding: 16px; margin-bottom: 20px;">
                    <div style="font-size: 0.85rem; font-weight: 600; color: var(--color-text); margin-bottom: 12px;">
                        ðŸ“± How to Record Your Interviews
                    </div>
                    <div style="font-size: 0.8rem; color: var(--color-text-secondary); line-height: 1.6;">
                        <strong>Best option:</strong> Use Grain, Otter.ai, or Fireflies.ai to auto-join your video calls.<br><br>
                        <strong>Alternative:</strong> Use your phone's voice recorder and transcribe later.<br><br>
                        <strong>Always ask:</strong> "Do you mind if I record for my notes? It helps me stay present."<br>
                        95% of interviewers say yes.
                    </div>
                </div>
                ` : ''}

                <div class="intervention-choice">
                    <div class="intervention-choice-label">I understand and will:</div>
                    <div class="intervention-choice-options">
                        <label class="intervention-choice-option recommended selected" onclick="selectClosePatternChoice('capture')">
                            <input type="radio" name="close-pattern-choice" value="capture" checked>
                            <div class="intervention-radio"></div>
                            <div class="intervention-choice-text">
                                <strong>Start capturing interview data</strong>
                                <span>Record or take detailed notes for my next interview</span>
                            </div>
                            <span class="intervention-badge recommended">Recommended</span>
                        </label>
                        <label class="intervention-choice-option" onclick="selectClosePatternChoice('dismiss')">
                            <input type="radio" name="close-pattern-choice" value="dismiss">
                            <div class="intervention-radio"></div>
                            <div class="intervention-choice-text">
                                <strong>I'll figure it out myself</strong>
                                <span>Don't show this again for 2 weeks</span>
                            </div>
                        </label>
                    </div>
                </div>

                <div class="modal-actions">
                    <button class="modal-btn primary" onclick="confirmClosePatternChoice()">Got It</button>
                </div>
            `;

            document.getElementById('interventionModal').classList.add('show');
        }

        let selectedClosePatternChoice = 'capture';

        function selectClosePatternChoice(choice) {
            selectedClosePatternChoice = choice;
            document.querySelectorAll('.intervention-choice-option').forEach(opt => {
                opt.classList.remove('selected');
                if (opt.querySelector(`input[value="${choice}"]`)) {
                    opt.classList.add('selected');
                }
            });
        }

        function confirmClosePatternChoice() {
            const state = getInterventionState();
            state.closePatternAcknowledged = new Date().toISOString();
            state.closePatternChoice = selectedClosePatternChoice;
            saveInterventionState(state);

            document.getElementById('interventionModal').classList.remove('show');
        }

        // ========================================================================
        // CANDIDATE EXPERIENCE SCORE (Company Behavior Analysis)
        // ========================================================================

        /**
         * Calculate Candidate Experience Score
         * This isn't about whether candidate got offerâ€”it's about
         * whether company treated them professionally.
         */
        function calculateCandidateExperienceScore(app) {
            let score = 100; // Start perfect
            const signals = [];

            // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            // FACTOR: Interview Round Count
            // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            const interviewRounds = app.interviewRounds || countInterviewRounds(app);

            if (interviewRounds >= 6) {
                score -= 20;
                signals.push({
                    icon: 'âš ï¸',
                    title: 'Excessive Interview Rounds',
                    detail: `${interviewRounds} rounds is above market standard (typical: 3-4 for senior roles). Suggests indecisive leadership or death by committee.`,
                    severity: 'high'
                });
            } else if (interviewRounds === 5) {
                score -= 10;
                signals.push({
                    icon: 'ðŸ¤”',
                    title: '5 Interview Rounds',
                    detail: 'Above standard (typical: 3-4 rounds). May indicate committee decision-making.',
                    severity: 'medium'
                });
            }

            // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            // FACTOR: Response Time
            // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            if (app.dateApplied && app.dateResponseReceived) {
                const daysToResponse = Math.round(
                    (new Date(app.dateResponseReceived) - new Date(app.dateApplied)) / (1000 * 60 * 60 * 24)
                );

                if (daysToResponse > 14) {
                    score -= 15;
                    signals.push({
                        icon: 'â³',
                        title: 'Slow Initial Response',
                        detail: `${daysToResponse} days to respond suggests high volume or disorganization.`,
                        severity: 'medium'
                    });
                }
            }

            if (app.dateInterviewed && isRejectedStatus(app.status)) {
                const daysSinceInterview = getDaysSince(app.dateInterviewed);
                const daysSinceUpdate = getDaysSince(app.lastUpdated);
                const daysToDecision = daysSinceInterview - daysSinceUpdate;

                if (daysToDecision > 10) {
                    score -= 15;
                    signals.push({
                        icon: 'â³',
                        title: 'Slow Final Decision',
                        detail: `${daysToDecision} days after final round suggests internal misalignment.`,
                        severity: 'medium'
                    });
                }
            }

            // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            // FACTOR: Feedback Provided
            // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            if (isRejectedStatus(app.status) && !app.feedbackProvided) {
                // Check if they reached interview stage
                const hadInterview = app.dateInterviewed ||
                    INTERVIEW_STATUSES.some(s => app.statusHistory?.includes(s));

                if (hadInterview) {
                    score -= 20;
                    signals.push({
                        icon: 'ðŸ¤',
                        title: 'No Rejection Feedback',
                        detail: 'You made it to interviews and they gave you nothing. Suggests low-transparency culture.',
                        severity: 'high'
                    });
                }
            }

            // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            // FACTOR: Ghosting
            // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            if (app.ghostedAfterFinalRound ||
                (LATE_STAGE_STATUSES.includes(app.status) && getDaysSince(app.lastUpdated) > 14)) {
                score -= 30;
                signals.push({
                    icon: 'ðŸ‘»',
                    title: 'Ghosted After Final Round',
                    detail: 'Major red flag for communication and respect. If they do this when trying to impress you, imagine working there.',
                    severity: 'critical'
                });
            }

            // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            // GENERATE LETTER GRADE
            // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            let grade, gradeLabel;
            if (score >= 90) {
                grade = 'A';
                gradeLabel = 'Excellent candidate experience';
            } else if (score >= 80) {
                grade = 'B';
                gradeLabel = 'Good, minor issues';
            } else if (score >= 70) {
                grade = 'C';
                gradeLabel = 'Average, some red flags';
            } else if (score >= 60) {
                grade = 'D';
                gradeLabel = 'Poor, multiple red flags';
            } else {
                grade = 'F';
                gradeLabel = 'Terrible, avoid this company';
            }

            return { score, grade, gradeLabel, signals };
        }

        function countInterviewRounds(app) {
            // Count based on status history or current status
            let rounds = 0;
            const interviewStages = ['Recruiter Screen', 'Hiring Manager', 'Technical Round',
                                     'Panel Interview', 'Final Round', 'Executive Interview'];

            if (app.statusHistory) {
                app.statusHistory.forEach(status => {
                    if (interviewStages.includes(status)) rounds++;
                });
            }

            // Also count current status if it's an interview
            if (interviewStages.includes(app.status)) rounds++;

            return rounds;
        }

        /**
         * Analyze company behavior patterns across all applications
         * Surfaces red flags and recurring issues
         */
        function analyzeCompanyBehaviorPatterns(apps) {
            const patterns = {
                excessiveRounds: [],
                noFeedback: [],
                ghosting: [],
                slowDecisions: []
            };

            apps.forEach(app => {
                const experience = calculateCandidateExperienceScore(app);

                experience.signals.forEach(signal => {
                    if (signal.title.includes('Excessive') || signal.title.includes('5 Interview')) {
                        patterns.excessiveRounds.push({ company: app.company, rounds: app.interviewRounds || countInterviewRounds(app) });
                    }
                    if (signal.title.includes('No Rejection Feedback')) {
                        patterns.noFeedback.push({ company: app.company });
                    }
                    if (signal.title.includes('Ghosted')) {
                        patterns.ghosting.push({ company: app.company });
                    }
                    if (signal.title.includes('Slow')) {
                        patterns.slowDecisions.push({ company: app.company });
                    }
                });
            });

            return patterns;
        }

        /**
         * Generate Company Behavior Analysis for a rejected application
         */
        function generateCompanyBehaviorAnalysis(app) {
            const experience = calculateCandidateExperienceScore(app);

            // Build timeline
            const timeline = {
                applied: app.dateApplied ? formatDate(app.dateApplied) : '--',
                interviewed: app.dateInterviewed ? formatDate(app.dateInterviewed) : '--',
                decision: app.lastUpdated ? formatDate(app.lastUpdated) : '--',
                feedbackProvided: app.feedbackProvided ? 'Yes' : 'None'
            };

            // Generate behavioral insights
            const insights = [];

            experience.signals.forEach(signal => {
                insights.push({
                    title: signal.title,
                    text: signal.detail,
                    implication: getImplication(signal.title)
                });
            });

            return { timeline, experience, insights };
        }

        function getImplication(signalTitle) {
            const implications = {
                'Excessive Interview Rounds': 'Expect the same indecisive leadership if you join.',
                '5 Interview Rounds': 'Committee cultures can slow down all decisions, not just hiring.',
                'Slow Initial Response': 'Communication may always be slow here.',
                'Slow Final Decision': 'Internal misalignment affects day-to-day work too.',
                'No Rejection Feedback': 'Low-feedback cultures don\'t tell you how you\'re doing in the job either.',
                'Ghosted After Final Round': 'They don\'t respect people\'s time. This won\'t change.'
            };
            return implications[signalTitle] || 'Your candidate experience reflects your employee experience.';
        }

        /**
         * Render excessive interview rounds warning if detected
         * Only shows for apps that are actually in interview stages (not screen)
         */
        function renderRoundsWarning(app) {
            const rounds = app.interviewRounds || countInterviewRounds(app);
            const status = STATUSES[app.status];

            // Only show warning if:
            // 1. Has 5+ rounds
            // 2. Status is active
            // 3. Status is in Interview category (not Application/Screening)
            const isInterviewStage = status?.category === 'Interview' || status?.category === 'Outcome';

            if (rounds >= 5 && status?.active && isInterviewStage) {
                return `
                    <div class="rounds-warning">
                        <span class="rounds-warning-icon">âš ï¸</span>
                        <div class="rounds-warning-text">
                            You're heading into interview round <strong>#${rounds}</strong>.
                            This is above market standard (typical: 3-4 rounds for senior roles).
                        </div>
                    </div>
                `;
            }
            return '';
        }

        // ========================================================================
        // PIPELINE METRICS
        // ========================================================================
        function calculatePipelineMetrics(apps) {
            const activeApps = apps.filter(a => STATUSES[a.status]?.active);
            const allApps = apps;

            // Active count
            const activeCount = activeApps.length;

            // Momentum distribution
            let momentumHigh = 0, momentumMed = 0;
            activeApps.forEach(app => {
                const m = getMomentum(app);
                if (m === 'fast') momentumHigh++;
                else if (m === 'medium') momentumMed++;
            });

            // Leverage score: (final-stage interviews * avg fit) / total active
            const finalStageApps = activeApps.filter(a =>
                ['Final Round', 'Executive Interview', 'Offer Received'].includes(a.status)
            );
            let leverageScore = 0;
            if (activeCount > 0 && finalStageApps.length > 0) {
                const avgFit = finalStageApps.reduce((sum, a) => sum + (a.fitScore || 50), 0) / finalStageApps.length;
                leverageScore = (finalStageApps.length * avgFit) / activeCount / 10;
            }

            // Average time to screen - use dateResponseReceived, dateInterviewed, or infer from status
            const screenStatuses = ['Recruiter Screen', 'Awaiting Screen Result', 'Hiring Manager', 'Technical Round',
                'Panel Interview', 'Final Round', 'Executive Interview', 'Awaiting Decision', 'Offer Received', 'Negotiating', 'Accepted'];

            const withScreen = allApps.filter(a => {
                const hasApplied = a.dateApplied;
                // Has explicit response date OR is in a screen/interview status
                const hasResponse = a.dateResponseReceived || a.dateInterviewed || screenStatuses.includes(a.status);
                return hasApplied && hasResponse;
            });

            let avgTimeToScreen = null;
            if (withScreen.length > 0) {
                const total = withScreen.reduce((sum, a) => {
                    // Use explicit dates if available, otherwise use lastUpdated as proxy for when they got a response
                    const responseDate = a.dateResponseReceived || a.dateInterviewed || a.lastUpdated;
                    if (!responseDate) return sum;
                    const applied = new Date(a.dateApplied);
                    const responded = new Date(responseDate);
                    const daysDiff = Math.floor((responded - applied) / (1000 * 60 * 60 * 24));
                    return sum + Math.max(0, daysDiff); // Ensure non-negative
                }, 0);
                avgTimeToScreen = Math.round(total / withScreen.length * 10) / 10;
            }

            // Interview conversion rate
            const applied = allApps.filter(a => !['Preparing'].includes(a.status)).length;
            const interviewed = allApps.filter(a =>
                ['Recruiter Screen', 'Awaiting Screen Result', 'Hiring Manager', 'Technical Round', 'Panel Interview', 'Final Round', 'Executive Interview', 'Awaiting Decision', 'Offer Received', 'Negotiating', 'Accepted'].includes(a.status)
            ).length;
            const conversionRate = applied > 0 ? Math.round((interviewed / applied) * 100) : 0;

            // Ghost rate
            const ghosted = allApps.filter(a => {
                const days = getDaysSince(a.dateApplied || a.dateAdded);
                return a.status === 'Applied' && days > 14;
            }).length;
            const ghostRate = applied > 0 ? Math.round((ghosted / applied) * 100) : 0;

            return {
                activeCount,
                momentumHigh,
                momentumMed,
                leverageScore,
                avgTimeToScreen,
                conversionRate,
                ghostRate
            };
        }

        // ========================================================================
        // STRATEGIC PRIORITIES
        // ========================================================================
        function getStrategicPriorities(apps) {
            const activeApps = apps.filter(a => STATUSES[a.status]?.active);

            // Calculate urgency for each and sort
            const withUrgency = activeApps.map(app => ({
                ...app,
                urgencyScore: calculateUrgencyScore(app),
                statusLabel: getStatusLabel(app),
                momentum: getMomentum(app)
            }));

            withUrgency.sort((a, b) => b.urgencyScore - a.urgencyScore);

            // Return top 3-5
            return withUrgency.slice(0, Math.min(5, withUrgency.length));
        }

        // ========================================================================
        // FILTERING & SORTING
        // ========================================================================
        function filterApplications(apps) {
            return apps.filter(app => {
                const status = STATUSES[app.status];
                const statusLabel = getStatusLabel(app);

                // Status filter
                if (currentStatusFilter === 'active' && !status?.active) return false;
                if (currentStatusFilter === 'hot' && statusLabel !== 'hot') return false;
                if (currentStatusFilter === 'interviewing') {
                    const interviewStatuses = ['Recruiter Screen', 'Hiring Manager', 'Technical Round', 'Panel Interview', 'Final Round', 'Executive Interview'];
                    if (!interviewStatuses.includes(app.status)) return false;
                }
                if (currentStatusFilter === 'waiting') {
                    if (!['Applied', 'Networking', 'Awaiting Decision'].includes(app.status)) return false;
                }
                if (currentStatusFilter === 'stale') {
                    if (statusLabel !== 'cooling' && statusLabel !== 'dead') return false;
                }

                // Fit filter
                if (currentFitFilter === 'high' && app.fitScore < 80) return false;
                if (currentFitFilter === 'medium' && (app.fitScore < 60 || app.fitScore >= 80)) return false;
                if (currentFitFilter === 'low' && app.fitScore >= 60) return false;

                return true;
            });
        }

        function sortApplications(apps) {
            return [...apps].sort((a, b) => {
                // Always put active first
                const aActive = STATUSES[a.status]?.active ?? true;
                const bActive = STATUSES[b.status]?.active ?? true;
                if (aActive && !bActive) return -1;
                if (!aActive && bActive) return 1;

                // Sort by selected criteria
                if (currentSort === 'urgency') {
                    return calculateUrgencyScore(b) - calculateUrgencyScore(a);
                }
                if (currentSort === 'fit') {
                    return (b.fitScore || 0) - (a.fitScore || 0);
                }
                if (currentSort === 'recent') {
                    return new Date(b.lastUpdated || b.dateAdded) - new Date(a.lastUpdated || a.dateAdded);
                }
                if (currentSort === 'timeline') {
                    return (STATUSES[b.status]?.stageWeight || 0) - (STATUSES[a.status]?.stageWeight || 0);
                }
                return 0;
            });
        }

        // ========================================================================
        // RENDER FUNCTIONS
        // ========================================================================
        function renderPipelineMetrics(metrics) {
            document.getElementById('metricActive').textContent = metrics.activeCount;
            document.getElementById('metricActive').className = 'metric-value ' + (metrics.activeCount > 0 ? 'green' : 'gray');

            // Momentum
            const totalMomentum = metrics.momentumHigh + metrics.momentumMed;
            document.getElementById('metricMomentum').textContent = totalMomentum > 0 ? (metrics.momentumHigh > metrics.momentumMed ? 'High' : 'Med') : '--';
            document.getElementById('metricMomentum').className = 'metric-value ' + (metrics.momentumHigh > 0 ? 'green' : metrics.momentumMed > 0 ? 'amber' : 'gray');
            document.getElementById('metricMomentumDetail').textContent = `High: ${metrics.momentumHigh} | Med: ${metrics.momentumMed}`;

            // Leverage
            document.getElementById('metricLeverage').textContent = metrics.leverageScore > 0 ? metrics.leverageScore.toFixed(1) + 'x' : '--';

            // Time to screen
            document.getElementById('metricTimeToScreen').textContent = metrics.avgTimeToScreen ? metrics.avgTimeToScreen + ' days' : '--';

            // Conversion
            document.getElementById('metricConversion').textContent = metrics.conversionRate + '%';
            document.getElementById('metricConversion').className = 'metric-value ' + (metrics.conversionRate >= 20 ? 'green' : metrics.conversionRate >= 10 ? 'amber' : 'gray');

            // Ghost rate
            document.getElementById('metricGhost').textContent = metrics.ghostRate + '%';
            document.getElementById('metricGhost').className = 'metric-value ' + (metrics.ghostRate <= 30 ? 'gray' : 'red');
        }

        function renderStrategicPriorities(priorities) {
            const container = document.getElementById('strategicPriorities');
            const content = document.getElementById('prioritiesContent');

            if (priorities.length === 0) {
                container.style.display = 'none';
                return;
            }

            container.style.display = 'block';

            content.innerHTML = priorities.map(app => {
                const action = generateNextAction(app);
                const statusLabel = app.statusLabel;
                const daysSince = getDaysSince(app.lastUpdated || app.dateAdded);

                return `
                    <div class="priority-item ${statusLabel}" onclick="navigateWithAnalysis('${app.id}', 'overview.html')" style="cursor: pointer;">
                        <span class="priority-badge ${statusLabel}">${statusLabel.toUpperCase()}</span>
                        <div class="priority-content">
                            <div class="priority-role">${app.role}</div>
                            <div class="priority-company">${app.company} â€¢ ${app.status}</div>
                            <div class="priority-action">â†’ ${action.action}</div>
                        </div>
                        <div class="priority-meta">
                            <span class="priority-fit">${app.fitScore}%</span>
                            <span class="priority-days">${daysSince === 0 ? 'Today' : daysSince + 'd ago'}</span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Current view mode: 'table' or 'cards'
        let currentViewMode = 'table';

        function setViewMode(mode) {
            currentViewMode = mode;
            document.getElementById('tableViewBtn').classList.toggle('active', mode === 'table');
            document.getElementById('cardViewBtn').classList.toggle('active', mode === 'cards');
            document.getElementById('tableViewContainer').style.display = mode === 'table' ? 'block' : 'none';
            document.getElementById('applicationsContainer').style.display = mode === 'cards' ? 'block' : 'none';
            // Re-render with current apps
            renderApplications(getApplications());
        }

        function renderApplications(apps) {
            const cardContainer = document.getElementById('applicationsContainer');
            const tableBody = document.getElementById('tableBody');
            const filtered = filterApplications(apps);
            const sorted = sortApplications(filtered);

            // Show/hide filters and bulk actions bar
            document.getElementById('filtersBar').style.display = apps.length > 0 ? 'flex' : 'none';
            document.getElementById('bulkActionsBar').style.display = selectedAppIds.size > 0 ? 'flex' : 'none';

            if (apps.length === 0) {
                const emptyHTML = `
                    <div class="empty-state">
                        <h2>Your command center is ready.</h2>
                        <p>Analyze your first role to start building your strategic pipeline.</p>
                        <a href="analyze.html">Analyze First Role</a>
                    </div>
                `;
                cardContainer.innerHTML = emptyHTML;
                tableBody.innerHTML = `<tr><td colspan="9" class="table-empty">${emptyHTML}</td></tr>`;
                return;
            }

            if (sorted.length === 0) {
                const noMatchHTML = `
                    <div class="empty-state">
                        <h2>No matches</h2>
                        <p>No applications match your current filters.</p>
                    </div>
                `;
                cardContainer.innerHTML = noMatchHTML;
                tableBody.innerHTML = `<tr><td colspan="9" class="table-empty">${noMatchHTML}</td></tr>`;
                return;
            }

            // Render card view
            cardContainer.innerHTML = `
                <div class="applications-grid">
                    ${sorted.map(app => renderAppCard(app)).join('')}
                </div>
            `;

            // Render table view
            tableBody.innerHTML = sorted.map(app => renderTableRow(app)).join('');
        }

        function renderTableRow(app) {
            const status = STATUSES[app.status] || { label: app.status, active: true };
            const daysSince = getDaysSince(app.dateApplied || app.dateAdded);
            const isGhostRisk = daysSince >= 14 && ['Applied', 'Networking'].includes(app.status);
            const action = generateNextAction(app);
            const timelineInfo = getTimelineStageForApp(app);
            const timelineStage = timelineInfo.stage;

            // Fit badge class
            let fitClass = 'medium';
            if (app.fitScore === null || app.fitScore === undefined) fitClass = 'none';
            else if (app.fitScore >= 80) fitClass = 'high';
            else if (app.fitScore < 60) fitClass = 'low';

            const fitDisplay = app.fitScore !== null && app.fitScore !== undefined ? `${app.fitScore}%` : 'â€”';

            const isSelected = selectedAppIds.has(String(app.id));

            // Stage names
            const stageNames = ['Applied', 'Screen', 'Interview', 'Final', 'Offer'];
            const currentStageName = timelineStage >= 0 && timelineStage < stageNames.length ? stageNames[timelineStage] : 'â€”';

            return `
                <tr class="${isGhostRisk ? 'ghost-risk' : ''} ${isSelected ? 'selected' : ''}" data-id="${app.id}">
                    <td class="col-checkbox">
                        <input type="checkbox" ${isSelected ? 'checked' : ''} onchange="toggleRowSelection('${app.id}', this.checked)">
                    </td>
                    <td class="col-company">
                        <span class="table-company">${app.company || 'Unknown'}</span>
                    </td>
                    <td class="col-role">
                        <span class="table-role" onclick="navigateWithAnalysis('${app.id}', 'overview.html')" title="View strategy">
                            ${app.role || 'Unknown Role'}
                        </span>
                    </td>
                    <td class="col-status">
                        <select class="table-status-select" onchange="updateStatus('${app.id}', this.value)">
                            ${renderStatusOptions(app.status)}
                        </select>
                    </td>
                    <td class="col-fit">
                        <span class="table-fit-badge ${fitClass}">${fitDisplay}</span>
                    </td>
                    <td class="col-stage">
                        <div class="table-stage-indicator" title="${currentStageName}">
                            ${[0,1,2,3,4].map(i => `<span class="table-stage-dot ${i < timelineStage ? 'completed' : i === timelineStage ? 'current' : ''}"></span>`).join('')}
                        </div>
                    </td>
                    <td class="col-days">
                        <span class="table-days ${daysSince >= 14 ? 'urgent' : ''}">${daysSince}d</span>
                    </td>
                    <td class="col-action">
                        <span class="table-action" title="${action.action}">${action.action}</span>
                    </td>
                    <td class="col-actions">
                        <div class="table-actions-menu">
                            <button class="table-icon-btn" onclick="showReachOutModal('${app.id}')" title="Reach Out">
                                ðŸ’¬
                            </button>
                            <button class="table-icon-btn" onclick="showArchiveModal('${app.id}')" title="Archive">
                                ðŸ“¦
                            </button>
                        </div>
                    </td>
                </tr>
            `;
        }

        function renderStatusOptions(currentStatus) {
            let html = '';
            for (const [category, statuses] of Object.entries(STATUS_CATEGORIES)) {
                html += `<optgroup label="${category}">`;
                for (const status of statuses) {
                    const statusDef = STATUSES[status] || { label: status };
                    const label = statusDef.label.replace(/^[^\s]+\s+/, ''); // Remove emoji prefix
                    const isSelected = status === currentStatus;
                    html += `<option value="${status}" ${isSelected ? 'selected' : ''}>${label}</option>`;
                }
                html += `</optgroup>`;
            }
            return html;
        }

        function toggleRowSelection(appId, isChecked) {
            if (isChecked) {
                selectedAppIds.add(String(appId));
            } else {
                selectedAppIds.delete(String(appId));
            }

            // Show/hide bulk actions bar based on selection
            document.getElementById('bulkActionsBar').style.display = selectedAppIds.size > 0 ? 'flex' : 'none';

            updateSelectedCount();
            updateSelectAllCheckbox();

            // Update row highlighting
            const row = document.querySelector(`tr[data-id="${appId}"]`);
            if (row) {
                row.classList.toggle('selected', isChecked);
            }
        }

        // Render grouped status dropdown options with emoji labels
        function renderGroupedStatusOptions(appId, currentStatus) {
            let html = '';
            for (const [category, statuses] of Object.entries(STATUS_CATEGORIES)) {
                html += `<div class="status-category-header">${category}</div>`;
                for (const status of statuses) {
                    const statusDef = STATUSES[status] || { label: status };
                    const isCurrent = status === currentStatus;
                    html += `<div class="status-option${isCurrent ? ' current' : ''}" onclick="updateStatus('${appId}', '${status}')">${statusDef.label}</div>`;
                }
            }
            return html;
        }

        function renderAppCard(app) {
            const status = STATUSES[app.status] || {};
            const statusLabel = getStatusLabel(app);
            const momentum = getMomentum(app);
            const action = generateNextAction(app);
            const isInactive = !status.active;
            const daysSince = getDaysSince(app.lastUpdated || app.dateAdded);

            // Fit badge class
            let fitClass = 'medium';
            if (app.fitScore === null || app.fitScore === undefined) fitClass = 'none';
            else if (app.fitScore >= 80) fitClass = 'high';
            else if (app.fitScore < 60) fitClass = 'low';

            // Timeline stage - use accurate stage based on actual interview history
            const timelineInfo = getTimelineStageForApp(app);
            const timelineStage = timelineInfo.stage;
            const isAwaiting = timelineInfo.isAwaiting;

            // Check if high leverage (final stages + high fit)
            const isLeverage = status.stageWeight >= 50 && app.fitScore >= 75;

            // Calculate candidate experience score for rejected/completed applications
            const experienceScore = calculateCandidateExperienceScore(app);
            const showExperience = isRejectedStatus(app.status) && experienceScore.signals.length > 0;

            // Ghost risk detection
            const daysSinceApplied = getDaysSince(app.dateApplied);
            const isGhostRisk = daysSinceApplied >= 14 && ['Applied', 'Networking'].includes(app.status);
            const dateAppliedDisplay = app.dateApplied ? formatDate(app.dateApplied) : null;

            return `
                <div class="app-card ${statusLabel === 'hot' ? 'hot' : ''} ${isInactive ? 'inactive' : ''} ${isGhostRisk ? 'ghost-risk' : ''}" data-id="${app.id}">
                    <div class="card-header">
                        <div class="card-title-section">
                            <div class="card-title" style="cursor: pointer;" onclick="navigateWithAnalysis('${app.id}', 'overview.html')" title="View application strategy">
                                ${app.role}
                                ${isLeverage ? '<span class="leverage-badge">ðŸ”¥ LEVERAGE</span>' : ''}
                            </div>
                            <div class="card-subtitle">
                                <span class="editable-company" onclick="editCompanyName('${app.id}', event)" title="Click to edit company name">${app.company}</span>${app.salary && app.salary !== 'Not specified' ? ' â€¢ ' + app.salary : ''}
                            </div>
                        </div>
                        <div class="card-meta">
                            <span class="fit-badge ${fitClass}">${app.fitScore !== null && app.fitScore !== undefined ? app.fitScore + '% fit' : 'No fit score'}</span>
                            ${showExperience ? `<span class="experience-badge grade-${experienceScore.grade.toLowerCase()}">${experienceScore.grade}</span>` : ''}
                            <div class="status-selector">
                                <button class="status-btn" onclick="toggleStatusDropdown('${app.id}', event)">
                                    ${status.label || app.status} <span style="opacity: 0.5;">â–¼</span>
                                </button>
                                <div class="status-dropdown" id="dropdown-${app.id}">
                                    ${renderGroupedStatusOptions(app.id, app.status)}
                                </div>
                            </div>
                        </div>
                    </div>

                    ${dateAppliedDisplay ? `
                    <div class="timeline-date-edit">
                        <div class="timeline-date-edit-left">
                            <span>Applied:</span>
                            <span class="timeline-date-display">${dateAppliedDisplay}</span>
                            <span class="timeline-days-ago">(${daysSinceApplied} days ago)</span>
                        </div>
                        <button class="edit-date-btn" onclick="showDateEditModal('${app.id}')">Edit Timeline</button>
                    </div>
                    ` : `
                    <div class="timeline-date-edit">
                        <div class="timeline-date-edit-left">
                            <span style="color: var(--color-text-muted);">No application date set</span>
                        </div>
                        <button class="edit-date-btn" onclick="showDateEditModal('${app.id}')">Set Date</button>
                    </div>
                    `}

                    ${isGhostRisk ? `
                    <div class="ghost-risk-alert">
                        <div class="ghost-risk-title">
                            <span>ðŸ‘»</span> GHOST RISK
                        </div>
                        <div class="ghost-risk-text">
                            ${daysSinceApplied} days with no response. You've likely been ghosted.
                            Send a final follow-up (Hail Mary) or archive and move on.
                        </div>
                    </div>
                    ` : ''}

                    ${renderRoundsWarning(app)}

                    <div class="next-action ${action.type}">
                        <div class="next-action-label">
                            <span>âš¡</span> Next Action
                        </div>
                        <div class="next-action-text">${action.context}</div>
                        <div class="next-action-cta">â†’ ${action.action}</div>
                    </div>

                    ${renderRejectionDebrief(app)}
                    ${renderCompanyBehaviorAnalysis(app)}

                    <div class="timeline-section">
                        <div class="timeline-bar">
                            ${[0,1,2,3,4].map(i => `
                                <div class="timeline-stage ${i < timelineStage ? 'completed' : i === timelineStage ? (isAwaiting ? 'current awaiting' : 'current') : ''}"
                                     onclick="setTimelineStage('${app.id}', ${i})"
                                     title="Click to update status"></div>
                            `).join('')}
                        </div>
                        ${isAwaiting && timelineStage >= 0 ? `<div class="you-are-here">â†‘ AWAITING NEXT STEPS${timelineStage === 2 ? ' (post-screen)' : timelineStage === 3 ? ' (mid-interviews)' : timelineStage === 4 ? ' (final rounds)' : ''}</div>` : ''}
                        <div class="timeline-labels">
                            <span onclick="setTimelineStage('${app.id}', 0)" style="cursor:pointer">Applied</span>
                            <span onclick="setTimelineStage('${app.id}', 1)" style="cursor:pointer">Screen</span>
                            <span onclick="setTimelineStage('${app.id}', 2)" style="cursor:pointer">${timelineStage >= 3 && (app.interviewRounds || 0) > 1 ? 'Round ' + app.interviewRounds : 'Interview'}</span>
                            <span onclick="setTimelineStage('${app.id}', 3)" style="cursor:pointer">Final</span>
                            <span onclick="setTimelineStage('${app.id}', 4)" style="cursor:pointer">Offer</span>
                        </div>
                    </div>

                    <div class="card-stats">
                        <div class="card-stat">
                            <div class="card-stat-value ${momentum}">${getMomentumLabel(momentum)}</div>
                            <div class="card-stat-label">Momentum</div>
                        </div>
                        <div class="card-stat">
                            <div class="card-stat-value">${daysSince === 0 ? 'Today' : daysSince + 'd'}</div>
                            <div class="card-stat-label">Last Activity</div>
                        </div>
                        <div class="card-stat" title="${app.networkLeverage ? 'You have a connection at this company' : 'No network connection identified - use Reach Out to find contacts'}">
                            <div class="card-stat-value">${app.networkLeverage === '1st_degree' ? '1stÂ°' : app.networkLeverage === '2nd_degree' ? '2ndÂ°' : app.networkLeverage === 'referral' ? 'ðŸ¤' : 'â€”'}</div>
                            <div class="card-stat-label">Network</div>
                        </div>
                    </div>

                    <div class="expandable-section">
                        <div class="expandable-toggle" onclick="toggleSection('${app.id}', 'notes')">
                            ðŸ“ Notes ${app.notes ? '(has notes)' : ''}
                        </div>
                        <div class="expandable-content" id="notes-content-${app.id}">
                            <textarea class="notes-textarea" placeholder="Add notes: contacts, interview details, reminders..." onblur="saveNotes('${app.id}', this.value)">${app.notes || ''}</textarea>
                        </div>
                    </div>

                    ${app.interviewNotes ? `
                    <div class="expandable-section">
                        <div class="expandable-toggle" onclick="toggleSection('${app.id}', 'interview')">
                            ðŸŽ¤ Interview Notes
                        </div>
                        <div class="expandable-content" id="interview-content-${app.id}">
                            <div class="interview-notes">
                                ${renderInterviewNotes(app.interviewNotes)}
                            </div>
                        </div>
                    </div>
                    ` : ''}

                    <div class="card-actions">
                        ${renderContextualActions(app)}
                    </div>
                </div>
            `;
        }

        function renderInterviewNotes(notes) {
            if (!notes) return '';
            return `
                <div class="interview-date">${formatDate(notes.date)}</div>
                ${notes.nailed?.length ? `
                    <div class="interview-section">
                        <div class="interview-section-label nailed">What You Nailed</div>
                        <ul class="interview-bullets">
                            ${notes.nailed.map(n => `<li>${n}</li>`).join('')}
                        </ul>
                    </div>
                ` : ''}
                ${notes.fumbled?.length ? `
                    <div class="interview-section">
                        <div class="interview-section-label fumbled">What to Improve</div>
                        <ul class="interview-bullets">
                            ${notes.fumbled.map(f => `<li>${f}</li>`).join('')}
                        </ul>
                    </div>
                ` : ''}
                ${notes.signals?.length ? `
                    <div class="interview-section">
                        <div class="interview-section-label signals">Signals</div>
                        <ul class="interview-bullets">
                            ${notes.signals.map(s => `<li>${s}</li>`).join('')}
                        </ul>
                    </div>
                ` : ''}
            `;
        }

        // ========================================================================
        // CONTEXT-AWARE ACTION BUTTONS
        // ========================================================================
        function getContextualActions(app) {
            const status = app.status;
            const daysSince = getDaysSince(app.lastUpdated || app.dateAdded);
            const statusDef = STATUSES[status] || {};
            const actions = [];

            // Pre-Apply stages
            if (['Preparing'].includes(status)) {
                if (!app.dateApplied) {
                    actions.push({ label: 'ðŸ“¤ Submit Application', action: `markAction('${app.id}', 'dateApplied')`, primary: true });
                }
                actions.push({ label: 'ðŸ“ Review Materials', action: `navigateWithAnalysis('${app.id}', 'documents.html')` });
            }
            // Just Applied - waiting for response
            else if (['Applied', 'Networking'].includes(status)) {
                if (daysSince >= 5 && daysSince <= 10) {
                    actions.push({ label: 'ðŸ“§ Send Follow-Up', action: `navigateWithAnalysis('${app.id}', 'outreach.html')`, primary: true });
                } else if (daysSince > 10) {
                    actions.push({ label: 'â° Schedule Check-In', action: `scheduleFollowUp('${app.id}')`, primary: true });
                }
                if (!app.dateReachedOut) {
                    actions.push({ label: 'ðŸ’¬ Reach Out', action: `showReachOutModal('${app.id}')` });
                }
            }
            // Screen scheduled - need to prep
            else if (status === 'Recruiter Screen') {
                actions.push({ label: 'ðŸ“‹ Review Prep Guide', action: `navigateToInterviewIntelligence('${app.id}')`, primary: true });
            }
            // Awaiting screen result - waiting for response
            else if (status === 'Awaiting Screen Result') {
                if (daysSince >= 5) {
                    actions.push({ label: 'ðŸ“§ Send Follow-Up', action: `showReachOutModal('${app.id}')`, primary: true });
                } else {
                    actions.push({ label: 'â° Schedule Follow-Up', action: `scheduleFollowUp('${app.id}')`, primary: true });
                }
                actions.push({ label: 'ðŸ“ Add Notes', action: `toggleSection('${app.id}', 'notes')` });
            }
            // Interview stages
            else if (['Hiring Manager', 'Technical Round', 'Panel Interview'].includes(status)) {
                if (statusDef.awaiting) {
                    actions.push({ label: 'â° Schedule Follow-Up', action: `scheduleFollowUp('${app.id}')` });
                } else {
                    actions.push({ label: 'ðŸ“‹ Review Prep Guide', action: `navigateToInterviewIntelligence('${app.id}')`, primary: true });
                }
            }
            // Final stages
            else if (['Final Round', 'Executive Interview', 'Awaiting Decision'].includes(status)) {
                actions.push({ label: 'ðŸ“ Add Notes', action: `toggleSection('${app.id}', 'notes')`, primary: true });
                if (statusDef.awaiting && daysSince >= 3) {
                    actions.push({ label: 'ðŸ“ž Request Timeline Update', action: `scheduleFollowUp('${app.id}')` });
                }
                actions.push({ label: 'âŒ Mark Rejected', action: `showRejectModal('${app.id}')` });
            }
            // Offer stage
            else if (['Offer Received', 'Negotiating'].includes(status)) {
                actions.push({ label: 'ðŸ’° Prep Negotiation', action: `navigateWithAnalysis('${app.id}', 'overview.html')`, primary: true });
                actions.push({ label: 'ðŸ“Š Compare Offers', action: `compareOffers('${app.id}')` });
                actions.push({ label: 'âœ… Accept Offer', action: `updateStatus('${app.id}', 'Accepted')` });
            }
            // Inactive/Closed states - show delete link only for these
            else if (isClosedStatus(status) || status === 'Accepted') {
                if (isRejectedStatus(status)) {
                    actions.push({ label: 'ðŸ“‹ View Debrief', action: `showRejectionDebrief('${app.id}')` });
                    actions.push({ label: 'ðŸ”„ Request Feedback', action: `requestFeedback('${app.id}')` });
                }
                // For closed/archived apps, show delete as a link (not button)
                actions.push({ label: 'Delete', action: `showDeleteModal('${app.id}')`, isLink: true });
                return actions;
            }

            // Active apps get Archive option (not delete)
            actions.push({ label: 'Archive', action: `showArchiveModal('${app.id}')` });

            return actions;
        }

        function renderContextualActions(app) {
            const actions = getContextualActions(app);

            // Always add "Review Job Description" button first
            const reviewJDBtn = `<button class="card-action-btn ask-henry" onclick="showJobDescription('${app.id}')">
                ðŸ“„ Review Job Description
            </button>`;

            const actionBtns = actions.map(action => {
                // Render as a subtle link instead of button
                if (action.isLink) {
                    return `<a href="#" class="card-action-link" onclick="${action.action}; return false;">${action.label}</a>`;
                }

                let btnClass = 'card-action-btn';
                if (action.primary) btnClass += ' primary';
                if (action.danger) btnClass += ' danger';

                return `<button class="${btnClass}" onclick="${action.action}">${action.label}</button>`;
            }).join('');

            return reviewJDBtn + actionBtns;
        }

        // Helper functions for contextual actions
        function scheduleFollowUp(appId) {
            const app = getApplications().find(a => a.id === appId);
            if (!app) return;
            // Open calendar with follow-up event
            const title = encodeURIComponent(`Follow up: ${app.role} at ${app.company}`);
            const date = new Date();
            date.setDate(date.getDate() + 3);
            const dateStr = date.toISOString().replace(/-|:|\.\d\d\d/g, '').slice(0, 15);
            window.open(`https://calendar.google.com/calendar/render?action=TEMPLATE&text=${title}&dates=${dateStr}/${dateStr}`, '_blank');
        }

        function schedulePrepTime(appId) {
            const app = getApplications().find(a => a.id === appId);
            if (!app) return;
            const title = encodeURIComponent(`Interview Prep: ${app.role} at ${app.company}`);
            const date = new Date();
            date.setDate(date.getDate() + 1);
            const dateStr = date.toISOString().replace(/-|:|\.\d\d\d/g, '').slice(0, 15);
            window.open(`https://calendar.google.com/calendar/render?action=TEMPLATE&text=${title}&dates=${dateStr}/${dateStr}`, '_blank');
        }

        function requestFeedback(appId) {
            const app = getApplications().find(a => a.id === appId);
            if (!app) return;
            const subject = encodeURIComponent(`Feedback Request - ${app.role}`);
            const body = encodeURIComponent(`Hi,\n\nThank you for considering me for the ${app.role} position. I was disappointed to learn I wasn't selected, but I'd genuinely appreciate any feedback you could share that might help me in my continued search.\n\nThank you for your time.\n\nBest regards`);
            window.open(`mailto:?subject=${subject}&body=${body}`, '_blank');
        }

        function compareOffers(appId) {
            alert('Offer comparison feature coming soon!');
        }

        /**
         * Show job description in a modal
         * Retrieves JD from app data or analysis data
         */
        function showJobDescription(appId) {
            console.log('showJobDescription called with:', appId);
            const app = getApplications().find(a => String(a.id) === String(appId));
            if (!app) {
                console.error('Application not found:', appId);
                return;
            }
            console.log('Found app for JD:', app.company, app.role);

            // Try to get JD from multiple sources
            let jobDescription = app.jobDescription || '';

            // If not in app, try to get from analysis data
            if (!jobDescription && app.analysisKey) {
                const analysisData = localStorage.getItem(app.analysisKey);
                if (analysisData) {
                    try {
                        const parsed = JSON.parse(analysisData);
                        jobDescription = parsed.job_description || parsed.jd_text || parsed._jd_text || '';
                    } catch (e) {
                        console.error('Error parsing analysis data:', e);
                    }
                }
            }

            // Show modal with JD
            const modal = document.getElementById('jobDescriptionModal');
            const content = document.getElementById('jobDescriptionContent');
            const title = document.getElementById('jobDescriptionTitle');

            title.textContent = `${app.role} at ${app.company}`;

            if (jobDescription) {
                content.innerHTML = `
                    <div class="jd-text">${jobDescription.replace(/\n/g, '<br>')}</div>
                    <button class="modal-btn secondary" style="margin-top: 16px;" onclick="editJobDescription('${appId}')">
                        âœï¸ Edit Job Description
                    </button>
                `;
            } else {
                content.innerHTML = `
                    <div class="jd-empty">
                        <p>âš ï¸ No job description saved for this role.</p>
                        <p style="margin-top: 12px; color: var(--color-text-muted); font-size: 0.9rem;">
                            Without a JD, some analysis features may be incomplete. Paste the job description below to enable full functionality.
                        </p>
                        <textarea id="jdInput" placeholder="Paste the job description here..."
                            style="width: 100%; min-height: 200px; margin-top: 16px; padding: 12px;
                            background: var(--color-surface); border: 1px solid var(--color-border);
                            border-radius: 8px; color: var(--color-text); font-size: 0.9rem; resize: vertical;"></textarea>
                        <button class="modal-btn primary" style="margin-top: 12px;" onclick="saveJobDescriptionFromModal('${appId}')">
                            ðŸ’¾ Save Job Description
                        </button>
                    </div>
                `;
            }

            modal.classList.add('show');
        }

        function editJobDescription(appId) {
            const app = getApplications().find(a => String(a.id) === String(appId));
            if (!app) return;

            const content = document.getElementById('jobDescriptionContent');
            const currentJD = app.jobDescription || '';

            content.innerHTML = `
                <textarea id="jdInput" style="width: 100%; min-height: 300px; padding: 12px;
                    background: var(--color-surface); border: 1px solid var(--color-border);
                    border-radius: 8px; color: var(--color-text); font-size: 0.9rem; resize: vertical;">${currentJD}</textarea>
                <div style="display: flex; gap: 12px; margin-top: 12px;">
                    <button class="modal-btn secondary" onclick="showJobDescription('${appId}')">Cancel</button>
                    <button class="modal-btn primary" onclick="saveJobDescriptionFromModal('${appId}')">ðŸ’¾ Save Changes</button>
                </div>
            `;
        }

        function saveJobDescriptionFromModal(appId) {
            const jdInput = document.getElementById('jdInput');
            if (!jdInput) return;

            const jobDescription = jdInput.value.trim();
            if (!jobDescription) {
                alert('Please paste a job description first.');
                return;
            }

            const apps = getApplications();
            const idx = apps.findIndex(a => String(a.id) === String(appId));
            if (idx === -1) return;

            apps[idx].jobDescription = jobDescription;
            apps[idx].lastUpdated = new Date().toISOString();
            saveApplications(apps);

            // Refresh the modal to show the saved JD
            showJobDescription(appId);
        }

        function closeJobDescriptionModal() {
            document.getElementById('jobDescriptionModal').classList.remove('show');
        }

        // ========================================================================
        // REJECTION MODAL
        // ========================================================================
        let rejectAppId = null;

        function showRejectModal(appId) {
            rejectAppId = appId;
            const app = getApplications().find(a => String(a.id) === String(appId));
            if (!app) return;

            // Reset form
            document.getElementById('rejectStage').value = 'pre-screen';
            document.getElementById('rejectFeedback').value = '';

            document.getElementById('rejectModal').classList.add('show');
        }

        function closeRejectModal() {
            rejectAppId = null;
            document.getElementById('rejectModal').classList.remove('show');
        }

        function confirmRejection() {
            if (!rejectAppId) return;

            const apps = getApplications();
            const idx = apps.findIndex(a => String(a.id) === String(rejectAppId));
            if (idx === -1) return;

            const rejectStage = document.getElementById('rejectStage').value;
            const rejectFeedback = document.getElementById('rejectFeedback').value;

            // Update application
            apps[idx].status = 'Rejected';
            apps[idx].lastUpdated = new Date().toISOString();
            apps[idx].rejectionData = {
                stage: rejectStage,
                feedback: rejectFeedback,
                date: new Date().toISOString()
            };

            saveApplications(apps);
            closeRejectModal();
            renderAll(apps);
        }

        function showRejectionDebrief(appId) {
            const app = getApplications().find(a => String(a.id) === String(appId));
            if (!app) return;

            const title = document.getElementById('debriefTitle');
            const content = document.getElementById('debriefContent');

            title.textContent = `${app.role} at ${app.company}`;

            const rejectionData = app.rejectionData || {};
            const stageLabels = {
                'pre-screen': 'Before any interviews (auto-rejection)',
                'after-screen': 'After recruiter screen',
                'after-hiring-manager': 'After hiring manager interview',
                'after-technical': 'After technical round',
                'after-final': 'After final round',
                'no-response': 'Never heard back (ghosted)'
            };

            const stageLabel = stageLabels[rejectionData.stage] || 'Unknown stage';
            const rejectionDate = rejectionData.date ? new Date(rejectionData.date).toLocaleDateString() : 'Unknown';

            // Calculate insights based on rejection stage
            let insights = '';
            if (rejectionData.stage === 'pre-screen') {
                insights = `
                    <div style="background: rgba(239, 68, 68, 0.1); border-left: 3px solid #ef4444; padding: 16px; border-radius: 8px; margin-top: 16px;">
                        <h4 style="color: #ef4444; margin: 0 0 8px 0;">Auto-Rejection Analysis</h4>
                        <p style="margin: 0; color: var(--color-text-secondary);">
                            Pre-screen rejections often indicate ATS filtering or a mismatch with hard requirements. Consider:
                        </p>
                        <ul style="margin: 12px 0 0 0; padding-left: 20px; color: var(--color-text-secondary);">
                            <li>Does your resume contain the exact keywords from the job description?</li>
                            <li>Do you meet all stated requirements (years of experience, degree, certifications)?</li>
                            <li>Is your resume format ATS-friendly (no tables, columns, or graphics)?</li>
                        </ul>
                    </div>
                `;
            } else if (rejectionData.stage === 'after-screen') {
                insights = `
                    <div style="background: rgba(234, 179, 8, 0.1); border-left: 3px solid #eab308; padding: 16px; border-radius: 8px; margin-top: 16px;">
                        <h4 style="color: #eab308; margin: 0 0 8px 0;">Post-Screen Rejection</h4>
                        <p style="margin: 0; color: var(--color-text-secondary);">
                            The recruiter saw potential but something didn't align. Common reasons:
                        </p>
                        <ul style="margin: 12px 0 0 0; padding-left: 20px; color: var(--color-text-secondary);">
                            <li>Salary expectations didn't match their budget</li>
                            <li>Location/remote work preferences didn't align</li>
                            <li>Timeline mismatch (they needed someone sooner/later)</li>
                            <li>Better-matched candidates in the pipeline</li>
                        </ul>
                    </div>
                `;
            } else if (rejectionData.stage === 'no-response') {
                insights = `
                    <div style="background: rgba(107, 114, 128, 0.1); border-left: 3px solid #6b7280; padding: 16px; border-radius: 8px; margin-top: 16px;">
                        <h4 style="color: #6b7280; margin: 0 0 8px 0;">Ghosted</h4>
                        <p style="margin: 0; color: var(--color-text-secondary);">
                            Unfortunately, ghosting is common. This usually reflects the company's process, not you:
                        </p>
                        <ul style="margin: 12px 0 0 0; padding-left: 20px; color: var(--color-text-secondary);">
                            <li>Role may have been filled, put on hold, or cancelled</li>
                            <li>High application volume with limited recruiter capacity</li>
                            <li>Internal candidates or referrals took priority</li>
                        </ul>
                    </div>
                `;
            } else {
                insights = `
                    <div style="background: rgba(59, 130, 246, 0.1); border-left: 3px solid #3b82f6; padding: 16px; border-radius: 8px; margin-top: 16px;">
                        <h4 style="color: #3b82f6; margin: 0 0 8px 0;">Post-Interview Rejection</h4>
                        <p style="margin: 0; color: var(--color-text-secondary);">
                            You made it far! Late-stage rejections often come down to:
                        </p>
                        <ul style="margin: 12px 0 0 0; padding-left: 20px; color: var(--color-text-secondary);">
                            <li>Cultural fit or team dynamics</li>
                            <li>Specific technical skills gaps</li>
                            <li>Another candidate was simply a better match</li>
                            <li>Budget or headcount changes</li>
                        </ul>
                    </div>
                `;
            }

            content.innerHTML = `
                <div style="background: var(--color-surface); border-radius: 12px; padding: 20px; margin-bottom: 16px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 16px;">
                        <div>
                            <div style="color: var(--color-text-muted); font-size: 0.85rem;">Rejection Stage</div>
                            <div style="color: var(--color-text); font-weight: 500;">${stageLabel}</div>
                        </div>
                        <div style="text-align: right;">
                            <div style="color: var(--color-text-muted); font-size: 0.85rem;">Date</div>
                            <div style="color: var(--color-text); font-weight: 500;">${rejectionDate}</div>
                        </div>
                    </div>

                    ${rejectionData.feedback ? `
                        <div style="border-top: 1px solid var(--color-border); padding-top: 16px;">
                            <div style="color: var(--color-text-muted); font-size: 0.85rem; margin-bottom: 8px;">Feedback Received</div>
                            <div style="color: var(--color-text); background: var(--color-bg); padding: 12px; border-radius: 8px;">${rejectionData.feedback}</div>
                        </div>
                    ` : `
                        <div style="border-top: 1px solid var(--color-border); padding-top: 16px; color: var(--color-text-muted); font-style: italic;">
                            No feedback provided
                        </div>
                    `}
                </div>

                ${insights}
            `;

            document.getElementById('rejectionDebriefModal').classList.add('show');
        }

        function closeRejectionDebriefModal() {
            document.getElementById('rejectionDebriefModal').classList.remove('show');
        }

        /**
         * Open Hey Henry for a specific application
         * Sets context and opens the chat drawer with an initial message
         */
        function openHeyHenry(appId) {
            const app = getApplications().find(a => a.id === appId);
            if (!app) {
                console.error('Application not found:', appId);
                return;
            }

            // Store application context for Hey Henry
            const appContext = {
                company: app.company,
                role: app.role,
                status: app.status,
                jobDescription: app.jobDescription || null,
                jobUrl: app.jobUrl || null,
                interviewDate: app.interviewDate || null,
                notes: app.notes || null,
                fitScore: app.fitScore || null
            };
            sessionStorage.setItem('heyHenryAppContext', JSON.stringify(appContext));

            // Build initial message based on what we know
            let initialMessage = '';
            const hasJD = !!app.jobDescription;
            const hasInterview = !!app.interviewDate;

            if (!hasJD) {
                // Prompt for JD
                initialMessage = `I'd love to help you prepare for your ${app.role} position at ${app.company}. To give you the best strategy, could you paste the job description? You can usually find it on the job posting page.`;
            } else if (hasInterview) {
                // Interview prep mode
                const interviewDate = new Date(app.interviewDate);
                const daysUntil = Math.ceil((interviewDate - new Date()) / (1000 * 60 * 60 * 24));
                initialMessage = `I see you have an interview coming up ${daysUntil <= 0 ? 'today' : daysUntil === 1 ? 'tomorrow' : `in ${daysUntil} days`} for ${app.role} at ${app.company}. Let's make sure you're ready!\n\nWhat would you like help with?\nâ€¢ Interview prep questions\nâ€¢ Position strategy (how to pitch yourself)\nâ€¢ Company research talking points\n\nAlso, I recommend checking out **Leverage Interview Intelligence** for mock interview practice - it's a great way to rehearse before the real thing.`;
            } else {
                // General help with JD available
                initialMessage = `Great, I have the job description for ${app.role} at ${app.company}. What would you like help with?\n\nâ€¢ Interview prep questions\nâ€¢ Position strategy (how to pitch yourself)\nâ€¢ Company research talking points\n\nAlso, I recommend checking out **Leverage Interview Intelligence** for mock interview practice - it's a great way to rehearse before the real thing.`;
            }

            // Store the initial message to show in Hey Henry
            sessionStorage.setItem('heyHenryInitialMessage', initialMessage);

            // Open Hey Henry drawer
            const fab = document.getElementById('askHenryFab');
            if (fab) {
                fab.click();
            }

            // Clear the stored context after a delay (next page load will be fresh)
            setTimeout(() => {
                // Let Hey Henry component handle the initial message display
                const messagesContainer = document.getElementById('askHenryMessages');
                if (messagesContainer) {
                    // Clear existing messages and add our contextual greeting
                    messagesContainer.innerHTML = '';
                    const msgEl = document.createElement('div');
                    msgEl.className = 'ask-henry-message assistant';
                    msgEl.innerHTML = formatHeyHenryMessage(initialMessage);
                    messagesContainer.appendChild(msgEl);

                    // Hide suggestions since we have context
                    const suggestions = document.getElementById('askHenrySuggestions');
                    if (suggestions) {
                        suggestions.style.display = 'none';
                    }
                }
            }, 100);
        }

        // Simple markdown formatter for Hey Henry messages
        function formatHeyHenryMessage(content) {
            return content
                .split('\n\n').map(para => {
                    if (para.match(/^[â€¢]\s/m)) {
                        const items = para.split('\n')
                            .filter(line => line.trim())
                            .map(line => `<li>${line.replace(/^[â€¢]\s*/, '')}</li>`)
                            .join('');
                        return `<ul>${items}</ul>`;
                    }
                    return `<p>${para
                        .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
                        .replace(/\n/g, '<br>')
                    }</p>`;
                })
                .join('');
        }

        /**
         * Navigate to a page with the application's analysis data loaded
         * This ensures overview, documents, outreach, etc. have the context they need
         */
        function navigateWithAnalysis(appId, targetPage) {
            // Handle both string and number IDs
            const app = getApplications().find(a => String(a.id) === String(appId));
            if (!app) {
                console.error('Application not found:', appId);
                window.location.href = targetPage;
                return;
            }

            // Try to load stored analysis data
            if (app.analysisKey) {
                const analysisData = localStorage.getItem(app.analysisKey);
                if (analysisData) {
                    sessionStorage.setItem('analysisData', analysisData);
                    console.log('Loaded analysis data for:', app.company, app.role);
                }
            }

            // If no analysis data loaded, create minimal analysis data from app info
            if (!sessionStorage.getItem('analysisData') || !app.analysisKey) {
                const minimalAnalysis = {
                    _company_name: app.company,
                    _company: app.company,
                    role_title: app.role,
                    _role: app.role,
                    fit_score: app.fitScore,
                    strengths: app.strengths || [],
                    gaps: app.gaps || [],
                    strategic_positioning: app.positioningStrategy || '',
                    salary_info: app.salary || 'Not specified'
                };
                sessionStorage.setItem('analysisData', JSON.stringify(minimalAnalysis));
                console.log('Created minimal analysis data for:', app.company, app.role);
            }

            // Try to load stored documents data - prefer Supabase data from app, fallback to localStorage
            if (app.documentsData && Object.keys(app.documentsData).length > 0) {
                sessionStorage.setItem('documentsData', JSON.stringify(app.documentsData));
                console.log('Loaded documents data from Supabase for:', app.company, app.role);
            } else {
                const documentsKey = `documents_${app.company}_${app.role}`.toLowerCase().replace(/[^a-z0-9_]/g, '_');
                const documentsData = localStorage.getItem(documentsKey);
                if (documentsData) {
                    sessionStorage.setItem('documentsData', documentsData);
                    console.log('Loaded documents data from localStorage for:', app.company, app.role);
                } else {
                    // Clear any stale documents data from a different application
                    sessionStorage.removeItem('documentsData');
                    console.log('No documents found for:', app.company, app.role);
                }
            }

            window.location.href = targetPage;
        }

        function renderRejectionDebrief(app) {
            // Only show for pre-interview rejections
            if (!isPreInterviewRejection(app)) return '';

            const allApps = getApplications();
            const debrief = generatePreInterviewRejectionDebrief(app, allApps);

            return `
                <div class="rejection-debrief">
                    <div class="debrief-header">
                        <span>ðŸ”</span>
                        <span class="debrief-title">Why This Happened</span>
                    </div>
                    <div class="debrief-subtitle">
                        No interview means no feedback, so <em style="color: #22d3ee;">Henry</em> analyzed what we know to help you learn from this.
                    </div>
                    <div class="debrief-factors">
                        ${debrief.factors.map(factor => `
                            <div class="debrief-factor">
                                <div class="factor-indicator ${factor.severity}"></div>
                                <div class="factor-content">
                                    <div class="factor-title">${factor.title}</div>
                                    <div class="factor-explanation">${factor.explanation}</div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    <div class="debrief-insight">
                        <div class="insight-label">Henry's Take</div>
                        <div class="insight-text">${debrief.insight}</div>
                    </div>
                </div>
            `;
        }

        /**
         * Render Company Behavior Analysis for post-interview rejections
         */
        function renderCompanyBehaviorAnalysis(app) {
            // Only show for rejections that had interviews
            if (!isRejectedStatus(app.status)) return '';

            const hadInterview = app.dateInterviewed ||
                INTERVIEW_STATUSES.some(s => app.statusHistory?.includes(s));

            if (!hadInterview) return ''; // Let pre-interview debrief handle this

            const experience = calculateCandidateExperienceScore(app);
            if (experience.signals.length === 0) return '';

            const analysis = generateCompanyBehaviorAnalysis(app);

            return `
                <div class="rejection-debrief" style="border-color: rgba(255, 107, 53, 0.3);">
                    <div class="debrief-header">
                        <span>ðŸ“Š</span>
                        <span class="debrief-title">Company Behavior Analysis</span>
                        <span class="experience-badge grade-${experience.grade.toLowerCase()}" style="margin-left: auto;">${experience.grade}</span>
                    </div>

                    <div class="behavior-timeline">
                        <div class="timeline-item">
                            <div class="timeline-label">Applied</div>
                            <div class="timeline-value">${analysis.timeline.applied}</div>
                        </div>
                        <div class="timeline-item">
                            <div class="timeline-label">Interviewed</div>
                            <div class="timeline-value">${analysis.timeline.interviewed}</div>
                        </div>
                        <div class="timeline-item">
                            <div class="timeline-label">Decision</div>
                            <div class="timeline-value">${analysis.timeline.decision}</div>
                        </div>
                        <div class="timeline-item">
                            <div class="timeline-label">Feedback</div>
                            <div class="timeline-value">${analysis.timeline.feedbackProvided}</div>
                        </div>
                    </div>

                    ${experience.signals.map(signal => `
                        <div class="behavior-insight">
                            <div class="behavior-insight-title">${signal.icon} ${signal.title}</div>
                            <div class="behavior-insight-text">${signal.detail}</div>
                        </div>
                    `).join('')}

                    <div class="behavior-principle">
                        <div class="behavior-principle-label">The Principle</div>
                        <div class="behavior-principle-text">
                            Your candidate experience is a reflection of your employee experience.
                            ${experience.grade === 'D' || experience.grade === 'F' ? ' Sometimes rejection is protection.' : ''}
                        </div>
                    </div>
                </div>
            `;
        }

        // ========================================================================
        // INTERACTION HANDLERS
        // ========================================================================
        function toggleStatusDropdown(appId, event) {
            if (event) event.stopPropagation();
            document.querySelectorAll('.status-dropdown').forEach(d => d.classList.remove('show'));
            const dropdown = document.getElementById(`dropdown-${appId}`);
            if (dropdown) {
                dropdown.classList.toggle('show');
            }
        }

        function editCompanyName(appId, event) {
            event.stopPropagation();
            const span = event.target;
            const currentName = span.textContent;

            // Create input element
            const input = document.createElement('input');
            input.type = 'text';
            input.value = currentName;
            input.className = 'company-edit-input';

            // Replace span with input
            span.replaceWith(input);
            input.focus();
            input.select();

            // Save on blur or enter
            const saveEdit = () => {
                const newName = input.value.trim() || currentName;

                // Update in localStorage
                const apps = getApplications();
                const idx = apps.findIndex(a => a.id === appId);
                if (idx !== -1 && newName !== apps[idx].company) {
                    apps[idx].company = newName;
                    apps[idx].lastUpdated = new Date().toISOString();
                    saveApplications(apps);
                }

                // Re-render
                renderAll(getApplications());
            };

            input.addEventListener('blur', saveEdit);
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    input.blur();
                } else if (e.key === 'Escape') {
                    input.value = currentName;
                    input.blur();
                }
            });
        }

        function updateStatus(appId, newStatus) {
            const apps = getApplications();
            const idx = apps.findIndex(a => String(a.id) === String(appId));

            if (idx !== -1) {
                const oldStatus = apps[idx].status;
                apps[idx].status = newStatus;
                apps[idx].lastUpdated = new Date().toISOString();

                // Track if transitioning to a milestone status without a date
                const needsDatePrompt = (
                    (newStatus === 'Applied' && !apps[idx].dateApplied) ||
                    (['Awaiting Decision', 'Recruiter Screen', 'Hiring Manager', 'Technical Round', 'Panel Interview', 'Final Round', 'Executive Interview'].includes(newStatus) && !apps[idx].dateInterviewed)
                );

                // Auto-set dates (default to today if not prompted)
                if (newStatus === 'Applied' && !apps[idx].dateApplied) {
                    apps[idx].dateApplied = new Date().toISOString();
                }
                if (newStatus === 'Networking' && !apps[idx].dateReachedOut) {
                    apps[idx].dateReachedOut = new Date().toISOString();
                }
                if (newStatus === 'Recruiter Screen' && !apps[idx].dateResponseReceived) {
                    apps[idx].dateResponseReceived = new Date().toISOString();
                }
                if (['Awaiting Decision', 'Recruiter Screen', 'Hiring Manager', 'Technical Round', 'Panel Interview', 'Final Round', 'Executive Interview'].includes(newStatus) && !apps[idx].dateInterviewed) {
                    apps[idx].dateInterviewed = new Date().toISOString();
                }

                saveApplications(apps);
                renderAll(apps);

                // If this was a significant status change, prompt to verify/edit the date
                if (needsDatePrompt) {
                    setTimeout(() => {
                        showDateEditModal(appId);
                    }, 300);
                }
            }

            document.querySelectorAll('.status-dropdown').forEach(d => d.classList.remove('show'));
        }

        function markAction(appId, dateField) {
            const apps = getApplications();
            const idx = apps.findIndex(a => a.id === appId);

            if (idx !== -1 && !apps[idx][dateField]) {
                apps[idx][dateField] = new Date().toISOString();
                apps[idx].lastUpdated = new Date().toISOString();

                // Auto-update status
                if (dateField === 'dateApplied' && ['Preparing'].includes(apps[idx].status)) {
                    apps[idx].status = 'Applied';
                }
                if (dateField === 'dateReachedOut' && ['Preparing', 'Applied'].includes(apps[idx].status)) {
                    apps[idx].status = 'Networking';
                }
                if (dateField === 'dateInterviewed' && !['Awaiting Decision', 'Offer Received', 'Negotiating', 'Accepted', 'No Response', 'Rejected', 'Withdrawn'].includes(apps[idx].status)) {
                    apps[idx].status = 'Awaiting Decision';
                }

                saveApplications(apps);
                renderAll(apps);
            }
        }

        function toggleSection(appId, section) {
            const content = document.getElementById(`${section}-content-${appId}`);
            content.classList.toggle('show');
        }

        // Map timeline stage index to status
        function setTimelineStage(appId, stageIndex) {
            const stageToStatus = {
                0: 'Applied',
                1: 'Recruiter Screen',
                2: 'Technical Round',
                3: 'Final Round',
                4: 'Offer Received'
            };

            const newStatus = stageToStatus[stageIndex];
            if (!newStatus) return;

            const apps = getApplications();
            const idx = apps.findIndex(a => String(a.id) === String(appId));
            if (idx === -1) return;

            const app = apps[idx];
            const oldStatus = app.status;

            // Update status
            app.status = newStatus;
            app.lastUpdated = new Date().toISOString();

            // Update relevant dates if not already set
            const today = new Date().toISOString();
            if (stageIndex >= 0 && !app.dateApplied) {
                app.dateApplied = today;
            }
            if (stageIndex >= 1 && !app.dateInterviewed) {
                app.dateInterviewed = today;
            }
            if (stageIndex >= 2 && stageIndex <= 3) {
                // Track interview rounds - only count actual interview stages (2=Interview, 3=Final)
                // Don't overwrite if already tracking higher rounds
                const currentRounds = app.interviewRounds || 0;
                if (currentRounds === 0) {
                    app.interviewRounds = 1; // First interview round
                }
            }

            saveApplications(apps);
            renderAll(apps);
        }

        function saveNotes(appId, notes) {
            const apps = getApplications();
            const idx = apps.findIndex(a => String(a.id) === String(appId));

            if (idx !== -1) {
                apps[idx].notes = notes;
                saveApplications(apps);
            }
        }

        function saveJobDescription(appId, jobDescription) {
            const apps = getApplications();
            const idx = apps.findIndex(a => a.id === appId);

            if (idx !== -1) {
                apps[idx].jobDescription = jobDescription;
                saveApplications(apps);
            }
        }

        // ========================================================================
        // ARCHIVE MODAL
        // ========================================================================
        let archiveAppId = null;

        function showArchiveModal(appId) {
            archiveAppId = appId;
            document.getElementById('archiveReason').value = '';
            document.getElementById('archiveModal').classList.add('show');
        }

        function closeArchiveModal() {
            archiveAppId = null;
            document.getElementById('archiveModal').classList.remove('show');
        }

        function confirmArchive() {
            if (!archiveAppId) return;

            const reason = document.getElementById('archiveReason').value;
            const apps = getApplications();
            const idx = apps.findIndex(a => String(a.id) === String(archiveAppId));

            if (idx !== -1) {
                // Map archive reasons to appropriate statuses
                const reasonToStatus = {
                    'no_response': 'No Response',
                    'rejected': 'Rejected: Other',
                    'withdrew': 'Withdrawn',
                    'found_role': 'Accepted',
                    'not_interested': 'Withdrawn',
                    'role_closed': 'Rejected: Went Internal',
                    'other': 'Withdrawn'
                };

                apps[idx].status = reasonToStatus[reason] || 'Withdrawn';
                apps[idx].archiveReason = reason;
                apps[idx].archivedAt = new Date().toISOString();
                apps[idx].lastUpdated = new Date().toISOString();

                saveApplications(apps);
                closeArchiveModal();
                renderAll(apps);
            }
        }

        // ========================================================================
        // DELETE MODAL (for archived apps only)
        // ========================================================================
        let deleteAppId = null;

        function showDeleteModal(appId) {
            deleteAppId = appId;
            // Reset form
            document.getElementById('deleteReason').value = '';
            document.getElementById('deleteConfirmInput').value = '';
            document.getElementById('confirmDeleteBtn').disabled = true;
            document.getElementById('deleteModal').classList.add('show');
        }

        function closeDeleteModal() {
            deleteAppId = null;
            document.getElementById('deleteModal').classList.remove('show');
        }

        function validateDeleteConfirmation() {
            const reason = document.getElementById('deleteReason').value;
            const confirmText = document.getElementById('deleteConfirmInput').value;
            const deleteBtn = document.getElementById('confirmDeleteBtn');

            // Enable button only if reason selected AND DELETE typed correctly
            deleteBtn.disabled = !(reason && confirmText === 'DELETE');
        }

        async function confirmDelete() {
            const reason = document.getElementById('deleteReason').value;
            const confirmText = document.getElementById('deleteConfirmInput').value;

            if (!deleteAppId || !reason || confirmText !== 'DELETE') {
                return;
            }

            const idToDelete = deleteAppId;
            console.log('Deleting app with ID:', idToDelete);

            // Delete from Supabase first if available
            if (typeof HenryData !== 'undefined' && window.supabaseSession) {
                try {
                    const result = await HenryData.deleteApplication(idToDelete);
                    console.log('Delete from Supabase result:', result);
                    if (result.error) {
                        console.error('Supabase delete error:', result.error);
                    }
                } catch (err) {
                    console.error('Error deleting from Supabase:', err);
                }
            }

            // Remove from local cache
            const currentApps = getApplications();
            const filteredApps = currentApps.filter(a => String(a.id) !== String(idToDelete));
            console.log('Filtered from', currentApps.length, 'to', filteredApps.length, 'apps');

            // Update cache
            window.trackerAppsCache = filteredApps;

            // Update localStorage - make sure deleted app is removed
            localStorage.setItem('trackedApplications', JSON.stringify(filteredApps));

            // Also remove any associated analysis data
            const deletedApp = currentApps.find(a => String(a.id) === String(idToDelete));
            if (deletedApp && deletedApp.analysisKey) {
                localStorage.removeItem(deletedApp.analysisKey);
                console.log('Removed analysis data for:', deletedApp.analysisKey);
            }

            closeDeleteModal();
            renderAll(filteredApps);
        }

        // ========================================================================
        // REACH OUT MODAL
        // ========================================================================
        let reachOutAppId = null;
        let reachOutType = null;

        function showReachOutModal(appId) {
            reachOutAppId = appId;
            reachOutType = null;

            const app = getApplications().find(a => String(a.id) === String(appId));
            if (!app) return;

            // Update description with company name
            document.getElementById('reachOutDescription').textContent =
                `Select who you're reaching out to at ${app.company} and get a personalized message template.`;

            // Reset to step 1
            showReachOutStep1();
            document.getElementById('reachOutModal').classList.add('show');
        }

        function closeReachOutModal() {
            reachOutAppId = null;
            reachOutType = null;
            document.getElementById('reachOutModal').classList.remove('show');
        }

        function showReachOutStep1() {
            document.getElementById('reachOutStep1').style.display = 'block';
            document.getElementById('reachOutStep2').style.display = 'none';
            document.getElementById('reachOutStep3').style.display = 'none';
        }

        function selectReachOutType(type) {
            reachOutType = type;

            if (type === 'other') {
                // Show custom contact form
                document.getElementById('reachOutStep1').style.display = 'none';
                document.getElementById('reachOutStep2').style.display = 'block';
                document.getElementById('reachOutStep3').style.display = 'none';
                document.getElementById('reachOutContactName').value = '';
                document.getElementById('reachOutContactRole').value = '';
            } else {
                // Get pre-drafted message for HM or Recruiter
                showDraftedMessage(type);
            }
        }

        function showDraftedMessage(type) {
            const app = getApplications().find(a => String(a.id) === String(reachOutAppId));
            if (!app) return;

            let message = '';
            let label = '';

            // Try to get from outreach_intelligence in analysisData
            if (app.analysisData?.outreach_intelligence) {
                const outreach = app.analysisData.outreach_intelligence;
                if (type === 'hiring_manager' && outreach.hiring_manager_outreach_template) {
                    message = outreach.hiring_manager_outreach_template;
                    label = 'Message to Hiring Manager';
                } else if (type === 'recruiter' && outreach.recruiter_outreach_template) {
                    message = outreach.recruiter_outreach_template;
                    label = 'Message to Recruiter';
                }
            }

            // Try localStorage analysisKey if not found
            if (!message && app.analysisKey) {
                try {
                    const analysisData = JSON.parse(localStorage.getItem(app.analysisKey) || '{}');
                    if (analysisData.outreach_intelligence) {
                        const outreach = analysisData.outreach_intelligence;
                        if (type === 'hiring_manager' && outreach.hiring_manager_outreach_template) {
                            message = outreach.hiring_manager_outreach_template;
                            label = 'Message to Hiring Manager';
                        } else if (type === 'recruiter' && outreach.recruiter_outreach_template) {
                            message = outreach.recruiter_outreach_template;
                            label = 'Message to Recruiter';
                        }
                    }
                } catch (e) {
                    console.error('Error parsing analysis data:', e);
                }
            }

            // Fallback template if no drafted message found
            if (!message) {
                const templates = {
                    hiring_manager: `Hi [Name],

I recently applied for the ${app.role} position at ${app.company} and wanted to reach out directly.

I'm particularly excited about this opportunity because [specific reason related to the role/company].

With my background in [relevant experience], I believe I could contribute meaningfully to your team, especially in [specific area].

Would you be open to a brief conversation? I'd love to learn more about your vision for this role.

Best regards,
[Your name]`,
                    recruiter: `Hi [Name],

I recently applied for the ${app.role} position at ${app.company} and wanted to connect.

I'm very interested in this opportunity because [specific reason]. My background in [relevant experience] aligns well with what you're looking for.

Could you share any insights about the timeline or process? I'm happy to provide any additional information that would be helpful.

Thanks for your time!
[Your name]`
                };
                message = templates[type] || templates.hiring_manager;
                label = type === 'hiring_manager' ? 'Message to Hiring Manager' : 'Message to Recruiter';
            }

            // Show the message
            document.getElementById('reachOutMessageLabel').textContent = label;
            document.getElementById('reachOutMessage').value = message;

            document.getElementById('reachOutStep1').style.display = 'none';
            document.getElementById('reachOutStep2').style.display = 'none';
            document.getElementById('reachOutStep3').style.display = 'block';
        }

        function generateCustomMessage() {
            const contactName = document.getElementById('reachOutContactName').value.trim() || '[Name]';
            const contactRole = document.getElementById('reachOutContactRole').value.trim() || 'contact';

            const app = getApplications().find(a => String(a.id) === String(reachOutAppId));
            if (!app) return;

            const message = `Hi ${contactName},

I hope this message finds you well! I noticed you're a ${contactRole} at ${app.company}, and I wanted to reach out.

I recently applied for the ${app.role} position and I'm very excited about the opportunity. I'd love to learn more about the team and culture from your perspective.

Would you have a few minutes for a quick chat? I'd really appreciate any insights you could share.

Thanks so much!
[Your name]`;

            document.getElementById('reachOutMessageLabel').textContent = `Message to ${contactName}`;
            document.getElementById('reachOutMessage').value = message;

            document.getElementById('reachOutStep1').style.display = 'none';
            document.getElementById('reachOutStep2').style.display = 'none';
            document.getElementById('reachOutStep3').style.display = 'block';
        }

        function copyReachOutMessage() {
            const message = document.getElementById('reachOutMessage').value;
            navigator.clipboard.writeText(message).then(() => {
                // Show feedback
                const btn = event.target;
                const originalText = btn.textContent;
                btn.textContent = 'âœ“ Copied!';
                btn.style.background = 'var(--color-active)';
                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.style.background = '';
                }, 2000);
            }).catch(err => {
                console.error('Failed to copy:', err);
                alert('Failed to copy. Please select and copy manually.');
            });
        }

        function markReachOutComplete() {
            if (!reachOutAppId) return;

            const apps = getApplications();
            const idx = apps.findIndex(a => String(a.id) === String(reachOutAppId));

            if (idx !== -1) {
                apps[idx].dateReachedOut = new Date().toISOString();
                apps[idx].lastUpdated = new Date().toISOString();

                // Update status if appropriate
                if (['Preparing', 'Applied'].includes(apps[idx].status)) {
                    apps[idx].status = 'Networking';
                }

                saveApplications(apps);
                closeReachOutModal();
                renderAll(apps);
            }
        }

        // ========================================================================
        // DATE EDIT MODAL
        // ========================================================================
        let dateEditAppId = null;

        function showDateEditModal(appId) {
            console.log('showDateEditModal called with:', appId);
            dateEditAppId = appId;
            const allApps = getApplications();
            console.log('getApplications returned:', allApps.length, 'apps');
            console.log('App IDs in cache:', allApps.map(a => a.id));
            console.log('Looking for ID:', appId);
            const app = allApps.find(a => String(a.id) === String(appId));
            if (!app) {
                console.error('App not found for id:', appId);
                console.error('Available IDs:', allApps.map(a => ({ id: a.id, company: a.company })));
                return;
            }
            console.log('Found app:', app.company, app.role);

            const today = new Date().toISOString().split('T')[0];

            // Build date edit form
            const content = document.getElementById('dateEditContent');
            const daysSinceApplied = app.dateApplied ? getDaysSince(app.dateApplied) : null;
            const isGhostRisk = daysSinceApplied && daysSinceApplied >= 14 &&
                               ['Applied', 'Networking'].includes(app.status);

            content.innerHTML = `
                <div class="date-field-group">
                    <label class="date-field-label">When did you apply?</label>
                    <input type="date" class="date-field-input" id="editDateApplied"
                           value="${app.dateApplied ? app.dateApplied.split('T')[0] : ''}"
                           max="${today}">
                    ${daysSinceApplied !== null ? `<div style="margin-top: 6px; font-size: 0.8rem; color: var(--color-text-muted);">${daysSinceApplied} days ago</div>` : ''}
                </div>

                ${isGhostRisk ? `
                <div class="date-warning">
                    <div class="date-warning-icon">âš ï¸</div>
                    <div class="date-warning-text">
                        <strong>Ghost Risk Detected:</strong> ${daysSinceApplied} days with no response.
                        At this stage, you've likely been ghosted. Consider archiving or sending a final follow-up.
                    </div>
                </div>
                ` : ''}

                <div class="timeline-edit-section">
                    <div class="timeline-edit-title">
                        <span>ðŸ“Š</span> Full Timeline
                    </div>
                    <div class="timeline-date-row">
                        <span class="timeline-date-label">Added to tracker</span>
                        <div class="timeline-date-value">
                            <input type="date" id="editDateAdded"
                                   value="${app.dateAdded ? app.dateAdded.split('T')[0] : ''}"
                                   max="${today}">
                        </div>
                    </div>
                    <div class="timeline-date-row">
                        <span class="timeline-date-label">Reached out</span>
                        <div class="timeline-date-value">
                            <input type="date" id="editDateReachedOut"
                                   value="${app.dateReachedOut ? app.dateReachedOut.split('T')[0] : ''}"
                                   max="${today}">
                            ${app.dateReachedOut ? `<button class="clear-date-btn" onclick="document.getElementById('editDateReachedOut').value=''">âœ•</button>` : ''}
                        </div>
                    </div>
                    <div class="timeline-date-row">
                        <span class="timeline-date-label">First interview</span>
                        <div class="timeline-date-value">
                            <input type="date" id="editDateInterviewed"
                                   value="${app.dateInterviewed ? app.dateInterviewed.split('T')[0] : ''}"
                                   max="${today}">
                            ${app.dateInterviewed ? `<button class="clear-date-btn" onclick="document.getElementById('editDateInterviewed').value=''">âœ•</button>` : ''}
                        </div>
                    </div>
                    <div class="timeline-date-row">
                        <span class="timeline-date-label">Last activity</span>
                        <div class="timeline-date-value">
                            <input type="date" id="editLastUpdated"
                                   value="${app.lastUpdated ? app.lastUpdated.split('T')[0] : ''}"
                                   max="${today}">
                        </div>
                    </div>
                    <div class="timeline-date-row">
                        <span class="timeline-date-label">Interview rounds completed</span>
                        <div class="timeline-date-value">
                            <input type="number" id="editInterviewRounds"
                                   value="${app.interviewRounds || 0}"
                                   min="0" max="20"
                                   style="width: 60px; text-align: center;">
                        </div>
                    </div>
                </div>
            `;

            // Add date change listener to update warning dynamically
            const dateAppliedInput = document.getElementById('editDateApplied');
            dateAppliedInput.addEventListener('change', () => {
                const newDate = dateAppliedInput.value;
                if (newDate) {
                    const days = getDaysSince(newDate);
                    const warningDiv = content.querySelector('.date-warning');
                    if (days >= 14 && ['Applied', 'Networking'].includes(app.status)) {
                        if (!warningDiv) {
                            const warning = document.createElement('div');
                            warning.className = 'date-warning';
                            warning.innerHTML = `
                                <div class="date-warning-icon">âš ï¸</div>
                                <div class="date-warning-text">
                                    <strong>Ghost Risk Detected:</strong> ${days} days with no response.
                                    At this stage, you've likely been ghosted. Consider archiving or sending a final follow-up.
                                </div>
                            `;
                            content.querySelector('.date-field-group').after(warning);
                        } else {
                            warningDiv.querySelector('.date-warning-text').innerHTML = `
                                <strong>Ghost Risk Detected:</strong> ${days} days with no response.
                                At this stage, you've likely been ghosted. Consider archiving or sending a final follow-up.
                            `;
                        }
                    } else if (warningDiv) {
                        warningDiv.remove();
                    }
                }
            });

            document.getElementById('dateEditModal').classList.add('show');
        }

        function closeDateEditModal() {
            dateEditAppId = null;
            document.getElementById('dateEditModal').classList.remove('show');
        }

        function saveDateEdits() {
            if (!dateEditAppId) return;

            const apps = getApplications();
            const idx = apps.findIndex(a => String(a.id) === String(dateEditAppId));
            if (idx === -1) return;

            // Get values from form
            const dateApplied = document.getElementById('editDateApplied').value;
            const dateAdded = document.getElementById('editDateAdded').value;
            const dateReachedOut = document.getElementById('editDateReachedOut').value;
            const dateInterviewed = document.getElementById('editDateInterviewed').value;
            const lastUpdated = document.getElementById('editLastUpdated').value;
            const interviewRounds = parseInt(document.getElementById('editInterviewRounds').value) || 0;

            // Helper to convert date input (YYYY-MM-DD) to ISO string preserving the date
            // Using noon local time to avoid timezone shifts
            function dateInputToISO(dateStr) {
                if (!dateStr) return null;
                // Parse as local date at noon to avoid timezone shifts
                const [year, month, day] = dateStr.split('-').map(Number);
                const date = new Date(year, month - 1, day, 12, 0, 0);
                return date.toISOString();
            }

            // Update application - use helper to preserve dates
            if (dateApplied) apps[idx].dateApplied = dateInputToISO(dateApplied);
            else delete apps[idx].dateApplied;

            if (dateAdded) apps[idx].dateAdded = dateInputToISO(dateAdded);

            if (dateReachedOut) apps[idx].dateReachedOut = dateInputToISO(dateReachedOut);
            else delete apps[idx].dateReachedOut;

            if (dateInterviewed) apps[idx].dateInterviewed = dateInputToISO(dateInterviewed);
            else delete apps[idx].dateInterviewed;

            if (lastUpdated) apps[idx].lastUpdated = dateInputToISO(lastUpdated);

            apps[idx].interviewRounds = interviewRounds;

            saveApplications(apps);
            closeDateEditModal();
            renderAll(apps);
        }

        // ========================================================================
        // SCHEDULE INTERVIEW MODAL
        // ========================================================================
        let selectedInterviewAppId = null;

        function openScheduleInterviewModal(appId = null) {
            const modal = document.getElementById('scheduleInterviewModal');
            const select = document.getElementById('interviewAppSelect');
            const proceedBtn = document.getElementById('proceedInterviewBtn');

            // Populate the select with active applications
            const apps = getApplications().filter(a => STATUSES[a.status]?.active);
            select.innerHTML = '<option value="">-- Select an application --</option>' +
                apps.map(app => `<option value="${app.id}">${app.company} - ${app.role}</option>`).join('');

            // If a specific app was passed, pre-select it
            if (appId) {
                select.value = appId;
                selectedInterviewAppId = appId;
                proceedBtn.disabled = false;
            } else {
                selectedInterviewAppId = null;
                proceedBtn.disabled = true;
            }

            // Listen for selection changes
            select.onchange = function() {
                selectedInterviewAppId = this.value || null;
                proceedBtn.disabled = !selectedInterviewAppId;
            };

            modal.classList.add('show');
        }

        function closeScheduleInterviewModal() {
            selectedInterviewAppId = null;
            document.getElementById('scheduleInterviewModal').classList.remove('show');
        }

        function createNewInterview() {
            // Navigate to Interview Intelligence without any context (manual entry)
            closeScheduleInterviewModal();
            window.location.href = 'interview-intelligence.html';
        }

        function proceedToInterviewIntelligence() {
            if (!selectedInterviewAppId) return;

            const apps = getApplications();
            const app = apps.find(a => String(a.id) === String(selectedInterviewAppId));
            if (!app) return;

            // Store context for the interview form
            const interviewContext = {
                company: app.company,
                role: app.role,
                jobDescription: app.notes || '',
                appId: app.id
            };
            sessionStorage.setItem('pendingInterviewContext', JSON.stringify(interviewContext));

            // Also load analysis data if available
            if (app.analysisKey) {
                const analysisData = localStorage.getItem(app.analysisKey);
                if (analysisData) {
                    sessionStorage.setItem('analysisData', analysisData);
                }
            }

            closeScheduleInterviewModal();
            window.location.href = 'interview-intelligence.html';
        }

        // Navigate directly to Interview Intelligence with app context
        // This should NOT open the add modal - just navigate to view existing interviews
        function navigateToInterviewIntelligence(appId) {
            const apps = getApplications();
            const app = apps.find(a => a.id === appId);
            if (!app) return;

            // Clear any pending context so the modal doesn't open
            sessionStorage.removeItem('pendingInterviewContext');

            // Load analysis data if available (for prep guide context)
            if (app.analysisKey) {
                const analysisData = localStorage.getItem(app.analysisKey);
                if (analysisData) {
                    sessionStorage.setItem('analysisData', analysisData);
                }
            }

            // Store the app context so Interview Intelligence knows which app to focus on
            sessionStorage.setItem('interviewAppContext', JSON.stringify({
                company: app.company,
                role: app.role,
                appId: app.id
            }));

            window.location.href = 'interview-intelligence.html';
        }

        // Add "Schedule Interview" to contextual actions for interview stages
        function scheduleInterviewForApp(appId) {
            openScheduleInterviewModal(appId);
        }

        // Close dropdowns when clicking outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.status-selector')) {
                document.querySelectorAll('.status-dropdown').forEach(d => d.classList.remove('show'));
            }
        });

        // ========================================================================
        // VIEW TOGGLE
        // ========================================================================
        function switchView(view) {
            // Update button states
            document.querySelectorAll('.view-toggle-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.view === view) {
                    btn.classList.add('active');
                }
            });

            // Show/hide view sections
            document.getElementById('prioritiesView').classList.toggle('active', view === 'priorities');
            document.getElementById('detailsView').classList.toggle('active', view === 'details');
        }

        // ========================================================================
        // FILTER HANDLERS
        // ========================================================================
        document.getElementById('filterStatus').addEventListener('change', (e) => {
            currentStatusFilter = e.target.value;
            renderApplications(getApplications());
        });

        document.getElementById('filterFit').addEventListener('change', (e) => {
            currentFitFilter = e.target.value;
            renderApplications(getApplications());
        });

        document.getElementById('sortBy').addEventListener('change', (e) => {
            currentSort = e.target.value;
            renderApplications(getApplications());
        });

        document.getElementById('confirmDeleteBtn').addEventListener('click', confirmDelete);
        document.getElementById('confirmArchiveBtn').addEventListener('click', confirmArchive);

        // Add validation listeners for delete confirmation
        document.getElementById('deleteReason').addEventListener('change', validateDeleteConfirmation);
        document.getElementById('deleteConfirmInput').addEventListener('input', validateDeleteConfirmation);

        // ========================================================================
        // BULK SELECT MODE
        // ========================================================================
        let bulkSelectMode = false;
        let selectedAppIds = new Set();

        function toggleBulkSelectMode() {
            bulkSelectMode = !bulkSelectMode;
            const btn = document.getElementById('bulkSelectToggle');
            const bar = document.getElementById('bulkActionsBar');

            if (bulkSelectMode) {
                btn.classList.add('active');
                btn.textContent = 'âœ“ Select Mode ON';
                bar.style.display = 'flex';
                selectedAppIds.clear();
                updateSelectedCount();
                // Add select-mode class to all cards
                document.querySelectorAll('.app-card').forEach(card => {
                    card.classList.add('select-mode');
                });
            } else {
                exitBulkSelectMode();
            }
        }

        function exitBulkSelectMode() {
            bulkSelectMode = false;
            selectedAppIds.clear();
            const btn = document.getElementById('bulkSelectToggle');
            const bar = document.getElementById('bulkActionsBar');

            btn.classList.remove('active');
            btn.textContent = 'â˜‘ï¸ Select Multiple';
            bar.style.display = 'none';
            document.getElementById('selectAllCheckbox').checked = false;

            // Remove select-mode and selected classes from all cards
            document.querySelectorAll('.app-card').forEach(card => {
                card.classList.remove('select-mode', 'selected');
            });
        }

        function toggleCardSelection(appId) {
            if (!bulkSelectMode) return;

            const card = document.querySelector(`.app-card[data-id="${appId}"]`);
            if (!card) return;

            if (selectedAppIds.has(appId)) {
                selectedAppIds.delete(appId);
                card.classList.remove('selected');
            } else {
                selectedAppIds.add(appId);
                card.classList.add('selected');
            }

            updateSelectedCount();
            updateSelectAllCheckbox();
        }

        function toggleSelectAll() {
            // Get the source checkbox (could be from bulk bar or table header)
            const bulkCheckbox = document.getElementById('selectAllCheckbox');
            const tableCheckbox = document.getElementById('tableSelectAll');

            // Determine if we're selecting or deselecting
            const isSelecting = bulkCheckbox?.checked || tableCheckbox?.checked;

            if (currentViewMode === 'table') {
                // Table view - select all visible rows
                const rows = document.querySelectorAll('#tableBody tr[data-id]');
                if (isSelecting) {
                    rows.forEach(row => {
                        const id = row.dataset.id;
                        selectedAppIds.add(id);
                        row.classList.add('selected');
                        const checkbox = row.querySelector('input[type="checkbox"]');
                        if (checkbox) checkbox.checked = true;
                    });
                } else {
                    selectedAppIds.clear();
                    rows.forEach(row => {
                        row.classList.remove('selected');
                        const checkbox = row.querySelector('input[type="checkbox"]');
                        if (checkbox) checkbox.checked = false;
                    });
                }
            } else {
                // Card view
                const cards = document.querySelectorAll('.app-card.select-mode');
                if (isSelecting) {
                    cards.forEach(card => {
                        const id = card.dataset.id;
                        selectedAppIds.add(id);
                        card.classList.add('selected');
                    });
                } else {
                    selectedAppIds.clear();
                    cards.forEach(card => {
                        card.classList.remove('selected');
                    });
                }
            }

            // Sync both checkboxes
            if (bulkCheckbox) bulkCheckbox.checked = isSelecting;
            if (tableCheckbox) tableCheckbox.checked = isSelecting;

            // Show/hide bulk actions bar
            document.getElementById('bulkActionsBar').style.display = selectedAppIds.size > 0 ? 'flex' : 'none';

            updateSelectedCount();
        }

        function updateSelectAllCheckbox() {
            const bulkCheckbox = document.getElementById('selectAllCheckbox');
            const tableCheckbox = document.getElementById('tableSelectAll');

            let totalItems = 0;
            if (currentViewMode === 'table') {
                totalItems = document.querySelectorAll('#tableBody tr[data-id]').length;
            } else {
                totalItems = document.querySelectorAll('.app-card.select-mode').length;
            }

            const allSelected = selectedAppIds.size === totalItems && totalItems > 0;
            if (bulkCheckbox) bulkCheckbox.checked = allSelected;
            if (tableCheckbox) tableCheckbox.checked = allSelected;
        }

        function updateSelectedCount() {
            document.getElementById('selectedCount').textContent = `${selectedAppIds.size} selected`;
        }

        async function bulkArchive() {
            if (selectedAppIds.size === 0) {
                alert('No applications selected');
                return;
            }

            const count = selectedAppIds.size;
            if (!confirm(`Archive ${count} application${count > 1 ? 's' : ''}? They will be marked as "No Response".`)) {
                return;
            }

            const apps = getApplications();
            const idsToArchive = Array.from(selectedAppIds);

            for (const id of idsToArchive) {
                const idx = apps.findIndex(a => String(a.id) === String(id));
                if (idx !== -1) {
                    apps[idx].status = 'No Response';
                    apps[idx].archivedAt = new Date().toISOString();
                    apps[idx].lastUpdated = new Date().toISOString();
                }
            }

            saveApplications(apps);
            exitBulkSelectMode();
            renderAll(apps);

            alert(`Archived ${count} application${count > 1 ? 's' : ''}.`);
        }

        async function bulkDelete() {
            if (selectedAppIds.size === 0) {
                alert('No applications selected');
                return;
            }

            const count = selectedAppIds.size;
            const confirmMsg = `Permanently delete ${count} application${count > 1 ? 's' : ''}?\n\nThis cannot be undone. Type "DELETE" to confirm.`;
            const userInput = prompt(confirmMsg);

            if (userInput !== 'DELETE') {
                alert('Deletion cancelled.');
                return;
            }

            const idsToDelete = Array.from(selectedAppIds);

            // Delete from Supabase if available
            if (typeof HenryData !== 'undefined' && window.supabaseSession) {
                for (const id of idsToDelete) {
                    try {
                        await HenryData.deleteApplication(id);
                    } catch (err) {
                        console.error('Error deleting from Supabase:', id, err);
                    }
                }
            }

            // Remove from local cache and localStorage
            const apps = getApplications().filter(a => !idsToDelete.includes(String(a.id)));
            window.trackerAppsCache = apps;
            localStorage.setItem('trackedApplications', JSON.stringify(apps));

            exitBulkSelectMode();
            renderAll(apps);

            alert(`Deleted ${count} application${count > 1 ? 's' : ''}.`);
        }

        // Add click handler for card selection in bulk mode
        document.addEventListener('click', function(e) {
            if (!bulkSelectMode) return;

            const card = e.target.closest('.app-card');
            if (!card) return;

            // Don't select if clicking on interactive elements
            if (e.target.closest('button, select, input, a, .status-dropdown')) return;

            toggleCardSelection(card.dataset.id);
        });

        // ========================================================================
        // PATTERN ALERT RENDERING
        // ========================================================================
        function renderPatternAlert(apps) {
            const pattern = detectRejectionPattern(apps);
            const existingAlert = document.getElementById('patternAlert');

            // Remove existing alert if present
            if (existingAlert) {
                existingAlert.remove();
            }

            // Only show if pattern detected (3+ pre-interview rejections)
            if (!pattern) return;

            const alertHtml = `
                <div class="pattern-alert" id="patternAlert">
                    <div class="pattern-alert-header">
                        <span>âš ï¸</span>
                        <span class="pattern-alert-title">Pattern Detected: ${pattern.count} Pre-Interview Rejections</span>
                    </div>
                    <div class="pattern-alert-content">
                        ${pattern.primaryPattern}
                    </div>
                    <div class="pattern-recommendations">
                        <ul>
                            ${pattern.recommendations.map(rec => `<li>${rec}</li>`).join('')}
                        </ul>
                    </div>
                </div>
            `;

            // Insert after strategic priorities or after pipeline dashboard
            const priorities = document.getElementById('strategicPriorities');
            if (priorities.style.display !== 'none') {
                priorities.insertAdjacentHTML('afterend', alertHtml);
            } else {
                document.getElementById('pipelineDashboard').insertAdjacentHTML('afterend', alertHtml);
            }
        }

        // ========================================================================
        // EMPATHY & ADAPTIVE MESSAGING SYSTEM
        // ========================================================================
        // These functions adapt tone and messaging based on the user's emotional state,
        // timeline urgency, and confidence level captured during profile onboarding.
        // ========================================================================

        /**
         * Load user profile with situation data
         */
        function getUserProfile() {
            try {
                const profile = localStorage.getItem('userProfile');
                return profile ? JSON.parse(profile) : null;
            } catch (err) {
                console.error('Error loading user profile:', err);
                return null;
            }
        }

        /**
         * Get empathetic greeting based on emotional state and timeline
         */
        function getPulseGreeting(profile, apps) {
            if (!profile || !profile.situation) {
                // Fallback if no profile data
                const activeCount = apps.filter(a => STATUSES[a.status]?.active).length;
                return `You have ${activeCount} active application${activeCount !== 1 ? 's' : ''}. Here's what needs attention today.`;
            }

            const { holding_up, timeline } = profile.situation;
            const activeCount = apps.filter(a => STATUSES[a.status]?.active).length;
            const hotCount = apps.filter(a => a.status === 'Hot').length;

            // Count interviews this week
            const interviewsThisWeek = apps.filter(a => {
                if (!a.interviewDate) return false;
                const date = new Date(a.interviewDate);
                const today = new Date();
                const weekFromNow = new Date(today.getTime() + 7 * 24 * 60 * 60 * 1000);
                return date >= today && date <= weekFromNow;
            }).length;

            // Crushed state (override everything)
            if (holding_up === 'crushed') {
                if (activeCount === 0) {
                    return "I know this is brutal. Let's get some applications moving.";
                }
                return `I know this is brutal. You have ${activeCount} active application${activeCount !== 1 ? 's' : ''}. Let's make sure each one gets follow-up.`;
            }

            // Desperate + urgent
            if (holding_up === 'desperate' && timeline === 'urgent') {
                if (interviewsThisWeek > 0) {
                    return `Let's focus. You have ${interviewsThisWeek} interview${interviewsThisWeek !== 1 ? 's' : ''} this week and ${hotCount} hot application${hotCount !== 1 ? 's' : ''}. Here's your priority list.`;
                }
                return `Let's focus. You have ${activeCount} application${activeCount !== 1 ? 's' : ''} moving. Here's what needs attention today.`;
            }

            // Desperate (without urgent timeline)
            if (holding_up === 'desperate') {
                return `You've got ${activeCount} application${activeCount !== 1 ? 's' : ''} moving. Let's make sure nothing slips through the cracks.`;
            }

            // Stressed + active
            if (holding_up === 'stressed' && timeline === 'active') {
                return `You've got ${activeCount} application${activeCount !== 1 ? 's' : ''} moving. Here's what needs attention so nothing slips.`;
            }

            // Stressed (without active timeline)
            if (holding_up === 'stressed') {
                return `You have ${activeCount} active application${activeCount !== 1 ? 's' : ''}. Here's what's happening in your pipeline.`;
            }

            // Zen + exploring
            if (holding_up === 'zen' && timeline === 'exploring') {
                return `You've got ${activeCount} active application${activeCount !== 1 ? 's' : ''}. No rush. Let's keep the bar high.`;
            }

            // Zen (without exploring)
            if (holding_up === 'zen') {
                return `${activeCount} application${activeCount !== 1 ? 's are' : ' is'} active. Things are looking solid.`;
            }

            // Clock ticking (urgent timeline)
            if (timeline === 'clock_ticking') {
                return `Time matters. You have ${activeCount} application${activeCount !== 1 ? 's' : ''} active. Here's what requires immediate action.`;
            }

            // Urgent timeline
            if (timeline === 'urgent') {
                return `You have ${activeCount} active application${activeCount !== 1 ? 's' : ''}. Let's prioritize what moves fastest.`;
            }

            // Default (covers other combinations)
            return `You have ${activeCount} active application${activeCount !== 1 ? 's' : ''}. Here's what needs attention today.`;
        }

        /**
         * Get adaptive priority action message based on situation
         */
        function getAdaptivePriorityAction(profile, apps, upcomingInterviews, followUpsDue, activeApps) {
            const { holding_up, timeline } = profile?.situation || {};

            // Priority 1: Upcoming interviews
            if (upcomingInterviews.length > 0) {
                const nextInterview = upcomingInterviews[0];
                return `
                    <span class="pulse-action-text">
                        <strong>Priority:</strong> Prepare for your ${nextInterview.status.toLowerCase()} at ${nextInterview.company}
                    </span>
                    <a href="interview-intelligence.html" class="pulse-action-btn">Prep Now</a>
                `;
            }

            // Priority 2: Follow-ups
            if (followUpsDue.length > 0) {
                const oldestFollowUp = followUpsDue.sort((a, b) =>
                    new Date(a.dateApplied || a.dateAdded) - new Date(b.dateApplied || b.dateAdded)
                )[0];
                const daysSince = getDaysSince(oldestFollowUp.dateApplied || oldestFollowUp.dateAdded);

                // Adapt tone based on timeline urgency
                let actionText = `<strong>Priority:</strong> Follow up with ${oldestFollowUp.company} (${daysSince} days since applying)`;
                if (timeline === 'clock_ticking' || timeline === 'urgent') {
                    actionText = `<strong>Action needed:</strong> ${oldestFollowUp.company} hasn't responded in ${daysSince} days. Follow up now.`;
                }

                return `
                    <span class="pulse-action-text">${actionText}</span>
                    <button class="pulse-action-btn" onclick="navigateWithAnalysis('${oldestFollowUp.id}', 'outreach.html')">Draft Follow-up</button>
                `;
            }

            // Priority 3: Pipeline too thin
            if (activeApps.length < 5) {
                // Adapt messaging based on emotional state
                let suggestionText = '';
                let buttonText = 'Analyze New Role';

                if (holding_up === 'zen' && timeline === 'exploring') {
                    suggestionText = `<strong>Suggestion:</strong> Your pipeline has ${activeApps.length} active apps. Room to add higher-quality matches.`;
                } else if (timeline === 'clock_ticking' || holding_up === 'desperate') {
                    suggestionText = `<strong>Pipeline thin:</strong> Only ${activeApps.length} active apps. You need more options. Broaden your search.`;
                    buttonText = 'Find More Roles';
                } else if (holding_up === 'stressed' || timeline === 'urgent') {
                    suggestionText = `<strong>Pipeline check:</strong> ${activeApps.length} active apps. Consider adding 2-3 more to strengthen your position.`;
                } else {
                    suggestionText = `<strong>Suggestion:</strong> Your pipeline has ${activeApps.length} active apps. Consider adding more to increase your odds.`;
                }

                return `
                    <span class="pulse-action-text">${suggestionText}</span>
                    <a href="analyze.html" class="pulse-action-btn">${buttonText}</a>
                `;
            }

            // Priority 4: Pipeline healthy
            let encouragementText = '';
            if (holding_up === 'crushed' || holding_up === 'desperate') {
                encouragementText = `<strong>Keep pushing:</strong> ${activeApps.length} active applications. You're doing the work.`;
            } else if (holding_up === 'stressed') {
                encouragementText = `<strong>On track:</strong> ${activeApps.length} active applications in your pipeline. Keep the momentum going.`;
            } else {
                encouragementText = `<strong>Looking good!</strong> ${activeApps.length} active applications in your pipeline. Keep the momentum going.`;
            }

            return `
                <span class="pulse-action-text">${encouragementText}</span>
                <a href="analyze.html" class="pulse-action-btn">Add Another</a>
            `;
        }

        // ========================================================================
        // ADAPTIVE EMPATHY - STALLED APPS MESSAGING (Phase 2)
        // ========================================================================
        /**
         * Get adaptive message for stalled applications
         */
        function getStalledAppsMessage(stalledApps, situation) {
            if (!situation) {
                return `${stalledApps.length} application${stalledApps.length !== 1 ? 's' : ''} haven't moved in 14+ days. Consider following up or deprioritizing.`;
            }

            const { holding_up, timeline } = situation;
            const count = stalledApps.length;
            const days = Math.max(...stalledApps.map(a => getDaysSince(a.dateApplied || a.dateAdded)));

            if (holding_up === 'crushed') {
                return `${count} application${count !== 1 ? 's' : ''} ghosted you at ${days}+ days. That's on them, not you. Let's focus on the ones that are responding.`;
            }

            if (timeline === 'clock_ticking' || timeline === 'urgent') {
                const activeCount = stalledApps.filter(a => STATUSES[a.status]?.active).length;
                return `${count} application${count !== 1 ? 's' : ''} dead at ${days}+ days with no response. Recommendation: deprioritize and focus on the ${activeCount} that are actually moving.`;
            }

            if (holding_up === 'stressed') {
                return `${count} application${count !== 1 ? 's' : ''} stalled at ${days}+ days. Quick check: are these still worth pursuing, or should we focus energy elsewhere?`;
            }

            // Default (zen/exploring)
            return `${count} application${count !== 1 ? 's' : ''} stalled at ${days}+ days. Not urgent, but worth deciding. Follow up or deprioritize?`;
        }

        // ========================================================================
        // ADAPTIVE EMPATHY - STRATEGIC RECOMMENDATIONS (Phase 2)
        // ========================================================================
        /**
         * Get strategic recommendations based on profile situation
         * Returns array of recommendation objects with type, message, and action
         */
        function getStrategicRecommendations(apps, profile) {
            if (!profile || !profile.situation) {
                return [];
            }

            const { holding_up, timeline, confidence } = profile.situation;
            const activeApps = apps.filter(a => STATUSES[a.status]?.active);
            const lowFitCount = activeApps.filter(a => a.fitScore && a.fitScore < 70).length;
            const recommendations = [];

            // Timeline-based pacing recommendations
            if (timeline === 'exploring') {
                recommendations.push({
                    type: 'pacing',
                    message: 'Target pace: 2-3 high-quality applications per week.',
                    action: 'Focus on 85%+ fit roles'
                });
            } else if (timeline === 'active') {
                const pacingAdvice = activeApps.length < 5 ? 'Need to accelerate. Find more matches' : 'On track';
                recommendations.push({
                    type: 'pacing',
                    message: 'Target pace: 5-7 applications per week.',
                    action: pacingAdvice
                });
            } else if (timeline === 'urgent') {
                const pacingAdvice = activeApps.length < 8 ? 'Falling behind. Broaden to 65%+ fit roles' : 'Keep pushing';
                recommendations.push({
                    type: 'pacing',
                    message: 'Target pace: 8-10 applications per week.',
                    action: pacingAdvice
                });
            } else if (timeline === 'clock_ticking') {
                recommendations.push({
                    type: 'pacing',
                    message: 'Survival mode: apply to everything 60%+ fit.',
                    action: 'Follow up on everything 7+ days old, reach out directly to hiring managers'
                });
            }

            // Fit quality check for stressed/desperate candidates
            if (lowFitCount > 5 && (holding_up === 'desperate' || holding_up === 'stressed')) {
                recommendations.push({
                    type: 'quality',
                    message: `You have ${lowFitCount} applications under 70% fit. You might be mass-applying out of anxiety.`,
                    action: 'Let\'s recalibrate and focus on stronger matches'
                });
            }

            // Confidence-based positioning
            if (confidence === 'low' && activeApps.length > 0) {
                recommendations.push({
                    type: 'mindset',
                    message: 'You wouldn\'t have these interviews if they didn\'t think you could do the job.',
                    action: 'Review your strengths before each interview'
                });
            }

            return recommendations;
        }

        // ========================================================================
        // DAILY PULSE BANNER
        // ========================================================================
        /**
         * MODIFIED renderDailyPulse function - integrates empathy-driven messaging
         */
        function renderDailyPulse(apps) {
            const pulseEl = document.getElementById('dailyPulse');

            // Element may not exist if removed from HTML - skip if so
            if (!pulseEl) {
                return;
            }

            // Only show if there are active applications
            const activeApps = apps.filter(a => STATUSES[a.status]?.active);
            if (activeApps.length === 0) {
                pulseEl.style.display = 'none';
                return;
            }

            pulseEl.style.display = 'block';

            // Load user profile for adaptive messaging
            const profile = getUserProfile();

            // Set greeting based on profile situation (or fallback to time-based)
            if (profile && profile.situation) {
                const greeting = getPulseGreeting(profile, apps);
                document.getElementById('pulseGreeting').textContent = greeting;
            } else {
                // Fallback to time-based greeting if no profile
                const hour = new Date().getHours();
                let greeting = 'Good morning';
                if (hour >= 12 && hour < 17) greeting = 'Good afternoon';
                else if (hour >= 17) greeting = 'Good evening';
                document.getElementById('pulseGreeting').textContent = `${greeting}! Here's your job search pulse:`;
            }

            // Count active apps
            document.getElementById('pulseActive').textContent = activeApps.length;

            // Count follow-ups due (applied 5+ days ago without progress)
            const followUpsDue = apps.filter(a => {
                const daysSince = getDaysSince(a.dateApplied || a.dateAdded);
                return ['Applied', 'Networking'].includes(a.status) && daysSince >= 5;
            });
            const followUpStat = document.getElementById('pulseFollowUpStat');
            if (followUpsDue.length > 0) {
                document.getElementById('pulseFollowUps').textContent = followUpsDue.length;
                followUpStat.style.display = 'flex';
            } else {
                followUpStat.style.display = 'none';
            }

            // Count upcoming interviews (interviewing statuses)
            const interviewingStatuses = ['Recruiter Screen', 'Hiring Manager', 'Technical Round',
                                          'Panel Interview', 'Final Round', 'Executive Interview'];
            const upcomingInterviews = apps.filter(a => interviewingStatuses.includes(a.status));
            const interviewStat = document.getElementById('pulseInterviewStat');
            if (upcomingInterviews.length > 0) {
                document.getElementById('pulseInterviews').textContent = upcomingInterviews.length;
                interviewStat.style.display = 'flex';
            } else {
                interviewStat.style.display = 'none';
            }

            // Determine priority action with adaptive messaging
            const pulseAction = document.getElementById('pulseAction');
            const actionHtml = getAdaptivePriorityAction(profile, apps, upcomingInterviews, followUpsDue, activeApps);
            pulseAction.innerHTML = actionHtml;
        }

        // ========================================================================
        // COMMAND CENTER v2.0 FUNCTIONS
        // ========================================================================

        // State
        let commandCenterIntelligence = null;
        let focusModeEnabled = false;
        let currentCommandCenterView = 'board';

        /**
         * Initialize Command Center with backend intelligence
         */
        async function initCommandCenter(apps) {
            // Handle empty state
            if (!apps || apps.length === 0) {
                console.log('[CommandCenter] No apps to analyze');
                showEmptyState();
                return;
            }

            // Show loading state
            showLoadingSkeleton();

            try {
                // Get user ID from localStorage or Supabase session
                const userId = localStorage.getItem('userId') || 'anonymous';

                // Fetch intelligence from backend
                commandCenterIntelligence = await CommandCenter.fetchIntelligence(userId, apps);

                // Hide loading state
                hideStateOverlays();

                // Render Command Center components
                renderDailyPulseV2(commandCenterIntelligence);
                renderBoardView(apps, commandCenterIntelligence);
                checkAndShowStrategicStop(commandCenterIntelligence);

                // Show Command Center UI
                document.getElementById('dailyPulseV2').style.display = 'block';
                document.getElementById('commandCenterViewSelector').parentElement.style.display = 'flex';

                // Set default view
                setCommandCenterView('board');

                // Persist intelligence to Supabase (async, don't wait)
                batchPersistIntelligence(commandCenterIntelligence).catch(err => {
                    console.warn('[CommandCenter] Background persist failed:', err);
                });

            } catch (error) {
                console.error('[CommandCenter] Init failed:', error);
                showErrorState('Unable to load pipeline intelligence. Please try again.');
            }
        }

        /**
         * Render Daily Pulse v2 with backend intelligence
         */
        function renderDailyPulseV2(intelligence) {
            if (!intelligence) return;

            const pulseEl = document.getElementById('dailyPulseV2');
            if (!pulseEl) return;

            // Set greeting
            const hour = new Date().getHours();
            let greeting = 'Good morning';
            if (hour >= 12 && hour < 17) greeting = 'Good afternoon';
            else if (hour >= 17) greeting = 'Good evening';

            const priorityCount = intelligence.priority_actions?.length || 0;
            const greetingText = priorityCount > 0
                ? `${greeting}! Here's what matters today:`
                : `${greeting}! Your pipeline is on track.`;

            document.getElementById('pulseGreetingV2').textContent = greetingText;

            // Render priority action cards
            const actionsRow = document.getElementById('pulseActionsRow');
            actionsRow.innerHTML = '';

            const topActions = intelligence.priority_actions?.slice(0, 3) || [];

            if (topActions.length === 0) {
                actionsRow.innerHTML = `
                    <div class="pulse-action-card">
                        <div class="pulse-action-icon">âœ…</div>
                        <div class="pulse-action-company">No urgent actions</div>
                        <div class="pulse-action-text">Your pipeline is healthy. Keep momentum going.</div>
                    </div>
                `;
            } else {
                topActions.forEach(action => {
                    const app = getApplications().find(a => String(a.id) === String(action.application_id));
                    const btnConfig = CommandCenter.getOneClickButtonConfig(action.one_click_action);

                    const cardHtml = `
                        <div class="pulse-action-card">
                            <div class="pulse-action-icon">${action.one_click_action?.type === 'draft_email' ? 'âœ‰ï¸' : action.one_click_action?.type === 'open_prep' ? 'ðŸ“‹' : 'âš¡'}</div>
                            <div class="pulse-action-company">${app?.company || 'Unknown'}</div>
                            <div class="pulse-action-text">${action.action}</div>
                            ${btnConfig ? `<button class="pulse-action-btn" onclick="handleOneClickAction('${action.application_id}', '${action.one_click_action?.type}')">${btnConfig.label}</button>` : ''}
                        </div>
                    `;
                    actionsRow.innerHTML += cardHtml;
                });
            }

            // Render pipeline health
            const health = intelligence.pipeline_health;
            if (health) {
                document.getElementById('pulseHealthIcon').textContent = health.icon;
                document.getElementById('pulseHealthLabel').textContent = health.status.charAt(0).toUpperCase() + health.status.slice(1);
                document.getElementById('pulseHealthReason').textContent = health.reason;

                const healthEl = document.getElementById('pulseHealthStatus');
                healthEl.className = 'pulse-health ' + (health.tone === 'urgent' ? 'urgent' : health.tone === 'caution' ? 'caution' : 'healthy');
            }

            pulseEl.style.display = 'block';
        }

        /**
         * Render Board View with intelligence
         */
        function renderBoardView(apps, intelligence) {
            const container = document.getElementById('boardViewContainer');
            if (!container) return;

            // Group apps by status category
            const statusGroups = {
                applied: [],
                screening: [],
                interviewing: [],
                final: []
            };

            apps.forEach(app => {
                const status = app.status?.toLowerCase() || '';
                const intel = intelligence?.applications?.find(a => String(a.id) === String(app.id));

                if (status.includes('applied') || status.includes('networking')) {
                    statusGroups.applied.push({ app, intel });
                } else if (status.includes('recruiter') || status.includes('screen')) {
                    statusGroups.screening.push({ app, intel });
                } else if (status.includes('hiring') || status.includes('technical') || status.includes('panel') || status.includes('interview')) {
                    statusGroups.interviewing.push({ app, intel });
                } else if (status.includes('final') || status.includes('executive') || status.includes('offer')) {
                    statusGroups.final.push({ app, intel });
                } else if (!['rejected', 'withdrawn', 'archived'].includes(status)) {
                    statusGroups.applied.push({ app, intel });
                }
            });

            // Update counts
            document.getElementById('boardCountApplied').textContent = statusGroups.applied.length;
            document.getElementById('boardCountScreening').textContent = statusGroups.screening.length;
            document.getElementById('boardCountInterviewing').textContent = statusGroups.interviewing.length;
            document.getElementById('boardCountFinal').textContent = statusGroups.final.length;

            // Render cards for each column
            Object.entries(statusGroups).forEach(([status, items]) => {
                const cardsEl = document.getElementById(`boardCards${status.charAt(0).toUpperCase() + status.slice(1)}`);
                if (!cardsEl) return;

                cardsEl.innerHTML = items.map(({ app, intel }) => renderAppCardV2(app, intel)).join('');
            });

            // Initialize drag and drop after rendering
            initBoardDragAndDrop();
        }

        /**
         * Render a single application card with UI signals
         */
        function renderAppCardV2(app, intel) {
            const ui = intel?.ui_signals || {
                priority: 'medium',
                confidence: 'medium',
                urgency: 'routine',
                color_code: 'yellow',
                icon: 'ðŸ“‹',
                badge: null,
                action_available: false,
                dimmed: false
            };

            const confidenceClass = `confidence-${ui.confidence}`;
            const priorityClass = `priority-${ui.priority}`;
            const dimmedClass = focusModeEnabled && ui.dimmed ? 'dimmed' : '';
            const urgentClass = ui.urgency === 'immediate' ? 'urgent' : '';

            const fitScore = app.fitScore || app.fit_score || '--';
            const daysSince = intel?.days_since_last_activity || getDaysSince(app.dateApplied || app.dateAdded);

            const nextAction = intel?.next_action || 'Review application';
            const nextReason = intel?.next_action_reason || '';

            const btnConfig = intel?.one_click_action ? CommandCenter.getOneClickButtonConfig(intel.one_click_action) : null;

            return `
                <div class="app-card-v2 ${confidenceClass} ${priorityClass} ${dimmedClass}"
                     data-id="${app.id}"
                     draggable="true"
                     tabindex="0"
                     role="button"
                     aria-label="${app.company} - ${app.role || app.roleTitle || 'Role'}"
                     onclick="navigateWithAnalysis('${app.id}', 'overview.html')">
                    ${app.user_override ? '<span class="override-badge" title="You have overridden the system recommendation">Manual Override</span>' : ''}

                    <div class="card-header-v2">
                        <div class="card-title-row">
                            <span class="card-icon ${urgentClass}">${ui.icon}</span>
                            <span class="card-title-v2">${app.company} - ${app.role || app.roleTitle || 'Role'}</span>
                        </div>
                        <div class="card-header-actions">
                            ${ui.badge ? `<span class="card-badge">${ui.badge}</span>` : ''}
                            <button class="card-override-btn"
                                    onclick="event.stopPropagation(); openOverrideModal('${app.id}')"
                                    title="Override system recommendation"
                                    aria-label="Override recommendation">
                                âš™ï¸
                            </button>
                        </div>
                    </div>

                    <div class="card-stats-v2">
                        <span class="card-stat-v2">Fit: ${fitScore}%${ui.badge === 'directional' ? ' (Directional)' : ''}</span>
                        <span class="card-stat-v2">
                            <span class="confidence-pill ${ui.confidence}">${ui.confidence}</span>
                        </span>
                        <span class="card-stat-v2">${daysSince}d since activity</span>
                    </div>

                    <div class="next-action-section">
                        <div class="next-action-text">Next: ${nextAction}</div>
                        ${nextReason ? `<div class="next-action-reason">${nextReason}</div>` : ''}
                    </div>

                    ${btnConfig && ui.action_available ? `
                        <button class="one-click-btn ${btnConfig.class}"
                                onclick="event.stopPropagation(); handleOneClickAction('${app.id}', '${intel.one_click_action?.type}')">
                            ${btnConfig.icon} ${btnConfig.label}
                        </button>
                    ` : ''}
                </div>
            `;
        }

        /**
         * Initialize drag and drop for board view
         */
        function initBoardDragAndDrop() {
            const columns = document.querySelectorAll('.board-column');
            const cards = document.querySelectorAll('.app-card-v2[draggable="true"]');

            // Card drag events
            cards.forEach(card => {
                card.addEventListener('dragstart', handleDragStart);
                card.addEventListener('dragend', handleDragEnd);
            });

            // Column drop zone events
            columns.forEach(column => {
                const cardsContainer = column.querySelector('.board-cards');

                column.addEventListener('dragover', handleDragOver);
                column.addEventListener('dragenter', handleDragEnter);
                column.addEventListener('dragleave', handleDragLeave);
                column.addEventListener('drop', handleDrop);

                if (cardsContainer) {
                    cardsContainer.addEventListener('dragover', handleDragOver);
                    cardsContainer.addEventListener('drop', handleDrop);
                }
            });
        }

        let draggedCard = null;
        let draggedAppId = null;

        function handleDragStart(e) {
            draggedCard = this;
            draggedAppId = this.dataset.id;
            this.classList.add('dragging');

            // Set drag data
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/plain', draggedAppId);

            // Delay to allow the drag image to be set
            setTimeout(() => {
                this.style.opacity = '0.4';
            }, 0);
        }

        function handleDragEnd(e) {
            this.classList.remove('dragging');
            this.style.opacity = '1';

            // Remove all drag-over styling
            document.querySelectorAll('.board-column.drag-over, .board-cards.drag-over').forEach(el => {
                el.classList.remove('drag-over');
            });

            draggedCard = null;
            draggedAppId = null;
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
        }

        function handleDragEnter(e) {
            e.preventDefault();
            const column = e.target.closest('.board-column');
            if (column) {
                column.classList.add('drag-over');
                const cardsContainer = column.querySelector('.board-cards');
                if (cardsContainer) cardsContainer.classList.add('drag-over');
            }
        }

        function handleDragLeave(e) {
            const column = e.target.closest('.board-column');
            if (column && !column.contains(e.relatedTarget)) {
                column.classList.remove('drag-over');
                const cardsContainer = column.querySelector('.board-cards');
                if (cardsContainer) cardsContainer.classList.remove('drag-over');
            }
        }

        function handleDrop(e) {
            e.preventDefault();

            const column = e.target.closest('.board-column');
            if (!column || !draggedAppId) return;

            const newStatus = column.dataset.status;
            if (!newStatus) return;

            // Remove drag styling
            column.classList.remove('drag-over');
            const cardsContainer = column.querySelector('.board-cards');
            if (cardsContainer) cardsContainer.classList.remove('drag-over');

            // Update the application status
            updateApplicationStatus(draggedAppId, newStatus);
        }

        /**
         * Update application status after drag and drop
         */
        function updateApplicationStatus(appId, newStatus) {
            const apps = getApplications();
            const appIndex = apps.findIndex(a => String(a.id) === String(appId));

            if (appIndex === -1) return;

            const app = apps[appIndex];
            const oldStatus = app.status;

            // Status mapping from column to actual status values
            const statusMap = {
                'applied': 'Applied',
                'screening': 'Screening',
                'interviewing': 'Interviewing',
                'final': 'Final Round'
            };

            const mappedStatus = statusMap[newStatus] || newStatus;

            // Don't update if status hasn't changed
            if (app.status?.toLowerCase() === newStatus.toLowerCase()) return;

            // Update the status
            app.status = mappedStatus;
            app.lastUpdated = new Date().toISOString();

            // Mark as user override since they manually moved it
            app.user_override = {
                type: 'status_change',
                from: oldStatus,
                to: mappedStatus,
                timestamp: new Date().toISOString()
            };

            // Save to localStorage
            localStorage.setItem('trackedApplications', JSON.stringify(apps));

            // Sync to Supabase if available
            if (typeof HenryData !== 'undefined') {
                HenryData.saveApplication(app).catch(e =>
                    console.error('Failed to sync status change to Supabase:', e)
                );
            }

            // Show feedback
            showToast(`Moved ${app.company} to ${mappedStatus}`, 'success');

            // Re-render the board
            renderBoardView();
        }

        /**
         * Simple toast notification for drag and drop feedback
         */
        function showToast(message, type = 'info') {
            // Use existing toast system if available
            if (window.InterviewNotifications?.showToast) {
                window.InterviewNotifications.showToast({
                    title: type === 'success' ? 'Updated' : 'Info',
                    message: message,
                    icon: type === 'success' ? 'âœ“' : 'â„¹ï¸',
                    timeout: 3000
                });
                return;
            }

            // Fallback simple toast
            const toast = document.createElement('div');
            toast.className = 'simple-toast';
            toast.textContent = message;
            toast.style.cssText = `
                position: fixed;
                bottom: 20px;
                right: 20px;
                background: ${type === 'success' ? '#10b981' : '#6b7280'};
                color: white;
                padding: 12px 20px;
                border-radius: 8px;
                font-size: 0.9rem;
                z-index: 10001;
                animation: fadeIn 0.3s ease;
            `;
            document.body.appendChild(toast);

            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transition = 'opacity 0.3s ease';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        /**
         * Handle one-click actions
         */
        function handleOneClickAction(appId, actionType) {
            const app = getApplications().find(a => String(a.id) === String(appId));
            if (!app) return;

            switch (actionType) {
                case 'draft_email':
                    // Open email composer with template
                    openFollowUpEmailComposer(appId);
                    break;
                case 'archive':
                    if (confirm(`Archive ${app.company} application? This will move it to your archived list.`)) {
                        archiveApplication(appId);
                    }
                    break;
                case 'open_prep':
                    navigateWithAnalysis(appId, 'interview-prep.html');
                    break;
                case 'block_time':
                    // TODO: Calendar integration
                    alert('Calendar blocking coming soon!');
                    break;
                default:
                    console.log('[CommandCenter] Unknown action:', actionType);
            }
        }

        /**
         * Open follow-up email composer
         */
        function openFollowUpEmailComposer(appId) {
            const app = getApplications().find(a => String(a.id) === String(appId));
            if (!app) return;

            // Navigate to reach out functionality or open modal
            if (typeof window.openReachOutModal === 'function') {
                window.openReachOutModal(appId);
            } else {
                navigateWithAnalysis(appId, 'overview.html');
            }
        }

        /**
         * Archive an application
         */
        async function archiveApplication(appId) {
            try {
                const apps = getApplications();
                const appIndex = apps.findIndex(a => String(a.id) === String(appId));
                if (appIndex === -1) return;

                apps[appIndex].status = 'Archived';
                apps[appIndex].archivedAt = new Date().toISOString();

                // Save to localStorage/Supabase
                saveApplications(apps);

                // Refresh UI
                CommandCenter.invalidateCache();
                renderAll(apps);

                console.log('[CommandCenter] Application archived:', appId);
            } catch (error) {
                console.error('[CommandCenter] Archive failed:', error);
            }
        }

        /**
         * Set Command Center view mode
         */
        function setCommandCenterView(view) {
            currentCommandCenterView = view;

            // Update selector buttons
            document.querySelectorAll('.view-selector-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.view === view);
            });

            // Show/hide views
            document.getElementById('boardViewContainer').style.display = view === 'board' ? 'grid' : 'none';
            document.getElementById('prioritiesView').style.display = view === 'list' ? 'block' : 'none';
            document.getElementById('detailsView').style.display = view === 'list' ? 'block' : 'none';
            document.getElementById('timelineViewContainer').style.display = view === 'timeline' ? 'block' : 'none';

            // Initialize timeline view if selected
            if (view === 'timeline') {
                const apps = getApplications();
                renderTimelineView(apps, commandCenterIntelligence);
            }
        }

        /**
         * Toggle Focus Mode
         */
        function toggleFocusMode() {
            focusModeEnabled = !focusModeEnabled;

            const toggle = document.getElementById('focusModeToggle');
            toggle.classList.toggle('active', focusModeEnabled);

            // Re-render board with focus mode
            if (commandCenterIntelligence) {
                renderBoardView(getApplications(), commandCenterIntelligence);
            }

            console.log('[CommandCenter] Focus mode:', focusModeEnabled ? 'ON' : 'OFF');
        }

        /**
         * Check and show Strategic Stop warning
         */
        function checkAndShowStrategicStop(intelligence) {
            if (!intelligence) return;

            // Calculate interview rate
            const apps = getApplications();
            const totalApps = apps.filter(a => STATUSES[a.status]?.active).length;
            const interviews = apps.filter(a => {
                const status = a.status?.toLowerCase() || '';
                return status.includes('recruiter') || status.includes('interview') || status.includes('screen');
            }).length;
            const interviewRate = totalApps > 0 ? (interviews / totalApps) * 100 : 0;

            const strategicStop = CommandCenter.checkStrategicStop(intelligence.pipeline_health, interviewRate);

            const banner = document.getElementById('strategicStopBanner');
            if (strategicStop?.triggered) {
                document.getElementById('strategicStopReason').textContent = strategicStop.reason;

                const actionsHtml = strategicStop.actions.map(a => `<li>${a}</li>`).join('');
                document.getElementById('strategicStopActions').innerHTML = actionsHtml;

                if (strategicStop.pauseDays > 0) {
                    document.getElementById('strategicStopPause').textContent =
                        `Applications paused for ${strategicStop.pauseDays} days.`;
                }

                banner.style.display = 'block';
            } else {
                banner.style.display = 'none';
            }
        }

        /**
         * Navigate to strategy review
         */
        function navigateToStrategy() {
            window.location.href = 'profile.html';
        }

        /**
         * Override strategic stop (user choice)
         */
        function overrideStrategicStop() {
            if (confirm('Are you sure? Overriding this warning may lead to wasted effort on a broken strategy.')) {
                document.getElementById('strategicStopBanner').style.display = 'none';
                localStorage.setItem('strategicStopOverride', Date.now());
            }
        }

        // ========================================================================
        // COMMAND CENTER: TIMELINE VIEW
        // ========================================================================

        let timelineChartInstance = null;

        /**
         * Render Timeline View with Chart.js
         */
        function renderTimelineView(apps, intelligence) {
            const container = document.getElementById('timelineViewContainer');
            const canvas = document.getElementById('timelineChart');
            if (!container || !canvas) return;

            // Destroy existing chart instance
            if (timelineChartInstance) {
                timelineChartInstance.destroy();
            }

            // Process data for timeline
            const timelineData = processTimelineData(apps);

            // Create chart
            const ctx = canvas.getContext('2d');
            timelineChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: timelineData.labels,
                    datasets: [
                        {
                            label: 'Applications',
                            data: timelineData.applications,
                            borderColor: '#22d3ee',
                            backgroundColor: 'rgba(34, 211, 238, 0.1)',
                            fill: true,
                            tension: 0.3
                        },
                        {
                            label: 'Interviews',
                            data: timelineData.interviews,
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            fill: true,
                            tension: 0.3
                        },
                        {
                            label: 'Rejections',
                            data: timelineData.rejections,
                            borderColor: '#ef4444',
                            backgroundColor: 'rgba(239, 68, 68, 0.1)',
                            fill: true,
                            tension: 0.3
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            backgroundColor: '#1c1c1f',
                            borderColor: 'rgba(255, 255, 255, 0.1)',
                            borderWidth: 1,
                            titleColor: '#fafafa',
                            bodyColor: '#a1a1aa',
                            padding: 12
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                color: 'rgba(255, 255, 255, 0.05)'
                            },
                            ticks: {
                                color: '#71717a'
                            }
                        },
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(255, 255, 255, 0.05)'
                            },
                            ticks: {
                                color: '#71717a',
                                stepSize: 1
                            }
                        }
                    },
                    interaction: {
                        mode: 'nearest',
                        axis: 'x',
                        intersect: false
                    }
                }
            });

            // Render insights
            renderTimelineInsights(apps, intelligence);
        }

        /**
         * Process application data for timeline chart
         */
        function processTimelineData(apps) {
            // Get last 8 weeks
            const weeks = [];
            const today = new Date();
            for (let i = 7; i >= 0; i--) {
                const weekStart = new Date(today);
                weekStart.setDate(today.getDate() - (i * 7));
                weeks.push({
                    start: new Date(weekStart),
                    label: `Week ${8 - i}`,
                    applications: 0,
                    interviews: 0,
                    rejections: 0
                });
            }

            // Count events per week
            apps.forEach(app => {
                const appDate = new Date(app.dateApplied || app.dateAdded || app.createdAt);
                const status = app.status?.toLowerCase() || '';

                weeks.forEach(week => {
                    const weekEnd = new Date(week.start);
                    weekEnd.setDate(week.start.getDate() + 7);

                    if (appDate >= week.start && appDate < weekEnd) {
                        week.applications++;
                    }
                });

                // Track status changes (simplified)
                if (status.includes('interview') || status.includes('screen') || status.includes('recruiter')) {
                    weeks[weeks.length - 1].interviews++;
                }
                if (status === 'rejected') {
                    weeks[weeks.length - 1].rejections++;
                }
            });

            return {
                labels: weeks.map(w => w.label),
                applications: weeks.map(w => w.applications),
                interviews: weeks.map(w => w.interviews),
                rejections: weeks.map(w => w.rejections)
            };
        }

        /**
         * Render timeline insights
         */
        function renderTimelineInsights(apps, intelligence) {
            const container = document.getElementById('timelineInsights');
            if (!container) return;

            const totalApps = apps.length;
            const activeApps = apps.filter(a => STATUSES[a.status]?.active).length;
            const interviewRate = totalApps > 0 ?
                Math.round((apps.filter(a => a.status?.toLowerCase().includes('interview')).length / totalApps) * 100) : 0;

            container.innerHTML = `
                <div class="timeline-insight">
                    <span class="insight-value">${totalApps}</span>
                    <span class="insight-label">Total Applications</span>
                </div>
                <div class="timeline-insight">
                    <span class="insight-value">${activeApps}</span>
                    <span class="insight-label">Active Pipeline</span>
                </div>
                <div class="timeline-insight">
                    <span class="insight-value">${interviewRate}%</span>
                    <span class="insight-label">Interview Rate</span>
                </div>
            `;
        }

        // ========================================================================
        // COMMAND CENTER: EMPTY, ERROR, LOADING, OFFLINE STATES
        // ========================================================================

        /**
         * Show empty state
         */
        function showEmptyState() {
            document.getElementById('emptyState').style.display = 'block';
            document.getElementById('errorState').style.display = 'none';
            document.getElementById('loadingSkeleton').style.display = 'none';
            document.getElementById('boardViewContainer').style.display = 'none';
            document.getElementById('dailyPulseV2').style.display = 'none';
        }

        /**
         * Show error state
         */
        function showErrorState(message = 'Unable to load intelligence. Check your connection.') {
            document.getElementById('errorState').style.display = 'block';
            document.getElementById('errorStateText').textContent = message;
            document.getElementById('emptyState').style.display = 'none';
            document.getElementById('loadingSkeleton').style.display = 'none';
        }

        /**
         * Show loading skeleton
         */
        function showLoadingSkeleton() {
            document.getElementById('loadingSkeleton').style.display = 'block';
            document.getElementById('emptyState').style.display = 'none';
            document.getElementById('errorState').style.display = 'none';
        }

        /**
         * Hide all state overlays
         */
        function hideStateOverlays() {
            document.getElementById('loadingSkeleton').style.display = 'none';
            document.getElementById('emptyState').style.display = 'none';
            document.getElementById('errorState').style.display = 'none';
        }

        /**
         * Retry loading intelligence after error
         */
        async function retryLoadIntelligence() {
            document.getElementById('errorState').style.display = 'none';
            showLoadingSkeleton();

            try {
                const apps = getApplications();
                CommandCenter.invalidateCache();
                await initCommandCenter(apps);
                hideStateOverlays();
            } catch (error) {
                console.error('[CommandCenter] Retry failed:', error);
                showErrorState('Still unable to connect. Please check your internet connection.');
            }
        }

        // ========================================================================
        // COMMAND CENTER: OFFLINE DETECTION
        // ========================================================================

        let isOffline = false;

        /**
         * Initialize offline detection
         */
        function initOfflineDetection() {
            window.addEventListener('online', handleOnline);
            window.addEventListener('offline', handleOffline);

            // Check initial state
            if (!navigator.onLine) {
                handleOffline();
            }
        }

        /**
         * Handle going online
         */
        function handleOnline() {
            isOffline = false;
            document.getElementById('offlineIndicator').style.display = 'none';

            // Refresh data
            const apps = getApplications();
            if (apps.length > 0) {
                CommandCenter.invalidateCache();
                initCommandCenter(apps);
            }
        }

        /**
         * Handle going offline
         */
        function handleOffline() {
            isOffline = true;
            document.getElementById('offlineIndicator').style.display = 'flex';
        }

        // ========================================================================
        // COMMAND CENTER: USER OVERRIDE MODAL
        // ========================================================================

        let currentOverrideAppId = null;

        /**
         * Open user override modal
         */
        function openOverrideModal(appId) {
            currentOverrideAppId = appId;
            const app = getApplications().find(a => String(a.id) === String(appId));
            if (!app) return;

            const intel = commandCenterIntelligence?.applications?.find(a => String(a.id) === String(appId));
            const currentAction = intel?.next_action || 'No action suggested';

            document.getElementById('overrideCurrentAction').textContent = currentAction;
            document.getElementById('overrideActionSelect').value = '';
            document.getElementById('overrideReason').value = app.user_override_reason || '';
            document.getElementById('overrideLock').checked = app.manual_lock || false;
            document.getElementById('overrideCustomWrapper').style.display = 'none';

            document.getElementById('overrideModal').classList.add('active');
        }

        /**
         * Close user override modal
         */
        function closeOverrideModal() {
            currentOverrideAppId = null;
            document.getElementById('overrideModal').classList.remove('active');
        }

        /**
         * Save user override
         */
        async function saveUserOverride() {
            if (!currentOverrideAppId) return;

            const actionSelect = document.getElementById('overrideActionSelect').value;
            const customAction = document.getElementById('overrideCustomAction').value;
            const reason = document.getElementById('overrideReason').value;
            const lock = document.getElementById('overrideLock').checked;

            const selectedAction = actionSelect === 'custom' ? customAction : actionSelect;

            if (!selectedAction) {
                alert('Please select an action');
                return;
            }

            try {
                const apps = getApplications();
                const appIndex = apps.findIndex(a => String(a.id) === String(currentOverrideAppId));
                if (appIndex === -1) return;

                // Update application with override
                apps[appIndex].user_override = true;
                apps[appIndex].user_override_reason = reason;
                apps[appIndex].manual_lock = lock;
                apps[appIndex].next_action = selectedAction;

                // Handle specific actions
                if (selectedAction === 'archive') {
                    apps[appIndex].status = 'Archived';
                    apps[appIndex].archivedAt = new Date().toISOString();
                }

                // Save
                saveApplications(apps);

                // Refresh UI
                CommandCenter.invalidateCache();
                renderAll(apps);

                closeOverrideModal();
                console.log('[CommandCenter] Override saved for:', currentOverrideAppId);
            } catch (error) {
                console.error('[CommandCenter] Override save failed:', error);
                alert('Failed to save override. Please try again.');
            }
        }

        /**
         * Handle override action select change
         */
        document.addEventListener('DOMContentLoaded', function() {
            const actionSelect = document.getElementById('overrideActionSelect');
            if (actionSelect) {
                actionSelect.addEventListener('change', function() {
                    const customWrapper = document.getElementById('overrideCustomWrapper');
                    customWrapper.style.display = this.value === 'custom' ? 'block' : 'none';
                });
            }

            // Initialize offline detection
            initOfflineDetection();
        });

        // ========================================================================
        // COMMAND CENTER: KEYBOARD NAVIGATION
        // ========================================================================

        /**
         * Initialize keyboard navigation
         */
        function initKeyboardNavigation() {
            document.addEventListener('keydown', handleKeyboardNavigation);
        }

        /**
         * Handle keyboard navigation
         */
        function handleKeyboardNavigation(e) {
            // Skip if typing in an input
            if (e.target.matches('input, textarea, select')) return;

            switch (e.key) {
                case 'f':
                case 'F':
                    // Toggle focus mode
                    if (!e.ctrlKey && !e.metaKey) {
                        toggleFocusMode();
                        e.preventDefault();
                    }
                    break;
                case '1':
                    setCommandCenterView('board');
                    e.preventDefault();
                    break;
                case '2':
                    setCommandCenterView('list');
                    e.preventDefault();
                    break;
                case '3':
                    setCommandCenterView('timeline');
                    e.preventDefault();
                    break;
                case 'Escape':
                    closeOverrideModal();
                    break;
                case 'ArrowDown':
                case 'ArrowUp':
                    navigateCards(e.key === 'ArrowDown' ? 1 : -1);
                    e.preventDefault();
                    break;
                case 'Enter':
                    // Open selected card
                    const focused = document.querySelector('.app-card-v2:focus');
                    if (focused) {
                        focused.click();
                    }
                    break;
            }
        }

        /**
         * Navigate between application cards
         */
        function navigateCards(direction) {
            const cards = Array.from(document.querySelectorAll('.app-card-v2:not(.dimmed)'));
            if (cards.length === 0) return;

            const currentFocus = document.activeElement;
            let currentIndex = cards.indexOf(currentFocus);

            if (currentIndex === -1) {
                currentIndex = direction === 1 ? -1 : cards.length;
            }

            const nextIndex = Math.max(0, Math.min(cards.length - 1, currentIndex + direction));
            cards[nextIndex].focus();
        }

        // Initialize keyboard navigation on load
        document.addEventListener('DOMContentLoaded', initKeyboardNavigation);

        // ========================================================================
        // COMMAND CENTER: SUPABASE PERSISTENCE
        // ========================================================================

        /**
         * Save intelligence to Supabase
         */
        async function persistIntelligenceToSupabase(appId, intel) {
            if (!window.supabase || !appId || !intel) return;

            try {
                const { error } = await window.supabase
                    .from('applications')
                    .update({
                        decision_confidence: intel.decision_confidence,
                        confidence_label: intel.confidence_label,
                        next_action: intel.next_action,
                        next_action_reason: intel.next_action_reason,
                        priority_level: intel.priority_level,
                        substatus: intel.substatus,
                        days_since_last_activity: intel.days_since_last_activity,
                        last_activity_date: new Date().toISOString().split('T')[0]
                    })
                    .eq('id', appId);

                if (error) {
                    console.error('[CommandCenter] Supabase persist error:', error);
                }
            } catch (error) {
                console.error('[CommandCenter] Supabase persist failed:', error);
            }
        }

        /**
         * Batch persist intelligence for all applications
         */
        async function batchPersistIntelligence(intelligence) {
            if (!window.supabase || !intelligence?.applications) return;

            const updates = intelligence.applications.map(intel => ({
                id: intel.id,
                decision_confidence: intel.decision_confidence,
                confidence_label: intel.ui_signals?.confidence || 'medium',
                next_action: intel.next_action,
                next_action_reason: intel.next_action_reason,
                priority_level: intel.priority_level,
                substatus: intel.substatus,
                days_since_last_activity: intel.days_since_last_activity
            }));

            // Supabase doesn't support bulk upsert easily, so we do individual updates
            // In production, consider using a batch endpoint
            for (const update of updates) {
                await persistIntelligenceToSupabase(update.id, update);
            }

            console.log('[CommandCenter] Intelligence persisted to Supabase');
        }

        // ========================================================================
        // RENDER ALL
        // ========================================================================
        function renderAll(apps) {
            console.log('=== RENDER ALL CALLED ===');
            console.log('Apps received:', apps);
            console.log('Apps count:', apps?.length || 0);

            if (apps && apps.length > 0) {
                apps.forEach((app, i) => {
                    console.log(`App ${i}:`, app.company, app.status, 'active:', STATUSES[app.status]?.active);
                });
            }

            const metrics = calculatePipelineMetrics(apps);
            console.log('Calculated metrics:', metrics);
            const priorities = getStrategicPriorities(apps);

            renderDailyPulse(apps);
            renderPipelineMetrics(metrics);
            renderStrategicPriorities(priorities);
            renderPatternAlert(apps);
            renderApplications(apps);

            // Show/hide view toggle based on whether there are applications
            const viewToggleContainer = document.getElementById('viewToggleContainer');
            viewToggleContainer.style.display = apps.length > 0 ? 'flex' : 'none';

            // Check for desperation pattern
            checkDesperationIntervention(apps);

            // Initialize Command Center v2.0
            initCommandCenter(apps);
        }

        function checkDesperationIntervention(apps) {
            // First check for close-but-not-closing pattern (takes priority if detected)
            const closePattern = shouldShowCloseButNotClosingIntervention(apps);
            if (closePattern) {
                renderCloseButNotClosingModal(closePattern);
                return;
            }

            // Then check for desperation patterns
            const pattern = shouldShowIntervention(apps);
            if (pattern) {
                renderInterventionModal(pattern);
            }
        }

        // ========================================================================
        // EXPORT/IMPORT BACKUP FUNCTIONS
        // ========================================================================

        function exportBackup() {
            // Collect all HenryHQ data from localStorage
            const backup = {
                exportDate: new Date().toISOString(),
                version: '1.0',
                data: {}
            };

            // Get all localStorage keys that belong to HenryHQ
            const henryKeys = [
                'trackedApplications',
                'candidateProfile',
                'resumeConversation',
                'resumeExtractedData',
                'interventionState'
            ];

            // Also get all analysis keys (analysis_*, documents_*)
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith('analysis_') || key.startsWith('documents_')) {
                    henryKeys.push(key);
                }
            }

            // Collect data
            henryKeys.forEach(key => {
                const value = localStorage.getItem(key);
                if (value) {
                    try {
                        backup.data[key] = JSON.parse(value);
                    } catch {
                        backup.data[key] = value;
                    }
                }
            });

            // Create and download file
            const blob = new Blob([JSON.stringify(backup, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `henryai-backup-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            alert('Backup downloaded! Keep this file safe to restore your data if needed.');
        }

        // ========================================================================
        // IMPORT OPTIONS
        // ========================================================================
        function showImportOptions() {
            document.getElementById('importOptionsModal').classList.add('show');
        }

        function closeImportOptions() {
            document.getElementById('importOptionsModal').classList.remove('show');
        }

        function showManualAddModal() {
            // Navigate to analyze page for manual entry
            window.location.href = 'analyze.html';
        }

        // ========================================================================
        // SCREENSHOT IMPORT
        // ========================================================================
        let extractedJobs = [];

        function handleScreenshotImport(event) {
            const file = event.target.files[0];
            if (!file) return;

            // Show the screenshot import modal
            document.getElementById('screenshotImportModal').classList.add('show');
            processScreenshotFile(file);

            // Reset the input for future use
            event.target.value = '';
        }

        function closeScreenshotImport() {
            document.getElementById('screenshotImportModal').classList.remove('show');
            resetScreenshotModal();
        }

        function resetScreenshotModal() {
            document.getElementById('screenshotUploadArea').style.display = 'block';
            document.querySelector('.screenshot-upload-content').style.display = 'block';
            document.getElementById('screenshotPreview').style.display = 'none';
            document.getElementById('screenshotProcessing').style.display = 'none';
            document.getElementById('screenshotResults').style.display = 'none';
            document.getElementById('importSelectedBtn').style.display = 'none';
            document.getElementById('screenshotUploadArea').classList.remove('has-image');
            extractedJobs = [];
        }

        function processScreenshotFile(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                // Show preview
                const preview = document.getElementById('screenshotPreview');
                preview.src = e.target.result;
                preview.style.display = 'block';
                document.querySelector('.screenshot-upload-content').style.display = 'none';
                document.getElementById('screenshotUploadArea').classList.add('has-image');

                // Send to API for processing
                processScreenshotWithAI(e.target.result);
            };
            reader.readAsDataURL(file);
        }

        async function processScreenshotWithAI(imageDataUrl) {
            // Show processing state
            document.getElementById('screenshotUploadArea').style.display = 'none';
            document.getElementById('screenshotProcessing').style.display = 'block';

            try {
                // Extract base64 data from data URL
                const base64Data = imageDataUrl.split(',')[1];

                // Call API to process with Claude Vision
                const response = await fetch('/api/extract-jobs-from-screenshot', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ image: base64Data })
                });

                if (!response.ok) {
                    throw new Error('API request failed');
                }

                const result = await response.json();
                extractedJobs = result.jobs || [];

                // Show results
                displayExtractedJobs(extractedJobs);

            } catch (error) {
                console.error('Screenshot processing error:', error);
                alert('Error processing screenshot. Please try again or use file import.');
                resetScreenshotModal();
            }
        }

        function displayExtractedJobs(jobs) {
            document.getElementById('screenshotProcessing').style.display = 'none';
            document.getElementById('screenshotResults').style.display = 'block';
            document.getElementById('importSelectedBtn').style.display = 'inline-block';

            document.getElementById('extractedJobCount').textContent = jobs.length;

            const listContainer = document.getElementById('extractedJobsList');

            if (jobs.length === 0) {
                listContainer.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: var(--color-text-muted);">
                        <p>No job applications found in this screenshot.</p>
                        <p style="font-size: 0.9rem; margin-top: 8px;">Try a screenshot that shows a list of applications with company names and job titles visible.</p>
                    </div>
                `;
                document.getElementById('importSelectedBtn').style.display = 'none';
                return;
            }

            listContainer.innerHTML = jobs.map((job, index) => `
                <div class="extracted-job-item">
                    <input type="checkbox" class="extracted-job-checkbox" id="job-${index}" checked>
                    <div class="extracted-job-details">
                        <div class="extracted-job-title">${job.title || 'Unknown Role'}</div>
                        <div class="extracted-job-company">${job.company || 'Unknown Company'}</div>
                        ${job.status || job.date_applied ? `
                            <div class="extracted-job-meta">
                                ${job.status ? `<span>Status: ${job.status}</span>` : ''}
                                ${job.date_applied ? `<span>Applied: ${job.date_applied}</span>` : ''}
                            </div>
                        ` : ''}
                    </div>
                </div>
            `).join('');
        }

        async function importSelectedJobs() {
            const checkboxes = document.querySelectorAll('.extracted-job-checkbox:checked');
            const selectedIndices = Array.from(checkboxes).map(cb => parseInt(cb.id.replace('job-', '')));

            if (selectedIndices.length === 0) {
                alert('Please select at least one job to import.');
                return;
            }

            const apps = getApplications();
            let addedCount = 0;

            for (const index of selectedIndices) {
                const job = extractedJobs[index];
                if (!job) continue;

                // Check for duplicates
                const isDuplicate = apps.some(a =>
                    a.company?.toLowerCase() === job.company?.toLowerCase() &&
                    a.role?.toLowerCase() === job.title?.toLowerCase()
                );

                if (!isDuplicate) {
                    const newApp = {
                        id: crypto.randomUUID ? crypto.randomUUID() : Date.now().toString(),
                        company: job.company || 'Unknown Company',
                        role: job.title || 'Unknown Role',
                        status: mapImportedStatus(job.status) || 'Applied',
                        dateAdded: new Date().toISOString(),
                        dateApplied: job.date_applied ? parseImportedDate(job.date_applied) : new Date().toISOString(),
                        lastUpdated: new Date().toISOString(),
                        fitScore: null,
                        importedFromScreenshot: true
                    };

                    apps.push(newApp);
                    addedCount++;

                    // Also save to Supabase if available
                    if (typeof HenryData !== 'undefined' && window.supabaseSession) {
                        try {
                            await HenryData.saveApplication(newApp);
                        } catch (err) {
                            console.error('Error saving to Supabase:', err);
                        }
                    }
                }
            }

            saveApplications(apps);
            closeScreenshotImport();
            renderAll(apps);

            alert(`Imported ${addedCount} applications${addedCount < selectedIndices.length ? ` (${selectedIndices.length - addedCount} duplicates skipped)` : ''}.`);
        }

        // Set up drag and drop + paste for screenshot modal
        document.addEventListener('DOMContentLoaded', function() {
            const uploadArea = document.getElementById('screenshotUploadArea');

            if (uploadArea) {
                // Click to upload
                uploadArea.addEventListener('click', () => {
                    document.getElementById('screenshotFile').click();
                });

                // Drag and drop
                uploadArea.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    uploadArea.classList.add('dragover');
                });

                uploadArea.addEventListener('dragleave', () => {
                    uploadArea.classList.remove('dragover');
                });

                uploadArea.addEventListener('drop', (e) => {
                    e.preventDefault();
                    uploadArea.classList.remove('dragover');
                    const file = e.dataTransfer.files[0];
                    if (file && file.type.startsWith('image/')) {
                        processScreenshotFile(file);
                    }
                });
            }

            // Paste support (when modal is open)
            document.addEventListener('paste', (e) => {
                const modal = document.getElementById('screenshotImportModal');
                if (modal && modal.classList.contains('show')) {
                    const items = e.clipboardData?.items;
                    if (items) {
                        for (const item of items) {
                            if (item.type.startsWith('image/')) {
                                const file = item.getAsFile();
                                if (file) {
                                    processScreenshotFile(file);
                                }
                                break;
                            }
                        }
                    }
                }
            });
        });

        function handleImport(event) {
            const file = event.target.files[0];
            if (!file) return;

            const fileName = file.name.toLowerCase();

            if (fileName.endsWith('.xlsx') || fileName.endsWith('.xls')) {
                // Excel file - use SheetJS
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                        const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
                        importSpreadsheetData(jsonData);
                    } catch (err) {
                        console.error('Excel import error:', err);
                        alert('Error importing Excel file. Please check the file format.');
                    }
                };
                reader.readAsArrayBuffer(file);
            } else {
                // JSON or CSV - read as text
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const content = e.target.result;
                        if (fileName.endsWith('.json')) {
                            importJSON(content);
                        } else if (fileName.endsWith('.csv')) {
                            importCSV(content);
                        } else {
                            alert('Please upload a .json, .csv, .xlsx, or .xls file');
                        }
                    } catch (err) {
                        console.error('Import error:', err);
                        alert('Error importing file. Please check the file format.');
                    }
                };
                reader.readAsText(file);
            }

            // Reset input so same file can be selected again
            event.target.value = '';
        }

        function importJSON(content) {
            const backup = JSON.parse(content);

            // Check if it's a HenryHQ backup
            if (backup.data && backup.version) {
                const confirmMsg = `This will restore data from ${new Date(backup.exportDate).toLocaleDateString()}.\n\nThis will MERGE with your existing data. Continue?`;
                if (!confirm(confirmMsg)) return;

                // Restore each key
                Object.entries(backup.data).forEach(([key, value]) => {
                    if (key === 'trackedApplications') {
                        // Merge applications, avoiding duplicates
                        const existing = JSON.parse(localStorage.getItem('trackedApplications') || '[]');
                        const imported = Array.isArray(value) ? value : [];
                        const merged = [...existing];

                        imported.forEach(app => {
                            const exists = merged.some(e =>
                                e.company === app.company &&
                                e.role === app.role &&
                                e.dateApplied === app.dateApplied
                            );
                            if (!exists) {
                                merged.push(app);
                            }
                        });

                        localStorage.setItem('trackedApplications', JSON.stringify(merged));
                    } else {
                        localStorage.setItem(key, JSON.stringify(value));
                    }
                });

                alert('Backup restored successfully!');
                location.reload();
            } else {
                alert('This does not appear to be a valid HenryHQ backup file.');
            }
        }

        function importCSV(content) {
            const lines = content.split('\n').filter(line => line.trim());
            if (lines.length < 2) {
                alert('CSV file appears to be empty');
                return;
            }

            // Parse into 2D array for shared processing
            const data = lines.map(line => parseCSVLine(line));
            importSpreadsheetData(data);
        }

        // Shared function for CSV and Excel import
        async function importSpreadsheetData(data) {
            if (data.length < 2) {
                alert('File appears to be empty or has no data rows');
                return;
            }

            // Parse header (first row)
            const header = data[0].map(h => (h || '').toString().toLowerCase().trim());

            // Enhanced column mapping with new fields
            const columnMap = {
                company: ['company', 'company name', 'employer', 'organization', 'org'],
                role: ['role', 'title', 'job title', 'position', 'job', 'job role', 'role title', 'jobtitle', 'role/title'],
                status: ['status', 'stage', 'state', 'application status', 'current stage', 'current status', 'app status'],
                dateApplied: ['date applied', 'applied date', 'date', 'applied', 'application date', 'app date', 'date applie'],
                salary: ['salary', 'compensation', 'pay', 'salary range', 'comp', 'wage'],
                location: ['location', 'city', 'place', 'office', 'work location'],
                notes: ['notes', 'comments', 'note'],
                jobUrl: ['url', 'link', 'job url', 'posting url', 'job link', 'job posting', 'posting link', 'application url', 'application ur'],
                jobDescription: ['description', 'job description', 'jd', 'job desc', 'full description'],
                interviewDate: ['interview date', 'interview', 'next interview', 'scheduled interview', 'interview scheduled']
            };

            // Find column indices
            const indices = {};
            Object.entries(columnMap).forEach(([field, aliases]) => {
                const idx = header.findIndex(h => aliases.includes(h));
                if (idx !== -1) indices[field] = idx;
            });

            if (indices.company === undefined && indices.role === undefined) {
                alert('Could not find Company or Role columns.\n\nPlease ensure your spreadsheet has headers like "Company" and "Role" or "Job Title".');
                return;
            }

            // Parse data rows
            const imported = [];
            for (let i = 1; i < data.length; i++) {
                const values = data[i];
                if (!values || values.length === 0) continue;

                const getValue = (field) => {
                    if (indices[field] === undefined) return '';
                    const val = values[indices[field]];
                    return val ? val.toString().trim() : '';
                };

                const company = getValue('company');
                const role = getValue('role');

                // Skip rows without company and role
                if (!company && !role) continue;

                const app = {
                    id: `imported_${Date.now()}_${i}`,
                    company: company || 'Unknown Company',
                    role: role || 'Unknown Role',
                    status: mapImportedStatus(getValue('status')) || 'Preparing',
                    dateApplied: parseImportedDate(getValue('dateApplied')) || new Date().toISOString().split('T')[0],
                    salary: getValue('salary'),
                    location: getValue('location'),
                    notes: getValue('notes'),
                    jobUrl: getValue('jobUrl'),
                    jobDescription: getValue('jobDescription'),
                    interviewDate: parseImportedDate(getValue('interviewDate')) || null,
                    fitScore: null,
                    analysisKey: null,
                    source: 'spreadsheet_import'
                };

                imported.push(app);
            }

            if (imported.length === 0) {
                alert('No valid applications found in file');
                return;
            }

            // Show summary of what was found
            const hasJD = imported.filter(a => a.jobDescription).length;
            const hasUrl = imported.filter(a => a.jobUrl).length;
            const hasInterview = imported.filter(a => a.interviewDate).length;

            let summaryMsg = `Found ${imported.length} applications to import:\n`;
            summaryMsg += `â€¢ ${hasJD} with job descriptions\n`;
            summaryMsg += `â€¢ ${hasUrl} with job URLs\n`;
            summaryMsg += `â€¢ ${hasInterview} with scheduled interviews\n\n`;
            summaryMsg += `This will MERGE with your existing data. Continue?`;

            if (!confirm(summaryMsg)) return;

            // Check if user is logged in
            const user = await HenryAuth.getUser();

            if (user) {
                // Save to Supabase
                let addedCount = 0;
                let errorCount = 0;

                for (const app of imported) {
                    const { data, error } = await HenryData.saveApplication(app);
                    if (error) {
                        console.error('Error saving application:', error);
                        errorCount++;
                    } else {
                        addedCount++;
                    }
                }

                alert(`Imported ${addedCount} applications to your account.${errorCount > 0 ? ` (${errorCount} errors)` : ''}`);
            } else {
                // Save to localStorage
                const existing = JSON.parse(localStorage.getItem('trackedApplications') || '[]');
                const merged = [...existing];

                let addedCount = 0;
                imported.forEach(app => {
                    const exists = merged.some(e =>
                        e.company.toLowerCase() === app.company.toLowerCase() &&
                        e.role.toLowerCase() === app.role.toLowerCase()
                    );
                    if (!exists) {
                        merged.push(app);
                        addedCount++;
                    }
                });

                localStorage.setItem('trackedApplications', JSON.stringify(merged));
                alert(`Imported ${addedCount} new applications (${imported.length - addedCount} duplicates skipped).`);
            }

            location.reload();
        }

        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;

            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            result.push(current.trim());
            return result;
        }

        function mapImportedStatus(status) {
            if (!status) return 'Preparing';
            const s = status.toLowerCase();

            if (s.includes('offer')) return 'Offer Received';
            if (s.includes('reject') || s.includes('declined') || s.includes('closed')) return 'Rejected';
            if (s.includes('ghost') || s.includes('no response')) return 'Ghosted';
            if (s.includes('final')) return 'Final Round';
            if (s.includes('interview') || s.includes('screen')) return 'Recruiter Screen';
            if (s.includes('applied') || s.includes('submitted')) return 'Applied';
            if (s.includes('preparing') || s.includes('saved') || s.includes('interested')) return 'Preparing';

            return 'Applied';
        }

        function parseImportedDate(dateStr) {
            if (!dateStr) return null;

            // Try various date formats
            const date = new Date(dateStr);
            if (!isNaN(date.getTime())) {
                return date.toISOString().split('T')[0];
            }

            // Try MM/DD/YYYY format
            const parts = dateStr.split(/[\/\-]/);
            if (parts.length === 3) {
                const [m, d, y] = parts;
                const year = y.length === 2 ? '20' + y : y;
                return `${year}-${m.padStart(2, '0')}-${d.padStart(2, '0')}`;
            }

            return null;
        }

        // ========================================================================
        // INITIALIZE
        // ========================================================================

        // Check if using Supabase auth
        async function initializeWithAuth() {
            console.log('=== TRACKER INIT ===');
            console.log('HenryAuth defined:', typeof HenryAuth !== 'undefined');

            if (typeof HenryAuth !== 'undefined') {
                const session = await HenryAuth.getSession();
                console.log('Supabase session:', session ? 'exists' : 'null');
                if (session) {
                    window.supabaseSession = session; // Store for later use
                    const currentUserId = session.user.id;

                    // Check if localStorage data belongs to a different user
                    const lastUserId = localStorage.getItem('henryai_current_user_id');
                    if (lastUserId && lastUserId !== currentUserId) {
                        console.log('Different user detected - clearing localStorage data');
                        // Clear user-specific localStorage data to prevent data leakage
                        localStorage.removeItem('trackedApplications');
                        localStorage.removeItem('upcomingInterviews');
                        localStorage.removeItem('completedInterviews');
                        localStorage.removeItem('candidateProfile');
                        localStorage.removeItem('resumeConversation');
                        localStorage.removeItem('celebratedMilestones');
                        localStorage.removeItem('interventionState');
                        // Clear any analysis/documents keys
                        for (let i = localStorage.length - 1; i >= 0; i--) {
                            const key = localStorage.key(i);
                            if (key && (key.startsWith('analysis_') || key.startsWith('documents_'))) {
                                localStorage.removeItem(key);
                            }
                        }
                    }
                    // Store current user ID
                    localStorage.setItem('henryai_current_user_id', currentUserId);

                    // User is logged in - try Supabase first
                    console.log('Loading data from Supabase...');
                    let apps = await HenryData.getApplications();
                    console.log('Supabase apps count:', apps?.length || 0);

                    // Read localStorage WITHOUT using cache (since cache is null)
                    const localAppsRaw = JSON.parse(localStorage.getItem('trackedApplications') || '[]');
                    console.log('localStorage apps count:', localAppsRaw?.length || 0);

                    // Only migrate if localStorage has data AND it's from the same user (not cleared above)
                    if ((!apps || apps.length === 0) && localAppsRaw.length > 0 && (!lastUserId || lastUserId === currentUserId)) {
                        console.log('Supabase empty but localStorage has data for same user - migrating...');
                        apps = localAppsRaw;

                        // Migrate localStorage data to Supabase in background
                        migrateToSupabase(localAppsRaw);
                    } else if (apps && apps.length > 0) {
                        // Supabase has data - sync localStorage with Supabase (source of truth)
                        // This ensures deleted apps don't reappear from stale localStorage
                        console.log('Syncing localStorage with Supabase data...');
                        localStorage.setItem('trackedApplications', JSON.stringify(apps));
                    }

                    // Set the global cache so getApplications() returns the right data
                    window.trackerAppsCache = apps;
                    console.log('Set window.trackerAppsCache with', apps?.length || 0, 'apps');

                    renderAll(apps);

                    // Override getApplications and saveApplications for this session
                    window.getApplicationsFromSupabase = async () => await HenryData.getApplications();
                    window.saveApplicationsToSupabase = async (apps) => await HenryData.saveAllApplications(apps);
                    return;
                }
            }
            // Fallback to localStorage
            console.log('Loading data from localStorage...');
            const apps = getApplications();
            console.log('localStorage apps:', apps);
            console.log('localStorage apps count:', apps?.length || 0);
            if (apps.length > 0) {
                console.log('First app status:', apps[0].status);
                console.log('STATUSES[status]:', STATUSES[apps[0].status]);
            }
            // Set the global cache so getApplications() returns consistent data
            window.trackerAppsCache = apps;
            renderAll(apps);
        }

        // Migrate localStorage applications to Supabase
        async function migrateToSupabase(localApps) {
            console.log('Starting migration of', localApps.length, 'apps to Supabase...');
            for (const app of localApps) {
                try {
                    // Add analysisData if we have it stored separately
                    if (app.analysisKey) {
                        const analysisData = localStorage.getItem(app.analysisKey);
                        if (analysisData) {
                            app.analysisData = JSON.parse(analysisData);
                        }
                    }
                    const result = await HenryData.saveApplication(app);
                    if (result.error) {
                        console.error('Migration error for', app.company, ':', result.error);
                    } else {
                        console.log('Migrated:', app.company, app.role);
                    }
                } catch (err) {
                    console.error('Migration exception for', app.company, ':', err);
                }
            }
            console.log('Migration complete!');
        }

        // Start initialization - wait for henryAuthReady event from auth-check.js
        // or fallback to localStorage if no auth
        console.log('=== TRACKER SCRIPT START ===');

        let initialized = false;

        function doInitialize() {
            if (initialized) return;
            initialized = true;
            initializeWithAuth();
        }

        // Listen for auth ready event from auth-check.js
        window.addEventListener('henryAuthReady', (event) => {
            console.log('=== HENRY AUTH READY EVENT ===');
            doInitialize();
        });

        // Also try on DOMContentLoaded as backup
        document.addEventListener('DOMContentLoaded', () => {
            console.log('=== DOM CONTENT LOADED ===');
            // Give auth-check.js a moment to fire its event
            setTimeout(() => {
                if (!initialized) {
                    console.log('Auth event not fired, initializing anyway...');
                    doInitialize();
                }
            }, 500);
        });

        // Also try on window load as final fallback
        window.addEventListener('load', () => {
            console.log('=== WINDOW LOAD ===');
            setTimeout(() => {
                if (!initialized) {
                    console.log('Still not initialized, forcing init...');
                    doInitialize();
                }
            }, 200);
        });
    </script>
<script src="js/supabase-client.js"></script>
<script src="js/auth-check.js"></script>
<script src="components/hey-henry.js"></script>
<script src="components/strategy-nav.js"></script>
<script src="components/interview-notifications.js"></script>
    <script src="components/status-banner.js"></script>
<script src="components/top-nav.js"></script>
</body>
</html>

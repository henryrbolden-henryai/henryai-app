<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interview Debrief - HenryHQ</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Instrument+Serif:ital@0;1&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 100%);
            color: #e0e0e0;
            min-height: 100vh;
            line-height: 1.6;
        }

        header {
            background: rgba(15, 15, 15, 0.95);
            border-bottom: 1px solid #374151;
            padding: 16px 20px;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        header .header-container {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .logo {
            font-family: 'Instrument Serif', Georgia, serif;
            font-size: 1.5rem;
            color: #ffffff;
            text-decoration: none;
        }

        .logo em {
            font-style: italic;
            color: #22d3ee;
        }

        .header-nav {
            display: flex;
            gap: 24px;
            align-items: center;
        }

        .nav-link {
            color: #9ca3af;
            text-decoration: none;
            font-size: 0.9rem;
            transition: color 0.2s ease;
        }

        .nav-link:hover {
            color: #22d3ee;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 40px 20px 120px;
        }

        /* Page Header */
        .page-header {
            margin-bottom: 32px;
        }

        .breadcrumb {
            color: #9ca3af;
            font-size: 0.9rem;
            margin-bottom: 8px;
        }

        .breadcrumb .company {
            color: #f59e0b;
        }

        .page-header h1 {
            font-size: 2rem;
            color: #ffffff;
            margin-bottom: 8px;
        }

        .interview-meta {
            color: #9ca3af;
            font-size: 0.95rem;
        }

        /* Initial Setup Section */
        .setup-section {
            background: #1f2937;
            border: 1px solid #374151;
            border-radius: 16px;
            padding: 32px;
            margin-bottom: 24px;
        }

        .setup-section h2 {
            color: #ffffff;
            font-size: 1.3rem;
            margin-bottom: 8px;
        }

        .setup-section .subtitle {
            color: #9ca3af;
            margin-bottom: 24px;
        }

        /* Feeling Selector */
        .feeling-section {
            margin-bottom: 24px;
        }

        .feeling-label {
            color: #d1d5db;
            font-size: 0.95rem;
            margin-bottom: 12px;
        }

        .feeling-scale {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .feeling-btn {
            width: 44px;
            height: 44px;
            border-radius: 8px;
            border: 1px solid #374151;
            background: #111827;
            color: #9ca3af;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .feeling-btn:hover {
            border-color: #f59e0b;
            color: #ffffff;
        }

        .feeling-btn.selected {
            background: #f59e0b;
            border-color: #f59e0b;
            color: #000000;
        }

        .feeling-labels {
            display: flex;
            justify-content: space-between;
            margin-top: 8px;
            font-size: 0.8rem;
            color: #6b7280;
        }

        /* Transcript Upload */
        .transcript-section {
            margin-bottom: 24px;
        }

        .transcript-label {
            color: #d1d5db;
            font-size: 0.95rem;
            margin-bottom: 8px;
        }

        .transcript-hint {
            color: #6b7280;
            font-size: 0.85rem;
            margin-bottom: 12px;
        }

        .upload-zone {
            display: flex;
            align-items: center;
            gap: 12px;
            background: rgba(255, 255, 255, 0.03);
            border: 2px dashed #374151;
            border-radius: 12px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .upload-zone:hover {
            border-color: #f59e0b;
            background: rgba(245, 158, 11, 0.05);
        }

        .upload-zone .upload-icon {
            font-size: 1.8rem;
        }

        .upload-zone .upload-text {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .upload-zone .upload-primary {
            color: #ffffff;
            font-size: 0.95rem;
        }

        .upload-zone .upload-secondary {
            color: #6b7280;
            font-size: 0.85rem;
        }

        .upload-zone input[type="file"] {
            display: none;
        }

        .uploaded-file {
            margin-top: 12px;
            padding: 12px 16px;
            background: rgba(245, 158, 11, 0.1);
            border-radius: 8px;
            color: #f59e0b;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .uploaded-file .remove-file {
            cursor: pointer;
            opacity: 0.7;
        }

        .uploaded-file .remove-file:hover {
            opacity: 1;
        }

        .or-divider {
            display: flex;
            align-items: center;
            gap: 16px;
            margin: 16px 0;
            color: #6b7280;
            font-size: 0.85rem;
        }

        .or-divider::before,
        .or-divider::after {
            content: '';
            flex: 1;
            height: 1px;
            background: #374151;
        }

        .paste-toggle {
            color: #9ca3af;
            font-size: 0.9rem;
            cursor: pointer;
            transition: color 0.2s;
        }

        .paste-toggle:hover {
            color: #f59e0b;
        }

        .transcript-textarea {
            width: 100%;
            min-height: 150px;
            background: #111827;
            border: 1px solid #374151;
            border-radius: 8px;
            padding: 16px;
            color: #ffffff;
            font-size: 0.95rem;
            resize: vertical;
            margin-top: 12px;
        }

        .transcript-textarea:focus {
            outline: none;
            border-color: #f59e0b;
        }

        .transcript-textarea::placeholder {
            color: #6b7280;
        }

        /* Start Button */
        .start-debrief-btn {
            width: 100%;
            padding: 16px;
            background: #f59e0b;
            border: none;
            border-radius: 10px;
            color: #000000;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .start-debrief-btn:hover {
            background: #d97706;
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(245, 158, 11, 0.3);
        }

        .start-debrief-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* Debrief Complete Button */
        .debrief-complete-section {
            margin-top: 32px;
            padding-top: 24px;
            border-top: 1px solid #374151;
            text-align: center;
        }

        .debrief-complete-btn {
            padding: 16px 32px;
            background: linear-gradient(135deg, #10b981, #059669);
            border: none;
            border-radius: 10px;
            color: #ffffff;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .debrief-complete-btn:hover {
            background: linear-gradient(135deg, #059669, #047857);
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(16, 185, 129, 0.3);
        }

        /* Outcome Selection */
        .outcome-section {
            margin-bottom: 24px;
        }

        .outcome-prompt {
            color: #e5e7eb;
            font-size: 1.1rem;
            margin-bottom: 16px;
            text-align: center;
        }

        .outcome-buttons {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        .outcome-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            padding: 20px 16px;
            background: #1f2937;
            border: 1px solid #374151;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .outcome-btn:hover {
            background: #374151;
            border-color: #22d3ee;
        }

        .outcome-btn.selected {
            background: #22d3ee20;
            border-color: #22d3ee;
        }

        .outcome-icon {
            font-size: 1.25rem;
            color: #9ca3af;
        }

        .outcome-text {
            color: #e5e7eb;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .outcome-subtext {
            color: #6b7280;
            font-size: 0.75rem;
            text-align: center;
            line-height: 1.3;
        }

        /* Signal-Specific Coaching Sections */
        .coaching-section {
            background: #1f2937;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 16px;
            border: 1px solid #374151;
        }

        .coaching-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 1px solid #374151;
        }

        .coaching-header.positive { border-bottom-color: #10b98140; }
        .coaching-header.mixed { border-bottom-color: #f59e0b40; }
        .coaching-header.neutral { border-bottom-color: #6b728040; }
        .coaching-header.waiting { border-bottom-color: #3b82f640; }

        .coaching-icon {
            font-size: 1.5rem;
        }

        .coaching-title {
            color: #ffffff;
            font-size: 1.1rem;
            font-weight: 600;
        }

        .coaching-content {
            color: #d1d5db;
            line-height: 1.7;
            margin-bottom: 20px;
        }

        .coaching-content p {
            margin-bottom: 12px;
        }

        .coaching-content strong {
            color: #f59e0b;
        }

        .coaching-content .highlight {
            background: rgba(245, 158, 11, 0.1);
            padding: 12px 16px;
            border-radius: 8px;
            border-left: 3px solid #f59e0b;
            margin: 16px 0;
        }

        .coaching-content .learning {
            background: rgba(59, 130, 246, 0.1);
            padding: 12px 16px;
            border-radius: 8px;
            border-left: 3px solid #3b82f6;
            margin: 16px 0;
        }

        .coaching-content .reassurance {
            background: rgba(16, 185, 129, 0.1);
            padding: 12px 16px;
            border-radius: 8px;
            border-left: 3px solid #10b981;
            margin: 16px 0;
        }

        .coaching-loading {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            padding: 24px;
            color: #9ca3af;
        }

        .coaching-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-top: 16px;
        }

        .coaching-action-btn {
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
        }

        .coaching-action-btn.primary {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: #000;
        }

        .coaching-action-btn.primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(245, 158, 11, 0.3);
        }

        .coaching-action-btn.secondary {
            background: #374151;
            color: #e5e7eb;
            border: 1px solid #4b5563;
        }

        .coaching-action-btn.secondary:hover {
            background: #4b5563;
            border-color: #6b7280;
        }

        .coaching-action-btn.tertiary {
            background: transparent;
            color: #9ca3af;
            border: 1px solid #374151;
        }

        .coaching-action-btn.tertiary:hover {
            color: #e5e7eb;
            border-color: #4b5563;
        }

        .form-section-title {
            color: #9ca3af;
            font-size: 0.9rem;
            margin-bottom: 16px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .follow-up-output-section {
            margin-top: 20px;
        }

        /* Reflection Checkpoint (Mixed Signal) */
        .reflection-checkpoint,
        .takeaway-checkpoint {
            padding: 8px 0;
        }

        .reflection-prompt,
        .takeaway-prompt {
            color: #e5e7eb;
            font-size: 1rem;
            margin-bottom: 16px;
            line-height: 1.5;
        }

        .reflection-input {
            width: 100%;
            min-height: 100px;
            background: #111827;
            border: 1px solid #374151;
            border-radius: 8px;
            padding: 14px 16px;
            color: #e5e7eb;
            font-size: 0.95rem;
            line-height: 1.5;
            resize: vertical;
            margin-bottom: 16px;
        }

        .reflection-input:focus {
            outline: none;
            border-color: #f59e0b;
        }

        .reflection-input::placeholder {
            color: #6b7280;
            font-style: italic;
        }

        .reflection-timer {
            color: #6b7280;
            font-size: 0.85rem;
            text-align: center;
            margin-bottom: 12px;
            transition: color 0.3s;
        }

        .reflection-timer.ready {
            color: #10b981;
        }

        .takeaway-input-section {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #374151;
        }

        /* Next Round Section (legacy) */
        .next-round-section {
            background: #1f2937;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 16px;
        }

        .next-round-prompt {
            color: #10b981;
            font-size: 1rem;
            margin-bottom: 16px;
            text-align: center;
        }

        .next-round-form {
            display: flex;
            flex-direction: column;
            gap: 16px;
            margin-bottom: 20px;
        }

        .next-round-form .form-row {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .next-round-form label {
            color: #9ca3af;
            font-size: 0.85rem;
        }

        .next-round-form select,
        .next-round-form input {
            padding: 12px;
            background: #111827;
            border: 1px solid #374151;
            border-radius: 8px;
            color: #e5e7eb;
            font-size: 0.95rem;
        }

        .next-round-form select:focus,
        .next-round-form input:focus {
            outline: none;
            border-color: #22d3ee;
        }

        .schedule-next-btn {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #22d3ee, #06b6d4);
            border: none;
            border-radius: 8px;
            color: #000;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 10px;
        }

        .schedule-next-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(34, 211, 238, 0.3);
        }

        .skip-btn {
            width: 100%;
            padding: 12px;
            background: transparent;
            border: 1px solid #374151;
            border-radius: 8px;
            color: #9ca3af;
            cursor: pointer;
            transition: all 0.2s;
        }

        .skip-btn:hover {
            border-color: #9ca3af;
            color: #e5e7eb;
        }

        /* Follow-up Email Section */
        .follow-up-section {
            background: #1f2937;
            border-radius: 12px;
            padding: 20px;
            margin-top: 16px;
            margin-bottom: 16px;
        }

        .follow-up-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 16px;
        }

        .follow-up-icon {
            font-size: 1.2rem;
        }

        .follow-up-title {
            color: #e5e7eb;
            font-size: 1rem;
            font-weight: 500;
        }

        .follow-up-buttons {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
        }

        .follow-up-type-btn {
            flex: 1;
            padding: 12px 16px;
            background: #111827;
            border: 1px solid #374151;
            border-radius: 8px;
            color: #e5e7eb;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .follow-up-type-btn:hover {
            border-color: #22d3ee;
            background: #374151;
        }

        .follow-up-type-btn.active {
            background: #22d3ee20;
            border-color: #22d3ee;
        }

        .follow-up-output {
            background: #111827;
            border-radius: 8px;
            padding: 16px;
        }

        .follow-up-email {
            color: #d1d5db;
            font-size: 0.9rem;
            line-height: 1.6;
            white-space: pre-wrap;
            margin-bottom: 16px;
            max-height: 300px;
            overflow-y: auto;
        }

        .follow-up-actions {
            display: flex;
            gap: 12px;
        }

        .copy-email-btn {
            flex: 1;
            padding: 12px;
            background: linear-gradient(135deg, #10b981, #059669);
            border: none;
            border-radius: 8px;
            color: #fff;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .copy-email-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
        }

        .regenerate-btn {
            padding: 12px 20px;
            background: transparent;
            border: 1px solid #374151;
            border-radius: 8px;
            color: #9ca3af;
            cursor: pointer;
            transition: all 0.2s;
        }

        .regenerate-btn:hover {
            border-color: #9ca3af;
            color: #e5e7eb;
        }

        .follow-up-loading {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            color: #9ca3af;
            padding: 20px;
        }

        /* Chat Section */
        .chat-section {
            display: none;
        }

        .chat-section.active {
            display: block;
        }

        .chat-messages {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-bottom: 24px;
        }

        .message {
            display: flex;
            gap: 12px;
            max-width: 90%;
        }

        .message.assistant {
            align-self: flex-start;
        }

        .message.user {
            align-self: flex-end;
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            flex-shrink: 0;
        }

        .message.assistant .message-avatar {
            background: linear-gradient(135deg, #f59e0b, #d97706);
        }

        .message.user .message-avatar {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
        }

        .message-content {
            background: #1f2937;
            border: 1px solid #374151;
            border-radius: 16px;
            padding: 16px 20px;
            line-height: 1.7;
        }

        .message.user .message-content {
            background: #1e3a5f;
            border-color: #2563eb40;
        }

        .message-content p {
            margin-bottom: 12px;
        }

        .message-content p:last-child {
            margin-bottom: 0;
        }

        .message-content ul, .message-content ol {
            margin: 12px 0;
            padding-left: 20px;
        }

        .message-content li {
            margin-bottom: 8px;
        }

        .message-content strong {
            color: #f59e0b;
        }

        .message-content h3, .message-content h4 {
            color: #ffffff;
            margin: 16px 0 8px 0;
        }

        /* Typing Indicator */
        .typing-indicator {
            display: flex;
            gap: 4px;
            padding: 12px 16px;
            background: #1f2937;
            border: 1px solid #374151;
            border-radius: 16px;
            width: fit-content;
        }

        .typing-indicator .dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #f59e0b;
            animation: typing 1.4s infinite ease-in-out;
        }

        .typing-indicator .dot:nth-child(1) { animation-delay: 0s; }
        .typing-indicator .dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-indicator .dot:nth-child(3) { animation-delay: 0.4s; }

        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); opacity: 0.4; }
            30% { transform: translateY(-8px); opacity: 1; }
        }

        /* Chat Input */
        .chat-input-container {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(to top, #0a0a0a 0%, rgba(10, 10, 10, 0.95) 80%, transparent 100%);
            padding: 20px;
        }

        .chat-input-wrapper {
            max-width: 800px;
            margin: 0 auto;
            display: flex;
            gap: 12px;
        }

        .chat-input {
            flex: 1;
            background: #1f2937;
            border: 1px solid #374151;
            border-radius: 12px;
            padding: 14px 18px;
            color: #ffffff;
            font-size: 0.95rem;
            resize: none;
            min-height: 50px;
            max-height: 150px;
        }

        .chat-input:focus {
            outline: none;
            border-color: #f59e0b;
        }

        .chat-input::placeholder {
            color: #6b7280;
        }

        .send-btn {
            background: #f59e0b;
            border: none;
            border-radius: 12px;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .send-btn:hover {
            background: #d97706;
        }

        .send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .send-btn svg {
            width: 20px;
            height: 20px;
            fill: #000000;
        }

        /* Voice Input Button */
        .voice-btn {
            background: transparent;
            border: 2px solid #374151;
            border-radius: 12px;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }

        .voice-btn:hover {
            border-color: #f59e0b;
            background: rgba(245, 158, 11, 0.1);
        }

        .voice-btn.recording {
            border-color: #ef4444;
            background: rgba(239, 68, 68, 0.2);
            animation: pulse-recording 1.5s infinite;
        }

        .voice-btn svg {
            width: 22px;
            height: 22px;
            fill: #9ca3af;
            transition: fill 0.2s;
        }

        .voice-btn:hover svg {
            fill: #f59e0b;
        }

        .voice-btn.recording svg {
            fill: #ef4444;
        }

        @keyframes pulse-recording {
            0%, 100% {
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4);
            }
            50% {
                box-shadow: 0 0 0 12px rgba(239, 68, 68, 0);
            }
        }

        /* Voice status indicator */
        .voice-status {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: #1f2937;
            border: 1px solid #374151;
            border-radius: 8px;
            padding: 8px 12px;
            font-size: 0.8rem;
            color: #9ca3af;
            white-space: nowrap;
            margin-bottom: 8px;
            display: none;
        }

        .voice-status.show {
            display: block;
        }

        .voice-status.recording {
            color: #ef4444;
            border-color: #ef4444;
        }

        /* Voice not supported message */
        .voice-not-supported {
            display: none;
            color: #6b7280;
            font-size: 0.8rem;
            text-align: center;
            margin-top: 8px;
        }

        .voice-not-supported.show {
            display: block;
        }

        /* Quick Actions */
        .quick-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-bottom: 16px;
        }

        .quick-action-btn {
            background: rgba(245, 158, 11, 0.1);
            border: 1px solid rgba(245, 158, 11, 0.3);
            border-radius: 20px;
            padding: 8px 16px;
            color: #f59e0b;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .quick-action-btn:hover {
            background: rgba(245, 158, 11, 0.2);
            border-color: #f59e0b;
        }

        /* Loading state */
        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 60px;
            color: #9ca3af;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #374151;
            border-top-color: #f59e0b;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 16px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Responsive */
        @media (max-width: 640px) {
            .feeling-scale {
                justify-content: center;
            }

            .feeling-btn {
                width: 40px;
                height: 40px;
                font-size: 0.9rem;
            }

            .message {
                max-width: 95%;
            }

            .quick-actions {
                justify-content: center;
            }
        }

        /* Story Bank Toast Notification */
        .story-bank-toast {
            position: fixed;
            bottom: 24px;
            right: 24px;
            background: linear-gradient(135deg, #1f2937 0%, #111827 100%);
            border: 1px solid #374151;
            border-left: 3px solid #22d3ee;
            border-radius: 12px;
            padding: 16px 20px;
            display: flex;
            align-items: center;
            gap: 12px;
            z-index: 1000;
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.3s ease;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .story-bank-toast.visible {
            opacity: 1;
            transform: translateY(0);
        }

        .story-bank-toast .toast-icon {
            font-size: 1.4rem;
        }

        .story-bank-toast .toast-message {
            color: #e5e7eb;
            font-size: 0.95rem;
        }

        .story-bank-toast .toast-link {
            color: #22d3ee;
            text-decoration: none;
            font-size: 0.9rem;
            font-weight: 500;
            white-space: nowrap;
            transition: color 0.2s;
        }

        .story-bank-toast .toast-link:hover {
            color: #67e8f9;
        }

        @media (max-width: 768px) {
            .story-bank-toast {
                bottom: 16px;
                right: 16px;
                left: 16px;
                flex-wrap: wrap;
            }
        }
    </style>
    <link rel="stylesheet" href="css/mobile.css">
    <!-- Supabase Auth -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/supabase-client.js"></script>
</head>
<body>
    <!-- HEADER -->
    <header>
        <div class="header-container">
            <a href="/index" class="logo"><em>Henry</em>HQ</a>
        </div>
    </header>

    <div class="container">
        <div class="page-header">
            <div class="breadcrumb"><span class="company" id="companyName">Company</span> &middot; <span id="interviewType">Interview</span></div>
            <h1>Interview Debrief</h1>
            <p class="interview-meta" id="interviewMeta">Let's reflect on how it went</p>
        </div>

        <!-- Initial Setup -->
        <div class="setup-section" id="setupSection">
            <h2>How did the interview go?</h2>
            <p class="subtitle">Share your thoughts and any notes to get personalized coaching.</p>

            <!-- Feeling Scale -->
            <div class="feeling-section">
                <div class="feeling-label">How do you feel it went? (1 = terrible, 10 = nailed it)</div>
                <div class="feeling-scale" id="feelingScale">
                    <button class="feeling-btn" data-value="1">1</button>
                    <button class="feeling-btn" data-value="2">2</button>
                    <button class="feeling-btn" data-value="3">3</button>
                    <button class="feeling-btn" data-value="4">4</button>
                    <button class="feeling-btn" data-value="5">5</button>
                    <button class="feeling-btn" data-value="6">6</button>
                    <button class="feeling-btn" data-value="7">7</button>
                    <button class="feeling-btn" data-value="8">8</button>
                    <button class="feeling-btn" data-value="9">9</button>
                    <button class="feeling-btn" data-value="10">10</button>
                </div>
                <div class="feeling-labels">
                    <span>Rough</span>
                    <span>Nailed it</span>
                </div>
            </div>

            <!-- Transcript Upload -->
            <div class="transcript-section">
                <div class="transcript-label">Interview transcript or notes (optional)</div>
                <div class="transcript-hint">Upload a recording, transcript, or paste what you remember. Audio/video will be automatically transcribed.</div>

                <!-- Recording Upload -->
                <div class="upload-zone" id="recordingUploadZone" onclick="document.getElementById('recordingFile').click()">
                    <div class="upload-icon">üéôÔ∏è</div>
                    <div class="upload-text">
                        <span class="upload-primary">Upload interview recording</span>
                        <span class="upload-secondary">.mp3, .m4a, .wav, .mp4, .mov, .webm</span>
                    </div>
                    <input type="file" id="recordingFile" accept="audio/*,video/*,.mp3,.m4a,.wav,.webm,.mp4,.mov" onchange="handleRecordingUpload(event)">
                </div>
                <div id="uploadedRecording" class="uploaded-file" style="display: none;"></div>
                <div id="transcriptionProgress" style="display: none; margin-top: 12px; padding: 16px; background: rgba(245, 158, 11, 0.1); border-radius: 8px; text-align: center;">
                    <div style="display: flex; align-items: center; justify-content: center; gap: 10px; color: #f59e0b;">
                        <div class="loading-spinner" style="width: 20px; height: 20px; border-width: 2px;"></div>
                        <span id="transcriptionStatus">Transcribing recording...</span>
                    </div>
                </div>

                <div class="or-divider">or</div>

                <!-- Text/Document Upload -->
                <div class="upload-zone" id="uploadZone" onclick="document.getElementById('transcriptFile').click()">
                    <div class="upload-icon">üìÑ</div>
                    <div class="upload-text">
                        <span class="upload-primary">Upload transcript file</span>
                        <span class="upload-secondary">.txt, .pdf, or .docx</span>
                    </div>
                    <input type="file" id="transcriptFile" accept=".txt,.pdf,.docx,text/*" onchange="handleTranscriptUpload(event)">
                </div>
                <div id="uploadedFile" class="uploaded-file" style="display: none;"></div>

                <div class="or-divider">or</div>

                <div class="paste-toggle" onclick="togglePasteSection()">Paste notes or transcript manually ‚ñº</div>
                <div id="pasteSection" style="display: none;">
                    <textarea
                        class="transcript-textarea"
                        id="transcriptText"
                        placeholder="Paste your interview notes, transcript, or anything you remember from the conversation...

Examples of helpful info:
- Questions they asked
- Your answers (rough summaries are fine)
- Topics that came up
- Things you wish you'd said differently"
                    ></textarea>
                </div>
            </div>

            <button class="start-debrief-btn" id="startDebriefBtn" onclick="startDebrief()">
                Start Debrief Conversation
            </button>
        </div>

        <!-- Chat Section -->
        <div class="chat-section" id="chatSection">
            <div class="quick-actions" id="quickActions">
                <button class="quick-action-btn" onclick="sendQuickAction('What should I have said differently?')">What should I have said differently?</button>
                <button class="quick-action-btn" onclick="sendQuickAction('Help me write a thank-you email')">Write thank-you email</button>
                <button class="quick-action-btn" onclick="sendQuickAction('How should I prepare for the next round?')">Prep for next round</button>
            </div>
            <div class="chat-messages" id="chatMessages">
                <!-- Messages will be added here -->
            </div>
            <div class="debrief-complete-section" id="debriefCompleteSection" style="display: none;">
                <div class="outcome-section" id="outcomeSection">
                    <p class="outcome-prompt">What signal did you get?</p>
                    <div class="outcome-buttons">
                        <button class="outcome-btn" data-outcome="strong_positive" onclick="selectOutcome('strong_positive')">
                            <span class="outcome-icon">‚úì</span>
                            <span class="outcome-text">Strong positive signal</span>
                            <span class="outcome-subtext">Felt aligned, good energy, clear next steps</span>
                        </button>
                        <button class="outcome-btn" data-outcome="mixed" onclick="selectOutcome('mixed')">
                            <span class="outcome-icon">~</span>
                            <span class="outcome-text">Mixed / unclear signal</span>
                            <span class="outcome-subtext">Some traction, some flags, no clarity yet</span>
                        </button>
                        <button class="outcome-btn" data-outcome="likely_no" onclick="selectOutcome('likely_no')">
                            <span class="outcome-icon">‚úï</span>
                            <span class="outcome-text">Likely no</span>
                            <span class="outcome-subtext">Energy off, gaps exposed, or soft rejection</span>
                        </button>
                        <button class="outcome-btn" data-outcome="awaiting" onclick="selectOutcome('awaiting')">
                            <span class="outcome-icon">...</span>
                            <span class="outcome-text">Awaiting response</span>
                            <span class="outcome-subtext">No signal yet, timing dependent</span>
                        </button>
                    </div>
                </div>
                <!-- SIGNAL-SPECIFIC COACHING SECTIONS -->

                <!-- Strong Positive: Reinforce + Next Round -->
                <div class="coaching-section" id="coachingStrongPositive" style="display: none;">
                    <div class="coaching-header positive">
                        <span class="coaching-icon">üî•</span>
                        <span class="coaching-title">You're in a strong position</span>
                    </div>
                    <div class="coaching-content" id="strongPositiveCoaching">
                        <div class="coaching-loading">
                            <div class="loading-spinner"></div>
                            <span>Generating coaching...</span>
                        </div>
                    </div>
                    <div class="coaching-actions">
                        <button class="coaching-action-btn primary" onclick="generateFollowUp('thank_you')">
                            ‚úâÔ∏è Draft thank-you email
                        </button>
                    </div>
                    <div class="next-round-form" id="nextRoundForm" style="margin-top: 20px;">
                        <p class="form-section-title">Schedule your next round</p>
                        <div class="form-row">
                            <label>Interview Type</label>
                            <select id="nextRoundType">
                                <option value="hiring_manager">Hiring Manager</option>
                                <option value="technical">Technical</option>
                                <option value="panel">Panel Interview</option>
                                <option value="final">Final Round</option>
                            </select>
                        </div>
                        <div class="form-row">
                            <label>Date & Time (if known)</label>
                            <input type="datetime-local" id="nextRoundDate" />
                        </div>
                        <div class="form-row">
                            <label>Interviewer Name (if known)</label>
                            <input type="text" id="nextRoundInterviewer" placeholder="e.g., Sarah Chen" />
                        </div>
                        <button class="schedule-next-btn" onclick="scheduleNextRound()">
                            Schedule Next Round
                        </button>
                        <button class="skip-btn" onclick="skipToComplete()">
                            I'll add details later
                        </button>
                    </div>
                </div>

                <!-- Mixed Signal: Reflect + Adjust -->
                <div class="coaching-section" id="coachingMixed" style="display: none;">
                    <div class="coaching-header mixed">
                        <span class="coaching-icon">üéØ</span>
                        <span class="coaching-title">Let's unpack what happened</span>
                    </div>
                    <!-- Phase 1: Reflection checkpoint (30 seconds minimum) -->
                    <div class="reflection-checkpoint" id="mixedReflectionCheckpoint">
                        <p class="reflection-prompt">Before we get tactical‚Äîwas there a moment where you felt the energy shift?</p>
                        <textarea class="reflection-input" id="mixedReflectionInput" placeholder="A question that caught you off guard, a point where your answer wasn't landing, a topic that seemed to change the room..."></textarea>
                        <div class="reflection-timer" id="mixedReflectionTimer">Take a moment</div>
                        <button class="coaching-action-btn primary" id="mixedReflectionSubmit" onclick="submitMixedReflection()" disabled>
                            Continue
                        </button>
                    </div>
                    <!-- Phase 2: Coaching (shown after reflection) -->
                    <div class="coaching-content" id="mixedCoaching" style="display: none;">
                        <div class="coaching-loading">
                            <div class="loading-spinner"></div>
                            <span>Processing your reflection...</span>
                        </div>
                    </div>
                    <div class="coaching-actions" id="mixedActions" style="display: none;">
                        <button class="coaching-action-btn primary" onclick="generateFollowUp('strategic')">
                            ‚úâÔ∏è Draft strategic follow-up
                        </button>
                        <button class="coaching-action-btn secondary" onclick="continueReflection()">
                            üí≠ Keep reflecting
                        </button>
                    </div>
                </div>

                <!-- Likely No: Contain + Extract + Move -->
                <div class="coaching-section" id="coachingLikelyNo" style="display: none;">
                    <div class="coaching-header neutral">
                        <span class="coaching-icon">üìù</span>
                        <span class="coaching-title">Extract the lesson, move forward</span>
                    </div>
                    <!-- Phase 1: Takeaway extraction -->
                    <div class="takeaway-checkpoint" id="likelyNoTakeawayCheckpoint">
                        <div class="coaching-content" id="likelyNoCoaching">
                            <div class="coaching-loading">
                                <div class="loading-spinner"></div>
                                <span>Processing...</span>
                            </div>
                        </div>
                        <div class="takeaway-input-section" id="takeawayInputSection" style="display: none;">
                            <p class="takeaway-prompt">One thing you wish you'd said differently:</p>
                            <textarea class="reflection-input" id="takeawayInput" placeholder="Not the whole interview. Just one moment."></textarea>
                            <button class="coaching-action-btn primary" onclick="submitTakeaway()">
                                Save this for next time
                            </button>
                        </div>
                    </div>
                    <!-- Phase 2: Actions (shown after takeaway) -->
                    <div class="coaching-actions" id="likelyNoActions" style="display: none;">
                        <button class="coaching-action-btn primary" onclick="goToCommandCenter()">
                            ‚Üí Back to pipeline
                        </button>
                        <button class="coaching-action-btn secondary" onclick="showPracticeRecommendation()">
                            üéØ Work on that skill
                        </button>
                    </div>
                </div>

                <!-- Awaiting Response: Prevent Spiral -->
                <div class="coaching-section" id="coachingAwaiting" style="display: none;">
                    <div class="coaching-header waiting">
                        <span class="coaching-icon">‚è±Ô∏è</span>
                        <span class="coaching-title">The waiting game</span>
                    </div>
                    <div class="coaching-content" id="awaitingCoaching">
                        <div class="coaching-loading">
                            <div class="loading-spinner"></div>
                            <span>Loading guidance...</span>
                        </div>
                    </div>
                    <div class="coaching-actions" id="awaitingActions" style="display: none;">
                        <button class="coaching-action-btn primary" onclick="generateFollowUp('thank_you')">
                            ‚úâÔ∏è Send thank-you now
                        </button>
                        <button class="coaching-action-btn secondary" onclick="scheduleCheckIn()">
                            üìÖ Set follow-up reminder
                        </button>
                        <button class="coaching-action-btn tertiary" onclick="goToCommandCenter()">
                            ‚Üí Focus on other opportunities
                        </button>
                    </div>
                </div>

                <!-- Shared Follow-up Email Output -->
                <div class="follow-up-output-section" id="followUpOutputSection" style="display: none;">
                    <div class="follow-up-output">
                        <div class="follow-up-email" id="followUpEmail"></div>
                        <div class="follow-up-actions">
                            <button class="copy-email-btn" onclick="copyFollowUpEmail()">
                                <span id="copyBtnText">Copy to Clipboard</span>
                            </button>
                            <button class="regenerate-btn" onclick="regenerateFollowUp()">
                                Regenerate
                            </button>
                        </div>
                    </div>
                </div>
                <button class="debrief-complete-btn" id="goToCommandCenterBtn" onclick="goToCommandCenter()" style="display: none;">
                    Done ‚Üí Go to Command Center
                </button>
            </div>
        </div>
    </div>

    <!-- Chat Input (fixed at bottom) -->
    <div class="chat-input-container" id="chatInputContainer" style="display: none;">
        <div class="chat-input-wrapper">
            <textarea
                class="chat-input"
                id="chatInput"
                placeholder="Type or tap the mic to speak..."
                rows="1"
                onkeydown="handleKeyDown(event)"
            ></textarea>
            <button class="voice-btn" id="voiceBtn" onclick="toggleVoiceInput()" title="Click to speak">
                <div class="voice-status" id="voiceStatus">Listening...</div>
                <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm-1-9c0-.55.45-1 1-1s1 .45 1 1v6c0 .55-.45 1-1 1s-1-.45-1-1V5zm6 6c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/>
                </svg>
            </button>
            <button class="send-btn" id="sendBtn" onclick="sendMessage()">
                <svg viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
            </button>
        </div>
        <div class="voice-not-supported" id="voiceNotSupported">
            Voice input not supported in this browser. Please type your response.
        </div>
    </div>

    <script>
        // ============================================================================
        // STATE
        // ============================================================================
        let currentInterview = null;
        let resumeData = null;
        let analysisData = null;
        let conversationHistory = [];
        let transcriptText = '';
        let transcriptFileData = null;
        let selectedFeeling = null;
        let selectedOutcome = null;
        let isLoading = false;

        const API_BASE = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
            ? 'http://localhost:8000'
            : 'https://henryai-app-production.up.railway.app';

        // ============================================================================
        // INITIALIZATION
        // ============================================================================
        document.addEventListener('DOMContentLoaded', () => {
            // Load interview - check both upcoming and completed
            const interviewId = sessionStorage.getItem('currentInterviewId');
            const upcomingInterviews = JSON.parse(localStorage.getItem('upcomingInterviews') || '[]');
            const completedInterviews = JSON.parse(localStorage.getItem('completedInterviews') || '[]');

            console.log('Looking for interview ID:', interviewId);
            console.log('Upcoming interviews:', upcomingInterviews.map(i => ({ id: i.id, type: typeof i.id })));
            console.log('Completed interviews:', completedInterviews.map(i => ({ id: i.id, type: typeof i.id })));

            // Handle both string and number ID comparisons
            currentInterview = upcomingInterviews.find(i => String(i.id) === String(interviewId))
                || completedInterviews.find(i => String(i.id) === String(interviewId));

            if (!currentInterview) {
                console.error('Interview not found for ID:', interviewId);
                alert('Interview not found. Returning to Interview Intelligence.');
                window.location.href = '/interview-intelligence';
                return;
            }

            console.log('Found interview:', currentInterview);

            // Load resume and analysis data
            const storedResume = sessionStorage.getItem('resumeData');
            if (storedResume) {
                try {
                    resumeData = JSON.parse(storedResume);
                } catch (e) {
                    console.error('Error parsing resume data:', e);
                }
            }

            const storedAnalysis = sessionStorage.getItem('analysisData');
            if (storedAnalysis) {
                try {
                    analysisData = JSON.parse(storedAnalysis);
                } catch (e) {
                    console.error('Error parsing analysis data:', e);
                }
            }

            // Update UI with interview info
            updateInterviewInfo();

            // Setup feeling buttons
            setupFeelingButtons();

            // Setup drag and drop
            setupDragAndDrop();

            // Check if there's a saved debrief for this interview
            loadSavedDebrief();
        });

        // ============================================================================
        // DEBRIEF PERSISTENCE
        // ============================================================================
        function getDebriefStorageKey() {
            return `debrief_${currentInterview.id}`;
        }

        function saveDebrief() {
            if (!currentInterview) return;

            const debriefData = {
                interviewId: currentInterview.id,
                feeling: selectedFeeling,
                transcript: transcriptText,
                conversationHistory: conversationHistory,
                completedAt: new Date().toISOString()
            };

            localStorage.setItem(getDebriefStorageKey(), JSON.stringify(debriefData));
        }

        function showDebriefCompleteButton() {
            const section = document.getElementById('debriefCompleteSection');
            if (section) {
                section.style.display = 'block';
            }
        }

        async function goToCommandCenter() {
            // Show loading state while extracting
            const completeBtn = document.querySelector('.debrief-complete-btn');
            if (completeBtn) {
                completeBtn.disabled = true;
                completeBtn.textContent = 'Saving insights...';
            }

            // Extract and store structured debrief data
            await extractAndStoreDebrief();

            // Ensure the interview is synced to Command Center before navigating
            if (currentInterview) {
                // Make sure debrief info is set on the interview object
                currentInterview.debriefCompleted = true;
                currentInterview.debriefCompletedAt = currentInterview.debriefCompletedAt || new Date().toISOString();
                currentInterview.feeling = selectedFeeling || currentInterview.feeling;
                currentInterview.outcome = selectedOutcome;
                currentInterview.needsDebrief = false;

                console.log('Syncing interview to tracker:', currentInterview);
                syncInterviewToTracker(currentInterview);

                // Also update completedInterviews directly to ensure Interview Intelligence shows correct state
                updateCompletedInterviewsWithOutcome();
            } else {
                console.error('No currentInterview found to sync');
            }
            window.location.href = '/tracker';
        }

        function updateCompletedInterviewsWithOutcome() {
            try {
                const completedInterviews = JSON.parse(localStorage.getItem('completedInterviews') || '[]');
                const idx = completedInterviews.findIndex(i => String(i.id) === String(currentInterview.id));
                if (idx > -1) {
                    completedInterviews[idx].debriefCompleted = true;
                    completedInterviews[idx].debriefCompletedAt = currentInterview.debriefCompletedAt;
                    completedInterviews[idx].feeling = selectedFeeling;
                    completedInterviews[idx].outcome = selectedOutcome;
                    completedInterviews[idx].needsDebrief = false;
                    localStorage.setItem('completedInterviews', JSON.stringify(completedInterviews));
                    console.log('Updated completedInterviews with outcome:', selectedOutcome);
                }
            } catch (e) {
                console.error('Error updating completedInterviews:', e);
            }
        }

        /**
         * Extract structured data from debrief conversation and store in Supabase
         * This feeds the intelligence loop for future interview prep
         */
        async function extractAndStoreDebrief() {
            // Need conversation history and HenryData to proceed
            if (conversationHistory.length === 0 || typeof window.HenryData === 'undefined') {
                console.log('Skipping debrief extraction - no conversation or HenryData unavailable');
                return;
            }

            try {
                // Format conversation as text for extraction
                const conversationText = conversationHistory
                    .map(msg => `${msg.role === 'user' ? 'User' : 'Henry'}: ${msg.content}`)
                    .join('\n\n');

                console.log('Extracting structured data from debrief conversation...');

                // Call the extraction endpoint
                const response = await fetch(`${API_BASE}/api/debriefs/extract`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        conversation: conversationText,
                        company: currentInterview?.company || 'Unknown',
                        role: currentInterview?.role || null,
                        interview_type: currentInterview?.type || null,
                        application_id: null
                    })
                });

                if (!response.ok) {
                    console.error('Debrief extraction failed:', response.status);
                    return;
                }

                const extractionResult = await response.json();
                console.log('‚úÖ Extracted debrief data:', extractionResult);

                // Store the structured debrief in Supabase
                const debriefData = {
                    company: currentInterview?.company || 'Unknown',
                    role: currentInterview?.role,
                    interview_date: currentInterview?.date ? new Date(currentInterview.date).toISOString().split('T')[0] : null,
                    raw_conversation: conversationText,
                    ...extractionResult.structured_data
                };

                const { data: savedDebrief, error: debriefError } = await window.HenryData.createDebrief(debriefData);

                if (debriefError) {
                    console.error('Failed to save debrief to Supabase:', debriefError);
                } else {
                    console.log('‚úÖ Saved structured debrief:', savedDebrief?.id);

                    // Save extracted stories to the story bank
                    if (extractionResult.stories_extracted && extractionResult.stories_extracted.length > 0) {
                        for (const story of extractionResult.stories_extracted) {
                            await window.HenryData.addStory({
                                story_name: story.name,
                                story_context: story.context,
                                effectiveness: story.effectiveness,
                                interview_id: savedDebrief?.id,
                                demonstrates: story.demonstrates || [],
                                best_for_questions: story.best_for_questions || []
                            });
                        }
                        console.log(`‚úÖ Saved ${extractionResult.stories_extracted.length} stories to story bank`);

                        // Show toast notification with link to story bank
                        showStoryBankToast(extractionResult.stories_extracted.length);
                    }
                }

            } catch (error) {
                console.error('Error extracting/storing debrief:', error);
                // Don't block navigation on extraction failure
            }
        }

        // ============================================================================
        // STORY BANK TOAST NOTIFICATION
        // ============================================================================
        function showStoryBankToast(count) {
            // Create toast element
            const toast = document.createElement('div');
            toast.className = 'story-bank-toast';
            toast.innerHTML = `
                <span class="toast-icon">üìö</span>
                <span class="toast-message">${count} ${count === 1 ? 'story' : 'stories'} saved to your Story Bank</span>
                <a href="/story-bank" class="toast-link">View Stories ‚Üí</a>
            `;
            document.body.appendChild(toast);

            // Animate in
            setTimeout(() => toast.classList.add('visible'), 100);

            // Auto dismiss after 6 seconds
            setTimeout(() => {
                toast.classList.remove('visible');
                setTimeout(() => toast.remove(), 300);
            }, 6000);
        }

        // ============================================================================
        // OUTCOME TRACKING
        // ============================================================================
        function selectOutcome(outcome) {
            selectedOutcome = outcome;

            // Update button states
            document.querySelectorAll('.outcome-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            const selectedBtn = document.querySelector(`.outcome-btn[data-outcome="${outcome}"]`);
            if (selectedBtn) {
                selectedBtn.classList.add('selected');
            }

            // Hide all coaching sections first
            document.getElementById('coachingStrongPositive').style.display = 'none';
            document.getElementById('coachingMixed').style.display = 'none';
            document.getElementById('coachingLikelyNo').style.display = 'none';
            document.getElementById('coachingAwaiting').style.display = 'none';
            document.getElementById('followUpOutputSection').style.display = 'none';
            document.getElementById('goToCommandCenterBtn').style.display = 'none';

            // Update status based on signal
            if (currentInterview && outcome === 'likely_no') {
                updateTrackerStatus('Rejected');
            }

            // Branch immediately to signal-specific coaching
            switch (outcome) {
                case 'strong_positive':
                    document.getElementById('coachingStrongPositive').style.display = 'block';
                    generateSignalCoaching('strong_positive');
                    break;
                case 'mixed':
                    // Show reflection checkpoint first, don't auto-generate coaching
                    document.getElementById('coachingMixed').style.display = 'block';
                    startMixedReflectionTimer();
                    break;
                case 'likely_no':
                    document.getElementById('coachingLikelyNo').style.display = 'block';
                    generateSignalCoaching('likely_no');
                    break;
                case 'awaiting':
                    document.getElementById('coachingAwaiting').style.display = 'block';
                    generateSignalCoaching('awaiting');
                    break;
            }
        }

        // Generate signal-specific coaching based on outcome
        async function generateSignalCoaching(signal) {
            const contentMap = {
                'strong_positive': 'strongPositiveCoaching',
                'mixed': 'mixedCoaching',
                'likely_no': 'likelyNoCoaching',
                'awaiting': 'awaitingCoaching'
            };
            const actionsMap = {
                'mixed': 'mixedActions',
                'awaiting': 'awaitingActions'
                // Note: likely_no actions shown after takeaway, not after coaching
            };

            const contentEl = document.getElementById(contentMap[signal]);
            const actionsEl = actionsMap[signal] ? document.getElementById(actionsMap[signal]) : null;

            try {
                // Build debrief context from conversation
                let debriefContext = '';
                if (conversationHistory.length > 0) {
                    debriefContext = conversationHistory
                        .map(m => `${m.role === 'user' ? 'Candidate' : 'Coach'}: ${m.content}`)
                        .join('\n\n')
                        .substring(0, 3000);
                }

                // For mixed signals, include the reflection they just wrote
                let reflectionContext = '';
                if (signal === 'mixed' && mixedReflectionText) {
                    reflectionContext = `\n\nCandidate's reflection on what shifted: ${mixedReflectionText}`;
                }

                const response = await fetch(`${API_BASE}/api/debrief/signal-coaching`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        signal: signal,
                        feeling: selectedFeeling,
                        company: currentInterview?.company,
                        role: currentInterview?.role,
                        interview_type: currentInterview?.type,
                        debrief_context: debriefContext + reflectionContext,
                        candidate_name: resumeData?.name || null,
                        reflection: mixedReflectionText || null
                    })
                });

                if (!response.ok) throw new Error('Failed to generate coaching');

                const data = await response.json();
                contentEl.innerHTML = formatCoachingContent(data.coaching, signal);

                // Signal-specific post-coaching actions
                handlePostCoaching(signal, actionsEl);

            } catch (error) {
                console.error('Error generating coaching:', error);
                // Fallback to static coaching
                contentEl.innerHTML = formatCoachingContent(getStaticCoaching(signal), signal);
                handlePostCoaching(signal, actionsEl);
            }
        }

        function handlePostCoaching(signal, actionsEl) {
            switch (signal) {
                case 'strong_positive':
                    // Show done button
                    document.getElementById('goToCommandCenterBtn').style.display = 'block';
                    break;
                case 'mixed':
                    // Show follow-up actions
                    if (actionsEl) actionsEl.style.display = 'flex';
                    document.getElementById('goToCommandCenterBtn').style.display = 'block';
                    break;
                case 'likely_no':
                    // Show takeaway input first, not actions yet
                    showTakeawayInput();
                    break;
                case 'awaiting':
                    // Show actions
                    if (actionsEl) actionsEl.style.display = 'flex';
                    break;
            }
        }

        function formatCoachingContent(text, signal) {
            // Convert markdown-like formatting to styled HTML
            let html = text
                .split('\n\n')
                .map(para => {
                    // Highlight boxes based on signal
                    if (para.startsWith('**Leverage:**') || para.startsWith('**Double down on:**')) {
                        return `<div class="highlight">${para.replace(/\*\*(.+?):\*\*/, '<strong>$1:</strong>')}</div>`;
                    }
                    if (para.startsWith('**Learning:**') || para.startsWith('**Takeaway:**')) {
                        return `<div class="learning">${para.replace(/\*\*(.+?):\*\*/, '<strong>$1:</strong>')}</div>`;
                    }
                    if (para.startsWith('**Remember:**') || para.startsWith('**Reality check:**')) {
                        return `<div class="reassurance">${para.replace(/\*\*(.+?):\*\*/, '<strong>$1:</strong>')}</div>`;
                    }
                    // Regular paragraphs with bold/italic
                    return `<p>${para
                        .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
                        .replace(/\*(.+?)\*/g, '<em>$1</em>')
                    }</p>`;
                })
                .join('');
            return html;
        }

        function getStaticCoaching(signal) {
            const company = currentInterview?.company || 'the company';

            switch (signal) {
                case 'strong_positive':
                    return `Good energy coming out of that one. Now let's make sure you don't leave momentum on the table.

**Leverage:** Your instincts are telling you something landed. Trust that. In your thank-you email, reference one specific moment from the conversation that felt like genuine connection‚Äînot generic enthusiasm.

**Double down on:** Whatever made them light up, that's your edge. Make sure you can articulate that same energy in the next round with a different interviewer who wasn't in the room.

Don't over-prepare yourself out of the authenticity that got you here.`;

                case 'mixed':
                    return `Mixed signals are the most common outcome‚Äîand the most coachable. Let's figure out what actually happened.

Before I give you tactical advice, I need you to be honest with yourself: Was there a moment where you felt the energy shift? A question that caught you off guard? A point where you knew your answer wasn't landing?

**Learning:** The gap between "it went okay" and "they're moving forward" is usually one of two things: Either you didn't connect your experience to *their* specific problem, or you said something that raised an unstated concern.

Your follow-up email is a chance to address whichever one it was‚Äîwithout being defensive. One clean clarification. One proof point they didn't hear the first time.`;

                case 'likely_no':
                    return `This happens. To everyone. More than anyone admits.

Let's not dwell‚Äîlet's extract the lesson and move. One question: What's the *one thing* you wish you'd said differently? Not the whole interview. Just one moment.

**Takeaway:** That moment is your coaching for the next one. Write it down somewhere you'll see it before your next interview.

**Remember:** Rejection rarely means "you're not good enough." It usually means "not the right fit for this specific team, this specific moment." The same skills that didn't land here might be exactly what another team needs.

You've got other shots in play. Let's go focus on those.`;

                case 'awaiting':
                    return `The waiting is the hardest part. Let's make sure you don't spiral.

**Reality check:** Most interview processes take longer than they say. "We'll get back to you by Friday" often means "sometime next week." This is not a reflection of how well you did.

Here's what you should do:
1. Send a thank-you email today if you haven't already
2. Set a calendar reminder to follow up in 5-7 business days
3. Do NOT check your email every 30 minutes‚Äîit won't make them respond faster

The best thing you can do while waiting is keep other opportunities moving. Pipeline momentum is the antidote to interview anxiety.`;
            }
            return '';
        }

        function skipToComplete() {
            document.getElementById('goToCommandCenterBtn').style.display = 'block';
        }

        function continueReflection() {
            // Scroll back to chat and add a prompt
            document.getElementById('chatInput').focus();
            document.getElementById('chatInput').placeholder = 'Tell me more about that moment...';
        }

        function showPracticeRecommendation() {
            // Navigate to practice drills with a suggested skill
            window.location.href = '/practice-drills';
        }

        // ============================================================================
        // MIXED SIGNAL: REFLECTION CHECKPOINT
        // ============================================================================
        let mixedReflectionTimer = null;
        let mixedReflectionSeconds = 30;
        let mixedReflectionText = '';

        function startMixedReflectionTimer() {
            const timerEl = document.getElementById('mixedReflectionTimer');
            const submitBtn = document.getElementById('mixedReflectionSubmit');
            const inputEl = document.getElementById('mixedReflectionInput');

            mixedReflectionSeconds = 30;
            timerEl.textContent = 'Take a moment (30s)';
            timerEl.classList.remove('ready');
            submitBtn.disabled = true;

            // Enable on input OR after timer
            inputEl.addEventListener('input', function() {
                mixedReflectionText = this.value;
                // If they've written something meaningful (>20 chars), enable early
                if (this.value.trim().length > 20) {
                    enableMixedReflectionSubmit();
                }
            });

            mixedReflectionTimer = setInterval(() => {
                mixedReflectionSeconds--;
                if (mixedReflectionSeconds > 0) {
                    timerEl.textContent = `Take a moment (${mixedReflectionSeconds}s)`;
                } else {
                    enableMixedReflectionSubmit();
                }
            }, 1000);
        }

        function enableMixedReflectionSubmit() {
            if (mixedReflectionTimer) {
                clearInterval(mixedReflectionTimer);
                mixedReflectionTimer = null;
            }
            const timerEl = document.getElementById('mixedReflectionTimer');
            const submitBtn = document.getElementById('mixedReflectionSubmit');

            timerEl.textContent = 'Ready when you are';
            timerEl.classList.add('ready');
            submitBtn.disabled = false;
        }

        async function submitMixedReflection() {
            const inputEl = document.getElementById('mixedReflectionInput');
            mixedReflectionText = inputEl.value.trim();

            // Hide reflection checkpoint, show coaching
            document.getElementById('mixedReflectionCheckpoint').style.display = 'none';
            document.getElementById('mixedCoaching').style.display = 'block';

            // Now generate coaching that incorporates their reflection
            await generateSignalCoaching('mixed');
        }

        // ============================================================================
        // LIKELY NO: TAKEAWAY EXTRACTION
        // ============================================================================
        let extractedTakeaway = '';

        function showTakeawayInput() {
            document.getElementById('takeawayInputSection').style.display = 'block';
        }

        async function submitTakeaway() {
            const inputEl = document.getElementById('takeawayInput');
            extractedTakeaway = inputEl.value.trim();

            if (extractedTakeaway) {
                // Store the takeaway for future reference
                try {
                    const takeaways = JSON.parse(localStorage.getItem('interviewTakeaways') || '[]');
                    takeaways.push({
                        company: currentInterview?.company,
                        role: currentInterview?.role,
                        date: new Date().toISOString(),
                        takeaway: extractedTakeaway
                    });
                    localStorage.setItem('interviewTakeaways', JSON.stringify(takeaways));
                } catch (e) {
                    console.error('Error saving takeaway:', e);
                }
            }

            // Hide takeaway section, show final actions
            document.getElementById('likelyNoTakeawayCheckpoint').style.display = 'none';
            document.getElementById('likelyNoActions').style.display = 'flex';
            document.getElementById('goToCommandCenterBtn').style.display = 'block';
        }

        function scheduleCheckIn() {
            // Calculate 5 business days from now
            const followUpDate = new Date();
            followUpDate.setDate(followUpDate.getDate() + 7);

            // Create a reminder (could integrate with calendar)
            alert(`Reminder set! Follow up with ${currentInterview?.company || 'them'} on ${followUpDate.toLocaleDateString()}`);

            // For now, just show the done button
            document.getElementById('goToCommandCenterBtn').style.display = 'block';
        }

        function updateTrackerStatus(newStatus) {
            try {
                let trackedApps = JSON.parse(localStorage.getItem('trackedApplications') || '[]');
                const appIndex = trackedApps.findIndex(app =>
                    app.company.toLowerCase() === currentInterview.company.toLowerCase() &&
                    app.role.toLowerCase() === currentInterview.role.toLowerCase()
                );
                if (appIndex !== -1) {
                    trackedApps[appIndex].status = newStatus;
                    trackedApps[appIndex].lastUpdated = new Date().toISOString();
                    trackedApps[appIndex].outcome = selectedOutcome;
                    localStorage.setItem('trackedApplications', JSON.stringify(trackedApps));
                }
            } catch (error) {
                console.error('Error updating tracker status:', error);
            }
        }

        function scheduleNextRound() {
            const interviewType = document.getElementById('nextRoundType').value;
            const dateValue = document.getElementById('nextRoundDate').value;
            const interviewerName = document.getElementById('nextRoundInterviewer').value;

            // Create next round interview
            const nextInterview = {
                id: Date.now(),
                company: currentInterview.company,
                role: currentInterview.role,
                type: interviewType,
                date: dateValue ? new Date(dateValue).toISOString() : null,
                interviewerName: interviewerName,
                interviewerTitle: '',
                jobDescription: currentInterview.jobDescription,
                round: (currentInterview.round || 1) + 1
            };

            // Add to upcoming interviews
            let upcomingInterviews = JSON.parse(localStorage.getItem('upcomingInterviews') || '[]');
            upcomingInterviews.push(nextInterview);
            localStorage.setItem('upcomingInterviews', JSON.stringify(upcomingInterviews));

            // Update tracker with next round date
            try {
                let trackedApps = JSON.parse(localStorage.getItem('trackedApplications') || '[]');
                const appIndex = trackedApps.findIndex(app =>
                    app.company.toLowerCase() === currentInterview.company.toLowerCase() &&
                    app.role.toLowerCase() === currentInterview.role.toLowerCase()
                );
                if (appIndex !== -1) {
                    trackedApps[appIndex].interviewDate = nextInterview.date;
                    trackedApps[appIndex].interviewType = interviewType;
                    trackedApps[appIndex].interviewerName = interviewerName;
                    trackedApps[appIndex].interviewRounds = (trackedApps[appIndex].interviewRounds || 1) + 1;
                    trackedApps[appIndex].lastUpdated = new Date().toISOString();
                    trackedApps[appIndex].outcome = 'strong_positive';
                    localStorage.setItem('trackedApplications', JSON.stringify(trackedApps));
                }
            } catch (error) {
                console.error('Error updating tracker:', error);
            }

            // Navigate to prep guide if date is set, otherwise command center
            if (dateValue) {
                window.location.href = `/prep-guide?id=${nextInterview.id}`;
            } else {
                window.location.href = '/tracker';
            }
        }

        function skipNextRound() {
            // Just show the done button without scheduling
            document.getElementById('goToCommandCenterBtn').style.display = 'block';
        }

        // ============================================================================
        // FOLLOW-UP EMAIL GENERATION
        // ============================================================================
        let currentFollowUpType = null;
        let generatedEmail = '';

        async function generateFollowUp(type) {
            currentFollowUpType = type;

            // Show the follow-up output section
            const outputSection = document.getElementById('followUpOutputSection');
            const emailDiv = document.getElementById('followUpEmail');
            outputSection.style.display = 'block';
            emailDiv.innerHTML = '<div class="follow-up-loading"><span class="loading-spinner"></span> Generating email...</div>';

            try {
                // Build context from debrief conversation
                let debriefContext = '';
                if (conversationHistory.length > 0) {
                    const assistantMessages = conversationHistory.filter(m => m.role === 'assistant');
                    if (assistantMessages.length > 0) {
                        debriefContext = assistantMessages.map(m => m.content).join('\n\n').substring(0, 2000);
                    }
                }

                const response = await fetch(`${API_BASE}/api/follow-up-email/generate`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email_type: type,
                        company: currentInterview.company,
                        role: currentInterview.role,
                        interviewer_name: currentInterview.interviewerName || '',
                        interview_date: currentInterview.date,
                        feeling: selectedFeeling,
                        outcome: selectedOutcome,
                        debrief_context: debriefContext,
                        resume_json: resumeData || {}
                    })
                });

                if (!response.ok) {
                    throw new Error('Failed to generate email');
                }

                const data = await response.json();
                generatedEmail = data.email || data.content || '';
                emailDiv.textContent = generatedEmail;
            } catch (error) {
                console.error('Error generating follow-up email:', error);
                // Fallback to local generation
                generatedEmail = generateLocalFollowUp(type);
                emailDiv.textContent = generatedEmail;
            }
        }

        function generateLocalFollowUp(type) {
            const interviewerName = currentInterview.interviewerName || 'Hiring Team';
            const company = currentInterview.company;
            const role = currentInterview.role;
            const firstName = interviewerName.split(' ')[0];

            if (type === 'thank_you') {
                return `Subject: Thank you for our conversation about ${role}

Hi ${firstName},

Thank you for taking the time to speak with me today about the ${role} position at ${company}. I really enjoyed learning more about the team and the exciting challenges ahead.

Our conversation reinforced my enthusiasm for this opportunity. I was particularly energized by [mention specific topic discussed] and I'm confident that my experience in [relevant skill/area] would allow me to contribute meaningfully from day one.

Please don't hesitate to reach out if you need any additional information. I look forward to the possibility of joining the ${company} team.

Best regards,
[Your Name]`;
            } else if (type === 'strategic') {
                // Strategic follow-up for mixed signals - address potential concerns
                return `Subject: A thought after our conversation about ${role}

Hi ${firstName},

Thank you again for our conversation about the ${role} position. I've been reflecting on our discussion and wanted to share one additional thought.

[When we discussed X, I realize I could have been clearer about Y. To add context: brief clarification that addresses potential concern without being defensive.]

I remain excited about the opportunity to contribute to ${company}, particularly around [specific area you discussed]. If there's any additional information that would be helpful as you continue the process, I'm happy to provide it.

Best regards,
[Your Name]`;
            } else {
                // check_in type
                return `Subject: Following up on ${role} interview

Hi ${firstName},

I hope this message finds you well. I wanted to follow up on our conversation about the ${role} position at ${company}.

I remain very enthusiastic about this opportunity and would love to learn about any updates in the hiring process. Please let me know if there's any additional information I can provide.

Thank you again for your consideration.

Best regards,
[Your Name]`;
            }
        }

        async function regenerateFollowUp() {
            if (currentFollowUpType) {
                await generateFollowUp(currentFollowUpType);
            }
        }

        function copyFollowUpEmail() {
            navigator.clipboard.writeText(generatedEmail).then(() => {
                const btnText = document.getElementById('copyBtnText');
                btnText.textContent = 'Copied!';
                setTimeout(() => {
                    btnText.textContent = 'Copy to Clipboard';
                }, 2000);
            }).catch(err => {
                console.error('Failed to copy:', err);
            });
        }

        function loadSavedDebrief() {
            if (!currentInterview) return;

            const savedDebrief = localStorage.getItem(getDebriefStorageKey());
            if (!savedDebrief) return;

            try {
                const debriefData = JSON.parse(savedDebrief);

                // Restore state
                selectedFeeling = debriefData.feeling;
                transcriptText = debriefData.transcript || '';
                conversationHistory = debriefData.conversationHistory || [];

                // If we have conversation history, show the chat section with the messages
                if (conversationHistory.length > 0) {
                    // Hide setup, show chat
                    document.getElementById('setupSection').style.display = 'none';
                    document.getElementById('chatSection').classList.add('active');
                    document.getElementById('chatInputContainer').style.display = 'block';

                    // Restore the feeling button selection
                    if (selectedFeeling) {
                        const feelingBtn = document.querySelector(`.feeling-btn[data-value="${selectedFeeling}"]`);
                        if (feelingBtn) feelingBtn.classList.add('selected');
                    }

                    // Render all messages
                    conversationHistory.forEach(msg => {
                        addMessage(msg.role, msg.content);
                    });

                    // Show the debrief complete button since we have conversation history
                    showDebriefCompleteButton();
                }
            } catch (e) {
                console.error('Error loading saved debrief:', e);
            }
        }

        function markInterviewCompleted() {
            if (!currentInterview) return;

            // Get current lists
            const upcomingInterviews = JSON.parse(localStorage.getItem('upcomingInterviews') || '[]');
            const completedInterviews = JSON.parse(localStorage.getItem('completedInterviews') || '[]');

            // Find and remove from upcoming
            const interviewIndex = upcomingInterviews.findIndex(i => i.id === currentInterview.id);
            if (interviewIndex > -1) {
                const [interview] = upcomingInterviews.splice(interviewIndex, 1);

                // Add debrief info to the interview
                interview.debriefCompleted = true;
                interview.debriefCompletedAt = new Date().toISOString();
                interview.feeling = selectedFeeling;

                // Add to completed (at the beginning)
                completedInterviews.unshift(interview);

                // Save both lists
                localStorage.setItem('upcomingInterviews', JSON.stringify(upcomingInterviews));
                localStorage.setItem('completedInterviews', JSON.stringify(completedInterviews));

                // Sync to Command Center tracker
                syncInterviewToTracker(interview);
            } else {
                // Interview might already be in completedInterviews (past interview)
                // Find and update it there
                const completedIndex = completedInterviews.findIndex(i => i.id === currentInterview.id);
                if (completedIndex > -1) {
                    // Update debrief info on the existing completed interview
                    completedInterviews[completedIndex].debriefCompleted = true;
                    completedInterviews[completedIndex].debriefCompletedAt = new Date().toISOString();
                    completedInterviews[completedIndex].feeling = selectedFeeling;
                    completedInterviews[completedIndex].needsDebrief = false;

                    // Save updated list
                    localStorage.setItem('completedInterviews', JSON.stringify(completedInterviews));

                    // Sync to Command Center tracker
                    syncInterviewToTracker(completedInterviews[completedIndex]);
                }
            }
        }

        function syncInterviewToTracker(interview) {
            try {
                let trackedApps = JSON.parse(localStorage.getItem('trackedApplications') || '[]');

                // Check if this company/role combo already exists
                const existingAppIndex = trackedApps.findIndex(app =>
                    app.company.toLowerCase() === interview.company.toLowerCase() &&
                    app.role.toLowerCase() === interview.role.toLowerCase()
                );

                const interviewDateTime = interview.date ? new Date(interview.date).toISOString() : new Date().toISOString();

                // Build debrief highlights from conversation if available
                let debriefHighlights = null;
                if (conversationHistory.length > 0) {
                    const assistantMessages = conversationHistory.filter(m => m.role === 'assistant');
                    if (assistantMessages.length > 0) {
                        // Get first substantive response as highlights
                        debriefHighlights = assistantMessages[0].content.substring(0, 500);
                        if (assistantMessages[0].content.length > 500) {
                            debriefHighlights += '...';
                        }
                    }
                }

                if (existingAppIndex !== -1) {
                    // Update existing application - determine status based on outcome
                    const outcomeToStatus = {
                        'strong_positive': 'Interviewed',
                        'mixed': 'Interviewed',
                        'likely_no': 'Rejected',
                        'awaiting': 'Interviewed'
                    };
                    const newStatus = interview.outcome ? (outcomeToStatus[interview.outcome] || 'Interviewed') : 'Interviewed';
                    trackedApps[existingAppIndex].status = newStatus;
                    trackedApps[existingAppIndex].lastUpdated = new Date().toISOString();
                    trackedApps[existingAppIndex].interviewDate = interview.date;
                    trackedApps[existingAppIndex].interviewerName = interview.interviewerName;
                    trackedApps[existingAppIndex].interviewerTitle = interview.interviewerTitle;
                    trackedApps[existingAppIndex].outcome = interview.outcome;
                    if (!trackedApps[existingAppIndex].dateInterviewed) {
                        trackedApps[existingAppIndex].dateInterviewed = interviewDateTime;
                    }
                    // Only increment rounds if not already done this session
                    if (!interview.roundIncremented) {
                        trackedApps[existingAppIndex].interviewRounds = (trackedApps[existingAppIndex].interviewRounds || 0) + 1;
                    }

                    // Add debrief info
                    if (interview.debriefCompleted) {
                        trackedApps[existingAppIndex].debriefCompleted = true;
                        trackedApps[existingAppIndex].debriefCompletedAt = interview.debriefCompletedAt;
                        trackedApps[existingAppIndex].interviewFeeling = interview.feeling || selectedFeeling;
                        if (debriefHighlights) {
                            trackedApps[existingAppIndex].debriefHighlights = debriefHighlights;
                        }
                    }
                } else {
                    // Create new tracked application
                    const newApp = {
                        id: Date.now(),
                        company: interview.company,
                        role: interview.role,
                        status: 'Interviewed',
                        fitScore: analysisData?.fit_score || 75,
                        salary: analysisData?.intelligence_layer?.salary_market_context?.typical_range || 'Not specified',
                        dateAdded: new Date().toISOString(),
                        lastUpdated: new Date().toISOString(),
                        dateInterviewed: interviewDateTime,
                        interviewDate: interview.date,
                        interviewerName: interview.interviewerName,
                        interviewerTitle: interview.interviewerTitle,
                        interviewRounds: 1,
                        notes: interview.jobDescription || '',
                        strengths: analysisData?.strengths || [],
                        gaps: analysisData?.gaps || [],
                        debriefCompleted: interview.debriefCompleted || false,
                        debriefCompletedAt: interview.debriefCompletedAt,
                        interviewFeeling: interview.feeling || selectedFeeling,
                        debriefHighlights: debriefHighlights
                    };
                    trackedApps.push(newApp);
                }

                localStorage.setItem('trackedApplications', JSON.stringify(trackedApps));
                console.log('Interview synced to Command Center:', interview.company, interview.role);
            } catch (error) {
                console.error('Error syncing interview to tracker:', error);
            }
        }

        function updateInterviewInfo() {
            document.getElementById('companyName').textContent = currentInterview.company;
            document.getElementById('interviewType').textContent = currentInterview.type;

            const date = new Date(currentInterview.date);
            const dateStr = date.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' });
            const timeStr = date.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });

            let metaText = `${dateStr} at ${timeStr}`;
            if (currentInterview.interviewerName) {
                metaText += ` with ${currentInterview.interviewerName}`;
                if (currentInterview.interviewerTitle) {
                    metaText += ` (${currentInterview.interviewerTitle})`;
                }
            }
            document.getElementById('interviewMeta').textContent = metaText;

            document.title = `Debrief: ${currentInterview.company} - HenryHQ`;
        }

        function setupFeelingButtons() {
            const buttons = document.querySelectorAll('.feeling-btn');
            buttons.forEach(btn => {
                btn.addEventListener('click', () => {
                    buttons.forEach(b => b.classList.remove('selected'));
                    btn.classList.add('selected');
                    selectedFeeling = btn.dataset.value;
                });
            });
        }

        // ============================================================================
        // FILE UPLOAD
        // ============================================================================
        function handleTranscriptUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            transcriptFileData = file;

            const uploadedFileEl = document.getElementById('uploadedFile');
            uploadedFileEl.innerHTML = `
                <span>üìÑ ${file.name}</span>
                <span class="remove-file" onclick="removeTranscriptFile(event)">‚úï</span>
            `;
            uploadedFileEl.style.display = 'flex';
            document.getElementById('uploadZone').style.display = 'none';
        }

        function removeTranscriptFile(event) {
            event.stopPropagation();
            transcriptFileData = null;
            document.getElementById('transcriptFile').value = '';
            document.getElementById('uploadedFile').style.display = 'none';
            document.getElementById('uploadZone').style.display = 'flex';
        }

        // ============================================================================
        // RECORDING UPLOAD & TRANSCRIPTION
        // ============================================================================
        let recordingFileData = null;

        async function handleRecordingUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            recordingFileData = file;

            // Show uploaded file indicator
            const uploadedEl = document.getElementById('uploadedRecording');
            const icon = file.type.startsWith('video/') ? 'üé¨' : 'üéôÔ∏è';
            const sizeMB = (file.size / (1024 * 1024)).toFixed(1);
            uploadedEl.innerHTML = `
                <span>${icon} ${file.name} (${sizeMB} MB)</span>
                <span class="remove-file" onclick="removeRecordingFile(event)">‚úï</span>
            `;
            uploadedEl.style.display = 'flex';
            document.getElementById('recordingUploadZone').style.display = 'none';

            // Check file size (Whisper has a 25MB limit)
            if (file.size > 25 * 1024 * 1024) {
                alert('File is too large. Maximum size is 25MB. Please use a shorter clip or compress the file.');
                removeRecordingFile(event);
                return;
            }

            // Start transcription
            await transcribeRecording(file);
        }

        async function transcribeRecording(file) {
            const progressEl = document.getElementById('transcriptionProgress');
            const statusEl = document.getElementById('transcriptionStatus');

            progressEl.style.display = 'block';
            statusEl.textContent = 'Transcribing recording... This may take a minute.';

            try {
                const formData = new FormData();
                formData.append('audio', file);

                const response = await fetch(`${API_BASE}/api/transcribe`, {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    const error = await response.json().catch(() => ({}));
                    throw new Error(error.detail || 'Transcription failed');
                }

                const data = await response.json();
                transcriptText = data.text;

                // Show success and preview
                statusEl.textContent = '‚úÖ Transcription complete!';
                progressEl.style.background = 'rgba(16, 185, 129, 0.1)';
                progressEl.querySelector('div').style.color = '#10b981';

                // Show transcript preview
                setTimeout(() => {
                    progressEl.innerHTML = `
                        <div style="text-align: left;">
                            <div style="color: #10b981; margin-bottom: 8px; font-weight: 500;">‚úÖ Transcript ready</div>
                            <div style="color: #9ca3af; font-size: 0.85rem; max-height: 100px; overflow-y: auto; line-height: 1.5;">
                                ${transcriptText.substring(0, 500)}${transcriptText.length > 500 ? '...' : ''}
                            </div>
                        </div>
                    `;
                }, 1000);

                console.log('Transcription complete:', transcriptText.substring(0, 200) + '...');

            } catch (error) {
                console.error('Transcription error:', error);
                statusEl.textContent = `‚ùå ${error.message}`;
                progressEl.style.background = 'rgba(239, 68, 68, 0.1)';
                progressEl.querySelector('div').style.color = '#ef4444';
            }
        }

        function removeRecordingFile(event) {
            event.stopPropagation();
            recordingFileData = null;
            transcriptText = '';
            document.getElementById('recordingFile').value = '';
            document.getElementById('uploadedRecording').style.display = 'none';
            document.getElementById('transcriptionProgress').style.display = 'none';
            document.getElementById('recordingUploadZone').style.display = 'flex';
        }

        function togglePasteSection() {
            const section = document.getElementById('pasteSection');
            const toggle = document.querySelector('.paste-toggle');
            if (section.style.display === 'none') {
                section.style.display = 'block';
                toggle.textContent = 'Hide paste option ‚ñ≤';
            } else {
                section.style.display = 'none';
                toggle.textContent = 'Paste notes or transcript manually ‚ñº';
            }
        }

        function setupDragAndDrop() {
            // Document/text upload zone
            const uploadZone = document.getElementById('uploadZone');

            uploadZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadZone.style.borderColor = '#f59e0b';
                uploadZone.style.background = 'rgba(245, 158, 11, 0.1)';
            });

            uploadZone.addEventListener('dragleave', () => {
                uploadZone.style.borderColor = '#374151';
                uploadZone.style.background = 'rgba(255, 255, 255, 0.03)';
            });

            uploadZone.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadZone.style.borderColor = '#374151';
                uploadZone.style.background = 'rgba(255, 255, 255, 0.03)';

                const file = e.dataTransfer.files[0];
                if (file) {
                    document.getElementById('transcriptFile').files = e.dataTransfer.files;
                    handleTranscriptUpload({ target: { files: [file] } });
                }
            });

            // Recording upload zone
            const recordingZone = document.getElementById('recordingUploadZone');

            recordingZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                recordingZone.style.borderColor = '#f59e0b';
                recordingZone.style.background = 'rgba(245, 158, 11, 0.1)';
            });

            recordingZone.addEventListener('dragleave', () => {
                recordingZone.style.borderColor = '#374151';
                recordingZone.style.background = 'rgba(255, 255, 255, 0.03)';
            });

            recordingZone.addEventListener('drop', (e) => {
                e.preventDefault();
                recordingZone.style.borderColor = '#374151';
                recordingZone.style.background = 'rgba(255, 255, 255, 0.03)';

                const file = e.dataTransfer.files[0];
                if (file && (file.type.startsWith('audio/') || file.type.startsWith('video/'))) {
                    handleRecordingUpload({ target: { files: [file] } });
                }
            });
        }

        // ============================================================================
        // DEBRIEF FLOW
        // ============================================================================
        async function startDebrief() {
            const btn = document.getElementById('startDebriefBtn');
            btn.disabled = true;
            btn.textContent = 'Starting debrief...';

            // Get transcript from recording (already transcribed), file upload, or text
            // Priority: recording transcription > uploaded file > pasted text
            if (recordingFileData && transcriptText) {
                // Recording was transcribed - transcriptText already populated
                console.log('Using transcribed recording');
            } else if (transcriptFileData) {
                try {
                    transcriptText = await readFileAsText(transcriptFileData);
                } catch (e) {
                    console.error('Error reading file:', e);
                }
            } else if (!transcriptText) {
                transcriptText = document.getElementById('transcriptText').value.trim();
            }

            // Hide setup, show chat
            document.getElementById('setupSection').style.display = 'none';
            document.getElementById('chatSection').classList.add('active');
            document.getElementById('chatInputContainer').style.display = 'block';

            // Start the conversation
            await sendInitialMessage();
        }

        function readFileAsText(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => resolve(e.target.result);
                reader.onerror = (e) => reject(e);

                if (file.type === 'application/pdf') {
                    // For PDF, we'd need to extract text - for now just read as text
                    reader.readAsText(file);
                } else {
                    reader.readAsText(file);
                }
            });
        }

        async function sendInitialMessage() {
            setLoading(true);
            addTypingIndicator();

            try {
                const response = await fetch(`${API_BASE}/api/debrief/chat`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        resume_json: resumeData || {},
                        job_description: currentInterview.jobDescription || analysisData?._jd_text || '',
                        context: {
                            interviewerName: currentInterview.interviewerName || 'the interviewer',
                            interviewerTitle: currentInterview.interviewerTitle || null,
                            interviewDate: currentInterview.date,
                            interviewStage: currentInterview.type,
                            feeling: selectedFeeling,
                            company: currentInterview.company,
                            roleTitle: currentInterview.role,
                            candidateName: resumeData?.name || 'there'
                        },
                        transcript: transcriptText || null,
                        conversation_history: [],
                        user_message: null  // null triggers initial analysis
                    })
                });

                removeTypingIndicator();

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    console.error('Debrief API error:', response.status, errorData);
                    throw new Error(errorData.detail || 'Failed to start debrief');
                }

                const data = await response.json();

                // Add assistant response to chat
                addMessage('assistant', data.response);
                conversationHistory.push({ role: 'assistant', content: data.response });

                // Mark interview as completed and save debrief
                markInterviewCompleted();
                saveDebrief();

                // Show the "Debrief Completed" button
                showDebriefCompleteButton();

            } catch (error) {
                console.error('Debrief error:', error);
                removeTypingIndicator();

                // Clear transcript and offer to continue without it
                if (transcriptText) {
                    transcriptText = null;
                    addMessage('assistant', "I had trouble processing that transcript - it may be too long or in an unsupported format. No worries though! Tell me about how the interview went, and I'll help you debrief just the same.");
                } else {
                    addMessage('assistant', "I'm having trouble connecting right now. Let's try again - tell me about how the interview went.");
                }
            }

            setLoading(false);
        }

        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            if (!message || isLoading) return;

            // Add user message
            addMessage('user', message);
            conversationHistory.push({ role: 'user', content: message });
            input.value = '';

            // Send to API
            await sendToAPI(message);
        }

        async function sendQuickAction(message) {
            if (isLoading) return;

            addMessage('user', message);
            conversationHistory.push({ role: 'user', content: message });

            await sendToAPI(message);
        }

        async function sendToAPI(userMessage) {
            setLoading(true);
            addTypingIndicator();

            try {
                const response = await fetch(`${API_BASE}/api/debrief/chat`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        resume_json: resumeData || {},
                        job_description: currentInterview.jobDescription || analysisData?._jd_text || '',
                        context: {
                            interviewerName: currentInterview.interviewerName || 'the interviewer',
                            interviewerTitle: currentInterview.interviewerTitle || null,
                            interviewDate: currentInterview.date,
                            interviewStage: currentInterview.type,
                            feeling: selectedFeeling,
                            company: currentInterview.company,
                            roleTitle: currentInterview.role,
                            candidateName: resumeData?.name || 'there'
                        },
                        transcript: transcriptText || null,
                        conversation_history: conversationHistory.slice(0, -1), // Exclude the message we just added
                        user_message: userMessage
                    })
                });

                removeTypingIndicator();

                if (!response.ok) {
                    throw new Error('Failed to get response');
                }

                const data = await response.json();

                addMessage('assistant', data.response);
                conversationHistory.push({ role: 'assistant', content: data.response });

                // Save conversation after each exchange
                saveDebrief();

            } catch (error) {
                console.error('Chat error:', error);
                removeTypingIndicator();
                addMessage('assistant', "I'm sorry, I had trouble processing that. Could you try rephrasing your question?");
            }

            setLoading(false);
        }

        // ============================================================================
        // UI HELPERS
        // ============================================================================
        function addMessage(role, content) {
            const messagesContainer = document.getElementById('chatMessages');
            const avatar = role === 'assistant' ? 'üéØ' : 'üë§';

            // Convert markdown-like formatting to HTML
            const formattedContent = formatMessageContent(content);

            const messageEl = document.createElement('div');
            messageEl.className = `message ${role}`;
            messageEl.innerHTML = `
                <div class="message-avatar">${avatar}</div>
                <div class="message-content">${formattedContent}</div>
            `;

            messagesContainer.appendChild(messageEl);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function formatMessageContent(content) {
            // Basic markdown conversion
            return content
                .split('\n\n').map(para => {
                    // Handle headers
                    if (para.startsWith('### ')) {
                        return `<h4>${para.slice(4)}</h4>`;
                    }
                    if (para.startsWith('## ')) {
                        return `<h3>${para.slice(3)}</h3>`;
                    }

                    // Handle lists
                    if (para.match(/^[-‚Ä¢]\s/m)) {
                        const items = para.split('\n')
                            .filter(line => line.trim())
                            .map(line => `<li>${line.replace(/^[-‚Ä¢]\s*/, '')}</li>`)
                            .join('');
                        return `<ul>${items}</ul>`;
                    }

                    // Handle numbered lists
                    if (para.match(/^\d+\.\s/m)) {
                        const items = para.split('\n')
                            .filter(line => line.trim())
                            .map(line => `<li>${line.replace(/^\d+\.\s*/, '')}</li>`)
                            .join('');
                        return `<ol>${items}</ol>`;
                    }

                    // Regular paragraph with bold/italic
                    return `<p>${para
                        .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
                        .replace(/\*(.+?)\*/g, '<em>$1</em>')
                    }</p>`;
                })
                .join('');
        }

        function addTypingIndicator() {
            const messagesContainer = document.getElementById('chatMessages');
            const indicator = document.createElement('div');
            indicator.className = 'message assistant';
            indicator.id = 'typingIndicator';
            indicator.innerHTML = `
                <div class="message-avatar">üéØ</div>
                <div class="typing-indicator">
                    <div class="dot"></div>
                    <div class="dot"></div>
                    <div class="dot"></div>
                </div>
            `;
            messagesContainer.appendChild(indicator);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function removeTypingIndicator() {
            const indicator = document.getElementById('typingIndicator');
            if (indicator) {
                indicator.remove();
            }
        }

        function setLoading(loading) {
            isLoading = loading;
            document.getElementById('sendBtn').disabled = loading;
            document.getElementById('chatInput').disabled = loading;
        }

        function handleKeyDown(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        // Auto-resize textarea
        document.getElementById('chatInput')?.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 150) + 'px';
        });

        // ============================================================================
        // VOICE INPUT (Web Speech API)
        // ============================================================================
        let recognition = null;
        let isRecording = false;

        // Initialize speech recognition
        function initVoiceInput() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

            if (!SpeechRecognition) {
                // Voice not supported - hide the button, show message
                const voiceBtn = document.getElementById('voiceBtn');
                if (voiceBtn) voiceBtn.style.display = 'none';
                return;
            }

            recognition = new SpeechRecognition();
            recognition.continuous = true;
            recognition.interimResults = true;
            recognition.lang = 'en-US';

            recognition.onstart = () => {
                isRecording = true;
                // Reset transcript accumulator when starting new recording
                window.voiceFinalTranscript = '';
                const voiceBtn = document.getElementById('voiceBtn');
                const voiceStatus = document.getElementById('voiceStatus');
                voiceBtn.classList.add('recording');
                voiceStatus.textContent = 'Listening...';
                voiceStatus.classList.add('show', 'recording');
            };

            recognition.onresult = (event) => {
                let interimTranscript = '';

                for (let i = event.resultIndex; i < event.results.length; i++) {
                    const transcript = event.results[i][0].transcript;
                    if (event.results[i].isFinal) {
                        window.voiceFinalTranscript += transcript + ' ';
                    } else {
                        interimTranscript += transcript;
                    }
                }

                // Update the input field with what we're hearing
                const chatInput = document.getElementById('chatInput');
                chatInput.value = window.voiceFinalTranscript + interimTranscript;

                // Auto-resize textarea
                chatInput.style.height = 'auto';
                chatInput.style.height = Math.min(chatInput.scrollHeight, 150) + 'px';

                // Update status to show we're picking up audio
                const voiceStatus = document.getElementById('voiceStatus');
                if (interimTranscript) {
                    voiceStatus.textContent = 'Hearing you...';
                }
            };

            recognition.onerror = (event) => {
                console.error('Speech recognition error:', event.error);
                stopRecording();

                const voiceStatus = document.getElementById('voiceStatus');
                if (event.error === 'no-speech') {
                    voiceStatus.textContent = 'No speech detected';
                    voiceStatus.classList.add('show');
                    setTimeout(() => voiceStatus.classList.remove('show'), 2000);
                } else if (event.error === 'not-allowed') {
                    voiceStatus.textContent = 'Microphone access denied';
                    voiceStatus.classList.add('show');
                    setTimeout(() => voiceStatus.classList.remove('show'), 3000);
                }
            };

            recognition.onend = () => {
                // If we were recording and have content, the user probably stopped intentionally
                if (isRecording && window.voiceFinalTranscript && window.voiceFinalTranscript.trim()) {
                    // User can click send to submit
                }
                stopRecording();
            };
        }

        function toggleVoiceInput() {
            if (!recognition) {
                document.getElementById('voiceNotSupported').classList.add('show');
                return;
            }

            if (isRecording) {
                stopRecording();
            } else {
                startRecording();
            }
        }

        function startRecording() {
            if (!recognition) return;

            try {
                // Reset transcript for new recording session
                recognition.start();
            } catch (e) {
                console.error('Error starting recognition:', e);
            }
        }

        function stopRecording() {
            isRecording = false;

            const voiceBtn = document.getElementById('voiceBtn');
            const voiceStatus = document.getElementById('voiceStatus');

            voiceBtn?.classList.remove('recording');
            voiceStatus?.classList.remove('show', 'recording');

            if (recognition) {
                try {
                    recognition.stop();
                } catch (e) {
                    // Ignore - might already be stopped
                }
            }
        }

        // Initialize voice input on page load
        document.addEventListener('DOMContentLoaded', initVoiceInput);
    </script>
<script src="components/strategy-nav.js"></script>
    <script src="components/status-banner.js"></script>
<script src="components/analytics.js"></script>
<script src="components/hey-henry.js"></script>
<script src="components/admin-alerts.js"></script>
<script src="components/top-nav.js"></script>
</body>
</html>

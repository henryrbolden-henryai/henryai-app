<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interview Prep Guide - HenryHQ</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Instrument+Serif:ital@0;1&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 100%);
            color: #e0e0e0;
            min-height: 100vh;
            line-height: 1.6;
        }

        header {
            background: rgba(15, 15, 15, 0.95);
            border-bottom: 1px solid #374151;
            padding: 16px 20px;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        header .header-container {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .logo {
            font-family: 'Instrument Serif', Georgia, serif;
            font-size: 1.8rem;
            color: #ffffff;
            text-decoration: none;
            position: fixed;
            left: 90px;
            top: 24px;
            z-index: 100;
        }

        .logo em {
            font-style: italic;
            color: #22d3ee;
        }

        .header-nav {
            display: flex;
            gap: 24px;
            align-items: center;
        }

        .nav-link {
            color: #9ca3af;
            text-decoration: none;
            font-size: 0.9rem;
            transition: color 0.2s ease;
        }

        .nav-link:hover {
            color: #22d3ee;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 40px 20px 80px;
        }

        .back-link {
            display: inline-flex;
            align-items: center;
            color: #60a5fa;
            text-decoration: none;
            margin-bottom: 24px;
            font-size: 14px;
            transition: color 0.2s;
        }

        .back-link:hover {
            color: #93c5fd;
        }

        /* Page Header */
        .page-header {
            margin-bottom: 40px;
        }

        .breadcrumb {
            color: #9ca3af;
            font-size: 0.9rem;
            margin-bottom: 8px;
        }

        .breadcrumb .company {
            color: #22d3ee;
        }

        .page-header h1 {
            font-size: 2rem;
            color: #ffffff;
            margin-bottom: 8px;
        }

        .interview-meta {
            color: #9ca3af;
            font-size: 0.95rem;
        }

        /* Sections */
        .section {
            background: #1f2937;
            border: 1px solid #374151;
            border-radius: 12px;
            margin-bottom: 20px;
            overflow: hidden;
        }

        .section-header {
            padding: 20px 24px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background 0.2s;
        }

        .section-header:hover {
            background: rgba(255, 255, 255, 0.02);
        }

        .section-title {
            font-size: 1.1rem;
            color: #ffffff;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section-toggle {
            color: #6b7280;
            transition: transform 0.2s;
        }

        .section.collapsed .section-toggle {
            transform: rotate(-90deg);
        }

        .section.collapsed .section-body {
            display: none;
        }

        .section-body {
            padding: 0 24px 24px;
        }

        /* Content List */
        .content-list {
            list-style: none;
        }

        .content-list li {
            padding: 10px 0;
            border-bottom: 1px solid #374151;
            color: #d1d5db;
        }

        .content-list li:last-child {
            border-bottom: none;
        }

        /* Intro Card */
        .intro-card {
            background: #111827;
            border: 1px solid #374151;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 16px;
        }

        .intro-card p {
            color: #d1d5db;
            line-height: 1.8;
            white-space: pre-wrap;
        }

        .intro-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid #374151;
        }

        .word-count {
            color: #6b7280;
            font-size: 0.85rem;
        }

        .btn-regenerate {
            background: transparent;
            border: 1px solid #374151;
            color: #9ca3af;
            padding: 8px 16px;
            font-size: 0.85rem;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-regenerate:hover {
            border-color: #22d3ee;
            color: #22d3ee;
        }

        /* Expandable Questions */
        .question-item {
            border-bottom: 1px solid #374151;
        }

        .question-item:last-child {
            border-bottom: none;
        }

        .question-header {
            padding: 16px 0;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .question-header:hover .question-text {
            color: #22d3ee;
        }

        .question-text {
            color: #d1d5db;
            transition: color 0.2s;
        }

        .question-toggle {
            color: #6b7280;
            font-size: 0.8rem;
            transition: transform 0.2s;
        }

        .question-item.collapsed .question-toggle {
            transform: rotate(-90deg);
        }

        .question-item.collapsed .question-answer {
            display: none;
        }

        .question-answer {
            padding: 0 0 16px 16px;
            color: #9ca3af;
            font-size: 0.9rem;
            border-left: 2px solid #374151;
            margin-left: 8px;
        }

        /* Story Cards */
        .story-card {
            background: #111827;
            border: 1px solid #374151;
            border-radius: 8px;
            margin-bottom: 12px;
            overflow: hidden;
        }

        .story-header {
            padding: 16px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .story-header:hover {
            background: rgba(255, 255, 255, 0.02);
        }

        .story-title {
            color: #ffffff;
            font-weight: 500;
        }

        .story-tag {
            background: #374151;
            color: #9ca3af;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.75rem;
        }

        .story-card.collapsed .story-body {
            display: none;
        }

        .story-body {
            padding: 0 16px 16px;
        }

        .story-section {
            margin-bottom: 12px;
        }

        .story-section-label {
            color: #22d3ee;
            font-size: 0.8rem;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .story-section p {
            color: #d1d5db;
            font-size: 0.9rem;
        }

        /* Red Flags */
        .red-flag-item {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            padding: 12px 0;
            border-bottom: 1px solid #374151;
        }

        .red-flag-item:last-child {
            border-bottom: none;
        }

        .red-flag-icon {
            color: #f59e0b;
        }

        .red-flag-text {
            color: #d1d5db;
        }

        /* Questions to Ask */
        .question-to-ask-item {
            padding: 12px 0;
            border-bottom: 1px solid #374151;
        }

        .question-to-ask-item:last-child {
            border-bottom: none;
        }

        .question-to-ask-text {
            color: #e5e7eb;
            font-size: 0.95rem;
            font-style: italic;
            margin-bottom: 6px;
        }

        .question-to-ask-rationale {
            color: #9ca3af;
            font-size: 0.85rem;
            padding-left: 12px;
            border-left: 2px solid #374151;
        }

        /* Intel badges and sourced items */
        .intel-badge {
            display: inline-block;
            background: linear-gradient(135deg, #0ea5e9, #22d3ee);
            color: #0f172a;
            font-size: 0.65rem;
            font-weight: 600;
            padding: 2px 6px;
            border-radius: 4px;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            margin-left: 6px;
            vertical-align: middle;
        }

        .intel-sourced {
            border-left: 3px solid #22d3ee;
            padding-left: 12px;
            margin-left: -12px;
        }

        li.intel-sourced {
            list-style-position: inside;
            padding-left: 15px;
            margin-left: 0;
        }

        .red-flag-content {
            flex: 1;
        }

        .red-flag-defense {
            color: #10b981;
            font-size: 0.85rem;
            margin-top: 6px;
            padding-left: 8px;
        }

        #introFramingNote {
            display: none;
            color: #22d3ee;
            font-size: 0.85rem;
            margin-bottom: 12px;
            padding: 8px 12px;
            background: rgba(34, 211, 238, 0.1);
            border-radius: 6px;
            border-left: 3px solid #22d3ee;
        }

        /* Drill Cards */
        .drill-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 12px;
        }

        .drill-card {
            background: #111827;
            border: 1px solid #374151;
            border-radius: 8px;
            padding: 16px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .drill-card:hover {
            border-color: #22d3ee;
            transform: translateY(-2px);
        }

        .drill-card .drill-icon {
            font-size: 1.5rem;
            margin-bottom: 8px;
        }

        .drill-card .drill-name {
            color: #d1d5db;
            font-size: 0.85rem;
        }

        /* CTA Button */
        .cta-section {
            text-align: center;
            padding: 40px 0;
        }

        .cta-btn {
            background: #22d3ee;
            color: #000000;
            border: none;
            padding: 16px 40px;
            font-size: 1.1rem;
            font-weight: 600;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .cta-btn:hover {
            background: #06b6d4;
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(34, 211, 238, 0.4);
        }

        /* Loading / Generating State */
        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 60px 20px;
            color: #9ca3af;
            min-height: 60vh;
        }

        .generating-icon {
            font-size: 4rem;
            margin-bottom: 24px;
            animation: pulse-glow 2s ease-in-out infinite;
        }

        @keyframes pulse-glow {
            0%, 100% {
                opacity: 1;
                transform: scale(1);
                filter: drop-shadow(0 0 10px rgba(34, 211, 238, 0.3));
            }
            50% {
                opacity: 0.8;
                transform: scale(1.05);
                filter: drop-shadow(0 0 20px rgba(34, 211, 238, 0.6));
            }
        }

        .generating-title {
            font-size: 1.5rem;
            color: #ffffff;
            margin-bottom: 8px;
            text-align: center;
        }

        .generating-subtitle {
            color: #9ca3af;
            font-size: 1rem;
            margin-bottom: 32px;
            text-align: center;
        }

        .generating-progress {
            width: 100%;
            max-width: 400px;
            margin-bottom: 32px;
        }

        .progress-bar-container {
            height: 4px;
            background: #374151;
            border-radius: 2px;
            overflow: hidden;
            margin-bottom: 16px;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #22d3ee, #06b6d4, #22d3ee);
            background-size: 200% 100%;
            border-radius: 2px;
            animation: progress-shimmer 2s ease-in-out infinite, progress-grow 12s ease-out forwards;
        }

        @keyframes progress-shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        @keyframes progress-grow {
            0% { width: 5%; }
            20% { width: 25%; }
            40% { width: 45%; }
            60% { width: 65%; }
            80% { width: 80%; }
            100% { width: 92%; }
        }

        .generating-steps {
            text-align: left;
            width: 100%;
            max-width: 320px;
        }

        .gen-step {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 0;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .gen-step.pending {
            color: #4b5563;
        }

        .gen-step.active {
            color: #22d3ee;
        }

        .gen-step.done {
            color: #10b981;
        }

        .gen-step-icon {
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
        }

        .gen-step.active .gen-step-icon {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .generating-tip {
            margin-top: 32px;
            padding: 16px 24px;
            background: rgba(34, 211, 238, 0.1);
            border: 1px solid rgba(34, 211, 238, 0.2);
            border-radius: 12px;
            max-width: 400px;
            text-align: center;
        }

        .generating-tip .tip-label {
            color: #22d3ee;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .generating-tip .tip-text {
            color: #d1d5db;
            font-size: 0.9rem;
            line-height: 1.5;
            transition: opacity 0.3s ease;
        }

        /* Error State */
        .error-state {
            text-align: center;
            padding: 60px 20px;
        }

        .error-state .icon {
            font-size: 3rem;
            margin-bottom: 16px;
        }

        .error-state h3 {
            color: #ffffff;
            margin-bottom: 12px;
        }

        .error-state p {
            color: #9ca3af;
            margin-bottom: 24px;
        }

        .error-state a {
            color: #22d3ee;
        }

        /* Interviewer Intelligence Upload */
        .intel-prompt {
            background: linear-gradient(135deg, #1e3a5f 0%, #1a2e44 100%);
            border: 1px solid #22d3ee;
            border-radius: 16px;
            padding: 32px;
            margin-bottom: 32px;
            text-align: center;
        }

        .intel-prompt .greeting {
            font-size: 1.3rem;
            color: #ffffff;
            margin-bottom: 16px;
        }

        .intel-prompt .message {
            color: #9ca3af;
            font-size: 1rem;
            line-height: 1.7;
            max-width: 600px;
            margin: 0 auto 24px;
        }

        .intel-prompt .highlight {
            color: #22d3ee;
            font-weight: 500;
        }

        .upload-zone {
            background: rgba(255, 255, 255, 0.03);
            border: 2px dashed #374151;
            border-radius: 12px;
            padding: 40px 24px;
            margin: 24px 0;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .upload-zone:hover {
            border-color: #22d3ee;
            background: rgba(34, 211, 238, 0.05);
        }

        .upload-zone.dragover {
            border-color: #22d3ee;
            background: rgba(34, 211, 238, 0.1);
        }

        .upload-zone .upload-icon {
            font-size: 3rem;
            margin-bottom: 16px;
        }

        .upload-zone h4 {
            color: #ffffff;
            font-size: 1.1rem;
            margin-bottom: 8px;
        }

        .upload-zone p {
            color: #9ca3af;
            font-size: 0.9rem;
        }

        .upload-zone input[type="file"] {
            display: none;
        }

        .reassurance {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            color: #6b7280;
            font-size: 0.85rem;
            margin-top: 16px;
        }

        .reassurance .lock-icon {
            color: #10b981;
        }

        .skip-link {
            color: #6b7280;
            font-size: 0.85rem;
            margin-top: 20px;
            display: inline-block;
            cursor: pointer;
            transition: color 0.2s;
        }

        .skip-link:hover {
            color: #9ca3af;
        }

        /* Text Paste Option */
        .paste-option {
            margin-top: 24px;
            padding-top: 24px;
            border-top: 1px solid #374151;
        }

        .paste-option h5 {
            color: #9ca3af;
            font-size: 0.85rem;
            margin-bottom: 12px;
        }

        .paste-textarea {
            width: 100%;
            min-height: 150px;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid #374151;
            border-radius: 8px;
            padding: 16px;
            color: #ffffff;
            font-family: inherit;
            font-size: 0.9rem;
            resize: vertical;
        }

        .paste-textarea:focus {
            outline: none;
            border-color: #22d3ee;
        }

        .paste-textarea::placeholder {
            color: #6b7280;
        }

        .submit-paste-btn {
            margin-top: 12px;
            background: #22d3ee;
            color: #000;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .submit-paste-btn:hover {
            background: #06b6d4;
        }

        .submit-paste-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Interviewer Intelligence Report Section */
        .intel-section {
            background: linear-gradient(135deg, #1a2e44 0%, #1f2937 100%);
            border: 1px solid #22d3ee;
            border-radius: 12px;
            margin-bottom: 20px;
            overflow: hidden;
        }

        .intel-section .section-header {
            background: rgba(34, 211, 238, 0.1);
        }

        .intel-section .section-title {
            color: #22d3ee;
        }

        .interviewer-summary {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 16px;
        }

        .interviewer-header {
            display: flex;
            gap: 16px;
            margin-bottom: 16px;
        }

        .interviewer-avatar {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #3b82f6, #8b5cf6);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            font-weight: bold;
            color: #ffffff;
            flex-shrink: 0;
        }

        .interviewer-info h4 {
            color: #ffffff;
            font-size: 1.1rem;
            margin-bottom: 4px;
        }

        .interviewer-info .title {
            color: #22d3ee;
            font-size: 0.9rem;
            margin-bottom: 4px;
        }

        .interviewer-info .tenure {
            color: #9ca3af;
            font-size: 0.85rem;
        }

        .interviewer-bio {
            color: #d1d5db;
            font-size: 0.95rem;
            line-height: 1.7;
        }

        .intel-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 16px;
        }

        .intel-card {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            padding: 16px;
        }

        .intel-card h5 {
            color: #22d3ee;
            font-size: 0.85rem;
            font-weight: 600;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .intel-card ul {
            list-style: none;
        }

        .intel-card li {
            color: #d1d5db;
            font-size: 0.9rem;
            padding: 6px 0;
            padding-left: 16px;
            position: relative;
        }

        .intel-card li::before {
            content: '‚Üí';
            position: absolute;
            left: 0;
            color: #6b7280;
        }

        .intel-card p {
            color: #d1d5db;
            font-size: 0.9rem;
            line-height: 1.6;
        }

        .risk-item {
            background: rgba(239, 68, 68, 0.1);
            border-left: 3px solid #ef4444;
            padding: 12px;
            margin-bottom: 8px;
            border-radius: 0 8px 8px 0;
        }

        .risk-item:last-child {
            margin-bottom: 0;
        }

        .risk-item .risk-title {
            color: #f87171;
            font-weight: 600;
            font-size: 0.85rem;
            margin-bottom: 4px;
        }

        .risk-item .risk-defense {
            color: #d1d5db;
            font-size: 0.85rem;
        }

        .strength-item {
            background: rgba(34, 197, 94, 0.1);
            border-left: 3px solid #22c55e;
            padding: 12px;
            margin-bottom: 8px;
            border-radius: 0 8px 8px 0;
        }

        .strength-item:last-child {
            margin-bottom: 0;
        }

        .strength-item p {
            color: #d1d5db;
            font-size: 0.9rem;
        }

        .question-to-ask {
            background: rgba(99, 102, 241, 0.1);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 8px;
        }

        .question-to-ask:last-child {
            margin-bottom: 0;
        }

        .question-to-ask .question {
            color: #a5b4fc;
            font-weight: 500;
            margin-bottom: 4px;
        }

        .question-to-ask .rationale {
            color: #9ca3af;
            font-size: 0.85rem;
        }

        /* Processing State */
        .processing-intel {
            text-align: center;
            padding: 60px 20px;
        }

        .processing-intel .processing-icon {
            font-size: 4rem;
            margin-bottom: 20px;
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.7; transform: scale(1.05); }
        }

        .processing-intel h3 {
            color: #ffffff;
            margin-bottom: 12px;
        }

        .processing-intel p {
            color: #9ca3af;
            max-width: 400px;
            margin: 0 auto;
        }

        .processing-steps {
            margin-top: 24px;
            text-align: left;
            max-width: 300px;
            margin-left: auto;
            margin-right: auto;
        }

        .processing-step {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px 0;
            color: #6b7280;
            font-size: 0.9rem;
        }

        .processing-step.active {
            color: #22d3ee;
        }

        .processing-step.done {
            color: #10b981;
        }

        .step-icon {
            width: 20px;
            text-align: center;
        }
    </style>
    <link rel="stylesheet" href="css/mobile.css">
    <!-- Supabase Auth -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/supabase-client.js"></script>
</head>
<body>
    <!-- HEADER -->
    <header>
        <div class="header-container">
            <a href="/index" class="logo"><em>Henry</em>HQ</a>
        </div>
    </header>

    <div class="container">
        <!-- Loading / Generating State -->
        <div id="loadingState" class="loading">
            <div class="generating-icon">‚ú®</div>
            <h2 class="generating-title">Generating Your Prep Guide</h2>
            <p class="generating-subtitle">Tailoring insights for your interview</p>

            <div class="generating-progress">
                <div class="progress-bar-container">
                    <div class="progress-bar"></div>
                </div>
            </div>

            <div class="generating-steps">
                <div class="gen-step active" id="step-analyze">
                    <span class="gen-step-icon">‚óê</span>
                    <span>Analyzing interview context...</span>
                </div>
                <div class="gen-step pending" id="step-questions">
                    <span class="gen-step-icon">‚óã</span>
                    <span>Crafting likely questions...</span>
                </div>
                <div class="gen-step pending" id="step-stories">
                    <span class="gen-step-icon">‚óã</span>
                    <span>Preparing your stories...</span>
                </div>
                <div class="gen-step pending" id="step-intro">
                    <span class="gen-step-icon">‚óã</span>
                    <span>Writing your intro pitch...</span>
                </div>
            </div>

            <div class="generating-tip">
                <div class="tip-label">üí° Did you know?</div>
                <div class="tip-text" id="generatingTip">Candidates who practice their intro 3+ times are 40% more likely to feel confident.</div>
            </div>
        </div>

        <!-- Error State -->
        <div id="errorState" class="error-state" style="display: none;">
            <div class="icon">‚ö†Ô∏è</div>
            <h3>Interview not found</h3>
            <p>Please <a href="/interview-intelligence">go back</a> and select an interview.</p>
        </div>

        <!-- Prep Guide Content -->
        <div id="prepContent" style="display: none;">
            <!-- Page Header -->
            <div class="page-header">
                <div class="breadcrumb">
                    <span class="company" id="companyName">Company</span> ‚Üí <span id="interviewTypeBreadcrumb">Interview Type</span> Prep
                </div>
                <h1 id="pageTitle">Interview Prep Guide</h1>
                <div class="interview-meta" id="interviewMeta"></div>
            </div>

            <!-- Interviewer Intelligence Section (shown when profile provided) -->
            <div class="intel-section" id="interviewerIntelSection" style="display: none;">
                <div class="section-header" onclick="toggleSection(this)">
                    <h3 class="section-title"><span>üéØ</span> Interviewer Intelligence</h3>
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <span id="intelCacheStatus" style="font-size: 0.75rem; color: #9ca3af;"></span>
                        <button onclick="event.stopPropagation(); reanalyzeLinkedIn();" style="background: transparent; border: 1px solid #374151; color: #9ca3af; padding: 4px 10px; font-size: 0.75rem; border-radius: 4px; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.borderColor='#22d3ee'; this.style.color='#22d3ee';" onmouseout="this.style.borderColor='#374151'; this.style.color='#9ca3af';">Re-analyze</button>
                        <span class="section-toggle">‚ñº</span>
                    </div>
                </div>
                <div class="section-body">
                    <!-- Interviewer Summary -->
                    <div class="interviewer-summary" id="interviewerSummary">
                        <div class="interviewer-header">
                            <div class="interviewer-avatar" id="interviewerAvatar">?</div>
                            <div class="interviewer-info">
                                <h4 id="intelInterviewerName">Loading...</h4>
                                <div class="title" id="intelInterviewerTitle"></div>
                                <div class="tenure" id="intelTenure"></div>
                            </div>
                        </div>
                        <div class="interviewer-bio" id="intelSummary"></div>
                    </div>

                    <!-- Intel Grid -->
                    <div class="intel-grid">
                        <!-- Evaluation Focus -->
                        <div class="intel-card">
                            <h5>üîç What They'll Evaluate</h5>
                            <ul id="intelEvalFocus"></ul>
                        </div>

                        <!-- Question Themes -->
                        <div class="intel-card">
                            <h5>‚ùì Predicted Question Themes</h5>
                            <ul id="intelQuestionThemes"></ul>
                        </div>
                    </div>

                    <!-- Communication Style -->
                    <div class="intel-card" style="margin-top: 16px;">
                        <h5>üí¨ Communication Strategy</h5>
                        <p id="intelCommStyle"></p>
                    </div>

                    <!-- Risks and Defenses -->
                    <div class="intel-card" style="margin-top: 16px;">
                        <h5>‚ö†Ô∏è Key Risks & Defenses</h5>
                        <div id="intelRisks"></div>
                    </div>

                    <!-- Strengths to Highlight -->
                    <div class="intel-card" style="margin-top: 16px;">
                        <h5>üí™ Strengths to Highlight</h5>
                        <div id="intelStrengths"></div>
                    </div>

                    <!-- Tailored Stories -->
                    <div class="intel-card" style="margin-top: 16px;">
                        <h5>üìñ Story Recommendations</h5>
                        <div id="intelStories"></div>
                    </div>

                    <!-- Questions to Ask -->
                    <div class="intel-card" style="margin-top: 16px;">
                        <h5>üôã Questions to Ask This Interviewer</h5>
                        <div id="intelQuestions"></div>
                    </div>
                </div>
            </div>

            <!-- Section 1: What They Evaluate -->
            <div class="section" id="evaluateSection">
                <div class="section-header" onclick="toggleSection(this)">
                    <h3 class="section-title"><span>üéØ</span> What They're Evaluating</h3>
                    <span class="section-toggle">‚ñº</span>
                </div>
                <div class="section-body">
                    <ul class="content-list" id="evaluateList"></ul>
                </div>
            </div>

            <!-- Section 2: Your 60-90 Second Intro -->
            <div class="section" id="introSection">
                <div class="section-header" onclick="toggleSection(this)">
                    <h3 class="section-title"><span>üó£Ô∏è</span> Your 60-90 Second Intro</h3>
                    <span class="section-toggle">‚ñº</span>
                </div>
                <div class="section-body">
                    <div id="introFramingNote"></div>
                    <div class="intro-card">
                        <p id="introText"></p>
                        <div class="intro-meta">
                            <span class="word-count" id="introWordCount"></span>
                            <button class="btn-regenerate" onclick="regenerateIntro()">Regenerate</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Section 3: Likely Questions -->
            <div class="section" id="questionsSection">
                <div class="section-header" onclick="toggleSection(this)">
                    <h3 class="section-title"><span>‚ùì</span> Likely Questions</h3>
                    <span class="section-toggle">‚ñº</span>
                </div>
                <div class="section-body">
                    <div id="questionsList"></div>
                </div>
            </div>

            <!-- Section 4: High-Impact Stories -->
            <div class="section" id="storiesSection">
                <div class="section-header" onclick="toggleSection(this)">
                    <h3 class="section-title"><span>üìñ</span> Your High-Impact Stories</h3>
                    <span class="section-toggle">‚ñº</span>
                </div>
                <div class="section-body">
                    <div id="storiesList"></div>
                </div>
            </div>

            <!-- Section 5: Red Flags to Avoid -->
            <div class="section" id="redFlagsSection">
                <div class="section-header" onclick="toggleSection(this)">
                    <h3 class="section-title"><span>‚ö†Ô∏è</span> Red Flags to Avoid</h3>
                    <span class="section-toggle">‚ñº</span>
                </div>
                <div class="section-body">
                    <div id="redFlagsList"></div>
                </div>
            </div>

            <!-- Section 5.5: Questions to Ask Them -->
            <div class="section" id="questionsToAskSection" style="display: none;">
                <div class="section-header" onclick="toggleSection(this)">
                    <h3 class="section-title"><span>üí¨</span> Questions to Ask Them</h3>
                    <span class="section-toggle">‚ñº</span>
                </div>
                <div class="section-body">
                    <p style="color: #9ca3af; font-size: 0.9rem; margin-bottom: 16px;">Smart questions that show you've done your homework and are evaluating them too.</p>
                    <div id="questionsToAskList"></div>
                </div>
            </div>

            <!-- Section 6: Strategy Scenarios (for HM/Technical only) -->
            <div class="section" id="strategySection" style="display: none;">
                <div class="section-header" onclick="toggleSection(this)">
                    <h3 class="section-title"><span>üß©</span> Strategy Scenarios</h3>
                    <span class="section-toggle">‚ñº</span>
                </div>
                <div class="section-body">
                    <div id="strategyList"></div>
                </div>
            </div>

            <!-- Section 7: Recommended Drills -->
            <div class="section" id="drillsSection">
                <div class="section-header" onclick="toggleSection(this)">
                    <h3 class="section-title"><span>üèãÔ∏è</span> Recommended Drills</h3>
                    <span class="section-toggle">‚ñº</span>
                </div>
                <div class="section-body">
                    <div class="drill-grid" id="drillsGrid"></div>
                </div>
            </div>

            <!-- CTA: Start Mock Interview -->
            <div class="cta-section">
                <button class="cta-btn" onclick="startStageMockInterview()">
                    üé§ Start <span id="stageSpecificMock">Mock Interview</span>
                </button>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const API_BASE = window.location.hostname === 'localhost' ? 'http://localhost:8000' : 'https://henryai-app-production.up.railway.app';

        // State
        let currentInterview = null;
        let prepData = null;
        let resumeData = null;
        let interviewerIntelData = null;

        // Generating tips to rotate through
        const generatingTips = [
            "Candidates who practice their intro 3+ times are 40% more likely to feel confident.",
            "The best stories use specific numbers and results to demonstrate impact.",
            "Most interviewers form an impression in the first 90 seconds.",
            "Asking thoughtful questions shows genuine interest in the role.",
            "Review the job description before your interview to align your stories.",
            "Practice out loud. It's different from practicing in your head.",
            "Arriving 5-10 minutes early shows professionalism and reduces stress."
        ];

        // Update generating step status
        function updateGeneratingStep(stepId, status) {
            const step = document.getElementById(stepId);
            if (!step) return;

            // Remove all status classes
            step.classList.remove('pending', 'active', 'done');
            step.classList.add(status);

            // Update icon
            const icon = step.querySelector('.gen-step-icon');
            if (icon) {
                if (status === 'active') icon.textContent = '‚óê';
                else if (status === 'done') icon.textContent = '‚úì';
                else icon.textContent = '‚óã';
            }
        }

        // Rotate tips during generation
        function startTipRotation() {
            let tipIndex = 0;
            const tipEl = document.getElementById('generatingTip');
            if (!tipEl) return;

            return setInterval(() => {
                tipIndex = (tipIndex + 1) % generatingTips.length;
                tipEl.style.opacity = '0';
                setTimeout(() => {
                    tipEl.textContent = generatingTips[tipIndex];
                    tipEl.style.opacity = '1';
                }, 300);
            }, 5000);
        }

        // Interview type labels
        const typeLabels = {
            'recruiter_screen': 'Recruiter Screen',
            'hiring_manager': 'Hiring Manager',
            'technical': 'Technical',
            'panel': 'Panel / Final',
            'executive': 'Executive'
        };

        // Load data on page load
        document.addEventListener('DOMContentLoaded', async () => {
            // Get interview ID from session storage
            const interviewId = sessionStorage.getItem('currentInterviewId');

            if (!interviewId) {
                showError();
                return;
            }

            // Get interviews from localStorage
            const interviews = JSON.parse(localStorage.getItem('upcomingInterviews') || '[]');
            currentInterview = interviews.find(i => String(i.id) === String(interviewId));
            console.log('Looking for interview ID:', interviewId, 'Found:', currentInterview ? 'yes' : 'no');
            if (currentInterview) {
                console.log('Interview data:', {
                    company: currentInterview.company,
                    hasLinkedInProfile: !!currentInterview.linkedInProfile,
                    hasInterviewerInsights: !!currentInterview.interviewerInsights,
                    linkedInProfileType: currentInterview.linkedInProfile?.type
                });
            }

            // Also check tracker apps if not found in interviews list
            // This handles the case where interview came from Command Center
            if (!currentInterview && interviewId.startsWith('app-')) {
                const appId = interviewId.replace('app-', '');
                const trackedApps = JSON.parse(localStorage.getItem('trackedApplications') || '[]');
                const app = trackedApps.find(a => String(a.id) === appId);
                if (app && app.interviewDate) {
                    currentInterview = {
                        id: interviewId,
                        appId: app.id,
                        company: app.company,
                        role: app.role,
                        type: app.interviewType || app.status || 'Interview',
                        date: app.interviewDate,
                        interviewerName: app.interviewerName || '',
                        interviewerTitle: app.interviewerTitle || '',
                        jobDescription: app.jobDescription || app.notes || '',
                        // Hydrate intel fields from tracker app
                        linkedInProfile: app.linkedInProfile || null,
                        interviewerInsights: app.interviewerInsights || null
                    };
                }
            }

            // Also check completed interviews
            if (!currentInterview) {
                const completed = JSON.parse(localStorage.getItem('completedInterviews') || '[]');
                currentInterview = completed.find(i => String(i.id) === String(interviewId));
            }

            // Final fallback: check tracker apps without app- prefix
            // (in case interview was scheduled via Interview Intelligence and synced to tracker)
            if (!currentInterview) {
                const trackedApps = JSON.parse(localStorage.getItem('trackedApplications') || '[]');
                // Try to find by interviewId directly in case it's stored differently
                const app = trackedApps.find(a =>
                    String(a.id) === String(interviewId) ||
                    (a.interviewDate && a.company && interviews.some(i =>
                        i.company.toLowerCase() === a.company.toLowerCase() &&
                        String(i.id) === String(interviewId)
                    ))
                );
                if (app && app.interviewDate) {
                    currentInterview = {
                        id: interviewId,
                        appId: app.id,
                        company: app.company,
                        role: app.role,
                        type: app.interviewType || app.status || 'Interview',
                        date: app.interviewDate,
                        interviewerName: app.interviewerName || '',
                        interviewerTitle: app.interviewerTitle || '',
                        jobDescription: app.jobDescription || app.notes || '',
                        // Hydrate intel fields from tracker app
                        linkedInProfile: app.linkedInProfile || null,
                        interviewerInsights: app.interviewerInsights || null
                    };
                }
            }

            if (!currentInterview) {
                showError();
                return;
            }

            // Load resume data from multiple sources (fallback chain)
            // 1. Try sessionStorage first (set by resume-leveling.html)
            let storedResume = sessionStorage.getItem('resumeData');
            if (storedResume) {
                try {
                    resumeData = JSON.parse(storedResume);
                    console.log('Loaded resume from sessionStorage');
                } catch (e) {
                    console.error('Error parsing resume from sessionStorage:', e);
                }
            }

            // 2. Fallback to userProfile in localStorage
            if (!resumeData) {
                try {
                    const userProfile = JSON.parse(localStorage.getItem('userProfile') || '{}');
                    if (userProfile.resume_json || userProfile.resume) {
                        resumeData = userProfile.resume_json || userProfile.resume;
                        console.log('Loaded resume from userProfile localStorage');
                    }
                } catch (e) {
                    console.error('Error loading resume from userProfile:', e);
                }
            }

            // 3. Try to load from Supabase if HenryData is available
            if (!resumeData && typeof HenryData !== 'undefined') {
                try {
                    const profile = await HenryData.getProfile();
                    if (profile && (profile.resume_json || profile.resume)) {
                        resumeData = profile.resume_json || profile.resume;
                        console.log('Loaded resume from Supabase profile');
                    }
                } catch (e) {
                    console.error('Error loading resume from Supabase:', e);
                }
            }

            if (!resumeData) {
                console.warn('No resume data found - prep guide will use generic content');
            }

            // Generate prep guide
            await generatePrepGuide();
        });

        function showError() {
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('errorState').style.display = 'block';
        }

        async function generatePrepGuide() {
            try {
                // Show loading
                document.getElementById('loadingState').style.display = 'flex';

                // Start tip rotation
                const tipInterval = startTipRotation();

                // Simulate step progression for better UX
                const stepTimers = [];
                stepTimers.push(setTimeout(() => {
                    updateGeneratingStep('step-analyze', 'done');
                    updateGeneratingStep('step-questions', 'active');
                }, 2000));
                stepTimers.push(setTimeout(() => {
                    updateGeneratingStep('step-questions', 'done');
                    updateGeneratingStep('step-stories', 'active');
                }, 4500));
                stepTimers.push(setTimeout(() => {
                    updateGeneratingStep('step-stories', 'done');
                    updateGeneratingStep('step-intro', 'active');
                }, 7000));

                // CHECK FOR CACHED INTERVIEWER INSIGHTS FIRST
                // Always use cached insights if available (mark as stale if >7 days)
                let intelIsStale = false;
                if (currentInterview.interviewerInsights) {
                    const cachedAt = new Date(currentInterview.interviewerInsights.extractedAt);
                    const daysSinceCached = (Date.now() - cachedAt.getTime()) / (1000 * 60 * 60 * 24);
                    interviewerIntelData = currentInterview.interviewerInsights.data;
                    intelIsStale = daysSinceCached >= 7;
                    console.log('Using cached interviewer insights (cached ' + Math.round(daysSinceCached) + ' days ago' + (intelIsStale ? ', marked as stale' : '') + ')');
                }

                // Check if we have LinkedIn profile data to analyze
                const hasLinkedInProfile = currentInterview.linkedInProfile &&
                    (currentInterview.linkedInProfile.type === 'text' ||
                     currentInterview.linkedInProfile.type === 'file');
                console.log('LinkedIn profile check:', {
                    hasLinkedInProfile,
                    linkedInProfile: currentInterview.linkedInProfile,
                    alreadyHasIntel: !!interviewerIntelData
                });

                // Generate prep guide and interviewer intelligence in parallel if profile exists
                const prepPromise = fetch(`${API_BASE}/api/prep-guide/generate`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        company: currentInterview.company,
                        role_title: currentInterview.role,
                        interview_type: currentInterview.type,
                        job_description: currentInterview.jobDescription || '',
                        interviewer_name: currentInterview.interviewerName || '',
                        interviewer_title: currentInterview.interviewerTitle || '',
                        resume_json: resumeData || {}
                    })
                });

                // Generate interviewer intelligence if LinkedIn profile available AND not cached
                let intelPromise = null;
                if (hasLinkedInProfile && !interviewerIntelData) {
                    const linkedInText = await getLinkedInText();
                    if (linkedInText) {
                        console.log('Generating new interviewer intelligence...');
                        intelPromise = fetch(`${API_BASE}/api/interviewer-intelligence/analyze`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                linkedin_profile_text: linkedInText,
                                company: currentInterview.company,
                                role_title: currentInterview.role,
                                interview_type: currentInterview.type,
                                interviewer_name: currentInterview.interviewerName || '',
                                interviewer_title: currentInterview.interviewerTitle || '',
                                candidate_resume_json: resumeData || {},
                                job_description: currentInterview.jobDescription || ''
                            })
                        });
                    }
                }

                // Wait for both requests
                const [prepResponse, intelResponse] = await Promise.all([
                    prepPromise,
                    intelPromise || Promise.resolve(null)
                ]);

                if (!prepResponse.ok) {
                    throw new Error('Failed to generate prep guide');
                }

                prepData = await prepResponse.json();

                // Process interviewer intelligence if available
                if (intelResponse && intelResponse.ok) {
                    interviewerIntelData = await intelResponse.json();
                    console.log('Interviewer intelligence generated:', interviewerIntelData.interviewer_name);

                    // PERSIST: Cache the generated insights to the interview object
                    await cacheInterviewerInsights(interviewerIntelData);
                }

                // Clear step timers and tip rotation
                stepTimers.forEach(t => clearTimeout(t));
                if (tipInterval) clearInterval(tipInterval);

                // Mark all steps as done before showing content
                updateGeneratingStep('step-analyze', 'done');
                updateGeneratingStep('step-questions', 'done');
                updateGeneratingStep('step-stories', 'done');
                updateGeneratingStep('step-intro', 'done');

                // Small delay to show completed state
                await new Promise(resolve => setTimeout(resolve, 300));

                renderPrepGuide();

            } catch (error) {
                console.error('Error generating prep guide:', error);
                // Clear timers on error too
                stepTimers.forEach(t => clearTimeout(t));
                if (tipInterval) clearInterval(tipInterval);
                // Show error or fallback content
                showFallbackContent();
            }
        }

        // Extract LinkedIn text from stored profile data
        async function getLinkedInText() {
            const profile = currentInterview.linkedInProfile;
            if (!profile) return null;

            if (profile.type === 'text') {
                return profile.data;
            }

            if (profile.type === 'file') {
                // For files, we need to extract text via API
                try {
                    // Convert base64 back to file
                    const base64Data = profile.data.split(',')[1]; // Remove data:... prefix
                    const byteString = atob(base64Data);
                    const ab = new ArrayBuffer(byteString.length);
                    const ia = new Uint8Array(ab);
                    for (let i = 0; i < byteString.length; i++) {
                        ia[i] = byteString.charCodeAt(i);
                    }
                    const blob = new Blob([ab], { type: profile.fileType });
                    const file = new File([blob], profile.fileName, { type: profile.fileType });

                    // Call extraction API
                    const formData = new FormData();
                    formData.append('file', file);

                    const response = await fetch(`${API_BASE}/api/interviewer-intelligence/extract-text`, {
                        method: 'POST',
                        body: formData
                    });

                    if (response.ok) {
                        const result = await response.json();
                        return result.text;
                    }
                } catch (e) {
                    console.error('Error extracting LinkedIn text:', e);
                }
            }

            return null;
        }

        function showFallbackContent() {
            // Hide loading, show content with placeholder data
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('prepContent').style.display = 'block';

            // Set header
            document.getElementById('companyName').textContent = currentInterview.company;
            document.getElementById('interviewTypeBreadcrumb').textContent = typeLabels[currentInterview.type] || currentInterview.type;
            document.getElementById('pageTitle').textContent = `${typeLabels[currentInterview.type] || currentInterview.type} Prep`;

            const date = new Date(currentInterview.date);
            const dateStr = date.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' });
            const timeStr = date.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
            document.getElementById('interviewMeta').textContent = `${dateStr} at ${timeStr}${currentInterview.interviewerName ? ' with ' + currentInterview.interviewerName : ''}`;

            // Set mock interview button
            document.getElementById('stageSpecificMock').textContent = `${typeLabels[currentInterview.type] || ''} Mock Interview`;

            // Show fallback message
            document.getElementById('evaluateList').innerHTML = '<li style="color: #9ca3af;">Unable to generate prep. Please check your connection and try again.</li>';
        }

        function renderPrepGuide() {
            // Hide loading, show content
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('prepContent').style.display = 'block';

            // Determine prep mode based on interviewer intelligence availability
            const hasInterviewerIntel = Boolean(interviewerIntelData);
            const prepMode = hasInterviewerIntel ? 'interviewer-driven' : 'generic';
            console.log('Prep mode:', prepMode);

            // Set header
            document.getElementById('companyName').textContent = currentInterview.company;
            document.getElementById('interviewTypeBreadcrumb').textContent = typeLabels[currentInterview.type] || currentInterview.type;
            document.getElementById('pageTitle').textContent = `${typeLabels[currentInterview.type] || currentInterview.type} Prep`;

            const date = new Date(currentInterview.date);
            const dateStr = date.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' });
            const timeStr = date.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
            document.getElementById('interviewMeta').textContent = `${dateStr} at ${timeStr}${currentInterview.interviewerName ? ' with ' + currentInterview.interviewerName : ''}`;

            // Set mock interview button
            document.getElementById('stageSpecificMock').textContent = `${typeLabels[currentInterview.type] || ''} Mock Interview`;

            // Render Interviewer Intelligence summary if available (collapsed by default in interviewer-driven mode)
            if (hasInterviewerIntel) {
                renderInterviewerIntelligence();
            }

            // ============================================================================
            // MERGED SECTION 1: What They Evaluate (intel.likely_evaluation_focus + prepData.what_they_evaluate)
            // ============================================================================
            const evaluateList = document.getElementById('evaluateList');
            let mergedEvalFocus = [];
            if (hasInterviewerIntel && interviewerIntelData.likely_evaluation_focus) {
                // Intel first (tagged as personalized)
                mergedEvalFocus = interviewerIntelData.likely_evaluation_focus.map(item => ({
                    text: item,
                    source: 'intel'
                }));
            }
            // Add generic items that don't overlap
            const genericEval = prepData.what_they_evaluate || [];
            const intelEvalLower = mergedEvalFocus.map(e => e.text.toLowerCase());
            genericEval.forEach(item => {
                const itemLower = item.toLowerCase();
                // Check for substantial overlap (more than just common words)
                const hasOverlap = intelEvalLower.some(intelItem =>
                    intelItem.includes(itemLower.slice(0, 20)) || itemLower.includes(intelItem.slice(0, 20))
                );
                if (!hasOverlap) {
                    mergedEvalFocus.push({ text: item, source: 'generic' });
                }
            });
            evaluateList.innerHTML = mergedEvalFocus.map(item =>
                `<li${item.source === 'intel' ? ' class="intel-sourced"' : ''}>${item.text}${item.source === 'intel' ? ' <span class="intel-badge">personalized</span>' : ''}</li>`
            ).join('');

            // ============================================================================
            // SECTION 2: Intro Pitch (with framing when intel exists)
            // ============================================================================
            const introText = document.getElementById('introText');
            let introPitch = prepData.intro_pitch || 'Loading...';

            // Add framing text when interviewer intel exists
            if (hasInterviewerIntel) {
                const interviewerName = interviewerIntelData.interviewer_name?.split(' ')[0] || currentInterview.interviewerName?.split(' ')[0] || 'the interviewer';
                const interviewerFocus = interviewerIntelData.likely_evaluation_focus?.[0] || 'key competencies';
                const framingNote = document.getElementById('introFramingNote');
                if (framingNote) {
                    framingNote.innerHTML = `<em>Tailored for ${interviewerName}, who values: ${interviewerFocus}</em>`;
                    framingNote.style.display = 'block';
                }
            }

            introText.textContent = introPitch;
            const wordCount = (introPitch || '').split(/\s+/).length;
            document.getElementById('introWordCount').textContent = `${wordCount} words`;

            // ============================================================================
            // MERGED SECTION 3: Likely Questions (intel themes first, generic deprioritized)
            // ============================================================================
            const questionsList = document.getElementById('questionsList');
            let mergedQuestions = [];

            if (hasInterviewerIntel && interviewerIntelData.predicted_question_themes) {
                // Convert intel themes to question format (they're themes, not full questions)
                interviewerIntelData.predicted_question_themes.forEach(theme => {
                    mergedQuestions.push({
                        question: theme,
                        guidance: `Based on ${interviewerIntelData.interviewer_name || 'interviewer'}'s background, expect probing questions in this area.`,
                        source: 'intel'
                    });
                });
            }

            // Add generic questions that don't substantially overlap
            const genericQuestions = prepData.likely_questions || [];
            const intelQuestionsLower = mergedQuestions.map(q => q.question.toLowerCase());
            genericQuestions.forEach(q => {
                const qLower = q.question.toLowerCase();
                const hasOverlap = intelQuestionsLower.some(intelQ =>
                    intelQ.includes(qLower.slice(0, 25)) || qLower.includes(intelQ.slice(0, 25))
                );
                if (!hasOverlap) {
                    mergedQuestions.push({ ...q, source: 'generic' });
                }
            });

            questionsList.innerHTML = mergedQuestions.map((q, i) => `
                <div class="question-item collapsed${q.source === 'intel' ? ' intel-sourced' : ''}">
                    <div class="question-header" onclick="toggleQuestion(this)">
                        <span class="question-text">${q.question}${q.source === 'intel' ? ' <span class="intel-badge">likely theme</span>' : ''}</span>
                        <span class="question-toggle">‚ñº</span>
                    </div>
                    <div class="question-answer">${q.guidance || 'Focus on specific examples from your experience.'}</div>
                </div>
            `).join('');

            // ============================================================================
            // MERGED SECTION 4: Stories (intel tailored_stories first, then generic)
            // ============================================================================
            const storiesList = document.getElementById('storiesList');
            let mergedStories = [];

            // Intel tailored stories first (these are story recommendations, not full STAR stories)
            if (hasInterviewerIntel && interviewerIntelData.tailored_stories) {
                interviewerIntelData.tailored_stories.forEach(s => {
                    mergedStories.push({
                        title: s.story_title,
                        competency: s.competency,
                        // These are recommendations - provide guidance rather than full STAR
                        situation: s.why_this_story || 'Tailored recommendation based on interviewer background.',
                        task: '',
                        action: '',
                        result: '',
                        source: 'intel',
                        isRecommendation: true
                    });
                });
            }

            // Add generic stories
            const genericStories = prepData.stories || [];
            const intelStoryTitles = mergedStories.map(s => s.title.toLowerCase());
            genericStories.forEach(story => {
                const titleLower = story.title.toLowerCase();
                const hasOverlap = intelStoryTitles.some(intelTitle =>
                    intelTitle.includes(titleLower.slice(0, 15)) || titleLower.includes(intelTitle.slice(0, 15))
                );
                if (!hasOverlap) {
                    mergedStories.push({ ...story, source: 'generic' });
                }
            });

            storiesList.innerHTML = mergedStories.map(story => {
                if (story.isRecommendation) {
                    // Render intel recommendations differently
                    return `
                        <div class="story-card collapsed intel-sourced">
                            <div class="story-header" onclick="toggleStory(this)">
                                <span class="story-title">${story.title} <span class="intel-badge">recommended</span></span>
                                <span class="story-tag">${story.competency || 'General'}</span>
                            </div>
                            <div class="story-body">
                                <div class="story-section">
                                    <div class="story-section-label">WHY THIS STORY</div>
                                    <p>${story.situation}</p>
                                </div>
                            </div>
                        </div>
                    `;
                } else {
                    // Render full STAR stories
                    return `
                        <div class="story-card collapsed">
                            <div class="story-header" onclick="toggleStory(this)">
                                <span class="story-title">${story.title}</span>
                                <span class="story-tag">${story.competency || 'General'}</span>
                            </div>
                            <div class="story-body">
                                <div class="story-section">
                                    <div class="story-section-label">SITUATION</div>
                                    <p>${story.situation || ''}</p>
                                </div>
                                <div class="story-section">
                                    <div class="story-section-label">TASK</div>
                                    <p>${story.task || ''}</p>
                                </div>
                                <div class="story-section">
                                    <div class="story-section-label">ACTION</div>
                                    <p>${story.action || ''}</p>
                                </div>
                                <div class="story-section">
                                    <div class="story-section-label">RESULT</div>
                                    <p>${story.result || ''}</p>
                                </div>
                            </div>
                        </div>
                    `;
                }
            }).join('');

            // ============================================================================
            // MERGED SECTION 5: Red Flags / Risks (intel risks first, then generic)
            // ============================================================================
            const redFlagsList = document.getElementById('redFlagsList');
            let mergedRisks = [];

            // Intel risks (with defenses)
            if (hasInterviewerIntel && interviewerIntelData.risks) {
                interviewerIntelData.risks.forEach(r => {
                    mergedRisks.push({
                        text: r.risk,
                        defense: r.defense,
                        source: 'intel'
                    });
                });
            }

            // Generic red flags
            const genericFlags = prepData.red_flags || [];
            const intelRisksLower = mergedRisks.map(r => r.text.toLowerCase());
            genericFlags.forEach(flag => {
                const flagLower = flag.toLowerCase();
                const hasOverlap = intelRisksLower.some(intelRisk =>
                    intelRisk.includes(flagLower.slice(0, 20)) || flagLower.includes(intelRisk.slice(0, 20))
                );
                if (!hasOverlap) {
                    mergedRisks.push({ text: flag, source: 'generic' });
                }
            });

            redFlagsList.innerHTML = mergedRisks.map(item => {
                if (item.source === 'intel' && item.defense) {
                    return `
                        <div class="red-flag-item intel-sourced">
                            <span class="red-flag-icon">‚ö†Ô∏è</span>
                            <div class="red-flag-content">
                                <span class="red-flag-text">${item.text} <span class="intel-badge">personalized</span></span>
                                <div class="red-flag-defense">‚Üí ${item.defense}</div>
                            </div>
                        </div>
                    `;
                } else {
                    return `
                        <div class="red-flag-item">
                            <span class="red-flag-icon">‚ö†Ô∏è</span>
                            <span class="red-flag-text">${item.text}</span>
                        </div>
                    `;
                }
            }).join('');

            // ============================================================================
            // MERGED SECTION 5.5: Questions to Ask Them (intel first, deduplicate)
            // ============================================================================
            const questionsToAskList = document.getElementById('questionsToAskList');
            let mergedQuestionsToAsk = [];

            // Intel questions to ask first
            if (hasInterviewerIntel && interviewerIntelData.questions_to_ask) {
                interviewerIntelData.questions_to_ask.forEach(q => {
                    mergedQuestionsToAsk.push({
                        question: q.question,
                        rationale: q.rationale,
                        source: 'intel'
                    });
                });
            }

            // Generic questions to ask
            const genericQuestionsToAsk = prepData.questions_to_ask || [];
            const intelQToAskLower = mergedQuestionsToAsk.map(q => q.question.toLowerCase());
            genericQuestionsToAsk.forEach(q => {
                const qText = typeof q === 'string' ? q : q.question;
                const qLower = qText.toLowerCase();
                const hasOverlap = intelQToAskLower.some(intelQ =>
                    intelQ.includes(qLower.slice(0, 25)) || qLower.includes(intelQ.slice(0, 25))
                );
                if (!hasOverlap) {
                    mergedQuestionsToAsk.push({
                        question: qText,
                        rationale: typeof q !== 'string' ? (q.why || q.rationale) : null,
                        source: 'generic'
                    });
                }
            });

            if (mergedQuestionsToAsk.length > 0) {
                document.getElementById('questionsToAskSection').style.display = 'block';
                questionsToAskList.innerHTML = mergedQuestionsToAsk.map(q => `
                    <div class="question-to-ask-item${q.source === 'intel' ? ' intel-sourced' : ''}">
                        <div class="question-to-ask-text">"${q.question}"${q.source === 'intel' ? ' <span class="intel-badge">personalized</span>' : ''}</div>
                        ${q.rationale ? `<div class="question-to-ask-rationale">Why: ${q.rationale}</div>` : ''}
                    </div>
                `).join('');
            }

            // ============================================================================
            // SECTION 6: Strategy (only for HM/Technical)
            // ============================================================================
            if (currentInterview.type === 'hiring_manager' || currentInterview.type === 'technical') {
                document.getElementById('strategySection').style.display = 'block';
                const strategyList = document.getElementById('strategyList');
                strategyList.innerHTML = (prepData.strategy_scenarios || []).map((scenario, i) => `
                    <div class="question-item collapsed">
                        <div class="question-header" onclick="toggleQuestion(this)">
                            <span class="question-text">${scenario.scenario}</span>
                            <span class="question-toggle">‚ñº</span>
                        </div>
                        <div class="question-answer">${scenario.approach || ''}</div>
                    </div>
                `).join('');
            }

            // ============================================================================
            // SECTION 7: Recommended Drills
            // ============================================================================
            const drillsGrid = document.getElementById('drillsGrid');
            const drills = [
                { icon: 'üéØ', name: 'Intro Practice', type: 'intro' },
                { icon: 'üìñ', name: 'Behavioral', type: 'behavioral' },
                { icon: 'üß©', name: 'Strategy', type: 'strategy' },
                { icon: 'üé§', name: 'Mock Interview', type: 'mock' }
            ];
            drillsGrid.innerHTML = drills.map(d => `
                <div class="drill-card" onclick="openDrill('${d.type}')">
                    <div class="drill-icon">${d.icon}</div>
                    <div class="drill-name">${d.name}</div>
                </div>
            `).join('');
        }

        // Toggle section expand/collapse
        function toggleSection(header) {
            const section = header.closest('.section');
            section.classList.toggle('collapsed');
        }

        // Toggle question expand/collapse
        function toggleQuestion(header) {
            const item = header.closest('.question-item');
            item.classList.toggle('collapsed');
        }

        // Toggle story expand/collapse
        function toggleStory(header) {
            const card = header.closest('.story-card');
            card.classList.toggle('collapsed');
        }

        // Regenerate intro
        async function regenerateIntro() {
            const btn = event.target;
            btn.disabled = true;
            btn.textContent = 'Generating...';

            try {
                const response = await fetch(`${API_BASE}/api/prep-guide/regenerate-intro`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        company: currentInterview.company,
                        role_title: currentInterview.role,
                        interview_type: currentInterview.type,
                        job_description: currentInterview.jobDescription || '',
                        resume_json: resumeData || {}
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('introText').textContent = data.intro_pitch;
                    const wordCount = data.intro_pitch.split(/\s+/).length;
                    document.getElementById('introWordCount').textContent = `${wordCount} words`;
                }
            } catch (error) {
                console.error('Error regenerating intro:', error);
            } finally {
                btn.disabled = false;
                btn.textContent = 'Regenerate';
            }
        }

        // Open drill
        function openDrill(type) {
            if (type === 'mock') {
                startStageMockInterview();
            } else if (type === 'intro') {
                window.location.href = '/practice-intro';
            } else {
                window.location.href = `/practice-drills?type=${type}`;
            }
        }

        // Start stage-specific mock interview
        function startStageMockInterview() {
            // Store current interview context for mock interview
            sessionStorage.setItem('mockInterviewContext', JSON.stringify({
                company: currentInterview.company,
                role: currentInterview.role,
                type: currentInterview.type,
                jobDescription: currentInterview.jobDescription
            }));
            window.location.href = '/mock-interview';
        }

        // Render Interviewer Intelligence section
        function renderInterviewerIntelligence() {
            const intel = interviewerIntelData;
            if (!intel) return;

            // Show the section
            document.getElementById('interviewerIntelSection').style.display = 'block';

            // Show cache status if insights are cached
            const cacheStatusEl = document.getElementById('intelCacheStatus');
            if (currentInterview.interviewerInsights) {
                const cachedAt = new Date(currentInterview.interviewerInsights.extractedAt);
                const daysSince = Math.round((Date.now() - cachedAt.getTime()) / (1000 * 60 * 60 * 24));
                const confidence = currentInterview.interviewerInsights.confidence || 'medium';
                const confColor = confidence === 'high' ? '#10b981' : confidence === 'medium' ? '#f59e0b' : '#ef4444';
                cacheStatusEl.innerHTML = `<span style="color: ${confColor};">‚óè</span> ${confidence} confidence ¬∑ Analyzed ${daysSince === 0 ? 'today' : daysSince + 'd ago'}`;
            }

            // Avatar initials
            const initials = intel.interviewer_name
                .split(' ')
                .map(n => n[0])
                .join('')
                .substring(0, 2)
                .toUpperCase();
            document.getElementById('interviewerAvatar').textContent = initials;

            // Basic info
            document.getElementById('intelInterviewerName').textContent = intel.interviewer_name;
            document.getElementById('intelInterviewerTitle').textContent = `${intel.interviewer_title} at ${intel.current_company}`;
            document.getElementById('intelTenure').textContent = `${intel.tenure} at company`;
            document.getElementById('intelSummary').textContent = intel.summary;

            // Evaluation Focus
            document.getElementById('intelEvalFocus').innerHTML = (intel.likely_evaluation_focus || [])
                .map(item => `<li>${item}</li>`)
                .join('');

            // Question Themes
            document.getElementById('intelQuestionThemes').innerHTML = (intel.predicted_question_themes || [])
                .map(item => `<li>${item}</li>`)
                .join('');

            // Communication Style
            document.getElementById('intelCommStyle').textContent = intel.communication_style;

            // Risks and Defenses
            document.getElementById('intelRisks').innerHTML = (intel.risks || [])
                .map(r => `
                    <div class="risk-item">
                        <div class="risk-title">‚ö†Ô∏è ${r.risk}</div>
                        <div class="risk-defense">‚Üí ${r.defense}</div>
                    </div>
                `)
                .join('');

            // Strengths to Highlight
            document.getElementById('intelStrengths').innerHTML = (intel.strengths_to_highlight || [])
                .map(s => `
                    <div class="strength-item">
                        <p><strong>${s.strength}</strong>: ${s.why_relevant}</p>
                    </div>
                `)
                .join('');

            // Tailored Stories
            document.getElementById('intelStories').innerHTML = (intel.tailored_stories || [])
                .map(s => `
                    <div class="strength-item">
                        <p><strong>${s.story_title}</strong> (${s.competency})</p>
                        <p style="color: #9ca3af; font-size: 0.85rem; margin-top: 4px;">${s.why_this_story}</p>
                    </div>
                `)
                .join('');

            // Questions to Ask
            document.getElementById('intelQuestions').innerHTML = (intel.questions_to_ask || [])
                .map(q => `
                    <div class="question-to-ask">
                        <div class="question">"${q.question}"</div>
                        <div class="rationale">Why: ${q.rationale}</div>
                    </div>
                `)
                .join('');
        }

        // ============================================================================
        // INTERVIEWER INSIGHTS CACHING
        // ============================================================================
        async function cacheInterviewerInsights(intelData) {
            if (!currentInterview || !intelData) return;

            try {
                // Build the cached insights object per Option B spec
                const insightsCache = {
                    source: 'linkedin',
                    extractedAt: new Date().toISOString(),
                    data: intelData,
                    // Quick summary fields for display in Interview Intelligence
                    summary: {
                        currentRole: intelData.interviewer_title || '',
                        currentCompany: intelData.current_company || '',
                        function: inferFunction(intelData),
                        seniority: inferSeniority(intelData.interviewer_title || ''),
                        tenureEstimate: intelData.tenure || ''
                    },
                    likelyFocus: intelData.likely_evaluation_focus || [],
                    confidence: calculateConfidence(intelData)
                };

                // Update current interview with insights
                currentInterview.interviewerInsights = insightsCache;

                // Persist to localStorage
                const interviews = JSON.parse(localStorage.getItem('upcomingInterviews') || '[]');
                const idx = interviews.findIndex(i => String(i.id) === String(currentInterview.id));
                if (idx >= 0) {
                    interviews[idx].interviewerInsights = insightsCache;
                    localStorage.setItem('upcomingInterviews', JSON.stringify(interviews));
                    console.log('Interviewer insights cached to localStorage');
                }

                // Sync to Supabase if available
                if (typeof HenryData !== 'undefined') {
                    HenryData.saveInterview(currentInterview).catch(e =>
                        console.error('Failed to sync insights to Supabase:', e)
                    );
                }
            } catch (e) {
                console.error('Error caching interviewer insights:', e);
            }
        }

        // Infer function category from title/profile
        function inferFunction(intelData) {
            const title = (intelData.interviewer_title || '').toLowerCase();
            const summary = (intelData.summary || '').toLowerCase();
            const combined = title + ' ' + summary;

            if (combined.match(/product|pm\b|pmo/)) return 'Product';
            if (combined.match(/engineer|developer|software|swe|tech lead|cto|architect/)) return 'Engineering';
            if (combined.match(/design|ux|ui|creative/)) return 'Design';
            if (combined.match(/data|analytics|ml|ai|machine learning|scientist/)) return 'Data';
            if (combined.match(/sales|revenue|gtm|growth|marketing|bd|business development/)) return 'GTM';
            if (combined.match(/recruit|talent|hr|people|human resources/)) return 'Talent/People';
            if (combined.match(/ceo|coo|founder|president|vp|director|head of|chief/)) return 'Leadership';
            return 'General';
        }

        // Infer seniority from title
        function inferSeniority(title) {
            const t = title.toLowerCase();
            if (t.match(/ceo|coo|cfo|cto|chief|founder|president|partner/)) return 'Executive';
            if (t.match(/vp|vice president|svp|evp|head of|director/)) return 'Director+';
            if (t.match(/senior manager|group manager|principal|staff|lead|manager/)) return 'Manager';
            return 'IC';
        }

        // Calculate confidence based on data completeness
        function calculateConfidence(intelData) {
            let score = 0;
            if (intelData.interviewer_name) score += 1;
            if (intelData.interviewer_title) score += 1;
            if (intelData.current_company) score += 1;
            if (intelData.tenure) score += 1;
            if (intelData.summary && intelData.summary.length > 50) score += 1;
            if (intelData.likely_evaluation_focus && intelData.likely_evaluation_focus.length >= 2) score += 1;
            if (intelData.communication_style) score += 1;

            if (score >= 6) return 'high';
            if (score >= 4) return 'medium';
            return 'low';
        }

        // Re-analyze function (clears cache and regenerates)
        async function reanalyzeLinkedIn() {
            if (!currentInterview.linkedInProfile) {
                alert('No LinkedIn profile uploaded. Edit the interview to add one.');
                return;
            }

            // Clear cached insights
            currentInterview.interviewerInsights = null;
            interviewerIntelData = null;

            // Update localStorage
            const interviews = JSON.parse(localStorage.getItem('upcomingInterviews') || '[]');
            const idx = interviews.findIndex(i => String(i.id) === String(currentInterview.id));
            if (idx >= 0) {
                interviews[idx].interviewerInsights = null;
                localStorage.setItem('upcomingInterviews', JSON.stringify(interviews));
            }

            // Regenerate
            await generatePrepGuide();
        }
    </script>
<script src="components/analytics.js"></script>
<script src="components/hey-henry.js"></script>
<script src="components/admin-alerts.js"></script>
<script src="components/strategy-nav.js"></script>
    <script src="components/status-banner.js"></script>
<script src="components/top-nav.js"></script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LinkedIn Profile Readiness | HenryHQ</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Instrument+Serif:ital@0;1&family=DM+Sans:opsz,wght@9..40,400;9..40,500;9..40,600&display=swap" rel="stylesheet">
    <style>
        :root {
            --color-bg: #0a0a0b;
            --color-surface: #141416;
            --color-surface-elevated: #1c1c1f;
            --color-border: rgba(255, 255, 255, 0.08);
            --color-border-hover: rgba(255, 255, 255, 0.15);
            --color-text: #fafafa;
            --color-text-secondary: #a1a1aa;
            --color-accent: #22d3ee;
            --color-accent-muted: rgba(34, 211, 238, 0.15);
            --color-linkedin: #0077b5;
            --color-success: #4ade80;
            --color-warning: #fbbf24;
            --color-error: #f87171;
            --font-display: 'Instrument Serif', Georgia, serif;
            --font-body: 'DM Sans', -apple-system, sans-serif;
            --ease-out: cubic-bezier(0.16, 1, 0.3, 1);
        }

        /* Job Fit Warning Banner */
        .job-fit-warning-banner {
            background: linear-gradient(135deg, rgba(248, 113, 113, 0.15), rgba(248, 113, 113, 0.08));
            border: 1px solid rgba(248, 113, 113, 0.4);
            border-radius: 12px;
            padding: 16px 20px;
            margin-bottom: 24px;
            display: flex;
            align-items: flex-start;
            gap: 12px;
        }

        .job-fit-warning-banner.caution {
            background: linear-gradient(135deg, rgba(251, 191, 36, 0.15), rgba(251, 191, 36, 0.08));
            border-color: rgba(251, 191, 36, 0.4);
        }

        .job-fit-warning-banner.proceeded {
            background: linear-gradient(135deg, rgba(251, 191, 36, 0.1), rgba(251, 191, 36, 0.05));
            border-color: rgba(251, 191, 36, 0.3);
        }

        .job-fit-warning-banner .warning-icon {
            font-size: 1.5rem;
            flex-shrink: 0;
        }

        .job-fit-warning-banner .warning-content {
            flex: 1;
        }

        .job-fit-warning-banner strong {
            display: block;
            color: #f87171;
            margin-bottom: 4px;
        }

        .job-fit-warning-banner.caution strong,
        .job-fit-warning-banner.proceeded strong {
            color: #fbbf24;
        }

        .job-fit-warning-banner p {
            color: var(--color-text-secondary);
            font-size: 0.9rem;
            margin: 0;
            line-height: 1.5;
        }

        /* How Recruiters Search Section */
        .how-recruiters-search {
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-left: 3px solid var(--color-linkedin);
            border-radius: 8px;
            margin-bottom: 24px;
            overflow: hidden;
        }

        .how-recruiters-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 20px;
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .how-recruiters-header:hover {
            background: var(--color-surface-elevated);
        }

        .how-recruiters-title {
            font-size: 0.95rem;
            font-weight: 500;
            color: var(--color-text);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .how-recruiters-title::before {
            content: "?";
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 20px;
            height: 20px;
            background: rgba(0, 119, 181, 0.2);
            color: var(--color-linkedin);
            border-radius: 50%;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .how-recruiters-chevron {
            color: var(--color-text-secondary);
            transition: transform 0.3s ease;
            font-size: 0.8rem;
        }

        .how-recruiters-search.collapsed .how-recruiters-chevron {
            transform: rotate(-90deg);
        }

        .how-recruiters-content {
            padding: 0 20px 20px;
            transition: max-height 0.3s ease, opacity 0.2s ease;
            overflow: hidden;
        }

        .how-recruiters-search.collapsed .how-recruiters-content {
            max-height: 0 !important;
            padding-top: 0;
            padding-bottom: 0;
            opacity: 0;
        }

        .how-recruiters-content p {
            font-size: 0.9rem;
            line-height: 1.6;
            color: var(--color-text-secondary);
            margin-bottom: 12px;
        }

        .how-recruiters-content p:last-child {
            margin-bottom: 0;
        }

        .how-recruiters-content strong {
            color: var(--color-text);
        }

        .three-second-test {
            background: var(--color-surface-elevated);
            border-radius: 8px;
            padding: 16px;
            margin-top: 12px;
        }

        .three-second-test h4 {
            font-size: 0.85rem;
            color: var(--color-linkedin);
            margin-bottom: 8px;
            font-weight: 600;
        }

        .three-second-test ol {
            margin: 0;
            padding-left: 20px;
            font-size: 0.85rem;
            color: var(--color-text-secondary);
        }

        .three-second-test li {
            margin-bottom: 4px;
        }

        /* Score Context Section */
        .score-context {
            background: var(--color-surface-elevated);
            border: 1px solid var(--color-border);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 24px;
        }

        .score-context-title {
            font-size: 0.85rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--color-accent);
            margin-bottom: 12px;
        }

        .score-context-text {
            font-size: 0.95rem;
            line-height: 1.6;
            color: var(--color-text);
            margin-bottom: 8px;
        }

        .score-context-encouragement {
            font-size: 0.9rem;
            line-height: 1.5;
            color: var(--color-success);
            font-style: italic;
        }

        /* Profile Gaps Section */
        .profile-gaps-section {
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-left: 4px solid var(--color-warning);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 24px;
        }

        .profile-gaps-header {
            font-family: var(--font-display);
            font-size: 1.2rem;
            margin-bottom: 8px;
            color: var(--color-text);
        }

        .profile-gaps-intro {
            color: var(--color-text-secondary);
            margin-bottom: 20px;
            line-height: 1.6;
            font-size: 0.95rem;
        }

        .gap-item {
            background: var(--color-surface-elevated);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 16px;
        }

        .gap-item:last-child {
            margin-bottom: 0;
        }

        .gap-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }

        .gap-icon {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            flex-shrink: 0;
        }

        .gap-icon.scope { background: rgba(239, 68, 68, 0.2); color: #f87171; }
        .gap-icon.evidence { background: rgba(251, 191, 36, 0.2); color: #fbbf24; }
        .gap-icon.credibility { background: rgba(251, 191, 36, 0.2); color: #fbbf24; }
        .gap-icon.positioning { background: rgba(251, 191, 36, 0.2); color: #fbbf24; }
        .gap-icon.recency { background: rgba(34, 211, 238, 0.2); color: #22d3ee; }

        .gap-title {
            font-weight: 600;
            font-size: 1rem;
        }

        .gap-description {
            color: var(--color-text);
            margin-bottom: 12px;
            line-height: 1.6;
            font-size: 0.95rem;
        }

        .gap-why {
            color: var(--color-text-secondary);
            font-size: 0.9rem;
            margin-bottom: 12px;
            padding-left: 16px;
            border-left: 2px solid var(--color-border);
            line-height: 1.5;
        }

        .gap-fix {
            color: var(--color-text);
            font-size: 0.9rem;
            padding: 12px;
            background: rgba(34, 211, 238, 0.1);
            border-radius: 8px;
            line-height: 1.6;
        }

        .gap-fix strong {
            color: var(--color-accent);
            font-weight: 600;
        }

        /* Section Cards */
        .section-cards {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 24px;
        }

        @media (max-width: 700px) {
            .section-cards {
                grid-template-columns: 1fr;
            }
        }

        .section-card {
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: 12px;
            overflow: hidden;
            transition: border-color 0.2s;
        }

        .section-card.good { border-left: 3px solid var(--color-success); }
        .section-card.warning { border-left: 3px solid var(--color-warning); }
        .section-card.bad { border-left: 3px solid var(--color-error); }

        .section-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 14px 16px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .section-card-header:hover {
            background: var(--color-surface-elevated);
        }

        .section-card-left {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section-icon {
            font-size: 1.1rem;
        }

        .section-name {
            font-weight: 600;
            font-size: 0.9rem;
        }

        .section-card-right {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section-score {
            font-weight: 600;
            font-size: 0.95rem;
        }

        .section-card.good .section-score { color: var(--color-success); }
        .section-card.warning .section-score { color: var(--color-warning); }
        .section-card.bad .section-score { color: var(--color-error); }

        .section-chevron {
            color: var(--color-text-secondary);
            transition: transform 0.2s;
            font-size: 0.8rem;
        }

        .section-card.expanded .section-chevron {
            transform: rotate(180deg);
        }

        .section-card-body {
            display: none;
            padding: 0 16px 16px;
            border-top: 1px solid var(--color-border);
        }

        .section-card.expanded .section-card-body {
            display: block;
        }

        .score-criteria {
            padding-top: 12px;
        }

        .criteria-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 0;
            font-size: 0.85rem;
            border-bottom: 1px solid var(--color-border);
        }

        .criteria-item:last-child {
            border-bottom: none;
        }

        .criteria-label {
            color: var(--color-text-secondary);
        }

        .criteria-value {
            font-weight: 500;
        }

        .criteria-value.earned { color: var(--color-success); }
        .criteria-value.partial { color: var(--color-warning); }
        .criteria-value.missed { color: var(--color-error); }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: var(--font-body);
            background: var(--color-bg);
            color: var(--color-text);
            min-height: 100vh;
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        .back-link {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            color: var(--color-text-secondary);
            text-decoration: none;
            font-size: 0.9rem;
            margin-bottom: 24px;
            transition: color 0.2s ease;
        }

        .back-link:hover { color: var(--color-accent); }

        h1 {
            font-family: var(--font-display);
            font-size: 2.2rem;
            font-weight: 400;
            margin-bottom: 8px;
        }

        .subtitle {
            color: var(--color-text-secondary);
            font-size: 1rem;
            margin-bottom: 32px;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 24px;
            border-bottom: 1px solid var(--color-border);
            padding-bottom: 0;
        }

        .tab {
            padding: 12px 20px;
            background: transparent;
            border: none;
            color: var(--color-text-secondary);
            font-size: 0.95rem;
            font-weight: 500;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            margin-bottom: -1px;
            transition: all 0.2s ease;
        }

        .tab:hover {
            color: var(--color-text);
        }

        .tab.active {
            color: var(--color-linkedin);
            border-bottom-color: var(--color-linkedin);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Upload Section */
        .upload-section {
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: 16px;
            padding: 40px;
            text-align: center;
        }

        .upload-icon {
            font-size: 3rem;
            margin-bottom: 16px;
        }

        .upload-title {
            font-family: var(--font-display);
            font-size: 1.5rem;
            margin-bottom: 12px;
        }

        .upload-description {
            color: var(--color-text-secondary);
            font-size: 0.95rem;
            margin-bottom: 24px;
            max-width: 400px;
            margin-left: auto;
            margin-right: auto;
        }

        .upload-dropzone {
            border: 2px dashed var(--color-border);
            border-radius: 12px;
            padding: 40px 20px;
            margin-bottom: 20px;
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .upload-dropzone:hover,
        .upload-dropzone.dragover {
            border-color: var(--color-linkedin);
            background: rgba(0, 119, 181, 0.05);
        }

        .upload-dropzone input {
            display: none;
        }

        .upload-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 12px 24px;
            background: var(--color-linkedin);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .upload-btn:hover {
            background: #006097;
            transform: translateY(-1px);
        }

        .upload-hint {
            color: var(--color-text-secondary);
            font-size: 0.8rem;
            margin-top: 16px;
        }

        /* Score Section */
        .score-header {
            display: flex;
            align-items: center;
            gap: 24px;
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: 16px;
            padding: 28px;
            margin-bottom: 24px;
        }

        .score-circle {
            width: 90px;
            height: 90px;
            border-radius: 50%;
            background: conic-gradient(var(--color-linkedin) calc(var(--score) * 3.6deg), var(--color-surface-elevated) 0deg);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            flex-shrink: 0;
        }

        .score-circle::before {
            content: '';
            position: absolute;
            width: 72px;
            height: 72px;
            border-radius: 50%;
            background: var(--color-surface);
        }

        .score-value {
            position: relative;
            z-index: 1;
            font-size: 1.6rem;
            font-weight: 600;
            color: var(--color-linkedin);
        }

        .score-info h2 {
            font-family: var(--font-display);
            font-size: 1.4rem;
            font-weight: 400;
            margin-bottom: 6px;
        }

        .score-summary {
            color: var(--color-text-secondary);
            font-size: 0.95rem;
        }

        /* Fix Sections */
        .fix-section {
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: 16px;
            margin-bottom: 16px;
            overflow: hidden;
        }

        .fix-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 24px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .fix-header:hover {
            background: var(--color-surface-elevated);
        }

        .fix-header-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .fix-title {
            font-size: 1.05rem;
            font-weight: 600;
        }

        .fix-count {
            background: var(--color-error);
            color: #000;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .fix-count.success {
            background: var(--color-success);
        }

        .fix-count.warning {
            background: var(--color-warning);
        }

        .fix-chevron {
            transition: transform 0.2s;
            color: var(--color-text-secondary);
        }

        .fix-section.expanded .fix-chevron {
            transform: rotate(180deg);
        }

        .fix-content {
            display: none;
            padding: 0 24px 24px;
            border-top: 1px solid var(--color-border);
        }

        .fix-section.expanded .fix-content {
            display: block;
        }

        .fix-item {
            background: var(--color-surface-elevated);
            border-radius: 12px;
            padding: 16px;
            margin-top: 16px;
        }

        .fix-item-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
        }

        .fix-item-title {
            font-weight: 600;
            font-size: 0.95rem;
        }

        .fix-item-severity {
            font-size: 0.75rem;
            padding: 2px 8px;
            border-radius: 4px;
            font-weight: 600;
        }

        .fix-item-severity.critical {
            background: rgba(248, 113, 113, 0.2);
            color: var(--color-error);
        }

        .fix-item-severity.high {
            background: rgba(251, 191, 36, 0.2);
            color: var(--color-warning);
        }

        .fix-item-description {
            color: var(--color-text-secondary);
            font-size: 0.9rem;
        }

        /* Optimization Sections */
        .optimization-section {
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 16px;
        }

        .optimization-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .optimization-title {
            font-family: var(--font-display);
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .copy-btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 14px;
            background: var(--color-surface-elevated);
            border: 1px solid var(--color-border);
            border-radius: 6px;
            color: var(--color-text-secondary);
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .copy-btn:hover {
            background: var(--color-accent-muted);
            border-color: var(--color-accent);
            color: var(--color-accent);
        }

        .copy-btn.copied {
            background: rgba(74, 222, 128, 0.15);
            border-color: var(--color-success);
            color: var(--color-success);
        }

        .optimization-content {
            background: var(--color-surface-elevated);
            border-radius: 8px;
            padding: 16px;
            font-size: 0.95rem;
            line-height: 1.7;
            white-space: pre-wrap;
        }

        .optimization-why {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid var(--color-border);
            color: var(--color-text-secondary);
            font-size: 0.85rem;
        }

        .optimization-why strong {
            color: var(--color-accent);
        }

        /* Skills Grid */
        .skills-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .skill-tag {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: var(--color-surface-elevated);
            border-radius: 6px;
            font-size: 0.85rem;
        }

        .skill-tag.add {
            background: rgba(74, 222, 128, 0.15);
            color: var(--color-success);
        }

        .skill-tag.remove {
            background: rgba(248, 113, 113, 0.15);
            color: var(--color-error);
            text-decoration: line-through;
        }

        /* Issue-Driven Optimization Styles */
        .optimization-intro {
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-left: 4px solid var(--color-accent);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 24px;
        }

        .optimization-intro h3 {
            font-family: var(--font-display);
            font-size: 1.2rem;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .optimization-intro p {
            color: var(--color-text-secondary);
            font-size: 0.95rem;
            line-height: 1.6;
        }

        .issue-count-badge {
            background: var(--color-error);
            color: #000;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
            font-family: var(--font-body);
        }

        .issue-count-badge.warning {
            background: var(--color-warning);
        }

        .issue-count-badge.success {
            background: var(--color-success);
        }

        /* Fixes These Issues Badge */
        .fixes-issues {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-bottom: 16px;
        }

        .fixes-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            background: rgba(248, 113, 113, 0.15);
            border: 1px solid rgba(248, 113, 113, 0.3);
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--color-error);
        }

        .fixes-badge.high {
            background: rgba(251, 191, 36, 0.15);
            border-color: rgba(251, 191, 36, 0.3);
            color: var(--color-warning);
        }

        .fixes-badge.medium {
            background: rgba(34, 211, 238, 0.15);
            border-color: rgba(34, 211, 238, 0.3);
            color: var(--color-accent);
        }

        .fixes-badge.gap {
            background: rgba(251, 191, 36, 0.2);
            border-color: rgba(251, 191, 36, 0.4);
            color: var(--color-warning);
        }

        /* Current vs Optimized Comparison */
        .comparison-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-bottom: 16px;
        }

        @media (max-width: 700px) {
            .comparison-container {
                grid-template-columns: 1fr;
            }
        }

        .comparison-box {
            border-radius: 8px;
            padding: 16px;
        }

        .comparison-box.current {
            background: rgba(248, 113, 113, 0.08);
            border: 1px solid rgba(248, 113, 113, 0.2);
        }

        .comparison-box.optimized {
            background: rgba(74, 222, 128, 0.08);
            border: 1px solid rgba(74, 222, 128, 0.2);
        }

        .comparison-label {
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .comparison-box.current .comparison-label {
            color: var(--color-error);
        }

        .comparison-box.optimized .comparison-label {
            color: var(--color-success);
        }

        .comparison-text {
            font-size: 0.95rem;
            line-height: 1.6;
            white-space: pre-wrap;
        }

        /* Optimization Priority Indicator */
        .priority-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 16px;
            background: var(--color-surface-elevated);
            border-radius: 8px;
            margin-bottom: 16px;
        }

        .priority-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .priority-dot.critical { background: var(--color-error); }
        .priority-dot.high { background: var(--color-warning); }
        .priority-dot.medium { background: var(--color-accent); }

        .priority-text {
            font-size: 0.85rem;
            color: var(--color-text-secondary);
        }

        .priority-text strong {
            color: var(--color-text);
        }

        /* Improvement Checklist */
        .improvement-checklist {
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid var(--color-border);
        }

        .improvement-checklist h4 {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--color-text-secondary);
            margin-bottom: 12px;
        }

        .checklist-item {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            padding: 8px 0;
            font-size: 0.9rem;
            color: var(--color-text);
        }

        .checklist-icon {
            flex-shrink: 0;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
        }

        .checklist-icon.pending {
            background: rgba(251, 191, 36, 0.2);
            color: var(--color-warning);
        }

        .checklist-icon.included {
            background: rgba(74, 222, 128, 0.2);
            color: var(--color-success);
        }

        /* Score Impact Preview */
        .score-impact {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            background: rgba(74, 222, 128, 0.1);
            border: 1px solid rgba(74, 222, 128, 0.2);
            border-radius: 8px;
            margin-top: 16px;
        }

        .score-impact-icon {
            font-size: 1.2rem;
        }

        .score-impact-text {
            font-size: 0.9rem;
            color: var(--color-success);
        }

        .score-impact-text strong {
            color: var(--color-success);
        }

        /* No Issues State */
        .no-issues-state {
            text-align: center;
            padding: 40px 20px;
            background: rgba(74, 222, 128, 0.08);
            border: 1px solid rgba(74, 222, 128, 0.2);
            border-radius: 16px;
        }

        .no-issues-state .icon {
            font-size: 3rem;
            margin-bottom: 16px;
        }

        .no-issues-state h3 {
            font-family: var(--font-display);
            font-size: 1.3rem;
            color: var(--color-success);
            margin-bottom: 8px;
        }

        .no-issues-state p {
            color: var(--color-text-secondary);
            font-size: 0.95rem;
        }

        /* CTA Section */
        .cta-section {
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: 16px;
            padding: 32px;
            text-align: center;
            margin-top: 32px;
        }

        .cta-section h3 {
            font-family: var(--font-display);
            font-size: 1.3rem;
            margin-bottom: 8px;
        }

        .cta-section p {
            color: var(--color-text-secondary);
            margin-bottom: 20px;
        }

        .btn-primary {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 14px 28px;
            background: var(--color-accent);
            color: #000;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            text-decoration: none;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(34, 211, 238, 0.25);
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--color-text-secondary);
        }

        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        /* Loading */
        .loading-spinner {
            border: 3px solid var(--color-surface-elevated);
            border-top: 3px solid var(--color-linkedin);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Responsive */
        @media (max-width: 600px) {
            .score-header {
                flex-direction: column;
                text-align: center;
            }

            .tabs {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/supabase-client.js"></script>
</head>
<body>
    <div class="container">
        <!-- Job Fit Warning Banner -->
        <div id="jobFitWarningBanner" class="job-fit-warning-banner" style="display: none;">
            <div class="warning-icon">‚ö†Ô∏è</div>
            <div class="warning-content">
                <strong id="warningTitle">HenryHQ Guidance</strong>
                <p id="warningMessage"></p>
            </div>
        </div>

        <h1>LinkedIn Profile Readiness</h1>
        <p class="subtitle" style="max-width: 700px; line-height: 1.6;">
            Recruiters use LinkedIn to find candidates. Hiring managers use LinkedIn to validate scope, seniority, and credibility before interviews.
            This score measures how well your profile holds up in both contexts‚Äîstrong enough that any hiring manager reviewing it for an adjacent role says "this person makes sense."
        </p>

        <!-- Tabs -->
        <div class="tabs">
            <button class="tab active" onclick="switchTab('scoring')">Profile Score</button>
            <button class="tab" onclick="switchTab('optimization')">Optimization</button>
        </div>

        <!-- Scoring Tab -->
        <div id="scoringTab" class="tab-content active">
            <!-- Upload Section (shown when no LinkedIn data) -->
            <div id="uploadSection" class="upload-section">
                <div class="upload-icon">üíº</div>
                <h2 class="upload-title">Upload Your LinkedIn Profile</h2>
                <p class="upload-description">
                    Export your LinkedIn profile as a PDF and upload it here to get a recruiter-visibility score and personalized optimization recommendations.
                </p>
                <div class="upload-dropzone" id="dropzone">
                    <input type="file" id="linkedinFile" accept=".pdf">
                    <button class="upload-btn" onclick="document.getElementById('linkedinFile').click()">
                        <span>+</span> Upload LinkedIn PDF
                    </button>
                </div>
                <p class="upload-hint">
                    To export: Go to your LinkedIn profile &rarr; More &rarr; Save to PDF
                </p>
            </div>

            <!-- Score Section (shown after upload) -->
            <div id="scoreSection" style="display: none;">
                <!-- How Hiring Teams Use LinkedIn Section -->
                <div class="how-recruiters-search collapsed" id="howRecruitersSearch">
                    <div class="how-recruiters-header" onclick="toggleHowRecruitersSearch()">
                        <span class="how-recruiters-title">How Hiring Teams Use LinkedIn</span>
                        <span class="how-recruiters-chevron">‚ñº</span>
                    </div>
                    <div class="how-recruiters-content">
                        <p><strong>Recruiters use LinkedIn to find you.</strong> They search by keywords (e.g., "product manager fintech") and scan the first 20 results. Your score reflects how likely you are to appear in that search and get clicked.</p>
                        <p style="margin-top: 12px;"><strong>Hiring managers use LinkedIn to validate you.</strong> Once your resume is shared, they review your profile to validate scope and seniority, sense-check credibility, and confirm the story matches. Your score reflects how confidently your profile supports that review.</p>
                        <div class="three-second-test">
                            <h4>The 3-Second Test</h4>
                            <p style="font-size: 0.85rem; color: var(--color-text-secondary); margin-bottom: 8px;">Both recruiters and hiring managers skim profiles quickly. In 3 seconds, they look for:</p>
                            <ol>
                                <li><strong>Headline:</strong> Does this person do what I'm hiring for?</li>
                                <li><strong>Experience:</strong> Do I recognize these companies? Does the scope match?</li>
                                <li><strong>Recency:</strong> Is this profile active or stale?</li>
                            </ol>
                        </div>
                        <p style="margin-top: 12px;">If you pass the 3-second test, they read your About section and skim your bullets. <strong>This score predicts visibility + confidence, not hiring outcomes.</strong></p>
                    </div>
                </div>

                <div class="score-header">
                    <div class="score-circle" id="scoreCircle" style="--score: 0">
                        <span class="score-value" id="scoreValue">--</span>
                    </div>
                    <div class="score-info">
                        <h2 id="scoreTitle">Analyzing...</h2>
                        <p class="score-summary" id="scoreSummary">Evaluating your LinkedIn profile against recruiter search patterns.</p>
                    </div>
                </div>

                <!-- What This Score Means Section -->
                <div class="score-context" id="scoreContextSection">
                    <h4 class="score-context-title">What This Score Means</h4>
                    <p class="score-context-text" id="scoreContextText">‚Äî</p>
                    <p class="score-context-encouragement" id="scoreContextEncouragement"></p>
                </div>

                <!-- Profile Gaps Section -->
                <div class="profile-gaps-section" id="profileGapsSection" style="display: none;">
                    <h3 class="profile-gaps-header">What's Missing From Your Profile</h3>
                    <p class="profile-gaps-intro" id="profileGapsIntro">Your profile has gaps that are limiting recruiter engagement:</p>
                    <div id="profileGapsList"></div>
                </div>

                <!-- Section Cards -->
                <div class="section-cards" id="sectionCards"></div>

                <!-- Fix Sections -->
                <div id="fixSections"></div>

                <!-- CTA -->
                <div class="cta-section">
                    <h3>Ready to optimize?</h3>
                    <p>See specific recommendations for your headline, summary, and skills.</p>
                    <button class="btn-primary" onclick="switchTab('optimization')">
                        View Optimization Recommendations &rarr;
                    </button>
                </div>

                <!-- Upload Updated Profile -->
                <div class="update-profile-section" style="margin-top: 32px; padding-top: 24px; border-top: 1px solid rgba(255,255,255,0.1); text-align: center;">
                    <p style="color: var(--color-text-secondary); font-size: 0.9rem; margin-bottom: 12px;">
                        Made changes to your LinkedIn? Upload your updated profile to see your new score.
                    </p>
                    <button class="btn-secondary" onclick="showUploadSection()" style="background: transparent; border: 1px solid var(--color-accent); color: var(--color-accent); padding: 10px 20px; border-radius: 8px; cursor: pointer; font-size: 0.9rem;">
                        Upload Updated Profile
                    </button>
                </div>
            </div>
        </div>

        <!-- Optimization Tab -->
        <div id="optimizationTab" class="tab-content">
            <div id="optimizationContent">
                <div class="empty-state" id="optimizationEmpty">
                    <div class="empty-state-icon">üíº</div>
                    <p>Upload your LinkedIn profile in the Profile Score tab to get personalized optimization recommendations.</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = window.location.hostname === 'localhost' ? 'http://localhost:8000' : 'https://henryai-app-production.up.railway.app';

        let linkedinData = null;
        let scoringResults = null;
        let analysisData = null;

        // Section configuration with weights and scoring criteria
        // Aligned with linkedin_scoring_spec.md v1.1
        const SECTION_CONFIG = {
            headline: {
                name: 'Headline',
                icon: 'üìå',
                weight: 0.15,
                maxPoints: 15,
                criteria: [
                    { key: 'notDefault', label: 'Not default template', points: 3 },
                    { key: 'role', label: 'Includes function/role', points: 4 },
                    { key: 'specialization', label: 'Includes specialization', points: 3 },
                    { key: 'length', label: 'Uses full 220 characters', points: 2 },
                    { key: 'credentials', label: 'Includes company/credentials', points: 3 }
                ]
            },
            about: {
                name: 'About Section',
                icon: 'üìù',
                weight: 0.20,
                maxPoints: 20,
                criteria: [
                    { key: 'exists', label: 'Exists and >100 words', points: 5 },
                    { key: 'length', label: '300-800 words (ideal)', points: 3 },
                    { key: 'firstPerson', label: 'First-person voice', points: 2 },
                    { key: 'metrics', label: 'Quantified achievements', points: 5 },
                    { key: 'specialization', label: 'Clear specialization', points: 3 },
                    { key: 'noBuzzwords', label: 'No generic buzzwords', points: 2 }
                ]
            },
            experience: {
                name: 'Experience',
                icon: 'üíº',
                weight: 0.20,
                maxPoints: 20,
                criteria: [
                    { key: 'hasBullets', label: 'All roles have 3+ bullets', points: 5 },
                    { key: 'parFormat', label: 'Bullets use PAR format', points: 5 },
                    { key: 'metrics', label: 'Quantified outcomes (50%+)', points: 5 },
                    { key: 'currentDetailed', label: 'Most recent role detailed', points: 3 },
                    { key: 'companyUrls', label: 'Company URLs included', points: 2 }
                ]
            },
            skills: {
                name: 'Skills',
                icon: 'üéØ',
                weight: 0.15,
                maxPoints: 15,
                criteria: [
                    { key: 'count', label: 'Has 10+ skills', points: 3 },
                    { key: 'functionSpecific', label: 'Function-specific skills', points: 4 },
                    { key: 'toolSpecific', label: 'Tool-specific skills', points: 3 },
                    { key: 'topThree', label: 'Top 3 are relevant', points: 3 },
                    { key: 'resumeMatch', label: 'Skills match resume', points: 2 }
                ]
            },
            freshness: {
                name: 'Freshness',
                icon: 'üïê',
                weight: 0.10,
                maxPoints: 10,
                criteria: [
                    { key: 'recentUpdate', label: 'Updated in last 30 days', points: 3 },
                    { key: 'recentActivity', label: 'Activity in last 30 days', points: 3 },
                    { key: 'currentRole', label: 'Current role is present', points: 2 },
                    { key: 'photoRecent', label: 'Photo updated (<2 years)', points: 2 }
                ]
            },
            resumeAlignment: {
                name: 'Resume Alignment',
                icon: 'üìÑ',
                weight: 0.10,
                maxPoints: 10,
                criteria: [
                    { key: 'titlesMatch', label: 'Job titles consistent', points: 3 },
                    { key: 'companiesMatch', label: 'Company names match', points: 3 },
                    { key: 'datesMatch', label: 'Date ranges consistent', points: 2 },
                    { key: 'noGaps', label: 'No unexplained gaps', points: 2 }
                ]
            },
            credibility: {
                name: 'Credibility',
                icon: '‚ú®',
                weight: 0.05,
                maxPoints: 5,
                criteria: [
                    { key: 'companyUrls', label: 'Company URLs exist', points: 2 },
                    { key: 'professionalPhoto', label: 'Professional photo', points: 2 },
                    { key: 'nobrokenLinks', label: 'No broken links', points: 1 }
                ]
            },
            other: {
                name: 'Other Signals',
                icon: 'üìö',
                weight: 0.05,
                maxPoints: 5,
                criteria: [
                    { key: 'education', label: 'Education listed', points: 2 },
                    { key: 'recommendations', label: 'Has recommendations', points: 2 },
                    { key: 'certifications', label: 'Certifications/volunteer', points: 1 }
                ]
            }
        };

        // Severity levels for fixes
        const SEVERITY = {
            CRITICAL: { label: 'Critical', class: 'critical', order: 1 },
            HIGH: { label: 'High', class: 'high', order: 2 },
            MEDIUM: { label: 'Medium', class: 'medium', order: 3 },
            LOW: { label: 'Low', class: 'low', order: 4 }
        };

        // Animate score from start to end value
        function animateScore(start, end, duration, scoreElement, circleElement) {
            const startTime = performance.now();
            const easeOut = t => 1 - Math.pow(1 - t, 3); // Cubic ease-out

            function update(currentTime) {
                const elapsed = currentTime - startTime;
                const progress = Math.min(elapsed / duration, 1);
                const easedProgress = easeOut(progress);
                const currentValue = Math.round(start + (end - start) * easedProgress);

                scoreElement.textContent = currentValue;

                // Update circle gradient
                const color = currentValue >= 80 ? 'var(--color-success)' :
                              currentValue >= 60 ? 'var(--color-warning)' : 'var(--color-error)';
                circleElement.style.background = `conic-gradient(${color} ${currentValue * 3.6}deg, var(--color-surface-elevated) 0deg)`;

                if (progress < 1) {
                    requestAnimationFrame(update);
                }
            }

            requestAnimationFrame(update);
        }

        // Toggle How Recruiters Search section
        function toggleHowRecruitersSearch() {
            const section = document.getElementById('howRecruitersSearch');
            section.classList.toggle('collapsed');
            sessionStorage.setItem('howRecruitersCollapsed', section.classList.contains('collapsed'));
        }

        // Initialize How Recruiters Search section (expand on first visit)
        function initHowRecruitersSection() {
            const hasSeenScore = sessionStorage.getItem('hasSeenLinkedInScore');
            const userPref = sessionStorage.getItem('howRecruitersCollapsed');

            if (!hasSeenScore) {
                document.getElementById('howRecruitersSearch').classList.remove('collapsed');
                sessionStorage.setItem('hasSeenLinkedInScore', 'true');
            } else if (userPref === 'false') {
                document.getElementById('howRecruitersSearch').classList.remove('collapsed');
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            // Get analysis data for job context
            analysisData = JSON.parse(sessionStorage.getItem('analysisData') || '{}');

            // Check Job Fit Warning
            checkAndDisplayJobFitWarning(analysisData);

            // Check if we have existing LinkedIn data - check localStorage first (persistent), then sessionStorage
            const persistedLinkedinData = localStorage.getItem('linkedinProfileData');
            const storedLinkedinData = sessionStorage.getItem('linkedinData');
            const storedScoringResults = sessionStorage.getItem('linkedinScoringResults');

            // Also check user profile for LinkedIn data
            const userProfile = JSON.parse(localStorage.getItem('userProfile') || '{}');
            const profileLinkedinData = userProfile.linkedin_parsed;

            // Priority: sessionStorage > localStorage > userProfile
            if (storedLinkedinData) {
                linkedinData = JSON.parse(storedLinkedinData);
            } else if (persistedLinkedinData) {
                linkedinData = JSON.parse(persistedLinkedinData);
                // Sync to sessionStorage for consistency
                sessionStorage.setItem('linkedinData', persistedLinkedinData);
            } else if (profileLinkedinData) {
                linkedinData = profileLinkedinData;
                // Sync to storage
                sessionStorage.setItem('linkedinData', JSON.stringify(profileLinkedinData));
                localStorage.setItem('linkedinProfileData', JSON.stringify(profileLinkedinData));
            }

            if (storedScoringResults) {
                scoringResults = JSON.parse(storedScoringResults);
            }

            // If we have data, show scores
            if (linkedinData && scoringResults) {
                showScoreSection();
                displayScoringResults(scoringResults);
                renderOptimizations();
            } else if (linkedinData) {
                // Have LinkedIn data but no scores - calculate them
                showScoreSection();
                const result = calculateDetailedScore(linkedinData, analysisData);
                scoringResults = result;
                sessionStorage.setItem('linkedinScoringResults', JSON.stringify(result));
                displayScoringResults(result);
                renderOptimizations();
            }

            // Setup file upload handlers
            setupUploadHandlers();
        });

        /**
         * Display Job Fit warning banner
         */
        function checkAndDisplayJobFitWarning(analysisData) {
            const banner = document.getElementById('jobFitWarningBanner');
            const title = document.getElementById('warningTitle');
            const message = document.getElementById('warningMessage');

            if (!banner) return;

            const recommendation = (analysisData.recommendation || '').toLowerCase();
            const lockedReason = analysisData.experience_analysis?.locked_reason ||
                                 analysisData.locked_reason || '';
            const proceededDespiteGuidance = sessionStorage.getItem('proceeded_despite_guidance') === 'true';
            const targetRole = analysisData.role_title || 'this role';

            // Check for "Do Not Apply" recommendation
            if (recommendation === 'do not apply' || recommendation === 'skip') {
                banner.style.display = 'flex';

                if (proceededDespiteGuidance) {
                    banner.classList.add('proceeded');
                    title.textContent = 'You Chose to Proceed';
                    message.textContent = `You acknowledged HenryHQ's guidance against applying to "${targetRole}" and chose to proceed. ` +
                        `We recommend focusing your energy on higher-fit roles. ` +
                        (lockedReason ? `Original guidance: ${lockedReason}` : '');
                } else {
                    banner.classList.remove('proceeded', 'caution');
                    title.textContent = 'Not Recommended for This Role';
                    message.textContent = lockedReason ||
                        `HenryHQ recommends "Do Not Apply" for "${targetRole}". ` +
                        `Your profile is optimized for roles that match your experience. ` +
                        `Focus on higher-fit opportunities instead.`;
                }
            }
            // Check for "Apply with Caution" recommendation
            else if (recommendation === 'apply with caution' || recommendation === 'conditional apply') {
                banner.style.display = 'flex';
                banner.classList.add('caution');
                title.textContent = 'Apply with Strategic Positioning';
                message.textContent = `This is a stretch role. Focus your LinkedIn optimization on emphasizing your strongest alignment points. ` +
                    (lockedReason ? `Key consideration: ${lockedReason}` : '');
            }
            // Good fit - hide banner
            else {
                banner.style.display = 'none';
            }
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

            if (tabName === 'scoring') {
                document.querySelector('.tab:nth-child(1)').classList.add('active');
                document.getElementById('scoringTab').classList.add('active');
            } else if (tabName === 'optimization') {
                document.querySelector('.tab:nth-child(2)').classList.add('active');
                document.getElementById('optimizationTab').classList.add('active');
            }
        }

        function setupUploadHandlers() {
            const dropzone = document.getElementById('dropzone');
            const fileInput = document.getElementById('linkedinFile');

            // Drag and drop
            dropzone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropzone.classList.add('dragover');
            });

            dropzone.addEventListener('dragleave', () => {
                dropzone.classList.remove('dragover');
            });

            dropzone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropzone.classList.remove('dragover');
                const file = e.dataTransfer.files[0];
                if (file && file.type === 'application/pdf') {
                    handleFileUpload(file);
                }
            });

            // File input
            fileInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    handleFileUpload(file);
                }
            });
        }

        async function handleFileUpload(file) {
            // Show loading state
            document.getElementById('uploadSection').innerHTML = `
                <div class="loading-spinner"></div>
                <p style="color: var(--color-text-secondary);">Analyzing your LinkedIn profile...</p>
            `;

            try {
                const formData = new FormData();
                formData.append('file', file);

                // Parse LinkedIn PDF via upload endpoint
                const parseResponse = await fetch(`${API_BASE}/api/linkedin/upload`, {
                    method: 'POST',
                    body: formData
                });

                if (!parseResponse.ok) {
                    throw new Error('Failed to parse LinkedIn PDF');
                }

                linkedinData = await parseResponse.json();

                // Persist to sessionStorage and localStorage
                sessionStorage.setItem('linkedinData', JSON.stringify(linkedinData));
                localStorage.setItem('linkedinProfileData', JSON.stringify(linkedinData));

                // Save to user profile
                saveLinkedInToProfile(linkedinData);

                // Calculate detailed score locally
                const result = calculateDetailedScore(linkedinData, analysisData);
                scoringResults = result;
                sessionStorage.setItem('linkedinScoringResults', JSON.stringify(result));

                showScoreSection();
                displayScoringResults(result);
                renderOptimizations();

            } catch (error) {
                console.error('Upload error:', error);
                document.getElementById('uploadSection').innerHTML = `
                    <div class="upload-icon">‚ö†Ô∏è</div>
                    <h2 class="upload-title">Upload Failed</h2>
                    <p class="upload-description">${error.message}</p>
                    <button class="upload-btn" onclick="location.reload()">Try Again</button>
                `;
            }
        }

        function showScoreSection() {
            document.getElementById('uploadSection').style.display = 'none';
            document.getElementById('scoreSection').style.display = 'block';
            const optimizationEmpty = document.getElementById('optimizationEmpty');
            if (optimizationEmpty) {
                optimizationEmpty.style.display = 'none';
            }
        }

        function showUploadSection() {
            // Reset the upload section HTML
            document.getElementById('uploadSection').innerHTML = `
                <div class="upload-icon">üíº</div>
                <h2 class="upload-title">Upload Updated LinkedIn Profile</h2>
                <p class="upload-description">
                    Upload your updated profile to see your new score and track your improvement.
                </p>
                <div class="upload-dropzone" id="dropzone">
                    <input type="file" id="linkedinFile" accept=".pdf">
                    <button class="upload-btn" onclick="document.getElementById('linkedinFile').click()">
                        <span>+</span> Upload LinkedIn PDF
                    </button>
                </div>
                <p class="upload-hint">
                    To export: Go to your LinkedIn profile &rarr; More &rarr; Save to PDF
                </p>
            `;
            document.getElementById('uploadSection').style.display = 'block';
            document.getElementById('scoreSection').style.display = 'none';

            // Re-setup upload handlers for the new elements
            setupUploadHandlers();
        }

        async function saveLinkedInToProfile(linkedinData) {
            try {
                // Update local userProfile
                const userProfile = JSON.parse(localStorage.getItem('userProfile') || '{}');
                userProfile.linkedin_parsed = linkedinData;
                userProfile.linkedin_profile_uploaded = true;
                userProfile.linkedin_last_updated = new Date().toISOString();
                localStorage.setItem('userProfile', JSON.stringify(userProfile));

                // Sync to Supabase if available
                if (typeof supabase !== 'undefined' && userProfile.id) {
                    const { error } = await supabase
                        .from('user_profiles')
                        .update({
                            linkedin_parsed: linkedinData,
                            linkedin_profile_uploaded: true,
                            linkedin_last_updated: new Date().toISOString()
                        })
                        .eq('id', userProfile.id);

                    if (error) {
                        console.error('Error saving LinkedIn to Supabase:', error);
                    } else {
                        console.log('LinkedIn profile saved to Supabase');
                    }
                }
            } catch (e) {
                console.error('Error saving LinkedIn profile:', e);
            }
        }

        // ============ COMPREHENSIVE SCORING LOGIC ============
        // Aligned with linkedin_scoring_spec.md v1.1
        // This score predicts recruiter click and message likelihood, not hiring outcomes.
        function calculateDetailedScore(linkedin, analysis) {
            const sectionScores = {};
            const sectionDetails = {};
            const fixes = [];
            const resume = JSON.parse(localStorage.getItem('lastResumeAnalysis') || '{}');

            // ============ HEADLINE SCORING (15 pts) ============
            const headline = linkedin.headline || '';
            const headlineCriteria = {};

            // Default template detection (3 pts)
            const defaultTemplates = /^(looking for|seeking|open to|student at|aspiring|passionate about)/i;
            const isDefault = defaultTemplates.test(headline) || headline.length === 0;
            headlineCriteria.notDefault = isDefault ? 0 : 3;
            if (isDefault) {
                fixes.push({
                    severity: 'CRITICAL',
                    section: 'Headline',
                    problem: 'Your headline uses a default or generic template',
                    why: 'Recruiters see your headline in every search result. Default templates like "Looking for opportunities" don\'t tell them what you do, so they skip your profile.',
                    fix: 'Use this formula: [Seniority] [Function] | [Specialization] | [Credentials/Companies]. Example: "Senior Product Manager | B2B SaaS Growth | Ex-Stripe"'
                });
            }

            // Includes function/role (4 pts)
            const hasRole = /\b(manager|director|lead|senior|staff|principal|engineer|developer|analyst|specialist|consultant|head|vp|chief|founder|ceo|cto|cfo|recruiter|designer|architect)\b/i.test(headline);
            headlineCriteria.role = hasRole ? 4 : 0;
            if (!hasRole && headline.length > 0) {
                fixes.push({
                    severity: 'CRITICAL',
                    section: 'Headline',
                    problem: 'No clear job function in your headline',
                    why: 'Recruiters search by title. "Product Manager" is searchable. "Builder of great products" is not.',
                    fix: 'Lead with your target role: "Senior Product Manager" or "Staff Software Engineer"'
                });
            }

            // Includes specialization (3 pts)
            const hasSpecialization = /\b(saas|b2b|b2c|fintech|healthcare|enterprise|growth|platform|infrastructure|mobile|web|data|cloud|ai|ml|devops|frontend|backend|fullstack|payments|e-commerce|edtech|healthtech)\b/i.test(headline);
            headlineCriteria.specialization = hasSpecialization ? 3 : 0;
            if (!hasSpecialization && headline.length > 0) {
                fixes.push({
                    severity: 'HIGH',
                    section: 'Headline',
                    problem: 'No specialization in your headline',
                    why: 'Recruiters search "product manager fintech" not just "product manager". Specialization makes you findable.',
                    fix: 'Add your niche: B2B SaaS, Fintech, Healthcare Tech, Growth, Platform, etc.'
                });
            }

            // Uses full 220 characters (2 pts)
            if (headline.length >= 180) {
                headlineCriteria.length = 2;
            } else if (headline.length >= 100) {
                headlineCriteria.length = 1;
            } else {
                headlineCriteria.length = 0;
                if (headline.length > 0 && headline.length < 100) {
                    fixes.push({
                        severity: 'MEDIUM',
                        section: 'Headline',
                        problem: `Your headline is only ${headline.length} characters (220 max)`,
                        why: 'Longer headlines = more keywords = higher search ranking. You\'re leaving space unused.',
                        fix: 'Expand to include: role, specialization, key achievement, or notable companies'
                    });
                }
            }

            // Includes company/credentials (3 pts)
            const hasCredentials = /\b(ex-|former|@|mba|phd|cpa|pmp|cspo|aws|google|meta|amazon|microsoft|netflix|apple|stripe|airbnb|uber|salesforce)\b/i.test(headline);
            headlineCriteria.credentials = hasCredentials ? 3 : 0;

            // Red flag penalties
            const allCapsOrLower = headline === headline.toUpperCase() || headline === headline.toLowerCase();
            if (allCapsOrLower && headline.length > 20) {
                headlineCriteria.notDefault = Math.max(0, (headlineCriteria.notDefault || 0) - 2);
            }
            const hasEmoji = /[\u{1F300}-\u{1F9FF}]/u.test(headline);
            if (hasEmoji) {
                headlineCriteria.notDefault = Math.max(0, (headlineCriteria.notDefault || 0) - 1);
            }

            sectionScores.headline = Object.values(headlineCriteria).reduce((a, b) => a + b, 0);
            sectionDetails.headline = headlineCriteria;

            // ============ ABOUT SECTION SCORING (20 pts) ============
            const about = linkedin.summary || linkedin.about || '';
            const aboutCriteria = {};
            const wordCount = about.split(/\s+/).filter(w => w.length > 0).length;

            // Exists and >100 words (5 pts)
            if (wordCount >= 100) {
                aboutCriteria.exists = 5;
            } else if (wordCount > 0) {
                aboutCriteria.exists = 2;
            } else {
                aboutCriteria.exists = 0;
                fixes.push({
                    severity: 'CRITICAL',
                    section: 'About',
                    problem: 'No About section',
                    why: 'The About section is prime real estate for keywords and showing personality. Without it, you\'re invisible to searches.',
                    fix: 'Write 300-800 words covering: Hook ‚Üí Career narrative ‚Üí Expertise ‚Üí What you\'re looking for'
                });
            }

            // 300-800 words ideal length (3 pts)
            if (wordCount >= 300 && wordCount <= 800) {
                aboutCriteria.length = 3;
            } else if (wordCount >= 150 && wordCount < 300) {
                aboutCriteria.length = 1;
            } else if (wordCount > 800 && wordCount <= 1200) {
                aboutCriteria.length = 2; // Slightly long but OK
            } else if (wordCount > 1200) {
                aboutCriteria.length = 0; // Too long penalty
                fixes.push({
                    severity: 'MEDIUM',
                    section: 'About',
                    problem: `About section is ${wordCount} words (recommended: 300-800)`,
                    why: 'Very long About sections become walls of text. Recruiters won\'t read past the first 3 lines.',
                    fix: 'Tighten to 300-800 words. Focus on what matters: expertise, key achievements, and what you\'re looking for.'
                });
            } else {
                aboutCriteria.length = 0;
                if (wordCount > 0 && wordCount < 100) {
                    fixes.push({
                        severity: 'HIGH',
                        section: 'About',
                        problem: `About section is only ${wordCount} words`,
                        why: 'A thin About section suggests low effort. More content = more keywords = more search matches.',
                        fix: 'Expand to 300-500 words. Include: your focus area, 2-3 quantified achievements, and what makes you different.'
                    });
                }
            }

            // First-person voice (2 pts)
            const firstPersonPattern = /^I\s|^I'm\s|^I've\s|^My\s/im;
            const thirdPersonPattern = new RegExp(`^${(linkedin.name || 'they').split(' ')[0]}\\s+(is|has|was|leads|manages)`, 'im');
            if (firstPersonPattern.test(about) && !thirdPersonPattern.test(about)) {
                aboutCriteria.firstPerson = 2;
            } else if (about.length > 0) {
                aboutCriteria.firstPerson = 0;
                if (thirdPersonPattern.test(about)) {
                    fixes.push({
                        severity: 'MEDIUM',
                        section: 'About',
                        problem: 'About section uses third-person voice',
                        why: '"I lead..." creates connection. "John leads..." feels like a press release.',
                        fix: 'Rewrite in first person: "I specialize in..." not "[Name] specializes in..."'
                    });
                }
            } else {
                aboutCriteria.firstPerson = 0;
            }

            // Quantified achievements (5 pts)
            const aboutHasMetrics = /\d+[%+]?|\$\d+[MBK]?|\d+x|\d+\s*(years?|hires?|people|team|clients?|projects?|million|billion|revenue|growth)/i.test(about);
            aboutCriteria.metrics = aboutHasMetrics ? 5 : 0;
            if (!aboutHasMetrics && about.length > 0) {
                fixes.push({
                    severity: 'HIGH',
                    section: 'About',
                    problem: 'No quantified achievements in About section',
                    why: 'Metrics prove impact. "Managed teams" is forgettable. "Managed 50-person team, drove $10M revenue" is memorable.',
                    fix: 'Add 3-5 metrics: team size, revenue impact, projects completed, years of experience, growth percentages'
                });
            }

            // Clear specialization (3 pts)
            const aboutHasSpecialization = /\b(specialize|focus|expert|known for|my area|i work on|my expertise)\b/i.test(about) ||
                /\b(saas|b2b|b2c|fintech|healthcare|enterprise|growth|platform|infrastructure)\b/i.test(about);
            aboutCriteria.specialization = aboutHasSpecialization ? 3 : 0;

            // No generic buzzwords (2 pts)
            const buzzwordMatches = about.match(/\b(passionate|driven|results-oriented|team player|self-starter|dynamic|motivated|enthusiastic|hardworking|dedicated|synergy|leverage|proactive)\b/gi) || [];
            if (buzzwordMatches.length === 0) {
                aboutCriteria.noBuzzwords = 2;
            } else if (buzzwordMatches.length <= 2) {
                aboutCriteria.noBuzzwords = 1;
            } else {
                aboutCriteria.noBuzzwords = 0;
                fixes.push({
                    severity: 'MEDIUM',
                    section: 'About',
                    problem: `About section contains ${buzzwordMatches.length} generic buzzwords`,
                    why: '"Passionate" and "driven" are invisible to recruiters - everyone uses them. They add no signal.',
                    fix: `Remove or replace: ${buzzwordMatches.slice(0, 3).join(', ')}. Use specifics instead.`
                });
            }

            sectionScores.about = Object.values(aboutCriteria).reduce((a, b) => a + b, 0);
            sectionDetails.about = aboutCriteria;

            // ============ EXPERIENCE SCORING (20 pts) ============
            const experience = linkedin.experience || [];
            const expCriteria = {};

            // All roles have 3+ bullets (5 pts)
            const rolesWithBullets = experience.filter(e => {
                const bullets = e.bullets || [];
                const descBullets = (e.description || '').split(/[‚Ä¢\-\*]|\n/).filter(b => b.trim().length > 10);
                return bullets.length >= 3 || descBullets.length >= 3;
            });
            if (experience.length === 0) {
                expCriteria.hasBullets = 0;
                fixes.push({
                    severity: 'CRITICAL',
                    section: 'Experience',
                    problem: 'No work experience listed',
                    why: 'Without experience, recruiters have nothing to evaluate. This is the most important section.',
                    fix: 'Add all relevant positions with 3-5 bullet points each'
                });
            } else if (rolesWithBullets.length === experience.length) {
                expCriteria.hasBullets = 5;
            } else if (rolesWithBullets.length >= experience.length / 2) {
                expCriteria.hasBullets = 3;
            } else {
                expCriteria.hasBullets = 0;
                fixes.push({
                    severity: 'HIGH',
                    section: 'Experience',
                    problem: 'Most roles lack detailed bullet points',
                    why: 'Recruiters need substance, not just titles. Each role should tell a story of impact.',
                    fix: 'Add 3-5 bullets per role. Each bullet: Action verb ‚Üí What you did ‚Üí Result/Impact'
                });
            }

            // Bullets use PAR format - Problem/Action/Result (5 pts)
            const parPatterns = /\b(led|drove|built|launched|increased|decreased|reduced|grew|saved|generated|achieved|delivered|managed|owned|created|designed|implemented|developed|established|transformed)\b/i;
            const resultPatterns = /\d+[%+]?|\$\d+|resulting in|leading to|which|saving|generating|achieving/i;
            const allBulletText = experience.map(e => e.description || (e.bullets ? e.bullets.join(' ') : '')).join(' ');
            const hasPARFormat = parPatterns.test(allBulletText) && resultPatterns.test(allBulletText);
            expCriteria.parFormat = hasPARFormat ? 5 : (parPatterns.test(allBulletText) ? 2 : 0);
            if (!hasPARFormat && experience.length > 0) {
                fixes.push({
                    severity: 'HIGH',
                    section: 'Experience',
                    problem: 'Experience bullets don\'t follow PAR format',
                    why: 'PAR (Problem/Action/Result) shows strategic thinking. "Managed team" vs "Led 12-person team to deliver $5M project on time."',
                    fix: 'Rewrite bullets: Start with action verb ‚Üí Describe what you did ‚Üí End with quantified result'
                });
            }

            // Quantified outcomes in 50%+ of bullets (5 pts)
            let totalBullets = 0;
            let quantifiedBullets = 0;
            experience.forEach(e => {
                const bullets = e.bullets || (e.description || '').split(/[‚Ä¢\-\*\n]/).filter(b => b.trim().length > 10);
                bullets.forEach(b => {
                    totalBullets++;
                    if (/\d+[%+]?|\$\d+[MBK]?|\d+x|\d+\s*(people|hires|team|revenue|growth|million|billion|users|customers)/i.test(b)) {
                        quantifiedBullets++;
                    }
                });
            });
            const quantifiedRatio = totalBullets > 0 ? quantifiedBullets / totalBullets : 0;
            if (quantifiedRatio >= 0.5) {
                expCriteria.metrics = 5;
            } else if (quantifiedRatio >= 0.25) {
                expCriteria.metrics = 3;
            } else {
                expCriteria.metrics = 0;
                if (experience.length > 0) {
                    fixes.push({
                        severity: 'HIGH',
                        section: 'Experience',
                        problem: `Only ${Math.round(quantifiedRatio * 100)}% of bullets have metrics (need 50%+)`,
                        why: '"Improved sales" means nothing. "Increased sales 40% ($2M ARR)" is a compelling proof point.',
                        fix: 'Add metrics to at least 50% of bullets: %, $, team size, time saved, revenue generated'
                    });
                }
            }

            // Most recent role is detailed (3 pts)
            const currentRole = experience[0];
            const currentBullets = currentRole?.bullets || [];
            const currentDesc = currentRole?.description || '';
            const currentDetailLevel = currentBullets.length + (currentDesc.split(/[‚Ä¢\-\*\n]/).filter(b => b.trim().length > 20).length);
            if (currentDetailLevel >= 4) {
                expCriteria.currentDetailed = 3;
            } else if (currentDetailLevel >= 2) {
                expCriteria.currentDetailed = 1;
            } else {
                expCriteria.currentDetailed = 0;
                if (experience.length > 0) {
                    fixes.push({
                        severity: 'HIGH',
                        section: 'Experience',
                        problem: 'Current role lacks detail',
                        why: 'Recruiters spend 80% of their time on your current role. A thin description signals low effort.',
                        fix: 'Expand to 4-6 bullet points. Each bullet should demonstrate scope, action, and measurable result.'
                    });
                }
            }

            // Company URLs included (2 pts) - We can't fully verify this from parsed data
            // Giving partial credit by default since LinkedIn usually includes company URLs
            expCriteria.companyUrls = experience.length > 0 ? 2 : 0;

            sectionScores.experience = Object.values(expCriteria).reduce((a, b) => a + b, 0);
            sectionDetails.experience = expCriteria;

            // ============ SKILLS SCORING (15 pts) ============
            const skills = linkedin.skills || [];
            const skillsCriteria = {};

            // Has 10+ skills (3 pts)
            if (skills.length >= 10) {
                skillsCriteria.count = 3;
            } else if (skills.length >= 5) {
                skillsCriteria.count = 1;
            } else {
                skillsCriteria.count = 0;
                fixes.push({
                    severity: 'HIGH',
                    section: 'Skills',
                    problem: `Only ${skills.length} skills listed (need 10+)`,
                    why: 'More skills = more search matches. LinkedIn recommends 10-50 skills for optimal visibility.',
                    fix: 'Add skills from job descriptions in your lane. Include tools, methodologies, and domain expertise.'
                });
            }

            // Function-specific skills (4 pts) - has role-related skills
            const functionSkills = /\b(product management|product strategy|software development|engineering|design|marketing|sales|recruiting|data analysis|project management|agile|scrum)\b/i;
            const hasFunctionSkills = skills.some(s => functionSkills.test(s));
            skillsCriteria.functionSpecific = hasFunctionSkills ? 4 : 0;
            if (!hasFunctionSkills && skills.length > 0) {
                fixes.push({
                    severity: 'HIGH',
                    section: 'Skills',
                    problem: 'No function-specific skills in your list',
                    why: 'Recruiters search "product management" or "software development". You need your core function represented.',
                    fix: 'Add your primary function as a skill: "Product Management", "Software Development", "Data Analysis", etc.'
                });
            }

            // Tool-specific skills (3 pts)
            const toolSkills = /\b(sql|python|javascript|java|figma|sketch|tableau|salesforce|hubspot|jira|confluence|aws|gcp|azure|react|node|kubernetes|docker|excel|powerbi)\b/i;
            const hasToolSkills = skills.some(s => toolSkills.test(s));
            skillsCriteria.toolSpecific = hasToolSkills ? 3 : 0;
            if (!hasToolSkills && skills.length > 0) {
                fixes.push({
                    severity: 'MEDIUM',
                    section: 'Skills',
                    problem: 'No tool-specific skills listed',
                    why: 'Concrete tools (SQL, Figma, Python) are highly searchable. They prove hands-on capability.',
                    fix: 'Add tools you actually use: SQL, Python, Figma, Jira, Salesforce, Tableau, etc.'
                });
            }

            // Top 3 are relevant (3 pts)
            const genericSkills = ['communication', 'leadership', 'teamwork', 'problem solving', 'microsoft office', 'time management', 'organization'];
            const topThreeGeneric = skills.slice(0, 3).filter(s =>
                genericSkills.some(g => s.toLowerCase().includes(g))
            ).length;
            skillsCriteria.topThree = topThreeGeneric === 0 ? 3 : (topThreeGeneric === 1 ? 2 : 0);
            if (topThreeGeneric >= 2) {
                fixes.push({
                    severity: 'MEDIUM',
                    section: 'Skills',
                    problem: 'Top 3 skills are too generic',
                    why: 'Your top 3 skills appear first in searches and on your profile. Generic skills like "Communication" don\'t differentiate you.',
                    fix: 'Pin your most unique, searchable skills to the top: specific tools, domain expertise, or certifications'
                });
            }

            // Skills match resume (2 pts) - compare if resume data available
            if (resume.skills?.length > 0 && skills.length > 0) {
                const resumeSkillsLower = resume.skills.map(s => s.toLowerCase());
                const linkedinSkillsLower = skills.map(s => s.toLowerCase());
                const matchCount = resumeSkillsLower.filter(rs =>
                    linkedinSkillsLower.some(ls => ls.includes(rs) || rs.includes(ls))
                ).length;
                const matchRate = matchCount / resumeSkillsLower.length;
                skillsCriteria.resumeMatch = matchRate >= 0.5 ? 2 : (matchRate >= 0.25 ? 1 : 0);
            } else {
                skillsCriteria.resumeMatch = 1; // Neutral if no resume to compare
            }

            sectionScores.skills = Object.values(skillsCriteria).reduce((a, b) => a + b, 0);
            sectionDetails.skills = skillsCriteria;

            // ============ FRESHNESS SCORING (10 pts) ============
            const freshCriteria = {};
            const linkedinLastUpdated = sessionStorage.getItem('linkedinUploadTime') || new Date().toISOString();
            const daysSinceUpdate = (Date.now() - new Date(linkedinLastUpdated)) / (1000 * 60 * 60 * 24);

            // Updated in last 30 days (3 pts)
            if (daysSinceUpdate < 30) {
                freshCriteria.recentUpdate = 3;
            } else if (daysSinceUpdate < 90) {
                freshCriteria.recentUpdate = 1;
            } else {
                freshCriteria.recentUpdate = 0;
                fixes.push({
                    severity: 'MEDIUM',
                    section: 'Freshness',
                    problem: 'Profile hasn\'t been updated recently',
                    why: 'LinkedIn\'s algorithm boosts recently updated profiles. Stale profiles rank lower in searches.',
                    fix: 'Make any edit (skill, headline tweak) to refresh your profile. Set a reminder for monthly updates.'
                });
            }

            // Activity in last 30 days (3 pts)
            const hasActivity = linkedin.activity?.length > 0 || linkedin.posts?.length > 0;
            freshCriteria.recentActivity = hasActivity ? 3 : 0;
            if (!hasActivity) {
                fixes.push({
                    severity: 'LOW',
                    section: 'Freshness',
                    problem: 'No recent LinkedIn activity',
                    why: 'Active profiles get algorithmic boost. Engagement signals you\'re present and reachable.',
                    fix: 'Like or comment on industry posts weekly. You don\'t need to create content, just engage.'
                });
            }

            // Current role is "Present" (2 pts)
            const currentRoleDate = currentRole?.dates || currentRole?.date_range || '';
            const hasPresent = /present|current|now|\d{4}\s*-\s*$/i.test(currentRoleDate);
            freshCriteria.currentRole = hasPresent ? 2 : 0;
            if (!hasPresent && experience.length > 0) {
                fixes.push({
                    severity: 'HIGH',
                    section: 'Freshness',
                    problem: 'No current role shows as "Present"',
                    why: 'Profiles without a current role signal unemployment or staleness. Even if job searching, consider "Open to Work" as current.',
                    fix: 'If employed, ensure your current role shows "Present". If searching, add "Open to [Role] Opportunities" as current.'
                });
            }

            // Photo updated in last 2 years (2 pts) - we can't verify this, give neutral score
            freshCriteria.photoRecent = 1; // Neutral

            sectionScores.freshness = Object.values(freshCriteria).reduce((a, b) => a + b, 0);
            sectionDetails.freshness = freshCriteria;

            // ============ RESUME ALIGNMENT SCORING (10 pts) ============
            // Resume = precision tool. LinkedIn = credibility + discovery surface.
            // Alignment matters, but exact mirroring is not the goal.
            const alignCriteria = {};

            if (resume.experience?.length > 0 && experience.length > 0) {
                // Check title consistency (3 pts)
                // LinkedIn titles should be consistent with resume, but not necessarily identical
                alignCriteria.titlesMatch = 3; // Assume match unless we detect inflation

                // Check company names match (3 pts)
                alignCriteria.companiesMatch = 3; // Assume match

                // Check date ranges consistent (2 pts)
                alignCriteria.datesMatch = 2; // Assume consistent

                // No unexplained gaps (2 pts)
                alignCriteria.noGaps = 2;
            } else {
                // No resume to compare - give neutral partial scores
                alignCriteria.titlesMatch = 2;
                alignCriteria.companiesMatch = 2;
                alignCriteria.datesMatch = 1;
                alignCriteria.noGaps = 1;
                if (!resume.experience) {
                    fixes.push({
                        severity: 'LOW',
                        section: 'Resume Alignment',
                        problem: 'Unable to verify resume alignment',
                        why: 'Major discrepancies between LinkedIn and resume destroy credibility. Minor differences are expected.',
                        fix: 'Upload your resume to check for title inflation or date mismatches'
                    });
                }
            }

            sectionScores.resumeAlignment = Object.values(alignCriteria).reduce((a, b) => a + b, 0);
            sectionDetails.resumeAlignment = alignCriteria;

            // ============ CREDIBILITY SCORING (5 pts) ============
            const credCriteria = {};

            // Company URLs exist (2 pts) - can't fully verify, assume partial
            credCriteria.companyUrls = experience.length > 0 ? 1 : 0;

            // Professional photo (2 pts) - can't verify from PDF, assume yes
            credCriteria.professionalPhoto = 2;

            // No broken links (1 pt) - can't verify, assume yes
            credCriteria.nobrokenLinks = 1;

            sectionScores.credibility = Object.values(credCriteria).reduce((a, b) => a + b, 0);
            sectionDetails.credibility = credCriteria;

            // ============ OTHER SIGNALS SCORING (5 pts) ============
            const otherCriteria = {};

            // Education listed (2 pts)
            const hasEducation = linkedin.education?.length > 0;
            otherCriteria.education = hasEducation ? 2 : 0;

            // Has recommendations (2 pts)
            const hasRecommendations = linkedin.recommendations?.length > 0;
            otherCriteria.recommendations = hasRecommendations ? 2 : 0;
            if (!hasRecommendations) {
                fixes.push({
                    severity: 'LOW',
                    section: 'Other',
                    problem: 'No recommendations',
                    why: 'Recommendations are social proof. They show others vouch for your work.',
                    fix: 'Ask 2-3 colleagues for recommendations. Offer to write theirs first.'
                });
            }

            // Certifications or volunteer (1 pt)
            const hasCerts = linkedin.certifications?.length > 0 || linkedin.volunteer?.length > 0;
            otherCriteria.certifications = hasCerts ? 1 : 0;

            sectionScores.other = Object.values(otherCriteria).reduce((a, b) => a + b, 0);
            sectionDetails.other = otherCriteria;

            // ============ CALCULATE OVERALL SCORE ============
            // Weights from spec: Headline 15, About 20, Experience 20, Skills 15, Freshness 10, Alignment 10, Credibility 5, Other 5 = 100
            const overall = Math.round(
                (sectionScores.headline / SECTION_CONFIG.headline.maxPoints) * 15 +
                (sectionScores.about / SECTION_CONFIG.about.maxPoints) * 20 +
                (sectionScores.experience / SECTION_CONFIG.experience.maxPoints) * 20 +
                (sectionScores.skills / SECTION_CONFIG.skills.maxPoints) * 15 +
                (sectionScores.freshness / SECTION_CONFIG.freshness.maxPoints) * 10 +
                (sectionScores.resumeAlignment / SECTION_CONFIG.resumeAlignment.maxPoints) * 10 +
                (sectionScores.credibility / SECTION_CONFIG.credibility.maxPoints) * 5 +
                (sectionScores.other / SECTION_CONFIG.other.maxPoints) * 5
            );

            // Add fix_ids for diagnosis-optimization contract
            let fixCounter = 1;
            fixes.forEach(fix => {
                fix.fix_id = `FIX_${fix.section.toUpperCase()}_${String(fixCounter++).padStart(2, '0')}`;
            });

            // Sort fixes by severity
            fixes.sort((a, b) => SEVERITY[a.severity].order - SEVERITY[b.severity].order);

            // Detect profile gaps
            const profileGaps = detectProfileGaps(linkedin, sectionScores, experience);

            // Build diagnosis object per contract spec
            const diagnosis = {
                overall_score: overall,
                section_scores: {
                    headline: { score: sectionScores.headline, max: SECTION_CONFIG.headline.maxPoints, threshold: 12 },
                    about: { score: sectionScores.about, max: SECTION_CONFIG.about.maxPoints, threshold: 16 },
                    experience: { score: sectionScores.experience, max: SECTION_CONFIG.experience.maxPoints, threshold: 16 },
                    skills: { score: sectionScores.skills, max: SECTION_CONFIG.skills.maxPoints, threshold: 12 },
                    freshness: { score: sectionScores.freshness, max: SECTION_CONFIG.freshness.maxPoints, threshold: 7 },
                    resumeAlignment: { score: sectionScores.resumeAlignment, max: SECTION_CONFIG.resumeAlignment.maxPoints, threshold: 7 },
                    credibility: { score: sectionScores.credibility, max: SECTION_CONFIG.credibility.maxPoints, threshold: 4 },
                    other: { score: sectionScores.other, max: SECTION_CONFIG.other.maxPoints, threshold: 4 }
                },
                profile_gaps: profileGaps.slice(0, 5),
                fixes: fixes.slice(0, 8)
            };

            // Store diagnosis for optimization validation
            window.linkedinDiagnosis = diagnosis;

            return {
                overall,
                sectionScores,
                sectionDetails,
                fixes: fixes.slice(0, 8),
                profileGaps: profileGaps.slice(0, 5),
                diagnosis // Include full diagnosis object
            };
        }

        // Detect strategic profile gaps
        // Per diagnosis-optimization contract: gaps are read-only diagnosis, not advice
        function detectProfileGaps(linkedin, sectionScores, experience) {
            const gaps = [];

            // 1. SCOPE GAP - Senior titles without evidence of scale
            const seniorTitles = /\b(senior|lead|staff|principal|director|vp|head|chief|manager)\b/i;
            const currentTitle = experience[0]?.title || linkedin.headline || '';
            const hasSeniorTitle = seniorTitles.test(currentTitle);

            if (hasSeniorTitle) {
                const allBullets = experience.map(e => e.description || (e.bullets ? e.bullets.join(' ') : '')).join(' ');
                const hasScope = /\b(\d+[-\s]person|\d+\s*team|led\s+\d+|managed\s+\d+|\$\d+[MBK]?\s*(budget|revenue)|cross-functional|org-wide|company-wide)/i.test(allBullets);

                if (!hasScope) {
                    gaps.push({
                        gap_id: 'GAP_SCOPE_01',
                        type: 'Scope',
                        severity: 'CRITICAL',
                        affected_sections: ['experience'],
                        icon: '!',
                        description: 'Your profile does not demonstrate senior-level ownership or decision-making authority.',
                        why: 'Hiring managers expect senior titles to show ownership, scale, and decision authority. Without these signals, they question whether the title reflects actual scope.',
                        fix: "Add bullets that quantify team size, budget, or geographic scope. Use ownership language: 'Led 12-person team', 'Owned $5M budget', 'Drove company-wide initiative'."
                    });
                }
            }

            // 2. EVIDENCE GAP - Lack of quantified outcomes
            const allBullets = experience.map(e => e.description || (e.bullets ? e.bullets.join(' ') : '')).join(' ');
            const hasMetrics = /\d+[%+]?|\$\d+[MBK]?|\d+x|\d+\s*(people|hires|team|revenue|growth|million|billion|users|customers)/i.test(allBullets);

            if (!hasMetrics && experience.length > 0) {
                gaps.push({
                    gap_id: 'GAP_EVIDENCE_01',
                    type: 'Evidence',
                    severity: 'HIGH',
                    affected_sections: ['experience', 'about'],
                    icon: '?',
                    description: 'Your experience describes what you worked on, but not the outcomes you drove.',
                    why: 'Hiring managers rely on quantified results to validate impact. Without metrics, they assume your work had limited business effect.',
                    fix: "Rewrite bullets to follow PAR format (Problem, Action, Result). Add specific metrics: revenue impact, cost savings, efficiency gains, user growth."
                });
            }

            // 3. CREDIBILITY GAP - Unverifiable companies or mismatches
            const smallCompanySignals = experience.filter(e => {
                const company = (e.company || '').toLowerCase();
                return !company.includes('google') && !company.includes('meta') && !company.includes('amazon') && !company.includes('microsoft');
            }).length;

            if (smallCompanySignals >= experience.length && experience.length >= 2) {
                gaps.push({
                    gap_id: 'GAP_CREDIBILITY_01',
                    type: 'Credibility',
                    severity: 'MEDIUM',
                    affected_sections: ['experience'],
                    icon: '‚úó',
                    description: 'Some roles on your profile are difficult to validate, which weakens hiring manager confidence in scope and scale.',
                    why: 'Hiring managers verify company legitimacy to assess the quality of your experience. Unverifiable companies raise questions about title inflation.',
                    fix: "Add context in your bullets: 'Series A fintech startup, $3M funding, 15 employees' or 'Acquired by [Company] in 2022'."
                });
            }

            // 4. POSITIONING GAP - Clear primary lane + optional adjacency. Never multiple lanes.
            // PM + B2B SaaS Growth = good. PM + Engineer = bad.
            const headlineForGaps = linkedin.headline || '';
            const aboutForGaps = linkedin.summary || linkedin.about || '';

            // Check for clear function
            const functionPatterns = /\b(product manager|project manager|program manager|engineering manager|software engineer|data engineer|data scientist|designer|ux designer|recruiter|marketing|sales|operations|analyst|consultant)\b/i;
            const hasFunction = functionPatterns.test(headlineForGaps);

            // Check for specialization
            const hasSpecialization = /\b(saas|b2b|b2c|fintech|healthcare|enterprise|growth|platform|infrastructure|mobile|web|data|cloud|ai|ml|devops|payments|e-commerce)\b/i.test(headlineForGaps + ' ' + aboutForGaps);

            // Check for MULTIPLE primary lanes (bad)
            const primaryLanes = [
                /\bproduct\s*(manager|management)\b/i,
                /\bengineer(ing)?\b/i,
                /\bdesign(er)?\b/i,
                /\bmarketing\b/i,
                /\bsales\b/i,
                /\brecruit(er|ing)?\b/i,
                /\boperation(s)?\b/i,
                /\bconsult(ant|ing)?\b/i
            ];
            const matchedLanes = primaryLanes.filter(pattern => pattern.test(headlineForGaps));
            const hasMultipleLanes = matchedLanes.length >= 2;

            if (hasMultipleLanes) {
                gaps.push({
                    gap_id: 'GAP_POSITIONING_01',
                    type: 'Positioning',
                    severity: 'CRITICAL',
                    affected_sections: ['headline', 'about', 'skills'],
                    icon: '‚óé',
                    description: 'Your profile tries to claim multiple primary lanes, which confuses hiring teams about what you actually do.',
                    why: "A profile that tries to appeal to everyone appeals to no one. 'PM + Engineer' or 'Sales + Marketing' signals you haven't committed to a lane. Both recruiters and hiring managers search for specialists.",
                    fix: "Pick ONE primary function. Adjacent skills are fine (PM who codes, Engineer who designs), but you need one clear lane. Your profile should pass this test: 'In one sentence, what does this person do?'"
                });
            } else if (!hasFunction || (!hasSpecialization && headlineForGaps.length > 0)) {
                gaps.push({
                    gap_id: 'GAP_POSITIONING_02',
                    type: 'Positioning',
                    severity: 'HIGH',
                    affected_sections: ['headline', 'about', 'skills'],
                    icon: '‚óé',
                    description: 'Your profile does not clearly position you for a specific role or niche, making it harder for hiring teams to match you to open roles.',
                    why: "Recruiters search for specific terms like 'product manager fintech' or 'backend engineer python'. Generic positioning makes you invisible in search. A profile that tries to appeal to everyone appeals to no one.",
                    fix: "Choose ONE primary function and specialize it (B2B SaaS, Healthcare Tech, Fintech). Update your headline, About, and skills to consistently reinforce this single positioning."
                });
            }

            // 5. RECENCY GAP - Profile appears inactive
            const currentRoleDates = experience[0]?.dates || experience[0]?.date_range || '';
            const hasCurrentRole = /present|current|now|\d{4}\s*-\s*$/i.test(currentRoleDates);

            if (!hasCurrentRole && experience.length > 0) {
                gaps.push({
                    gap_id: 'GAP_RECENCY_01',
                    type: 'Recency',
                    severity: 'MEDIUM',
                    affected_sections: ['experience', 'freshness'],
                    icon: '‚è±',
                    description: 'Your profile appears inactive, which reduces how often it is surfaced in recruiter searches.',
                    why: "LinkedIn's algorithm prioritizes active profiles in search results. Stale profiles rank lower and signal to hiring teams that you may not be actively engaged.",
                    fix: "Update your profile monthly. If between roles, add a 'current' entry like 'Open to Product Management Opportunities'."
                });
            }

            return gaps;
        }

        // ============ DISPLAY FUNCTIONS ============
        function displayScoringResults(result) {
            const { overall, sectionScores, sectionDetails, fixes, profileGaps } = result;

            // Initialize How Recruiters Search section
            initHowRecruitersSection();

            // Update overall score with animation
            const scoreValue = document.getElementById('scoreValue');
            const scoreCircle = document.getElementById('scoreCircle');
            const scoreTitle = document.getElementById('scoreTitle');
            const scoreSummary = document.getElementById('scoreSummary');

            // Animate score from 0 to final value (1.5s ease-out per spec)
            animateScore(0, overall, 1500, scoreValue, scoreCircle);

            // Set final score color based on health
            const scoreColor = overall >= 80 ? 'var(--color-success)' :
                               overall >= 60 ? 'var(--color-warning)' : 'var(--color-error)';
            scoreValue.style.color = scoreColor;

            // Set label and summary
            let label, summary;
            if (overall >= 80) {
                label = 'Strong Profile';
                summary = 'Your profile is well-optimized. Focus on the minor improvements below to maximize visibility.';
            } else if (overall >= 60) {
                label = 'Needs Improvement';
                summary = 'Recruiters will find you but may not click. Address the high-priority items below.';
            } else if (overall >= 40) {
                label = 'Needs Work';
                summary = 'Your profile is missing key elements. Fix the critical issues to start getting noticed.';
            } else {
                label = 'Critical Attention Needed';
                summary = 'Your profile isn\'t optimized for recruiter search. Start with the critical items immediately.';
            }

            scoreTitle.textContent = label;
            scoreSummary.textContent = summary;

            // Render score context section
            renderScoreContext(overall);

            // Render profile gaps section
            renderProfileGaps(profileGaps);

            // Render section cards
            renderSectionCards(sectionScores, sectionDetails);

            // Render fix list
            renderFixSections(fixes);

            // Add click handlers for expandable cards
            document.querySelectorAll('.section-card-header').forEach(header => {
                header.addEventListener('click', () => {
                    header.closest('.section-card').classList.toggle('expanded');
                });
            });
        }

        // Render "What This Score Means" with outcome-based messaging
        function renderScoreContext(score) {
            let contextText = '';
            let encouragement = '';

            if (score >= 80) {
                contextText = "You're in the top 20% of profiles. Recruiters will find you, click your profile, and likely reach out. Focus on staying fresh (update every 30 days).";
                encouragement = "You're well-positioned for inbound recruiter interest. The polish items below can make you exceptional.";
            } else if (score >= 60) {
                contextText = "You're findable but not compelling. Recruiters will see you in search results but may skip to the next person. Fix the high-priority items to stand out.";
                encouragement = "A few targeted improvements will significantly increase your click-through rate from recruiter searches.";
            } else if (score >= 40) {
                contextText = "You're barely visible. Most recruiters won't find you in search, and if they do, they won't click. Fix the critical issues to start getting noticed.";
                encouragement = "The fixes below are your roadmap to visibility. Start with the critical items. They'll have the biggest impact.";
            } else {
                contextText = "Your profile is essentially invisible. LinkedIn's algorithm won't surface you in recruiter searches. Start with the critical items immediately.";
                encouragement = "Don't be discouraged. Every profile starts somewhere. Focus on the basics and you'll see improvement quickly.";
            }

            document.getElementById('scoreContextText').textContent = contextText;
            document.getElementById('scoreContextEncouragement').textContent = encouragement;
        }

        // Render profile gaps section
        function renderProfileGaps(gaps) {
            const section = document.getElementById('profileGapsSection');
            if (!gaps || gaps.length === 0) {
                section.style.display = 'none';
                return;
            }

            section.style.display = 'block';
            document.getElementById('profileGapsIntro').textContent =
                `Your profile has ${gaps.length} strategic gap${gaps.length > 1 ? 's' : ''} that ${gaps.length > 1 ? 'are' : 'is'} limiting recruiter engagement:`;

            const gapsHtml = gaps.map(gap => {
                const gapTypeClass = gap.type.toLowerCase();
                return `
                    <div class="gap-item">
                        <div class="gap-header">
                            <span class="gap-icon ${gapTypeClass}">${gap.icon}</span>
                            <span class="gap-title">${gap.type} Gap</span>
                        </div>
                        <p class="gap-description">${gap.description}</p>
                        <p class="gap-why">${gap.why}</p>
                        <div class="gap-fix"><strong>How to fix:</strong> ${gap.fix}</div>
                    </div>
                `;
            }).join('');

            document.getElementById('profileGapsList').innerHTML = gapsHtml;
        }

        // Render section cards with expandable breakdown
        function renderSectionCards(sectionScores, sectionDetails) {
            const container = document.getElementById('sectionCards');

            const html = Object.entries(SECTION_CONFIG).map(([key, config]) => {
                const score = sectionScores[key] || 0;
                const details = sectionDetails[key] || {};
                const pct = (score / config.maxPoints) * 100;
                const status = pct >= 80 ? 'good' : pct >= 50 ? 'warning' : 'bad';

                const criteriaHtml = config.criteria.map(c => {
                    const earned = details[c.key] || 0;
                    const valueClass = earned >= c.points ? 'earned' : (earned > 0 ? 'partial' : 'missed');
                    return `
                        <div class="criteria-item">
                            <span class="criteria-label">${c.label}</span>
                            <span class="criteria-value ${valueClass}">${earned}/${c.points}</span>
                        </div>
                    `;
                }).join('');

                return `
                    <div class="section-card ${status}">
                        <div class="section-card-header">
                            <div class="section-card-left">
                                <span class="section-icon">${config.icon}</span>
                                <span class="section-name">${config.name}</span>
                            </div>
                            <div class="section-card-right">
                                <span class="section-score">${score}/${config.maxPoints}</span>
                                <span class="section-chevron">‚ñº</span>
                            </div>
                        </div>
                        <div class="section-card-body">
                            <div class="score-criteria">
                                ${criteriaHtml}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = html;
        }

        function renderFixSections(fixes) {
            const container = document.getElementById('fixSections');

            if (!fixes || fixes.length === 0) {
                container.innerHTML = `
                    <div class="fix-section">
                        <div class="fix-header">
                            <div class="fix-header-left">
                                <span class="fix-title">No Critical Issues Found</span>
                                <span class="fix-count success">All Good</span>
                            </div>
                        </div>
                    </div>
                `;
                return;
            }

            // Group by severity
            const critical = fixes.filter(f => f.severity === 'CRITICAL');
            const high = fixes.filter(f => f.severity === 'HIGH');
            const medium = fixes.filter(f => f.severity === 'MEDIUM');
            const low = fixes.filter(f => f.severity === 'LOW');

            let html = '';

            if (critical.length > 0) {
                html += renderFixGroup('Critical Issues', critical, 'critical');
            }
            if (high.length > 0) {
                html += renderFixGroup('High Priority', high, 'warning');
            }
            if (medium.length > 0) {
                html += renderFixGroup('Recommendations', medium, 'success');
            }
            if (low.length > 0) {
                html += renderFixGroup('Nice to Have', low, 'success');
            }

            container.innerHTML = html;

            // Add click handlers
            container.querySelectorAll('.fix-header').forEach(header => {
                header.addEventListener('click', () => {
                    header.closest('.fix-section').classList.toggle('expanded');
                });
            });
        }

        function renderFixGroup(title, items, countClass) {
            const itemsHtml = items.map(item => `
                <div class="fix-item">
                    <div class="fix-item-header">
                        <span class="fix-item-title">${item.problem || item.issue || 'Issue'}</span>
                        <span class="fix-item-severity ${SEVERITY[item.severity]?.class || 'high'}">${SEVERITY[item.severity]?.label || item.severity}</span>
                    </div>
                    <p class="fix-item-description"><strong>Why it matters:</strong> ${item.why || ''}</p>
                    <p class="fix-item-description" style="margin-top: 8px; color: var(--color-accent);"><strong>How to fix:</strong> ${item.fix || item.recommendation || ''}</p>
                </div>
            `).join('');

            return `
                <div class="fix-section expanded">
                    <div class="fix-header">
                        <div class="fix-header-left">
                            <span class="fix-title">${title}</span>
                            <span class="fix-count ${countClass}">${items.length}</span>
                        </div>
                        <span class="fix-chevron">&#9660;</span>
                    </div>
                    <div class="fix-content">
                        ${itemsHtml}
                    </div>
                </div>
            `;
        }

        // ============ DIAGNOSIS ‚Üí OPTIMIZATION CONTRACT ============
        // Profile Scoring diagnoses. Profile Optimization treats.
        // Optimization must never introduce new ideas that weren't surfaced by scoring.
        // If it doesn't show up in the score or gaps, it does not belong in optimization.

        function renderOptimizations() {
            const container = document.getElementById('optimizationContent');

            if (!linkedinData || !scoringResults) {
                return;
            }

            const { fixes, profileGaps, sectionScores, sectionDetails, overall, diagnosis } = scoringResults;
            const role = analysisData?._role || analysisData?.role_title || 'your target role';
            const currentHeadline = linkedinData.headline || '';
            const currentSummary = linkedinData.summary || linkedinData.about || '';

            // ============ OPTIMIZATION VALIDATION (Contract Enforcement) ============
            // Build allowed optimization scope from diagnosis
            const allowedGapIds = profileGaps.map(g => g.gap_id).filter(Boolean);
            const allowedFixIds = fixes.filter(f => f.severity === 'CRITICAL' || f.severity === 'HIGH').map(f => f.fix_id).filter(Boolean);
            const sectionsNeeding = new Set();

            // Add sections from gaps
            profileGaps.forEach(gap => {
                (gap.affected_sections || []).forEach(s => sectionsNeeding.add(s));
            });

            // Add sections from CRITICAL/HIGH fixes
            fixes.filter(f => f.severity === 'CRITICAL' || f.severity === 'HIGH').forEach(fix => {
                sectionsNeeding.add(fix.section?.toLowerCase());
            });

            // Add sections below threshold
            const thresholds = { headline: 12, about: 16, experience: 16, skills: 12 };
            Object.entries(thresholds).forEach(([section, threshold]) => {
                if ((sectionScores[section] || 0) < threshold) {
                    sectionsNeeding.add(section);
                }
            });

            // Helper: Check if optimization is valid per contract
            const isOptimizationAllowed = (section) => {
                return sectionsNeeding.has(section.toLowerCase());
            };

            // Count issues by severity
            const criticalCount = fixes.filter(f => f.severity === 'CRITICAL').length;
            const highCount = fixes.filter(f => f.severity === 'HIGH').length;
            const totalIssues = fixes.length + profileGaps.length;

            // If no issues, show success state
            if (totalIssues === 0 && overall >= 80) {
                container.innerHTML = `
                    <div class="no-issues-state">
                        <div class="icon">üéâ</div>
                        <h3>Your Profile is Well-Optimized</h3>
                        <p>No critical issues found. Your LinkedIn profile is already recruiter-ready for ${role}.</p>
                    </div>
                `;
                return;
            }

            // Get issues by section for targeting
            const headlineIssues = fixes.filter(f => f.section === 'Headline');
            const aboutIssues = fixes.filter(f => f.section === 'About');
            const experienceIssues = fixes.filter(f => f.section === 'Experience');
            const skillsIssues = fixes.filter(f => f.section === 'Skills');

            // Get relevant gaps
            const positioningGap = profileGaps.find(g => g.type === 'Positioning');
            const evidenceGap = profileGaps.find(g => g.type === 'Evidence');
            const scopeGap = profileGaps.find(g => g.type === 'Scope');

            // Build issue-driven badge HTML helper
            const buildFixesBadges = (issues, gaps = []) => {
                const badges = [];
                issues.forEach(issue => {
                    const badgeClass = issue.severity === 'CRITICAL' ? '' : (issue.severity === 'HIGH' ? 'high' : 'medium');
                    badges.push(`<span class="fixes-badge ${badgeClass}">‚ö° ${issue.problem.substring(0, 40)}${issue.problem.length > 40 ? '...' : ''}</span>`);
                });
                gaps.forEach(gap => {
                    badges.push(`<span class="fixes-badge gap">üéØ ${gap.type} Gap</span>`);
                });
                return badges.length > 0 ? `<div class="fixes-issues">${badges.join('')}</div>` : '';
            };

            // Calculate potential score impact
            const headlineMaxGain = SECTION_CONFIG.headline.maxPoints - (sectionScores.headline || 0);
            const aboutMaxGain = SECTION_CONFIG.about.maxPoints - (sectionScores.about || 0);
            const skillsMaxGain = SECTION_CONFIG.skills.maxPoints - (sectionScores.skills || 0);

            // Generate optimized content based on issues
            const optimizedHeadline = generateOptimizedHeadline();
            const optimizedSummary = generateOptimizedSummary();
            const skillsRecommendations = generateSkillsRecommendations();

            // Build intro section
            let badgeClass = criticalCount > 0 ? '' : (highCount > 0 ? 'warning' : 'success');
            let introText = '';
            if (criticalCount > 0) {
                introText = `Your profile has ${criticalCount} critical issue${criticalCount > 1 ? 's' : ''} preventing recruiter visibility. The optimizations below directly address each problem identified in your Profile Score.`;
            } else if (highCount > 0) {
                introText = `Your profile is findable but not compelling. These ${highCount} high-priority optimizations will significantly improve your recruiter click-through rate.`;
            } else {
                introText = `Minor polish items to maximize your profile's effectiveness for ${role}. These improvements will help you stand out from other candidates.`;
            }

            let html = `
                <!-- Issue-Driven Intro -->
                <div class="optimization-intro">
                    <h3>
                        Your Optimization Plan
                        <span class="issue-count-badge ${badgeClass}">${totalIssues} issue${totalIssues !== 1 ? 's' : ''} to fix</span>
                    </h3>
                    <p>${introText}</p>
                </div>
            `;

            // ============ HEADLINE OPTIMIZATION ============
            // Contract rule: Only generate if headline score < 12/15 OR Positioning gap detected
            const headlineAllowed = isOptimizationAllowed('headline') || positioningGap;
            if (headlineAllowed && (headlineIssues.length > 0 || positioningGap)) {
                const hasCritical = headlineIssues.some(i => i.severity === 'CRITICAL');
                const priorityClass = hasCritical ? 'critical' : 'high';
                const priorityText = hasCritical ? 'Critical - Fix immediately' : 'High priority - Significant impact';
                // Track what this optimization fixes (per contract)
                const fixesRefs = [
                    ...headlineIssues.map(i => i.fix_id).filter(Boolean),
                    positioningGap?.gap_id
                ].filter(Boolean);

                html += `
                    <div class="optimization-section">
                        <div class="optimization-header">
                            <h3 class="optimization-title"><span>üìå</span> Headline Optimization</h3>
                            <button class="copy-btn" onclick="copyToClipboard(this, 'headline')">
                                <span>üìã</span> Copy Optimized
                            </button>
                        </div>

                        ${buildFixesBadges(headlineIssues, positioningGap ? [positioningGap] : [])}

                        <div class="priority-indicator">
                            <span class="priority-dot ${priorityClass}"></span>
                            <span class="priority-text"><strong>${priorityText}</strong> ‚Ä¢ Estimated +${headlineMaxGain} points</span>
                        </div>

                        <div class="comparison-container">
                            <div class="comparison-box current">
                                <div class="comparison-label">‚ùå Current</div>
                                <div class="comparison-text">${currentHeadline || '(No headline set)'}</div>
                            </div>
                            <div class="comparison-box optimized">
                                <div class="comparison-label">‚úì Optimized</div>
                                <div class="comparison-text" id="headline">${optimizedHeadline}</div>
                            </div>
                        </div>

                        <div class="improvement-checklist">
                            <h4>This optimization addresses:</h4>
                            ${headlineIssues.map(issue => `
                                <div class="checklist-item">
                                    <span class="checklist-icon included">‚úì</span>
                                    <span>${issue.problem}</span>
                                </div>
                            `).join('')}
                            ${positioningGap ? `
                                <div class="checklist-item">
                                    <span class="checklist-icon included">‚úì</span>
                                    <span>${positioningGap.description}</span>
                                </div>
                            ` : ''}
                        </div>

                        <div class="optimization-why">
                            <strong>Why this works:</strong> Includes target role title for search visibility, removes buzzwords, adds quantified differentiator, and positions you for ${role}.
                        </div>
                    </div>
                `;
            }

            // ============ ABOUT SECTION OPTIMIZATION ============
            // Contract rule: Only generate if about score < 16/20 OR Evidence/Positioning gap detected
            const aboutAllowed = isOptimizationAllowed('about') || evidenceGap || positioningGap;
            if (aboutAllowed && (aboutIssues.length > 0 || evidenceGap)) {
                const hasCritical = aboutIssues.some(i => i.severity === 'CRITICAL');
                const priorityClass = hasCritical ? 'critical' : 'high';
                const priorityText = hasCritical ? 'Critical - Your profile is incomplete' : 'High priority - Weak positioning';

                html += `
                    <div class="optimization-section">
                        <div class="optimization-header">
                            <h3 class="optimization-title"><span>üìù</span> About Section Optimization</h3>
                            <button class="copy-btn" onclick="copyToClipboard(this, 'summary')">
                                <span>üìã</span> Copy Optimized
                            </button>
                        </div>

                        ${buildFixesBadges(aboutIssues, evidenceGap ? [evidenceGap] : [])}

                        <div class="priority-indicator">
                            <span class="priority-dot ${priorityClass}"></span>
                            <span class="priority-text"><strong>${priorityText}</strong> ‚Ä¢ Estimated +${aboutMaxGain} points</span>
                        </div>

                        ${currentSummary ? `
                        <div class="comparison-container">
                            <div class="comparison-box current">
                                <div class="comparison-label">‚ùå Current (${currentSummary.split(/\s+/).length} words)</div>
                                <div class="comparison-text">${currentSummary.substring(0, 200)}${currentSummary.length > 200 ? '...' : ''}</div>
                            </div>
                            <div class="comparison-box optimized">
                                <div class="comparison-label">‚úì Optimized Framework</div>
                                <div class="comparison-text">Hook ‚Üí Expertise ‚Üí Achievements ‚Üí CTA</div>
                            </div>
                        </div>
                        ` : ''}

                        <div class="optimization-content" id="summary">${optimizedSummary}</div>

                        <div class="improvement-checklist">
                            <h4>This optimization addresses:</h4>
                            ${aboutIssues.map(issue => `
                                <div class="checklist-item">
                                    <span class="checklist-icon included">‚úì</span>
                                    <span>${issue.problem}</span>
                                </div>
                            `).join('')}
                            ${evidenceGap ? `
                                <div class="checklist-item">
                                    <span class="checklist-icon included">‚úì</span>
                                    <span>Adds quantified outcomes to demonstrate impact</span>
                                </div>
                            ` : ''}
                        </div>

                        <div class="optimization-why">
                            <strong>Why this works:</strong> First 3 lines are visible before "see more" and contain your hook. Includes searchable keywords for ${role}. Ends with clear CTA.
                        </div>
                    </div>
                `;
            }

            // ============ EXPERIENCE BULLETS OPTIMIZATION ============
            // Contract rule: Only generate if experience score < 16/20 OR Scope/Evidence gap detected
            const experienceAllowed = isOptimizationAllowed('experience') || scopeGap || evidenceGap;
            if (experienceAllowed && (experienceIssues.length > 0 || scopeGap)) {
                html += `
                    <div class="optimization-section">
                        <div class="optimization-header">
                            <h3 class="optimization-title"><span>üíº</span> Experience Optimization</h3>
                        </div>

                        ${buildFixesBadges(experienceIssues, scopeGap ? [scopeGap] : [])}

                        <div class="priority-indicator">
                            <span class="priority-dot high"></span>
                            <span class="priority-text"><strong>High priority</strong> ‚Ä¢ Experience carries 20% of your score</span>
                        </div>

                        <div class="optimization-content">
                            <strong>Transform your bullets using PAR format:</strong>

<strong>Before:</strong> "Managed a team and improved processes"

<strong>After:</strong> "Led 12-person cross-functional team to redesign onboarding workflow, reducing time-to-productivity by 40% ($500K annual savings)"

<strong>The PAR Formula:</strong>
‚Ä¢ <strong>P</strong>roblem/Context: What challenge did you face?
‚Ä¢ <strong>A</strong>ction: What specifically did you do?
‚Ä¢ <strong>R</strong>esult: What measurable outcome did you achieve?
                        </div>

                        <div class="improvement-checklist">
                            <h4>Apply to your current role:</h4>
                            ${experienceIssues.map(issue => `
                                <div class="checklist-item">
                                    <span class="checklist-icon pending">!</span>
                                    <span>${issue.fix}</span>
                                </div>
                            `).join('')}
                            ${scopeGap ? `
                                <div class="checklist-item">
                                    <span class="checklist-icon pending">!</span>
                                    <span>${scopeGap.fix}</span>
                                </div>
                            ` : ''}
                        </div>

                        <div class="optimization-why">
                            <strong>Key insight:</strong> Recruiters spend 80% of their time on your current role. Make every bullet count with specific metrics.
                        </div>
                    </div>
                `;
            }

            // ============ SKILLS OPTIMIZATION ============
            // Contract rule: Only generate if skills score < 12/15 OR Positioning gap detected
            const skillsAllowed = isOptimizationAllowed('skills') || positioningGap;
            if (skillsAllowed && (skillsIssues.length > 0 || skillsRecommendations.add.length > 0)) {
                html += `
                    <div class="optimization-section">
                        <div class="optimization-header">
                            <h3 class="optimization-title"><span>üéØ</span> Skills Optimization</h3>
                        </div>

                        ${buildFixesBadges(skillsIssues)}

                        <div class="priority-indicator">
                            <span class="priority-dot ${skillsIssues.some(i => i.severity === 'HIGH') ? 'high' : 'medium'}"></span>
                            <span class="priority-text"><strong>Skills matching</strong> ‚Ä¢ Estimated +${skillsMaxGain} points</span>
                        </div>

                        <div style="margin-bottom: 16px;">
                            <p style="color: var(--color-success); font-size: 0.9rem; margin-bottom: 8px; font-weight: 600;">Add these skills (from ${role} job requirements):</p>
                            <div class="skills-grid">
                                ${skillsRecommendations.add.map(s => `<span class="skill-tag add">+ ${s}</span>`).join('')}
                            </div>
                        </div>
                        ${skillsRecommendations.remove.length > 0 ? `
                        <div style="margin-bottom: 16px;">
                            <p style="color: var(--color-error); font-size: 0.9rem; margin-bottom: 8px; font-weight: 600;">Remove generic skills:</p>
                            <div class="skills-grid">
                                ${skillsRecommendations.remove.map(s => `<span class="skill-tag remove">${s}</span>`).join('')}
                            </div>
                        </div>
                        ` : ''}

                        <div class="improvement-checklist">
                            <h4>Skills strategy:</h4>
                            <div class="checklist-item">
                                <span class="checklist-icon pending">!</span>
                                <span>Pin your 3 most relevant skills to the top (these appear in search)</span>
                            </div>
                            <div class="checklist-item">
                                <span class="checklist-icon pending">!</span>
                                <span>Add skills from ${role} job descriptions until you reach 50</span>
                            </div>
                            <div class="checklist-item">
                                <span class="checklist-icon pending">!</span>
                                <span>Request endorsements from colleagues for your top skills</span>
                            </div>
                        </div>

                        <div class="optimization-why">
                            <strong>Why this matters:</strong> LinkedIn's search algorithm weights skills heavily. More relevant skills = more search matches.
                        </div>
                    </div>
                `;
            }

            // ============ SCORE IMPACT SUMMARY ============
            const potentialScore = Math.min(100, overall + headlineMaxGain + aboutMaxGain + skillsMaxGain);
            html += `
                <div class="score-impact">
                    <span class="score-impact-icon">üìà</span>
                    <span class="score-impact-text">
                        Implementing these optimizations could improve your Profile Score from <strong>${overall}</strong> to approximately <strong>${potentialScore}</strong> points.
                    </span>
                </div>
            `;

            container.innerHTML = html;
        }

        function generateOptimizedHeadline() {
            const role = analysisData?._role || analysisData?.role_title || '';
            const level = analysisData?._level || 'Senior';
            const keywords = analysisData?.ats_keywords || analysisData?.required_skills || [];
            const currentHeadline = linkedinData?.headline || '';

            // Identify issues to fix
            const headlineIssues = scoringResults?.fixes?.filter(f => f.section === 'Headline') || [];
            const needsQuantification = headlineIssues.some(i => i.problem.includes('No numbers'));
            const needsRole = headlineIssues.some(i => i.problem.includes('No clear job title'));
            const hasBuzzwords = headlineIssues.some(i => i.problem.includes('buzzwords'));

            // Build headline that specifically addresses detected issues
            let headline = '';

            // Start with clear role title (addresses "No clear job title" issue)
            if (needsRole || !currentHeadline) {
                headline = `${level} ${role}`;
            } else {
                // Try to extract and improve existing role
                const roleMatch = currentHeadline.match(/\b(Senior|Lead|Staff|Principal|Director|VP|Head|Chief|Manager)?\s*([A-Za-z]+\s*(Manager|Engineer|Developer|Designer|Analyst|Specialist|Consultant|Director|Lead)?)/i);
                headline = roleMatch ? roleMatch[0].trim() : `${level} ${role}`;
            }

            // Add specialization from job keywords (addresses "Positioning Gap")
            if (keywords.length > 0) {
                const specialization = keywords.slice(0, 2).join(' | ');
                headline += ` | ${specialization}`;
            }

            // Add quantification (addresses "No numbers in headline" issue)
            if (needsQuantification || !currentHeadline.match(/\d+/)) {
                // Try to find metrics from experience
                let metric = '';
                if (linkedinData?.experience?.length > 0) {
                    // Calculate years of experience
                    const firstJob = linkedinData.experience[linkedinData.experience.length - 1];
                    const dateMatch = firstJob?.dates?.match(/\d{4}/) || firstJob?.date_range?.match(/\d{4}/);
                    if (dateMatch) {
                        const years = new Date().getFullYear() - parseInt(dateMatch[0]);
                        if (years > 0) {
                            metric = `${years}+ Years`;
                        }
                    }
                }
                if (metric) {
                    headline += ` | ${metric}`;
                }
            }

            // Add company credibility if space allows
            if (headline.length < 160 && linkedinData?.experience?.length > 0) {
                const notableCompanies = linkedinData.experience
                    .map(e => e.company)
                    .filter(c => c && c.length > 2 && !c.toLowerCase().includes('freelance') && !c.toLowerCase().includes('self-employed'))
                    .slice(0, 1);
                if (notableCompanies.length > 0 && notableCompanies[0].length < 30) {
                    headline += ` | Ex-${notableCompanies[0]}`;
                }
            }

            // Ensure under 220 chars
            if (headline.length > 220) {
                headline = headline.substring(0, 217) + '...';
            }

            return headline;
        }

        function generateOptimizedSummary() {
            const role = analysisData?._role || analysisData?.role_title || 'professional';
            const level = analysisData?._level || 'experienced';
            const keywords = analysisData?.ats_keywords || [];
            const currentSummary = linkedinData?.summary || linkedinData?.about || '';

            // Identify issues to fix
            const aboutIssues = scoringResults?.fixes?.filter(f => f.section === 'About') || [];
            const needsMetrics = aboutIssues.some(i => i.problem.includes('No quantified'));
            const needsCTA = !currentSummary.toLowerCase().match(/\b(reach out|contact|connect|email|let's talk|open to|looking for)\b/);
            const isTooShort = currentSummary.split(/\s+/).length < 150;

            // Get years of experience estimate
            let years = 10;
            if (linkedinData?.experience?.length > 0) {
                const firstJob = linkedinData.experience[linkedinData.experience.length - 1];
                const dateMatch = firstJob?.dates?.match(/\d{4}/) || firstJob?.date_range?.match(/\d{4}/);
                if (dateMatch) {
                    years = new Date().getFullYear() - parseInt(dateMatch[0]);
                }
            }

            // Extract metrics from experience if possible
            let achievementBullet = 'Delivered measurable results through strategic execution';
            if (linkedinData?.experience?.length > 0) {
                const allText = linkedinData.experience
                    .map(e => e.description || (e.bullets ? e.bullets.join(' ') : ''))
                    .join(' ');
                const metricMatch = allText.match(/(\d+[%+x]|\$\d+[MBK]?|\d+\s*(people|team|users|customers|projects|clients))/i);
                if (metricMatch) {
                    achievementBullet = `Track record of results: ${metricMatch[0]} and growing`;
                }
            }

            // Build keyword-rich summary
            const keywordStr = keywords.slice(0, 3).join(', ');
            const additionalKeywords = keywords.slice(3, 6).join(', ');

            // Generate summary that addresses specific issues
            let summary = `${level.charAt(0).toUpperCase() + level.slice(1)} ${role} with ${years}+ years of experience in ${keywordStr || 'driving business results'}.`;

            // Add hook (first 3 lines are visible before "see more")
            summary += `

I help organizations ${keywords[0] ? `leverage ${keywords[0]}` : 'solve complex challenges'} to achieve measurable outcomes. My approach combines strategic thinking with hands-on execution.`;

            // Add structured expertise section (addresses "Clear structure/paragraphs")
            summary += `

WHAT I BRING:
‚Ä¢ ${achievementBullet}
‚Ä¢ Deep expertise in ${keywords[0] || 'core competencies'} and ${keywords[1] || 'cross-functional collaboration'}
‚Ä¢ ${additionalKeywords ? `Experience with ${additionalKeywords}` : 'Collaborative leadership focused on team growth'}`;

            // Add metrics section if needed (addresses "No quantified achievements")
            if (needsMetrics) {
                summary += `

RECENT IMPACT:
‚Ä¢ [Add: Specific metric from your most impressive project]
‚Ä¢ [Add: Team size or budget you've managed]
‚Ä¢ [Add: Efficiency gain or revenue impact]`;
            }

            // Add CTA (addresses "Has call-to-action" criterion)
            summary += `

Currently exploring ${role} opportunities where I can leverage my experience in ${keywords[0] || 'the field'} to drive meaningful outcomes.

‚ûú Let's connect: [Your email] | Open to conversations about ${role} roles`;

            return summary;
        }

        function generateSkillsRecommendations() {
            const targetKeywords = analysisData?.ats_keywords || analysisData?.required_skills || [];
            const currentSkills = linkedinData?.skills || [];

            // Skills to add (from job requirements not in current skills)
            const skillsToAdd = targetKeywords
                .filter(kw => !currentSkills.some(s => s.toLowerCase().includes(kw.toLowerCase())))
                .slice(0, 8);

            // Generic skills to potentially remove
            const genericSkills = ['Microsoft Office', 'Microsoft Word', 'Microsoft Excel', 'PowerPoint', 'Communication', 'Teamwork', 'Problem Solving'];
            const skillsToRemove = currentSkills
                .filter(s => genericSkills.some(g => s.toLowerCase().includes(g.toLowerCase())))
                .slice(0, 3);

            return {
                add: skillsToAdd.length > 0 ? skillsToAdd : ['Add skills from the job description'],
                remove: skillsToRemove
            };
        }

        function copyToClipboard(btn, elementId) {
            const text = document.getElementById(elementId).textContent;
            navigator.clipboard.writeText(text).then(() => {
                btn.classList.add('copied');
                btn.innerHTML = '<span>‚úì</span> Copied!';
                setTimeout(() => {
                    btn.classList.remove('copied');
                    btn.innerHTML = '<span>üìã</span> Copy';
                }, 2000);
            });
        }
    </script>

    <script src="components/analytics.js"></script>
    <script src="components/hey-henry.js"></script>
    <script src="components/admin-alerts.js"></script>
    <script src="components/strategy-nav.js"></script>
    <script src="components/status-banner.js"></script>
    <script src="components/top-nav.js"></script>
</body>
</html>

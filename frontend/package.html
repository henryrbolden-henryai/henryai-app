<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Your Application Package ‚Äî HenryAI</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Instrument+Serif:ital@0;1&family=DM+Sans:opsz,wght@9..40,400;9..40,500;9..40,600&display=swap" rel="stylesheet">
    <style>
        :root {
            --color-bg: #0a0a0b;
            --color-surface: #141416;
            --color-surface-elevated: #1c1c1f;
            --color-border: rgba(255, 255, 255, 0.08);
            --color-border-hover: rgba(255, 255, 255, 0.15);
            --color-text: #fafafa;
            --color-text-secondary: #a1a1aa;
            --color-accent: #22d3ee;
            --color-accent-muted: rgba(34, 211, 238, 0.15);
            --color-success: #4ade80;
            --color-warning: #fbbf24;
            --color-error: #f87171;
            --font-display: 'Instrument Serif', Georgia, serif;
            --font-body: 'DM Sans', -apple-system, sans-serif;
            --ease-out: cubic-bezier(0.16, 1, 0.3, 1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-body);
            background: var(--color-bg);
            color: var(--color-text);
            min-height: 100vh;
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
            padding: 40px 20px;
        }

        .container {
            max-width: 960px;
            margin: 0 auto;
        }

        /* BACK LINK */
        .back-link {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            color: var(--color-text-secondary);
            text-decoration: none;
            font-size: 0.9rem;
            margin-bottom: 32px;
            transition: color 0.2s ease;
        }

        .back-link:hover {
            color: var(--color-text);
        }

        /* HEADER */
        h1 {
            font-family: var(--font-display);
            font-size: clamp(1.75rem, 5vw, 2.5rem);
            font-weight: 400;
            line-height: 1.2;
            margin-bottom: 8px;
            letter-spacing: -0.02em;
        }

        .subtitle {
            font-size: 1rem;
            color: var(--color-text-secondary);
            margin-bottom: 32px;
        }

        /* PACKAGE ITEMS */
        .package-items {
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: 16px;
            padding: 8px;
            margin-bottom: 24px;
        }

        .package-item {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 16px;
            border-radius: 12px;
            transition: background 0.2s ease;
        }

        .package-item:hover {
            background: var(--color-surface-elevated);
        }

        .checkmark {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--color-success);
            color: var(--color-bg);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            font-weight: bold;
            flex-shrink: 0;
        }

        .item-info {
            flex: 1;
        }

        .item-name {
            font-size: 1rem;
            font-weight: 500;
            margin-bottom: 2px;
        }

        .item-desc {
            font-size: 0.85rem;
            color: var(--color-text-secondary);
        }

        /* STRATEGY BOX */
        .strategy-box {
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 24px;
        }

        .strategy-title {
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--color-text-secondary);
            margin-bottom: 16px;
        }

        .strategy-content {
            font-size: 0.95rem;
            line-height: 1.7;
            color: var(--color-text);
            margin-bottom: 16px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--color-border);
        }

        .strategy-content:last-child {
            margin-bottom: 0;
            padding-bottom: 0;
            border-bottom: none;
        }

        .strategy-label {
            font-weight: 600;
            color: var(--color-accent);
            margin-right: 8px;
        }

        .ats-keywords {
            font-family: 'SF Mono', 'Monaco', 'Consolas', monospace;
            font-size: 0.85rem;
            color: var(--color-text-secondary);
        }

        /* TALKING POINTS */
        .talking-points {
            list-style: none;
            padding: 0;
        }

        .talking-points li {
            padding: 12px 0;
            padding-left: 28px;
            position: relative;
            font-size: 0.95rem;
            line-height: 1.5;
            color: var(--color-text-secondary);
            border-bottom: 1px solid var(--color-border);
        }

        .talking-points li:last-child {
            border-bottom: none;
            padding-bottom: 0;
        }

        .talking-points li:first-child {
            padding-top: 0;
        }

        .talking-points li::before {
            content: "‚Üí";
            position: absolute;
            left: 0;
            color: var(--color-accent);
            font-weight: bold;
        }

        /* BUTTONS */
        .button-group {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-top: 32px;
        }

        button {
            width: 100%;
            border: none;
            border-radius: 12px;
            padding: 18px 24px;
            font-size: 1rem;
            font-weight: 600;
            font-family: var(--font-body);
            cursor: pointer;
            transition: all 0.25s var(--ease-out);
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }

        .btn-primary {
            background: var(--color-text);
            color: var(--color-bg);
        }

        .btn-primary:hover:not(:disabled) {
            background: var(--color-accent);
            transform: translateY(-2px);
            box-shadow: 0 8px 32px rgba(34, 211, 238, 0.25);
        }

        .btn-secondary {
            background: transparent;
            color: var(--color-text);
            border: 1px solid var(--color-border);
        }

        .btn-secondary:hover:not(:disabled) {
            background: var(--color-surface);
            border-color: var(--color-text-secondary);
        }

        /* SUCCESS MESSAGE */
        .success-message {
            background: rgba(74, 222, 128, 0.1);
            border: 1px solid rgba(74, 222, 128, 0.3);
            border-radius: 12px;
            padding: 16px;
            margin-top: 16px;
            color: var(--color-success);
            text-align: center;
            font-size: 0.95rem;
            display: none;
        }

        .success-message.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-8px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* START OVER LINK */
        .start-over {
            text-align: center;
            margin-top: 32px;
        }

        .start-over a {
            color: var(--color-text-secondary);
            text-decoration: none;
            font-size: 0.9rem;
            transition: color 0.2s ease;
        }

        .start-over a:hover {
            color: var(--color-text);
        }

        /* PREVIEW SECTION */
        .preview-section {
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 24px;
        }

        .preview-header {
            margin-bottom: 20px;
        }

        .preview-header h3 {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 6px;
        }

        .preview-header p {
            color: var(--color-text-secondary);
            font-size: 0.9rem;
        }

        .preview-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
        }

        .preview-tab {
            padding: 10px 20px;
            background: var(--color-bg);
            border: 1px solid var(--color-border);
            border-radius: 8px;
            color: var(--color-text-secondary);
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .preview-tab:hover {
            border-color: var(--color-border-hover);
            color: var(--color-text);
        }

        .preview-tab.active {
            background: var(--color-accent-muted);
            border-color: var(--color-accent);
            color: var(--color-accent);
        }

        .preview-content textarea {
            width: 100%;
            min-height: 400px;
            padding: 20px;
            background: var(--color-bg);
            border: 1px solid var(--color-border);
            border-radius: 12px;
            color: var(--color-text);
            font-family: 'SF Mono', 'Monaco', 'Consolas', monospace;
            font-size: 0.85rem;
            line-height: 1.6;
            resize: vertical;
        }

        .preview-content textarea:focus {
            outline: none;
            border-color: var(--color-accent);
        }

        .outreach-content {
            padding: 20px;
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: 12px;
            max-height: 500px;
            overflow-y: auto;
        }

        .outreach-content h4 {
            margin-top: 0;
        }

        /* Outreach tab styles */
        #outreachPreview {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .outreach-instructions {
            background: var(--color-surface-elevated);
            border: 1px solid var(--color-border);
            border-radius: 8px;
            padding: 16px;
        }

        .outreach-instructions h4 {
            font-size: 0.9rem;
            font-weight: 600;
            margin: 0 0 10px 0;
            color: var(--color-text-secondary);
        }

        .outreach-instructions #linkedinHelp {
            font-size: 0.85rem;
            line-height: 1.6;
            color: var(--color-text-secondary);
            white-space: pre-wrap;
        }

        .outreach-message-box {
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: 8px;
            overflow: hidden;
        }

        .outreach-message-header {
            padding: 12px 16px;
            border-bottom: 1px solid var(--color-border);
            background: var(--color-bg);
        }

        .outreach-message-header h4 {
            font-size: 0.9rem;
            font-weight: 600;
            margin: 0 0 4px 0;
            color: var(--color-text);
        }

        .outreach-subject {
            font-size: 0.8rem;
            color: var(--color-text-secondary);
        }

        .outreach-subject span {
            color: var(--color-text);
            font-weight: 500;
        }

        .outreach-message-box textarea {
            width: 100%;
            min-height: 120px;
            padding: 16px;
            background: var(--color-surface);
            border: none;
            color: var(--color-text);
            font-family: var(--font-body);
            font-size: 0.9rem;
            line-height: 1.6;
            resize: vertical;
        }

        .outreach-message-box textarea:focus {
            outline: none;
            background: var(--color-surface-elevated);
        }

        /* SCREENING QUESTIONS SECTION */
        .screening-questions-section {
            margin-top: 40px;
            padding-top: 32px;
            border-top: 1px solid var(--color-border);
        }

        .screening-questions-header {
            margin-bottom: 20px;
        }

        .screening-questions-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--color-text);
            margin-bottom: 8px;
        }

        .screening-questions-subtitle {
            font-size: 0.9rem;
            color: var(--color-text-secondary);
            line-height: 1.6;
        }

        .screening-questions-input-box {
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 16px;
        }

        .screening-questions-input-box textarea {
            width: 100%;
            min-height: 150px;
            padding: 16px;
            background: var(--color-bg);
            border: 1px solid var(--color-border);
            border-radius: 8px;
            color: var(--color-text);
            font-family: var(--font-body);
            font-size: 0.9rem;
            line-height: 1.6;
            resize: vertical;
        }

        .screening-questions-input-box textarea:focus {
            outline: none;
            border-color: var(--color-accent);
        }

        .screening-questions-input-box textarea::placeholder {
            color: var(--color-text-secondary);
        }

        .btn-generate-responses {
            width: 100%;
            padding: 14px 24px;
            background: var(--color-accent);
            color: var(--color-bg);
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            margin-top: 12px;
        }

        .btn-generate-responses:hover:not(:disabled) {
            background: #5eead4;
            transform: translateY(-2px);
        }

        .btn-generate-responses:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .screening-responses-container {
            margin-top: 24px;
            display: none;
        }

        .screening-responses-container.active {
            display: block;
        }

        .screening-response-card {
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 16px;
        }

        .screening-response-card.gap-detected {
            border-color: var(--color-warning);
            background: rgba(251, 191, 36, 0.05);
        }

        .screening-question-text {
            font-size: 0.95rem;
            font-weight: 600;
            color: var(--color-text);
            margin-bottom: 12px;
            line-height: 1.5;
        }

        .screening-response-text {
            font-size: 0.9rem;
            color: var(--color-text);
            line-height: 1.7;
            padding: 16px;
            background: var(--color-bg);
            border-radius: 8px;
            margin-bottom: 12px;
            white-space: pre-wrap;
        }

        .screening-strategic-note {
            font-size: 0.85rem;
            color: var(--color-accent);
            padding: 12px 16px;
            background: var(--color-accent-muted);
            border-radius: 8px;
            margin-bottom: 12px;
        }

        .screening-strategic-note::before {
            content: "Strategy: ";
            font-weight: 600;
        }

        .screening-gap-warning {
            font-size: 0.85rem;
            color: var(--color-warning);
            padding: 12px 16px;
            background: rgba(251, 191, 36, 0.1);
            border-radius: 8px;
            border-left: 3px solid var(--color-warning);
        }

        .screening-gap-warning::before {
            content: "‚ö†Ô∏è Gap Detected: ";
            font-weight: 600;
        }

        .screening-overall-strategy {
            font-size: 0.9rem;
            color: var(--color-text-secondary);
            padding: 16px;
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: 8px;
            margin-top: 20px;
            line-height: 1.6;
        }

        .screening-overall-strategy strong {
            color: var(--color-text);
        }

        .copy-response-btn {
            padding: 8px 16px;
            background: transparent;
            color: var(--color-text-secondary);
            border: 1px solid var(--color-border);
            border-radius: 6px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s;
            margin-top: 8px;
        }

        .copy-response-btn:hover {
            background: var(--color-surface-elevated);
            color: var(--color-text);
            border-color: var(--color-accent);
        }

        .copy-response-btn.copied {
            background: var(--color-success);
            color: var(--color-bg);
            border-color: var(--color-success);
        }

        /* SIMILAR ROLES SECTION */
        .similar-roles-section {
            margin-top: 40px;
            padding-top: 32px;
            border-top: 1px solid var(--color-border);
        }

        .similar-roles-header {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            margin-bottom: 20px;
        }

        .similar-roles-icon {
            font-size: 1.25rem;
            line-height: 1;
        }

        .similar-roles-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--color-text);
        }

        .similar-roles-subtitle {
            font-size: 0.85rem;
            color: var(--color-text-secondary);
            margin-top: 2px;
        }

        .similar-roles-coming-soon {
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: 12px;
            padding: 20px;
            color: var(--color-text-secondary);
            font-size: 0.95rem;
            line-height: 1.6;
        }

        .manual-search-links {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 16px;
        }

        .manual-search-link {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: var(--color-bg);
            border: 1px solid var(--color-border);
            padding: 8px 14px;
            border-radius: 8px;
            color: var(--color-text);
            text-decoration: none;
            font-size: 0.85rem;
            transition: border-color 0.2s, background 0.2s;
        }

        .manual-search-link:hover {
            border-color: var(--color-accent);
            background: var(--color-accent-muted);
        }

        .manual-search-link img {
            width: 16px;
            height: 16px;
            border-radius: 2px;
        }

        /* RESPONSIVE */
        @media (min-width: 640px) {
            body {
                padding: 60px 24px;
            }

            .button-group {
                flex-direction: row;
            }

            button {
                flex: 1;
            }
        }

        /* TWO COLUMN LAYOUT */
        .two-column-layout {
            display: grid;
            grid-template-columns: 1fr;
            gap: 24px;
            margin-bottom: 24px;
        }

        @media (min-width: 900px) {
            .two-column-layout {
                grid-template-columns: 340px 1fr;
                gap: 32px;
            }
        }

        .left-column {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .right-column {
            display: flex;
            flex-direction: column;
        }

        .right-column .preview-section {
            flex: 1;
            margin-bottom: 0;
        }

        .right-column .preview-content textarea {
            min-height: 350px;
        }

        .right-column .outreach-content {
            max-height: 350px;
        }

        /* HEADER */
        header {
            padding: 24px 0;
            border-bottom: 1px solid var(--color-border);
            margin-bottom: 32px;
        }

        header .header-container {
            max-width: 960px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-family: var(--font-display);
            font-size: 1.5rem;
            color: var(--color-text);
            text-decoration: none;
        }

        .logo em {
            font-style: italic;
            color: var(--color-accent);
        }

        .header-nav {
            display: flex;
            gap: 24px;
            align-items: center;
        }

        .nav-link {
            color: var(--color-text-secondary);
            text-decoration: none;
            font-size: 0.9rem;
            transition: color 0.2s ease;
        }

        .nav-link:hover {
            color: var(--color-accent);
        }
    </style>
</head>
<body>
    <!-- HEADER -->
    <header>
        <div class="header-container">
            <a href="index.html" class="logo"><em>Henry</em>AI</a>
            <nav class="header-nav">
                <a href="tracker.html" class="nav-link">Command Center</a>
                <a href="profile-edit.html" class="nav-link">Edit Profile</a>
            </nav>
        </div>
    </header>

    <div class="container">
        <a href="results.html" class="back-link">‚Üê Back to Analysis</a>

        <h1>Your application package is ready</h1>
        <p class="subtitle">Everything you need to apply for this role, tailored to stand out.</p>

        <!-- POSITIONING STRATEGY (moved above package items) -->
        <div class="strategy-box" id="positioningSection" style="background: var(--color-accent-muted); border: 1px solid var(--color-accent);">
            <div class="strategy-title" style="color: var(--color-accent);">Your Positioning Strategy</div>
            <p style="font-size: 1.05rem; line-height: 1.7; color: var(--color-text); margin: 0;">
                <strong><span id="candidateNameStrategy"></span>,</strong> <span id="positioningStrategy"></span>
            </p>
        </div>

        <!-- TWO COLUMN LAYOUT -->
        <div class="two-column-layout">
            <!-- LEFT COLUMN: Checkboxes + What Changed -->
            <div class="left-column">
                <div class="package-items">
                    <div class="package-item">
                        <div class="checkmark">‚úì</div>
                        <div class="item-info">
                            <div class="item-name">Tailored Resume</div>
                            <div class="item-desc">ATS-optimized with keywords from the job description</div>
                        </div>
                    </div>
                    <div class="package-item">
                        <div class="checkmark">‚úì</div>
                        <div class="item-info">
                            <div class="item-name">Cover Letter</div>
                            <div class="item-desc">Custom letter that positions your experience for this role</div>
                        </div>
                    </div>
                </div>

                <!-- WHAT CHANGED (always visible) -->
                <div class="strategy-box" style="margin-bottom: 0;">
                    <div class="strategy-title">What Changed & Why</div>
                    <div style="margin-top: 16px;">
                        <div class="strategy-content" id="resumeRationale">
                            <span class="strategy-label">Resume:</span>
                            <span id="resumeRationaleText">Loading...</span>
                        </div>
                        <div class="strategy-content" id="coverLetterRationale">
                            <span class="strategy-label">Cover Letter:</span>
                            <span id="coverLetterRationaleText">Loading...</span>
                        </div>
                        <div class="strategy-content" id="atsKeywordsSection" style="display: none;">
                            <span class="strategy-label">ATS Keywords:</span>
                            <span id="atsKeywordsText" class="ats-keywords"></span>
                        </div>
                        <!-- Enhanced Keyword Analysis Section -->
                        <div id="keywordAnalysisSection" style="display: none; margin-top: 16px; padding: 16px; background: rgba(16, 185, 129, 0.08); border: 1px solid rgba(16, 185, 129, 0.2); border-radius: 8px;">
                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
                                <span style="font-size: 1.1rem;">üìä</span>
                                <span style="font-weight: 600; color: #10b981;">ATS Keyword Coverage</span>
                            </div>
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; font-size: 0.85rem;">
                                <div>
                                    <div style="color: #9ca3af; margin-bottom: 4px;">Tier 1 (Critical)</div>
                                    <div id="tier1Keywords" style="color: #ffffff;"></div>
                                    <div id="tier1Count" style="color: #10b981; font-size: 0.8rem; margin-top: 2px;"></div>
                                </div>
                                <div>
                                    <div style="color: #9ca3af; margin-bottom: 4px;">Tier 2 (Important)</div>
                                    <div id="tier2Keywords" style="color: #ffffff;"></div>
                                    <div id="tier2Count" style="color: #10b981; font-size: 0.8rem; margin-top: 2px;"></div>
                                </div>
                                <div>
                                    <div style="color: #9ca3af; margin-bottom: 4px;">Tier 3 (Nice-to-have)</div>
                                    <div id="tier3Keywords" style="color: #ffffff;"></div>
                                    <div id="tier3Count" style="color: #10b981; font-size: 0.8rem; margin-top: 2px;"></div>
                                </div>
                            </div>
                        </div>
                        <!-- Positioning Strategy Section -->
                        <div id="positioningStrategySection" style="display: none; margin-top: 12px; padding: 12px; background: rgba(96, 165, 250, 0.08); border: 1px solid rgba(96, 165, 250, 0.2); border-radius: 8px;">
                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                <span style="font-size: 1rem;">üéØ</span>
                                <span style="font-weight: 600; color: #60a5fa;">Positioning Strategy</span>
                            </div>
                            <div id="positioningDetails" style="font-size: 0.85rem; color: #d1d5db;"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- RIGHT COLUMN: Review & Edit Documents -->
            <div class="right-column">
                <div class="preview-section" style="margin-bottom: 0;">
                    <div class="preview-header">
                        <h3>Review & Edit Your Documents</h3>
                        <p>Make any final adjustments before downloading.</p>
                    </div>
                    
                    <div class="preview-tabs">
                        <button class="preview-tab active" data-tab="resume">Resume</button>
                        <button class="preview-tab" data-tab="coverletter">Cover Letter</button>
                        <button class="preview-tab" data-tab="outreach">Outreach</button>
                    </div>

                    <div class="preview-content" id="resumePreview">
                        <textarea id="resume-editor" placeholder="Your tailored resume will appear here..."></textarea>
                    </div>
                    
                    <div class="preview-content" id="coverletterPreview" style="display: none;">
                        <textarea id="coverletter-editor" placeholder="Your cover letter will appear here..."></textarea>
                    </div>

                    <div class="preview-content" id="outreachPreview" style="display: none;">
                        <!-- Box 1: Instructions (not editable) -->
                        <div class="outreach-instructions">
                            <h4>Find the Right People on LinkedIn</h4>
                            <div id="linkedinHelp"></div>
                        </div>

                        <!-- Box 2: Hiring Manager Message (editable) -->
                        <div class="outreach-message-box">
                            <div class="outreach-message-header">
                                <h4>Hiring Manager Message</h4>
                                <span class="outreach-subject">Subject: <span id="hiringManagerSubject"></span></span>
                            </div>
                            <textarea id="hiringManagerOutreach" placeholder="Your hiring manager outreach message..."></textarea>
                        </div>

                        <!-- Box 3: Recruiter Message (editable) -->
                        <div class="outreach-message-box">
                            <div class="outreach-message-header">
                                <h4>Recruiter Message <span style="font-weight: 400; color: var(--color-text-secondary);">(Optional)</span></h4>
                                <span class="outreach-subject">Subject: <span id="recruiterSubject"></span></span>
                            </div>
                            <textarea id="recruiterOutreach" placeholder="Your recruiter outreach message..."></textarea>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="button-group">
            <button class="btn-primary" id="downloadBtn">Download All</button>
            <button class="btn-secondary" id="trackBtn">Track This Application</button>
            <button class="btn-secondary" onclick="window.location.href='tracker.html'">View My Tracker</button>
        </div>

        <div class="success-message" id="successMessage">
            ‚úì Package downloaded successfully ‚Äî good luck with your application!
        </div>
        
        <div class="success-message" id="trackSuccessMessage" style="display: none;">
            ‚úì Added to your application tracker ‚Äî <a href="tracker.html" style="color: var(--color-accent);">View Tracker</a>
        </div>

        <!-- SCREENING QUESTIONS SECTION -->
        <div class="screening-questions-section" id="screeningQuestionsSection">
            <div class="screening-questions-header">
                <div class="screening-questions-title">Application Screening Questions</div>
                <p class="screening-questions-subtitle">
                    Many applications include screening questions that are weighted heavily in ATS scoring.
                    Paste any screening questions below and I'll generate tailored responses based on your background‚Äîno fabrication, just strategic positioning.
                </p>
            </div>

            <div class="screening-questions-input-box">
                <textarea
                    id="screeningQuestionsInput"
                    placeholder="Paste screening questions here. For example:

1. Describe your experience with cross-functional stakeholder management in a B2B SaaS environment (250 words).

2. How many years of experience do you have managing product roadmaps for enterprise clients?

3. Describe a time you drove adoption of a new product feature in a regulated industry."
                ></textarea>
                <button class="btn-generate-responses" id="generateResponsesBtn">Generate Responses</button>
            </div>

            <div class="screening-responses-container" id="screeningResponsesContainer">
                <!-- Responses will be dynamically inserted here -->
            </div>
        </div>

        <!-- SIMILAR ROLES SECTION -->
        <div class="similar-roles-section" id="similarRolesSection">
            <div class="similar-roles-header">
                <span class="similar-roles-icon">üí¨</span>
                <div>
                    <div class="similar-roles-title" id="similarRolesTitle">One more thing!</div>
                </div>
            </div>
            
            <div class="similar-roles-coming-soon">
                <p id="similarRolesMessage" style="line-height: 1.7;">I know this market is brutal. You're not imagining it: 300+ applicants per role, ghosting from companies you'd be perfect for, algorithms that don't see your value. It's exhausting, and it's not your fault.</p>
                <p style="margin-top: 16px; line-height: 1.7;">I'm building something to help. Automatic alerts for roles that match your experience, posted in the last 24 hours, before the flood of applicants. You'll be first in line, not lost in a pile.</p>
                <p style="margin-top: 16px; font-size: 0.9rem; color: var(--color-text-secondary);">That's coming soon. For now, these searches are pre-built for you:</p>
                <div class="manual-search-links" id="manualSearchLinks">
                    <!-- Populated by JavaScript -->
                </div>
            </div>
        </div>

        <div class="start-over">
            <a href="analyze.html">‚Üê Analyze Another Role</a>
        </div>
    </div>

  <script>
        // ========================================================================
        // CONFIGURATION
        // ========================================================================
        const API_BASE_URL = window.location.hostname === 'localhost'
            ? 'http://localhost:8000'
            : 'https://henryai-app-production.up.railway.app';

        // ========================================================================
        // LOAD DATA
        // ========================================================================
        const analysisData = JSON.parse(sessionStorage.getItem('analysisData'));

        // Redirect if no data
        if (!analysisData) {
            window.location.href = 'index.html';
        }

        console.log('Package page data:', analysisData);

        // ========================================================================
        // POPULATE "WHAT I CHANGED & WHY"
        // ========================================================================
        // This data comes from /api/jd/analyze (intelligence_layer) 
        
        let resumeRationaleText = 'Tailored to match job requirements.';
        let coverLetterRationaleText = 'Customized to highlight relevant experience.';
        let atsKeywords = [];

        console.log('Analysis data for rationale:', analysisData);
        
        // Check if we have changes_summary from documents/generate or jd/analyze
        if (analysisData.changes_summary) {
            const cs = analysisData.changes_summary;
            if (cs.resume?.summary_rationale) {
                resumeRationaleText = cs.resume.summary_rationale;
                if (cs.resume.qualifications_rationale) {
                    resumeRationaleText += ' ' + cs.resume.qualifications_rationale;
                }
            }
            if (cs.cover_letter?.opening_rationale) {
                coverLetterRationaleText = cs.cover_letter.opening_rationale;
                if (cs.cover_letter.body_rationale) {
                    coverLetterRationaleText += ' ' + cs.cover_letter.body_rationale;
                }
            }
            if (cs.resume?.ats_keywords && cs.resume.ats_keywords.length > 0) {
                atsKeywords = cs.resume.ats_keywords;
            }
        }
        // Or check intelligence_layer from /api/jd/analyze
        else if (analysisData.intelligence_layer?.strategic_positioning) {
            const sp = analysisData.intelligence_layer.strategic_positioning;
            if (sp.positioning_strategy) {
                resumeRationaleText = sp.positioning_strategy;
            }
            if (sp.emphasis_points && sp.emphasis_points.length > 0) {
                coverLetterRationaleText = 'Emphasized: ' + sp.emphasis_points.slice(0, 2).join('; ');
            } else if (sp.lead_with_strengths && sp.lead_with_strengths.length > 0) {
                coverLetterRationaleText = 'Emphasized: ' + sp.lead_with_strengths.slice(0, 2).join('; ');
            }
        }
        // Fallback to strengths if available
        else if (analysisData.strengths && analysisData.strengths.length > 0) {
            resumeRationaleText = 'Highlighted your key strengths: ' + analysisData.strengths.slice(0, 2).join('; ');
            coverLetterRationaleText = 'Positioned you based on: ' + analysisData.strengths.slice(0, 2).join('; ');
        }
        // Final fallback - use fit explanation
        else if (analysisData.fit_score_explanation) {
            resumeRationaleText = analysisData.fit_score_explanation;
            coverLetterRationaleText = 'Tailored to address fit with role requirements.';
        }

        // Get ATS keywords from various sources if not already set
        if (atsKeywords.length === 0 && analysisData.ats_keywords) {
            atsKeywords = analysisData.ats_keywords.slice(0, 7);
        }

        document.getElementById('resumeRationaleText').textContent = resumeRationaleText;
        document.getElementById('coverLetterRationaleText').textContent = coverLetterRationaleText;
        
        // Show ATS keywords if we have them
        if (atsKeywords.length > 0) {
            document.getElementById('atsKeywordsSection').style.display = 'block';
            document.getElementById('atsKeywordsText').textContent = atsKeywords.join(' ‚Ä¢ ');
        }

        // ========================================================================
        // HELPER: Convert to title case (for names)
        // ========================================================================
        function toTitleCase(str) {
            if (!str) return '';
            // If all caps, convert to title case
            if (str === str.toUpperCase()) {
                return str.toLowerCase().replace(/\b\w/g, c => c.toUpperCase());
            }
            return str;
        }

        // ========================================================================
        // POPULATE: Positioning Strategy with Candidate Name
        // ========================================================================
        const positioningStrategy = analysisData.positioning_strategy ||
                                    analysisData.intelligence_layer?.strategic_positioning?.positioning_strategy ||
                                    analysisData.strategic_positioning ||
                                    '';
        
        const positioningEl = document.getElementById('positioningStrategy');
        const positioningSection = document.getElementById('positioningSection');
        const candidateNameStrategyEl = document.getElementById('candidateNameStrategy');
        
        // Get and format candidate name
        let candidateName = analysisData._candidate_name || 'You';
        candidateName = toTitleCase(candidateName);
        // Use first name only
        const firstName = candidateName.split(' ')[0];
        candidateNameStrategyEl.textContent = firstName;
        
        if (positioningStrategy) {
            // Lowercase first letter since name provides the capital
            let strategyText = positioningStrategy;
            if (strategyText && firstName !== 'You') {
                strategyText = strategyText.charAt(0).toLowerCase() + strategyText.slice(1);
            }
            positioningEl.textContent = strategyText;
        } else {
            // Hide section if no strategy available
            positioningSection.style.display = 'none';
        }

        // ========================================================================
        // POPULATE: Outreach Templates with Subject Lines
        // ========================================================================
        const outreach = analysisData.outreach || 
                        analysisData.intelligence_layer?.outreach || 
                        {};
        
        const outreachSection = document.getElementById('outreachSection');
        const company = analysisData._company || analysisData.company || 'the company';
        const role = analysisData._role || analysisData.role_title || 'this role';
        
        // LinkedIn help (Step 1)
        const linkedinHelp = outreach.linkedin_help_text || 
                            analysisData.linkedin_help_text ||
                            'Search LinkedIn for the company name + "recruiter" or "hiring manager" to find the right people to contact.';
        document.getElementById('linkedinHelp').textContent = linkedinHelp;
        
        // Hiring Manager message (Step 2)
        const hiringManagerSubject = outreach.hiring_manager_subject || 
                                    `Interest in ${role} at ${company}`;
        document.getElementById('hiringManagerSubject').textContent = hiringManagerSubject;
        
        const hiringManagerMsg = outreach.hiring_manager || 
                                analysisData.hiring_manager_outreach ||
                                'Message not available for this role.';
        document.getElementById('hiringManagerOutreach').value = hiringManagerMsg;
        
        // Recruiter message (Step 3)
        const recruiterSubject = outreach.recruiter_subject || 
                                `Application for ${role} - ${firstName}`;
        document.getElementById('recruiterSubject').textContent = recruiterSubject;
        
        const recruiterMsg = outreach.recruiter || 
                            analysisData.recruiter_outreach ||
                            'Message not available for this role.';
        document.getElementById('recruiterOutreach').value = recruiterMsg;
        
        // Hide outreach section if no messages available
        if (!hiringManagerMsg || hiringManagerMsg === 'Message not available for this role.') {
            if (!recruiterMsg || recruiterMsg === 'Message not available for this role.') {
                outreachSection.style.display = 'none';
            }
        }

        // ========================================================================
        // STATE FOR GENERATED DOCUMENTS
        // ========================================================================
        let generatedDocuments = null;

        // ========================================================================
        // HELPER: Parse candidate info from resume text
        // ========================================================================
        function parseCandidateInfo(resumeText) {
            const lines = (resumeText || '').split('\n').filter(l => l.trim());
            
            // Default values
            let fullName = analysisData._candidate_name || 'CANDIDATE NAME';
            let titleLine = '';
            let contactLine = '';
            
            // Collect header lines (before first section)
            let headerLines = [];
            for (let i = 0; i < Math.min(15, lines.length); i++) {
                const line = lines[i].trim();
                if (!line) continue;
                // Stop at section headers
                if (line.match(/^(PROFESSIONAL\s*SUMMARY|SUMMARY|EXPERIENCE|EDUCATION|SKILLS|CORE\s*COMPETENCIES|KEY\s*QUALIFICATIONS)/i)) {
                    break;
                }
                headerLines.push(line);
            }
            
            // Parse header lines
            for (let i = 0; i < headerLines.length; i++) {
                const line = headerLines[i];
                
                // First line is the name
                if (i === 0) {
                    fullName = line;
                    continue;
                }
                
                // Skip LinkedIn/Portfolio/GitHub links
                if (line.toLowerCase().includes('linkedin') || 
                    line.toLowerCase().includes('portfolio') ||
                    line.toLowerCase().includes('github') ||
                    line.toLowerCase().includes('http')) {
                    continue;
                }
                
                // Look for contact line (contains email or phone)
                if (line.includes('@') || line.match(/\(\d{3}\)|\d{3}[-.\s]\d{3}[-.\s]\d{4}/)) {
                    if (contactLine) {
                        contactLine += ' | ' + line;
                    } else {
                        contactLine = line;
                    }
                    continue;
                }
            }
            
            // ================================================================
            // BUILD TITLE LINE - Use target role + verified competencies
            // ================================================================
            
            // Start with target role
            const targetRole = analysisData._role || analysisData.role_title || 'Professional';
            titleLine = targetRole;
            
            // Get competencies to add (from API response or inferred)
            const competenciesToAdd = [];
            
            // Priority 1: Use headline from API if it's good
            const apiHeadline = analysisData.resume_output?.headline || analysisData.headline || '';
            if (apiHeadline && apiHeadline.includes('|')) {
                // API provided a headline with competencies - extract them
                const parts = apiHeadline.split('|').map(p => p.trim()).filter(p => p);
                // Skip first part (role title), add rest as competencies
                for (let i = 1; i < parts.length && competenciesToAdd.length < 3; i++) {
                    const comp = parts[i];
                    // Filter out bad phrases
                    const badPhrases = ['experience working', 'various skill', 'expertise in', 'leadership experience'];
                    const isBad = badPhrases.some(bp => comp.toLowerCase().includes(bp));
                    if (!isBad && comp.length > 2 && comp.length < 30) {
                        competenciesToAdd.push(comp);
                    }
                }
            }
            
            // Priority 2: Extract from required_skills or strengths
            if (competenciesToAdd.length < 2) {
                const skills = analysisData.required_skills || analysisData.ats_keywords || [];
                const strengths = analysisData.strengths || [];
                
                // Helper to clean a skill
                const cleanSkill = (skill) => {
                    if (!skill) return null;
                    let cleaned = skill.trim();
                    // Remove leading filler words
                    const fillers = ['strong', 'excellent', 'proven', 'demonstrated', 'experience with', 'experience in', 'expertise in', 'skilled in'];
                    for (const f of fillers) {
                        if (cleaned.toLowerCase().startsWith(f)) {
                            cleaned = cleaned.substring(f.length).trim();
                        }
                    }
                    // Limit length
                    if (cleaned.length > 25) {
                        cleaned = cleaned.split(' ').slice(0, 3).join(' ');
                    }
                    // Title case
                    cleaned = cleaned.split(' ')
                        .filter(w => w.length > 0)
                        .map(w => w.charAt(0).toUpperCase() + w.slice(1).toLowerCase())
                        .join(' ');
                    return cleaned.length >= 3 && cleaned.length <= 25 ? cleaned : null;
                };
                
                // Try skills first
                for (const skill of skills) {
                    if (competenciesToAdd.length >= 3) break;
                    const cleaned = cleanSkill(skill);
                    if (cleaned && !competenciesToAdd.includes(cleaned) && 
                        !titleLine.toLowerCase().includes(cleaned.toLowerCase().split(' ')[0])) {
                        competenciesToAdd.push(cleaned);
                    }
                }
                
                // Then strengths
                for (const strength of strengths) {
                    if (competenciesToAdd.length >= 3) break;
                    // Extract first phrase from strength
                    const match = strength.match(/^([^,\-‚Äì:]+)/);
                    if (match) {
                        const cleaned = cleanSkill(match[1]);
                        if (cleaned && !competenciesToAdd.includes(cleaned) &&
                            !titleLine.toLowerCase().includes(cleaned.toLowerCase().split(' ')[0])) {
                            competenciesToAdd.push(cleaned);
                        }
                    }
                }
            }
            
            // Build final title line
            if (competenciesToAdd.length > 0) {
                titleLine = targetRole + ' | ' + competenciesToAdd.slice(0, 3).join(' | ');
            }
            
            // Final cleanup - remove any filler phrases that snuck through
            const badPatterns = [
                /\|\s*experience working with\s*\|?/gi,
                /\|\s*various skills?\s*\|?/gi,
                /\|\s*expertise in\s*\|?/gi,
                /\|\s*leadership experience\s*\|?/gi,
                /\|\s*professional experience\s*\|?/gi,
                /\|\s*skilled in\s*\|?/gi,
                /\|\s*\|/g,  // double pipes
                /\|\s*$/,    // trailing pipe
                /^\s*\|/     // leading pipe
            ];
            for (const pattern of badPatterns) {
                titleLine = titleLine.replace(pattern, '|').trim();
            }
            titleLine = titleLine.replace(/\|\s*\|/g, '|').replace(/\|\s*$/, '').replace(/^\s*\|/, '').trim();
            
            // If no contact found, create placeholder
            if (!contactLine) {
                contactLine = 'Contact information';
            }
            
            return { fullName, titleLine, contactLine };
        }

        // ========================================================================
        // HELPER: Parse resume sections from text
        // ========================================================================
        function parseResumeFromText(resumeText) {
            const lines = (resumeText || '').split('\n');
            
            const resume = {
                summary: '',
                competencies: [],
                experience: [],
                education: {},
                key_qualifications: []
            };
            
            let currentSection = '';
            let currentExperience = null;
            let summaryLines = [];
            let lastLineWasTitle = false;
            
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) {
                    lastLineWasTitle = false;
                    continue;
                }
                
                // Detect section headers
                const upperLine = line.toUpperCase();
                if (upperLine.match(/^PROFESSIONAL\s*SUMMARY|^SUMMARY$/)) {
                    currentSection = 'summary';
                    continue;
                } else if (upperLine.match(/^CORE\s*COMPETENCIES|^COMPETENCIES|^SKILLS$/)) {
                    currentSection = 'competencies';
                    continue;
                } else if (upperLine.match(/^PROFESSIONAL\s*EXPERIENCE|^EXPERIENCE|^WORK\s*HISTORY$/)) {
                    currentSection = 'experience';
                    continue;
                } else if (upperLine.match(/^EDUCATION$/)) {
                    // Save last experience entry before switching
                    if (currentExperience && currentExperience.title) {
                        resume.experience.push(currentExperience);
                        currentExperience = null;
                    }
                    currentSection = 'education';
                    continue;
                } else if (upperLine.match(/^KEY\s*QUALIFICATIONS/)) {
                    if (currentExperience && currentExperience.title) {
                        resume.experience.push(currentExperience);
                        currentExperience = null;
                    }
                    currentSection = 'qualifications';
                    continue;
                }
                
                // Parse content based on section
                if (currentSection === 'summary') {
                    summaryLines.push(line);
                } else if (currentSection === 'competencies') {
                    // Remove bullet characters and add each line
                    const cleanLine = line.replace(/^[\‚Ä¢\-\*\‚ñ∫\‚Üí]\s*/, '').trim();
                    if (cleanLine) {
                        resume.competencies.push(cleanLine);
                    }
                } else if (currentSection === 'experience') {
                    // Check if this line looks like a job title (usually followed by company on same or next line)
                    // Common patterns:
                    // Pattern 1: "Director of Talent Operations" (title on its own line)
                    // Pattern 2: "Company Name (Description) ‚Äî Location, State | 2021 ‚Äì 2025" (company with dates)
                    // Pattern 3: "Title | Company ‚Äî Location | 2020 ‚Äì Present" (combined line)
                    
                    const hasDate = line.match(/\d{4}\s*[-‚Äì‚Äî]\s*(Present|\d{4})/i);
                    const startsWithBullet = line.match(/^[\‚Ä¢\-\*\‚ñ∫\‚Üí‚óã‚óè‚ó¶‚ñ™‚ñ∏]/) || line.match(/^\d+\.\s/);
                    
                    // Also check if line looks like a bullet by content (starts lowercase, has action verb)
                    const looksLikeBulletContent = !hasDate && 
                        line.length > 20 && 
                        (line.match(/^[a-z]/) || // starts lowercase
                         line.match(/^(Led|Managed|Developed|Created|Built|Designed|Implemented|Spearheaded|Drove|Achieved|Reduced|Increased|Improved|Established|Launched|Delivered|Partnered|Collaborated|Scaled|Optimized)/i));
                    
                    const isBullet = startsWithBullet || looksLikeBulletContent;
                    
                    // Helper to extract location from company string
                    // e.g., "Arcadia Finance (Series C Fintech) ‚Äî New York, NY" => { company: "Arcadia Finance (Series C Fintech)", location: "New York, NY" }
                    const parseCompanyLocation = (str) => {
                        // Look for pattern: Company ‚Äî Location or Company - Location
                        const dashMatch = str.match(/^(.+?)\s*[-‚Äì‚Äî]\s*([A-Z][a-zA-Z\s]+,\s*[A-Z]{2})\s*$/);
                        if (dashMatch) {
                            return { company: dashMatch[1].trim(), location: dashMatch[2].trim() };
                        }
                        // Look for state abbreviations at end
                        const stateMatch = str.match(/^(.+?)\s*\|\s*([A-Z][a-zA-Z\s]+,\s*[A-Z]{2})\s*$/);
                        if (stateMatch) {
                            return { company: stateMatch[1].trim(), location: stateMatch[2].trim() };
                        }
                        return { company: str, location: '' };
                    };
                    
                    // Helper to generate company description from parenthetical info
                    // e.g., "Arcadia Finance", "Series C Fintech" => "Series C fintech company specializing in financial services"
                    const generateCompanyDescription = (companyName, parenInfo) => {
                        const info = parenInfo.toLowerCase();
                        const name = companyName.replace(/\s*\([^)]+\)\s*/g, '').trim();
                        
                        // Map common patterns to descriptions
                        if (info.includes('series a')) {
                            return `Early-stage startup focused on growth and product-market fit.`;
                        } else if (info.includes('series b')) {
                            return `Growth-stage company scaling operations and expanding market presence.`;
                        } else if (info.includes('series c') || info.includes('series d')) {
                            return `Late-stage startup with proven business model and significant scale.`;
                        } else if (info.includes('saas')) {
                            return `B2B SaaS company delivering cloud-based software solutions.`;
                        } else if (info.includes('fintech')) {
                            return `Financial technology company modernizing financial services.`;
                        } else if (info.includes('machine learning') || info.includes('ai') || info.includes('ml')) {
                            return `AI/ML company building intelligent automation solutions.`;
                        } else if (info.includes('startup')) {
                            return `High-growth startup in rapid scaling phase.`;
                        } else if (info.includes('enterprise')) {
                            return `Enterprise software company serving large organizations.`;
                        } else {
                            // Generic description based on parenthetical
                            return `${parenInfo} company.`;
                        }
                    };
                    
                    if (isBullet && currentExperience) {
                        // This is a bullet point
                        const bullet = line.replace(/^[\‚Ä¢\-\*\‚ñ∫\‚Üí‚óã‚óè‚ó¶‚ñ™‚ñ∏\d+\.]\s*/, '').trim();
                        if (bullet) {
                            currentExperience.bullets.push(bullet);
                        }
                    } else if (hasDate) {
                        // This line has dates - could be company line or combined title/company line
                        const dateMatch = line.match(/(\d{4}\s*[-‚Äì‚Äî]\s*(Present|\d{4}))/i);
                        const dates = dateMatch ? dateMatch[1] : '';
                        const beforeDates = dateMatch ? line.substring(0, dateMatch.index).trim() : line;
                        // Clean up trailing separators
                        const cleanBeforeDates = beforeDates.replace(/\s*\|\s*$/, '').replace(/\s*[-‚Äì‚Äî]\s*$/, '').trim();
                        
                        // Check if previous line was a job title (no date, not a bullet)
                        if (lastLineWasTitle && currentExperience && !currentExperience.company) {
                            // Previous line was the title, this line is company info
                            const { company, location } = parseCompanyLocation(cleanBeforeDates);
                            currentExperience.company = company;
                            currentExperience.location = location;
                            currentExperience.dates = dates;
                            // Extract company description from parenthetical if present
                            const parenMatch = company.match(/\(([^)]+)\)/);
                            if (parenMatch) {
                                currentExperience.company_description = generateCompanyDescription(company, parenMatch[1]);
                            }
                        } else {
                            // Save previous experience
                            if (currentExperience && (currentExperience.title || currentExperience.company)) {
                                resume.experience.push(currentExperience);
                            }
                            
                            // Parse this as a new entry - check if it has a title keyword
                            const looksLikeTitle = cleanBeforeDates.match(/\b(Director|Manager|Lead|Head|VP|SVP|Chief|Officer|Specialist|Coordinator|Administrator|Analyst|Engineer|Recruiter|Executive|Senior|Junior|Associate|Partner)\b/i);
                            
                            if (looksLikeTitle) {
                                // This line has both title and company info
                                // Split by | to separate title from company
                                const parts = cleanBeforeDates.split(/\s*\|\s*/).map(p => p.trim()).filter(p => p);
                                const titlePart = parts[0] || '';
                                const companyPart = parts.slice(1).join(' | ');
                                
                                // Parse location from company part
                                const { company, location } = parseCompanyLocation(companyPart);
                                
                                // Extract company description from parenthetical
                                const parenMatch = company.match(/\(([^)]+)\)/);
                                const companyDesc = parenMatch ? generateCompanyDescription(company, parenMatch[1]) : '';
                                
                                currentExperience = {
                                    title: titlePart,
                                    company: company,
                                    dates: dates,
                                    location: location,
                                    company_description: companyDesc,
                                    bullets: []
                                };
                            } else {
                                // Just company info
                                const parenMatch = beforeDates.match(/\(([^)]+)\)/);
                                const companyDesc = parenMatch ? generateCompanyDescription(beforeDates, parenMatch[1]) : '';
                                
                                currentExperience = {
                                    title: '',
                                    company: beforeDates,
                                    dates: dates,
                                    location: '',
                                    company_description: companyDesc,
                                    bullets: []
                                };
                            }
                        }
                        lastLineWasTitle = false;
                    } else if (line.length < 100 && !line.includes('@')) {
                        // This could be a job title line (no dates, no bullet, reasonable length)
                        const looksLikeTitle = line.match(/\b(Director|Manager|Lead|Head|VP|SVP|Chief|Officer|Specialist|Coordinator|Administrator|Analyst|Engineer|Recruiter|Executive|Senior|Junior|Associate|Partner)\b/i);
                        
                        if (looksLikeTitle) {
                            // Save previous experience
                            if (currentExperience && (currentExperience.title || currentExperience.company)) {
                                resume.experience.push(currentExperience);
                            }
                            
                            // Start new experience with this as the title
                            currentExperience = {
                                title: line,
                                company: '',
                                dates: '',
                                location: '',
                                company_description: '',
                                bullets: []
                            };
                            lastLineWasTitle = true;
                        } else {
                            // Unknown line - skip it (don't add as context since it causes issues)
                            lastLineWasTitle = false;
                        }
                    } else {
                        lastLineWasTitle = false;
                    }
                } else if (currentSection === 'education') {
                    const cleanLine = line.replace(/^[\‚Ä¢\-\*]\s*/, '').trim();
                    if (!resume.education.degree) {
                        if (line.match(/\b(Bachelor|Master|MBA|PhD|B\.\w|M\.\w|Associate|B\.A\.|B\.S\.|M\.A\.|M\.S\.)/i)) {
                            resume.education.degree = cleanLine;
                        } else {
                            resume.education.school = cleanLine;
                        }
                    } else if (!resume.education.school) {
                        resume.education.school = cleanLine;
                    } else {
                        if (!resume.education.details) resume.education.details = [];
                        if (cleanLine) {
                            resume.education.details.push(cleanLine);
                        }
                    }
                }
            }
            
            // Don't forget the last experience entry
            if (currentExperience && (currentExperience.title || currentExperience.company)) {
                resume.experience.push(currentExperience);
            }
            
            // Join summary lines
            resume.summary = summaryLines.join(' ');
            
            // Use data from the analysis for key_qualifications
            if (analysisData.intelligence_layer?.strategic_positioning) {
                const sp = analysisData.intelligence_layer.strategic_positioning;
                resume.key_qualifications = sp.lead_with_strengths || analysisData.strengths || [];
            } else {
                resume.key_qualifications = analysisData.strengths || [];
            }
            
            console.log('Parsed experience entries:', resume.experience);
            
            return resume;
        }

        // ========================================================================
        // HELPER: Build substantive cover letter from analysis data
        // ========================================================================
        function buildCoverLetter(analysisData, parsedResume) {
            const role = analysisData._role || analysisData.role_title || 'the position';
            const company = analysisData._company || analysisData.company || 'your company';
            const strengths = analysisData.strengths || [];
            const positioning = analysisData.intelligence_layer?.strategic_positioning?.positioning_strategy || '';
            const leadWith = analysisData.intelligence_layer?.strategic_positioning?.lead_with_strengths || [];
            
            // Extract concrete achievements from experience bullets
            const achievements = [];
            for (const exp of (parsedResume.experience || [])) {
                for (const bullet of (exp.bullets || [])) {
                    // Look for bullets with numbers/metrics
                    if (bullet.match(/\d+%|\d+x|\$\d+|\d+\+|\d+\s*(employees|hires|team|people)/i)) {
                        achievements.push(bullet);
                        if (achievements.length >= 3) break;
                    }
                }
                if (achievements.length >= 3) break;
            }
            
            // Get first company from experience for specificity
            const recentCompany = parsedResume.experience?.[0]?.company || 'my current organization';
            
            // Build opening paragraph - confident, specific (2-3 sentences)
            const opening = `I'm excited to apply for the ${role} at ${company}. Your focus on building a high-performance talent function aligns directly with my background scaling recruiting operations at high-growth companies.`;
            
            // Build body paragraph 1 - key achievements with metrics (3-4 sentences)
            let body1 = '';
            if (achievements.length > 0) {
                // Clean up achievement text - remove leading bullets
                const cleanAchievements = achievements.slice(0, 2).map(a => 
                    a.replace(/^[\‚Ä¢\-\*]\s*/, '').trim()
                );
                body1 = `At ${recentCompany}, I ${cleanAchievements[0].charAt(0).toLowerCase() + cleanAchievements[0].slice(1)}${cleanAchievements[1] ? ` I also ${cleanAchievements[1].charAt(0).toLowerCase() + cleanAchievements[1].slice(1)}` : ''} This operational foundation enabled consistent execution through rapid growth.`;
            } else if (strengths.length > 0) {
                body1 = `My background includes ${strengths.slice(0, 2).join(' and ')}. These capabilities directly align with what ${company} needs in this role.`;
            } else {
                body1 = `My experience building and scaling talent functions at high-growth companies has prepared me well for this opportunity.`;
            }
            
            // Build body paragraph 2 - value proposition (2-3 sentences)
            let body2 = '';
            if (leadWith.length > 0) {
                body2 = `My approach combines ${leadWith[0].toLowerCase()} with ${leadWith[1] ? leadWith[1].toLowerCase() : 'operational excellence'}‚Äîexactly what ${company} needs to scale efficiently.`;
            } else if (positioning) {
                body2 = positioning;
            } else {
                body2 = `My approach combines recruiting expertise with operational excellence‚Äîexactly what ${company} needs to scale efficiently.`;
            }
            
            // Build closing - confident, not tentative (1-2 sentences)
            const closing = `I'd appreciate the opportunity to discuss how this experience can support ${company}'s next growth phase.`;
            
            return {
                greeting: 'Dear Hiring Manager,',
                paragraphs: [opening, body1, body2, closing, 'Thank you for your consideration.']
            };
        }

        // ========================================================================
        // DOWNLOAD HANDLER - Uses edited textarea content
        // ========================================================================
        const downloadBtn = document.getElementById('downloadBtn');
        const successMessage = document.getElementById('successMessage');

        downloadBtn.addEventListener('click', async () => {
            downloadBtn.disabled = true;
            downloadBtn.textContent = 'Generating DOCX files...';

            try {
                // Get edited content from textareas
                const resumeText = document.getElementById('resume-editor').value;
                const coverLetterText = document.getElementById('coverletter-editor').value;

                // Get candidate name
                const resumeJson = analysisData._resume_json || analysisData._profile?.resume || {};
                const candidateName = resumeJson.contact?.full_name || 
                                     analysisData._candidate_name || 
                                     'Candidate';

                console.log('Downloading with edited content for:', candidateName);

                // Try new accuracy pipeline endpoint first
                let response;
                try {
                    response = await fetch(`${API_BASE_URL}/api/package/download`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            resume_text: resumeText,
                            cover_letter_text: coverLetterText,
                            candidate_name: candidateName
                        })
                    });
                } catch (e) {
                    console.log('New endpoint failed, trying legacy endpoint');
                }

                // Fallback to legacy endpoint if new one fails
                if (!response || !response.ok) {
                    const candidateInfo = parseCandidateInfo(analysisData._resume_text || resumeText);
                    const parsedResume = parseResumeFromText(analysisData._resume_text || resumeText);
                    const outreach = analysisData.outreach || analysisData.intelligence_layer?.outreach || {};
                    const targetRole = analysisData._role || analysisData.role_title || 'Position';
                    const targetCompany = analysisData._company || analysisData.company || 'Company';

                    const formData = new FormData();
                    formData.append('resume_data', JSON.stringify({
                        full_text: resumeText,
                        summary: parsedResume.summary,
                        experience: parsedResume.experience,
                        skills: parsedResume.competencies
                    }));
                    formData.append('cover_letter_data', JSON.stringify({
                        full_text: coverLetterText,
                        paragraphs: coverLetterText.split('\n\n')
                    }));
                    formData.append('candidate_name', candidateName);
                    formData.append('include_outreach', 'true');

                    response = await fetch(`${API_BASE_URL}/api/documents/download`, {
                        method: 'POST',
                        body: formData
                    });
                }

                if (!response.ok) {
                    throw new Error(`Download failed: ${response.status}`);
                }

                // Download the ZIP file
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${candidateName.replace(/\s+/g, '_')}_Application_Package.zip`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);

                // Show success message
                downloadBtn.textContent = 'Download All';
                downloadBtn.disabled = false;
                successMessage.style.display = 'block';
                setTimeout(() => {
                    successMessage.style.display = 'none';
                }, 5000);

            } catch (error) {
                console.error('Download error:', error);
                downloadBtn.textContent = 'Download Failed - Try Again';
                downloadBtn.disabled = false;
                setTimeout(() => {
                    downloadBtn.textContent = 'Download All';
                }, 3000);
            }
        });

        // ========================================================================
        // APPLICATION TRACKER HANDLER
        // ========================================================================
        const trackBtn = document.getElementById('trackBtn');
        const trackSuccessMessage = document.getElementById('trackSuccessMessage');

        trackBtn.addEventListener('click', async () => {
            // Get existing tracked applications from localStorage
            let trackedApps = JSON.parse(localStorage.getItem('trackedApplications') || '[]');
            
            // Create application record
            const application = {
                id: Date.now(),
                company: analysisData._company || analysisData.company || 'Unknown Company',
                role: analysisData._role || analysisData.role_title || 'Unknown Role',
                fitScore: analysisData.fit_score || inferFitScore(analysisData),
                dateAdded: new Date().toISOString(),
                status: 'To Apply',
                salary: analysisData.salary_typical_range || 
                       analysisData.intelligence_layer?.salary_market_context?.typical_range || 
                       'Not specified',
                notes: ''
            };
            
            // Check if already tracked (same company + role)
            const exists = trackedApps.some(app => 
                app.company === application.company && app.role === application.role
            );
            
            if (exists) {
                alert('This role is already in your tracker.');
                return;
            }
            
            // Add to tracker
            trackedApps.push(application);
            localStorage.setItem('trackedApplications', JSON.stringify(trackedApps));
            
            // Show success message
            trackSuccessMessage.style.display = 'block';
            trackBtn.textContent = 'Tracked ‚úì';
            trackBtn.disabled = true;
            
            // Hide after 3 seconds
            setTimeout(() => {
                trackSuccessMessage.style.display = 'none';
            }, 3000);
        });
        
        // Helper function (copy from results.html if not available)
        function inferFitScore(data) {
            if (data.fit_score && data.fit_score > 0) return data.fit_score;
            const recommendation = (data.recommendation || 
                                   data.intelligence_layer?.apply_decision?.recommendation || 
                                   '').toLowerCase();
            if (recommendation.includes('skip')) return 35;
            if (recommendation.includes('caution')) return 55;
            if (recommendation.includes('apply')) return 72;
            return 50;
        }

        // ========================================================================
        // SIMILAR ROLES - MANUAL SEARCH LINKS
        // ========================================================================
        function generateSearchLinks() {
            const container = document.getElementById('manualSearchLinks');
            const titleEl = document.getElementById('similarRolesTitle');
            if (!container) return;

            const role = analysisData._role || analysisData.role_title || '';
            const location = analysisData.location || 'Remote';
            
            // Get candidate first name for personalization
            const candidateInfo = parseCandidateInfo();
            const firstName = candidateInfo.fullName.split(' ')[0] || '';
            
            // Personalize the title with their name
            if (titleEl && firstName) {
                titleEl.textContent = `One more thing, ${firstName}!`;
            }
            
            // Clean role for search query
            const searchRole = encodeURIComponent(role);
            const searchLocation = encodeURIComponent(location);
            
            // Generate alternative role titles for broader search
            const altTitles = generateAltTitles(role);
            const altSearchQuery = encodeURIComponent(altTitles.join(' OR '));

            const links = [
                {
                    name: 'Indeed',
                    url: `https://www.indeed.com/jobs?q=${searchRole}&l=${searchLocation}&fromage=1`,
                    icon: 'https://www.google.com/s2/favicons?domain=indeed.com&sz=32'
                },
                {
                    name: 'LinkedIn',
                    url: `https://www.linkedin.com/jobs/search/?keywords=${searchRole}&f_TPR=r86400`,
                    icon: 'https://www.google.com/s2/favicons?domain=linkedin.com&sz=32'
                },
                {
                    name: 'Greenhouse',
                    url: `https://job-boards.greenhouse.io/search?query=${searchRole}`,
                    icon: 'https://www.google.com/s2/favicons?domain=greenhouse.io&sz=32'
                },
                {
                    name: 'Wellfound',
                    url: `https://wellfound.com/jobs?query=${searchRole}`,
                    icon: 'https://www.google.com/s2/favicons?domain=wellfound.com&sz=32'
                },
                {
                    name: 'BuiltIn',
                    url: `https://builtin.com/jobs?search=${searchRole}`,
                    icon: 'https://www.google.com/s2/favicons?domain=builtin.com&sz=32'
                }
            ];

            container.innerHTML = links.map(link => `
                <a href="${link.url}" target="_blank" rel="noopener" class="manual-search-link">
                    <img src="${link.icon}" alt="${link.name}">
                    ${link.name}
                </a>
            `).join('');
        }

        // Generate alternative job titles for broader matching
        function generateAltTitles(role) {
            const roleLower = role.toLowerCase();
            const altTitles = [role];
            
            // TA / Recruiting variations
            if (roleLower.includes('talent acquisition') || roleLower.includes('recruiting')) {
                if (roleLower.includes('head')) {
                    altTitles.push('Director of Talent Acquisition', 'VP Recruiting', 'Director of Recruiting');
                } else if (roleLower.includes('director')) {
                    altTitles.push('Head of Talent Acquisition', 'Senior Manager Recruiting');
                } else if (roleLower.includes('manager')) {
                    altTitles.push('Talent Acquisition Lead', 'Recruiting Lead');
                }
            }
            
            // People / HR variations
            if (roleLower.includes('people') || roleLower.includes('hr') || roleLower.includes('human resources')) {
                if (roleLower.includes('head') || roleLower.includes('vp')) {
                    altTitles.push('Chief People Officer', 'VP Human Resources', 'Head of HR');
                } else if (roleLower.includes('director')) {
                    altTitles.push('Head of People', 'Director of HR');
                }
            }
            
            return altTitles.slice(0, 3); // Max 3 alternatives
        }

        // Initialize search links
        generateSearchLinks();

        // ========================================================================
        // PREVIEW TAB FUNCTIONALITY
        // ========================================================================
        const previewTabs = document.querySelectorAll('.preview-tab');
        previewTabs.forEach(tab => {
            tab.addEventListener('click', () => {
                // Update active tab
                previewTabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');

                // Show corresponding content
                const tabName = tab.dataset.tab;
                document.getElementById('resumePreview').style.display = tabName === 'resume' ? 'block' : 'none';
                document.getElementById('coverletterPreview').style.display = tabName === 'coverletter' ? 'block' : 'none';
                document.getElementById('outreachPreview').style.display = tabName === 'outreach' ? 'block' : 'none';
            });
        });

        // ========================================================================
        // POPULATE PREVIEW TEXTAREAS
        // ========================================================================
        function populatePreviewEditors() {
            const resumeEditor = document.getElementById('resume-editor');
            const coverletterEditor = document.getElementById('coverletter-editor');

            // Get resume JSON from profile
            const resumeJson = analysisData._resume_json || analysisData._profile?.resume || null;
            
            if (resumeJson) {
                // Build resume text from JSON
                const resumeText = buildResumePreviewText(resumeJson, analysisData);
                resumeEditor.value = resumeText;
            } else if (analysisData._resume_text) {
                // Fallback to raw resume text
                resumeEditor.value = analysisData._resume_text;
            }

            // Build cover letter text
            const coverLetterText = buildCoverLetterPreviewText(analysisData, resumeJson);
            coverletterEditor.value = coverLetterText;
        }

        function buildResumePreviewText(resumeJson, analysisData) {
            const contact = resumeJson.contact || {};
            const lines = [];

            // Header
            if (contact.full_name) lines.push(contact.full_name.toUpperCase());
            
            const contactParts = [];
            if (contact.city_state) contactParts.push(contact.city_state);
            if (contact.email) contactParts.push(contact.email);
            if (contact.phone) contactParts.push(contact.phone);
            if (contact.linkedin) contactParts.push(contact.linkedin);
            if (contactParts.length > 0) lines.push(contactParts.join(' | '));
            lines.push('');

            // Professional Summary
            if (resumeJson.summary_text) {
                lines.push('PROFESSIONAL SUMMARY');
                lines.push(resumeJson.summary_text);
                lines.push('');
            }

            // Core Skills
            if (resumeJson.skills && resumeJson.skills.length > 0) {
                lines.push('CORE SKILLS');
                lines.push(resumeJson.skills.join(', '));
                lines.push('');
            }

            // Experience
            if (resumeJson.experience && resumeJson.experience.length > 0) {
                lines.push('PROFESSIONAL EXPERIENCE');
                lines.push('');
                for (const exp of resumeJson.experience) {
                    lines.push(`${exp.company || ''} | ${exp.role || exp.title || ''}`);
                    const dateParts = [];
                    if (exp.location) dateParts.push(exp.location);
                    if (exp.start_date || exp.end_date) {
                        dateParts.push(`${exp.start_date || ''} ‚Äì ${exp.end_date || 'Present'}`);
                    }
                    if (dateParts.length > 0) lines.push(dateParts.join(' | '));
                    
                    if (exp.bullets && exp.bullets.length > 0) {
                        for (const bullet of exp.bullets) {
                            lines.push(`‚Ä¢ ${bullet}`);
                        }
                    }
                    lines.push('');
                }
            }

            // Education
            if (resumeJson.education) {
                lines.push('EDUCATION');
                // Handle education as string or array
                if (typeof resumeJson.education === 'string') {
                    lines.push(resumeJson.education);
                } else if (Array.isArray(resumeJson.education) && resumeJson.education.length > 0) {
                    for (const edu of resumeJson.education) {
                        if (typeof edu === 'string') {
                            lines.push(edu);
                        } else if (edu && typeof edu === 'object') {
                            // Handle education object with institution, degree, details
                            const parts = [];
                            if (edu.institution) parts.push(edu.institution);
                            if (edu.degree) parts.push(edu.degree);
                            if (parts.length > 0) lines.push(parts.join(' | '));
                            if (edu.details) lines.push(edu.details);
                        }
                    }
                }
                lines.push('');
            }

            // Certifications
            if (resumeJson.certifications) {
                // Handle certifications as string or array
                if (typeof resumeJson.certifications === 'string') {
                    lines.push('CERTIFICATIONS');
                    lines.push(resumeJson.certifications);
                } else if (Array.isArray(resumeJson.certifications) && resumeJson.certifications.length > 0) {
                    lines.push('CERTIFICATIONS');
                    for (const cert of resumeJson.certifications) {
                        lines.push(typeof cert === 'string' ? cert : JSON.stringify(cert));
                    }
                }
            }

            return lines.join('\n');
        }

        function buildCoverLetterPreviewText(analysisData, resumeJson) {
            const contact = resumeJson?.contact || {};
            const role = analysisData._role || analysisData.role_title || 'the position';
            const company = analysisData._company || analysisData.company || 'your company';
            const lines = [];

            // Header
            if (contact.full_name) lines.push(contact.full_name.toUpperCase());
            const contactParts = [];
            if (contact.city_state) contactParts.push(contact.city_state);
            if (contact.email) contactParts.push(contact.email);
            if (contact.phone) contactParts.push(contact.phone);
            if (contact.linkedin) contactParts.push(contact.linkedin);
            if (contactParts.length > 0) lines.push(contactParts.join(' | '));
            lines.push('');

            // Date
            const today = new Date();
            const dateStr = today.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
            lines.push(dateStr);
            lines.push('');

            // Recipient
            lines.push('Hiring Team');
            lines.push(company);
            lines.push('');
            lines.push(`Re: Application for ${role}`);
            lines.push('');

            // Greeting
            lines.push('Dear Hiring Team,');
            lines.push('');

            // Body - use generated content or create placeholder
            const strengths = analysisData.strengths || [];
            const positioning = analysisData.intelligence_layer?.strategic_positioning?.positioning_strategy || '';

            // Opening
            lines.push(`I am writing to express my interest in the ${role} position at ${company}. My background aligns well with this opportunity.`);
            lines.push('');

            // Body
            if (strengths.length > 0) {
                lines.push(`My experience includes ${strengths.slice(0, 3).join(', ')}. These capabilities directly support what ${company} needs in this role.`);
            } else {
                lines.push(`My professional background has prepared me well for this opportunity, and I am excited about the possibility of contributing to ${company}.`);
            }
            lines.push('');

            // Closing
            lines.push(`I would welcome the opportunity to discuss how my experience can support ${company}'s goals. Thank you for considering my application.`);
            lines.push('');
            lines.push('Sincerely,');
            lines.push(contact.full_name || 'Candidate');

            return lines.join('\n');
        }

        // ========================================================================
        // ASYNC DOCUMENT LOADER (CALLS BACKEND APIs)
        // ========================================================================
        async function loadTailoredDocuments() {
            const resumeEditor = document.getElementById('resume-editor');
            const coverletterEditor = document.getElementById('coverletter-editor');
            
            // Show loading state
            resumeEditor.value = 'Generating tailored resume...';
            resumeEditor.disabled = true;
            coverletterEditor.value = 'Generating cover letter...';
            coverletterEditor.disabled = true;

            // Get data needed for API calls
            const resumeJson = analysisData._resume_json || analysisData._profile?.resume || null;
            const jobDescription = analysisData._jd_text || '';
            const targetRole = analysisData._role || analysisData.role_title || '';
            const targetCompany = analysisData._company || analysisData.company || '';
            const strengths = analysisData.strengths || [];

            // Debug: log what data we have
            console.log('üì¶ loadTailoredDocuments - Data check:', {
                hasResumeJson: !!resumeJson,
                hasJobDescription: !!jobDescription,
                targetRole,
                targetCompany
            });

            // If we don't have the necessary data, fall back to local generation
            if (!resumeJson || !jobDescription) {
                console.warn('‚ö†Ô∏è Missing data for API calls, using local fallback');
                resumeEditor.value = buildResumePreviewText(resumeJson || {}, analysisData);
                coverletterEditor.value = buildCoverLetterPreviewText(analysisData, resumeJson || {});
                resumeEditor.disabled = false;
                coverletterEditor.disabled = false;
                return;
            }

            // Call both endpoints in parallel with timeout
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 90000); // 90 second timeout (Claude can be slow)

            // Get situation from profile for tone calibration
            const situation = analysisData._profile?.situation || null;

            // Check for supplements from strengthen page
            const supplementsStr = sessionStorage.getItem('supplements');
            const supplements = supplementsStr ? JSON.parse(supplementsStr) : [];
            if (supplements.length > 0) {
                console.log('üìù Found supplements from strengthen page:', supplements);
                // Clear after use
                sessionStorage.removeItem('supplements');
                sessionStorage.removeItem('originalGaps');
            }

            // Build smaller payloads - don't send entire analysisData
            const resumePayload = {
                resume_json: resumeJson,
                job_description: jobDescription,
                target_role: targetRole,
                target_company: targetCompany,
                situation: situation,
                supplements: supplements.length > 0 ? supplements : undefined
            };

            const coverLetterPayload = {
                resume_json: resumeJson,
                job_description: jobDescription,
                target_role: targetRole,
                target_company: targetCompany,
                strengths: strengths,
                situation: situation,
                supplements: supplements.length > 0 ? supplements : undefined
            };

            console.log('üì§ Resume payload size:', JSON.stringify(resumePayload).length, 'bytes');
            console.log('üì§ Cover letter payload size:', JSON.stringify(coverLetterPayload).length, 'bytes');
            console.log('üéØ Situation for calibration:', situation);

            try {
                console.log('üöÄ Calling document generation APIs...');
                
                const [resumeResponse, coverLetterResponse] = await Promise.all([
                    fetch(`${API_BASE_URL}/api/resume/customize`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        signal: controller.signal,
                        body: JSON.stringify(resumePayload)
                    }),
                    fetch(`${API_BASE_URL}/api/cover-letter/generate`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        signal: controller.signal,
                        body: JSON.stringify(coverLetterPayload)
                    })
                ]);

                clearTimeout(timeoutId);

                // Process resume response
                if (resumeResponse.ok) {
                    const resumeData = await resumeResponse.json();
                    console.log('‚úÖ Resume API success');
                    console.log('üìä Resume data:', resumeData);
                    resumeEditor.value = resumeData.tailored_resume_text || 'Resume generation failed';

                    // Update "What Changed" section with resume rationale
                    if (resumeData.changes_summary) {
                        const cs = resumeData.changes_summary;
                        let resumeRationale = '';
                        if (cs.summary_rationale) resumeRationale += cs.summary_rationale;
                        if (cs.experience_rationale) resumeRationale += ' ' + cs.experience_rationale;
                        else if (cs.qualifications_rationale) resumeRationale += ' ' + cs.qualifications_rationale;
                        if (resumeRationale) {
                            document.getElementById('resumeRationaleText').textContent = resumeRationale;
                        }
                        // Legacy ATS keywords support
                        if (cs.ats_keywords && cs.ats_keywords.length > 0) {
                            document.getElementById('atsKeywordsSection').style.display = 'block';
                            document.getElementById('atsKeywordsText').textContent = cs.ats_keywords.join(' ‚Ä¢ ');
                        }
                    }

                    // Display enhanced keyword analysis
                    if (resumeData.keyword_analysis) {
                        const ka = resumeData.keyword_analysis;
                        document.getElementById('keywordAnalysisSection').style.display = 'block';

                        if (ka.tier_1_keywords && ka.tier_1_keywords.length > 0) {
                            document.getElementById('tier1Keywords').textContent = ka.tier_1_keywords.slice(0, 4).join(', ');
                            document.getElementById('tier1Count').textContent = `${ka.tier_1_placements || 0} placements`;
                        }
                        if (ka.tier_2_keywords && ka.tier_2_keywords.length > 0) {
                            document.getElementById('tier2Keywords').textContent = ka.tier_2_keywords.slice(0, 4).join(', ');
                            document.getElementById('tier2Count').textContent = `${ka.tier_2_placements || 0} placements`;
                        }
                        if (ka.tier_3_keywords && ka.tier_3_keywords.length > 0) {
                            document.getElementById('tier3Keywords').textContent = ka.tier_3_keywords.slice(0, 3).join(', ');
                            document.getElementById('tier3Count').textContent = `${ka.tier_3_placements || 0} placements`;
                        }
                    }

                    // Display positioning strategy
                    if (resumeData.positioning_strategy) {
                        const ps = resumeData.positioning_strategy;
                        document.getElementById('positioningStrategySection').style.display = 'block';

                        let positioningHtml = '';
                        if (ps.company_stage_detected) {
                            positioningHtml += `<div style="margin-bottom: 6px;"><strong>Company Stage:</strong> ${ps.company_stage_detected}</div>`;
                        }
                        if (ps.lead_with) {
                            positioningHtml += `<div style="margin-bottom: 6px;"><strong>Leading with:</strong> ${ps.lead_with}</div>`;
                        }
                        if (ps.de_emphasize) {
                            positioningHtml += `<div><strong>De-emphasizing:</strong> ${ps.de_emphasize}</div>`;
                        }
                        document.getElementById('positioningDetails').innerHTML = positioningHtml;
                    }
                } else {
                    const errorText = await resumeResponse.text();
                    console.error('‚ùå Resume API error:', resumeResponse.status, errorText);
                    resumeEditor.value = buildResumePreviewText(resumeJson, analysisData);
                }

                // Process cover letter response
                if (coverLetterResponse.ok) {
                    const coverData = await coverLetterResponse.json();
                    console.log('‚úÖ Cover letter API success');
                    coverletterEditor.value = coverData.cover_letter_text || 'Cover letter generation failed';
                    
                    // Update "What Changed" section with cover letter rationale
                    if (coverData.changes_summary) {
                        const cs = coverData.changes_summary;
                        let coverRationale = '';
                        if (cs.opening_rationale) coverRationale += cs.opening_rationale;
                        if (cs.body_rationale) coverRationale += ' ' + cs.body_rationale;
                        if (coverRationale) {
                            document.getElementById('coverLetterRationaleText').textContent = coverRationale;
                        }
                    }
                } else {
                    const errorText = await coverLetterResponse.text();
                    console.error('‚ùå Cover letter API error:', coverLetterResponse.status, errorText);
                    coverletterEditor.value = buildCoverLetterPreviewText(analysisData, resumeJson);
                }

            } catch (error) {
                clearTimeout(timeoutId);
                if (error.name === 'AbortError') {
                    console.error('‚è±Ô∏è API calls timed out after 60 seconds');
                } else {
                    console.error('‚ùå Error loading tailored documents:', error);
                }
                // Fall back to local generation
                resumeEditor.value = buildResumePreviewText(resumeJson || {}, analysisData);
                coverletterEditor.value = buildCoverLetterPreviewText(analysisData, resumeJson || {});
            } finally {
                // Re-enable editors
                resumeEditor.disabled = false;
                coverletterEditor.disabled = false;
            }
        }

        // Initialize preview editors - use async loader for AI-generated content
        loadTailoredDocuments();

        // ========================================================================
        // SCREENING QUESTIONS HANDLER
        // ========================================================================
        const generateResponsesBtn = document.getElementById('generateResponsesBtn');
        const screeningQuestionsInput = document.getElementById('screeningQuestionsInput');
        const screeningResponsesContainer = document.getElementById('screeningResponsesContainer');

        generateResponsesBtn.addEventListener('click', async () => {
            const questionsText = screeningQuestionsInput.value.trim();

            if (!questionsText) {
                alert('Please paste your screening questions first.');
                return;
            }

            // Disable button and show loading state
            generateResponsesBtn.disabled = true;
            generateResponsesBtn.textContent = 'Generating responses...';
            screeningResponsesContainer.innerHTML = '<p style="color: var(--color-text-secondary); text-align: center; padding: 20px;">Analyzing questions and generating strategic responses...</p>';
            screeningResponsesContainer.classList.add('active');

            try {
                // Get data needed for API call
                const resumeJson = analysisData._resume_json || analysisData._profile?.resume || {};
                const jobDescription = analysisData._jd_text || '';
                const targetRole = analysisData._role || analysisData.role_title || '';
                const targetCompany = analysisData._company || analysisData.company || '';
                const jdAnalysis = {
                    fit_score: analysisData.fit_score,
                    strengths: analysisData.strengths || [],
                    gaps: analysisData.gaps || []
                };
                const situation = analysisData._profile?.situation || null;

                console.log('üìã Sending screening questions request...');

                const response = await fetch(`${API_BASE_URL}/api/screening-questions/generate`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        resume_json: resumeJson,
                        job_description: jobDescription,
                        company: targetCompany,
                        role_title: targetRole,
                        screening_questions: questionsText,
                        jd_analysis: jdAnalysis,
                        situation: situation
                    })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`API error: ${response.status} - ${errorText}`);
                }

                const data = await response.json();
                console.log('‚úÖ Screening responses received:', data);

                // Render responses
                renderScreeningResponses(data);

            } catch (error) {
                console.error('‚ùå Screening questions error:', error);
                screeningResponsesContainer.innerHTML = `
                    <div style="color: var(--color-error); text-align: center; padding: 20px;">
                        <p>Failed to generate responses. Please try again.</p>
                        <p style="font-size: 0.85rem; color: var(--color-text-secondary); margin-top: 8px;">${error.message}</p>
                    </div>
                `;
            } finally {
                generateResponsesBtn.disabled = false;
                generateResponsesBtn.textContent = 'Generate Responses';
            }
        });

        function renderScreeningResponses(data) {
            if (!data.responses || data.responses.length === 0) {
                screeningResponsesContainer.innerHTML = '<p style="color: var(--color-text-secondary); text-align: center; padding: 20px;">No responses generated. Please check your questions and try again.</p>';
                return;
            }

            let html = '';

            // Render each response card
            data.responses.forEach((response, index) => {
                const hasGap = response.gap_detected;
                html += `
                    <div class="screening-response-card ${hasGap ? 'gap-detected' : ''}">
                        <div class="screening-question-text">Q${index + 1}: ${escapeHtml(response.question)}</div>
                        <div class="screening-response-text">${escapeHtml(response.recommended_response)}</div>
                        <div class="screening-strategic-note">${escapeHtml(response.strategic_note)}</div>
                        ${hasGap && response.mitigation_strategy ? `<div class="screening-gap-warning">${escapeHtml(response.mitigation_strategy)}</div>` : ''}
                        <button class="copy-response-btn" onclick="copyScreeningResponse(this, ${index})">Copy Response</button>
                    </div>
                `;
            });

            // Add overall strategy
            if (data.overall_strategy) {
                html += `
                    <div class="screening-overall-strategy">
                        <strong>Overall Strategy:</strong> ${escapeHtml(data.overall_strategy)}
                    </div>
                `;
            }

            screeningResponsesContainer.innerHTML = html;

            // Store responses for copy functionality
            window.screeningResponses = data.responses;
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Global function for copy button
        window.copyScreeningResponse = function(button, index) {
            const response = window.screeningResponses?.[index];
            if (!response) return;

            navigator.clipboard.writeText(response.recommended_response).then(() => {
                button.textContent = 'Copied!';
                button.classList.add('copied');
                setTimeout(() => {
                    button.textContent = 'Copy Response';
                    button.classList.remove('copied');
                }, 2000);
            }).catch(err => {
                console.error('Failed to copy:', err);
                // Fallback for older browsers
                const textarea = document.createElement('textarea');
                textarea.value = response.recommended_response;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                button.textContent = 'Copied!';
                button.classList.add('copied');
                setTimeout(() => {
                    button.textContent = 'Copy Response';
                    button.classList.remove('copied');
                }, 2000);
            });
        };
    </script>
</body>
</html>

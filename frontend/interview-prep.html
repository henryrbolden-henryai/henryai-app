<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interview Intelligence - HenryAI</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Instrument+Serif:ital@0;1&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 100%);
            color: #e0e0e0;
            min-height: 100vh;
            line-height: 1.6;
        }

        /* Header */
        header {
            background: rgba(15, 15, 15, 0.95);
            border-bottom: 1px solid #374151;
            padding: 16px 20px;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        header .header-container {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-family: 'Instrument Serif', Georgia, serif;
            font-size: 1.5rem;
            color: #ffffff;
            text-decoration: none;
        }

        .logo em {
            font-style: italic;
            color: #22d3ee;
        }

        .header-nav {
            display: flex;
            gap: 24px;
            align-items: center;
        }

        .nav-link {
            color: #9ca3af;
            text-decoration: none;
            font-size: 0.9rem;
            transition: color 0.2s ease;
        }

        .nav-link:hover {
            color: #22d3ee;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .back-link {
            display: inline-flex;
            align-items: center;
            color: #60a5fa;
            text-decoration: none;
            margin-bottom: 30px;
            font-size: 14px;
            transition: color 0.2s;
        }

        .back-link:hover {
            color: #93c5fd;
        }

        h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .subtitle {
            color: #9ca3af;
            margin-bottom: 30px;
            font-size: 1.1rem;
        }

        /* Stage Selector */
        .stage-selector {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
        }

        .stage-btn {
            flex: 1;
            padding: 20px;
            background: #1f2937;
            border: 2px solid #374151;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }

        .stage-btn:hover {
            border-color: #60a5fa;
        }

        .stage-btn.active {
            border-color: #22d3ee;
            background: rgba(34, 211, 238, 0.1);
        }

        .stage-btn h3 {
            color: #ffffff;
            font-size: 1.1rem;
            margin-bottom: 5px;
        }

        .stage-btn p {
            color: #9ca3af;
            font-size: 0.85rem;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            border-bottom: 2px solid #374151;
        }

        .tab {
            padding: 12px 24px;
            background: transparent;
            border: none;
            color: #9ca3af;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
        }

        .tab:hover {
            color: #60a5fa;
        }

        .tab.active {
            color: #22d3ee;
            border-bottom-color: #22d3ee;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Section Cards */
        .section {
            background: #1f2937;
            border-radius: 12px;
            margin-bottom: 20px;
            border: 1px solid #374151;
            overflow: hidden;
        }

        .section-header {
            padding: 20px 25px;
            background: rgba(0, 0, 0, 0.2);
            border-bottom: 1px solid #374151;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: background 0.2s;
        }

        .section-header:hover {
            background: rgba(0, 0, 0, 0.3);
        }

        .section-title {
            font-size: 1.2rem;
            color: #60a5fa;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section-toggle {
            color: #9ca3af;
            font-size: 1.2rem;
            transition: transform 0.3s;
        }

        .section.collapsed .section-toggle {
            transform: rotate(-90deg);
        }

        .section-body {
            padding: 25px;
            transition: max-height 0.3s ease-out, padding 0.3s ease-out, opacity 0.3s ease-out;
            max-height: 2000px;
            overflow: hidden;
            opacity: 1;
        }

        .section.collapsed .section-body {
            max-height: 0;
            padding-top: 0;
            padding-bottom: 0;
            opacity: 0;
        }

        .section.collapsed .section-header {
            border-bottom: none;
        }

        /* Content Lists */
        .content-list {
            list-style: none;
        }

        .content-list li {
            padding: 12px 0;
            border-bottom: 1px solid #374151;
            display: flex;
            align-items: flex-start;
            gap: 12px;
        }

        .content-list li:last-child {
            border-bottom: none;
        }

        .content-list li::before {
            content: "‚Ä¢";
            color: #22d3ee;
            font-weight: bold;
            font-size: 1.2rem;
            line-height: 1.4;
        }

        /* Question Cards */
        .question-card {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 12px;
            border-left: 3px solid #60a5fa;
        }

        .question-card .question {
            font-weight: 600;
            color: #ffffff;
            margin-bottom: 8px;
        }

        .question-card .rationale {
            color: #9ca3af;
            font-size: 0.9rem;
        }

        /* STAR Example Cards */
        .star-card {
            background: rgba(0, 0, 0, 0.3);
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 15px;
            border: 1px solid #374151;
        }

        .star-card .competency {
            color: #22d3ee;
            font-weight: 600;
            font-size: 1rem;
            margin-bottom: 12px;
        }

        .star-card .star-section {
            margin-bottom: 8px;
        }

        .star-card .star-label {
            color: #60a5fa;
            font-weight: 600;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .star-card .star-text {
            color: #d1d5db;
            margin-top: 4px;
        }

        /* Red Flag Mitigation */
        .mitigation-card {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 12px;
        }

        .mitigation-card .flag {
            color: #f87171;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .mitigation-card .mitigation {
            color: #d1d5db;
        }

        /* Strategy Box */
        .strategy-box {
            background: rgba(34, 211, 238, 0.1);
            border: 1px solid rgba(34, 211, 238, 0.3);
            padding: 20px;
            border-radius: 8px;
            margin-top: 15px;
        }

        .strategy-box h4 {
            color: #22d3ee;
            margin-bottom: 10px;
        }

        .strategy-box p {
            color: #d1d5db;
        }

        /* Quick Action Buttons for Debrief Chat */
        .quick-action-btn {
            background: transparent;
            border: 1px solid #374151;
            color: #9ca3af;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.2s;
        }
        .quick-action-btn:hover {
            background: rgba(34, 211, 238, 0.1);
            border-color: #22d3ee;
            color: #22d3ee;
        }

        /* Feeling Rating Buttons */
        .feeling-btn {
            transition: all 0.2s;
        }
        .feeling-btn:hover {
            border-color: #22d3ee !important;
        }
        .feeling-btn.selected {
            background: rgba(34, 211, 238, 0.2) !important;
            border-color: #22d3ee !important;
            color: #22d3ee;
        }

        /* Chat Message Styles */
        .chat-message {
            margin-bottom: 20px;
            animation: fadeIn 0.3s ease;
        }
        .chat-message.assistant {
            background: #1f2937;
            border-radius: 12px;
            padding: 15px 20px;
            border-left: 3px solid #22d3ee;
        }
        .chat-message.user {
            background: rgba(34, 211, 238, 0.1);
            border-radius: 12px;
            padding: 15px 20px;
            margin-left: 40px;
        }
        .chat-message .sender {
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 0.85rem;
        }
        .chat-message.assistant .sender {
            color: #22d3ee;
        }
        .chat-message.user .sender {
            color: #a78bfa;
        }
        .chat-message .content {
            color: #d1d5db;
            line-height: 1.7;
            white-space: pre-wrap;
        }
        .chat-message .content strong {
            color: #ffffff;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Intro Sell Practice */
        .intro-sell-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }

        @media (max-width: 900px) {
            .intro-sell-container {
                grid-template-columns: 1fr;
            }
        }

        .template-box {
            background: #1f2937;
            border: 1px solid #374151;
            border-radius: 12px;
            padding: 25px;
        }

        .template-box h3 {
            color: #60a5fa;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .template-text {
            background: rgba(0, 0, 0, 0.3);
            padding: 20px;
            border-radius: 8px;
            line-height: 1.8;
            color: #d1d5db;
            font-size: 1rem;
        }

        .word-count {
            margin-top: 15px;
            color: #9ca3af;
            font-size: 0.9rem;
        }

        .coaching-note {
            margin-top: 15px;
            padding: 15px;
            background: rgba(34, 211, 238, 0.1);
            border-radius: 8px;
            color: #22d3ee;
            font-size: 0.9rem;
        }

        .practice-box h3 {
            color: #60a5fa;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .practice-textarea {
            width: 100%;
            min-height: 200px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid #374151;
            border-radius: 8px;
            padding: 15px;
            color: #d1d5db;
            font-size: 1rem;
            line-height: 1.8;
            resize: vertical;
            font-family: inherit;
        }

        .practice-textarea:focus {
            outline: none;
            border-color: #60a5fa;
        }

        .practice-stats {
            display: flex;
            gap: 20px;
            margin-top: 15px;
            color: #9ca3af;
            font-size: 0.9rem;
        }

        .btn-primary {
            background: linear-gradient(135deg, #22d3ee 0%, #0ea5e9 100%);
            color: #000000;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            margin-top: 15px;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(34, 211, 238, 0.4);
        }

        .btn-primary:disabled {
            background: #4b5563;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* Feedback Section */
        .feedback-section {
            margin-top: 30px;
            display: none;
        }

        .feedback-section.active {
            display: block;
        }

        .score-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        @media (max-width: 700px) {
            .score-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .score-card {
            background: rgba(0, 0, 0, 0.3);
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }

        .score-card .score {
            font-size: 2.5rem;
            font-weight: bold;
            color: #22d3ee;
        }

        .score-card .label {
            color: #9ca3af;
            font-size: 0.85rem;
            margin-top: 5px;
        }

        .feedback-list {
            list-style: none;
        }

        .feedback-list.strengths li::before {
            content: "‚úì";
            color: #4ade80;
        }

        .feedback-list.opportunities li::before {
            content: "‚Üí";
            color: #fbbf24;
        }

        .feedback-list li {
            padding: 10px 0;
            border-bottom: 1px solid #374151;
            display: flex;
            gap: 10px;
        }

        .feedback-list li:last-child {
            border-bottom: none;
        }

        .revised-version {
            background: rgba(74, 222, 128, 0.1);
            border: 1px solid rgba(74, 222, 128, 0.3);
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
        }

        .revised-version h4 {
            color: #4ade80;
            margin-bottom: 10px;
        }

        /* Debrief Section */
        .debrief-form {
            display: grid;
            gap: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .form-group label {
            color: #d1d5db;
            font-weight: 500;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid #374151;
            border-radius: 8px;
            padding: 12px;
            color: #d1d5db;
            font-size: 1rem;
            font-family: inherit;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #60a5fa;
        }

        /* Loading State */
        .loading {
            text-align: center;
            padding: 40px;
            color: #9ca3af;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #374151;
            border-top-color: #22d3ee;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Navigation */
        .navigation {
            display: flex;
            justify-content: space-between;
            margin-top: 40px;
            padding-top: 30px;
            border-top: 1px solid #374151;
        }

        .btn {
            padding: 14px 28px;
            border-radius: 8px;
            text-decoration: none;
            font-weight: 600;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-secondary {
            background: transparent;
            border: 2px solid #374151;
            color: #9ca3af;
        }

        .btn-secondary:hover {
            border-color: #60a5fa;
            color: #60a5fa;
        }

        .btn-cta {
            background: linear-gradient(135deg, #22d3ee 0%, #0ea5e9 100%);
            border: none;
            color: #000000;
        }

        .btn-cta:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(34, 211, 238, 0.4);
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 40px;
            color: #6b7280;
        }

        /* Generate Button */
        .generate-section {
            text-align: center;
            padding: 30px;
            background: rgba(34, 211, 238, 0.05);
            border-radius: 12px;
            margin-bottom: 30px;
        }

        .generate-section p {
            color: #9ca3af;
            margin-bottom: 20px;
        }

        .btn-generate {
            background: linear-gradient(135deg, #22d3ee 0%, #0ea5e9 100%);
            color: #000000;
            border: none;
            padding: 16px 40px;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-generate:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(34, 211, 238, 0.4);
        }

        .btn-generate:disabled {
            background: #4b5563;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
    </style>
</head>
<body>
    <!-- HEADER -->
    <header>
        <div class="header-container">
            <a href="index.html" class="logo"><em>Henry</em>AI</a>
            <nav class="header-nav">
                <a href="tracker.html" class="nav-link">My Applications</a>
                <a href="profile-edit.html" class="nav-link">Edit Profile</a>
            </nav>
        </div>
    </header>

    <div class="container">
        <a href="interview-intelligence.html" class="back-link">‚Üê Back to Interview Intelligence</a>

        <h1>
            <span>üéØ</span> Interview Intelligence
        </h1>
        <p class="subtitle">Stage-specific prep, intro sell practice, and post-interview analysis</p>

        <!-- Stage Selector -->
        <div class="stage-selector">
            <button class="stage-btn active" data-stage="recruiter_screen" onclick="selectStage('recruiter_screen')">
                <h3>üìû Recruiter Screen</h3>
                <p>Logistics, salary, timeline, red flags</p>
            </button>
            <button class="stage-btn" data-stage="hiring_manager" onclick="selectStage('hiring_manager')">
                <h3>üëî Hiring Manager</h3>
                <p>STAR stories, competencies, depth</p>
            </button>
            <button class="stage-btn" data-stage="mock_interview" onclick="selectStage('mock_interview')">
                <h3>üé§ Mock Interviews</h3>
                <p>Practice with AI feedback</p>
            </button>
        </div>

        <!-- Tabs -->
        <div class="tabs" id="mainTabs">
            <button class="tab active" onclick="switchTab('prep')">Pre-Interview Prep</button>
            <button class="tab" onclick="switchTab('debrief')">Post-Interview Debrief</button>
        </div>

        <!-- Mock Interview Tabs (shown when mock_interview stage selected) -->
        <div class="tabs" id="mockTabs" style="display: none;">
            <button class="tab active" onclick="switchMockTab('intro-sell')">üéØ Intro Sell Practice</button>
            <button class="tab" onclick="switchMockTab('recruiter')">üìû Recruiter Screen</button>
            <button class="tab" onclick="switchMockTab('hiring')">üëî Hiring Manager</button>
            <button class="tab" onclick="switchMockTab('drills')">üèãÔ∏è Practice Drills</button>
        </div>

        <!-- Pre-Interview Prep Tab -->
        <div id="prepTab" class="tab-content active">
            <div class="generate-section" id="prepGenerateSection">
                <p>Generate personalized interview prep based on your resume and the job description.</p>
                <button class="btn-generate" onclick="generatePrep()" id="generatePrepBtn">
                    Generate Interview Prep
                </button>
            </div>

            <div id="prepLoading" class="loading" style="display: none;">
                <div class="loading-spinner"></div>
                <div>Generating your personalized interview prep...</div>
            </div>

            <div id="prepContent" style="display: none;">
                <!-- Expand/Collapse All -->
                <div style="display: flex; justify-content: flex-end; margin-bottom: 15px; gap: 10px;">
                    <button onclick="expandAllSections()" class="btn-secondary" style="padding: 8px 16px; font-size: 0.85rem; border-radius: 6px; cursor: pointer; background: transparent; border: 1px solid #374151; color: #9ca3af;">
                        Expand All
                    </button>
                    <button onclick="collapseAllSections()" class="btn-secondary" style="padding: 8px 16px; font-size: 0.85rem; border-radius: 6px; cursor: pointer; background: transparent; border: 1px solid #374151; color: #9ca3af;">
                        Collapse All
                    </button>
                </div>

                <!-- Overview Section -->
                <div class="section collapsible">
                    <div class="section-header" onclick="toggleSection(this)">
                        <h3 class="section-title"><span>üìã</span> Interview Overview</h3>
                        <span class="section-toggle">‚ñº</span>
                    </div>
                    <div class="section-body">
                        <p id="interviewOverview"></p>
                    </div>
                </div>

                <!-- Key Talking Points / Strengths -->
                <div class="section collapsible">
                    <div class="section-header" onclick="toggleSection(this)">
                        <h3 class="section-title"><span>üí™</span> <span id="talkingPointsTitle">Key Talking Points</span></h3>
                        <span class="section-toggle">‚ñº</span>
                    </div>
                    <div class="section-body">
                        <ul class="content-list" id="talkingPointsList"></ul>
                    </div>
                </div>

                <!-- Red Flags / Gaps -->
                <div class="section collapsible">
                    <div class="section-header" onclick="toggleSection(this)">
                        <h3 class="section-title"><span>‚ö†Ô∏è</span> <span id="mitigationTitle">Red Flag Mitigation</span></h3>
                        <span class="section-toggle">‚ñº</span>
                    </div>
                    <div class="section-body" id="mitigationContent"></div>
                </div>

                <!-- STAR Examples (Hiring Manager only) -->
                <div class="section collapsible" id="starExamplesSection" style="display: none;">
                    <div class="section-header" onclick="toggleSection(this)">
                        <h3 class="section-title"><span>‚≠ê</span> STAR Examples</h3>
                        <span class="section-toggle">‚ñº</span>
                    </div>
                    <div class="section-body" id="starExamplesContent"></div>
                </div>

                <!-- Likely Questions -->
                <div class="section collapsible">
                    <div class="section-header" onclick="toggleSection(this)">
                        <h3 class="section-title"><span>‚ùì</span> Likely Questions & Suggested Answers</h3>
                        <span class="section-toggle">‚ñº</span>
                    </div>
                    <div class="section-body" id="likelyQuestionsContent"></div>
                </div>

                <!-- Questions to Ask -->
                <div class="section collapsible">
                    <div class="section-header" onclick="toggleSection(this)">
                        <h3 class="section-title"><span>üôã</span> Questions to Ask</h3>
                        <span class="section-toggle">‚ñº</span>
                    </div>
                    <div class="section-body" id="questionsToAskContent"></div>
                </div>

                <!-- Strategy Boxes -->
                <div id="strategyBoxes"></div>
            </div>
        </div>

        <!-- Intro Sell Tab -->
        <div id="intro-sellTab" class="tab-content">
            <div class="section">
                <div class="section-header" style="cursor: default;">
                    <h3 class="section-title"><span>üìù</span> Your 60-90 Second Intro</h3>
                </div>
                <div class="section-body">
                    <p style="color: #9ca3af; margin-bottom: 20px;">
                        A tailored "tell me about yourself" response for this specific role. Practice this verbally until it feels natural.
                    </p>

                    <div id="templateLoading" class="loading">
                        <div class="loading-spinner"></div>
                        <div>Generating your intro sell template...</div>
                    </div>

                    <div id="templateContent" style="display: none;">
                        <div class="template-text" id="introSellTemplate"></div>
                        <div class="word-count" id="templateWordCount" style="margin-top: 15px;"></div>
                        <div class="coaching-note" id="templateCoachingNote" style="margin-top: 15px;"></div>

                        <button class="btn-primary" onclick="generateIntroSellTemplate()" id="generateTemplateBtn" style="margin-top: 20px;">
                            Regenerate Template
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Post-Interview Debrief Tab -->
        <div id="debriefTab" class="tab-content">
            <!-- Step 1: Interview Context Setup -->
            <div id="debriefSetup" class="section">
                <div class="section-header" style="cursor: default;">
                    <h3 class="section-title"><span>üìù</span> Interview Debrief Coach</h3>
                </div>
                <div class="section-body">
                    <p style="color: #d1d5db; margin-bottom: 20px; line-height: 1.6;">
                        Have a coaching conversation about your interview. Share the transcript and I'll analyze what went well,
                        what to improve, draft your thank-you email, and prep you for the next round.
                    </p>

                    <!-- Recording Instructions -->
                    <div style="background: rgba(34, 211, 238, 0.1); border: 1px solid rgba(34, 211, 238, 0.3); border-radius: 8px; padding: 15px; margin-bottom: 25px;">
                        <h4 style="color: #22d3ee; margin: 0 0 10px 0; font-size: 1rem;">üéôÔ∏è How to Record & Transcribe Your Interview</h4>
                        <p style="color: #d1d5db; margin: 0 0 10px 0; font-size: 0.9rem;">
                            Use a transcription service to capture your interview, then paste the transcript below:
                        </p>
                        <ul style="color: #9ca3af; margin: 0; padding-left: 20px; font-size: 0.85rem; line-height: 1.8;">
                            <li><strong><a href="https://otter.ai" target="_blank" style="color: #22d3ee;">Otter.ai</a></strong> - Free tier available, auto-joins Zoom/Meet/Teams calls</li>
                            <li><strong><a href="https://fireflies.ai" target="_blank" style="color: #22d3ee;">Fireflies.ai</a></strong> - Meeting assistant with AI summaries</li>
                            <li><strong><a href="https://www.read.ai" target="_blank" style="color: #22d3ee;">Read.ai</a></strong> - Real-time transcription with insights</li>
                            <li><strong><a href="https://tactiq.io" target="_blank" style="color: #22d3ee;">Tactiq</a></strong> - Chrome extension for Google Meet</li>
                            <li><strong>Zoom/Teams Built-in</strong> - Enable transcription in meeting settings</li>
                        </ul>
                        <p style="color: #6b7280; margin: 10px 0 0 0; font-size: 0.8rem; font-style: italic;">
                            Tip: Always inform the interviewer you're recording for personal notes. Most are fine with it.
                        </p>
                    </div>

                    <!-- Interview Details -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                        <div class="form-group" style="margin: 0;">
                            <label>Interview Date & Time</label>
                            <input type="datetime-local" id="debriefInterviewDate">
                        </div>
                        <div class="form-group" style="margin: 0;">
                            <label>Interview Stage</label>
                            <select id="debriefInterviewStage">
                                <option value="recruiter_screen">üìû Recruiter Screen</option>
                                <option value="hiring_manager">üëî Hiring Manager</option>
                                <option value="technical">üíª Technical Interview</option>
                                <option value="panel">üë• Panel Interview</option>
                                <option value="executive">üè¢ Executive/Final Round</option>
                            </select>
                        </div>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                        <div class="form-group" style="margin: 0;">
                            <label>Interviewer Name</label>
                            <input type="text" id="debriefInterviewerName" placeholder="e.g., Jung Kim">
                        </div>
                        <div class="form-group" style="margin: 0;">
                            <label>Interviewer Title (if known)</label>
                            <input type="text" id="debriefInterviewerTitle" placeholder="e.g., Senior Recruiter, VP of Engineering">
                        </div>
                    </div>

                    <div class="form-group">
                        <label>How do you feel it went? (1-10)</label>
                        <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                            <label class="feeling-btn" style="padding: 8px 16px; background: #1f2937; border: 2px solid #374151; border-radius: 6px; cursor: pointer;">
                                <input type="radio" name="debriefFeeling" value="1" style="display: none;">
                                <span>1</span>
                            </label>
                            <label class="feeling-btn" style="padding: 8px 16px; background: #1f2937; border: 2px solid #374151; border-radius: 6px; cursor: pointer;">
                                <input type="radio" name="debriefFeeling" value="2" style="display: none;">
                                <span>2</span>
                            </label>
                            <label class="feeling-btn" style="padding: 8px 16px; background: #1f2937; border: 2px solid #374151; border-radius: 6px; cursor: pointer;">
                                <input type="radio" name="debriefFeeling" value="3" style="display: none;">
                                <span>3</span>
                            </label>
                            <label class="feeling-btn" style="padding: 8px 16px; background: #1f2937; border: 2px solid #374151; border-radius: 6px; cursor: pointer;">
                                <input type="radio" name="debriefFeeling" value="4" style="display: none;">
                                <span>4</span>
                            </label>
                            <label class="feeling-btn" style="padding: 8px 16px; background: #1f2937; border: 2px solid #374151; border-radius: 6px; cursor: pointer;">
                                <input type="radio" name="debriefFeeling" value="5" style="display: none;">
                                <span>5</span>
                            </label>
                            <label class="feeling-btn" style="padding: 8px 16px; background: #1f2937; border: 2px solid #374151; border-radius: 6px; cursor: pointer;">
                                <input type="radio" name="debriefFeeling" value="6" style="display: none;">
                                <span>6</span>
                            </label>
                            <label class="feeling-btn" style="padding: 8px 16px; background: #1f2937; border: 2px solid #374151; border-radius: 6px; cursor: pointer;">
                                <input type="radio" name="debriefFeeling" value="7" style="display: none;">
                                <span>7</span>
                            </label>
                            <label class="feeling-btn" style="padding: 8px 16px; background: #1f2937; border: 2px solid #374151; border-radius: 6px; cursor: pointer;">
                                <input type="radio" name="debriefFeeling" value="8" style="display: none;">
                                <span>8</span>
                            </label>
                            <label class="feeling-btn" style="padding: 8px 16px; background: #1f2937; border: 2px solid #374151; border-radius: 6px; cursor: pointer;">
                                <input type="radio" name="debriefFeeling" value="9" style="display: none;">
                                <span>9</span>
                            </label>
                            <label class="feeling-btn" style="padding: 8px 16px; background: #1f2937; border: 2px solid #374151; border-radius: 6px; cursor: pointer;">
                                <input type="radio" name="debriefFeeling" value="10" style="display: none;">
                                <span>10</span>
                            </label>
                        </div>
                    </div>

                    <!-- Transcript Input -->
                    <div class="form-group" style="margin-top: 20px;">
                        <label style="display: flex; align-items: center; gap: 10px;">
                            <span>üìÑ Interview Transcript</span>
                            <span style="font-size: 0.8rem; color: #6b7280; font-weight: normal;">(optional - for detailed analysis)</span>
                        </label>
                        <p style="color: #9ca3af; font-size: 0.85rem; margin-bottom: 10px;">
                            Have a transcript? Great - I'll analyze it in detail. No transcript? No problem - we can still have a productive debrief conversation.
                        </p>
                        <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                            <label style="display: inline-flex; align-items: center; gap: 8px; padding: 8px 16px; background: #1f2937; border: 1px solid #374151; border-radius: 6px; cursor: pointer; font-size: 0.9rem;">
                                <span>üìÅ Upload File</span>
                                <input type="file" id="debriefTranscriptFile" accept=".txt,.vtt,.srt" style="display: none;" onchange="handleDebriefTranscriptUpload(event)">
                            </label>
                            <span style="color: #6b7280; font-size: 0.85rem; display: flex; align-items: center;">
                                .txt, .vtt, .srt
                            </span>
                        </div>
                        <textarea id="debriefTranscript" rows="6" style="font-family: monospace; font-size: 0.85rem;"
                            placeholder="Paste your interview transcript here (or leave blank to discuss verbally)..."></textarea>
                    </div>

                    <button class="btn-generate" onclick="startDebriefConversation()" id="startDebriefBtn" style="width: 100%;">
                        üí¨ Start Debrief Conversation
                    </button>
                </div>
            </div>

            <!-- Step 2: Conversational Debrief Chat -->
            <div id="debriefChat" style="display: none;">
                <!-- Chat Header -->
                <div style="background: #1f2937; border-radius: 8px 8px 0 0; padding: 15px 20px; border-bottom: 1px solid #374151;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <h3 style="margin: 0; color: #ffffff; font-size: 1.1rem;">üéØ Interview Debrief Coach</h3>
                            <p id="debriefChatContext" style="margin: 5px 0 0 0; color: #9ca3af; font-size: 0.85rem;">
                                Recruiter Screen with Jung Kim
                            </p>
                        </div>
                        <button onclick="resetDebrief()" style="background: transparent; border: 1px solid #374151; color: #9ca3af; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 0.85rem;">
                            New Debrief
                        </button>
                    </div>
                </div>

                <!-- Chat Messages -->
                <div id="debriefMessages" style="background: #111827; min-height: 400px; max-height: 600px; overflow-y: auto; padding: 20px;">
                    <!-- Messages will be inserted here -->
                </div>

                <!-- Chat Input -->
                <div style="background: #1f2937; border-radius: 0 0 8px 8px; padding: 15px 20px;">
                    <div style="display: flex; gap: 10px;">
                        <textarea id="debriefChatInput" rows="2" style="flex: 1; resize: none; background: #111827; color: #ffffff; border: 1px solid #374151; border-radius: 6px; padding: 12px; font-family: inherit; font-size: 0.95rem;"
                            placeholder="Ask a follow-up question, request a thank-you email draft, or discuss specific moments..."
                            onkeydown="handleDebriefKeydown(event)"></textarea>
                        <button onclick="sendDebriefMessage()" id="sendDebriefBtn" style="background: #22d3ee; color: #111827; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: 600; align-self: flex-end;">
                            Send
                        </button>
                    </div>
                    <div style="display: flex; gap: 10px; margin-top: 10px; flex-wrap: wrap;">
                        <button class="quick-action-btn" onclick="sendQuickAction('Draft a thank-you email for this interview')">üìß Thank-You Email</button>
                        <button class="quick-action-btn" onclick="sendQuickAction('What should I prepare for the next round?')">üìã Next Round Prep</button>
                        <button class="quick-action-btn" onclick="sendQuickAction('Analyze my compensation discussion')">üí∞ Comp Analysis</button>
                        <button class="quick-action-btn" onclick="sendQuickAction('What questions should I have asked?')">‚ùì Missed Questions</button>
                    </div>
                </div>
            </div>

            <!-- Loading State -->
            <div id="debriefLoading" class="loading" style="display: none;">
                <div class="loading-spinner"></div>
                <div>Analyzing your interview...</div>
            </div>

            <div id="debriefResults" style="display: none;">
                <!-- Overall Score -->
                <div class="section">
                    <div class="section-header">
                        <h3 class="section-title"><span>üìä</span> Performance Analysis</h3>
                    </div>
                    <div class="section-body">
                        <div class="score-grid" id="debriefScores"></div>
                    </div>
                </div>

                <!-- Strengths & Opportunities -->
                <div class="section">
                    <div class="section-header">
                        <h3 class="section-title"><span>‚úì</span> Strengths</h3>
                    </div>
                    <div class="section-body">
                        <ul class="feedback-list strengths" id="debriefStrengths"></ul>
                    </div>
                </div>

                <div class="section">
                    <div class="section-header">
                        <h3 class="section-title"><span>‚Üí</span> Areas for Improvement</h3>
                    </div>
                    <div class="section-body">
                        <ul class="feedback-list opportunities" id="debriefOpportunities"></ul>
                    </div>
                </div>

                <!-- What They Should Have Said -->
                <div class="section" id="shouldHaveSaidSection">
                    <div class="section-header">
                        <h3 class="section-title"><span>üí°</span> What You Should Have Said</h3>
                    </div>
                    <div class="section-body" id="shouldHaveSaidContent"></div>
                </div>

                <!-- Coaching Points -->
                <div class="section">
                    <div class="section-header">
                        <h3 class="section-title"><span>üéØ</span> Coaching Points</h3>
                    </div>
                    <div class="section-body">
                        <ul class="content-list" id="coachingPoints"></ul>
                    </div>
                </div>

                <!-- Thank You Email -->
                <div class="section">
                    <div class="section-header">
                        <h3 class="section-title"><span>‚úâÔ∏è</span> Thank-You Email</h3>
                        <button class="btn-primary" onclick="copyThankYouEmail()" style="margin: 0;">
                            Copy Email
                        </button>
                    </div>
                    <div class="section-body">
                        <div class="template-text" id="thankYouEmail" style="white-space: pre-wrap;"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Mock Interview Tab -->
        <div id="mockInterviewTab" class="tab-content">
            <!-- Mock Interview UI -->
            <div id="mockStartSection">
                <div class="section">
                    <div class="section-header" style="cursor: default;">
                        <h3 class="section-title"><span>üé§</span> Mock Interview Practice</h3>
                    </div>
                    <div class="section-body">
                        <p style="color: #9ca3af; margin-bottom: 20px;">
                            Practice answering interview questions with real-time AI feedback. You'll answer 5 questions with follow-ups, just like a real interview.
                        </p>

                        <!-- 60-90 Second Pitch Guidance -->
                        <div style="background: rgba(34, 211, 238, 0.1); border: 1px solid rgba(34, 211, 238, 0.3); border-radius: 8px; padding: 15px; margin-bottom: 25px;">
                            <h4 style="color: #22d3ee; margin: 0 0 10px 0; font-size: 1rem;">üí° Your 60-90 Second Pitch</h4>
                            <p style="color: #d1d5db; margin: 0; font-size: 0.9rem; line-height: 1.5;">
                                The interview will start with <strong>"Tell me about yourself"</strong> ‚Äî your chance to deliver a compelling 60-90 second pitch. Structure it as:
                            </p>
                            <ul style="color: #9ca3af; margin: 10px 0 0 0; padding-left: 20px; font-size: 0.85rem; line-height: 1.6;">
                                <li><strong>Present:</strong> Your current role and key accomplishments</li>
                                <li><strong>Past:</strong> Relevant experience that led you here</li>
                                <li><strong>Future:</strong> Why this role excites you and what you'll bring</li>
                            </ul>
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 25px;">
                            <div class="form-group">
                                <label>Interview Stage</label>
                                <select id="mockInterviewStage">
                                    <option value="recruiter_screen">üìû Recruiter Screen</option>
                                    <option value="hiring_manager">üëî Hiring Manager</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Difficulty Level</label>
                                <select id="mockDifficulty">
                                    <option value="easy">Easy - Straightforward questions</option>
                                    <option value="medium" selected>Medium - Standard interview</option>
                                    <option value="hard">Hard - Challenging scenarios</option>
                                </select>
                            </div>
                        </div>

                        <!-- Response Mode Selection -->
                        <div style="margin-bottom: 25px;">
                            <label style="color: #d1d5db; margin-bottom: 10px; display: block;">Response Mode</label>
                            <div style="display: flex; gap: 15px;">
                                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 12px 20px; background: rgba(34, 211, 238, 0.1); border: 2px solid #22d3ee; border-radius: 8px; flex: 1; justify-content: center;">
                                    <input type="radio" name="responseMode" value="text" checked style="accent-color: #22d3ee;">
                                    <span>‚å®Ô∏è Type Responses</span>
                                </label>
                                <label id="voiceModeLabel" style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 12px 20px; background: #1f2937; border: 2px solid #374151; border-radius: 8px; flex: 1; justify-content: center;">
                                    <input type="radio" name="responseMode" value="voice" style="accent-color: #22d3ee;">
                                    <span>üé§ Voice Recording</span>
                                </label>
                                <label id="conversationalModeLabel" style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 12px 20px; background: #1f2937; border: 2px solid #374151; border-radius: 8px; flex: 1; justify-content: center;">
                                    <input type="radio" name="responseMode" value="conversational" style="accent-color: #22d3ee;">
                                    <span>üí¨ Conversational</span>
                                </label>
                            </div>
                            <p id="modeDescription" style="color: #9ca3af; font-size: 0.85rem; margin-top: 10px; text-align: center;">
                                Type your responses in the text box
                            </p>
                        </div>

                        <div style="text-align: center;">
                            <button class="btn-generate" onclick="startMockInterview()" id="startMockBtn">
                                üé§ Start Mock Interview
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Active Mock Interview -->
            <div id="mockActiveSection" style="display: none;">
                <div class="section">
                    <div class="section-header" style="cursor: default;">
                        <h3 class="section-title">
                            <span>‚ùì</span>
                            <span id="mockQuestionTitle">Question 1/5</span>
                        </h3>
                        <span id="mockCompetency" style="color: #22d3ee; font-size: 0.9rem;"></span>
                    </div>
                    <div class="section-body">
                        <div id="mockQuestionText" style="font-size: 1.2rem; color: #ffffff; margin-bottom: 20px; line-height: 1.6;"></div>

                        <div id="mockFollowUpIndicator" style="display: none; color: #f59e0b; margin-bottom: 15px; font-size: 0.9rem;">
                            üìå Follow-up question
                        </div>

                        <div class="form-group">
                            <label style="display: flex; justify-content: space-between; align-items: center;">
                                <span>Your Response</span>
                                <span id="recordingStatus" style="color: #f87171; font-size: 0.85rem; display: none;">
                                    üî¥ Recording...
                                </span>
                            </label>
                            <textarea id="mockResponseText" rows="6" placeholder="Type your answer here or click the microphone to record... Be specific and use examples from your experience."></textarea>
                        </div>

                        <div style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
                            <!-- Voice Recording Button -->
                            <button class="btn-primary" onclick="toggleRecording()" id="recordBtn" style="background: #374151; min-width: 50px;">
                                üé§
                            </button>
                            <button class="btn-primary" onclick="submitMockResponse()" id="submitMockResponseBtn">
                                Submit Response
                            </button>
                            <span id="mockResponseNumber" style="color: #9ca3af; font-size: 0.9rem;"></span>
                            <span id="recordingTime" style="color: #9ca3af; font-size: 0.9rem; display: none;"></span>
                        </div>

                        <!-- Transcription status -->
                        <div id="transcriptionStatus" style="display: none; margin-top: 10px; padding: 10px; background: rgba(34, 211, 238, 0.1); border-radius: 8px; color: #22d3ee; font-size: 0.9rem;">
                            <span class="loading-spinner" style="width: 16px; height: 16px; display: inline-block; vertical-align: middle; margin-right: 8px;"></span>
                            Transcribing your response...
                        </div>
                    </div>
                </div>

                <!-- Brief Feedback -->
                <div id="mockBriefFeedback" class="section" style="display: none;">
                    <div class="section-header" style="cursor: default;">
                        <h3 class="section-title"><span>üí°</span> Quick Coaching</h3>
                    </div>
                    <div class="section-body">
                        <p id="mockBriefFeedbackText" style="color: #d1d5db;"></p>
                        <div style="margin-top: 20px; display: flex; gap: 15px;">
                            <button class="btn-primary" onclick="continueFollowUp()" id="continueFollowUpBtn" style="display: none;">
                                Answer Follow-Up
                            </button>
                            <button class="btn-primary" onclick="showQuestionFeedback()" id="showFeedbackBtn" style="display: none;">
                                View Full Feedback
                            </button>
                            <button class="btn-primary" onclick="nextMockQuestion()" id="nextQuestionBtn" style="display: none;">
                                Next Question ‚Üí
                            </button>
                            <button class="btn-primary" onclick="endMockInterview()" id="endSessionBtn" style="display: none;">
                                End Session & Get Results
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Question Feedback -->
            <div id="mockQuestionFeedback" class="section" style="display: none;">
                <div class="section-header" style="cursor: default;">
                    <h3 class="section-title"><span>üìä</span> Question Feedback</h3>
                </div>
                <div class="section-body">
                    <div class="score-grid" style="grid-template-columns: repeat(2, 1fr); margin-bottom: 25px;">
                        <div class="score-card">
                            <div class="score" id="qfScore">-</div>
                            <div class="label">Score</div>
                        </div>
                        <div class="score-card">
                            <div class="score" id="qfLevel" style="font-size: 1.5rem;">-</div>
                            <div class="label">Level Demonstrated</div>
                        </div>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 25px;">
                        <div>
                            <h4 style="color: #4ade80; margin-bottom: 10px;">‚úì What Landed</h4>
                            <ul class="feedback-list strengths" id="qfWhatLanded"></ul>
                        </div>
                        <div>
                            <h4 style="color: #f87171; margin-bottom: 10px;">‚úó What Didn't Land</h4>
                            <ul class="feedback-list opportunities" id="qfWhatDidntLand"></ul>
                        </div>
                    </div>

                    <div style="margin-bottom: 25px;">
                        <h4 style="color: #60a5fa; margin-bottom: 10px;">üéØ Coaching</h4>
                        <p id="qfCoaching" style="color: #d1d5db; line-height: 1.7;"></p>
                    </div>

                    <div class="revised-version">
                        <h4>üí° Here's What You Could Have Said</h4>
                        <p id="qfRevisedAnswer" style="color: #d1d5db; line-height: 1.7; margin-top: 10px;"></p>
                    </div>

                    <div style="margin-top: 20px; display: flex; gap: 15px;">
                        <button class="btn-primary" onclick="nextMockQuestion()" id="feedbackNextBtn">
                            Next Question ‚Üí
                        </button>
                        <button class="btn-primary" onclick="endMockInterview()" id="feedbackEndBtn" style="display: none;">
                            End Session & Get Results
                        </button>
                    </div>
                </div>
            </div>

            <!-- Session Results -->
            <div id="mockSessionResults" style="display: none;">
                <div class="section">
                    <div class="section-header" style="cursor: default;">
                        <h3 class="section-title"><span>üèÜ</span> Session Complete</h3>
                    </div>
                    <div class="section-body">
                        <div class="score-grid" style="margin-bottom: 25px;">
                            <div class="score-card">
                                <div class="score" id="sessionScore">-</div>
                                <div class="label">Overall Score</div>
                            </div>
                            <div class="score-card">
                                <div class="score" id="sessionQuestions" style="font-size: 2rem;">-</div>
                                <div class="label">Questions</div>
                            </div>
                            <div class="score-card">
                                <div class="score" id="sessionReadiness" style="font-size: 1.2rem;">-</div>
                                <div class="label">Readiness</div>
                            </div>
                            <div class="score-card">
                                <div class="score" id="sessionLevelEstimate" style="font-size: 1.2rem; text-transform: capitalize;">-</div>
                                <div class="label">Level Demonstrated</div>
                            </div>
                        </div>

                        <div style="margin-bottom: 25px;">
                            <h4 style="color: #60a5fa; margin-bottom: 10px;">üìã Overall Assessment</h4>
                            <p id="sessionAssessment" style="color: #d1d5db; line-height: 1.7;"></p>
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 25px;">
                            <div>
                                <h4 style="color: #4ade80; margin-bottom: 10px;">üí™ Key Strengths</h4>
                                <ul class="content-list" id="sessionStrengths"></ul>
                            </div>
                            <div>
                                <h4 style="color: #f59e0b; margin-bottom: 10px;">üìà Areas to Improve</h4>
                                <ul class="content-list" id="sessionImprove"></ul>
                            </div>
                        </div>

                        <div style="margin-bottom: 25px;">
                            <h4 style="color: #22d3ee; margin-bottom: 10px;">üéØ Coaching Priorities</h4>
                            <ul class="content-list" id="sessionPriorities"></ul>
                        </div>

                        <div style="margin-bottom: 25px;" id="sessionDrillsSection">
                            <h4 style="color: #a78bfa; margin-bottom: 10px;">üèãÔ∏è Recommended Drills</h4>
                            <ul class="content-list" id="sessionDrills"></ul>
                        </div>

                        <div class="strategy-box">
                            <h4>üìå Next Steps</h4>
                            <p id="sessionNextSteps"></p>
                        </div>

                        <div style="margin-top: 25px; text-align: center;">
                            <button class="btn-generate" onclick="resetMockInterview()">
                                üé§ Start Another Mock Interview
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Question Summaries -->
                <div class="section">
                    <div class="section-header" onclick="toggleSection(this)">
                        <h3 class="section-title"><span>üìù</span> Question Summaries</h3>
                        <span class="section-toggle">‚ñº</span>
                    </div>
                    <div class="section-body" id="sessionQuestionSummaries"></div>
                </div>
            </div>

            <!-- Loading State -->
            <div id="mockLoading" class="loading" style="display: none;">
                <div class="loading-spinner"></div>
                <div id="mockLoadingText">Generating your question...</div>
            </div>
        </div>

        <!-- Practice Drills Tab -->
        <div id="drillsTab" class="tab-content">
            <div class="section">
                <div class="section-header" style="cursor: default;">
                    <h3 class="section-title"><span>üèãÔ∏è</span> Practice Drills</h3>
                </div>
                <div class="section-body">
                    <p style="color: #9ca3af; margin-bottom: 20px;">
                        Quick targeted drills to strengthen specific interview skills. Each drill focuses on a key signal that interviewers evaluate.
                    </p>

                    <!-- Drill Categories -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 15px; margin-bottom: 25px;">
                        <!-- Metrics Drill -->
                        <div class="drill-card" style="background: #1f2937; border: 1px solid #374151; border-radius: 8px; padding: 15px; cursor: pointer;" onclick="startDrill('metrics')">
                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                                <span style="font-size: 1.5rem;">üìä</span>
                                <h4 style="color: #22d3ee; margin: 0;">Metrics Orientation</h4>
                            </div>
                            <p style="color: #9ca3af; font-size: 0.9rem; margin: 0;">Practice adding specific numbers and measurable outcomes to your stories.</p>
                        </div>

                        <!-- Ownership Drill -->
                        <div class="drill-card" style="background: #1f2937; border: 1px solid #374151; border-radius: 8px; padding: 15px; cursor: pointer;" onclick="startDrill('ownership')">
                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                                <span style="font-size: 1.5rem;">üí™</span>
                                <h4 style="color: #4ade80; margin: 0;">Ownership & Accountability</h4>
                            </div>
                            <p style="color: #9ca3af; font-size: 0.9rem; margin: 0;">Rewrite stories using "I" statements and personal accountability.</p>
                        </div>

                        <!-- Strategic Thinking Drill -->
                        <div class="drill-card" style="background: #1f2937; border: 1px solid #374151; border-radius: 8px; padding: 15px; cursor: pointer;" onclick="startDrill('strategy')">
                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                                <span style="font-size: 1.5rem;">üéØ</span>
                                <h4 style="color: #f59e0b; margin: 0;">Strategic Thinking</h4>
                            </div>
                            <p style="color: #9ca3af; font-size: 0.9rem; margin: 0;">Practice framing answers with business context first.</p>
                        </div>

                        <!-- Stakeholder Management Drill -->
                        <div class="drill-card" style="background: #1f2937; border: 1px solid #374151; border-radius: 8px; padding: 15px; cursor: pointer;" onclick="startDrill('stakeholder')">
                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                                <span style="font-size: 1.5rem;">ü§ù</span>
                                <h4 style="color: #a78bfa; margin: 0;">Stakeholder Management</h4>
                            </div>
                            <p style="color: #9ca3af; font-size: 0.9rem; margin: 0;">Add examples of cross-functional influence to your stories.</p>
                        </div>

                        <!-- Communication Clarity Drill -->
                        <div class="drill-card" style="background: #1f2937; border: 1px solid #374151; border-radius: 8px; padding: 15px; cursor: pointer;" onclick="startDrill('communication')">
                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                                <span style="font-size: 1.5rem;">üó£Ô∏è</span>
                                <h4 style="color: #60a5fa; margin: 0;">Communication Clarity</h4>
                            </div>
                            <p style="color: #9ca3af; font-size: 0.9rem; margin: 0;">Practice STAR structure: Situation, Task, Action, Result.</p>
                        </div>

                        <!-- Problem Solving Drill -->
                        <div class="drill-card" style="background: #1f2937; border: 1px solid #374151; border-radius: 8px; padding: 15px; cursor: pointer;" onclick="startDrill('problem_solving')">
                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                                <span style="font-size: 1.5rem;">üß©</span>
                                <h4 style="color: #ec4899; margin: 0;">Problem Solving</h4>
                            </div>
                            <p style="color: #9ca3af; font-size: 0.9rem; margin: 0;">Practice explaining your decision-making framework step by step.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Active Drill Section (hidden by default) -->
            <div id="activeDrillSection" style="display: none;">
                <div class="section">
                    <div class="section-header" style="cursor: default;">
                        <h3 class="section-title">
                            <span id="drillIcon">üìä</span>
                            <span id="drillTitle">Metrics Drill</span>
                        </h3>
                    </div>
                    <div class="section-body">
                        <div id="drillPrompt" class="question-card" style="margin-bottom: 20px;">
                            <p style="color: #d1d5db; line-height: 1.7;" id="drillQuestion"></p>
                        </div>

                        <div style="margin-bottom: 20px;">
                            <h4 style="color: #60a5fa; margin-bottom: 10px;">Your Response</h4>
                            <textarea id="drillResponse" style="width: 100%; min-height: 150px; background: #111827; color: #ffffff; border: 1px solid #374151; border-radius: 8px; padding: 12px; resize: vertical; font-family: inherit; font-size: 0.95rem;" placeholder="Type your answer here..."></textarea>
                        </div>

                        <div style="display: flex; gap: 10px;">
                            <button class="btn-generate" onclick="submitDrillResponse()" id="submitDrillBtn">
                                Get Feedback
                            </button>
                            <button style="background: transparent; border: 1px solid #374151; color: #9ca3af; padding: 12px 20px; border-radius: 8px; cursor: pointer;" onclick="cancelDrill()">
                                Cancel
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Drill Feedback -->
                <div id="drillFeedbackSection" style="display: none;">
                    <div class="section">
                        <div class="section-header" style="cursor: default;">
                            <h3 class="section-title"><span>üìù</span> Feedback</h3>
                        </div>
                        <div class="section-body">
                            <div id="drillFeedbackContent"></div>
                            <div style="margin-top: 20px; display: flex; gap: 10px;">
                                <button class="btn-generate" onclick="tryDrillAgain()">
                                    Try Again
                                </button>
                                <button style="background: #1f2937; border: 1px solid #374151; color: #22d3ee; padding: 12px 20px; border-radius: 8px; cursor: pointer;" onclick="nextDrill()">
                                    Next Drill
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Drill Loading State -->
            <div id="drillLoading" class="loading" style="display: none;">
                <div class="loading-spinner"></div>
                <div>Analyzing your response...</div>
            </div>
        </div>

        <!-- Navigation -->
        <div class="navigation" style="justify-content: center;">
            <a href="overview.html" class="btn btn-cta">‚Üê Return to Strategy Overview</a>
        </div>
    </div>

    <script>
        // Configuration
        const API_BASE = window.location.hostname === 'localhost' ? 'http://localhost:8000' : 'https://henryai-app-production.up.railway.app';

        // State
        let currentStage = 'recruiter_screen';
        let analysisData = null;
        let prepData = null;
        let introSellTemplate = null;

        // Load analysis data from sessionStorage
        document.addEventListener('DOMContentLoaded', () => {
            const storedAnalysis = sessionStorage.getItem('analysisData');
            if (storedAnalysis) {
                try {
                    analysisData = JSON.parse(storedAnalysis);
                    console.log('Analysis data loaded:', analysisData);
                } catch (e) {
                    console.error('Error parsing analysis data:', e);
                }
            }

            // Set today's date as default for debrief
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('interviewDate').value = today;

            // Update practice textarea word count (if element exists)
            const practiceTextarea = document.getElementById('practiceTextarea');
            if (practiceTextarea) {
                practiceTextarea.addEventListener('input', updatePracticeStats);
            }
        });

        // Stage selection
        function selectStage(stage) {
            currentStage = stage;
            document.querySelectorAll('.stage-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.stage === stage);
            });

            // Reset prep content when stage changes
            document.getElementById('prepContent').style.display = 'none';
            document.getElementById('prepGenerateSection').style.display = 'block';
            prepData = null;
        }

        // Section toggle functions
        function toggleSection(headerEl) {
            const section = headerEl.closest('.section');
            section.classList.toggle('collapsed');
        }

        function expandAllSections() {
            document.querySelectorAll('.section.collapsible').forEach(section => {
                section.classList.remove('collapsed');
            });
        }

        function collapseAllSections() {
            document.querySelectorAll('.section.collapsible').forEach(section => {
                section.classList.add('collapsed');
            });
        }

        // Tab switching
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

            event.target.classList.add('active');
            document.getElementById(tabName + 'Tab').classList.add('active');

            // Auto-generate intro sell template when switching to that tab
            if (tabName === 'intro-sell' && !introSellTemplate) {
                generateIntroSellTemplate();
            }
        }

        // Helper to get resume JSON
        function getResumeJson() {
            if (!analysisData) return {};

            // Try multiple sources
            return analysisData._resume_json ||
                   analysisData._profile ||
                   {
                       full_name: analysisData._candidate_name || 'Candidate',
                       summary: analysisData.summary || '',
                       experience: [],
                       skills: [],
                       core_competencies: []
                   };
        }

        // Helper to get job description
        function getJobDescription() {
            if (!analysisData) return '';
            return analysisData._job_description ||
                   analysisData.job_description ||
                   `Role: ${analysisData.role_title || ''}\nCompany: ${analysisData._company_name || ''}`;
        }

        // Generate Interview Prep
        async function generatePrep() {
            const btn = document.getElementById('generatePrepBtn');
            const loadingEl = document.getElementById('prepLoading');
            const generateSection = document.getElementById('prepGenerateSection');
            const contentEl = document.getElementById('prepContent');

            btn.disabled = true;
            btn.textContent = 'Generating...';
            generateSection.style.display = 'none';
            loadingEl.style.display = 'block';

            try {
                const response = await fetch(`${API_BASE}/api/interview-prep/generate`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        resume_json: getResumeJson(),
                        job_description: getJobDescription(),
                        company: analysisData?._company_name || 'Company',
                        role_title: analysisData?.role_title || 'Role',
                        interview_stage: currentStage,
                        jd_analysis: analysisData
                    })
                });

                if (!response.ok) throw new Error('Failed to generate prep');

                prepData = await response.json();
                renderPrepContent(prepData.prep_content);

                loadingEl.style.display = 'none';
                contentEl.style.display = 'block';

            } catch (error) {
                console.error('Error generating prep:', error);
                alert('Error generating interview prep: ' + error.message);
                generateSection.style.display = 'block';
                loadingEl.style.display = 'none';
            } finally {
                btn.disabled = false;
                btn.textContent = 'Generate Interview Prep';
            }
        }

        // Render prep content
        function renderPrepContent(content) {
            // Overview
            document.getElementById('interviewOverview').textContent = content.interview_overview || '';

            // Talking points / Strengths
            const talkingPointsTitle = document.getElementById('talkingPointsTitle');
            const talkingPointsList = document.getElementById('talkingPointsList');

            if (currentStage === 'recruiter_screen') {
                talkingPointsTitle.textContent = 'Key Talking Points';
                renderList(talkingPointsList, content.key_talking_points || []);
            } else {
                talkingPointsTitle.textContent = 'Strengths to Emphasize';
                renderList(talkingPointsList, content.strengths_to_emphasize || []);
            }

            // Red flags / Gaps
            const mitigationTitle = document.getElementById('mitigationTitle');
            const mitigationContent = document.getElementById('mitigationContent');

            if (currentStage === 'recruiter_screen') {
                mitigationTitle.textContent = 'Red Flag Mitigation';
                renderMitigationCards(mitigationContent, content.red_flag_mitigation || []);
            } else {
                mitigationTitle.textContent = 'Gaps to Mitigate';
                renderList(mitigationContent, content.gaps_to_mitigate || [], true);
            }

            // STAR Examples (hiring manager only)
            const starSection = document.getElementById('starExamplesSection');
            if (currentStage === 'hiring_manager') {
                starSection.style.display = 'block';
                renderStarExamples(document.getElementById('starExamplesContent'), content.star_examples || []);
            } else {
                starSection.style.display = 'none';
            }

            // Likely questions with answers
            renderLikelyQuestions(document.getElementById('likelyQuestionsContent'), content.likely_questions || []);

            // Questions to ask
            renderQuestionsToAsk(document.getElementById('questionsToAskContent'), content.questions_to_ask || []);

            // Strategy sections (now collapsible)
            const strategyBoxes = document.getElementById('strategyBoxes');
            strategyBoxes.innerHTML = '';

            if (currentStage === 'recruiter_screen') {
                if (content.compensation_expectations) {
                    strategyBoxes.innerHTML += `
                        <div class="section collapsible">
                            <div class="section-header" onclick="toggleSection(this)">
                                <h3 class="section-title"><span>üí∞</span> Compensation Expectations</h3>
                                <span class="section-toggle">‚ñº</span>
                            </div>
                            <div class="section-body">
                                <div class="strategy-box" style="margin-top: 0;">
                                    <p>${content.compensation_expectations}</p>
                                </div>
                            </div>
                        </div>
                    `;
                }
                if (content.timeline_strategy) {
                    strategyBoxes.innerHTML += `
                        <div class="section collapsible">
                            <div class="section-header" onclick="toggleSection(this)">
                                <h3 class="section-title"><span>üìÖ</span> Timeline Strategy</h3>
                                <span class="section-toggle">‚ñº</span>
                            </div>
                            <div class="section-body">
                                <div class="strategy-box" style="margin-top: 0;">
                                    <p>${content.timeline_strategy}</p>
                                </div>
                            </div>
                        </div>
                    `;
                }
            } else {
                if (content.closing_strategy) {
                    strategyBoxes.innerHTML += `
                        <div class="section collapsible">
                            <div class="section-header" onclick="toggleSection(this)">
                                <h3 class="section-title"><span>üéØ</span> Closing Strategy</h3>
                                <span class="section-toggle">‚ñº</span>
                            </div>
                            <div class="section-body">
                                <div class="strategy-box" style="margin-top: 0;">
                                    <p>${content.closing_strategy}</p>
                                </div>
                            </div>
                        </div>
                    `;
                }
            }
        }

        function renderList(container, items, asUl = false) {
            if (asUl) {
                container.innerHTML = `<ul class="content-list">${items.map(item => `<li>${item}</li>`).join('')}</ul>`;
            } else {
                container.innerHTML = items.map(item => `<li>${item}</li>`).join('');
            }
        }

        function renderMitigationCards(container, items) {
            container.innerHTML = items.map(item => `
                <div class="mitigation-card">
                    <div class="flag">‚ö†Ô∏è ${item.flag || item}</div>
                    <div class="mitigation">${item.mitigation || ''}</div>
                </div>
            `).join('');
        }

        function renderStarExamples(container, examples) {
            container.innerHTML = examples.map(ex => `
                <div class="star-card">
                    <div class="competency">${ex.competency}</div>
                    <div class="star-section">
                        <div class="star-label">Situation</div>
                        <div class="star-text">${ex.situation}</div>
                    </div>
                    <div class="star-section">
                        <div class="star-label">Task</div>
                        <div class="star-text">${ex.task}</div>
                    </div>
                    <div class="star-section">
                        <div class="star-label">Action</div>
                        <div class="star-text">${ex.action}</div>
                    </div>
                    <div class="star-section">
                        <div class="star-label">Result</div>
                        <div class="star-text">${ex.result}</div>
                    </div>
                </div>
            `).join('');
        }

        function renderLikelyQuestions(container, questions) {
            console.log('Likely questions data:', JSON.stringify(questions, null, 2));
            container.innerHTML = questions.map(q => {
                // Handle both string and object formats
                const question = typeof q === 'string' ? q : (q.question || '');
                const answer = typeof q === 'object' ? (q.suggested_answer || q.answer || '') : '';

                return `
                    <div class="question-card" style="border-left-color: #f59e0b;">
                        <div class="question">${question}</div>
                        ${answer ? `
                            <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #374151;">
                                <div style="color: #4ade80; font-size: 0.85rem; font-weight: 600; margin-bottom: 6px;">SUGGESTED ANSWER</div>
                                <div style="color: #d1d5db;">${answer}</div>
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }

        function renderQuestionsToAsk(container, questions) {
            container.innerHTML = questions.map(q => `
                <div class="question-card">
                    <div class="question">${q.question || q}</div>
                    <div class="rationale">${q.why || ''}</div>
                </div>
            `).join('');
        }

        // Generate Intro Sell Template
        async function generateIntroSellTemplate() {
            const btn = document.getElementById('generateTemplateBtn');
            const loadingEl = document.getElementById('templateLoading');
            const contentEl = document.getElementById('templateContent');

            btn.disabled = true;
            loadingEl.style.display = 'block';
            contentEl.style.display = 'none';

            try {
                const response = await fetch(`${API_BASE}/api/interview-prep/intro-sell/generate`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        resume_json: getResumeJson(),
                        job_description: getJobDescription(),
                        company: analysisData?._company_name || 'Company',
                        role_title: analysisData?.role_title || 'Role'
                    })
                });

                if (!response.ok) throw new Error('Failed to generate template');

                introSellTemplate = await response.json();

                document.getElementById('introSellTemplate').textContent = introSellTemplate.template;
                document.getElementById('templateWordCount').textContent = `${introSellTemplate.word_count} words (~${Math.round(introSellTemplate.word_count / 140 * 60)} seconds)`;
                document.getElementById('templateCoachingNote').textContent = introSellTemplate.coaching_note;

                loadingEl.style.display = 'none';
                contentEl.style.display = 'block';

            } catch (error) {
                console.error('Error generating template:', error);
                loadingEl.innerHTML = '<div class="empty-state">Error generating template. Please try again.</div>';
            } finally {
                btn.disabled = false;
            }
        }

        // Update practice stats
        function updatePracticeStats() {
            const text = document.getElementById('practiceTextarea').value;
            const wordCount = text.trim() ? text.trim().split(/\s+/).length : 0;
            const timeSeconds = Math.round(wordCount / 140 * 60);

            document.getElementById('practiceWordCount').textContent = wordCount;
            document.getElementById('practiceTime').textContent = timeSeconds;
        }

        // Submit intro sell for feedback
        async function submitIntroSellForFeedback() {
            const text = document.getElementById('practiceTextarea').value.trim();
            if (!text) {
                alert('Please enter your intro sell practice text first.');
                return;
            }

            const btn = document.getElementById('getFeedbackBtn');
            const feedbackSection = document.getElementById('feedbackSection');

            btn.disabled = true;
            btn.textContent = 'Analyzing...';

            try {
                const response = await fetch(`${API_BASE}/api/interview-prep/intro-sell/feedback`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        resume_json: getResumeJson(),
                        job_description: getJobDescription(),
                        company: analysisData?._company_name || 'Company',
                        role_title: analysisData?.role_title || 'Role',
                        candidate_version: text
                    })
                });

                if (!response.ok) throw new Error('Failed to get feedback');

                const feedback = await response.json();

                // Render scores
                document.getElementById('overallScore').textContent = feedback.overall_score.toFixed(1);
                document.getElementById('contentScore').textContent = feedback.content_score;
                document.getElementById('structureScore').textContent = feedback.structure_score;
                document.getElementById('toneScore').textContent = feedback.tone_score;

                // Render strengths
                document.getElementById('feedbackStrengths').innerHTML =
                    feedback.strengths.map(s => `<li>${s}</li>`).join('');

                // Render opportunities
                document.getElementById('feedbackOpportunities').innerHTML =
                    feedback.opportunities.map(o => `<li>${o}</li>`).join('');

                // Render revised version
                document.getElementById('revisedVersion').textContent = feedback.revised_version;

                // Render coaching note
                document.getElementById('feedbackCoachingNote').textContent = feedback.coaching_note;

                feedbackSection.classList.add('active');

            } catch (error) {
                console.error('Error getting feedback:', error);
                alert('Error getting feedback: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.textContent = 'Get Feedback';
            }
        }

        // ============================================================================
        // CONVERSATIONAL DEBRIEF SYSTEM
        // ============================================================================

        // Debrief conversation state
        let debriefConversation = {
            context: null,
            messages: [],
            transcript: null
        };

        // Handle feeling button selection
        document.querySelectorAll('.feeling-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.feeling-btn').forEach(b => b.classList.remove('selected'));
                btn.classList.add('selected');
            });
        });

        // Handle transcript file upload for debrief
        async function handleDebriefTranscriptUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const textarea = document.getElementById('debriefTranscript');

            try {
                if (file.name.endsWith('.txt') || file.name.endsWith('.vtt') || file.name.endsWith('.srt')) {
                    const text = await file.text();
                    textarea.value = text;
                } else {
                    alert('Unsupported file type. Please use .txt, .vtt, or .srt files.');
                }
            } catch (error) {
                console.error('Error reading file:', error);
                alert('Error reading file. Please paste the transcript directly.');
            }
        }

        // Start the debrief conversation
        async function startDebriefConversation() {
            const transcript = document.getElementById('debriefTranscript').value.trim();
            const interviewerName = document.getElementById('debriefInterviewerName').value.trim();
            const interviewerTitle = document.getElementById('debriefInterviewerTitle').value.trim();
            const interviewDate = document.getElementById('debriefInterviewDate').value;
            const interviewStage = document.getElementById('debriefInterviewStage').value;
            const feelingBtn = document.querySelector('input[name="debriefFeeling"]:checked');
            const feeling = feelingBtn ? feelingBtn.value : null;

            // Store context - transcript is now optional
            debriefConversation.context = {
                interviewerName: interviewerName || 'the interviewer',
                interviewerTitle: interviewerTitle || '',
                interviewDate: interviewDate,
                interviewStage: interviewStage,
                feeling: feeling,
                company: analysisData?._company_name || 'the company',
                roleTitle: analysisData?.role_title || 'the role',
                candidateName: analysisData?._candidate_name || 'Candidate',
                hasTranscript: !!transcript
            };
            debriefConversation.transcript = transcript || null;
            debriefConversation.messages = [];

            // Update chat header context
            const stageLabels = {
                'recruiter_screen': 'Recruiter Screen',
                'hiring_manager': 'Hiring Manager',
                'technical': 'Technical Interview',
                'panel': 'Panel Interview',
                'executive': 'Executive/Final Round'
            };
            document.getElementById('debriefChatContext').textContent =
                `${stageLabels[interviewStage]} with ${interviewerName || 'Interviewer'}${interviewerTitle ? ` (${interviewerTitle})` : ''}`;

            // Show chat interface
            document.getElementById('debriefSetup').style.display = 'none';
            document.getElementById('debriefChat').style.display = 'block';

            // Send initial analysis or greeting
            await sendInitialAnalysis();
        }

        // Send initial analysis
        async function sendInitialAnalysis() {
            const messagesEl = document.getElementById('debriefMessages');
            messagesEl.innerHTML = '<div class="chat-message assistant"><div class="content">Analyzing your interview transcript...</div></div>';

            try {
                const response = await fetch(`${API_BASE}/api/debrief/chat`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        resume_json: getResumeJson(),
                        job_description: getJobDescription(),
                        context: debriefConversation.context,
                        transcript: debriefConversation.transcript,
                        conversation_history: [],
                        user_message: null // Initial analysis, no user message yet
                    })
                });

                if (!response.ok) throw new Error('Failed to analyze interview');

                const data = await response.json();

                // Add assistant's analysis to conversation
                debriefConversation.messages.push({
                    role: 'assistant',
                    content: data.response
                });

                // Render the message
                messagesEl.innerHTML = '';
                renderMessage('assistant', data.response);

            } catch (error) {
                console.error('Error:', error);
                messagesEl.innerHTML = `<div class="chat-message assistant"><div class="content" style="color: #ef4444;">Error analyzing interview: ${error.message}. Please try again.</div></div>`;
            }
        }

        // Send a follow-up message
        async function sendDebriefMessage() {
            const input = document.getElementById('debriefChatInput');
            const message = input.value.trim();

            if (!message) return;

            // Add user message to UI
            renderMessage('user', message);
            input.value = '';

            // Add to conversation history
            debriefConversation.messages.push({
                role: 'user',
                content: message
            });

            // Show typing indicator
            const messagesEl = document.getElementById('debriefMessages');
            const typingEl = document.createElement('div');
            typingEl.className = 'chat-message assistant';
            typingEl.id = 'typing-indicator';
            typingEl.innerHTML = '<div class="content" style="color: #9ca3af;">Thinking...</div>';
            messagesEl.appendChild(typingEl);
            messagesEl.scrollTop = messagesEl.scrollHeight;

            try {
                const response = await fetch(`${API_BASE}/api/debrief/chat`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        resume_json: getResumeJson(),
                        job_description: getJobDescription(),
                        context: debriefConversation.context,
                        transcript: debriefConversation.transcript,
                        conversation_history: debriefConversation.messages.slice(0, -1), // Exclude the message we just added
                        user_message: message
                    })
                });

                // Remove typing indicator
                document.getElementById('typing-indicator')?.remove();

                if (!response.ok) throw new Error('Failed to get response');

                const data = await response.json();

                // Add assistant response to conversation
                debriefConversation.messages.push({
                    role: 'assistant',
                    content: data.response
                });

                // Render the response
                renderMessage('assistant', data.response);

            } catch (error) {
                document.getElementById('typing-indicator')?.remove();
                renderMessage('assistant', `Error: ${error.message}. Please try again.`);
            }
        }

        // Render a chat message
        function renderMessage(role, content) {
            const messagesEl = document.getElementById('debriefMessages');
            const messageEl = document.createElement('div');
            messageEl.className = `chat-message ${role}`;

            const senderName = role === 'assistant' ? 'üéØ Debrief Coach' : 'üë§ You';

            // Convert markdown-like formatting to HTML
            let formattedContent = content
                // Convert ## headers to styled headings with spacing
                .replace(/^## (.*?)$/gm, '<h4 style="color: #22d3ee; margin: 20px 0 10px 0; font-size: 1rem;">$1</h4>')
                // Convert **bold** to strong
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                // Convert bullet points
                .replace(/^- (.*?)$/gm, '<li style="margin-left: 20px; margin-bottom: 5px;">$1</li>')
                .replace(/^‚Ä¢ (.*?)$/gm, '<li style="margin-left: 20px; margin-bottom: 5px;">$1</li>')
                // Convert numbered lists
                .replace(/^(\d+)\. (.*?)$/gm, '<li style="margin-left: 20px; margin-bottom: 5px;"><strong>$1.</strong> $2</li>')
                // Convert double newlines to paragraph breaks with spacing
                .replace(/\n\n/g, '</p><p style="margin-top: 12px;">')
                // Convert single newlines to line breaks
                .replace(/\n/g, '<br>');

            messageEl.innerHTML = `
                <div class="sender">${senderName}</div>
                <div class="content"><p>${formattedContent}</p></div>
            `;

            messagesEl.appendChild(messageEl);
            messagesEl.scrollTop = messagesEl.scrollHeight;
        }

        // Handle Enter key in chat input
        function handleDebriefKeydown(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendDebriefMessage();
            }
        }

        // Quick action buttons
        function sendQuickAction(message) {
            document.getElementById('debriefChatInput').value = message;
            sendDebriefMessage();
        }

        // Reset debrief to start over
        function resetDebrief() {
            debriefConversation = { context: null, messages: [], transcript: null };
            document.getElementById('debriefChat').style.display = 'none';
            document.getElementById('debriefSetup').style.display = 'block';
            document.getElementById('debriefMessages').innerHTML = '';
            document.getElementById('debriefTranscript').value = '';
            document.querySelectorAll('.feeling-btn').forEach(b => b.classList.remove('selected'));
        }

        // Legacy debrief support (kept for backwards compatibility)
        // Submit debrief
        async function submitDebrief(event) {
            event.preventDefault();

            const btn = document.getElementById('submitDebriefBtn');
            const loadingEl = document.getElementById('debriefLoading');
            const resultsEl = document.getElementById('debriefResults');

            btn.disabled = true;
            btn.textContent = 'Analyzing...';
            loadingEl.style.display = 'block';
            resultsEl.style.display = 'none';

            try {
                const questionsAsked = document.getElementById('questionsAsked').value
                    .split('\n').filter(q => q.trim());
                const strongAnswers = document.getElementById('strongAnswers').value
                    .split('\n').filter(a => a.trim());
                const weakAnswers = document.getElementById('weakAnswers').value
                    .split('\n').filter(a => a.trim());
                const transcript = document.getElementById('interviewTranscript').value.trim();

                const response = await fetch(`${API_BASE}/api/interview-prep/debrief`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        resume_json: getResumeJson(),
                        job_description: getJobDescription(),
                        company: analysisData?._company_name || 'Company',
                        role_title: analysisData?.role_title || 'Role',
                        interview_stage: currentStage,
                        interview_date: document.getElementById('interviewDate').value,
                        interviewer_name: document.getElementById('interviewerName').value || null,
                        transcript_text: transcript || null,
                        typed_responses: {
                            overall_feeling: document.getElementById('overallFeeling').value,
                            questions_asked: questionsAsked,
                            strong_answers: strongAnswers,
                            weak_answers: weakAnswers,
                            learnings: document.getElementById('learnings').value
                        }
                    })
                });

                if (!response.ok) throw new Error('Failed to analyze debrief');

                const debrief = await response.json();
                renderDebriefResults(debrief);

                loadingEl.style.display = 'none';
                resultsEl.style.display = 'block';

            } catch (error) {
                console.error('Error analyzing debrief:', error);
                alert('Error analyzing debrief: ' + error.message);
                loadingEl.style.display = 'none';
            } finally {
                btn.disabled = false;
                btn.textContent = 'Analyze & Generate Thank-You Email';
            }
        }

        // Render debrief results
        function renderDebriefResults(debrief) {
            // Scores
            const scoresEl = document.getElementById('debriefScores');
            const scores = debrief.dimension_scores;
            scoresEl.innerHTML = `
                <div class="score-card">
                    <div class="score">${debrief.overall_score}</div>
                    <div class="label">Overall</div>
                </div>
                <div class="score-card">
                    <div class="score">${scores.content}</div>
                    <div class="label">Content</div>
                </div>
                <div class="score-card">
                    <div class="score">${scores.clarity}</div>
                    <div class="label">Clarity</div>
                </div>
                <div class="score-card">
                    <div class="score">${scores.confidence}</div>
                    <div class="label">Confidence</div>
                </div>
            `;

            // Strengths
            document.getElementById('debriefStrengths').innerHTML =
                debrief.strengths.map(s => `<li>${s}</li>`).join('');

            // Opportunities
            document.getElementById('debriefOpportunities').innerHTML =
                debrief.opportunities.map(o => `<li>${o}</li>`).join('');

            // What they should have said
            const shouldHaveSaid = debrief.what_they_should_have_said || [];
            if (shouldHaveSaid.length > 0) {
                document.getElementById('shouldHaveSaidSection').style.display = 'block';
                document.getElementById('shouldHaveSaidContent').innerHTML = shouldHaveSaid.map(item => `
                    <div class="mitigation-card" style="background: rgba(59, 130, 246, 0.1); border-color: rgba(59, 130, 246, 0.3);">
                        <div class="flag" style="color: #60a5fa;">‚ùì ${item.question}</div>
                        <div style="margin: 10px 0;">
                            <strong style="color: #f87171;">What you said:</strong>
                            <p style="color: #9ca3af; margin-top: 4px;">${item.weak_answer}</p>
                        </div>
                        <div>
                            <strong style="color: #4ade80;">What to say next time:</strong>
                            <p style="color: #d1d5db; margin-top: 4px;">${item.strong_answer}</p>
                        </div>
                    </div>
                `).join('');
            } else {
                document.getElementById('shouldHaveSaidSection').style.display = 'none';
            }

            // Coaching points
            document.getElementById('coachingPoints').innerHTML =
                debrief.coaching_points.map(p => `<li>${p}</li>`).join('');

            // Thank you email
            document.getElementById('thankYouEmail').textContent = debrief.thank_you_email;
        }

        // Copy thank you email
        function copyThankYouEmail() {
            const email = document.getElementById('thankYouEmail').textContent;
            navigator.clipboard.writeText(email).then(() => {
                alert('Email copied to clipboard!');
            }).catch(err => {
                console.error('Error copying email:', err);
            });
        }

        // ============================================================================
        // MOCK INTERVIEW FUNCTIONS
        // ============================================================================

        // Mock interview state
        let mockSession = {
            sessionId: null,
            currentQuestionId: null,
            currentQuestionNumber: 1,
            responseNumber: 1,
            followUpQuestion: null
        };

        // Current mock tab state
        let currentMockTab = 'intro-sell';

        // Switch between mock interview sub-tabs
        function switchMockTab(tabName) {
            currentMockTab = tabName;

            // Update tab button styles
            document.querySelectorAll('#mockTabs .tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');

            // Hide all content sections
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));

            // Show appropriate content
            if (tabName === 'intro-sell') {
                document.getElementById('intro-sellTab').classList.add('active');
                // Auto-generate intro sell template if not already loaded
                if (!introSellTemplate) {
                    generateIntroSellTemplate();
                }
            } else if (tabName === 'drills') {
                document.getElementById('drillsTab').classList.add('active');
            } else {
                // For recruiter and hiring manager, show the mock interview setup
                document.getElementById('mockInterviewTab').classList.add('active');
                // Update the interview type dropdown based on selected tab
                const interviewType = document.getElementById('mockInterviewType');
                if (interviewType) {
                    interviewType.value = tabName === 'recruiter' ? 'recruiter_screen' : 'hiring_manager';
                }
            }
        }

        // Update selectStage to handle mock interview mode
        const originalSelectStage = selectStage;
        selectStage = function(stage) {
            currentStage = stage;
            document.querySelectorAll('.stage-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.stage === stage);
            });

            // Show/hide appropriate tabs and content
            const mainTabs = document.getElementById('mainTabs');
            const mockTabs = document.getElementById('mockTabs');

            if (stage === 'mock_interview') {
                // Hide main tabs, show mock interview tabs
                mainTabs.style.display = 'none';
                mockTabs.style.display = 'flex';

                // Hide all regular tab content
                document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));

                // Reset mock tabs to first tab (Intro Sell)
                document.querySelectorAll('#mockTabs .tab').forEach((tab, i) => {
                    tab.classList.toggle('active', i === 0);
                });

                // Show intro-sell tab by default
                document.getElementById('intro-sellTab').classList.add('active');
                currentMockTab = 'intro-sell';

                // Auto-generate intro sell template if not already loaded
                if (!introSellTemplate) {
                    generateIntroSellTemplate();
                }
            } else {
                // Show main tabs
                mainTabs.style.display = 'flex';
                mockTabs.style.display = 'none';

                // Reset to prep tab
                document.querySelectorAll('#mainTabs .tab').forEach(tab => tab.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                document.querySelector('#mainTabs .tab').classList.add('active');
                document.getElementById('prepTab').classList.add('active');

                // Reset prep content when stage changes
                document.getElementById('prepContent').style.display = 'none';
                document.getElementById('prepGenerateSection').style.display = 'block';
                prepData = null;
            }
        };

        // Start mock interview
        async function startMockInterview() {
            const btn = document.getElementById('startMockBtn');
            const loadingEl = document.getElementById('mockLoading');
            const startSection = document.getElementById('mockStartSection');

            btn.disabled = true;
            btn.textContent = 'Starting...';
            loadingEl.style.display = 'block';
            document.getElementById('mockLoadingText').textContent = 'Generating your first question...';

            try {
                const response = await fetch(`${API_BASE}/api/mock-interview/start`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        resume_json: getResumeJson(),
                        job_description: getJobDescription(),
                        company: analysisData?._company_name || 'Company',
                        role_title: analysisData?.role_title || 'Role',
                        interview_stage: document.getElementById('mockInterviewStage').value,
                        difficulty_level: document.getElementById('mockDifficulty').value
                    })
                });

                if (!response.ok) throw new Error('Failed to start mock interview');

                const data = await response.json();

                // Update state
                mockSession.sessionId = data.session_id;
                mockSession.currentQuestionId = data.first_question.question_id;
                mockSession.currentQuestionNumber = 1;
                mockSession.responseNumber = 1;

                // Show question
                displayMockQuestion(data.first_question);

                loadingEl.style.display = 'none';
                startSection.style.display = 'none';
                document.getElementById('mockActiveSection').style.display = 'block';

            } catch (error) {
                console.error('Error starting mock interview:', error);
                alert('Error starting mock interview: ' + error.message);
                loadingEl.style.display = 'none';
            } finally {
                btn.disabled = false;
                btn.textContent = 'üé§ Start Mock Interview';
            }
        }

        // Display a mock question
        function displayMockQuestion(question) {
            document.getElementById('mockQuestionTitle').textContent =
                `Question ${question.question_number}/5`;
            document.getElementById('mockQuestionText').textContent = question.question_text;
            document.getElementById('mockCompetency').textContent =
                `Testing: ${question.competency_tested}`;
            document.getElementById('mockResponseNumber').textContent =
                `Response ${mockSession.responseNumber}/4`;
            document.getElementById('mockResponseText').value = '';
            document.getElementById('mockFollowUpIndicator').style.display = 'none';
            document.getElementById('mockBriefFeedback').style.display = 'none';

            // Reset buttons
            document.getElementById('continueFollowUpBtn').style.display = 'none';
            document.getElementById('showFeedbackBtn').style.display = 'none';
            document.getElementById('nextQuestionBtn').style.display = 'none';
            document.getElementById('endSessionBtn').style.display = 'none';
        }

        // Submit mock response
        async function submitMockResponse() {
            const responseText = document.getElementById('mockResponseText').value.trim();
            if (!responseText) {
                alert('Please enter your response before submitting.');
                return;
            }

            const btn = document.getElementById('submitMockResponseBtn');
            const loadingEl = document.getElementById('mockLoading');

            btn.disabled = true;
            btn.textContent = 'Analyzing...';
            loadingEl.style.display = 'block';
            document.getElementById('mockLoadingText').textContent = 'Analyzing your response...';

            try {
                const response = await fetch(`${API_BASE}/api/mock-interview/respond`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        session_id: mockSession.sessionId,
                        question_id: mockSession.currentQuestionId,
                        response_text: responseText,
                        response_number: mockSession.responseNumber
                    })
                });

                if (!response.ok) throw new Error('Failed to submit response');

                const data = await response.json();

                // Show brief feedback
                document.getElementById('mockBriefFeedbackText').textContent = data.brief_feedback;
                document.getElementById('mockBriefFeedback').style.display = 'block';

                // Store follow-up if available
                mockSession.followUpQuestion = data.follow_up_question;

                // Show appropriate buttons
                if (data.should_continue && data.follow_up_question) {
                    document.getElementById('continueFollowUpBtn').style.display = 'inline-block';
                    document.getElementById('showFeedbackBtn').style.display = 'inline-block';
                } else {
                    document.getElementById('showFeedbackBtn').style.display = 'inline-block';
                }

                // Show next question or end button
                if (mockSession.currentQuestionNumber < 5) {
                    document.getElementById('nextQuestionBtn').style.display = 'inline-block';
                }
                document.getElementById('endSessionBtn').style.display = 'inline-block';

                loadingEl.style.display = 'none';

            } catch (error) {
                console.error('Error submitting response:', error);
                alert('Error submitting response: ' + error.message);
                loadingEl.style.display = 'none';
            } finally {
                btn.disabled = false;
                btn.textContent = 'Submit Response';
            }
        }

        // Continue with follow-up question
        function continueFollowUp() {
            mockSession.responseNumber++;

            // Show follow-up question
            document.getElementById('mockQuestionText').textContent = mockSession.followUpQuestion;
            document.getElementById('mockFollowUpIndicator').style.display = 'block';
            document.getElementById('mockResponseNumber').textContent =
                `Response ${mockSession.responseNumber}/4`;
            document.getElementById('mockResponseText').value = '';
            document.getElementById('mockBriefFeedback').style.display = 'none';

            // Reset buttons
            document.getElementById('continueFollowUpBtn').style.display = 'none';
            document.getElementById('showFeedbackBtn').style.display = 'none';
            document.getElementById('nextQuestionBtn').style.display = 'none';
            document.getElementById('endSessionBtn').style.display = 'none';
        }

        // Show full question feedback
        async function showQuestionFeedback() {
            const loadingEl = document.getElementById('mockLoading');
            loadingEl.style.display = 'block';
            document.getElementById('mockLoadingText').textContent = 'Generating detailed feedback...';

            try {
                const response = await fetch(
                    `${API_BASE}/api/mock-interview/question-feedback/${mockSession.currentQuestionId}`
                );

                if (!response.ok) throw new Error('Failed to get feedback');

                const data = await response.json();

                // Populate feedback
                document.getElementById('qfScore').textContent = data.score;
                document.getElementById('qfLevel').textContent = data.level_demonstrated;
                document.getElementById('qfWhatLanded').innerHTML =
                    data.what_landed.map(item => `<li>${item}</li>`).join('');
                document.getElementById('qfWhatDidntLand').innerHTML =
                    data.what_didnt_land.map(item => `<li>${item}</li>`).join('');
                document.getElementById('qfCoaching').textContent = data.coaching;
                document.getElementById('qfRevisedAnswer').textContent = data.revised_answer;

                // Show/hide buttons based on question number
                if (mockSession.currentQuestionNumber < 5) {
                    document.getElementById('feedbackNextBtn').style.display = 'inline-block';
                } else {
                    document.getElementById('feedbackNextBtn').style.display = 'none';
                }
                document.getElementById('feedbackEndBtn').style.display = 'inline-block';

                // Hide active section, show feedback
                document.getElementById('mockActiveSection').style.display = 'none';
                document.getElementById('mockQuestionFeedback').style.display = 'block';

                loadingEl.style.display = 'none';

            } catch (error) {
                console.error('Error getting feedback:', error);
                alert('Error getting feedback: ' + error.message);
                loadingEl.style.display = 'none';
            }
        }

        // Move to next question
        async function nextMockQuestion() {
            const loadingEl = document.getElementById('mockLoading');
            loadingEl.style.display = 'block';
            document.getElementById('mockLoadingText').textContent = 'Generating next question...';

            try {
                const response = await fetch(`${API_BASE}/api/mock-interview/next-question`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        session_id: mockSession.sessionId,
                        current_question_number: mockSession.currentQuestionNumber
                    })
                });

                if (!response.ok) throw new Error('Failed to get next question');

                const data = await response.json();

                // Update state
                mockSession.currentQuestionId = data.question_id;
                mockSession.currentQuestionNumber = data.question_number;
                mockSession.responseNumber = 1;

                // Display new question
                displayMockQuestion(data);

                // Hide feedback, show active section
                document.getElementById('mockQuestionFeedback').style.display = 'none';
                document.getElementById('mockActiveSection').style.display = 'block';

                loadingEl.style.display = 'none';

            } catch (error) {
                console.error('Error getting next question:', error);
                alert('Error getting next question: ' + error.message);
                loadingEl.style.display = 'none';
            }
        }

        // End mock interview session
        async function endMockInterview() {
            const loadingEl = document.getElementById('mockLoading');
            loadingEl.style.display = 'block';
            document.getElementById('mockLoadingText').textContent = 'Generating session results...';

            try {
                const response = await fetch(`${API_BASE}/api/mock-interview/end`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        session_id: mockSession.sessionId
                    })
                });

                if (!response.ok) throw new Error('Failed to end session');

                const data = await response.json();

                // Populate session results
                document.getElementById('sessionScore').textContent = data.overall_score.toFixed(1);
                document.getElementById('sessionQuestions').textContent = data.questions_completed;
                document.getElementById('sessionReadiness').textContent = data.session_feedback.readiness_score;
                document.getElementById('sessionAssessment').textContent = data.session_feedback.overall_assessment;

                document.getElementById('sessionStrengths').innerHTML =
                    data.session_feedback.key_strengths.map(s => `<li>${s}</li>`).join('');
                document.getElementById('sessionImprove').innerHTML =
                    data.session_feedback.areas_to_improve.map(a => `<li>${a}</li>`).join('');
                document.getElementById('sessionPriorities').innerHTML =
                    data.session_feedback.coaching_priorities.map(p => `<li>${p}</li>`).join('');

                // Display level estimate
                document.getElementById('sessionLevelEstimate').textContent =
                    data.session_feedback.level_estimate || 'mid';

                // Display recommended drills
                const drills = data.session_feedback.recommended_drills || [];
                const drillsSection = document.getElementById('sessionDrillsSection');
                if (drills.length > 0) {
                    document.getElementById('sessionDrills').innerHTML =
                        drills.map(d => `<li>${d}</li>`).join('');
                    drillsSection.style.display = 'block';
                } else {
                    drillsSection.style.display = 'none';
                }

                document.getElementById('sessionNextSteps').textContent = data.session_feedback.next_steps;

                // Render question summaries
                document.getElementById('sessionQuestionSummaries').innerHTML =
                    data.question_summaries.map(q => `
                        <div class="question-card" style="margin-bottom: 15px;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div class="question">Q${q.question_number}: ${q.question_text}</div>
                                <span style="color: #22d3ee; font-weight: bold;">${q.score}/10</span>
                            </div>
                            <div class="rationale" style="margin-top: 8px;">${q.brief_feedback}</div>
                        </div>
                    `).join('');

                // Hide other sections, show results
                document.getElementById('mockActiveSection').style.display = 'none';
                document.getElementById('mockQuestionFeedback').style.display = 'none';
                document.getElementById('mockSessionResults').style.display = 'block';

                loadingEl.style.display = 'none';

            } catch (error) {
                console.error('Error ending session:', error);
                alert('Error ending session: ' + error.message);
                loadingEl.style.display = 'none';
            }
        }

        // Reset mock interview to start again
        function resetMockInterview() {
            // Reset state
            mockSession = {
                sessionId: null,
                currentQuestionId: null,
                currentQuestionNumber: 1,
                responseNumber: 1,
                followUpQuestion: null
            };

            // Stop any ongoing recording
            if (isRecording) {
                toggleRecording();
            }

            // Reset UI
            document.getElementById('mockSessionResults').style.display = 'none';
            document.getElementById('mockQuestionFeedback').style.display = 'none';
            document.getElementById('mockActiveSection').style.display = 'none';
            document.getElementById('mockStartSection').style.display = 'block';
        }

        // ============================================================================
        // PRACTICE DRILLS FUNCTIONS
        // ============================================================================

        // Drill configuration
        const drillConfig = {
            metrics: {
                icon: 'üìä',
                title: 'Metrics Orientation',
                signal: 'metrics_orientation',
                questions: [
                    "Think of a project you led or contributed to. Describe the outcome, but this time, include at least 3 specific numbers: team size, timeline, impact (revenue, users, efficiency %).",
                    "Describe a time you improved a process. What was the before/after in measurable terms?",
                    "Tell me about a successful project. What KPIs did you track and what were the results?",
                    "How would you quantify the impact of your most recent work? Include timeline, scope, and outcomes."
                ]
            },
            ownership: {
                icon: 'üí™',
                title: 'Ownership & Accountability',
                signal: 'ownership',
                questions: [
                    "Rewrite this story using only 'I' statements. Describe what YOU specifically did, not what the team did: 'Our team launched a new feature that increased engagement.'",
                    "Tell me about a mistake you made and how YOU fixed it. Focus on your personal accountability.",
                    "Describe a time you took initiative without being asked. What did YOU do and why?",
                    "Walk me through a project where you were the primary driver. What decisions did YOU make?"
                ]
            },
            strategy: {
                icon: 'üéØ',
                title: 'Strategic Thinking',
                signal: 'strategic_thinking',
                questions: [
                    "Before describing a project, explain the business context: Why did this matter to the company? What was at stake?",
                    "Describe a decision you made. First explain the strategic tradeoffs, then the decision, then the outcome.",
                    "How would you prioritize if you could only do 1 of 3 important projects? Walk through your framework.",
                    "Tell me about a time you had to say no to something. What was your strategic reasoning?"
                ]
            },
            stakeholder: {
                icon: 'ü§ù',
                title: 'Stakeholder Management',
                signal: 'stakeholder_management',
                questions: [
                    "Describe a time you had to get buy-in from someone who initially disagreed with you. How did you influence them?",
                    "Tell me about a cross-functional project. Who were the stakeholders and how did you manage their different needs?",
                    "Describe a conflict between teams or individuals. How did you navigate it?",
                    "How do you communicate differently with executives vs. peers vs. direct reports?"
                ]
            },
            communication: {
                icon: 'üó£Ô∏è',
                title: 'Communication Clarity',
                signal: 'communication_clarity',
                questions: [
                    "Tell me about a challenging project using STAR format: Situation (1-2 sentences), Task (what was your responsibility), Action (what YOU did), Result (measurable outcome).",
                    "Explain a complex concept from your work as if I'm a non-technical stakeholder.",
                    "Describe a time you had to deliver difficult feedback. Walk through exactly what you said.",
                    "How would you summarize your biggest accomplishment in exactly 3 sentences?"
                ]
            },
            problem_solving: {
                icon: 'üß©',
                title: 'Problem Solving',
                signal: 'problem_solving',
                questions: [
                    "Describe a complex problem you solved. Walk me through your step-by-step thinking process.",
                    "Tell me about a time you had to make a decision with incomplete information. What was your framework?",
                    "Describe a time you identified a problem that others missed. How did you spot it and solve it?",
                    "How do you approach debugging or root cause analysis? Give me a specific example."
                ]
            }
        };

        let currentDrill = null;
        let currentDrillQuestion = '';

        // Start a drill
        function startDrill(drillType) {
            currentDrill = drillType;
            const config = drillConfig[drillType];

            // Pick a random question
            currentDrillQuestion = config.questions[Math.floor(Math.random() * config.questions.length)];

            // Update UI
            document.getElementById('drillIcon').textContent = config.icon;
            document.getElementById('drillTitle').textContent = config.title + ' Drill';
            document.getElementById('drillQuestion').textContent = currentDrillQuestion;
            document.getElementById('drillResponse').value = '';

            // Show drill section, hide feedback
            document.getElementById('activeDrillSection').style.display = 'block';
            document.getElementById('drillFeedbackSection').style.display = 'none';

            // Scroll to drill
            document.getElementById('activeDrillSection').scrollIntoView({ behavior: 'smooth' });
        }

        // Cancel drill
        function cancelDrill() {
            document.getElementById('activeDrillSection').style.display = 'none';
            currentDrill = null;
        }

        // Submit drill response for feedback
        async function submitDrillResponse() {
            const response = document.getElementById('drillResponse').value.trim();
            if (!response) {
                alert('Please write a response before submitting.');
                return;
            }

            const btn = document.getElementById('submitDrillBtn');
            const loadingEl = document.getElementById('drillLoading');

            btn.disabled = true;
            btn.innerHTML = 'Analyzing...';
            loadingEl.style.display = 'flex';

            try {
                const config = drillConfig[currentDrill];

                // Call the drill feedback API
                const apiResponse = await fetch(`${API_BASE}/api/drill/feedback`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        drill_type: currentDrill,
                        signal_focus: config.signal,
                        question: currentDrillQuestion,
                        response: response
                    })
                });

                if (!apiResponse.ok) throw new Error('Failed to get drill feedback');

                const data = await apiResponse.json();

                // Display feedback
                displayDrillFeedback(data);

            } catch (error) {
                console.error('Error getting drill feedback:', error);
                alert('Error getting feedback: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = 'Get Feedback';
                loadingEl.style.display = 'none';
            }
        }

        // Display drill feedback
        function displayDrillFeedback(data) {
            const config = drillConfig[currentDrill];
            const feedbackContent = document.getElementById('drillFeedbackContent');

            // Build feedback HTML
            let html = `
                <div style="margin-bottom: 20px;">
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
                        <span style="font-size: 2rem;">${data.score >= 7 ? '‚úÖ' : data.score >= 5 ? 'üìà' : 'üéØ'}</span>
                        <div>
                            <div style="font-size: 1.5rem; color: ${data.score >= 7 ? '#4ade80' : data.score >= 5 ? '#f59e0b' : '#ef4444'}; font-weight: bold;">
                                ${data.score}/10
                            </div>
                            <div style="color: #9ca3af; font-size: 0.9rem;">Signal Score: ${config.title}</div>
                        </div>
                    </div>
                </div>

                <div style="margin-bottom: 20px;">
                    <h4 style="color: #4ade80; margin-bottom: 10px;">What You Did Well</h4>
                    <ul class="content-list">
                        ${data.strengths.map(s => `<li>${s}</li>`).join('')}
                    </ul>
                </div>

                <div style="margin-bottom: 20px;">
                    <h4 style="color: #f59e0b; margin-bottom: 10px;">Areas to Improve</h4>
                    <ul class="content-list">
                        ${data.improvements.map(i => `<li>${i}</li>`).join('')}
                    </ul>
                </div>

                <div style="margin-bottom: 20px;">
                    <h4 style="color: #22d3ee; margin-bottom: 10px;">Coaching Tip</h4>
                    <p style="color: #d1d5db; line-height: 1.7;">${data.coaching_tip}</p>
                </div>
            `;

            if (data.rewritten_example) {
                html += `
                    <div class="strategy-box" style="background: #1f2937;">
                        <h4 style="color: #a78bfa;">Example Rewrite</h4>
                        <p style="color: #d1d5db; line-height: 1.7;">${data.rewritten_example}</p>
                    </div>
                `;
            }

            feedbackContent.innerHTML = html;
            document.getElementById('drillFeedbackSection').style.display = 'block';

            // Scroll to feedback
            document.getElementById('drillFeedbackSection').scrollIntoView({ behavior: 'smooth' });
        }

        // Try the same drill again
        function tryDrillAgain() {
            document.getElementById('drillResponse').value = '';
            document.getElementById('drillFeedbackSection').style.display = 'none';
            document.getElementById('drillResponse').focus();
        }

        // Move to next drill (random different one)
        function nextDrill() {
            const drillTypes = Object.keys(drillConfig);
            let nextType = drillTypes[Math.floor(Math.random() * drillTypes.length)];
            // Avoid same drill twice in a row
            while (nextType === currentDrill && drillTypes.length > 1) {
                nextType = drillTypes[Math.floor(Math.random() * drillTypes.length)];
            }
            startDrill(nextType);
        }

        // ============================================================================
        // VOICE RECORDING FUNCTIONS
        // ============================================================================

        let mediaRecorder = null;
        let audioChunks = [];
        let isRecording = false;
        let recordingStartTime = null;
        let recordingTimer = null;
        let currentResponseMode = 'text';

        // Initialize response mode radio buttons
        document.querySelectorAll('input[name="responseMode"]').forEach(radio => {
            radio.addEventListener('change', (e) => {
                currentResponseMode = e.target.value;
                updateModeUI();
            });
        });

        function updateModeUI() {
            const modeLabels = document.querySelectorAll('input[name="responseMode"]');
            modeLabels.forEach(input => {
                const label = input.closest('label');
                if (input.checked) {
                    label.style.background = 'rgba(34, 211, 238, 0.1)';
                    label.style.borderColor = '#22d3ee';
                } else {
                    label.style.background = '#1f2937';
                    label.style.borderColor = '#374151';
                }
            });

            const descEl = document.getElementById('modeDescription');
            switch (currentResponseMode) {
                case 'text':
                    descEl.textContent = 'Type your responses in the text box';
                    break;
                case 'voice':
                    descEl.textContent = 'Click the microphone to record your spoken response, which will be transcribed';
                    break;
                case 'conversational':
                    descEl.textContent = 'Real-time voice conversation with automatic follow-ups (requires microphone)';
                    break;
            }
        }

        // Toggle recording on/off
        async function toggleRecording() {
            if (isRecording) {
                stopRecording();
            } else {
                await startRecording();
            }
        }

        // Start recording
        async function startRecording() {
            try {
                // Reset accumulated transcript for new recording
                resetTranscript();

                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });

                // Start speech recognition for real-time transcription
                startSpeechRecognition();

                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];

                mediaRecorder.ondataavailable = (event) => {
                    audioChunks.push(event.data);
                };

                mediaRecorder.onstop = async () => {
                    // Stop speech recognition
                    stopSpeechRecognition();

                    // If we already have transcript from speech recognition, use it
                    if (accumulatedTranscript && accumulatedTranscript.trim()) {
                        console.log('Using real-time transcript:', accumulatedTranscript.substring(0, 50) + '...');
                        // Transcript is already in the text area
                    } else {
                        // Fall back to backend transcription
                        const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                        await transcribeAudio(audioBlob);
                    }

                    // Stop all tracks
                    stream.getTracks().forEach(track => track.stop());
                };

                mediaRecorder.start();
                isRecording = true;
                recordingStartTime = Date.now();

                // Update UI
                document.getElementById('recordBtn').style.background = '#ef4444';
                document.getElementById('recordBtn').textContent = '‚èπÔ∏è';
                document.getElementById('recordingStatus').style.display = 'inline';
                document.getElementById('recordingTime').style.display = 'inline';

                // Start timer
                recordingTimer = setInterval(updateRecordingTime, 1000);
                updateRecordingTime();

            } catch (error) {
                console.error('Error accessing microphone:', error);
                alert('Could not access microphone. Please ensure you have granted permission.');
            }
        }

        // Stop recording
        function stopRecording() {
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
            }

            isRecording = false;
            clearInterval(recordingTimer);

            // Update UI
            document.getElementById('recordBtn').style.background = '#374151';
            document.getElementById('recordBtn').textContent = 'üé§';
            document.getElementById('recordingStatus').style.display = 'none';
            document.getElementById('recordingTime').style.display = 'none';
        }

        // Update recording time display
        function updateRecordingTime() {
            const elapsed = Math.floor((Date.now() - recordingStartTime) / 1000);
            const minutes = Math.floor(elapsed / 60);
            const seconds = elapsed % 60;
            document.getElementById('recordingTime').textContent =
                `${minutes}:${seconds.toString().padStart(2, '0')}`;
        }

        // Transcribe audio using browser's Speech Recognition or send to backend
        async function transcribeAudio(audioBlob) {
            document.getElementById('transcriptionStatus').style.display = 'block';

            try {
                // Try using Web Speech API first (free, client-side)
                if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                    // For browsers that support it, we'll use real-time recognition
                    // But since we already recorded, we'll use a simple fallback
                }

                // Send to backend for transcription (using Whisper API)
                const formData = new FormData();
                formData.append('audio', audioBlob, 'recording.webm');

                const response = await fetch(`${API_BASE}/api/transcribe`, {
                    method: 'POST',
                    body: formData
                });

                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('mockResponseText').value = data.text;
                } else {
                    // Fallback: append a note that recording was captured
                    const currentText = document.getElementById('mockResponseText').value;
                    document.getElementById('mockResponseText').value =
                        currentText + (currentText ? '\n\n' : '') +
                        '[Voice recording captured - transcription service unavailable. Please type your response or try again.]';
                }
            } catch (error) {
                console.error('Transcription error:', error);
                // Fallback message
                document.getElementById('mockResponseText').value =
                    '[Voice recording captured - transcription service unavailable. Please type your response.]';
            } finally {
                document.getElementById('transcriptionStatus').style.display = 'none';
            }
        }

        // ============================================================================
        // CONVERSATIONAL MODE (Real-time voice with auto-follow-ups)
        // ============================================================================

        let speechRecognition = null;
        let speechSynthesis = window.speechSynthesis;
        let isConversationalMode = false;
        let isSpeechRecognitionActive = false; // Track if we want speech recognition running
        let accumulatedTranscript = ''; // Store full transcript across recognition restarts
        let silenceTimer = null; // Timer to detect when user is done speaking
        let recognitionRestartTimer = null; // Timer to restart recognition
        const SILENCE_TIMEOUT = 2000; // 2 seconds of silence = done speaking
        const RESTART_DELAY = 100; // Small delay before restarting recognition

        // Initialize speech recognition if available
        function initSpeechRecognition() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (SpeechRecognition) {
                speechRecognition = new SpeechRecognition();
                speechRecognition.continuous = true; // Keep listening until manually stopped
                speechRecognition.interimResults = true;
                speechRecognition.lang = 'en-US';
                speechRecognition.maxAlternatives = 1;

                speechRecognition.onresult = (event) => {
                    // Build transcript from all results
                    let interimTranscript = '';
                    let finalTranscript = '';

                    for (let i = event.resultIndex; i < event.results.length; i++) {
                        const result = event.results[i];
                        if (result.isFinal) {
                            finalTranscript += result[0].transcript;
                        } else {
                            interimTranscript += result[0].transcript;
                        }
                    }

                    // Add final transcript to accumulated
                    if (finalTranscript) {
                        accumulatedTranscript += finalTranscript;
                    }

                    // Display accumulated + interim
                    const displayText = accumulatedTranscript + interimTranscript;
                    document.getElementById('mockResponseText').value = displayText;

                    // Reset silence timer on any speech
                    if (silenceTimer) {
                        clearTimeout(silenceTimer);
                    }

                    // In conversational mode, auto-submit after silence
                    if (isConversationalMode && finalTranscript) {
                        silenceTimer = setTimeout(() => {
                            // Only submit if we have actual content
                            if (accumulatedTranscript.trim()) {
                                stopRecordingAndSubmit();
                            }
                        }, SILENCE_TIMEOUT);
                    }
                };

                speechRecognition.onerror = (event) => {
                    console.error('Speech recognition error:', event.error);

                    // Handle specific errors
                    if (event.error === 'no-speech') {
                        // No speech detected - this is normal, just restart
                        console.log('No speech detected, will restart...');
                    } else if (event.error === 'audio-capture') {
                        console.log('Audio capture error - microphone may be in use');
                    } else if (event.error === 'not-allowed') {
                        console.log('Microphone permission denied');
                        isSpeechRecognitionActive = false;
                    } else if (event.error !== 'aborted') {
                        console.log('Speech recognition error: ' + event.error);
                    }
                };

                speechRecognition.onend = () => {
                    console.log('Speech recognition ended, active:', isSpeechRecognitionActive, 'recording:', isRecording);

                    // Restart if we still want recognition active
                    if (isSpeechRecognitionActive && isRecording) {
                        // Clear any pending restart
                        if (recognitionRestartTimer) {
                            clearTimeout(recognitionRestartTimer);
                        }

                        // Small delay before restarting to avoid rapid restart loops
                        recognitionRestartTimer = setTimeout(() => {
                            if (isSpeechRecognitionActive && isRecording) {
                                try {
                                    console.log('Restarting speech recognition...');
                                    speechRecognition.start();
                                } catch (e) {
                                    console.log('Recognition restart failed:', e.message);
                                    // Try again after a longer delay
                                    recognitionRestartTimer = setTimeout(() => {
                                        if (isSpeechRecognitionActive && isRecording) {
                                            try {
                                                speechRecognition.start();
                                            } catch (e2) {
                                                console.log('Recognition restart failed again:', e2.message);
                                            }
                                        }
                                    }, 500);
                                }
                            }
                        }, RESTART_DELAY);
                    }
                };

                speechRecognition.onstart = () => {
                    console.log('Speech recognition started');
                };
            }
        }

        // Start speech recognition
        function startSpeechRecognition() {
            if (!speechRecognition) {
                console.log('Speech recognition not available');
                return false;
            }

            isSpeechRecognitionActive = true;

            try {
                speechRecognition.start();
                return true;
            } catch (e) {
                console.log('Failed to start speech recognition:', e.message);
                // May already be running
                if (e.message.includes('already started')) {
                    return true;
                }
                return false;
            }
        }

        // Stop speech recognition
        function stopSpeechRecognition() {
            isSpeechRecognitionActive = false;

            if (recognitionRestartTimer) {
                clearTimeout(recognitionRestartTimer);
                recognitionRestartTimer = null;
            }

            if (speechRecognition) {
                try {
                    speechRecognition.stop();
                } catch (e) {
                    console.log('Failed to stop speech recognition:', e.message);
                }
            }
        }

        // Stop recording and submit the response
        function stopRecordingAndSubmit() {
            if (silenceTimer) {
                clearTimeout(silenceTimer);
                silenceTimer = null;
            }

            // Stop recognition
            stopSpeechRecognition();

            isRecording = false;
            document.getElementById('recordBtn').style.background = '';
            document.getElementById('recordingStatus').style.display = 'none';

            // Submit if we have content
            if (accumulatedTranscript.trim()) {
                submitMockResponse();
            }
        }

        // Reset transcript when starting a new question
        function resetTranscript() {
            accumulatedTranscript = '';
            if (silenceTimer) {
                clearTimeout(silenceTimer);
                silenceTimer = null;
            }
            // Clear the text area as well
            const textArea = document.getElementById('mockResponseText');
            if (textArea) {
                textArea.value = '';
            }
        }

        // ============================================================================
        // AI VOICE (OpenAI TTS) - Natural, human-like speech
        // ============================================================================

        let currentAudio = null;
        let aiVoiceAvailable = true; // Will be set to false if API unavailable

        // Speak text using AI voice (OpenAI TTS) with browser fallback
        async function speakText(text) {
            // Stop any current audio
            if (currentAudio) {
                currentAudio.pause();
                currentAudio = null;
            }
            if (speechSynthesis) {
                speechSynthesis.cancel();
            }

            // Try AI voice first
            if (aiVoiceAvailable) {
                try {
                    // Use Echo voice - warm, conversational with personality and energy
                    console.log('üéôÔ∏è Using AI voice: echo');
                    const response = await fetch(`${API_BASE}/api/tts`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            text: text,
                            voice: 'echo'
                        })
                    });

                    if (response.ok) {
                        const audioBlob = await response.blob();
                        const audioUrl = URL.createObjectURL(audioBlob);
                        currentAudio = new Audio(audioUrl);

                        // When done speaking, start listening in conversational mode
                        currentAudio.onended = () => {
                            URL.revokeObjectURL(audioUrl);
                            currentAudio = null;
                            startListeningAfterSpeech();
                        };

                        currentAudio.onerror = () => {
                            console.log('Audio playback error, using browser fallback');
                            speakWithBrowserTTS(text);
                        };

                        await currentAudio.play();
                        return;
                    } else if (response.status === 503) {
                        // OpenAI API not configured - disable AI voice
                        console.log('AI voice not configured, using browser TTS');
                        aiVoiceAvailable = false;
                    }
                } catch (e) {
                    console.log('AI voice error:', e);
                }
            }

            // Fallback to browser TTS
            speakWithBrowserTTS(text);
        }

        // Browser TTS fallback
        function speakWithBrowserTTS(text) {
            if (!speechSynthesis) return;

            const utterance = new SpeechSynthesisUtterance(text);

            // Try to find a decent male voice
            const voices = speechSynthesis.getVoices();
            const maleVoice = voices.find(v =>
                v.name.includes('Daniel') || v.name.includes('Alex') ||
                v.name.includes('David') || v.name.includes('Mark')
            );
            if (maleVoice) utterance.voice = maleVoice;

            utterance.rate = 0.95;
            utterance.pitch = 0.9;

            utterance.onend = () => startListeningAfterSpeech();

            speechSynthesis.speak(utterance);
        }

        // Start listening after speech ends (for conversational mode)
        function startListeningAfterSpeech() {
            if (isConversationalMode && speechRecognition) {
                // Reset transcript for new response
                resetTranscript();

                setTimeout(() => {
                    isRecording = true;
                    startSpeechRecognition();
                    document.getElementById('recordBtn').style.background = '#ef4444';
                    document.getElementById('recordingStatus').style.display = 'inline';
                }, 300);
            }
        }

        // Initialize speech recognition on page load
        initSpeechRecognition();

        // Override startMockInterview to handle conversational mode
        const originalStartMockInterview = startMockInterview;
        startMockInterview = async function() {
            const selectedMode = document.querySelector('input[name="responseMode"]:checked').value;
            isConversationalMode = selectedMode === 'conversational';

            // Call original function (displayMockQuestion will handle speaking)
            await originalStartMockInterview();
        };

        // Override displayMockQuestion to speak in conversational mode
        const originalDisplayMockQuestion = displayMockQuestion;
        displayMockQuestion = function(question) {
            // Reset transcript for the new question
            resetTranscript();

            originalDisplayMockQuestion(question);

            if (isConversationalMode) {
                setTimeout(() => speakText(question.question_text), 300);
            }
        };
    </script>
</body>
</html>

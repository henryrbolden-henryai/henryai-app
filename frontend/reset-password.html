<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reset Password - HenryHQ</title>

    <!-- PWA Meta Tags -->
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#000000">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="HenryHQ">
    <link rel="apple-touch-icon" href="/assets/icons/icon-192x192.svg">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Instrument+Serif:ital@0;1&family=DM+Sans:opsz,wght@9..40,400;9..40,500;9..40,600&display=swap" rel="stylesheet">
    <style>
        :root {
            --color-bg: #0a0a0b;
            --color-surface: #141416;
            --color-surface-elevated: #1c1c1f;
            --color-border: rgba(255, 255, 255, 0.08);
            --color-border-hover: rgba(255, 255, 255, 0.15);
            --color-text: #fafafa;
            --color-text-secondary: #a1a1aa;
            --color-accent: #22d3ee;
            --color-accent-muted: rgba(34, 211, 238, 0.15);
            --color-success: #4ade80;
            --color-error: #f87171;
            --font-display: 'Instrument Serif', Georgia, serif;
            --font-body: 'DM Sans', -apple-system, sans-serif;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-body);
            background: var(--color-bg);
            color: var(--color-text);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .reset-container {
            width: 100%;
            max-width: 440px;
        }

        .top-header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            padding: 16px 24px;
            z-index: 100;
        }

        .top-logo {
            font-family: var(--font-display);
            font-size: 2rem;
            text-decoration: none;
            color: var(--color-text);
        }

        .top-logo em {
            font-style: italic;
            color: var(--color-accent);
        }

        .logo-section {
            text-align: center;
            margin-bottom: 40px;
        }

        .tagline-row {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
        }

        .logo-graphic {
            width: 54px;
            height: 54px;
            flex-shrink: 0;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.85; transform: scale(1.03); }
        }

        .logo-graphic svg {
            animation: pulse 3s ease-in-out infinite;
        }

        .tagline {
            color: var(--color-text);
            font-size: 1.1rem;
            font-weight: 500;
            margin: 0;
        }

        .reset-card {
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: 16px;
            padding: 32px;
        }

        .reset-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 8px;
            text-align: center;
        }

        .reset-subtitle {
            color: var(--color-text-secondary);
            font-size: 0.9rem;
            margin-bottom: 24px;
            text-align: center;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            font-size: 0.9rem;
            color: var(--color-text-secondary);
            margin-bottom: 8px;
        }

        .form-group input {
            width: 100%;
            padding: 14px 16px;
            background: var(--color-bg);
            border: 1px solid var(--color-border);
            border-radius: 8px;
            color: var(--color-text);
            font-size: 1rem;
            font-family: var(--font-body);
            transition: border-color 0.2s;
        }

        .form-group input:focus {
            outline: none;
            border-color: var(--color-accent);
        }

        .form-group input::placeholder {
            color: var(--color-text-secondary);
        }

        .password-requirements {
            font-size: 0.8rem;
            color: var(--color-text-secondary);
            margin-top: 8px;
        }

        .submit-btn {
            width: 100%;
            padding: 14px;
            background: var(--color-accent);
            border: none;
            border-radius: 8px;
            color: #000;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .submit-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 20px rgba(34, 211, 238, 0.3);
        }

        .submit-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .error-message {
            background: rgba(248, 113, 113, 0.1);
            border: 1px solid rgba(248, 113, 113, 0.3);
            color: var(--color-error);
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 0.9rem;
            display: none;
        }

        .error-message.show {
            display: block;
        }

        .success-message {
            background: rgba(74, 222, 128, 0.1);
            border: 1px solid rgba(74, 222, 128, 0.3);
            color: var(--color-success);
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 0.9rem;
            display: none;
        }

        .success-message.show {
            display: block;
        }

        .back-link {
            text-align: center;
            margin-top: 16px;
        }

        .back-link a {
            color: var(--color-text-secondary);
            font-size: 0.9rem;
            text-decoration: none;
        }

        .back-link a:hover {
            color: var(--color-accent);
        }

        .loading-spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid transparent;
            border-top-color: currentColor;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-right: 8px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .invalid-token {
            text-align: center;
            padding: 40px 20px;
        }

        .invalid-token h2 {
            font-size: 1.25rem;
            margin-bottom: 12px;
            color: var(--color-error);
        }

        .invalid-token p {
            color: var(--color-text-secondary);
            margin-bottom: 24px;
        }

        @media (max-width: 480px) {
            .reset-card {
                padding: 24px;
            }
        }
    </style>
</head>
<body>
    <!-- Top left logo -->
    <header class="top-header">
        <a href="/index" class="top-logo"><em>Henry</em>HQ</a>
    </header>

    <div class="reset-container">
        <div class="logo-section">
            <div class="tagline-row">
                <!-- HenryHQ Logo Mark -->
                <div class="logo-graphic">
                    <svg width="54" height="54" viewBox="0 0 200 200" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <defs>
                            <linearGradient id="ringGradient" x1="0%" y1="100%" x2="100%" y2="0%">
                                <stop offset="0%" style="stop-color:#667eea;stop-opacity:1" />
                                <stop offset="100%" style="stop-color:#764ba2;stop-opacity:1" />
                            </linearGradient>
                            <linearGradient id="strokeGradient" x1="0%" y1="100%" x2="100%" y2="0%">
                                <stop offset="0%" style="stop-color:#667eea;stop-opacity:1" />
                                <stop offset="100%" style="stop-color:#764ba2;stop-opacity:1" />
                            </linearGradient>
                        </defs>
                        <circle cx="100" cy="100" r="85" stroke="url(#ringGradient)" stroke-width="4" fill="none"/>
                        <path d="M55 130 L55 70" stroke="#667eea" stroke-width="9" stroke-linecap="round" fill="none"/>
                        <path d="M145 130 L145 50" stroke="url(#strokeGradient)" stroke-width="9" stroke-linecap="round" fill="none"/>
                        <path d="M55 100 L145 100" stroke="#764ba2" stroke-width="9" stroke-linecap="round" fill="none"/>
                        <circle cx="145" cy="50" r="9" fill="#764ba2"/>
                    </svg>
                </div>
                <p class="tagline">Strategy that gets you hired.</p>
            </div>
        </div>

        <div class="reset-card">
            <!-- Loading state while checking token -->
            <div id="loadingState" style="text-align: center; padding: 20px;">
                <span class="loading-spinner"></span>
                <p style="color: var(--color-text-secondary); margin-top: 12px;">Verifying reset link...</p>
            </div>

            <!-- Invalid token state -->
            <div id="invalidState" class="invalid-token" style="display: none;">
                <h2>Invalid or Expired Link</h2>
                <p>This password reset link is no longer valid. Please request a new one.</p>
                <a href="/login" class="submit-btn" style="display: inline-block; text-decoration: none; padding: 14px 28px;">Request New Link</a>
            </div>

            <!-- Reset form -->
            <div id="resetFormContainer" style="display: none;">
                <h2 class="reset-title">Set New Password</h2>
                <p class="reset-subtitle">Enter your new password below.</p>

                <div class="error-message" id="errorMessage"></div>
                <div class="success-message" id="successMessage"></div>

                <form id="resetForm" onsubmit="handleResetPassword(event)">
                    <div class="form-group">
                        <label for="newPassword">New Password</label>
                        <input type="password" id="newPassword" placeholder="Enter new password" required minlength="6">
                        <p class="password-requirements">At least 6 characters</p>
                    </div>
                    <div class="form-group">
                        <label for="confirmPassword">Confirm Password</label>
                        <input type="password" id="confirmPassword" placeholder="Confirm new password" required minlength="6">
                    </div>
                    <button type="submit" class="submit-btn" id="resetBtn">Update Password</button>
                </form>
                <div class="back-link">
                    <a href="/login">Back to Sign In</a>
                </div>
            </div>

            <!-- Success state -->
            <div id="successState" style="display: none; text-align: center; padding: 20px;">
                <div style="font-size: 48px; margin-bottom: 16px;">&#10003;</div>
                <h2 class="reset-title">Password Updated!</h2>
                <p style="color: var(--color-text-secondary); margin-bottom: 24px;">Your password has been successfully reset.</p>
                <a href="/login" class="submit-btn" style="display: inline-block; text-decoration: none; padding: 14px 28px;">Sign In</a>
            </div>
        </div>
    </div>

    <!-- Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        const SUPABASE_URL = 'https://xmbappvomvmanvybdavs.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhtYmFwcHZvbXZtYW52eWJkYXZzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUzOTczNjEsImV4cCI6MjA4MDk3MzM2MX0.hswKgjSEQalsJCyjPTcs4ngJH_BGrYKhUmAEEx5QmuU';
        const resetSupabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        let isValidToken = false;
        let recoveryHandled = false;

        // Listen for auth state changes - Supabase automatically handles the recovery token
        resetSupabase.auth.onAuthStateChange(async (event, session) => {
            console.log('Auth event:', event, session);

            if (event === 'PASSWORD_RECOVERY') {
                // Recovery token was valid, show the reset form
                recoveryHandled = true;
                isValidToken = true;
                document.getElementById('loadingState').style.display = 'none';
                document.getElementById('resetFormContainer').style.display = 'block';
            } else if (event === 'SIGNED_IN' && !recoveryHandled) {
                // User signed in via recovery link
                recoveryHandled = true;
                isValidToken = true;
                document.getElementById('loadingState').style.display = 'none';
                document.getElementById('resetFormContainer').style.display = 'block';
            }
        });

        // Fallback check if onAuthStateChange doesn't fire
        async function checkResetToken() {
            const loadingState = document.getElementById('loadingState');
            const invalidState = document.getElementById('invalidState');
            const resetFormContainer = document.getElementById('resetFormContainer');

            // Wait a bit for onAuthStateChange to handle it
            await new Promise(resolve => setTimeout(resolve, 2000));

            // If already handled by onAuthStateChange, skip
            if (recoveryHandled) return;

            // Check if there's a hash with token info
            const hashParams = new URLSearchParams(window.location.hash.substring(1));
            const accessToken = hashParams.get('access_token');
            const type = hashParams.get('type');
            const errorCode = hashParams.get('error_code');
            const errorDescription = hashParams.get('error_description');

            // Check for error in URL
            if (errorCode || errorDescription) {
                console.error('Reset link error:', errorDescription);
                loadingState.style.display = 'none';
                invalidState.style.display = 'block';
                const errorP = invalidState.querySelector('p');
                if (errorDescription) {
                    errorP.textContent = decodeURIComponent(errorDescription.replace(/\+/g, ' '));
                }
                return;
            }

            // If no token at all, show invalid
            if (!accessToken) {
                loadingState.style.display = 'none';
                invalidState.style.display = 'block';
                return;
            }

            // Try to get current session - Supabase may have already processed the token
            const { data: { session }, error } = await resetSupabase.auth.getSession();

            if (session) {
                // Session exists, show the form
                isValidToken = true;
                loadingState.style.display = 'none';
                resetFormContainer.style.display = 'block';
                return;
            }

            // If we got here with a token but no session, try manual approach
            if (accessToken && type === 'recovery') {
                try {
                    const refreshToken = hashParams.get('refresh_token') || '';
                    const { data, error } = await resetSupabase.auth.setSession({
                        access_token: accessToken,
                        refresh_token: refreshToken
                    });

                    if (!error && data.session) {
                        isValidToken = true;
                        loadingState.style.display = 'none';
                        resetFormContainer.style.display = 'block';
                        return;
                    }
                } catch (e) {
                    console.error('Manual session error:', e);
                }
            }

            // Nothing worked, show invalid
            loadingState.style.display = 'none';
            invalidState.style.display = 'block';
        }

        function showError(message) {
            const el = document.getElementById('errorMessage');
            el.textContent = message;
            el.classList.add('show');
            document.getElementById('successMessage').classList.remove('show');
        }

        function showSuccess(message) {
            const el = document.getElementById('successMessage');
            el.textContent = message;
            el.classList.add('show');
            document.getElementById('errorMessage').classList.remove('show');
        }

        function hideMessages() {
            document.getElementById('errorMessage').classList.remove('show');
            document.getElementById('successMessage').classList.remove('show');
        }

        function setLoading(loading) {
            const btn = document.getElementById('resetBtn');
            if (loading) {
                btn.disabled = true;
                btn.innerHTML = '<span class="loading-spinner"></span>Updating...';
            } else {
                btn.disabled = false;
                btn.textContent = 'Update Password';
            }
        }

        async function handleResetPassword(e) {
            e.preventDefault();
            hideMessages();

            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            // Validate passwords match
            if (newPassword !== confirmPassword) {
                showError('Passwords do not match');
                return;
            }

            // Validate password length
            if (newPassword.length < 6) {
                showError('Password must be at least 6 characters');
                return;
            }

            setLoading(true);

            try {
                const { data, error } = await resetSupabase.auth.updateUser({
                    password: newPassword
                });

                if (error) {
                    showError(error.message);
                    setLoading(false);
                    return;
                }

                // Success - show success state
                document.getElementById('resetFormContainer').style.display = 'none';
                document.getElementById('successState').style.display = 'block';

                // Sign out to clear the recovery session
                await resetSupabase.auth.signOut();

            } catch (err) {
                showError('An error occurred. Please try again.');
                setLoading(false);
            }
        }

        // Initialize on page load
        checkResetToken();
    </script>
<script src="components/analytics.js"></script>
</body>
</html>

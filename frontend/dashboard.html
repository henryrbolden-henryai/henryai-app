<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard | HenryHQ</title>

    <!-- PWA Meta Tags -->
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#000000">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="HenryHQ">
    <link rel="apple-touch-icon" href="/assets/icons/icon-192x192.svg">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Instrument+Serif:ital@0;1&display=swap" rel="stylesheet">
    <style>
        :root {
            /* Core Colors */
            --color-bg: #0a0a0b;
            --color-surface: #141416;
            --color-surface-elevated: #1c1c1f;
            --color-border: rgba(255, 255, 255, 0.08);
            --color-border-hover: rgba(255, 255, 255, 0.15);
            --color-text: #fafafa;
            --color-text-secondary: #71717a;
            --color-text-muted: #52525b;

            /* Status Colors */
            --color-hot: #FF6B35;
            --color-hot-muted: rgba(255, 107, 53, 0.15);
            --color-active: #4CAF50;
            --color-active-muted: rgba(76, 175, 80, 0.15);
            --color-cooling: #546E7A;
            --color-cooling-muted: rgba(84, 110, 122, 0.15);
            --color-dead: #E57373;
            --color-dead-muted: rgba(229, 115, 115, 0.15);
            --color-leverage: #FFD700;
            --color-leverage-muted: rgba(255, 215, 0, 0.15);

            /* Accent */
            --color-accent: #22d3ee;
            --color-accent-muted: rgba(34, 211, 238, 0.15);

            /* Typography */
            --font-display: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            --font-body: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-body);
            background: var(--color-bg);
            color: var(--color-text);
            min-height: 100vh;
            line-height: 1.6;
            padding-top: 60px;
        }

        /* TOP NAVIGATION BAR */
        .top-nav {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            background: var(--color-bg);
            border-bottom: 1px solid var(--color-border);
            padding: 12px 24px;
        }

        .top-nav-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
        }

        .top-nav-logo {
            font-family: 'Instrument Serif', Georgia, serif;
            font-size: 1.5rem;
            font-weight: 400;
            color: var(--color-text);
            text-decoration: none;
        }

        .top-nav-logo em {
            font-style: italic;
            color: var(--color-accent);
        }

        /* Account Dropdown */
        .account-dropdown {
            position: relative;
        }

        .account-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            background: transparent;
            border: 1px solid var(--color-border);
            border-radius: 8px;
            padding: 8px 14px;
            color: var(--color-text);
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .account-btn:hover {
            border-color: var(--color-accent);
            color: var(--color-accent);
        }

        .account-btn svg {
            width: 16px;
            height: 16px;
            transition: transform 0.2s ease;
        }

        .account-dropdown.open .account-btn svg {
            transform: rotate(180deg);
        }

        .account-menu {
            position: absolute;
            top: calc(100% + 8px);
            right: 0;
            min-width: 180px;
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: 10px;
            padding: 8px 0;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.2s ease;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.4);
        }

        .account-dropdown.open .account-menu {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .account-menu-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 16px;
            color: var(--color-text-secondary);
            text-decoration: none;
            font-size: 0.9rem;
            transition: all 0.15s ease;
        }

        .account-menu-item:hover {
            background: var(--color-surface-elevated);
            color: var(--color-text);
        }

        .account-menu-item svg {
            width: 16px;
            height: 16px;
            opacity: 0.7;
        }

        .account-menu-divider {
            height: 1px;
            background: var(--color-border);
            margin: 8px 0;
        }

        .account-menu-item.danger {
            color: #f87171;
        }

        .account-menu-item.danger:hover {
            background: rgba(248, 113, 113, 0.1);
            color: #f87171;
        }

        /* MAIN CONTAINER */
        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 32px 24px;
        }

        /* WELCOME SECTION */
        .welcome-section {
            margin-bottom: 24px;
        }

        .welcome-heading {
            font-family: 'Instrument Serif', Georgia, serif;
            font-size: 2rem;
            font-weight: 400;
            color: var(--color-text);
            margin-bottom: 8px;
        }

        .welcome-subtext {
            color: var(--color-text-secondary);
            font-size: 1rem;
        }

        /* DAILY PULSE BANNER */
        .daily-pulse {
            background: linear-gradient(135deg, rgba(34, 211, 238, 0.1) 0%, rgba(96, 165, 250, 0.1) 100%);
            border: 1px solid rgba(34, 211, 238, 0.3);
            border-radius: 16px;
            padding: 24px 28px;
            margin-bottom: 32px;
        }

        .pulse-greeting {
            font-size: 1.25rem;
            color: var(--color-text);
            font-weight: 500;
            line-height: 1.5;
        }

        /* QUICK STATS CARDS */
        .quick-stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
            margin-bottom: 32px;
        }

        .stat-card {
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            transition: all 0.2s;
        }

        .stat-card:hover {
            border-color: var(--color-border-hover);
            transform: translateY(-2px);
        }

        .stat-card.highlight {
            border-color: var(--color-hot);
            background: var(--color-hot-muted);
        }

        .stat-card.urgent {
            border-color: var(--color-dead);
            background: var(--color-dead-muted);
        }

        .stat-icon {
            font-size: 1.5rem;
            margin-bottom: 8px;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--color-accent);
            margin-bottom: 4px;
        }

        .stat-card.highlight .stat-value {
            color: var(--color-hot);
        }

        .stat-card.urgent .stat-value {
            color: var(--color-dead);
        }

        .stat-label {
            font-size: 0.85rem;
            color: var(--color-text-secondary);
        }

        /* REALITY CHECK SECTION */
        .reality-check-section {
            margin-bottom: 32px;
        }

        .reality-check-section h2 {
            font-size: 1.1rem;
            font-weight: 600;
            color: #ef4444;
            margin-bottom: 16px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .reality-check-card {
            background: rgba(239, 68, 68, 0.06);
            border: 1px solid rgba(239, 68, 68, 0.3);
            border-radius: 12px;
            padding: 24px;
        }

        .reality-check-content {
            display: flex;
            align-items: flex-start;
            gap: 16px;
        }

        .reality-check-icon {
            font-size: 2rem;
            flex-shrink: 0;
        }

        .reality-check-text {
            flex: 1;
        }

        .reality-check-headline {
            font-size: 1.1rem;
            font-weight: 600;
            color: #ef4444;
            margin-bottom: 8px;
        }

        .reality-check-detail {
            color: var(--color-text-secondary);
            font-size: 0.95rem;
            line-height: 1.5;
            margin-bottom: 16px;
        }

        .reality-check-detail strong {
            color: var(--color-text);
        }

        .reality-check-actions {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .reality-check-btn {
            padding: 10px 20px;
            background: #ef4444;
            color: #fff;
            border: none;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
        }

        .reality-check-btn:hover {
            background: #dc2626;
            transform: translateY(-1px);
        }

        .reality-check-btn.secondary {
            background: transparent;
            color: #ef4444;
            border: 1px solid rgba(239, 68, 68, 0.4);
        }

        .reality-check-btn.secondary:hover {
            background: rgba(239, 68, 68, 0.1);
        }

        /* TODAY'S FOCUS */
        .focus-section {
            margin-bottom: 32px;
        }

        .focus-section h2 {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--color-text-secondary);
            margin-bottom: 16px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .focus-card {
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: 12px;
            padding: 24px;
        }

        .focus-items {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .focus-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 16px;
            padding: 12px 16px;
            background: rgba(255, 255, 255, 0.02);
            border-radius: 8px;
            border-left: 3px solid var(--color-accent);
        }

        .focus-item.secondary {
            border-left-color: var(--color-text-muted);
            background: transparent;
        }

        .focus-item.urgent {
            border-left-color: #f59e0b;
            background: rgba(245, 158, 11, 0.08);
        }

        .focus-item.urgent .focus-item-label {
            color: #f59e0b;
        }

        .focus-item.urgent .focus-message strong {
            color: #f59e0b;
        }

        .focus-item.completed {
            border-left-color: var(--color-active);
            opacity: 0.7;
        }

        .focus-item-content {
            flex: 1;
        }

        .focus-item-label {
            font-size: 0.75rem;
            color: var(--color-text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 4px;
        }

        .focus-message {
            font-size: 1rem;
            color: var(--color-text);
        }

        .focus-message strong {
            color: var(--color-accent);
        }

        .focus-button {
            padding: 10px 20px;
            background: var(--color-accent);
            color: #000;
            border: none;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 600;
            font-family: inherit;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
            text-decoration: none;
        }

        .focus-button:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }

        .focus-button.secondary {
            background: var(--color-surface-elevated);
            color: var(--color-text);
            border: 1px solid var(--color-border);
        }

        .focus-button.secondary:hover {
            border-color: var(--color-border-hover);
        }

        /* RECENT ACTIVITY */
        .recent-section {
            margin-bottom: 32px;
        }

        .recent-section h2 {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--color-text-secondary);
            margin-bottom: 16px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .recent-activity {
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: 12px;
            overflow: hidden;
        }

        .activity-item {
            display: flex;
            align-items: center;
            padding: 16px 20px;
            border-bottom: 1px solid var(--color-border);
            gap: 16px;
        }

        .activity-item:last-child {
            border-bottom: none;
        }

        .activity-info {
            flex: 1;
        }

        .activity-company {
            font-weight: 600;
            color: var(--color-text);
            margin-bottom: 2px;
        }

        .activity-role {
            font-size: 0.85rem;
            color: var(--color-text-secondary);
        }

        .activity-meta {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .status-badge {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-hot {
            background: var(--color-hot-muted);
            color: var(--color-hot);
        }

        .status-active {
            background: var(--color-active-muted);
            color: var(--color-active);
        }

        .status-waiting {
            background: var(--color-cooling-muted);
            color: var(--color-cooling);
        }

        .status-default {
            background: var(--color-surface-elevated);
            color: var(--color-text-secondary);
        }

        .activity-time {
            font-size: 0.8rem;
            color: var(--color-text-muted);
        }

        .activity-link {
            color: var(--color-accent);
            text-decoration: none;
            font-size: 0.85rem;
            font-weight: 500;
        }

        .activity-link:hover {
            text-decoration: underline;
        }

        /* EMPTY STATE */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
        }

        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: 16px;
        }

        .empty-state-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .empty-state-text {
            color: var(--color-text-secondary);
            margin-bottom: 24px;
        }

        /* MILESTONE CELEBRATION */
        .milestone-toast {
            position: fixed;
            top: 80px;
            left: 50%;
            transform: translateX(-50%) translateY(-20px);
            background: linear-gradient(135deg, #059669 0%, #10b981 100%);
            border-radius: 16px;
            padding: 20px 28px;
            display: flex;
            align-items: center;
            gap: 16px;
            box-shadow: 0 8px 32px rgba(16, 185, 129, 0.3);
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            max-width: 90%;
        }

        .milestone-toast.show {
            opacity: 1;
            visibility: visible;
            transform: translateX(-50%) translateY(0);
        }

        .milestone-icon {
            font-size: 2.5rem;
            animation: bounce 0.6s ease-in-out;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-8px); }
        }

        .milestone-content {
            flex: 1;
        }

        .milestone-title {
            font-size: 1.1rem;
            font-weight: 700;
            color: #ffffff;
            margin-bottom: 4px;
        }

        .milestone-message {
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.9);
        }

        .milestone-close {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            color: #ffffff;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            transition: background 0.2s;
        }

        .milestone-close:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        /* STRATEGIC OPTIONS SECTION */
        .strategic-options-section {
            margin-bottom: 32px;
        }

        .strategic-options-section h2 {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--color-text-secondary);
            margin-bottom: 16px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .strategic-options-card {
            background: rgba(239, 68, 68, 0.06);
            border: 1px solid rgba(239, 68, 68, 0.3);
            border-radius: 12px;
            padding: 24px;
        }

        .strategic-options-card.stressed {
            background: rgba(234, 179, 8, 0.06);
            border-color: rgba(234, 179, 8, 0.3);
        }

        .strategic-options-card.standard {
            background: rgba(34, 211, 238, 0.06);
            border-color: rgba(34, 211, 238, 0.3);
        }

        .strategic-options-urgency-label {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 12px;
            color: #ef4444;
        }

        .strategic-options-card.stressed .strategic-options-urgency-label {
            color: #eab308;
        }

        .strategic-options-card.standard .strategic-options-urgency-label {
            color: var(--color-accent);
        }

        .strategic-options-content {
            display: flex;
            align-items: flex-start;
            gap: 16px;
        }

        .strategic-options-icon {
            font-size: 2rem;
            flex-shrink: 0;
        }

        .strategic-options-text {
            flex: 1;
        }

        .strategic-options-headline {
            font-size: 1rem;
            font-weight: 600;
            color: var(--color-text);
            margin-bottom: 8px;
        }

        .strategic-options-detail {
            color: var(--color-text-secondary);
            font-size: 0.95rem;
            line-height: 1.5;
            margin-bottom: 16px;
        }

        .strategic-options-detail strong {
            color: var(--color-text);
        }

        .strategic-options-actions {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .strategic-options-btn {
            padding: 10px 20px;
            background: #ef4444;
            color: #fff;
            border: none;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
        }

        .strategic-options-btn:hover {
            background: #dc2626;
            transform: translateY(-1px);
        }

        .strategic-options-card.stressed .strategic-options-btn {
            background: #eab308;
            color: #000;
        }

        .strategic-options-card.stressed .strategic-options-btn:hover {
            background: #ca8a04;
        }

        .strategic-options-card.standard .strategic-options-btn {
            background: var(--color-accent);
            color: #000;
        }

        .strategic-options-card.standard .strategic-options-btn:hover {
            background: #06b6d4;
        }

        .strategic-options-btn.secondary {
            background: transparent;
            color: #fff;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .strategic-options-btn.secondary:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .strategic-options-dismiss {
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            text-align: right;
        }

        .strategic-options-dismiss button {
            background: none;
            border: none;
            color: var(--color-text-muted);
            font-size: 0.8rem;
            cursor: pointer;
            padding: 4px 8px;
        }

        .strategic-options-dismiss button:hover {
            color: var(--color-text-secondary);
        }

        /* Contract Guidance Modal */
        .contract-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }

        .contract-modal-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        .contract-modal {
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: 16px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            padding: 32px;
            transform: translateY(20px);
            transition: transform 0.3s;
        }

        .contract-modal-overlay.show .contract-modal {
            transform: translateY(0);
        }

        .contract-modal h3 {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 16px;
            color: var(--color-text);
        }

        .contract-modal-section {
            margin-bottom: 24px;
        }

        .contract-modal-section h4 {
            font-size: 1rem;
            font-weight: 600;
            color: var(--color-accent);
            margin-bottom: 8px;
        }

        .contract-modal-section p {
            color: var(--color-text-secondary);
            line-height: 1.6;
            margin-bottom: 8px;
        }

        .contract-modal-section ul {
            color: var(--color-text-secondary);
            margin-left: 20px;
            line-height: 1.8;
        }

        .contract-modal-close {
            display: block;
            width: 100%;
            padding: 12px;
            background: var(--color-accent);
            color: #000;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            margin-top: 16px;
        }

        .contract-modal-close:hover {
            opacity: 0.9;
        }

        /* COACHING MODAL (for Positioning/Outreach context selection) */
        .coaching-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.85);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }

        .coaching-modal-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        .coaching-modal {
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: 16px;
            max-width: 520px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            padding: 28px;
            transform: translateY(20px);
            transition: transform 0.3s;
        }

        .coaching-modal-overlay.show .coaching-modal {
            transform: translateY(0);
        }

        .coaching-modal-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
        }

        .coaching-modal-icon {
            font-size: 1.5rem;
        }

        .coaching-modal h3 {
            font-size: 1.15rem;
            font-weight: 600;
            color: var(--color-text);
        }

        .coaching-modal-intro {
            color: var(--color-text-secondary);
            font-size: 0.95rem;
            line-height: 1.6;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--color-border);
        }

        .coaching-modal-label {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--color-accent);
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .coaching-app-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 20px;
        }

        .coaching-app-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 14px 16px;
            background: var(--color-surface-elevated);
            border: 1px solid var(--color-border);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .coaching-app-item:hover {
            border-color: var(--color-accent);
            background: rgba(34, 211, 238, 0.05);
        }

        .coaching-app-info {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .coaching-app-company {
            font-weight: 600;
            color: var(--color-text);
            font-size: 0.95rem;
        }

        .coaching-app-role {
            font-size: 0.85rem;
            color: var(--color-text-secondary);
        }

        .coaching-app-arrow {
            color: var(--color-text-muted);
            font-size: 1.1rem;
            transition: transform 0.2s;
        }

        .coaching-app-item:hover .coaching-app-arrow {
            transform: translateX(4px);
            color: var(--color-accent);
        }

        .coaching-empty-state {
            text-align: center;
            padding: 24px 16px;
            color: var(--color-text-secondary);
        }

        .coaching-empty-state p {
            margin-bottom: 16px;
            line-height: 1.6;
        }

        .coaching-empty-cta {
            display: inline-block;
            padding: 10px 20px;
            background: var(--color-accent);
            color: #000;
            font-weight: 600;
            font-size: 0.9rem;
            border-radius: 8px;
            text-decoration: none;
            transition: opacity 0.2s;
        }

        .coaching-empty-cta:hover {
            opacity: 0.9;
        }

        .coaching-modal-tip {
            background: rgba(34, 211, 238, 0.08);
            border: 1px solid rgba(34, 211, 238, 0.2);
            border-radius: 8px;
            padding: 14px 16px;
            margin-top: 16px;
        }

        .coaching-modal-tip-label {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--color-accent);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 6px;
        }

        .coaching-modal-tip p {
            font-size: 0.9rem;
            color: var(--color-text-secondary);
            line-height: 1.5;
        }

        .coaching-modal-close {
            display: block;
            width: 100%;
            padding: 12px;
            background: transparent;
            color: var(--color-text-secondary);
            border: 1px solid var(--color-border);
            border-radius: 8px;
            font-size: 0.95rem;
            cursor: pointer;
            margin-top: 16px;
            transition: all 0.2s;
        }

        .coaching-modal-close:hover {
            border-color: var(--color-text-secondary);
            color: var(--color-text);
        }

        /* SETUP CHECKLIST */
        .setup-checklist-section {
            margin-bottom: 32px;
        }

        .setup-checklist-section h2 {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--color-text-secondary);
            margin-bottom: 16px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .setup-checklist-card {
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: 12px;
            padding: 24px;
        }

        .setup-progress {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--color-border);
        }

        .setup-progress-bar {
            flex: 1;
            height: 6px;
            background: rgba(255, 255, 255, 0.08);
            border-radius: 3px;
            overflow: hidden;
        }

        .setup-progress-fill {
            height: 100%;
            background: var(--color-accent);
            border-radius: 3px;
            transition: width 0.5s ease;
        }

        .setup-progress-text {
            font-size: 0.85rem;
            color: var(--color-text-secondary);
            white-space: nowrap;
        }

        .setup-items {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .setup-item {
            display: flex;
            align-items: center;
            gap: 14px;
            padding: 12px 16px;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.02);
            transition: all 0.2s;
        }

        .setup-item:hover {
            background: rgba(255, 255, 255, 0.04);
        }

        .setup-item.completed {
            opacity: 0.6;
        }

        .setup-check {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border: 2px solid var(--color-text-muted);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            font-size: 0.75rem;
            color: transparent;
            transition: all 0.2s;
        }

        .setup-item.completed .setup-check {
            background: var(--color-accent);
            border-color: var(--color-accent);
            color: #000;
        }

        .setup-item-content {
            flex: 1;
        }

        .setup-item-title {
            font-size: 0.95rem;
            font-weight: 500;
            color: var(--color-text);
        }

        .setup-item.completed .setup-item-title {
            text-decoration: line-through;
            color: var(--color-text-secondary);
        }

        .setup-item-desc {
            font-size: 0.8rem;
            color: var(--color-text-muted);
            margin-top: 2px;
        }

        .setup-item-action {
            padding: 8px 16px;
            background: var(--color-surface-elevated);
            color: var(--color-text);
            border: 1px solid var(--color-border);
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
            white-space: nowrap;
        }

        .setup-item-action:hover {
            border-color: var(--color-accent);
            color: var(--color-accent);
        }

        .setup-item.completed .setup-item-action {
            display: none;
        }

        /* PRIORITY ACTIONS (from Command Center intelligence) */
        .priority-actions-section {
            margin-bottom: 32px;
        }

        .priority-actions-section h2 {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--color-text-secondary);
            margin-bottom: 16px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .priority-actions-card {
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: 12px;
            overflow: hidden;
        }

        .priority-action-item {
            display: flex;
            align-items: center;
            padding: 16px 20px;
            border-bottom: 1px solid var(--color-border);
            gap: 14px;
            transition: background 0.15s;
        }

        .priority-action-item:last-child {
            border-bottom: none;
        }

        .priority-action-item:hover {
            background: rgba(255, 255, 255, 0.02);
        }

        .priority-action-icon {
            font-size: 1.25rem;
            flex-shrink: 0;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--color-surface-elevated);
            border-radius: 8px;
        }

        .priority-action-info {
            flex: 1;
        }

        .priority-action-company {
            font-weight: 600;
            color: var(--color-text);
            font-size: 0.95rem;
            margin-bottom: 2px;
        }

        .priority-action-text {
            font-size: 0.85rem;
            color: var(--color-text-secondary);
            line-height: 1.4;
        }

        .priority-action-btn {
            padding: 8px 16px;
            background: var(--color-accent);
            color: #000;
            border: none;
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .priority-action-btn:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }

        .priority-actions-footer {
            padding: 12px 20px;
            background: rgba(255, 255, 255, 0.02);
            border-top: 1px solid var(--color-border);
            text-align: center;
        }

        .priority-actions-footer a {
            color: var(--color-accent);
            text-decoration: none;
            font-size: 0.85rem;
            font-weight: 500;
        }

        .priority-actions-footer a:hover {
            text-decoration: underline;
        }

        /* RESPONSIVE */
        @media (max-width: 768px) {
            .quick-stats {
                grid-template-columns: repeat(2, 1fr);
            }

            .header-nav {
                display: none;
            }

            .focus-item {
                flex-direction: column;
                text-align: center;
                gap: 12px;
            }

            .focus-button {
                width: 100%;
            }

            .activity-item {
                flex-wrap: wrap;
            }

            .activity-meta {
                width: 100%;
                margin-top: 8px;
            }
        }

        /* Welcome Modal Fix - ensures proper height, scrolling, and button clickability */
        #askHenryContainer.show .chat-container.genie-mode {
            max-height: 80vh !important;
            overflow: hidden !important;
            display: flex !important;
            flex-direction: column !important;
        }

        #askHenryContainer.show .chat-messages {
            flex: 1 !important;
            overflow-y: auto !important;
            max-height: none !important;
            padding: 24px !important;
        }

        #askHenryContainer.show .welcome-actions {
            flex-shrink: 0 !important;
            position: relative !important;
            z-index: 10001 !important;
            padding: 20px 24px !important;
            background: #1a1a1a !important;
            border-top: 1px solid #333 !important;
        }

        #askHenryContainer.show .create-profile-btn {
            position: relative !important;
            z-index: 10002 !important;
            cursor: pointer !important;
            pointer-events: auto !important;
            width: 100% !important;
        }

        #askHenryContainer.show .chat-overlay {
            z-index: 9999 !important;
        }

        /* Welcome Button Styles */
        .welcome-button-container {
            padding: 16px 0;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .btn-welcome {
            padding: 14px 24px;
            border-radius: 12px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: center;
            text-decoration: none !important;
            display: block;
            font-family: 'DM Sans', -apple-system, sans-serif;
            border: none;
            outline: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            width: 100%;
            box-sizing: border-box;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #ffffff;
            box-shadow: 0 4px 16px rgba(102, 126, 234, 0.3);
        }

        .btn-welcome:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        /* ============================================ */
        /* JOB DISCOVERY SECTION                        */
        /* ============================================ */
        .job-discovery-section {
            margin-bottom: 32px;
        }

        .job-discovery-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .job-discovery-header h2 {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--color-text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin: 0;
        }

        .job-discovery-controls {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .job-search-info {
            font-size: 0.8rem;
            color: var(--color-text-muted);
        }

        .job-refresh-btn {
            padding: 6px 14px;
            background: transparent;
            border: 1px solid var(--color-border);
            border-radius: 6px;
            color: var(--color-text-secondary);
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .job-refresh-btn:hover {
            border-color: var(--color-accent);
            color: var(--color-accent);
        }

        .job-discovery-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .job-card {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: 12px;
            padding: 18px 20px;
            transition: all 0.2s;
        }

        .job-card:hover {
            border-color: var(--color-border-hover);
            transform: translateY(-1px);
        }

        .job-card-network {
            border-color: rgba(34, 211, 238, 0.3);
            background: linear-gradient(135deg, var(--color-surface) 0%, rgba(34, 211, 238, 0.03) 100%);
        }

        .job-card-main {
            flex: 1;
            min-width: 0;
        }

        .job-card-header {
            margin-bottom: 8px;
        }

        .job-card-title-row {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }

        .job-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--color-text);
            margin: 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .job-company {
            font-size: 0.9rem;
            color: var(--color-text-secondary);
            margin-top: 2px;
        }

        .job-card-meta {
            display: flex;
            align-items: center;
            gap: 16px;
            flex-wrap: wrap;
        }

        .job-card-meta span {
            font-size: 0.8rem;
            color: var(--color-text-muted);
        }

        .job-salary {
            color: var(--color-active) !important;
            font-weight: 500;
        }

        .job-network-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 2px 8px;
            background: var(--color-accent-muted);
            border: 1px solid rgba(34, 211, 238, 0.3);
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 600;
            color: var(--color-accent);
            text-transform: uppercase;
            letter-spacing: 0.03em;
            white-space: nowrap;
        }

        .job-remote-badge {
            display: inline-flex;
            padding: 2px 8px;
            background: rgba(76, 175, 80, 0.1);
            border: 1px solid rgba(76, 175, 80, 0.3);
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 600;
            color: var(--color-active);
            text-transform: uppercase;
            letter-spacing: 0.03em;
            white-space: nowrap;
        }

        .job-former-employer-badge {
            display: inline-flex;
            padding: 2px 8px;
            background: rgba(251, 191, 36, 0.1);
            border: 1px solid rgba(251, 191, 36, 0.3);
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 600;
            color: #f59e0b;
            text-transform: uppercase;
            letter-spacing: 0.03em;
            white-space: nowrap;
        }

        .job-card-former {
            border-color: rgba(251, 191, 36, 0.3);
            background: linear-gradient(135deg, var(--color-surface) 0%, rgba(251, 191, 36, 0.03) 100%);
        }

        .job-card-actions {
            display: flex;
            gap: 8px;
            flex-shrink: 0;
            margin-left: 16px;
        }

        .job-btn-apply {
            padding: 8px 18px;
            background: var(--color-accent);
            color: #000;
            border: none;
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: 600;
            text-decoration: none;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .job-btn-apply:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(34, 211, 238, 0.3);
        }

        .job-btn-analyze {
            padding: 8px 14px;
            background: transparent;
            color: var(--color-text-secondary);
            border: 1px solid var(--color-border);
            border-radius: 8px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .job-btn-analyze:hover {
            border-color: var(--color-accent);
            color: var(--color-accent);
        }

        /* Job discovery footer notes */
        .job-discovery-footer {
            margin-top: 16px;
            padding: 16px 20px;
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: 10px;
        }

        .job-refresh-note {
            font-size: 0.82rem;
            color: var(--color-text-muted);
            line-height: 1.5;
            margin: 0;
        }

        .job-refresh-note a,
        .job-network-note a {
            color: var(--color-accent);
            text-decoration: none;
        }

        .job-refresh-note a:hover,
        .job-network-note a:hover {
            text-decoration: underline;
        }

        .job-network-note {
            font-size: 0.82rem;
            color: var(--color-text-muted);
            line-height: 1.5;
            margin: 10px 0 0 0;
            padding-top: 10px;
            border-top: 1px solid var(--color-border);
        }

        /* Loading / Empty / Error states */
        .job-discovery-loading,
        .job-discovery-empty,
        .job-discovery-error,
        .job-discovery-needs-profile {
            padding: 32px 24px;
            text-align: center;
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: 12px;
        }

        .job-discovery-loading p,
        .job-discovery-empty p,
        .job-discovery-error p,
        .job-discovery-needs-profile p {
            color: var(--color-text-secondary);
            font-size: 0.9rem;
            margin: 0;
        }

        .job-empty-hint {
            color: var(--color-text-muted) !important;
            font-size: 0.82rem !important;
            margin-top: 8px !important;
        }

        .job-loading-spinner {
            width: 32px;
            height: 32px;
            border: 3px solid var(--color-border);
            border-top: 3px solid var(--color-accent);
            border-radius: 50%;
            animation: jobSpin 0.8s linear infinite;
            margin: 0 auto 12px;
        }

        @keyframes jobSpin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .job-btn-upload-resume {
            display: inline-block;
            margin-top: 16px;
            padding: 10px 24px;
            background: var(--color-accent);
            color: #000;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.9rem;
            text-decoration: none;
            transition: all 0.2s;
        }

        .job-btn-upload-resume:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(34, 211, 238, 0.3);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .job-card {
                flex-direction: column;
                align-items: flex-start;
            }

            .job-card-actions {
                margin-left: 0;
                margin-top: 12px;
                width: 100%;
            }

            .job-btn-apply,
            .job-btn-analyze {
                flex: 1;
                text-align: center;
            }

            .job-discovery-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }

            .job-card-title-row {
                flex-wrap: wrap;
            }
        }

    </style>
    <!-- D5: Beta Access Gate moved to auth initialization for server-side validation -->
</head>
<body>
    <!-- LinkedIn Modal Container -->
    <div id="linkedin-modal-container"></div>

    <!-- TOP NAVIGATION -->
    <nav class="top-nav">
        <div class="top-nav-container">
            <a href="/dashboard" class="top-nav-logo"><em>Henry</em>HQ</a>
            <div class="account-dropdown" id="accountDropdown">
                <button class="account-btn" onclick="toggleAccountMenu()">
                    My Account
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 11.168l3.71-3.938a.75.75 0 111.08 1.04l-4.25 4.5a.75.75 0 01-1.08 0l-4.25-4.5a.75.75 0 01.02-1.06z" clip-rule="evenodd" />
                    </svg>
                </button>
                <div class="account-menu">
                    <a href="/profile-edit" class="account-menu-item">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                            <path d="M10 8a3 3 0 100-6 3 3 0 000 6zM3.465 14.493a1.23 1.23 0 00.41 1.412A9.957 9.957 0 0010 18c2.31 0 4.438-.784 6.131-2.1.43-.333.604-.903.408-1.41a7.002 7.002 0 00-13.074.003z" />
                        </svg>
                        Edit Profile
                    </a>
                    <a href="/settings" class="account-menu-item">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M7.84 1.804A1 1 0 018.82 1h2.36a1 1 0 01.98.804l.331 1.652a6.993 6.993 0 011.929 1.115l1.598-.54a1 1 0 011.186.447l1.18 2.044a1 1 0 01-.205 1.251l-1.267 1.113a7.047 7.047 0 010 2.228l1.267 1.113a1 1 0 01.206 1.25l-1.18 2.045a1 1 0 01-1.187.447l-1.598-.54a6.993 6.993 0 01-1.929 1.115l-.33 1.652a1 1 0 01-.98.804H8.82a1 1 0 01-.98-.804l-.331-1.652a6.993 6.993 0 01-1.929-1.115l-1.598.54a1 1 0 01-1.186-.447l-1.18-2.044a1 1 0 01.205-1.251l1.267-1.114a7.05 7.05 0 010-2.227L1.821 7.773a1 1 0 01-.206-1.25l1.18-2.045a1 1 0 011.187-.447l1.598.54A6.993 6.993 0 017.51 3.456l.33-1.652zM10 13a3 3 0 100-6 3 3 0 000 6z" clip-rule="evenodd" />
                        </svg>
                        Settings
                    </a>
                    <div class="account-menu-divider"></div>
                    <a href="#" class="account-menu-item danger" onclick="signOut(); return false;">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M3 4.25A2.25 2.25 0 015.25 2h5.5A2.25 2.25 0 0113 4.25v2a.75.75 0 01-1.5 0v-2a.75.75 0 00-.75-.75h-5.5a.75.75 0 00-.75.75v11.5c0 .414.336.75.75.75h5.5a.75.75 0 00.75-.75v-2a.75.75 0 011.5 0v2A2.25 2.25 0 0110.75 18h-5.5A2.25 2.25 0 013 15.75V4.25z" clip-rule="evenodd" />
                            <path fill-rule="evenodd" d="M19 10a.75.75 0 00-.75-.75H8.704l1.048-.943a.75.75 0 10-1.004-1.114l-2.5 2.25a.75.75 0 000 1.114l2.5 2.25a.75.75 0 101.004-1.114l-1.048-.943h9.546A.75.75 0 0019 10z" clip-rule="evenodd" />
                        </svg>
                        Sign Out
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <!-- Milestone Celebration Toast -->
    <div class="milestone-toast" id="milestoneToast">
        <div class="milestone-icon" id="milestoneIcon"></div>
        <div class="milestone-content">
            <div class="milestone-title" id="milestoneTitle">Milestone Reached!</div>
            <div class="milestone-message" id="milestoneMessage">You're making great progress.</div>
        </div>
        <button class="milestone-close" onclick="closeMilestone()"></button>
    </div>

    <div class="container">
        <!-- WELCOME MESSAGE -->
        <div class="welcome-section" id="welcomeSection">
            <h1 class="welcome-heading" id="welcomeHeading">Welcome back!</h1>
            <p class="welcome-subtext" id="welcomeSubtext">Let's keep building momentum on your job search.</p>
        </div>

        <!-- LinkedIn Reminder Banner Container -->
        <div id="linkedin-reminder-container"></div>

        <!-- DAILY PULSE BANNER -->
        <div class="daily-pulse" id="dailyPulse">
            <div class="pulse-greeting" id="pulseGreeting">Loading...</div>
        </div>

        <!-- SETUP CHECKLIST (shown until all steps complete) -->
        <div class="setup-checklist-section" id="setupChecklistSection" style="display: none;">
            <h2>Get Set Up</h2>
            <div class="setup-checklist-card">
                <div class="setup-progress">
                    <div class="setup-progress-bar">
                        <div class="setup-progress-fill" id="setupProgressFill" style="width: 0%"></div>
                    </div>
                    <span class="setup-progress-text" id="setupProgressText">0 of 4 complete</span>
                </div>
                <div class="setup-items" id="setupItems">
                    <!-- Dynamically populated -->
                </div>
            </div>
        </div>

        <!-- QUICK STATS CARDS -->
        <div class="quick-stats">
            <div class="stat-card" id="cardActive">
                <div class="stat-icon"></div>
                <div class="stat-value" id="statActive">0</div>
                <div class="stat-label">Active Applications</div>
            </div>
            <div class="stat-card" id="cardInterviews">
                <div class="stat-icon"></div>
                <div class="stat-value" id="statInterviews">0</div>
                <div class="stat-label">Interviews This Week</div>
            </div>
            <div class="stat-card" id="cardFollowUps">
                <div class="stat-icon"></div>
                <div class="stat-value" id="statFollowUps">0</div>
                <div class="stat-label">Follow-ups Due</div>
            </div>
            <div class="stat-card" id="cardResponseTime">
                <div class="stat-icon"></div>
                <div class="stat-value" id="statResponseTime"></div>
                <div class="stat-label">Avg Response Time</div>
            </div>
        </div>

        <!-- PRIORITY ACTIONS (from Command Center intelligence) -->
        <div class="priority-actions-section" id="priorityActionsSection" style="display: none;">
            <h2>Your Next Actions</h2>
            <div class="priority-actions-card" id="priorityActionsCard">
                <!-- Dynamically populated with intelligence-driven actions -->
            </div>
        </div>

        <!-- JOBS FOR YOU (job discovery) -->
        <div class="job-discovery-section" id="jobDiscoverySection" style="display: none;">
            <div class="job-discovery-header">
                <h2>Jobs for You</h2>
                <div class="job-discovery-controls">
                    <span class="job-search-info" id="jobSearchInfo"></span>
                    <button class="job-refresh-btn" onclick="window.jobDiscovery && window.jobDiscovery.refresh()" title="Refresh job listings">Refresh</button>
                </div>
            </div>
            <div class="job-discovery-list" id="jobDiscoveryList">
                <!-- Populated by job-discovery.js -->
            </div>
            <div class="job-discovery-footer">
                <p class="job-refresh-note">
                    This list refreshes every 24 hours based on your target role and location.
                    For the most comprehensive search, also check
                    <a href="https://www.linkedin.com/jobs/" target="_blank" rel="noopener noreferrer">LinkedIn Jobs</a>
                    directly  especially for roles posted in the last 24 hours.
                </p>
                <p class="job-network-note" id="jobNetworkNote" style="display: none;">
                    Want to see which companies you have connections at?
                    <a href="/profile-edit#linkedinConnectionsSection">Upload your LinkedIn connections CSV</a>
                    in your profile and we'll highlight jobs at companies in your network.
                </p>
            </div>
        </div>

        <!-- REALITY CHECK (conditionally shown) -->
        <div class="reality-check-section" id="realityCheckSection" style="display: none;">
            <h2>Reality Check</h2>
            <div class="reality-check-card">
                <div class="reality-check-content">
                    <div class="reality-check-icon" id="realityCheckIcon"></div>
                    <div class="reality-check-text">
                        <div class="reality-check-headline" id="realityCheckHeadline">Your pipeline doesn't match your goals</div>
                        <div class="reality-check-detail" id="realityCheckDetail">
                            <!-- Populated by JS -->
                        </div>
                        <div class="reality-check-actions" id="realityCheckActions">
                            <!-- Populated by JS -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- TODAY'S FOCUS -->
        <div class="focus-section">
            <h2>Today's Focus</h2>
            <div class="focus-card">
                <div class="focus-items" id="focusItems">
                    <!-- Dynamically populated with 3+ action items -->
                </div>
            </div>
        </div>

        <!-- STRATEGIC OPTIONS (conditionally shown based on urgency) -->
        <div class="strategic-options-section" id="strategicOptionsSection" style="display: none;">
            <h2>Strategic Options</h2>
            <div class="strategic-options-card" id="strategicOptionsCard">
                <div class="strategic-options-urgency-label" id="strategicOptionsUrgencyLabel"></div>
                <div class="strategic-options-content">
                    <div class="strategic-options-icon" id="strategicOptionsIcon"></div>
                    <div class="strategic-options-text">
                        <div class="strategic-options-headline" id="strategicOptionsHeadline"></div>
                        <div class="strategic-options-detail" id="strategicOptionsDetail"></div>
                        <div class="strategic-options-actions" id="strategicOptionsActions"></div>
                    </div>
                </div>
                <div class="strategic-options-dismiss">
                    <button onclick="dismissStrategicOptions()">Dismiss for today</button>
                </div>
            </div>
        </div>

        <!-- Contract Guidance Modal -->
        <div class="contract-modal-overlay" id="contractModalOverlay" onclick="closeContractGuidanceModal(event)">
            <div class="contract-modal" onclick="event.stopPropagation()">
                <h3> Contract/Consulting Work: A Strategic Option</h3>
                <div class="contract-modal-section">
                    <h4>Why Consider Contract Work?</h4>
                    <p>When cash flow is tight, contract work can be a strategic bridge that keeps you financially stable while you continue your full-time search.</p>
                </div>
                <div class="contract-modal-section">
                    <h4>Benefits</h4>
                    <ul>
                        <li><strong>Income now:</strong> Start earning within 1-2 weeks vs. 2-3 months for full-time</li>
                        <li><strong>Flexibility:</strong> Continue interviewing without quitting</li>
                        <li><strong>Network expansion:</strong> Meet new people who might lead to full-time roles</li>
                        <li><strong>Resume gap coverage:</strong> Stay current and employed</li>
                    </ul>
                </div>
                <div class="contract-modal-section">
                    <h4>Where to Find Contract Work</h4>
                    <ul>
                        <li><strong>Toptal:</strong> Premium remote opportunities (competitive screening)</li>
                        <li><strong>LinkedIn:</strong> Filter by "Contract" employment type</li>
                        <li><strong>Your network:</strong> Let contacts know you're available for project work</li>
                        <li><strong>Agencies:</strong> Robert Half, TEKsystems, Insight Global</li>
                    </ul>
                </div>
                <div class="contract-modal-section">
                    <h4>Rate Guidance</h4>
                    <p>Calculate your target rate: (Annual Salary  2000 hours)  1.3 to account for benefits/taxes you'll self-pay.</p>
                </div>
                <button class="contract-modal-close" onclick="closeContractGuidanceModal()">Got it</button>
            </div>
        </div>

        <!-- Coaching Context Modal (for Positioning/Outreach) -->
        <div class="coaching-modal-overlay" id="coachingModalOverlay" onclick="closeCoachingModal(event)">
            <div class="coaching-modal" onclick="event.stopPropagation()">
                <div class="coaching-modal-header">
                    <span class="coaching-modal-icon" id="coachingModalIcon"></span>
                    <h3 id="coachingModalTitle">Select a Role</h3>
                </div>
                <p class="coaching-modal-intro" id="coachingModalIntro">
                    Positioning and outreach strategies are tailored to each specific role. Select one of your active applications to view its strategy.
                </p>
                <div class="coaching-modal-label">Your Active Applications</div>
                <div class="coaching-app-list" id="coachingAppList">
                    <!-- Populated by JS -->
                </div>
                <div class="coaching-modal-tip">
                    <div class="coaching-modal-tip-label">How it works</div>
                    <p id="coachingModalTip">Each role you analyze gets personalized positioning guidance and outreach templates. Access them anytime from the strategy overview page.</p>
                </div>
                <button class="coaching-modal-close" onclick="closeCoachingModal()">Cancel</button>
            </div>
        </div>

        <!-- RECENT ACTIVITY -->
        <div class="recent-section" id="recentSection">
            <h2>Recent Activity</h2>
            <div class="recent-activity" id="recentActivity">
                <!-- Populated by JS -->
            </div>
        </div>

    </div>

    <script>
        // ========================================================================
        // ACCOUNT DROPDOWN & AUTH FUNCTIONS
        // ========================================================================
        function toggleAccountMenu() {
            const dropdown = document.getElementById('accountDropdown');
            dropdown.classList.toggle('open');
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', function(e) {
            const dropdown = document.getElementById('accountDropdown');
            if (dropdown && !dropdown.contains(e.target)) {
                dropdown.classList.remove('open');
            }
        });

        function signOut() {
            // Clear all auth data
            localStorage.removeItem('supabase_session');
            localStorage.removeItem('beta_verified');
            localStorage.removeItem('henryhq_user');
            sessionStorage.clear();
            // Redirect to login
            window.location.href = '/login';
        }

        // ========================================================================
        // CONSTANTS
        // ========================================================================
        // Status definitions matching tracker.html structure with visual labels
        const STATUSES = {
            // Application Stage
            'Preparing': { active: true, color: 'cooling', category: 'Application', label: '  Preparing' },
            'Applied': { active: true, color: 'waiting', category: 'Application', label: '  Applied' },
            'Networking': { active: true, color: 'waiting', category: 'Application', label: '  Networking' },

            // Screening Stage
            'Recruiter Screen': { active: true, color: 'active', category: 'Screening', label: '  Recruiter Screen' },
            'Awaiting Screen Result': { active: true, color: 'waiting', category: 'Screening', label: '  Awaiting Screen Result' },

            // Interview Stage
            'Hiring Manager': { active: true, color: 'active', category: 'Interview', label: '  Hiring Manager' },
            'Technical Round': { active: true, color: 'active', category: 'Interview', label: '  Technical Round' },
            'Panel Interview': { active: true, color: 'active', category: 'Interview', label: '  Panel Interview' },
            'Final Round': { active: true, color: 'active', category: 'Interview', label: '  Final Round' },
            'Executive Interview': { active: true, color: 'active', category: 'Interview', label: '  Executive Interview' },
            'Awaiting Decision': { active: true, color: 'waiting', category: 'Interview', label: '  Awaiting Decision' },

            // Positive Outcome Stage
            'Offer Received': { active: true, color: 'hot', category: 'Outcome', label: '  Offer Received' },
            'Negotiating': { active: true, color: 'hot', category: 'Outcome', label: '  Negotiating' },
            'Accepted': { active: false, color: 'active', category: 'Outcome', label: '  Accepted' },

            // Closed Stage - Rejection reasons for coaching
            'Rejected: No Fit': { active: false, color: 'dead', category: 'Closed', label: '  No Fit' },
            'Rejected: Experience Gap': { active: false, color: 'dead', category: 'Closed', label: '  Experience Gap' },
            'Rejected: Culture Fit': { active: false, color: 'dead', category: 'Closed', label: '  Culture Fit' },
            'Rejected: Went Internal': { active: false, color: 'dead', category: 'Closed', label: '  Went Internal' },
            'Rejected: Other': { active: false, color: 'dead', category: 'Closed', label: '  Other' },
            'Withdrawn': { active: false, color: 'cooling', category: 'Closed', label: '  Withdrawn' },
            'No Response': { active: false, color: 'dead', category: 'Closed', label: '  No Response' },
            'Ghosted': { active: false, color: 'dead', category: 'Closed', label: '  Ghosted' }
        };

        // Helper functions for status checking
        function isRejectedStatus(status) {
            return status && status.startsWith('Rejected:');
        }

        function isClosedStatus(status) {
            return isRejectedStatus(status) || ['Withdrawn', 'No Response', 'Ghosted'].includes(status);
        }

        // Legacy status mapping for migration
        const LEGACY_STATUS_MAP = {
            'To Apply': 'Preparing',
            'Researching': 'Preparing',
            'Reached Out': 'Networking',
            'Response Received': 'Recruiter Screen',
            'Awaiting Screen': 'Awaiting Screen Result',
            'Awaiting Next Round': 'Awaiting Decision',
            'Interviewed': 'Awaiting Decision',
            'Reference Check': 'Awaiting Decision',
            'Offer': 'Offer Received',
            'Hot': 'Recruiter Screen',
            'Active': 'Applied',
            'Rejected': 'Rejected: Other'
        };

        // ========================================================================
        // DATA LOADING FUNCTIONS
        // ========================================================================
        function getUserProfile() {
            try {
                const profile = localStorage.getItem('userProfile');
                return profile ? JSON.parse(profile) : null;
            } catch (err) {
                console.error('Error loading user profile:', err);
                return null;
            }
        }

        // Global cache for applications (populated by Supabase or localStorage)
        let dashboardAppsCache = null;

        function getApplications() {
            // If cache is populated (from Supabase), use it
            if (dashboardAppsCache !== null) {
                return dashboardAppsCache;
            }

            // Fallback to localStorage
            try {
                const apps = localStorage.getItem('trackedApplications');
                const parsed = apps ? JSON.parse(apps) : [];
                // Migrate legacy statuses
                let needsSave = false;
                parsed.forEach(app => {
                    if (LEGACY_STATUS_MAP[app.status]) {
                        app.status = LEGACY_STATUS_MAP[app.status];
                        needsSave = true;
                    }
                });
                if (needsSave) {
                    localStorage.setItem('trackedApplications', JSON.stringify(parsed));
                }
                return parsed;
            } catch (err) {
                console.error('Error loading applications:', err);
                return [];
            }
        }

        function getActiveApplications(apps) {
            return apps.filter(a => STATUSES[a.status]?.active);
        }

        function getDaysSince(dateString) {
            if (!dateString) return 0;
            const date = new Date(dateString);
            const now = new Date();
            const diffTime = Math.abs(now - date);
            return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        }

        // ========================================================================
        // STATS CALCULATION FUNCTIONS
        // ========================================================================
        // Get upcoming interviews from dedicated localStorage (set by interview-intelligence.html)
        function getUpcomingInterviewsFromStorage() {
            try {
                const stored = localStorage.getItem('upcomingInterviews');
                return stored ? JSON.parse(stored) : [];
            } catch (e) {
                return [];
            }
        }

        function getInterviewsThisWeek(apps) {
            const upcomingInterviews = getUpcomingInterviewsFromStorage();
            const now = new Date();
            const weekFromNow = new Date(now.getTime() + 7 * 24 * 60 * 60 * 1000);

            // Count interviews scheduled within the next 7 days
            const scheduledThisWeek = upcomingInterviews.filter(interview => {
                if (!interview.date) return false;
                const interviewDate = new Date(interview.date);
                return interviewDate >= now && interviewDate <= weekFromNow;
            });

            return scheduledThisWeek.length;
        }

        // Get the next upcoming interview with date details
        function getNextUpcomingInterview() {
            const upcomingInterviews = getUpcomingInterviewsFromStorage();
            const now = new Date();

            console.log('Dashboard: Checking upcoming interviews from storage:', upcomingInterviews.length);

            // Filter to future interviews and sort by date
            const futureInterviews = upcomingInterviews
                .filter(i => {
                    if (!i.date) {
                        console.log('Dashboard: Interview missing date:', i.company);
                        return false;
                    }
                    const interviewDate = new Date(i.date);
                    const isFuture = interviewDate >= now;
                    console.log(`Dashboard: ${i.company} interview on ${i.date}, isFuture: ${isFuture}`);
                    return isFuture;
                })
                .sort((a, b) => new Date(a.date) - new Date(b.date));

            console.log('Dashboard: Future interviews found:', futureInterviews.length);
            return futureInterviews.length > 0 ? futureInterviews[0] : null;
        }

        function getFollowUpsDue(apps) {
            return apps.filter(a => {
                const daysSince = getDaysSince(a.dateApplied || a.dateAdded);
                return ['Applied', 'Networking'].includes(a.status) && daysSince >= 5;
            });
        }

        function getAvgResponseTime(apps) {
            const withResponse = apps.filter(a => {
                return a.dateApplied && (a.dateResponseReceived || a.dateInterviewed);
            });

            if (withResponse.length === 0) return null;

            const total = withResponse.reduce((sum, a) => {
                const responseDate = a.dateResponseReceived || a.dateInterviewed;
                const applied = new Date(a.dateApplied);
                const responded = new Date(responseDate);
                return sum + Math.floor((responded - applied) / (1000 * 60 * 60 * 24));
            }, 0);

            return Math.round(total / withResponse.length);
        }

        function getRecentApplications(apps) {
            return [...apps]
                .sort((a, b) => {
                    const aDate = new Date(a.lastUpdated || a.dateAdded);
                    const bDate = new Date(b.lastUpdated || b.dateAdded);
                    return bDate - aDate;
                })
                .slice(0, 5);
        }

        // ========================================================================
        // EMPATHY FUNCTIONS
        // ========================================================================
        function getPulseGreeting(profile, apps) {
            const activeCount = getActiveApplications(apps).length;

            if (!profile || !profile.situation) {
                if (activeCount === 0) {
                    return "Welcome back! Ready to find your next opportunity?";
                }
                return `You have ${activeCount} active application${activeCount !== 1 ? 's' : ''}. Here's what needs attention today.`;
            }

            const { holding_up, timeline } = profile.situation;

            // Crushed state (override everything)
            if (holding_up === 'crushed') {
                if (activeCount === 0) {
                    return "I know this is brutal. Let's get some applications moving.";
                }
                return `I know this is brutal. You have ${activeCount} active application${activeCount !== 1 ? 's' : ''}. Let's make sure each one gets follow-up.`;
            }

            // Desperate + urgent
            if (holding_up === 'desperate' && timeline === 'urgent') {
                return `Let's focus. You have ${activeCount} application${activeCount !== 1 ? 's' : ''} moving. Here's what needs attention today.`;
            }

            // Desperate (without urgent timeline)
            if (holding_up === 'desperate') {
                return `You've got ${activeCount} application${activeCount !== 1 ? 's' : ''} moving. Let's make sure nothing slips through the cracks.`;
            }

            // Stressed + active
            if (holding_up === 'stressed' && timeline === 'active') {
                return `You've got ${activeCount} application${activeCount !== 1 ? 's' : ''} moving. Here's what needs attention so nothing slips.`;
            }

            // Stressed (without active timeline)
            if (holding_up === 'stressed') {
                return `You have ${activeCount} active application${activeCount !== 1 ? 's' : ''}. Here's what's happening in your pipeline.`;
            }

            // Zen + exploring
            if (holding_up === 'zen' && timeline === 'exploring') {
                if (activeCount === 0) {
                    return "No rush. When you're ready, let's find the right opportunity.";
                }
                return `You've got ${activeCount} active application${activeCount !== 1 ? 's' : ''}. No rush. Let's keep the bar high.`;
            }

            // Zen (without exploring)
            if (holding_up === 'zen') {
                return `${activeCount} application${activeCount !== 1 ? 's are' : ' is'} active. Things are looking solid.`;
            }

            // Clock ticking (urgent timeline)
            if (timeline === 'clock_ticking') {
                return `Time matters. You have ${activeCount} application${activeCount !== 1 ? 's' : ''} active. Here's what requires immediate action.`;
            }

            // Default
            if (activeCount === 0) {
                return "Your pipeline is clear. Time to add your next target role.";
            }
            return `You have ${activeCount} active application${activeCount !== 1 ? 's' : ''}. Here's what needs attention today.`;
        }

        // ========================================================================
        // RENDER FUNCTIONS
        // ========================================================================
        function renderDashboard() {
            try {
                const profile = getUserProfile();
                const apps = getApplications();
                const activeApps = getActiveApplications(apps);

                renderWelcome(profile);
                renderDailyPulse(profile, apps);
                renderSetupChecklist(profile, apps);
                renderQuickStats(apps, activeApps);
                renderPriorityActions(apps);
                renderJobDiscoveryNetworkNote(profile);
                renderRealityCheck(profile, apps, activeApps);
                renderTodaysFocus(profile, apps, activeApps);
                renderStrategicOptions(profile);
                renderRecentActivity(apps);
            } catch (e) {
                console.error('Error rendering dashboard:', e);
                // Don't throw - this would trigger auth redirect
            }
        }

        // Cache for Supabase user name (set during auth check)
        let supabaseUserName = null;

        function renderWelcome(profile) {
            const welcomeHeading = document.getElementById('welcomeHeading');
            const welcomeSubtext = document.getElementById('welcomeSubtext');

            // Guard against missing DOM elements
            if (!welcomeHeading || !welcomeSubtext) {
                console.warn('Welcome elements not found in DOM');
                return;
            }

            // Get user's first name - check multiple possible locations
            let firstName = '';
            // First try Supabase user name (set during auth)
            if (supabaseUserName?.firstName && supabaseUserName.firstName !== 'there') {
                firstName = supabaseUserName.firstName;
            } else {
                // Fall back to profile data
                const fullName = profile?.resume?.contact?.full_name ||
                               profile?.resume?.full_name ||
                               profile?.name ||
                               null;
                if (fullName) {
                    firstName = fullName.split(' ')[0];
                }
            }

            // Time-based greeting
            const hour = new Date().getHours();
            let greeting = 'Good morning';
            if (hour >= 12 && hour < 17) greeting = 'Good afternoon';
            else if (hour >= 17) greeting = 'Good evening';

            // Only include name in greeting if we have one
            welcomeHeading.textContent = firstName ? `${greeting}, ${firstName}` : greeting;

            // Adaptive subtext based on situation
            const situation = profile?.situation;
            if (situation?.holding_up === 'crushed' || situation?.holding_up === 'desperate') {
                welcomeSubtext.textContent = "One step at a time. Let's focus on what matters most today.";
            } else if (situation?.timeline === 'clock_ticking' || situation?.timeline === 'urgent') {
                welcomeSubtext.textContent = "Time is precious. Here's what needs your attention.";
            } else if (situation?.holding_up === 'zen') {
                welcomeSubtext.textContent = "No rush. Let's make sure every application counts.";
            } else {
                welcomeSubtext.textContent = "Let's keep building momentum on your job search.";
            }
        }

        function renderDailyPulse(profile, apps) {
            const pulseGreeting = document.getElementById('pulseGreeting');
            if (!pulseGreeting) return;
            const greeting = getPulseGreeting(profile, apps);
            pulseGreeting.textContent = greeting;
        }

        function renderQuickStats(apps, activeApps) {
            const statActive = document.getElementById('statActive');
            const statInterviews = document.getElementById('statInterviews');
            const statFollowUps = document.getElementById('statFollowUps');
            const statResponseTime = document.getElementById('statResponseTime');

            // Guard against missing elements
            if (!statActive || !statInterviews || !statFollowUps || !statResponseTime) {
                console.warn('Quick stats elements not found in DOM');
                return;
            }

            statActive.textContent = activeApps.length;

            const interviewsThisWeek = getInterviewsThisWeek(apps);
            statInterviews.textContent = interviewsThisWeek;
            if (interviewsThisWeek > 0) {
                const cardInterviews = document.getElementById('cardInterviews');
                if (cardInterviews) cardInterviews.classList.add('highlight');
            }

            const followUpsDue = getFollowUpsDue(apps);
            statFollowUps.textContent = followUpsDue.length;
            if (followUpsDue.length > 0) {
                const cardFollowUps = document.getElementById('cardFollowUps');
                if (cardFollowUps) cardFollowUps.classList.add('urgent');
            }

            const avgResponseTime = getAvgResponseTime(apps);
            statResponseTime.textContent = avgResponseTime ? `${avgResponseTime}d` : '';
        }

        // ========================================================================
        // SETUP CHECKLIST
        // ========================================================================
        function renderSetupChecklist(profile, apps) {
            const section = document.getElementById('setupChecklistSection');
            const itemsContainer = document.getElementById('setupItems');
            const progressFill = document.getElementById('setupProgressFill');
            const progressText = document.getElementById('setupProgressText');

            if (!section || !itemsContainer) return;

            // Define the 4 setup steps and check completion
            const steps = [
                {
                    id: 'resume',
                    title: 'Upload your resume',
                    desc: 'Your resume powers everything  fit scores, positioning, interview prep',
                    done: !!(profile?.resume || profile?.work_history?.length > 0),
                    action: 'Upload',
                    link: '/linkedin-upload'
                },
                {
                    id: 'profile',
                    title: 'Complete your profile',
                    desc: 'Tell us your situation so we can tailor guidance to you',
                    done: !!(profile?.situation?.holding_up && profile?.situation?.timeline),
                    action: 'Set Up',
                    link: '/profile-edit'
                },
                {
                    id: 'analyze',
                    title: 'Analyze your first role',
                    desc: 'Paste a job description to get a fit score and strategy',
                    done: apps.some(a => a.analysisData || a.analysis_data || a.analysisKey),
                    action: 'Analyze',
                    link: '/analyze'
                },
                {
                    id: 'track',
                    title: 'Track your first application',
                    desc: 'Start building your pipeline to unlock intelligence',
                    done: apps.length > 0,
                    action: 'Add',
                    link: '/tracker'
                }
            ];

            const completedCount = steps.filter(s => s.done).length;
            const totalSteps = steps.length;

            // If all steps done, hide the checklist entirely
            if (completedCount === totalSteps) {
                section.style.display = 'none';
                return;
            }

            section.style.display = 'block';
            progressFill.style.width = `${(completedCount / totalSteps) * 100}%`;
            progressText.textContent = `${completedCount} of ${totalSteps} complete`;

            itemsContainer.innerHTML = steps.map(step => `
                <div class="setup-item ${step.done ? 'completed' : ''}">
                    <div class="setup-check">${step.done ? '&#10003;' : ''}</div>
                    <div class="setup-item-content">
                        <div class="setup-item-title">${step.title}</div>
                        <div class="setup-item-desc">${step.desc}</div>
                    </div>
                    <a href="${step.link}" class="setup-item-action">${step.action}</a>
                </div>
            `).join('');
        }

        // ========================================================================
        // PRIORITY ACTIONS (Command Center Intelligence on Dashboard)
        // ========================================================================
        function renderPriorityActions(apps) {
            const section = document.getElementById('priorityActionsSection');
            const card = document.getElementById('priorityActionsCard');

            if (!section || !card) return;

            // Only show if we have cached intelligence from a previous command center visit
            // or if the user has enough apps to warrant fetching
            const activeApps = getActiveApplications(apps);
            if (activeApps.length < 1) {
                section.style.display = 'none';
                return;
            }

            // Try to use cached intelligence if available
            if (window.CommandCenter && CommandCenter.cache.intelligence) {
                displayPriorityActions(section, card, apps, CommandCenter.cache.intelligence);
                return;
            }

            // Fetch intelligence in background (non-blocking)
            if (window.CommandCenter && activeApps.length >= 1) {
                const userId = localStorage.getItem('userId') || 'anonymous';
                CommandCenter.fetchIntelligence(userId, activeApps).then(intelligence => {
                    if (intelligence && intelligence.priority_actions?.length > 0) {
                        displayPriorityActions(section, card, apps, intelligence);
                    }
                }).catch(err => {
                    console.log('[Dashboard] Could not fetch intelligence:', err.message);
                });
            }
        }

        function displayPriorityActions(section, card, apps, intelligence) {
            const actions = intelligence.priority_actions || [];
            if (actions.length === 0) {
                section.style.display = 'none';
                return;
            }

            // Show up to 5 priority actions
            const topActions = actions.slice(0, 5);
            let html = topActions.map(action => {
                const app = apps.find(a => String(a.id) === String(action.application_id));
                const company = app?.company || 'Unknown';
                const icon = action.one_click_action?.type === 'draft_email' ? '&#9993;'
                    : action.one_click_action?.type === 'open_prep' ? '&#128203;'
                    : action.one_click_action?.type === 'archive' ? '&#128230;'
                    : '&#9889;';

                const btnConfig = window.CommandCenter ? CommandCenter.getOneClickButtonConfig(action.one_click_action) : null;
                const btnHtml = btnConfig
                    ? `<button class="priority-action-btn" onclick="handleDashboardAction('${action.application_id}', '${action.one_click_action?.type}')">${btnConfig.label}</button>`
                    : '';

                return `
                    <div class="priority-action-item">
                        <div class="priority-action-icon">${icon}</div>
                        <div class="priority-action-info">
                            <div class="priority-action-company">${company}</div>
                            <div class="priority-action-text">${action.action}</div>
                        </div>
                        ${btnHtml}
                    </div>
                `;
            }).join('');

            html += `
                <div class="priority-actions-footer">
                    <a href="/tracker">View full pipeline in Command Center &rarr;</a>
                </div>
            `;

            card.innerHTML = html;
            section.style.display = 'block';
        }

        // Handle one-click actions from priority actions on dashboard
        function handleDashboardAction(appId, actionType) {
            const apps = getApplications();
            const app = apps.find(a => String(a.id) === String(appId));

            if (actionType === 'draft_email' && app) {
                // Navigate to outreach with app context
                navigateWithAppContext(appId, 'outreach');
            } else if (actionType === 'open_prep') {
                window.location.href = '/interview-intelligence';
            } else if (actionType === 'archive') {
                // Navigate to tracker to handle archive
                window.location.href = `/tracker?highlight=${appId}`;
            } else {
                // Default: go to tracker
                window.location.href = `/tracker?highlight=${appId}`;
            }
        }

        /**
         * Show the LinkedIn network note in the job discovery footer
         * if the user hasn't uploaded their LinkedIn connections CSV.
         */
        function renderJobDiscoveryNetworkNote(profile) {
            const networkNote = document.getElementById('jobNetworkNote');
            if (!networkNote) return;

            // Show note if user hasn't uploaded LinkedIn connections
            const hasNetworkData = profile?.linkedin_connections_uploaded_at ||
                                   (profile?.linkedin_network_companies?.length > 0);

            if (!hasNetworkData) {
                networkNote.style.display = 'block';
            } else {
                networkNote.style.display = 'none';
            }
        }

        function renderRealityCheck(profile, apps, activeApps) {
            const section = document.getElementById('realityCheckSection');
            const headline = document.getElementById('realityCheckHeadline');
            const detail = document.getElementById('realityCheckDetail');
            const actions = document.getElementById('realityCheckActions');
            const icon = document.getElementById('realityCheckIcon');

            // Get profile situation values
            const { holding_up, timeline, confidence } = profile?.situation || {};

            // Determine urgency level
            const isUrgentTimeline = timeline === 'urgent' || timeline === 'soon';
            const isStrugglingEmotionally = holding_up === 'struggling' || holding_up === 'stressed_but_managing';
            const hasLowConfidence = confidence === 'low' || confidence === 'need_validation';

            // Calculate pipeline gaps
            const appCount = activeApps.length;
            const hasScheduledInterview = getNextUpcomingInterview() !== null;

            // Define reality check scenarios (only show if there's a real mismatch)
            let showRealityCheck = false;
            let realityContent = {
                icon: '',
                headline: '',
                detail: '',
                primaryBtn: { text: 'Analyze Role', link: '/analyze' },
                secondaryBtn: null
            };

            // Scenario 1: Urgent search + 0 applications
            if (isUrgentTimeline && appCount === 0) {
                showRealityCheck = true;
                realityContent = {
                    icon: '',
                    headline: 'Urgent search, zero pipeline',
                    detail: `You said your job search is <strong>${timeline === 'urgent' ? 'urgent' : 'happening soon'}</strong>, but you have no active applications. Every day without applications in play is a day lost. The average successful job search takes 3-6 months. Start now.`,
                    primaryBtn: { text: 'Analyze Your First Role', link: '/analyze' },
                    secondaryBtn: null
                };
            }
            // Scenario 2: Urgent search + only 1 application
            else if (isUrgentTimeline && appCount === 1) {
                showRealityCheck = true;

                realityContent = {
                    icon: '',
                    headline: 'One application isn\'t a job search',
                    detail: `You marked this search as <strong>${timeline}</strong>, but having just 1 application means you're betting everything on one outcome. That's not strategy, that's hope. <strong>Build to 5-10 active applications</strong> over the next few weeks. Quality over quantity, but you need options.`,
                    primaryBtn: { text: 'Add Another Role', link: '/analyze' },
                    secondaryBtn: { text: 'Why This Matters', prompt: 'Why does having only 1 application hurt my job search? Explain the math and psychology behind building a pipeline of 5-10 applications.' }
                };
            }
            // Scenario 3: Urgent + struggling emotionally + thin pipeline
            else if (isUrgentTimeline && isStrugglingEmotionally && appCount < 3) {
                showRealityCheck = true;

                realityContent = {
                    icon: '',
                    headline: 'Let\'s get your pipeline working for you',
                    detail: `I know this is hard. You're feeling ${holding_up === 'struggling' ? 'the pressure' : 'stressed'}, and that's completely valid. But here's the thing: <strong>more applications = more chances = less stress</strong>. Right now you have ${appCount} active. Build toward 5-10 quality applications. Take it one role at a time.`,
                    primaryBtn: { text: 'Add Another Role', link: '/analyze' },
                    secondaryBtn: { text: 'Talk Strategy', action: 'openHeyHenry' }
                };
            }
            // Scenario 4: Low confidence + no interviews scheduled
            else if (hasLowConfidence && !hasScheduledInterview && appCount >= 1) {
                showRealityCheck = true;
                realityContent = {
                    icon: '',
                    headline: 'Confidence comes from preparation',
                    detail: `You mentioned feeling ${confidence === 'low' ? 'low confidence' : 'like you need validation'} about your search. Here's the truth: <strong>confidence is built, not found</strong>. Practice your story, research your targets, and prepare like the interviews are already scheduled. You've got this.`,
                    primaryBtn: { text: 'Practice Interview', link: '/interview-intelligence' },
                    secondaryBtn: { text: 'Review Positioning', modalDest: 'positioning' }
                };
            }
            // Scenario 5: Thin pipeline without urgency (gentler nudge)
            // Note: No action button - user can use "Analyze New Role" in navigation
            else if (appCount === 1 && !isUrgentTimeline) {
                showRealityCheck = true;
                realityContent = {
                    icon: '',
                    headline: 'Diversify your pipeline',
                    detail: `Right now, your entire job search depends on one application. Even if you're not in a rush, <strong>spreading your bets across 5-10 roles</strong> dramatically increases your chances of landing the right opportunity. Don't put all your eggs in one basket.`,
                    primaryBtn: null,
                    secondaryBtn: null
                };
            }

            // Render or hide the section
            if (showRealityCheck) {
                section.style.display = 'block';
                icon.textContent = realityContent.icon;
                headline.textContent = realityContent.headline;
                detail.innerHTML = realityContent.detail;

                let actionsHTML = '';
                if (realityContent.primaryBtn) {
                    actionsHTML = `<a href="${realityContent.primaryBtn.link}" class="reality-check-btn">${realityContent.primaryBtn.text}</a>`;
                }
                if (realityContent.secondaryBtn) {
                    if (realityContent.secondaryBtn.prompt) {
                        // Use data attribute for prompt to avoid quote escaping issues
                        actionsHTML += `<button class="reality-check-btn secondary" data-prompt="${encodeURIComponent(realityContent.secondaryBtn.prompt)}" onclick="handleHeyHenryPrompt(this)">${realityContent.secondaryBtn.text}</button>`;
                    } else if (realityContent.secondaryBtn.action === 'openHeyHenry') {
                        actionsHTML += `<button class="reality-check-btn secondary" onclick="if(window.openHeyHenry) window.openHeyHenry();">${realityContent.secondaryBtn.text}</button>`;
                    } else if (realityContent.secondaryBtn.modalDest) {
                        // Use coaching modal for positioning/outreach
                        actionsHTML += `<button class="reality-check-btn secondary" onclick="showCoachingModal('${realityContent.secondaryBtn.modalDest}')">${realityContent.secondaryBtn.text}</button>`;
                    } else {
                        actionsHTML += `<a href="${realityContent.secondaryBtn.link}" class="reality-check-btn secondary">${realityContent.secondaryBtn.text}</a>`;
                    }
                }
                actions.innerHTML = actionsHTML;
            } else {
                section.style.display = 'none';
            }
        }

        // ========================================================================
        // STRATEGIC OPTIONS SECTION
        // ========================================================================
        const STRATEGIC_CONTENT = {
            desperate: {
                urgencyLabel: 'Urgent: Cash Flow Options',
                icon: '',
                headline: 'Need income now? Consider contract work.',
                detail: 'You need income now, not in 3-6 months. Contract work isn\'t giving up on your FTE search. It\'s <strong>buying yourself time</strong> and reducing desperation energy in interviews.',
                primaryBtn: { text: 'Show Contract Options', action: 'showContractGuidance' },
                secondaryBtn: { text: 'Not Right Now', action: 'dismiss' },
                cardClass: ''
            },
            stressed: {
                urgencyLabel: 'Tactical Options to Consider',
                icon: '',
                headline: 'Strategic alternatives while you search',
                detail: 'A tight timeline means you need to expand your opportunity set strategically. Contract work can serve as a <strong>bridge while you find the right FTE role</strong>. Plus, 30% of contract roles convert to full-time.',
                primaryBtn: { text: 'Explore Options', action: 'showContractGuidance' },
                secondaryBtn: { text: 'Dismiss', action: 'dismiss' },
                cardClass: 'stressed'
            },
            standard: {
                urgencyLabel: 'Other Paths Worth Exploring',
                icon: '',
                headline: 'Build leverage beyond the job search',
                detail: 'You\'ve got solid runway. Beyond your core search, consider <strong>advisory/consulting work</strong> to build credibility, expand your network, and create unexpected opportunities.',
                primaryBtn: { text: 'Learn More', action: 'showContractGuidance' },
                secondaryBtn: { text: 'Not Interested', action: 'dismiss' },
                cardClass: 'standard'
            }
        };

        function calculateUrgency(profile) {
            const timeline = profile?.situation?.timeline || 'actively_looking';
            const holdingUp = profile?.situation?.holdingUp || profile?.situation?.holding_up || 'doing_well';

            // Decision matrix from STRATEGIC_OPTIONS_DECISION_MATRIX.md

            // timeline = 'urgent' -> DESPERATE (regardless of holdingUp)
            if (timeline === 'urgent') {
                return 'desperate';
            }

            // timeline = 'soon' -> STRESSED (regardless of holdingUp)
            if (timeline === 'soon') {
                return 'stressed';
            }

            // timeline = 'actively_looking'
            if (timeline === 'actively_looking') {
                if (holdingUp === 'struggling') return 'desperate';
                if (holdingUp === 'stressed_but_managing') return 'stressed';
                // doing_well or rather_not_say -> standard
                return 'standard';
            }

            // timeline = 'no_rush'
            if (timeline === 'no_rush') {
                if (holdingUp === 'struggling') return 'desperate';
                if (holdingUp === 'stressed_but_managing') return 'stressed';
                if (holdingUp === 'doing_well') return 'none'; // Hide section for zen candidates
                // rather_not_say -> standard
                return 'standard';
            }

            // Default fallback
            return 'standard';
        }

        function renderStrategicOptions(profile) {
            const section = document.getElementById('strategicOptionsSection');
            const card = document.getElementById('strategicOptionsCard');
            const urgencyLabel = document.getElementById('strategicOptionsUrgencyLabel');
            const icon = document.getElementById('strategicOptionsIcon');
            const headline = document.getElementById('strategicOptionsHeadline');
            const detail = document.getElementById('strategicOptionsDetail');
            const actions = document.getElementById('strategicOptionsActions');

            // Check if dismissed today
            const dismissedDate = localStorage.getItem('strategicOptionsDismissed');
            const today = new Date().toDateString();
            if (dismissedDate === today) {
                section.style.display = 'none';
                return;
            }

            const urgency = calculateUrgency(profile);

            if (urgency === 'none') {
                section.style.display = 'none';
                return;
            }

            const content = STRATEGIC_CONTENT[urgency];
            if (!content) {
                section.style.display = 'none';
                return;
            }

            section.style.display = 'block';
            card.className = 'strategic-options-card ' + content.cardClass;
            urgencyLabel.textContent = content.urgencyLabel;
            icon.textContent = content.icon;
            headline.textContent = content.headline;
            detail.innerHTML = content.detail;

            // Build action buttons
            let actionsHTML = '';
            if (content.primaryBtn) {
                if (content.primaryBtn.action === 'showContractGuidance') {
                    actionsHTML += `<button class="strategic-options-btn" onclick="showContractGuidanceModal()">${content.primaryBtn.text}</button>`;
                } else if (content.primaryBtn.action === 'openHeyHenry') {
                    actionsHTML += `<button class="strategic-options-btn" onclick="if(window.openHeyHenry) window.openHeyHenry();">${content.primaryBtn.text}</button>`;
                }
            }
            if (content.secondaryBtn) {
                if (content.secondaryBtn.action === 'dismiss') {
                    actionsHTML += `<button class="strategic-options-btn secondary" onclick="dismissStrategicOptions()">${content.secondaryBtn.text}</button>`;
                } else if (content.secondaryBtn.action === 'openHeyHenry') {
                    actionsHTML += `<button class="strategic-options-btn secondary" onclick="if(window.openHeyHenry) window.openHeyHenry();">${content.secondaryBtn.text}</button>`;
                }
            }
            actions.innerHTML = actionsHTML;
        }

        function dismissStrategicOptions() {
            const today = new Date().toDateString();
            localStorage.setItem('strategicOptionsDismissed', today);
            document.getElementById('strategicOptionsSection').style.display = 'none';
        }

        function showContractGuidanceModal() {
            document.getElementById('contractModalOverlay').classList.add('show');
        }

        function closeContractGuidanceModal(event) {
            // If called from overlay click, only close if clicking the overlay itself
            if (event && event.target !== event.currentTarget) return;
            document.getElementById('contractModalOverlay').classList.remove('show');
        }

        // ========================================================================
        // COACHING MODAL (for context-aware Positioning/Outreach navigation)
        // ========================================================================
        let pendingCoachingDestination = null;

        const COACHING_MODAL_CONTENT = {
            positioning: {
                icon: '',
                title: 'View Positioning Strategy',
                intro: 'Your positioning strategy is tailored to each role you\'re targeting. Select an application to see how to best position yourself for that specific opportunity.',
                tip: 'Positioning shows you what to emphasize and de-emphasize based on the role requirements, company culture, and your background.'
            },
            outreach: {
                icon: '',
                title: 'View Outreach Templates',
                intro: 'Outreach messages are customized for each company and role. Select an application to access personalized email templates and LinkedIn messages.',
                tip: 'Each role has ready-to-send templates for reaching out to recruiters, hiring managers, and internal contacts.'
            }
        };

        function showCoachingModal(destination) {
            pendingCoachingDestination = destination;
            const content = COACHING_MODAL_CONTENT[destination] || COACHING_MODAL_CONTENT.positioning;

            // Update modal content
            document.getElementById('coachingModalIcon').textContent = content.icon;
            document.getElementById('coachingModalTitle').textContent = content.title;
            document.getElementById('coachingModalIntro').textContent = content.intro;
            document.getElementById('coachingModalTip').textContent = content.tip;

            // Populate application list
            const apps = getApplications();
            const activeApps = apps.filter(a => {
                const status = STATUSES[a.status];
                return status && status.active;
            });

            const listContainer = document.getElementById('coachingAppList');

            if (activeApps.length === 0) {
                listContainer.innerHTML = `
                    <div class="coaching-empty-state">
                        <p>You don't have any active applications yet. Analyze a new role to get personalized ${destination} strategies.</p>
                        <a href="/index" class="coaching-empty-cta">Analyze New Role</a>
                    </div>
                `;
            } else {
                listContainer.innerHTML = activeApps.map(app => `
                    <div class="coaching-app-item" onclick="navigateToCoachingDestination('${app.id}')">
                        <div class="coaching-app-info">
                            <div class="coaching-app-company">${app.company || 'Unknown Company'}</div>
                            <div class="coaching-app-role">${app.role_title || app.role || 'Role'}</div>
                        </div>
                        <span class="coaching-app-arrow"></span>
                    </div>
                `).join('');
            }

            document.getElementById('coachingModalOverlay').classList.add('show');
        }

        function closeCoachingModal(event) {
            if (event && event.target !== event.currentTarget) return;
            document.getElementById('coachingModalOverlay').classList.remove('show');
            pendingCoachingDestination = null;
        }

        function navigateToCoachingDestination(appId) {
            const apps = getApplications();
            const app = apps.find(a => String(a.id) === String(appId));
            if (!app) {
                console.error('Application not found:', appId);
                return;
            }

            // Get analysis data - prefer Supabase, fall back to localStorage
            let analysisData = null;

            // Check if app has analysisData embedded (from Supabase)
            if (app.analysisData && typeof app.analysisData === 'object') {
                analysisData = app.analysisData;
                console.log('Using analysisData from Supabase app object');
            }
            // Also check analysis_data (snake_case from DB)
            else if (app.analysis_data && typeof app.analysis_data === 'object') {
                analysisData = app.analysis_data;
                console.log('Using analysis_data from Supabase app object');
            }
            // Fall back to localStorage using analysisKey
            else if (app.analysisKey) {
                const stored = localStorage.getItem(app.analysisKey);
                if (stored) {
                    try {
                        analysisData = JSON.parse(stored);
                        console.log('Using analysisData from localStorage key:', app.analysisKey);
                    } catch (e) {
                        console.error('Failed to parse localStorage analysis data:', e);
                    }
                } else {
                    console.log('No data found in localStorage for key:', app.analysisKey);
                }
            }
            // Last resort: try to find by company/role pattern in localStorage
            else {
                console.log('No analysisKey found, searching localStorage for company:', app.company);
                // Try common key patterns
                const possibleKeys = [
                    `analysis_${app.company}_${app.role_title || app.role}`,
                    `analysis_${app.company}`,
                ];
                for (const key of possibleKeys) {
                    const stored = localStorage.getItem(key);
                    if (stored) {
                        try {
                            analysisData = JSON.parse(stored);
                            console.log('Found analysisData using fallback key:', key);
                            break;
                        } catch (e) {
                            console.error('Failed to parse fallback key:', key, e);
                        }
                    }
                }
            }

            if (!analysisData) {
                // No analysis data available - offer to go to strategy overview
                closeCoachingModal();
                const viewStrategy = confirm(
                    `Analysis data not found for ${app.company}.\n\n` +
                    'This may happen if the analysis was run on a different device.\n\n' +
                    'Would you like to view this application in the Strategy Overview instead?'
                );
                if (viewStrategy) {
                    window.location.href = `/tracker?highlight=${appId}`;
                }
                return;
            }

            // Store in sessionStorage for the destination page
            sessionStorage.setItem('analysisData', JSON.stringify(analysisData));

            // Navigate to destination (capture destination before closing modal clears it)
            const destination = pendingCoachingDestination;
            closeCoachingModal();
            window.location.href = '/' + destination;
        }

        // Direct navigation with specific app context (skips modal)
        function navigateWithAppContext(appId, destination) {
            const apps = getApplications();
            const app = apps.find(a => String(a.id) === String(appId));
            if (!app) {
                console.error('Application not found:', appId);
                // Fall back to modal
                showCoachingModal(destination);
                return;
            }

            // Get analysis data - prefer Supabase, fall back to localStorage
            let analysisData = null;

            // Check if app has analysisData embedded (from Supabase)
            if (app.analysisData && typeof app.analysisData === 'object') {
                analysisData = app.analysisData;
            }
            // Also check analysis_data (snake_case from DB)
            else if (app.analysis_data && typeof app.analysis_data === 'object') {
                analysisData = app.analysis_data;
            }
            // Fall back to localStorage using analysisKey
            else if (app.analysisKey) {
                const stored = localStorage.getItem(app.analysisKey);
                if (stored) {
                    try {
                        analysisData = JSON.parse(stored);
                    } catch (e) {
                        console.error('Failed to parse localStorage analysis data');
                    }
                }
            }
            // Last resort: try to find by company/role pattern in localStorage
            else {
                const possibleKeys = [
                    `analysis_${app.company}_${app.role_title || app.role}`,
                    `analysis_${app.company}`,
                ];
                for (const key of possibleKeys) {
                    const stored = localStorage.getItem(key);
                    if (stored) {
                        try {
                            analysisData = JSON.parse(stored);
                            break;
                        } catch (e) {
                            // Continue to next key
                        }
                    }
                }
            }

            if (!analysisData) {
                // No analysis data - fall back to modal to let user pick another app
                showCoachingModal(destination);
                return;
            }

            // Store in sessionStorage and navigate directly
            sessionStorage.setItem('analysisData', JSON.stringify(analysisData));
            window.location.href = '/' + destination;
        }

        function renderTodaysFocus(profile, apps, activeApps) {
            const container = document.getElementById('focusItems');
            const focusItems = generateFocusItems(profile, apps, activeApps);

            container.innerHTML = focusItems.map((item, i) => {
                let buttonHtml = '';
                if (item.buttonText) {
                    if (item.buttonAppId && item.buttonModalDest) {
                        // Direct navigation with specific app context (e.g., follow-up for specific company)
                        buttonHtml = `<button onclick="navigateWithAppContext('${item.buttonAppId}', '${item.buttonModalDest}')" class="focus-button ${item.buttonType || ''}">${item.buttonText}</button>`;
                    } else if (item.buttonModalDest) {
                        // Use modal for positioning/outreach (context-aware navigation)
                        buttonHtml = `<button onclick="showCoachingModal('${item.buttonModalDest}')" class="focus-button ${item.buttonType || ''}">${item.buttonText}</button>`;
                    } else if (item.buttonLink) {
                        buttonHtml = `<a href="${item.buttonLink}" class="focus-button ${item.buttonType || ''}">${item.buttonText}</a>`;
                    }
                }
                return `
                    <div class="focus-item ${item.type || ''} ${item.completed ? 'completed' : ''}">
                        <div class="focus-item-content">
                            ${item.label ? `<div class="focus-item-label">${item.label}</div>` : ''}
                            <div class="focus-message">${item.message}</div>
                        </div>
                        ${buttonHtml}
                    </div>
                `;
            }).join('');
        }

        function generateFocusItems(profile, apps, activeApps) {
            const items = [];
            const { holding_up, timeline } = profile?.situation || {};

            // Get interview-related data
            const interviewStatuses = ['Recruiter Screen', 'Hiring Manager', 'Technical Round',
                                       'Panel Interview', 'Final Round', 'Executive Interview'];

            // Check for UPCOMING interviews (have interview date in the future)
            const now = new Date();
            const upcomingInterviews = apps.filter(a => {
                if (!interviewStatuses.includes(a.status)) return false;
                // If there's an interview date, check if it's in the future
                if (a.interviewDate) {
                    return new Date(a.interviewDate) >= now;
                }
                // If no date but in interview status, it's "scheduled" but date unknown
                return true;
            });

            // Check for COMPLETED interviews (have interview date in the past or dateInterviewed set)
            const completedInterviews = apps.filter(a => {
                // Apps that are in post-interview stages
                if (['Awaiting Decision', 'Awaiting Screen Result', 'Offer Received', 'Negotiating'].includes(a.status)) {
                    return true;
                }
                // Apps in interview stage but with past interview date
                if (interviewStatuses.includes(a.status) && a.dateInterviewed) {
                    const interviewedDate = new Date(a.dateInterviewed);
                    // Consider "completed" if interviewed more than 1 day ago
                    return (now - interviewedDate) > (24 * 60 * 60 * 1000);
                }
                return false;
            });

            const followUpsDue = getFollowUpsDue(apps);

            // 
            // ITEM 1: Priority action (interview prep, follow-up, or apply)
            // 
            // Check for scheduled interviews from dedicated storage first
            const nextScheduledInterview = getNextUpcomingInterview();

            if (nextScheduledInterview) {
                // Format the interview date nicely
                const interviewDate = new Date(nextScheduledInterview.date);
                const dateOptions = { weekday: 'short', month: 'short', day: 'numeric' };
                const timeOptions = { hour: 'numeric', minute: '2-digit' };
                const dateStr = interviewDate.toLocaleDateString('en-US', dateOptions);
                const timeStr = interviewDate.toLocaleTimeString('en-US', timeOptions);

                // Calculate days until interview
                const daysUntil = Math.ceil((interviewDate - now) / (1000 * 60 * 60 * 24));
                let urgency = '';
                if (daysUntil === 0) urgency = '(Today!)';
                else if (daysUntil === 1) urgency = '(Tomorrow)';
                else if (daysUntil <= 3) urgency = `(in ${daysUntil} days)`;

                // Build interview message with interviewer name if available
                let interviewMsg = `<strong>${nextScheduledInterview.company}</strong>: ${nextScheduledInterview.type || 'Interview'}`;
                if (nextScheduledInterview.interviewerName) {
                    interviewMsg += ` with ${nextScheduledInterview.interviewerName}`;
                    if (nextScheduledInterview.interviewerTitle) {
                        interviewMsg += ` (${nextScheduledInterview.interviewerTitle})`;
                    }
                }
                interviewMsg += ` on ${dateStr} at ${timeStr} ${urgency}`;

                items.push({
                    label: 'Interview Coming Up',
                    message: interviewMsg,
                    buttonText: 'Prep Now',
                    buttonLink: '/interview-intelligence',
                    type: 'urgent'
                });
            } else if (upcomingInterviews.length > 0) {
                const nextInterview = upcomingInterviews[0];
                items.push({
                    label: 'Priority',
                    message: `<strong>Prepare for ${nextInterview.status.toLowerCase()}</strong> at ${nextInterview.company}`,
                    buttonText: 'Interview Prep',
                    buttonLink: '/interview-intelligence'
                });
            } else if (completedInterviews.length > 0) {
                // They have completed interviews - suggest follow-up or debrief
                const awaitingResponse = completedInterviews.filter(a =>
                    ['Awaiting Decision', 'Awaiting Screen Result'].includes(a.status)
                );
                if (awaitingResponse.length > 0) {
                    const app = awaitingResponse[0];
                    const daysSince = getDaysSince(app.dateInterviewed || app.lastUpdated);
                    if (daysSince >= 3) {
                        items.push({
                            label: 'Priority',
                            message: `<strong>Follow up with ${app.company}</strong>: ${daysSince} days since your interview`,
                            buttonText: 'Draft Follow-up',
                            buttonModalDest: 'outreach',
                            buttonAppId: app.id
                        });
                    } else {
                        items.push({
                            label: 'Awaiting Response',
                            message: `Waiting to hear back from <strong>${app.company}</strong> after your interview`,
                            buttonText: 'View Status',
                            buttonLink: '/tracker',
                            buttonType: 'secondary'
                        });
                    }
                }
            } else if (followUpsDue.length > 0) {
                const oldestFollowUp = followUpsDue.sort((a, b) =>
                    new Date(a.dateApplied || a.dateAdded) - new Date(b.dateApplied || b.dateAdded)
                )[0];
                const daysSince = getDaysSince(oldestFollowUp.dateApplied || oldestFollowUp.dateAdded);
                items.push({
                    label: 'Priority',
                    message: `<strong>Follow up with ${oldestFollowUp.company}</strong>: ${daysSince} days since applying`,
                    buttonText: 'Draft Follow-up',
                    buttonModalDest: 'outreach',
                    buttonAppId: oldestFollowUp.id
                });
            } else if (activeApps.length > 0) {
                // Has active apps but nothing urgent - suggest keeping momentum
                items.push({
                    label: 'On Track',
                    message: `<strong>${activeApps.length} active applications</strong> in your pipeline. Keep the momentum going.`,
                    buttonText: 'View Pipeline',
                    buttonLink: '/tracker',
                    buttonType: 'secondary'
                });
            }

            // 
            // ITEM 2: Pipeline health / Apply to more roles
            // 
            // Note: Critical warnings are now shown in the Reality Check section above
            // This section provides lighter guidance for pipeline growth
            // User can click "Analyze New Role" in the navigation pane to add roles
            if (activeApps.length < 5) {
                let pipelineMsg = '';
                let itemType = 'secondary';
                let labelText = 'Growth';

                if (activeApps.length === 0) {
                    pipelineMsg = '<strong>Start building your pipeline</strong>. Use "Analyze New Role" in the menu to add your first target.';
                } else if (activeApps.length <= 2) {
                    pipelineMsg = `<strong>Expand your pipeline:</strong> ${activeApps.length} active app${activeApps.length > 1 ? 's' : ''}. Aim for 5-10 for best results.`;
                } else {
                    pipelineMsg = `<strong>Keep going:</strong> ${activeApps.length} active apps. A few more gives you optionality.`;
                }
                items.push({
                    label: labelText,
                    message: pipelineMsg,
                    buttonText: null,
                    buttonLink: null,
                    type: itemType
                });
            } else {
                // Pipeline is healthy - show status only
                items.push({
                    label: 'Pipeline',
                    message: `<strong>${activeApps.length} active applications</strong>. Solid pipeline. Add selectively for quality matches.`,
                    buttonText: null,
                    buttonLink: null,
                    type: 'secondary',
                    buttonType: 'secondary'
                });
            }

            // 
            // ITEM 3: Coaching / Maintenance tasks
            // 
            // Check for stale applications (no activity in 14+ days)
            const staleApps = activeApps.filter(a => {
                const daysSince = getDaysSince(a.lastUpdated || a.dateAdded);
                return daysSince >= 14 && !['Awaiting Decision', 'Awaiting Screen Result'].includes(a.status);
            });

            if (staleApps.length > 0) {
                items.push({
                    label: 'Maintenance',
                    message: `<strong>${staleApps.length} stale application${staleApps.length > 1 ? 's' : ''}</strong>: No activity in 14+ days. Review and archive if needed.`,
                    buttonText: 'Review',
                    buttonLink: '/tracker',
                    type: 'secondary',
                    buttonType: 'secondary'
                });
            } else if (followUpsDue.length > 1) {
                // Multiple follow-ups due - show modal to select which one
                items.push({
                    label: 'Follow-ups',
                    message: `<strong>${followUpsDue.length} applications</strong> need follow-up messages`,
                    buttonText: 'Draft Follow-up',
                    buttonModalDest: 'outreach',
                    type: 'secondary',
                    buttonType: 'secondary'
                });
            } else {
                // General coaching tip
                const tips = [
                    { message: '<strong>Tip:</strong> Personalize each application. Generic submissions get filtered out.', btn: 'Positioning', modalDest: 'positioning' },
                    { message: '<strong>Tip:</strong> Network connections increase response rates by 4x.', btn: 'Outreach', modalDest: 'outreach' },
                    { message: '<strong>Tip:</strong> Practice your story. Preparation shows in interviews.', link: '/interview-intelligence', btn: 'Prep' }
                ];
                const tip = tips[Math.floor(Math.random() * tips.length)];
                items.push({
                    label: 'Coaching',
                    message: tip.message,
                    buttonText: tip.btn,
                    buttonLink: tip.link || null,
                    buttonModalDest: tip.modalDest || null,
                    type: 'secondary',
                    buttonType: 'secondary'
                });
            }

            // Ensure we have at least 3 items
            if (items.length < 3 && activeApps.length === 0) {
                items.push({
                    label: 'Getting Started',
                    message: '<strong>Welcome to HenryHQ!</strong> Click "Analyze New Role" in the menu to get personalized strategy.',
                    buttonText: null,
                    buttonLink: null,
                    type: 'secondary'
                });
            }

            return items;
        }

        function renderRecentActivity(apps) {
            const recent = getRecentApplications(apps);
            const container = document.getElementById('recentActivity');
            const section = document.getElementById('recentSection');

            if (recent.length === 0) {
                section.style.display = 'none';
                return;
            }

            section.style.display = 'block';
            container.innerHTML = recent.map(app => `
                <div class="activity-item">
                    <div class="activity-info">
                        <div class="activity-company">${app.company || 'Unknown Company'}</div>
                        <div class="activity-role">${app.role_title || app.role || 'Role'}</div>
                    </div>
                    <div class="activity-meta">
                        <span class="status-badge ${getStatusClass(app.status)}">${getStatusLabel(app.status) || 'Unknown'}</span>
                        <span class="activity-time">${getDaysSince(app.lastUpdated || app.dateAdded)}d ago</span>
                    </div>
                    <a href="#" onclick="viewApplicationStrategy('${app.id}'); return false;" class="activity-link">View Strategy </a>
                </div>
            `).join('');
        }

        // Navigate to Strategy Overview for a specific application
        // D4: Prefer app.analysisData from Supabase over localStorage
        function viewApplicationStrategy(appId) {
            const apps = getApplications();
            const app = apps.find(a => String(a.id) === String(appId));
            if (!app) {
                console.error('Application not found:', appId);
                return;
            }

            // D4: Prefer Supabase analysisData first
            let analysisData = null;

            // Check if app has analysisData embedded (from Supabase)
            if (app.analysisData && typeof app.analysisData === 'object') {
                analysisData = app.analysisData;
                console.log('Using analysisData from Supabase app object');
            }
            // Also check analysis_data (snake_case from DB)
            else if (app.analysis_data && typeof app.analysis_data === 'object') {
                analysisData = app.analysis_data;
                console.log('Using analysis_data from Supabase app object');
            }
            // Fall back to localStorage only if Supabase data unavailable
            else if (app.analysisKey) {
                const stored = localStorage.getItem(app.analysisKey);
                if (stored) {
                    try {
                        analysisData = JSON.parse(stored);
                        console.log('Fallback: Using analysisData from localStorage');
                    } catch (e) {
                        console.error('Error parsing analysis data from localStorage:', e);
                    }
                }
            }

            // If we have analysis data, store it in sessionStorage and navigate to overview
            if (analysisData) {
                sessionStorage.setItem('analysisData', JSON.stringify(analysisData));
                window.location.href = '/overview';
            } else {
                // D4: Show explicit message instead of silent fallback
                const goToTracker = confirm(
                    'Analysis data not found for this application.\n\n' +
                    'This may happen if the analysis was run on a different device.\n\n' +
                    'Would you like to view this application in the tracker instead?'
                );
                if (goToTracker) {
                    window.location.href = `/tracker?highlight=${appId}`;
                }
            }
        }

        function getStatusClass(status) {
            if (['Offer Received', 'Negotiating'].includes(status)) return 'status-hot';
            if (['Recruiter Screen', 'Hiring Manager', 'Technical Round', 'Panel Interview', 'Final Round', 'Executive Interview'].includes(status)) return 'status-active';
            if (['Applied', 'Networking', 'Preparing', 'Awaiting Decision', 'Awaiting Screen Result'].includes(status)) return 'status-waiting';
            if (isRejectedStatus(status) || isClosedStatus(status)) return 'status-dead';
            return 'status-default';
        }

        // Get display label for status (with emoji)
        function getStatusLabel(status) {
            return STATUSES[status]?.label || status;
        }

        // Handle Hey Henry prompt from button click (avoids quote escaping issues)
        function handleHeyHenryPrompt(button) {
            const prompt = decodeURIComponent(button.dataset.prompt);
            if (window.openHeyHenryWithPrompt) {
                window.openHeyHenryWithPrompt(prompt);
            } else {
                console.error('openHeyHenryWithPrompt not available yet');
            }
        }

        // ========================================================================
        // MILESTONE CELEBRATIONS
        // ========================================================================
        const MILESTONES = {
            first_app: {
                icon: '',
                title: 'First Application!',
                message: 'You\'ve started your job search journey. Keep the momentum going!',
                check: (apps, interviews) => apps.length >= 1
            },
            five_apps: {
                icon: '',
                title: 'Pipeline Building!',
                message: '5 applications in your pipeline. You\'re playing the numbers right.',
                check: (apps, interviews) => apps.length >= 5
            },
            ten_apps: {
                icon: '',
                title: 'Serious Contender!',
                message: '10 applications! Your pipeline is solid. Quality over quantity from here.',
                check: (apps, interviews) => apps.length >= 10
            },
            first_interview: {
                icon: '',
                title: 'First Interview Scheduled!',
                message: 'Your prep is paying off. Time to shine!',
                check: (apps, interviews) => interviews.length >= 1
            },
            three_interviews: {
                icon: '',
                title: 'Interview Machine!',
                message: '3 interviews scheduled. Your strategy is working.',
                check: (apps, interviews) => interviews.length >= 3
            },
            offer_received: {
                icon: '',
                title: 'OFFER RECEIVED!',
                message: 'All your hard work paid off. Time to negotiate!',
                check: (apps, interviews) => apps.some(a => a.status === 'Offer Received' || a.status === 'Negotiating')
            },
            accepted: {
                icon: '',
                title: 'YOU DID IT!',
                message: 'Congratulations on your new role! Henry is so proud of you.',
                check: (apps, interviews) => apps.some(a => a.status === 'Accepted')
            }
        };

        // Get celebrated milestones from localStorage
        function getCelebratedMilestones() {
            try {
                const stored = localStorage.getItem('celebratedMilestones');
                return stored ? JSON.parse(stored) : [];
            } catch (e) {
                return [];
            }
        }

        // Mark a milestone as celebrated
        function markMilestoneCelebrated(milestoneId) {
            const celebrated = getCelebratedMilestones();
            if (!celebrated.includes(milestoneId)) {
                celebrated.push(milestoneId);
                localStorage.setItem('celebratedMilestones', JSON.stringify(celebrated));
            }
        }

        // Check for new milestones and show celebration
        function checkMilestones(apps, interviews) {
            const celebrated = getCelebratedMilestones();
            const activeApps = getActiveApplications(apps);

            // Check milestones in order of significance (highest first)
            const priorityOrder = ['accepted', 'offer_received', 'three_interviews', 'first_interview', 'ten_apps', 'five_apps', 'first_app'];

            for (const milestoneId of priorityOrder) {
                const milestone = MILESTONES[milestoneId];
                if (!celebrated.includes(milestoneId) && milestone.check(activeApps, interviews)) {
                    // Mark as celebrated first to prevent repeated attempts
                    markMilestoneCelebrated(milestoneId);
                    showMilestone(milestoneId, milestone);
                    return; // Only show one milestone at a time
                }
            }
        }

        // Show milestone toast
        function showMilestone(milestoneId, milestone) {
            const toast = document.getElementById('milestoneToast');
            const icon = document.getElementById('milestoneIcon');
            const title = document.getElementById('milestoneTitle');
            const message = document.getElementById('milestoneMessage');

            // Guard against missing DOM elements
            if (!toast || !icon || !title || !message) {
                console.warn('Milestone toast elements not found');
                return;
            }

            icon.textContent = milestone.icon;
            title.textContent = milestone.title;
            message.textContent = milestone.message;

            // Show the toast
            setTimeout(() => {
                toast.classList.add('show');
            }, 500); // Small delay for dramatic effect

            // Auto-hide after 8 seconds
            setTimeout(() => {
                closeMilestone();
            }, 8000);
        }

        // Close milestone toast
        function closeMilestone() {
            const toast = document.getElementById('milestoneToast');
            toast.classList.remove('show');
        }

        // ========================================================================
        // INITIALIZATION - D1: Block render until auth verified
        // ========================================================================
        // Flag to track if dashboard has been initialized
        let dashboardInitialized = false;
        let supabaseDataLoaded = false;

        // D1: Hide body until auth verified (prevent flash of stale content)
        document.body.style.visibility = 'hidden';

        // Show loading state - use overlay instead of wiping DOM
        function showLoadingState() {
            // Create loading overlay instead of replacing container content
            const overlay = document.createElement('div');
            overlay.id = 'loadingOverlay';
            overlay.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: var(--color-bg, #0a0a0b); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 9999; color: var(--color-text-secondary, #71717a);';
            overlay.innerHTML = '<div style="font-size: 1.2rem;">Loading dashboard...</div>';
            document.body.appendChild(overlay);
            document.body.style.visibility = 'visible';
        }

        // Hide loading overlay
        function hideLoadingState() {
            const overlay = document.getElementById('loadingOverlay');
            if (overlay) overlay.remove();
        }

        function showAuthError(message) {
            document.body.innerHTML = `
                <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; background: #0a0a0b; color: #f87171; font-family: system-ui; padding: 40px; text-align: center;">
                    <h2 style="margin-bottom: 16px;">Authentication Required</h2>
                    <p style="margin-bottom: 24px; color: #a1a1aa;">${message}</p>
                    <a href="/login" style="background: #22d3ee; color: #000; padding: 12px 24px; border-radius: 8px; text-decoration: none; font-weight: 600;">Return to Login</a>
                </div>
            `;
            document.body.style.visibility = 'visible';
        }

        function showDataError(message) {
            document.body.innerHTML = `
                <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; background: #0a0a0b; color: #fbbf24; font-family: system-ui; padding: 40px; text-align: center;">
                    <h2 style="margin-bottom: 16px;">Data Error</h2>
                    <p style="margin-bottom: 24px; color: #a1a1aa;">${message}</p>
                    <a href="/dashboard" style="background: #22d3ee; color: #000; padding: 12px 24px; border-radius: 8px; text-decoration: none; font-weight: 600;">Refresh</a>
                </div>
            `;
            document.body.style.visibility = 'visible';
        }

        // D1: Do NOT render on DOMContentLoaded - wait for auth
        document.addEventListener('DOMContentLoaded', () => {
            showLoadingState();
        });
    </script>

    <!-- Auth scripts -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/supabase-client.js"></script>
    <!-- Command Center Intelligence (for priority actions) -->
    <script src="js/command-center.js"></script>
    <script>
        // D1: Auth check MUST complete before any rendering
        (async function() {
            // D1: Fail closed if auth library unavailable
            if (typeof HenryAuth === 'undefined') {
                showAuthError('Authentication system unavailable. Please refresh or return to login.');
                return;
            }

            try {
                const session = await HenryAuth.getSession();
                if (!session) {
                    // Not logged in, redirect to login
                    window.location.href = '/login';
                    return;
                }

                // Beta gate - check localStorage (standard flow for private beta)
                // Note: Server-side beta verification deferred to v1.1
                if (localStorage.getItem('beta_verified') !== 'true') {
                    window.location.href = '/beta-access';
                    return;
                }

                // IMPORTANT: Validate that localStorage data belongs to this user
                // If different user logged in, this clears old data
                await HenryAuth.validateUserData();

                // Check if new user needs onboarding (set during signup)
                if (localStorage.getItem('henryai_needs_onboarding') === 'true') {
                    // First check if they already have a profile or resume data
                    // (e.g., returning user who logged in on different device)
                    let hasExistingData = false;

                    if (typeof HenryData !== 'undefined') {
                        try {
                            const [profile, resumeConvo] = await Promise.all([
                                HenryData.getCandidateProfile(),
                                HenryData.getResumeConversation()
                            ]);
                            // If they have profile with resume or work history, skip onboarding
                            hasExistingData = (profile?.resume || profile?.work_history?.length > 0) ||
                                              (resumeConvo?.resume_json);
                        } catch (e) {
                            console.log('Could not check for existing data:', e);
                        }
                    }

                    localStorage.removeItem('henryai_needs_onboarding');

                    if (!hasExistingData) {
                        window.location.href = '/profile-edit';
                        return;
                    }
                    console.log('Skipping onboarding - user has existing profile data');
                }

                // Get user's name from Supabase for personalized greeting
                supabaseUserName = await HenryAuth.getUserName();

                // D2: Load applications from Supabase BEFORE first render
                // Supabase is the authoritative source
                if (typeof HenryData !== 'undefined') {
                    try {
                        const apps = await HenryData.getApplications();
                        if (apps && apps.length > 0) {
                            console.log('Loaded', apps.length, 'applications from Supabase');
                            // Update cache and localStorage
                            dashboardAppsCache = apps;
                            localStorage.setItem('trackedApplications', JSON.stringify(apps));
                            supabaseDataLoaded = true;
                        } else {
                            console.log('No applications in Supabase');
                            // D2: Clear cache - Supabase returned empty, don't use stale localStorage
                            dashboardAppsCache = [];
                            supabaseDataLoaded = true;
                        }
                    } catch (err) {
                        console.error('Error loading from Supabase:', err);
                        // D2: Show error instead of silent fallback to localStorage
                        showDataError('Unable to load your applications. Please check your connection and refresh.');
                        return;
                    }
                } else {
                    showDataError('Database unavailable. Please refresh the page.');
                    return;
                }

                // Auth verified, data loaded - NOW render dashboard
                dashboardInitialized = true;
                hideLoadingState();
                document.body.style.visibility = 'visible';
                renderDashboard();

                // Check for milestones after render
                const apps = getApplications();
                const interviews = getUpcomingInterviewsFromStorage();
                checkMilestones(apps, interviews);

                // Listen for Hey Henry data corrections to auto-refresh the dashboard
                window.addEventListener('henryDataCorrected', async (event) => {
                    console.log('=== HEY HENRY DATA CORRECTED (dashboard) ===', event.detail);
                    // Re-fetch from Supabase to get fresh data
                    if (typeof HenryData !== 'undefined') {
                        try {
                            const apps = await HenryData.getApplications(true); // Force refresh
                            if (apps) {
                                dashboardAppsCache = apps;
                                localStorage.setItem('trackedApplications', JSON.stringify(apps));
                                renderDashboard();
                            }
                        } catch (e) {
                            console.error('Error refreshing dashboard after data correction:', e);
                        }
                    }
                });
            } catch (authErr) {
                console.error('Auth check failed:', authErr);
                // Only redirect if not already redirecting (prevent loops)
                if (!window.location.href.includes('login')) {
                    window.location.href = '/login';
                }
            }
        })();
    </script>
    <script src="components/analytics.js"></script>
<script src="components/hey-henry.js"></script>
<script src="components/admin-alerts.js"></script>
    <script src="components/strategy-nav.js"></script>
    <script src="components/interview-notifications.js"></script>

    <!-- LinkedIn Upload Feature -->
    <link rel="stylesheet" href="css/linkedin.css">
    <script src="js/linkedin-upload.js"></script>
    <script src="js/job-discovery.js"></script>

    <!-- Welcome Flow for New and Returning Users -->
    <script>
    (function() {
        'use strict';

        // ==========================================
        // FIRST-TIME USER WELCOME FLOW
        // ==========================================

        async function checkFirstTimeUser() {
            // Only run if HenryAuth is available
            if (typeof HenryAuth === 'undefined') return;

            const user = await HenryAuth.getUser();
            if (!user) return;

            // Check if profile exists in Supabase
            let hasProfile = false;
            if (typeof HenryData !== 'undefined') {
                try {
                    const profile = await HenryData.getCandidateProfile();
                    hasProfile = profile && profile.resume;
                } catch (e) {
                    console.log('Could not check profile:', e);
                }
            }

            // Check if already seen welcome
            const hasSeenWelcome = localStorage.getItem('hasSeenWelcome');

            if (!hasProfile && !hasSeenWelcome) {
                // First-time user without profile, show welcome
                await showWelcomeFlow(user);
            }
        }

        async function showWelcomeFlow(user) {
            // Get first name from user metadata or email
            const firstName = user.user_metadata?.full_name?.split(' ')[0] ||
                             user.user_metadata?.first_name ||
                             user.email?.split('@')[0] ||
                             'there';

            // Wait 1 second for page to settle
            await new Promise(resolve => setTimeout(resolve, 1000));

            // Get FAB element and pulse it
            const fab = document.getElementById('askHenryFab');
            if (fab) {
                fab.classList.add('genie-pulse');
                await new Promise(resolve => setTimeout(resolve, 900)); // 3 pulses
                fab.classList.remove('genie-pulse');
            }

            // Create overlay
            const overlay = document.createElement('div');
            overlay.className = 'genie-overlay';
            overlay.id = 'genieOverlay';
            document.body.appendChild(overlay);

            // Get drawer and add genie mode
            const drawer = document.getElementById('askHenryDrawer');
            if (drawer) {
                drawer.classList.add('genie-mode');
                drawer.style.display = 'flex';
            }

            // Wait for animation
            await new Promise(resolve => setTimeout(resolve, 600));

            // Build welcome message
            const welcomeMessage = `Hey ${firstName}, welcome to HenryHQ.

I'm Henry. I'll be your strategic advisor through this job search.

No mass applying. No fluff. Just honest fit checks, clear positioning, and materials grounded in your real experience. Never fabricated.

To get started, I need your resume, LinkedIn profile, and job search preferences. Takes about 35 minutes. After that, you're ready to analyze roles and move with intention.

I'm always here. If you're unsure about a role or how to position yourself, just ask.`;

            // Display message in chat
            const messagesContainer = document.getElementById('askHenryMessages');
            if (messagesContainer) {
                // Clear existing messages
                messagesContainer.innerHTML = '';

                // Add welcome message
                const messageDiv = document.createElement('div');
                messageDiv.className = 'ask-henry-message assistant';
                messageDiv.innerHTML = welcomeMessage.replace(/\n/g, '<br>');
                messagesContainer.appendChild(messageDiv);

                // Add "Create My Profile" button
                const buttonContainer = document.createElement('div');
                buttonContainer.className = 'welcome-button-container';

                const button = document.createElement('button');
                button.textContent = 'Create My Profile';
                button.className = 'btn-welcome';
                button.onclick = handleCreateProfile;

                buttonContainer.appendChild(button);
                messagesContainer.appendChild(buttonContainer);

                // Scroll to bottom
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }
        }

        async function handleCreateProfile() {
            // Mark as seen
            localStorage.setItem('hasSeenWelcome', 'true');

            // Get elements
            const drawer = document.getElementById('askHenryDrawer');
            const overlay = document.getElementById('genieOverlay');

            // Genie collapse animation
            if (drawer) {
                drawer.classList.remove('genie-mode');
                drawer.classList.add('genie-collapse');
            }

            if (overlay) {
                overlay.style.animation = 'genieOverlayFadeOut 0.3s ease forwards';
            }

            // Wait for animation
            await new Promise(resolve => setTimeout(resolve, 500));

            // Clean up
            if (overlay) overlay.remove();
            if (drawer) {
                drawer.classList.remove('genie-collapse');
                drawer.style.display = 'none';
            }

            // Redirect to profile setup
            window.location.href = '/profile-edit';
        }

        // ==========================================
        // RETURNING USER WELCOME BACK FLOW
        // ==========================================

        async function checkReturningUser() {
            // Only run if HenryAuth is available
            if (typeof HenryAuth === 'undefined') return;

            const user = await HenryAuth.getUser();
            if (!user) return;

            // Check if profile exists
            let profile = null;
            if (typeof HenryData !== 'undefined') {
                try {
                    profile = await HenryData.getCandidateProfile();
                } catch (e) {
                    console.log('Could not check profile:', e);
                }
            }

            if (!profile || !profile.resume) return; // No profile yet

            // Check if coming directly from profile setup
            const urlParams = new URLSearchParams(window.location.search);
            const fromProfileSetup = urlParams.get('from') === 'profile-setup';

            if (fromProfileSetup) {
                // First time after profile creation - show action prompt
                await showFirstActionPrompt(user, profile);
                // Mark welcome back as seen so it doesn't show on refresh
                localStorage.setItem('hasSeenWelcomeBack', 'true');
                // Clean URL
                window.history.replaceState({}, '', '/dashboard');
                return;
            }

            // NOTE: The "Welcome back" flow should ONLY show ONCE after profile creation.
            // It is NOT meant to show on every return visit.
            // The first action prompt (showFirstActionPrompt) shows when coming from profile setup.
            // The welcome back flow was previously showing incorrectly on subsequent logins.
            //
            // Removing this flow entirely - the normal Hey Henry greeting handles returning users.
            // If you want to re-enable a one-time welcome, use a per-user flag stored in Supabase,
            // not localStorage which gets cleared on logout/different browser.

            // DISABLED: Welcome back flow - was showing incorrectly on every login
            // const hasSeenWelcomeBack = localStorage.getItem('hasSeenWelcomeBack');
            // if (!hasSeenWelcomeBack) {
            //     await showWelcomeBackFlow(user, profile);
            // }
        }

        async function showWelcomeBackFlow(user, profile) {
            // Wait 500ms
            await new Promise(resolve => setTimeout(resolve, 500));

            // Open chat normally using existing function
            if (typeof openAskHenry === 'function') {
                openAskHenry();
            } else {
                // Fallback: manually open drawer
                const drawer = document.getElementById('askHenryDrawer');
                const fab = document.getElementById('askHenryFab');
                if (drawer) drawer.style.display = 'flex';
                if (fab) fab.classList.add('active');
            }

            // Wait for drawer to open
            await new Promise(resolve => setTimeout(resolve, 300));

            // Build dynamic message
            const message = buildWelcomeBackMessage(user, profile);

            // Display message in chat
            const messagesContainer = document.getElementById('askHenryMessages');
            if (messagesContainer) {
                // Clear existing messages
                messagesContainer.innerHTML = '';

                // Add welcome back message
                const messageDiv = document.createElement('div');
                messageDiv.className = 'ask-henry-message assistant';
                messageDiv.innerHTML = message.replace(/\n/g, '<br>');
                messagesContainer.appendChild(messageDiv);

                // Add "Got It" button
                const buttonContainer = document.createElement('div');
                buttonContainer.className = 'welcome-button-container';

                const button = document.createElement('button');
                button.textContent = 'Got It';
                button.className = 'btn-welcome';
                button.style.padding = '12px 32px';
                button.style.fontSize = '0.95rem';
                button.onclick = handleGotIt;

                buttonContainer.appendChild(button);
                messagesContainer.appendChild(buttonContainer);

                // Scroll to bottom
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }
        }

        function buildWelcomeBackMessage(user, profile) {
            const firstName = profile.resume?.contact?.full_name?.split(' ')[0] ||
                             user.user_metadata?.full_name?.split(' ')[0] ||
                             user.email?.split('@')[0] ||
                             'there';

            const timeline = profile.timeline;
            const confidence = profile.confidence;

            // Dynamic context based on timeline
            let dynamicContext = '';
            if (timeline === 'urgent') {
                dynamicContext = "I know you're under pressure. Let's find roles that are actually worth your time so you're not spinning your wheels.";
            } else if (timeline === 'soon') {
                dynamicContext = "You need to move fast, so let's make every application count. No spray-and-pray.";
            } else if (timeline === 'actively_looking') {
                dynamicContext = "You've got a solid window. Let's be strategic so you land something good, not just something fast.";
            } else if (timeline === 'no_rush') {
                dynamicContext = "You're in a good position. Let's find roles that are actually worth making a move for.";
            } else {
                dynamicContext = "You're all set to start analyzing roles.";
            }

            // Dynamic closing based on confidence
            let dynamicClosing = '';
            if (confidence === 'low' || confidence === 'need_validation') {
                dynamicClosing = "Quick thing: if you're ever unsure about a role or how to position yourself, just ask. I'm here to help you see what's actually working.";
            } else if (confidence === 'shaky') {
                dynamicClosing = "Look, rejections suck, but they don't mean you're not good enough. They just mean the fit wasn't right. Let's find roles where it is.";
            } else if (confidence === 'strong') {
                dynamicClosing = "Got questions about a role or how to position yourself? Just ask. I'm here to help you stay sharp.";
            } else {
                dynamicClosing = "Got questions about a role? Just ask. I'm here to help.";
            }

            return `Welcome back, ${firstName}!

Your profile is saved. ${dynamicContext}

Here's what you can do:
 <strong>Analyze New Role</strong>: Paste a job description, I'll score your fit
 <strong>Command Center</strong>: Track applications and interviews
 <strong>Edit Profile</strong>: Update anytime

${dynamicClosing}`;
        }

        function handleGotIt() {
            // Mark as seen
            localStorage.setItem('hasSeenWelcomeBack', 'true');

            // Close chat normally
            if (typeof closeAskHenry === 'function') {
                closeAskHenry();
            } else {
                // Fallback: manually close drawer with correct class changes
                const drawer = document.getElementById('askHenryDrawer');
                const fab = document.getElementById('askHenryFab');
                if (drawer) {
                    drawer.classList.remove('open');
                    drawer.classList.remove('expanded');
                }
                if (fab) fab.classList.remove('hidden');
            }
        }

        // ==========================================
        // FIRST ACTION PROMPT (after profile setup)
        // ==========================================

        async function showFirstActionPrompt(user, profile) {
            // Wait 500ms for page to settle
            await new Promise(resolve => setTimeout(resolve, 500));

            // Open chat normally (no genie animation)
            if (typeof openAskHenry === 'function') {
                openAskHenry();
            } else {
                const drawer = document.getElementById('askHenryDrawer');
                const fab = document.getElementById('askHenryFab');
                if (drawer) drawer.style.display = 'flex';
                if (fab) fab.classList.add('active');
            }

            // Wait for drawer to open
            await new Promise(resolve => setTimeout(resolve, 300));

            // Get first name
            const firstName = profile.resume?.contact?.full_name?.split(' ')[0] ||
                             user.user_metadata?.full_name?.split(' ')[0] ||
                             user.email?.split('@')[0] ||
                             'there';

            const message = `Alright ${firstName}, you're all set. Ready to analyze your first role?`;

            // Display message in chat
            const messagesContainer = document.getElementById('askHenryMessages');
            if (messagesContainer) {
                // Clear existing messages
                messagesContainer.innerHTML = '';

                // Add message
                const messageDiv = document.createElement('div');
                messageDiv.className = 'ask-henry-message assistant';
                messageDiv.innerHTML = message;
                messagesContainer.appendChild(messageDiv);

                // Add action buttons
                addFirstActionButtons(messagesContainer);

                // Scroll to bottom
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }
        }

        function addFirstActionButtons(container) {
            const buttonContainer = document.createElement('div');
            buttonContainer.className = 'welcome-button-container';
            buttonContainer.style.cssText = 'display: flex; gap: 12px; flex-wrap: wrap;';

            const analyzeBtn = document.createElement('button');
            analyzeBtn.textContent = 'Analyze a Role';
            analyzeBtn.className = 'btn-welcome';
            analyzeBtn.style.cssText = 'flex: 1; min-width: 140px;';
            analyzeBtn.onclick = () => {
                window.location.href = '/analyze';
            };

            const exploreBtn = document.createElement('button');
            exploreBtn.textContent = "I'll Look Around First";
            exploreBtn.className = 'btn-welcome';
            exploreBtn.style.cssText = 'flex: 1; min-width: 140px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2);';
            exploreBtn.onclick = () => {
                if (typeof closeAskHenry === 'function') {
                    closeAskHenry();
                } else {
                    // Fallback: manually close drawer with correct class changes
                    const drawer = document.getElementById('askHenryDrawer');
                    const fab = document.getElementById('askHenryFab');
                    if (drawer) {
                        drawer.classList.remove('open');
                        drawer.classList.remove('expanded');
                    }
                    if (fab) fab.classList.remove('hidden');
                }
            };

            buttonContainer.appendChild(analyzeBtn);
            buttonContainer.appendChild(exploreBtn);
            container.appendChild(buttonContainer);
        }

        // ==========================================
        // INITIALIZATION
        // ==========================================

        // Run checks after a short delay to ensure everything is loaded
        setTimeout(async () => {
            await checkFirstTimeUser();
            // Only check returning user if first-time didn't trigger
            if (!document.getElementById('genieOverlay')) {
                await checkReturningUser();
            }
        }, 500);

    })();
    </script>
<script src="components/mobile-nav.js"></script>
</body>
</html>

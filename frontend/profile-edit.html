<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edit Profile | HenryHQ</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Instrument+Serif:ital@0;1&family=DM+Sans:opsz,wght@9..40,400;9..40,500;9..40,600&display=swap" rel="stylesheet">
    <style>
        :root {
            --color-bg: #0a0a0b;
            --color-surface: #141416;
            --color-surface-elevated: #1c1c1f;
            --color-border: rgba(255, 255, 255, 0.08);
            --color-border-hover: rgba(255, 255, 255, 0.15);
            --color-text: #fafafa;
            --color-text-secondary: #a1a1aa;
            --color-accent: #22d3ee;
            --color-accent-muted: rgba(34, 211, 238, 0.15);
            --color-success: #4ade80;
            --color-warning: #fbbf24;
            --color-error: #f87171;
            --font-display: 'Instrument Serif', Georgia, serif;
            --font-body: 'DM Sans', -apple-system, sans-serif;
            --ease-out: cubic-bezier(0.16, 1, 0.3, 1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-body);
            background: var(--color-bg);
            color: var(--color-text);
            min-height: 100vh;
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
            padding: 40px 20px;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
        }

        .back-link {
            color: var(--color-text-secondary);
            text-decoration: none;
            font-size: 0.9rem;
            display: inline-block;
            margin-bottom: 24px;
        }

        .back-link:hover {
            color: var(--color-accent);
        }

        h1 {
            font-family: var(--font-display);
            font-size: 2rem;
            font-weight: 400;
            margin-bottom: 8px;
        }

        .subtitle {
            color: var(--color-text-secondary);
            font-size: 1rem;
            margin-bottom: 32px;
        }

        .form-section {
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 24px;
        }

        .section-title {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .section-title .icon {
            font-size: 1.2rem;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group:last-child {
            margin-bottom: 0;
        }

        label {
            display: block;
            font-size: 0.9rem;
            font-weight: 500;
            margin-bottom: 8px;
            color: var(--color-text);
        }

        .label-hint {
            font-weight: 400;
            color: var(--color-text-secondary);
            font-size: 0.85rem;
        }

        input[type="text"],
        input[type="email"],
        input[type="number"],
        select,
        textarea {
            width: 100%;
            padding: 12px 16px;
            background: var(--color-bg);
            border: 1px solid var(--color-border);
            border-radius: 8px;
            color: var(--color-text);
            font-family: var(--font-body);
            font-size: 1rem;
            transition: border-color 0.2s;
        }

        input:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: var(--color-accent);
        }

        select {
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23a1a1aa' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 16px center;
            padding-right: 40px;
        }

        .comp-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 12px;
        }

        .comp-grid label {
            font-size: 0.8rem;
            color: var(--color-text-secondary);
        }

        .comp-grid input {
            text-align: center;
        }

        /* Multi-Resume List Styles */
        .resume-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 16px;
        }

        .resume-card {
            background: var(--color-bg);
            border: 1px solid var(--color-border);
            border-radius: 8px;
            padding: 16px;
            position: relative;
            transition: border-color 0.2s;
        }

        .resume-card:hover {
            border-color: var(--color-accent);
        }

        .resume-card.is-default {
            border-color: var(--color-success);
            border-width: 2px;
        }

        .resume-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
        }

        .resume-card-name {
            font-weight: 600;
            color: var(--color-text);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .resume-card-name .default-badge {
            background: var(--color-success);
            color: #000;
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 500;
        }

        .resume-card-preview {
            font-size: 0.85rem;
            color: var(--color-text-secondary);
            margin-bottom: 8px;
        }

        .resume-card-skills {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-bottom: 12px;
        }

        .resume-card-skills .skill-tag {
            font-size: 0.75rem;
            padding: 4px 8px;
            background: var(--color-surface-elevated);
            border: 1px solid var(--color-border);
            border-radius: 4px;
            color: var(--color-text-secondary);
        }

        .resume-card-skills .skill-tag.more {
            background: transparent;
            border-style: dashed;
            color: var(--color-accent);
        }

        .resume-card-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .resume-card-actions button {
            font-size: 0.8rem;
            padding: 4px 10px;
        }

        .resume-count {
            font-size: 0.85rem;
            color: var(--color-text-secondary);
            margin-bottom: 12px;
        }

        .add-resume-btn {
            width: 100%;
            padding: 12px;
            border: 2px dashed var(--color-border);
            border-radius: 8px;
            background: transparent;
            color: var(--color-text-secondary);
            cursor: pointer;
            transition: border-color 0.2s, color 0.2s;
        }

        .add-resume-btn:hover {
            border-color: var(--color-accent);
            color: var(--color-accent);
        }

        .add-resume-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Resume Upload Modal */
        .resume-upload-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .resume-upload-modal.show {
            display: flex;
        }

        .resume-upload-content {
            background: var(--color-bg-elevated);
            border-radius: 12px;
            padding: 24px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .resume-upload-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .resume-upload-header h3 {
            margin: 0;
            font-size: 1.2rem;
        }

        .resume-upload-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--color-text-secondary);
        }

        .resume-name-input {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--color-border);
            border-radius: 8px;
            background: var(--color-bg);
            color: var(--color-text);
            font-size: 1rem;
            margin-bottom: 16px;
        }

        .accuracy-checkbox {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            margin: 16px 0;
            padding: 12px;
            background: var(--color-bg);
            border-radius: 8px;
            border: 1px solid var(--color-border);
        }

        .accuracy-checkbox input[type="checkbox"] {
            width: 20px;
            height: 20px;
            margin-top: 2px;
            flex-shrink: 0;
        }

        .accuracy-checkbox label {
            font-size: 0.9rem;
            color: var(--color-text);
            cursor: pointer;
        }

        .accuracy-checkbox label small {
            display: block;
            color: var(--color-text-secondary);
            margin-top: 4px;
        }

        /* Legacy single resume styles (kept for backwards compat) */
        .resume-info {
            background: var(--color-bg);
            border: 1px solid var(--color-border);
            border-radius: 8px;
            padding: 16px;
        }

        .resume-info-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .resume-info-name {
            font-weight: 600;
            color: var(--color-success);
        }

        .resume-info-meta {
            font-size: 0.85rem;
            color: var(--color-text-secondary);
        }

        .resume-chat-link {
            display: inline-block;
            margin-top: 12px;
            color: var(--color-accent);
            text-decoration: none;
            font-size: 0.9rem;
        }

        .resume-chat-link:hover {
            text-decoration: underline;
        }

        .file-upload {
            position: relative;
            border: 2px dashed var(--color-border);
            border-radius: 12px;
            padding: 24px;
            text-align: center;
            cursor: pointer;
            transition: border-color 0.2s, background 0.2s;
        }

        .file-upload:hover {
            border-color: var(--color-accent);
            background: var(--color-accent-muted);
        }

        .file-upload input {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
        }

        .file-upload-text {
            color: var(--color-text-secondary);
            font-size: 0.9rem;
        }

        .parsing-status {
            margin-top: 12px;
            font-size: 0.85rem;
            color: var(--color-text-secondary);
            display: none;
        }

        .parsing-status.show {
            display: block;
        }

        .parsing-status.success {
            color: var(--color-success);
        }

        .parsing-status.warning {
            color: var(--color-warning);
            background: rgba(251, 191, 36, 0.1);
            border: 1px solid rgba(251, 191, 36, 0.3);
            padding: 10px 12px;
            border-radius: 8px;
            line-height: 1.5;
        }

        .parsing-status.error {
            color: var(--color-error);
        }

        .location-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 8px;
        }

        .location-tag {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: var(--color-accent-muted);
            border: 1px solid rgba(34, 211, 238, 0.3);
            border-radius: 20px;
            font-size: 0.85rem;
            color: var(--color-accent);
        }

        .location-tag button {
            background: none;
            border: none;
            color: var(--color-accent);
            cursor: pointer;
            font-size: 1rem;
            line-height: 1;
            padding: 0;
        }

        /* Section hint text */
        .section-hint {
            color: var(--color-text-secondary);
            font-size: 0.9rem;
            margin-bottom: 16px;
            margin-top: -8px;
        }

        /* Form row for side-by-side fields */
        .form-row {
            display: flex;
            gap: 16px;
        }

        .form-group-half {
            flex: 1;
        }

        /* Field hint text (below inputs) */
        .field-hint {
            display: block;
            font-size: 0.8rem;
            color: var(--color-text-secondary);
            margin-top: 6px;
        }

        /* Inline checkbox style */
        .checkbox-inline {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            font-weight: 500;
        }

        .checkbox-inline input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .checkbox-inline span {
            font-size: 0.95rem;
        }

        /* Disabled input styling */
        input:disabled {
            background: var(--color-surface-elevated);
            color: var(--color-text-secondary);
            cursor: not-allowed;
        }

        @media (max-width: 640px) {
            .form-row {
                flex-direction: column;
                gap: 0;
            }
        }

        /* Henry Response Bubbles */
        .henry-response {
            display: none;
            margin-top: 12px;
            padding: 14px 16px;
            background: var(--color-accent-muted);
            border-left: 3px solid var(--color-accent);
            border-radius: 0 8px 8px 0;
            font-size: 0.9rem;
            color: var(--color-text);
            line-height: 1.5;
        }

        .henry-response.show {
            display: block;
        }

        .henry-response::before {
            content: 'üí¨ ';
        }

        /* File Upload - New Profile Style */
        .file-upload {
            border: 2px dashed var(--color-border);
            border-radius: 12px;
            padding: 40px 32px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .file-upload:hover {
            border-color: var(--color-accent);
            background: var(--color-accent-muted);
        }

        .file-upload.has-file {
            border-color: var(--color-success);
            background: rgba(74, 222, 128, 0.1);
        }

        .file-upload.hidden {
            display: none;
        }

        .file-upload input[type="file"] {
            display: none;
        }

        .upload-icon {
            font-size: 2.5rem;
            margin-bottom: 12px;
        }

        .upload-text {
            color: var(--color-text-secondary);
            font-size: 0.95rem;
        }

        .upload-text span {
            color: var(--color-accent);
            text-decoration: underline;
        }

        .file-name {
            display: none;
            margin-top: 12px;
            color: var(--color-success);
            font-size: 0.9rem;
        }

        .file-name.show {
            display: block;
        }

        /* Radio Options */
        .radio-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .radio-option {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 16px;
            background: var(--color-bg);
            border: 1px solid var(--color-border);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .radio-option:hover {
            border-color: var(--color-border-hover);
        }

        .radio-option.selected {
            border-color: var(--color-accent);
            background: var(--color-accent-muted);
        }

        .radio-option input {
            display: none;
        }

        .radio-circle {
            width: 20px;
            height: 20px;
            border: 2px solid var(--color-border);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            flex-shrink: 0;
        }

        .radio-option.selected .radio-circle {
            border-color: var(--color-accent);
        }

        .radio-circle::after {
            content: '';
            width: 10px;
            height: 10px;
            background: var(--color-accent);
            border-radius: 50%;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .radio-option.selected .radio-circle::after {
            opacity: 1;
        }

        .radio-label {
            font-size: 0.95rem;
            color: var(--color-text);
        }

        /* Checkbox Options */
        .checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .checkbox-option {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 16px;
            background: var(--color-bg);
            border: 1px solid var(--color-border);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .checkbox-option:hover {
            border-color: var(--color-border-hover);
        }

        .checkbox-option.selected {
            border-color: var(--color-accent);
            background: var(--color-accent-muted);
        }

        .checkbox-option input {
            display: none;
        }

        .checkbox-box {
            width: 18px;
            height: 18px;
            border: 2px solid var(--color-border);
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            flex-shrink: 0;
        }

        .checkbox-option.selected .checkbox-box {
            border-color: var(--color-accent);
            background: var(--color-accent);
        }

        .checkbox-box::after {
            content: '‚úì';
            font-size: 12px;
            color: var(--color-bg);
            opacity: 0;
        }

        .checkbox-option.selected .checkbox-box::after {
            opacity: 1;
        }

        .add-location {
            display: flex;
            gap: 8px;
        }

        .add-location input {
            flex: 1;
        }

        .add-location button {
            padding: 12px 20px;
            background: var(--color-surface-elevated);
            border: 1px solid var(--color-border);
            border-radius: 8px;
            color: var(--color-text);
            cursor: pointer;
            font-size: 0.9rem;
            white-space: nowrap;
        }

        .button-group {
            display: flex;
            gap: 12px;
        }

        .btn-primary {
            flex: 1;
            padding: 16px 24px;
            background: var(--color-accent);
            border: none;
            border-radius: 12px;
            color: #000;
            font-family: var(--font-body);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s var(--ease-out), box-shadow 0.2s var(--ease-out);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(34, 211, 238, 0.3);
        }

        .btn-secondary {
            padding: 12px 20px;
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: 8px;
            color: var(--color-text);
            font-size: 0.95rem;
            cursor: pointer;
            transition: background 0.2s, border-color 0.2s;
        }

        .btn-secondary:hover {
            background: var(--color-surface-hover);
            border-color: var(--color-primary);
        }

        .btn-danger {
            padding: 16px 24px;
            background: transparent;
            border: 1px solid var(--color-error);
            border-radius: 12px;
            color: var(--color-error);
            font-family: var(--font-body);
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.2s;
        }

        .btn-danger:hover {
            background: rgba(248, 113, 113, 0.1);
        }

        .btn-danger-outline {
            padding: 12px 20px;
            background: transparent;
            border: 1px solid var(--color-warning);
            border-radius: 12px;
            color: var(--color-warning);
            font-family: var(--font-body);
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.2s;
        }

        .btn-danger-outline:hover {
            background: rgba(251, 191, 36, 0.1);
        }

        .error-message,
        .success-message {
            border-radius: 8px;
            padding: 12px 16px;
            font-size: 0.9rem;
            margin-bottom: 20px;
            display: none;
        }

        .error-message {
            background: rgba(248, 113, 113, 0.1);
            border: 1px solid rgba(248, 113, 113, 0.3);
            color: var(--color-error);
        }

        .success-message {
            background: rgba(74, 222, 128, 0.1);
            border: 1px solid rgba(74, 222, 128, 0.3);
            color: var(--color-success);
        }

        .error-message.show,
        .success-message.show {
            display: block;
        }

        /* Delete Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.85);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
        }

        .modal-overlay.show {
            display: flex;
        }

        .modal {
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: 16px;
            padding: 32px;
            max-width: 440px;
            width: 100%;
        }

        .modal h2 {
            font-family: var(--font-display);
            font-size: 1.5rem;
            font-weight: 400;
            margin-bottom: 12px;
        }

        .modal p {
            color: var(--color-text-secondary);
            font-size: 0.95rem;
            line-height: 1.6;
            margin-bottom: 24px;
        }

        .modal-actions {
            display: flex;
            gap: 12px;
        }

        .modal-btn {
            flex: 1;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 0.95rem;
            font-weight: 500;
            cursor: pointer;
            border: none;
        }

        .modal-btn.secondary {
            background: var(--color-surface-elevated);
            color: var(--color-text);
            border: 1px solid var(--color-border);
        }

        .modal-btn.danger {
            background: var(--color-error);
            color: white;
        }

        .modal-btn.warning {
            background: var(--color-warning);
            color: #000;
        }

        @media (max-width: 640px) {
            .comp-grid {
                grid-template-columns: 1fr;
            }

            .button-group {
                flex-direction: column;
            }
        }

        /* HEADER */
        header {
            padding: 24px 0;
            border-bottom: 1px solid var(--color-border);
            margin-bottom: 32px;
        }

        header .header-container {
            max-width: 640px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .logo {
            font-family: var(--font-display);
            font-size: 1.5rem;
            color: var(--color-text);
            text-decoration: none;
        }

        .logo em {
            font-style: italic;
            color: var(--color-accent);
        }

        .header-nav {
            display: flex;
            gap: 24px;
            align-items: center;
        }

        .nav-link {
            color: var(--color-text-secondary);
            text-decoration: none;
            font-size: 0.9rem;
            transition: color 0.2s ease;
        }

        .nav-link:hover {
            color: var(--color-accent);
        }
    </style>
    <link rel="stylesheet" href="css/mobile.css">
    <!-- Beta Access Gate -->
    <script>
        if (localStorage.getItem('beta_verified') !== 'true') {
            window.location.href = 'beta-access.html';
        }
    </script>
</head>
<body>
    <!-- HEADER -->
    <header>
        <div class="header-container">
            <a href="index.html" class="logo"><em>Henry</em>HQ</a>
        </div>
    </header>

    <div class="container">
        <a href="analyze.html" class="back-link" id="backLink" style="display: none;">‚Üê Back</a>

        <h1 id="pageTitle">Set Up Your Profile</h1>
        <p class="subtitle" id="pageSubtitle">I need a few details to give you honest fit assessments and strategic positioning.</p>

        <div class="error-message" id="errorMessage"></div>
        <div class="success-message" id="successMessage"></div>

        <!-- SECTION 1: ABOUT YOU (Expanded) -->
        <div class="form-section">
            <div class="section-title">
                <span class="icon">üë§</span>
                About You
            </div>
            <div class="form-row">
                <div class="form-group form-group-half">
                    <label>First Name *</label>
                    <input type="text" id="firstName" placeholder="Jane" disabled>
                </div>
                <div class="form-group form-group-half">
                    <label>Last Name *</label>
                    <input type="text" id="lastName" placeholder="Smith" disabled>
                </div>
            </div>
            <span class="field-hint" style="margin-top: -12px; margin-bottom: 16px; display: block;">Need to update your name? Contact <a href="mailto:support@henryhq.com" style="color: var(--color-accent);">support@henryhq.com</a></span>
            <div class="form-row">
                <div class="form-group" style="flex: 0 0 100px;">
                    <label>Middle Initial <span style="color: #888; font-weight: 400;">(opt)</span></label>
                    <input type="text" id="middleInitial" placeholder="R" maxlength="2" style="text-transform: uppercase;">
                </div>
                <div class="form-group" style="flex: 0 0 120px;">
                    <label>Suffix <span style="color: #888; font-weight: 400;">(opt)</span></label>
                    <select id="nameSuffix">
                        <option value="">None</option>
                        <option value="Jr.">Jr.</option>
                        <option value="Sr.">Sr.</option>
                        <option value="II">II</option>
                        <option value="III">III</option>
                        <option value="IV">IV</option>
                        <option value="V">V</option>
                        <option value="Esq.">Esq.</option>
                        <option value="PhD">PhD</option>
                        <option value="MD">MD</option>
                    </select>
                </div>
                <div class="form-group" style="flex: 1;">
                    <label>Nickname <span style="color: #888; font-weight: 400;">(opt)</span></label>
                    <input type="text" id="nickname" placeholder="e.g., Mike, Liz, AJ">
                </div>
            </div>
            <div class="form-group">
                <label>Email</label>
                <input type="email" id="userEmail" disabled placeholder="Loading...">
            </div>
            <div class="form-group">
                <label>Pronouns <span style="color: #888; font-weight: 400;">(optional)</span></label>
                <input type="text" id="pronouns" placeholder="e.g., she/her, he/him, they/them">
            </div>
            <div class="form-group">
                <label>Function Area *</label>
                <select id="functionArea">
                    <option value="">Select your function...</option>
                    <option value="product_management">Product Management</option>
                    <option value="engineering">Engineering</option>
                    <option value="design">Design</option>
                    <option value="data_analytics">Data / Analytics</option>
                    <option value="sales">Sales</option>
                    <option value="marketing">Marketing</option>
                    <option value="customer_success">Customer Success</option>
                    <option value="operations">Operations</option>
                    <option value="finance">Finance</option>
                    <option value="hr_people">HR / People</option>
                    <option value="legal">Legal</option>
                    <option value="other">Other</option>
                </select>
                <span class="field-hint" id="functionAreaHint" style="display: none;"></span>
            </div>
            <div class="form-group">
                <label>Current Industry *</label>
                <select id="currentIndustry">
                    <option value="">Select your industry...</option>
                    <option value="technology">Technology / Software</option>
                    <option value="healthcare">Healthcare & Life Sciences</option>
                    <option value="fintech">Financial Services / Fintech</option>
                    <option value="ecommerce">E-commerce / Retail</option>
                    <option value="media">Media & Entertainment</option>
                    <option value="manufacturing">Manufacturing</option>
                    <option value="energy">Energy / Cleantech</option>
                    <option value="real_estate">Real Estate / PropTech</option>
                    <option value="education">Education / EdTech</option>
                    <option value="government">Government / Public Sector</option>
                    <option value="consulting">Consulting / Professional Services</option>
                    <option value="telecom">Telecommunications</option>
                    <option value="transportation">Transportation / Logistics</option>
                    <option value="hospitality">Hospitality / Travel</option>
                    <option value="nonprofit">Nonprofit</option>
                    <option value="other">Other</option>
                </select>
                <span class="field-hint" id="industryHint" style="display: none;"></span>
            </div>
            <div class="form-group">
                <label class="checkbox-inline">
                    <input type="checkbox" id="multiIndustry">
                    <span>I work across multiple industries</span>
                </label>
            </div>
            <div class="form-group" id="secondaryIndustryGroup" style="display: none;">
                <label>Secondary Industry</label>
                <select id="secondaryIndustry">
                    <option value="">Select secondary industry...</option>
                    <option value="technology">Technology / Software</option>
                    <option value="healthcare">Healthcare & Life Sciences</option>
                    <option value="fintech">Financial Services / Fintech</option>
                    <option value="ecommerce">E-commerce / Retail</option>
                    <option value="media">Media & Entertainment</option>
                    <option value="manufacturing">Manufacturing</option>
                    <option value="energy">Energy / Cleantech</option>
                    <option value="real_estate">Real Estate / PropTech</option>
                    <option value="education">Education / EdTech</option>
                    <option value="government">Government / Public Sector</option>
                    <option value="consulting">Consulting / Professional Services</option>
                    <option value="telecom">Telecommunications</option>
                    <option value="transportation">Transportation / Logistics</option>
                    <option value="hospitality">Hospitality / Travel</option>
                    <option value="nonprofit">Nonprofit</option>
                    <option value="other">Other</option>
                </select>
            </div>
            <div class="form-group">
                <label>Work Authorization *</label>
                <select id="workAuthorization">
                    <option value="">Select your work authorization...</option>
                    <option value="us_citizen">US Citizen</option>
                    <option value="green_card">Green Card / Permanent Resident</option>
                    <option value="h1b">H1B Visa</option>
                    <option value="h1b_transfer">H1B Transfer (currently employed)</option>
                    <option value="l1">L1 Visa</option>
                    <option value="opt">OPT (with EAD)</option>
                    <option value="opt_stem">OPT STEM Extension</option>
                    <option value="tn">TN Visa (Canadian/Mexican)</option>
                    <option value="other_visa">Other Visa</option>
                </select>
            </div>
            <div class="form-group" id="sponsorshipGroup" style="display: none;">
                <label>Do you require employer sponsorship?</label>
                <div class="radio-group" id="sponsorshipRequired">
                    <label class="radio-option" data-value="yes">
                        <input type="radio" name="sponsorship" value="yes">
                        <span class="radio-circle"></span>
                        <span class="radio-label">Yes, I require sponsorship</span>
                    </label>
                    <label class="radio-option" data-value="no">
                        <input type="radio" name="sponsorship" value="no">
                        <span class="radio-circle"></span>
                        <span class="radio-label">No, I do NOT require sponsorship</span>
                    </label>
                </div>
                <span class="field-hint">This helps filter out roles that won't work for you</span>
            </div>
            <div class="form-group">
                <label class="checkbox-inline">
                    <input type="checkbox" id="isVeteran">
                    <span>I am a U.S. military veteran</span>
                </label>
                <span class="field-hint">Some employers actively seek to hire veterans</span>
            </div>
        </div>

        <!-- SECTION 2: RESUMES (Multi-Resume Support) -->
        <div class="form-section">
            <div class="section-title">
                <span class="icon">üìÑ</span>
                Your Resumes
            </div>
            <p class="section-hint">Upload different versions for different roles. Select which one to use when analyzing a job.</p>

            <div class="form-group">
                <!-- Resume List Container -->
                <div id="resumeListContainer">
                    <div class="resume-count" id="resumeCount">Loading...</div>
                    <div class="resume-list" id="resumeList">
                        <!-- Resume cards populated dynamically -->
                    </div>
                    <button type="button" class="add-resume-btn" id="addResumeBtn">
                        + Add Resume
                    </button>
                </div>

                <!-- Legacy single resume display (hidden, for migration) -->
                <div class="resume-info" id="resumeInfo" style="display: none;">
                    <div class="resume-info-header">
                        <span class="resume-info-name" id="resumeName">Loading...</span>
                    </div>
                    <div class="resume-info-meta" id="resumeMeta"></div>
                    <a href="resume-discuss.html" class="resume-chat-link">üí¨ Chat with Henry about your resume</a>
                    <div class="resume-actions" style="margin-top: 12px; display: flex; gap: 10px;">
                        <button type="button" class="btn-secondary" id="replaceResumeBtn">Replace Resume</button>
                        <button type="button" class="btn-danger-outline" id="deleteResumeBtn">Delete</button>
                    </div>
                </div>

                <!-- Legacy file upload (hidden, replaced by modal) -->
                <label class="file-upload" id="fileUpload" style="display: none;">
                    <input type="file" id="resumeFile" accept=".pdf,.docx,.doc,.txt">
                    <div class="upload-icon">üìé</div>
                    <div class="upload-text">Drop your resume here or <span>browse</span></div>
                    <div class="file-name" id="fileName"></div>
                </label>
                <div class="parsing-status" id="parsingStatus"></div>
            </div>
        </div>

        <!-- Resume Upload Modal -->
        <div class="resume-upload-modal" id="resumeUploadModal">
            <div class="resume-upload-content">
                <div class="resume-upload-header">
                    <h3>Add Resume</h3>
                    <button class="resume-upload-close" id="closeResumeModal">&times;</button>
                </div>

                <div class="form-group">
                    <label>Name this resume</label>
                    <input type="text" class="resume-name-input" id="newResumeName" placeholder="e.g., Growth PM Resume, Enterprise Focus">
                </div>

                <label class="file-upload" id="modalFileUpload">
                    <input type="file" id="modalResumeFile" accept=".pdf,.docx,.doc,.txt">
                    <div class="upload-icon">üìé</div>
                    <div class="upload-text">Drop your resume here or <span>browse</span></div>
                    <div class="file-name" id="modalFileName"></div>
                </label>

                <div class="parsing-status" id="modalParsingStatus"></div>

                <div class="accuracy-checkbox">
                    <input type="checkbox" id="accuracyConfirm">
                    <label for="accuracyConfirm">
                        I confirm this resume accurately reflects my real work experience.
                        <small>HenryHQ tailors content based on what you provide - accuracy matters.</small>
                    </label>
                </div>

                <button type="button" class="btn-primary" id="saveResumeBtn" disabled style="width: 100%; margin-top: 12px;">
                    Save Resume
                </button>
            </div>
        </div>

        <!-- SECTION 3: LINKEDIN PROFILE -->
        <div class="form-section linkedin-profile-section">
            <div class="section-title">
                <span class="icon">üíº</span>
                LinkedIn Profile
            </div>
            <p class="section-hint" style="color: #888; font-size: 0.9rem; margin: 8px 0 16px 0; line-height: 1.5;">Optional, but recommended. I'll check for alignment gaps between your resume and LinkedIn, then help you optimize your profile.</p>
            <div id="linkedin-profile-status">
                <!-- Populated dynamically by linkedin-upload.js -->
            </div>
        </div>

        <!-- SECTION 4: LOCATION & WORK ARRANGEMENT -->
        <div class="form-section">
            <div class="section-title">
                <span class="icon">üìç</span>
                Location & Work Style
            </div>
            <div class="form-row">
                <div class="form-group form-group-half">
                    <label>City</label>
                    <input type="text" id="city" placeholder="e.g., San Francisco">
                </div>
                <div class="form-group form-group-half">
                    <label>State / Province</label>
                    <input type="text" id="state" placeholder="e.g., California">
                </div>
            </div>
            <div class="form-group">
                <label>Country</label>
                <select id="country">
                    <option value="">Select country...</option>
                    <option value="US">United States</option>
                    <option value="CA">Canada</option>
                    <option value="UK">United Kingdom</option>
                    <option value="DE">Germany</option>
                    <option value="FR">France</option>
                    <option value="AU">Australia</option>
                    <option value="IN">India</option>
                    <option value="SG">Singapore</option>
                    <option value="other">Other</option>
                </select>
            </div>
            <!-- Hidden field for backward compatibility -->
            <input type="hidden" id="currentLocation">

            <div class="form-group" style="margin-top: 20px;">
                <label>Work Arrangement</label>
                <p class="section-hint" style="margin-top: 4px;">What setups work for you? Select all that apply.</p>
                <div class="checkbox-group" id="workArrangementGroup">
                    <div class="checkbox-option" data-value="remote">
                        <span class="checkbox-box"></span>
                        <span>Remote</span>
                    </div>
                    <div class="checkbox-option" data-value="hybrid">
                        <span class="checkbox-box"></span>
                        <span>Hybrid</span>
                    </div>
                    <div class="checkbox-option" data-value="onsite">
                        <span class="checkbox-box"></span>
                        <span>On-site</span>
                    </div>
                </div>
            </div>
            <div class="form-group">
                <label>Open to relocating?</label>
                <div class="radio-group" id="relocateGroup">
                    <label class="radio-option" data-value="yes">
                        <input type="radio" name="relocate" value="yes">
                        <span class="radio-circle"></span>
                        <span class="radio-label">Yes</span>
                    </label>
                    <label class="radio-option" data-value="maybe">
                        <input type="radio" name="relocate" value="maybe">
                        <span class="radio-circle"></span>
                        <span class="radio-label">Maybe, for the right role</span>
                    </label>
                    <label class="radio-option" data-value="no">
                        <input type="radio" name="relocate" value="no">
                        <span class="radio-circle"></span>
                        <span class="radio-label">No</span>
                    </label>
                </div>
            </div>
            <div class="form-group" id="relocateLocationsGroup" style="display: none;">
                <label>Where would you consider?</label>
                <div class="add-location">
                    <input type="text" id="relocateLocationInput" placeholder="e.g., Austin, Seattle, Denver">
                    <button type="button" id="addRelocateLocationBtn">Add</button>
                </div>
                <div class="location-tags" id="relocateLocationTags"></div>
            </div>
        </div>

        <!-- SECTION 5: WHAT YOU'RE LOOKING FOR -->
        <div class="form-section">
            <div class="section-title">
                <span class="icon">üéØ</span>
                What You're Looking For
            </div>
            <div class="form-group">
                <label>Target Industry (Primary)</label>
                <select id="targetIndustryPrimary">
                    <option value="">Same as current / Open to all</option>
                    <option value="technology">Technology / Software</option>
                    <option value="healthcare">Healthcare & Life Sciences</option>
                    <option value="fintech">Financial Services / Fintech</option>
                    <option value="ecommerce">E-commerce / Retail</option>
                    <option value="media">Media & Entertainment</option>
                    <option value="manufacturing">Manufacturing</option>
                    <option value="energy">Energy / Cleantech</option>
                    <option value="real_estate">Real Estate / PropTech</option>
                    <option value="education">Education / EdTech</option>
                    <option value="government">Government / Public Sector</option>
                    <option value="consulting">Consulting / Professional Services</option>
                    <option value="telecom">Telecommunications</option>
                    <option value="transportation">Transportation / Logistics</option>
                    <option value="hospitality">Hospitality / Travel</option>
                    <option value="nonprofit">Nonprofit</option>
                    <option value="other">Other</option>
                </select>
                <span class="field-hint">Leave blank if you want to stay in your current industry or are open to any</span>
            </div>
            <div class="form-group">
                <label>Target Industry (Secondary) <span style="color: #888; font-weight: 400;">(optional)</span></label>
                <select id="targetIndustrySecondary">
                    <option value="">None</option>
                    <option value="technology">Technology / Software</option>
                    <option value="healthcare">Healthcare & Life Sciences</option>
                    <option value="fintech">Financial Services / Fintech</option>
                    <option value="ecommerce">E-commerce / Retail</option>
                    <option value="media">Media & Entertainment</option>
                    <option value="manufacturing">Manufacturing</option>
                    <option value="energy">Energy / Cleantech</option>
                    <option value="real_estate">Real Estate / PropTech</option>
                    <option value="education">Education / EdTech</option>
                    <option value="government">Government / Public Sector</option>
                    <option value="consulting">Consulting / Professional Services</option>
                    <option value="telecom">Telecommunications</option>
                    <option value="transportation">Transportation / Logistics</option>
                    <option value="hospitality">Hospitality / Travel</option>
                    <option value="nonprofit">Nonprofit</option>
                    <option value="other">Other</option>
                </select>
            </div>
            <div class="form-group" style="margin-top: 20px;">
                <label>Compensation Expectations <span class="label-hint">(annual base salary, USD)</span></label>
                <div class="comp-grid">
                    <div>
                        <label>Minimum</label>
                        <input type="text" id="compMin" placeholder="$120,000" inputmode="numeric">
                    </div>
                    <div>
                        <label>Target</label>
                        <input type="text" id="compTarget" placeholder="$150,000" inputmode="numeric">
                    </div>
                    <div>
                        <label>Stretch</label>
                        <input type="text" id="compStretch" placeholder="$180,000" inputmode="numeric">
                    </div>
                </div>
            </div>
        </div>

        <!-- SECTION 6: WHERE YOU'RE AT -->
        <div class="form-section">
            <div class="section-title">
                <span class="icon">üí≠</span>
                Where you're at
            </div>
            <p class="section-hint">Job searching is hard. Be honest so I can calibrate my advice to your actual situation.</p>
            
            <div class="form-group">
                <label>How are you holding up?</label>
                <select id="holdingUp">
                    <option value="">Select one...</option>
                    <option value="doing_well">I'm good, exploring opportunistically</option>
                    <option value="stressed_but_managing">Stressed but managing</option>
                    <option value="struggling">Struggling, honestly</option>
                    <option value="rather_not_say">I'd rather not say</option>
                </select>
                <div class="henry-response" id="holdingUpResponse"></div>
            </div>

            <div class="form-group">
                <label>What's your timeline?</label>
                <select id="timeline">
                    <option value="">Select one...</option>
                    <option value="no_rush">No rush, waiting for the right thing</option>
                    <option value="actively_looking">Actively looking (1-3 months)</option>
                    <option value="soon">Need something soon (under a month)</option>
                    <option value="urgent">Urgent, financial pressure</option>
                </select>
                <div class="henry-response" id="timelineResponse"></div>
            </div>

            <div class="form-group">
                <label>How's your confidence right now?</label>
                <select id="confidence">
                    <option value="">Select one...</option>
                    <option value="strong">Feeling strong, I know what I bring</option>
                    <option value="shaky">A bit shaky after some rejections</option>
                    <option value="low">Pretty low, hard to stay motivated</option>
                    <option value="need_validation">I just need reassurance that I'm on the right track</option>
                </select>
                <div class="henry-response" id="confidenceResponse"></div>
            </div>
        </div>

        <div class="button-group">
            <button class="btn-primary" id="saveBtn">Save and Start My Job Search</button>
        </div>

    </div>

    <!-- Account Options - fixed bottom left, only shown in edit mode -->
    <div id="dangerZone" style="display: none; position: fixed; bottom: 24px; left: 24px; opacity: 0.5;">
        <div style="display: flex; flex-direction: column; gap: 4px; align-items: flex-start;">
            <button id="resetProfileBtn" style="background: transparent; border: none; color: var(--color-text-muted); font-size: 0.75rem; cursor: pointer; padding: 4px 0;">Reset Profile</button>
            <button id="deleteAccountBtn" style="background: transparent; border: none; color: var(--color-text-muted); font-size: 0.75rem; cursor: pointer; padding: 4px 0;">Delete Account</button>
        </div>
    </div>

    <!-- Reset Profile Confirmation Modal -->
    <div class="modal-overlay" id="resetModal">
        <div class="modal">
            <h2>Reset your profile?</h2>
            <p>This will delete your profile data and all tracked applications. Your account will remain active and you can set up a new profile.</p>
            <div class="form-group" style="margin: 20px 0;">
                <label style="font-size: 0.9rem; color: var(--color-text-secondary);">Type <strong style="color: var(--color-warning);">RESET</strong> to confirm:</label>
                <input type="text" id="resetConfirmInput" placeholder="Type RESET" autocomplete="off" style="margin-top: 8px;">
            </div>
            <div class="modal-actions">
                <button class="modal-btn secondary" id="cancelResetBtn">Cancel</button>
                <button class="modal-btn warning" id="confirmResetBtn" disabled>Reset Profile</button>
            </div>
        </div>
    </div>

    <!-- Delete Account Confirmation Modal - Step 1 -->
    <div class="modal-overlay" id="deleteModal">
        <div class="modal">
            <h2>Delete your account?</h2>
            <p>This will <strong>permanently</strong> delete your account and all associated data. This action cannot be undone.</p>
            <p style="margin-top: 12px; color: var(--color-error); font-size: 0.9rem;">Are you absolutely sure you want to proceed?</p>
            <div class="modal-actions">
                <button class="modal-btn secondary" id="cancelDeleteBtn">Cancel</button>
                <button class="modal-btn danger" id="proceedDeleteBtn">Yes, Delete My Account</button>
            </div>
        </div>
    </div>

    <!-- Delete Account Confirmation Modal - Step 2 (Final) -->
    <div class="modal-overlay" id="deleteFinalModal">
        <div class="modal">
            <h2>Final Confirmation</h2>
            <p>This is your last chance to cancel. All your data will be permanently deleted.</p>
            <div class="form-group" style="margin: 20px 0;">
                <label style="font-size: 0.9rem; color: var(--color-text-secondary);">Type <strong style="color: var(--color-error);">DELETE MY ACCOUNT</strong> to confirm:</label>
                <input type="text" id="deleteConfirmInput" placeholder="Type DELETE MY ACCOUNT" autocomplete="off" style="margin-top: 8px;">
            </div>
            <div class="modal-actions">
                <button class="modal-btn secondary" id="cancelDeleteFinalBtn">Cancel</button>
                <button class="modal-btn danger" id="confirmDeleteBtn" disabled>Permanently Delete</button>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = window.location.hostname === 'localhost' ? 'http://localhost:8000' : 'https://henryai-app-production.up.railway.app';
        
        // State
        let profile = null;
        let relocateLocations = [];
        let workArrangements = [];

        // Elements
        const resumeInfo = document.getElementById('resumeInfo');
        const resumeName = document.getElementById('resumeName');
        const resumeMeta = document.getElementById('resumeMeta');
        const fileUpload = document.getElementById('fileUpload');
        const resumeFile = document.getElementById('resumeFile');
        const parsingStatus = document.getElementById('parsingStatus');
        const saveBtn = document.getElementById('saveBtn');
        const deleteBtn = document.getElementById('deleteBtn');
        const deleteModal = document.getElementById('deleteModal');
        const errorMessage = document.getElementById('errorMessage');
        const successMessage = document.getElementById('successMessage');
        const replaceResumeBtn = document.getElementById('replaceResumeBtn');
        const deleteResumeBtn = document.getElementById('deleteResumeBtn');

        // Multi-resume elements
        const resumeListContainer = document.getElementById('resumeListContainer');
        const resumeList = document.getElementById('resumeList');
        const resumeCount = document.getElementById('resumeCount');
        const addResumeBtn = document.getElementById('addResumeBtn');
        const resumeUploadModal = document.getElementById('resumeUploadModal');
        const closeResumeModal = document.getElementById('closeResumeModal');
        const newResumeName = document.getElementById('newResumeName');
        const modalResumeFile = document.getElementById('modalResumeFile');
        const modalFileName = document.getElementById('modalFileName');
        const modalParsingStatus = document.getElementById('modalParsingStatus');
        const accuracyConfirm = document.getElementById('accuracyConfirm');
        const saveResumeBtn = document.getElementById('saveResumeBtn');

        // Multi-resume state
        let userResumes = [];
        let pendingResumeJson = null;
        const MAX_RESUMES = 5;

        // Determine if this is new profile or edit
        let isNewProfile = false;

        // Simple toast notifications
        function showSuccess(message) {
            console.log('‚úÖ ' + message);
            // Could add a toast UI here later
        }

        function showError(message) {
            console.error('‚ùå ' + message);
            alert(message); // Simple alert for errors
        }

        // Currency formatting helpers
        function formatCurrency(value) {
            if (!value && value !== 0) return '';
            const num = typeof value === 'string' ? parseInt(value.replace(/[^0-9]/g, '')) : value;
            if (isNaN(num)) return '';
            return '$' + num.toLocaleString('en-US');
        }

        function parseCurrency(formattedValue) {
            if (!formattedValue) return null;
            const num = parseInt(formattedValue.replace(/[^0-9]/g, ''));
            return isNaN(num) ? null : num;
        }

        // Set up currency input formatting
        function setupCurrencyInput(inputId) {
            const input = document.getElementById(inputId);
            input.addEventListener('input', function(e) {
                const cursorPos = e.target.selectionStart;
                const oldValue = e.target.value;
                const oldLength = oldValue.length;

                // Get raw number
                const rawNum = oldValue.replace(/[^0-9]/g, '');
                if (!rawNum) {
                    e.target.value = '';
                    return;
                }

                // Format with $ and commas
                const formatted = formatCurrency(rawNum);
                e.target.value = formatted;

                // Adjust cursor position
                const newLength = formatted.length;
                const diff = newLength - oldLength;
                const newPos = Math.max(1, cursorPos + diff); // Keep cursor after $
                e.target.setSelectionRange(newPos, newPos);
            });

            // Format on blur if just a number was entered
            input.addEventListener('blur', function(e) {
                if (e.target.value && !e.target.value.startsWith('$')) {
                    e.target.value = formatCurrency(e.target.value);
                }
            });
        }

        // Initialize currency inputs
        setupCurrencyInput('compMin');
        setupCurrencyInput('compTarget');
        setupCurrencyInput('compStretch');

        // ==========================================
        // Multi-Resume Functions
        // ==========================================

        // Load and display user's resumes
        async function loadResumes() {
            if (typeof HenryData === 'undefined') {
                console.log('HenryData not available, skipping resume load');
                resumeCount.textContent = 'Sign in to save multiple resumes';
                return;
            }

            try {
                userResumes = await HenryData.getResumes();

                // Auto-migrate localStorage resume if Supabase has no resumes
                if (userResumes.length === 0) {
                    const migrated = await migrateLocalStorageResume();
                    if (migrated) {
                        userResumes = await HenryData.getResumes();
                    }
                }

                renderResumeList();
            } catch (error) {
                console.error('Error loading resumes:', error);
                resumeCount.textContent = 'Error loading resumes';
            }
        }

        // Auto-migrate localStorage resume to Supabase (one-time migration for existing users)
        async function migrateLocalStorageResume() {
            const stored = localStorage.getItem('userProfile');
            if (!stored) return false;

            try {
                const profile = JSON.parse(stored);
                if (!profile.resume) return false;

                // Check if we already migrated (prevent duplicate migrations)
                const migrationKey = 'henryai_resume_migrated';
                if (localStorage.getItem(migrationKey) === 'true') {
                    console.log('Resume already migrated, skipping');
                    return false;
                }

                console.log('Migrating localStorage resume to Supabase...');

                // Extract name from resume
                const resumeName = profile.resume.contact?.full_name ||
                                   profile.resume.full_name ||
                                   'My Resume';

                // Save to Supabase with accuracy_confirmed = true (they were already using it)
                const result = await HenryData.saveResume(
                    `${resumeName} (Migrated)`,
                    profile.resume,
                    true,  // is_default
                    true   // accuracy_confirmed - they've been using this resume
                );

                if (result) {
                    console.log('Successfully migrated localStorage resume to Supabase');
                    localStorage.setItem(migrationKey, 'true');
                    return true;
                }
            } catch (error) {
                console.error('Error migrating localStorage resume:', error);
            }

            return false;
        }

        // Render the resume list
        function renderResumeList() {
            resumeList.innerHTML = '';

            if (userResumes.length === 0) {
                resumeCount.textContent = 'No resumes uploaded yet';
                addResumeBtn.textContent = '+ Add Your First Resume';
            } else {
                resumeCount.textContent = `${userResumes.length} of ${MAX_RESUMES} resumes`;
                addResumeBtn.textContent = '+ Add Another Resume';
            }

            // Disable add button if at limit
            addResumeBtn.disabled = userResumes.length >= MAX_RESUMES;
            if (userResumes.length >= MAX_RESUMES) {
                addResumeBtn.textContent = `Maximum ${MAX_RESUMES} resumes reached`;
            }

            userResumes.forEach(resume => {
                const card = createResumeCard(resume);
                resumeList.appendChild(card);
            });
        }

        // Create a resume card element
        function createResumeCard(resume) {
            const card = document.createElement('div');
            card.className = 'resume-card' + (resume.is_default ? ' is-default' : '');
            card.dataset.resumeId = resume.id;

            // Extract preview info from resume_json
            const json = resume.resume_json || {};
            const name = json.contact?.full_name || json.full_name || 'Unknown';
            const expCount = json.experience?.length || 0;
            const skills = json.skills || [];
            const skillCount = skills.length;
            const currentTitle = json.current_title || json.experience?.[0]?.title || '';

            // Format skills display (show first 5, then "+X more")
            let skillsHtml = '';
            if (skills.length > 0) {
                const displaySkills = skills.slice(0, 5);
                const moreCount = skills.length - 5;
                skillsHtml = `
                    <div class="resume-card-skills">
                        ${displaySkills.map(s => `<span class="skill-tag">${s}</span>`).join('')}
                        ${moreCount > 0 ? `<span class="skill-tag more">+${moreCount} more</span>` : ''}
                    </div>
                `;
            }

            card.innerHTML = `
                <div class="resume-card-header">
                    <div class="resume-card-name">
                        ${resume.resume_name}
                        ${resume.is_default ? '<span class="default-badge">Default</span>' : ''}
                    </div>
                </div>
                <div class="resume-card-preview">
                    ${expCount} jobs ‚Ä¢ ${skillCount} skills${currentTitle ? ' ‚Ä¢ ' + currentTitle : ''}
                </div>
                ${skillsHtml}
                <div class="resume-card-actions">
                    ${!resume.is_default ? `<button class="btn-secondary" onclick="setDefaultResume('${resume.id}')">Set as Default</button>` : ''}
                    <button class="btn-danger-outline" onclick="deleteResume('${resume.id}', '${resume.resume_name}')">Delete</button>
                </div>
            `;

            return card;
        }

        // Open the upload modal
        function openResumeModal() {
            // Reset modal state
            newResumeName.value = '';
            modalResumeFile.value = '';
            modalFileName.textContent = '';
            modalFileName.classList.remove('show');
            modalParsingStatus.textContent = '';
            modalParsingStatus.className = 'parsing-status';
            accuracyConfirm.checked = false;
            saveResumeBtn.disabled = true;
            pendingResumeJson = null;

            resumeUploadModal.classList.add('show');
        }

        // Close the upload modal
        function closeModal() {
            resumeUploadModal.classList.remove('show');
            pendingResumeJson = null;
        }

        // Validate that new resume name matches existing resumes
        function validateResumeNameConsistency(newName) {
            if (!newName || newName === 'Unknown') return null;
            if (userResumes.length === 0) return null;

            // Normalize name for comparison (lowercase, trim)
            const normalize = (n) => n?.toLowerCase().trim() || '';
            const newNameNorm = normalize(newName);

            // Check against existing resumes
            for (const existing of userResumes) {
                const existingName = existing.resume_json?.contact?.full_name ||
                                    existing.resume_json?.full_name || '';
                const existingNorm = normalize(existingName);

                if (!existingNorm) continue;

                // Check if names are different (not just formatting differences)
                if (existingNorm && newNameNorm && existingNorm !== newNameNorm) {
                    // Check if it's a substantially different name (not just middle name difference)
                    const existingParts = existingNorm.split(' ').filter(p => p.length > 1);
                    const newParts = newNameNorm.split(' ').filter(p => p.length > 1);

                    // If first AND last names don't match, warn
                    const existingFirst = existingParts[0] || '';
                    const existingLast = existingParts[existingParts.length - 1] || '';
                    const newFirst = newParts[0] || '';
                    const newLast = newParts[newParts.length - 1] || '';

                    if (existingFirst !== newFirst || existingLast !== newLast) {
                        return `This resume shows "${newName}" but your existing resume shows "${existingName}". Please ensure this is your resume.`;
                    }
                }
            }

            return null; // No warning
        }

        // Update save button state
        function updateSaveButtonState() {
            const hasName = newResumeName.value.trim().length > 0;
            const hasResume = pendingResumeJson !== null;
            const hasConfirmation = accuracyConfirm.checked;

            saveResumeBtn.disabled = !(hasName && hasResume && hasConfirmation);
        }

        // Handle modal file upload
        async function handleModalFileUpload(file) {
            if (!file) return;

            modalFileName.textContent = `üìé ${file.name}`;
            modalFileName.classList.add('show');
            document.getElementById('modalFileUpload').classList.add('has-file');

            modalParsingStatus.textContent = `Uploading ${file.name}...`;
            modalParsingStatus.className = 'parsing-status show';

            try {
                const formData = new FormData();
                formData.append('file', file);

                const response = await fetch(`${API_BASE}/api/resume/parse`, {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    let errorDetail = errorText.substring(0, 200);
                    try {
                        const errorJson = JSON.parse(errorText);
                        if (errorJson.detail) {
                            errorDetail = typeof errorJson.detail === 'string' ? errorJson.detail : JSON.stringify(errorJson.detail);
                        }
                    } catch (e) {}
                    throw new Error(`Server ${response.status}: ${errorDetail}`);
                }

                modalParsingStatus.textContent = 'Processing...';
                pendingResumeJson = await response.json();

                const name = pendingResumeJson.contact?.full_name || pendingResumeJson.full_name || 'Unknown';
                const firstName = name.split(' ')[0];

                // Validate name consistency with existing resumes
                const nameWarning = validateResumeNameConsistency(name);
                if (nameWarning) {
                    modalParsingStatus.textContent = `‚ö†Ô∏è ${nameWarning}`;
                    modalParsingStatus.className = 'parsing-status show warning';
                } else {
                    modalParsingStatus.textContent = `‚úì Got it, ${firstName}!`;
                    modalParsingStatus.className = 'parsing-status show success';
                }

                // Auto-suggest a name if empty
                if (!newResumeName.value.trim()) {
                    const title = pendingResumeJson.current_title || pendingResumeJson.experience?.[0]?.title || '';
                    if (title) {
                        newResumeName.value = `${title} Resume`;
                    }
                }

                updateSaveButtonState();

            } catch (error) {
                console.error('Parse error:', error);
                let errorMsg = '‚úó ';
                if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
                    errorMsg += 'Network error - check your connection.';
                } else if (error.message.includes('Server 500')) {
                    errorMsg += 'Server error - please try again.';
                } else {
                    errorMsg += error.message;
                }
                modalParsingStatus.textContent = errorMsg;
                modalParsingStatus.className = 'parsing-status show error';
                pendingResumeJson = null;
                updateSaveButtonState();
            }
        }

        // Save the resume
        async function saveNewResume() {
            if (!pendingResumeJson || !newResumeName.value.trim() || !accuracyConfirm.checked) {
                return;
            }

            saveResumeBtn.disabled = true;
            saveResumeBtn.textContent = 'Saving...';

            try {
                console.log('Saving resume to Supabase...');
                const result = await HenryData.saveResume(
                    newResumeName.value.trim(),
                    pendingResumeJson,
                    true, // accuracy confirmed
                    userResumes.length === 0 // first resume is default
                );

                console.log('Save result:', result);

                if (!result || result.error) {
                    throw new Error(result?.error || 'Failed to save resume');
                }

                // Also save to localStorage for backwards compatibility
                if (!profile) profile = {};
                profile.resume = pendingResumeJson;
                localStorage.setItem('userProfile', JSON.stringify(profile));

                // Close modal and refresh list first
                closeModal();
                showSuccess('Resume saved successfully!');
                await loadResumes();

                // Run LinkedIn comparison if LinkedIn data exists (non-blocking)
                if (result.data?.id && profile?.linkedin_parsed) {
                    checkLinkedInAlignment(pendingResumeJson, result.data.id).catch(e => {
                        console.error('LinkedIn comparison error:', e);
                    });
                }

            } catch (error) {
                console.error('Save error:', error);
                showError(error.message || 'Failed to save resume');
            } finally {
                // Always reset button state
                saveResumeBtn.disabled = false;
                saveResumeBtn.textContent = 'Save Resume';
            }
        }

        // Set a resume as default
        async function setDefaultResume(resumeId) {
            try {
                const result = await HenryData.setDefaultResume(resumeId);
                if (result.error) {
                    throw new Error(result.error);
                }

                // Update localStorage with default resume
                const defaultResume = userResumes.find(r => r.id === resumeId);
                if (defaultResume && defaultResume.resume_json) {
                    if (!profile) profile = {};
                    profile.resume = defaultResume.resume_json;
                    localStorage.setItem('userProfile', JSON.stringify(profile));
                }

                showSuccess('Default resume updated');
                await loadResumes();
            } catch (error) {
                console.error('Error setting default:', error);
                showError(error.message || 'Failed to update default resume');
            }
        }

        // Delete a resume
        async function deleteResume(resumeId, resumeName) {
            if (!confirm(`Delete "${resumeName}"? This cannot be undone.`)) {
                return;
            }

            try {
                const result = await HenryData.deleteResume(resumeId);
                if (result.error) {
                    throw new Error(result.error);
                }

                showSuccess('Resume deleted');
                await loadResumes();

                // Update localStorage if we deleted the last resume
                if (userResumes.length === 0) {
                    if (profile) {
                        profile.resume = null;
                        localStorage.setItem('userProfile', JSON.stringify(profile));
                    }
                }
            } catch (error) {
                console.error('Error deleting resume:', error);
                showError(error.message || 'Failed to delete resume');
            }
        }

        // ==========================================
        // LinkedIn Cross-Reference Comparison
        // ==========================================

        function compareResumeToLinkedIn(resumeJson, linkedInData) {
            const mismatches = [];

            if (!linkedInData || !resumeJson) {
                return { hasMismatches: false, mismatches: [] };
            }

            // Get experience from both sources
            const resumeExperience = resumeJson.experience || [];
            const linkedInExperience = linkedInData.experience || linkedInData.positions || [];

            // Normalize company names for comparison
            const normalizeCompany = (name) => {
                if (!name) return '';
                return name.toLowerCase()
                    .replace(/,?\s*(inc\.?|llc|corp\.?|corporation|ltd\.?)$/i, '')
                    .replace(/[^\w\s]/g, '')
                    .trim();
            };

            // Normalize titles for comparison
            const normalizeTitle = (title) => {
                if (!title) return '';
                return title.toLowerCase()
                    .replace(/\s*(sr\.?|senior|jr\.?|junior|lead|principal|staff|associate)\s*/gi, ' ')
                    .replace(/\s+/g, ' ')
                    .trim();
            };

            // Build LinkedIn company map
            const linkedInCompanies = new Map();
            linkedInExperience.forEach(exp => {
                const company = normalizeCompany(exp.company || exp.companyName);
                if (company) {
                    linkedInCompanies.set(company, {
                        title: exp.title || exp.position,
                        rawTitle: exp.title || exp.position,
                        rawCompany: exp.company || exp.companyName,
                        dates: exp.dates || exp.dateRange || ''
                    });
                }
            });

            // Check each resume experience against LinkedIn
            resumeExperience.forEach(exp => {
                const resumeCompany = normalizeCompany(exp.company);
                const resumeTitle = exp.title || '';

                if (!resumeCompany) return;

                // Check if company exists on LinkedIn
                const linkedInMatch = linkedInCompanies.get(resumeCompany);

                if (!linkedInMatch) {
                    // Company not found on LinkedIn
                    mismatches.push({
                        type: 'missing_company',
                        resumeValue: exp.company,
                        linkedInValue: null,
                        message: `"${exp.company}" on your resume is not on your LinkedIn profile`
                    });
                } else {
                    // Company found - check title
                    const resumeTitleNorm = normalizeTitle(resumeTitle);
                    const linkedInTitleNorm = normalizeTitle(linkedInMatch.title);

                    // Check for title inflation (resume title seems higher than LinkedIn)
                    const seniorKeywords = ['vp', 'vice president', 'director', 'head of', 'chief', 'cto', 'ceo', 'coo', 'cfo'];
                    const resumeHasSenior = seniorKeywords.some(k => resumeTitleNorm.includes(k));
                    const linkedInHasSenior = seniorKeywords.some(k => linkedInTitleNorm.includes(k));

                    if (resumeHasSenior && !linkedInHasSenior && resumeTitleNorm !== linkedInTitleNorm) {
                        mismatches.push({
                            type: 'title_mismatch',
                            resumeValue: resumeTitle,
                            linkedInValue: linkedInMatch.rawTitle,
                            company: exp.company,
                            message: `Your resume says "${resumeTitle}" at ${exp.company}, but LinkedIn shows "${linkedInMatch.rawTitle}"`
                        });
                    }
                }
            });

            return {
                hasMismatches: mismatches.length > 0,
                mismatches: mismatches
            };
        }

        // Run comparison after resume upload if LinkedIn data exists
        async function checkLinkedInAlignment(resumeJson, resumeId) {
            // Get LinkedIn data from profile
            const linkedInData = profile?.linkedin_parsed;

            if (!linkedInData) {
                console.log('No LinkedIn data to compare against');
                return;
            }

            const comparison = compareResumeToLinkedIn(resumeJson, linkedInData);

            if (comparison.hasMismatches) {
                // Update the resume with verification notes
                await HenryData.updateResumeVerification(resumeId, false, {
                    mismatches: comparison.mismatches,
                    checkedAt: new Date().toISOString()
                });

                // Show warning to user
                const mismatchMessages = comparison.mismatches.map(m => `‚Ä¢ ${m.message}`).join('\n');
                const proceed = confirm(
                    `‚ö†Ô∏è We noticed some differences between your resume and LinkedIn:\n\n` +
                    `${mismatchMessages}\n\n` +
                    `Please confirm which is accurate. Click OK to keep the resume, or Cancel to review.`
                );

                if (!proceed) {
                    // User wants to review - could open edit modal or just highlight
                    console.log('User wants to review mismatches');
                }
            } else {
                // Mark as verified
                await HenryData.updateResumeVerification(resumeId, true, {
                    checkedAt: new Date().toISOString()
                });
            }
        }

        // Set up multi-resume event listeners
        if (addResumeBtn) {
            addResumeBtn.addEventListener('click', openResumeModal);
        }

        if (closeResumeModal) {
            closeResumeModal.addEventListener('click', closeModal);
        }

        // Close modal on background click
        if (resumeUploadModal) {
            resumeUploadModal.addEventListener('click', (e) => {
                if (e.target === resumeUploadModal) {
                    closeModal();
                }
            });
        }

        if (modalResumeFile) {
            modalResumeFile.addEventListener('change', (e) => {
                handleModalFileUpload(e.target.files[0]);
            });
        }

        if (newResumeName) {
            newResumeName.addEventListener('input', updateSaveButtonState);
        }

        if (accuracyConfirm) {
            accuracyConfirm.addEventListener('change', updateSaveButtonState);
        }

        if (saveResumeBtn) {
            saveResumeBtn.addEventListener('click', saveNewResume);
        }

        // Load existing profile - tries Supabase first, then localStorage
        async function loadProfile() {
            // Check if we're in forced onboarding mode (after reset)
            const needsOnboarding = localStorage.getItem('henryai_needs_onboarding') === 'true';
            if (needsOnboarding) {
                console.log('Forced onboarding mode - showing new profile setup');
                localStorage.removeItem('henryai_needs_onboarding');
                isNewProfile = true;
                setupNewProfileMode();
                return;
            }

            let profileData = null;

            // Try Supabase first if available
            if (typeof HenryData !== 'undefined') {
                try {
                    profileData = await HenryData.getCandidateProfile();
                    if (profileData) {
                        console.log('Loaded profile from Supabase');
                    }
                } catch (e) {
                    console.error('Error loading from Supabase:', e);
                }
            }

            // Fall back to localStorage if no Supabase data
            if (!profileData) {
                const stored = localStorage.getItem('userProfile');
                if (stored) {
                    try {
                        profileData = JSON.parse(stored);
                        console.log('Loaded profile from localStorage');
                    } catch (e) {
                        console.error('Failed to parse localStorage profile:', e);
                    }
                }
            }

            if (!profileData) {
                // New profile mode
                isNewProfile = true;
                setupNewProfileMode();
                return;
            }

            profile = profileData;
            setupEditMode();
            populateForm();
        }

        function setupNewProfileMode() {
            document.getElementById('pageTitle').textContent = 'Set Up Your Profile';
            document.getElementById('pageSubtitle').textContent = 'I need a few details to give you honest fit assessments and strategic positioning.';
            document.getElementById('backLink').style.display = 'none';
            document.getElementById('deleteBtn').style.display = 'none';
            document.getElementById('saveBtn').textContent = 'Save and Start My Job Search';
            // Show file upload, hide resume info
            document.getElementById('fileUpload').style.display = 'block';
            document.getElementById('resumeInfo').style.display = 'none';
        }

        function setupEditMode() {
            document.getElementById('pageTitle').textContent = 'Edit Your Profile';
            document.getElementById('pageSubtitle').textContent = 'Update your preferences anytime.';
            document.getElementById('backLink').style.display = 'block';
            document.getElementById('dangerZone').style.display = 'block';
            document.getElementById('saveBtn').textContent = 'Save Changes';
            // Hide legacy resume sections - multi-resume UI handles this now
            document.getElementById('fileUpload').style.display = 'none';
            document.getElementById('resumeInfo').style.display = 'none';
        }

        function populateForm() {
            // Resume info
            if (profile.resume) {
                const name = profile.resume.contact?.full_name || profile.resume.full_name || 'Unknown';
                resumeName.textContent = name;
                const expCount = profile.resume.experience?.length || 0;
                const skillCount = profile.resume.skills?.length || 0;
                resumeMeta.textContent = `${expCount} roles ¬∑ ${skillCount} skills`;

                // Pre-populate first/last name from resume if not already set
                if (!profile.first_name && !profile.last_name && name && name !== 'Unknown') {
                    const nameParts = name.trim().split(' ');
                    if (nameParts.length >= 2) {
                        document.getElementById('firstName').value = nameParts[0];
                        document.getElementById('lastName').value = nameParts.slice(1).join(' ');
                    } else if (nameParts.length === 1) {
                        document.getElementById('firstName').value = nameParts[0];
                    }
                }
            }

            // About You section - new fields
            document.getElementById('firstName').value = profile.first_name || document.getElementById('firstName').value || '';
            document.getElementById('lastName').value = profile.last_name || document.getElementById('lastName').value || '';
            document.getElementById('middleInitial').value = profile.middle_initial || '';
            document.getElementById('nameSuffix').value = profile.name_suffix || '';
            document.getElementById('nickname').value = profile.nickname || '';
            document.getElementById('pronouns').value = profile.pronouns || '';

            // Function Area
            if (profile.function_area) {
                document.getElementById('functionArea').value = profile.function_area;
            }

            // Current Industry
            if (profile.current_industry) {
                document.getElementById('currentIndustry').value = profile.current_industry;
            }

            // Secondary Industry (multi-industry)
            if (profile.secondary_industry) {
                document.getElementById('multiIndustry').checked = true;
                document.getElementById('secondaryIndustryGroup').style.display = 'block';
                document.getElementById('secondaryIndustry').value = profile.secondary_industry;
            }

            // Work Authorization
            if (profile.work_authorization) {
                document.getElementById('workAuthorization').value = profile.work_authorization;
                // Show sponsorship question for visa types that might require it
                const visaTypesRequiringSponsorship = ['h1b', 'h1b_transfer', 'l1', 'opt', 'opt_stem', 'other_visa'];
                if (visaTypesRequiringSponsorship.includes(profile.work_authorization)) {
                    document.getElementById('sponsorshipGroup').style.display = 'block';
                }
            }

            // Sponsorship Required
            if (profile.requires_sponsorship !== undefined) {
                const sponsorshipValue = profile.requires_sponsorship ? 'yes' : 'no';
                const option = document.querySelector(`#sponsorshipRequired .radio-option[data-value="${sponsorshipValue}"]`);
                if (option) {
                    option.classList.add('selected');
                    option.querySelector('input').checked = true;
                }
            }

            // Veteran Status
            if (profile.is_veteran) {
                document.getElementById('isVeteran').checked = true;
            }

            // Compensation (format as currency)
            if (profile.compensation) {
                document.getElementById('compMin').value = formatCurrency(profile.compensation.min);
                document.getElementById('compTarget').value = formatCurrency(profile.compensation.target);
                document.getElementById('compStretch').value = formatCurrency(profile.compensation.stretch);
            }

            // Work arrangement
            if (profile.work_arrangement) {
                workArrangements = profile.work_arrangement;
                workArrangements.forEach(value => {
                    const option = document.querySelector(`.checkbox-option[data-value="${value}"]`);
                    if (option) {
                        option.classList.add('selected');
                    }
                });
            }

            // Location - new structured fields
            if (profile.location) {
                // New structured fields
                document.getElementById('city').value = profile.location.city || '';
                document.getElementById('state').value = profile.location.state || '';
                document.getElementById('country').value = profile.location.country || '';

                // Backward compatibility - populate hidden field
                document.getElementById('currentLocation').value = profile.location.current || '';

                // If we have old-style current location but no structured, try to parse
                if (profile.location.current && !profile.location.city) {
                    const parts = profile.location.current.split(',').map(p => p.trim());
                    if (parts.length >= 2) {
                        document.getElementById('city').value = parts[0];
                        document.getElementById('state').value = parts[1];
                        if (!profile.location.country) {
                            document.getElementById('country').value = 'US'; // Default assumption
                        }
                    }
                }

                if (profile.location.open_to_relocate) {
                    const option = document.querySelector(`#relocateGroup .radio-option[data-value="${profile.location.open_to_relocate}"]`);
                    if (option) {
                        option.classList.add('selected');
                        option.querySelector('input').checked = true;
                        // Show relocate locations if yes or maybe
                        if (profile.location.open_to_relocate === 'yes' || profile.location.open_to_relocate === 'maybe') {
                            document.getElementById('relocateLocationsGroup').style.display = 'block';
                        }
                    }
                }

                relocateLocations = profile.location.relocate_to || [];
                renderRelocateLocations();
            }

            // Target Industries (What You're Looking For section)
            if (profile.target_industry_primary) {
                document.getElementById('targetIndustryPrimary').value = profile.target_industry_primary;
            }
            if (profile.target_industry_secondary) {
                document.getElementById('targetIndustrySecondary').value = profile.target_industry_secondary;
            }

            // Situation (dropdown-based)
            if (profile.situation) {
                if (profile.situation.holding_up) {
                    document.getElementById('holdingUp').value = profile.situation.holding_up;
                    showHenryResponse('holdingUp', profile.situation.holding_up);
                }
                if (profile.situation.timeline) {
                    document.getElementById('timeline').value = profile.situation.timeline;
                    showHenryResponse('timeline', profile.situation.timeline);
                }
                if (profile.situation.confidence) {
                    document.getElementById('confidence').value = profile.situation.confidence;
                    showHenryResponse('confidence', profile.situation.confidence);
                }
            }
        }

        // Henry's responses to each selection - real talk, not corporate comfort
        const henryResponses = {
            holdingUp: {
                doing_well: "Good. That's leverage. Let's use it.",
                stressed_but_managing: "Yeah, this market's rough. Let's be strategic so you're not just spraying applications.",
                struggling: "Appreciate the honesty. This market is brutal and it's not just you. Let's focus on what we can control.",
                rather_not_say: "Fair enough. Let's just get to work."
            },
            timeline: {
                no_rush: "That's the best position to be in. We can be picky.",
                actively_looking: "Solid timeline. Enough runway to be strategic, not desperate.",
                soon: "Okay, we need to move. I'll flag roles with faster hiring cycles.",
                urgent: "Got it. We'll move fast, but we're not settling for terrible roles just because you need something now."
            },
            confidence: {
                strong: "Good. You'll need that energy. Let's find roles that deserve it.",
                shaky: "Rejections hit different when you actually want the job. That's normal. Let's get some momentum going.",
                low: "Look, I've seen thousands of candidates. The ones who feel worst about themselves are rarely the ones who should. This market breaks people. It's not you.",
                need_validation: "You're not off-base. Ghost jobs are real. Companies ghost candidates constantly. The process is broken, not you."
            }
        };

        function showHenryResponse(field, value) {
            const responseEl = document.getElementById(field + 'Response');
            if (responseEl && henryResponses[field] && henryResponses[field][value]) {
                responseEl.textContent = henryResponses[field][value];
                responseEl.classList.add('show');
            } else if (responseEl) {
                responseEl.classList.remove('show');
            }
        }

        // Replace Resume button handler
        if (replaceResumeBtn) {
            replaceResumeBtn.addEventListener('click', () => {
                // Hide resume info, show upload area
                resumeInfo.style.display = 'none';
                fileUpload.style.display = 'flex';
                parsingStatus.textContent = '';
                parsingStatus.className = 'parsing-status';
                // Clear previous file selection
                resumeFile.value = '';
                const fileNameEl = document.getElementById('fileName');
                fileNameEl.textContent = '';
                fileNameEl.classList.remove('show');
                fileUpload.classList.remove('has-file');
            });
        }

        // Delete Resume button handler
        if (deleteResumeBtn) {
            deleteResumeBtn.addEventListener('click', async () => {
                if (!confirm('Are you sure you want to delete your resume? This cannot be undone.')) {
                    return;
                }

                try {
                    const response = await fetch(`${API_BASE}/api/profile/resume`, {
                        method: 'DELETE',
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('access_token')}`
                        }
                    });

                    if (!response.ok) throw new Error('Failed to delete resume');

                    // Clear local profile resume data
                    if (profile) {
                        profile.resume = null;
                        profile.resume_output = null;
                    }

                    // Reset UI to show upload area
                    resumeInfo.style.display = 'none';
                    fileUpload.style.display = 'flex';
                    parsingStatus.textContent = '';
                    parsingStatus.className = 'parsing-status';
                    resumeFile.value = '';
                    const fileNameEl = document.getElementById('fileName');
                    fileNameEl.textContent = '';
                    fileNameEl.classList.remove('show');
                    fileUpload.classList.remove('has-file');

                    showSuccess('Resume deleted successfully');
                } catch (error) {
                    console.error('Delete error:', error);
                    showError('Failed to delete resume. Please try again.');
                }
            });
        }

        // File upload handler (works for both new and edit)
        resumeFile.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            // Show file name
            const fileNameEl = document.getElementById('fileName');
            fileNameEl.textContent = `üìé ${file.name}`;
            fileNameEl.classList.add('show');
            fileUpload.classList.add('has-file');

            parsingStatus.textContent = `Uploading ${file.name} (${(file.size / 1024).toFixed(0)}KB)...`;
            parsingStatus.className = 'parsing-status show';

            try {
                const formData = new FormData();
                formData.append('file', file);

                const response = await fetch(`${API_BASE}/api/resume/parse`, {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    // Try to parse error detail from JSON response
                    let errorDetail = errorText.substring(0, 200);
                    try {
                        const errorJson = JSON.parse(errorText);
                        if (errorJson.detail) {
                            if (typeof errorJson.detail === 'string') {
                                errorDetail = errorJson.detail;
                            } else if (errorJson.detail.missing_fields) {
                                errorDetail = `Missing: ${errorJson.detail.missing_fields.join(', ')}`;
                            } else if (errorJson.detail.summary) {
                                errorDetail = errorJson.detail.summary;
                            }
                        }
                    } catch (e) {}
                    throw new Error(`Server ${response.status}: ${errorDetail}`);
                }

                parsingStatus.textContent = 'Processing...';
                const parsedResume = await response.json();

                // Initialize profile if new
                if (!profile) {
                    profile = {};
                }
                profile.resume = parsedResume;

                // Save resume to localStorage immediately so it persists if page reloads
                // (e.g., after LinkedIn upload triggers a refresh)
                try {
                    const existingProfile = JSON.parse(localStorage.getItem('userProfile') || '{}');
                    existingProfile.resume = parsedResume;
                    localStorage.setItem('userProfile', JSON.stringify(existingProfile));
                    console.log('Resume saved to localStorage');
                } catch (e) {
                    console.error('Error saving resume to localStorage:', e);
                }

                const name = parsedResume.contact?.full_name || parsedResume.full_name || 'Unknown';
                const firstName = name.split(' ')[0];
                parsingStatus.textContent = `‚úì Got it, ${firstName}!`;
                parsingStatus.className = 'parsing-status show success';

                // Update display for edit mode
                resumeName.textContent = name;
                const expCount = parsedResume.experience?.length || 0;
                const skillCount = parsedResume.skills?.length || 0;
                resumeMeta.textContent = `${expCount} roles ¬∑ ${skillCount} skills`;

                // In edit mode, hide the legacy file upload (multi-resume UI handles display)
                if (!isNewProfile) {
                    fileUpload.style.display = 'none';
                    // Legacy resumeInfo is hidden - multi-resume list shows resumes
                }

            } catch (error) {
                console.error('Parse error:', error);
                let errorMsg = '‚úó ';
                if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError') || error.message.includes('Load failed')) {
                    errorMsg += 'Network error - check your connection and try again.';
                } else if (error.message.includes('Server 500')) {
                    errorMsg += 'Server error - please try again in a moment.';
                } else if (error.message.includes('Server 413')) {
                    errorMsg += 'File too large - please use a smaller file.';
                } else if (error.message.includes('Server')) {
                    errorMsg += error.message;
                } else {
                    errorMsg += `Error: ${error.message}. Try PDF or DOCX format.`;
                }
                parsingStatus.textContent = errorMsg;
                parsingStatus.className = 'parsing-status show error';
            }
        });

        // Dropdown change listeners for Henry responses
        ['holdingUp', 'timeline', 'confidence'].forEach(field => {
            const select = document.getElementById(field);
            if (select) {
                select.addEventListener('change', (e) => {
                    showHenryResponse(field, e.target.value);
                });
            }
        });

        // Multi-industry checkbox toggle
        const multiIndustryCheckbox = document.getElementById('multiIndustry');
        const secondaryIndustryGroup = document.getElementById('secondaryIndustryGroup');
        if (multiIndustryCheckbox) {
            multiIndustryCheckbox.addEventListener('change', (e) => {
                secondaryIndustryGroup.style.display = e.target.checked ? 'block' : 'none';
                if (!e.target.checked) {
                    document.getElementById('secondaryIndustry').value = '';
                }
            });
        }

        // Work authorization change - show sponsorship question for visa types
        const workAuthorizationSelect = document.getElementById('workAuthorization');
        const sponsorshipGroup = document.getElementById('sponsorshipGroup');
        if (workAuthorizationSelect) {
            workAuthorizationSelect.addEventListener('change', (e) => {
                const visaTypesRequiringSponsorship = ['h1b', 'h1b_transfer', 'l1', 'opt', 'opt_stem', 'other_visa'];
                if (visaTypesRequiringSponsorship.includes(e.target.value)) {
                    sponsorshipGroup.style.display = 'block';
                } else {
                    sponsorshipGroup.style.display = 'none';
                    // Auto-set to "no sponsorship required" for US citizens, green card holders, TN visa
                    document.querySelectorAll('#sponsorshipRequired .radio-option').forEach(o => o.classList.remove('selected'));
                }
            });
        }

        // Load user email and name from Supabase auth
        async function loadUserAuthData() {
            // Wait for HenryAuth to be available
            const waitForAuth = () => {
                return new Promise((resolve) => {
                    if (typeof HenryAuth !== 'undefined') {
                        resolve();
                    } else {
                        const check = setInterval(() => {
                            if (typeof HenryAuth !== 'undefined') {
                                clearInterval(check);
                                resolve();
                            }
                        }, 50);
                        // Timeout after 3 seconds
                        setTimeout(() => {
                            clearInterval(check);
                            resolve();
                        }, 3000);
                    }
                });
            };

            await waitForAuth();

            if (typeof HenryAuth !== 'undefined') {
                try {
                    const session = await HenryAuth.getSession();
                    const emailInput = document.getElementById('userEmail');

                    if (session?.user?.email) {
                        emailInput.value = session.user.email;
                        emailInput.placeholder = '';
                    } else {
                        emailInput.value = '';
                        emailInput.placeholder = 'Not logged in';
                    }

                    // Load name from auth metadata (set during signup)
                    const nameData = await HenryAuth.getUserName();
                    if (nameData) {
                        const firstNameInput = document.getElementById('firstName');
                        const lastNameInput = document.getElementById('lastName');

                        // Only auto-populate if the fields are empty (don't override saved profile data)
                        if (!firstNameInput.value && nameData.firstName) {
                            firstNameInput.value = nameData.firstName;
                        }
                        if (!lastNameInput.value && nameData.lastName) {
                            lastNameInput.value = nameData.lastName;
                        }
                    }
                } catch (e) {
                    console.error('Error loading user auth data:', e);
                    document.getElementById('userEmail').placeholder = 'Error loading email';
                }
            } else {
                console.error('HenryAuth not available');
                document.getElementById('userEmail').placeholder = 'Auth not available';
            }
        }
        loadUserAuthData();

        // Radio/Checkbox handlers
        document.querySelectorAll('.radio-group').forEach(group => {
            group.querySelectorAll('.radio-option').forEach(option => {
                option.addEventListener('click', () => {
                    // Deselect all in group
                    group.querySelectorAll('.radio-option').forEach(o => o.classList.remove('selected'));
                    // Select this one
                    option.classList.add('selected');
                    option.querySelector('input').checked = true;

                    // Show/hide relocate locations based on answer
                    if (group.id === 'relocateGroup') {
                        const value = option.dataset.value;
                        const relocateLocationsGroup = document.getElementById('relocateLocationsGroup');
                        relocateLocationsGroup.style.display = (value === 'yes' || value === 'maybe') ? 'block' : 'none';
                    }
                });
            });
        });

        document.querySelectorAll('.checkbox-option').forEach(option => {
            option.addEventListener('click', (e) => {
                e.preventDefault();
                option.classList.toggle('selected');
                
                // Update workArrangements array
                workArrangements = Array.from(document.querySelectorAll('.checkbox-option.selected'))
                    .map(o => o.dataset.value);
            });
        });

        // Relocate location handling
        const relocateLocationInput = document.getElementById('relocateLocationInput');
        const addRelocateLocationBtn = document.getElementById('addRelocateLocationBtn');
        const relocateLocationTags = document.getElementById('relocateLocationTags');

        addRelocateLocationBtn.addEventListener('click', () => {
            const location = relocateLocationInput.value.trim();
            if (location && !relocateLocations.includes(location)) {
                relocateLocations.push(location);
                renderRelocateLocations();
                relocateLocationInput.value = '';
            }
        });

        relocateLocationInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                addRelocateLocationBtn.click();
            }
        });

        function renderRelocateLocations() {
            relocateLocationTags.innerHTML = relocateLocations.map((loc, index) => `
                <span class="location-tag">
                    ${loc}
                    <button type="button" onclick="removeRelocateLocation(${index})">√ó</button>
                </span>
            `).join('');
        }

        function removeRelocateLocation(index) {
            relocateLocations.splice(index, 1);
            renderRelocateLocations();
        }
        window.removeRelocateLocation = removeRelocateLocation;

        // Helper function for radio groups (relocate still uses radio)
        function getSelectedRadioValue(groupId) {
            const selected = document.querySelector(`#${groupId} .radio-option.selected`);
            return selected ? selected.dataset.value : null;
        }

        // Save changes
        saveBtn.addEventListener('click', async () => {
            // Clear previous errors
            errorMessage.classList.remove('show');

            // Validate required fields
            const firstName = document.getElementById('firstName').value.trim();
            const lastName = document.getElementById('lastName').value.trim();
            const functionArea = document.getElementById('functionArea').value;
            const currentIndustry = document.getElementById('currentIndustry').value;
            const workAuthorization = document.getElementById('workAuthorization').value;

            if (!firstName || !lastName) {
                errorMessage.textContent = 'Please enter your first and last name.';
                errorMessage.classList.add('show');
                window.scrollTo({ top: 0, behavior: 'smooth' });
                return;
            }

            if (!functionArea) {
                errorMessage.textContent = 'Please select your function area.';
                errorMessage.classList.add('show');
                window.scrollTo({ top: 0, behavior: 'smooth' });
                return;
            }

            if (!currentIndustry) {
                errorMessage.textContent = 'Please select your current industry.';
                errorMessage.classList.add('show');
                window.scrollTo({ top: 0, behavior: 'smooth' });
                return;
            }

            if (!workAuthorization) {
                errorMessage.textContent = 'Please select your work authorization status.';
                errorMessage.classList.add('show');
                window.scrollTo({ top: 0, behavior: 'smooth' });
                return;
            }

            // Validate required fields for new profile
            if (isNewProfile) {
                if (!profile || !profile.resume) {
                    errorMessage.textContent = 'Please upload your resume first.';
                    errorMessage.classList.add('show');
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                    return;
                }
                if (!document.getElementById('timeline').value) {
                    errorMessage.textContent = 'Please select your timeline.';
                    errorMessage.classList.add('show');
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                    return;
                }
            }

            try {
                if (!profile) profile = {};

                // Merge any LinkedIn data that may have been saved during this session
                const storedProfile = localStorage.getItem('userProfile');
                if (storedProfile) {
                    try {
                        const parsed = JSON.parse(storedProfile);
                        // Only merge LinkedIn fields, preserve our resume data
                        if (parsed.linkedin_profile_uploaded) {
                            profile.linkedin_profile_uploaded = parsed.linkedin_profile_uploaded;
                            profile.linkedin_last_updated = parsed.linkedin_last_updated;
                            profile.linkedin_parsed = parsed.linkedin_parsed;
                        }
                    } catch (e) {
                        console.error('Error merging stored profile:', e);
                    }
                }

                // About You section - new fields
                profile.first_name = firstName;
                profile.last_name = lastName;
                profile.middle_initial = document.getElementById('middleInitial').value.trim().toUpperCase() || null;
                profile.name_suffix = document.getElementById('nameSuffix').value || null;
                profile.nickname = document.getElementById('nickname').value.trim() || null;
                profile.pronouns = document.getElementById('pronouns').value.trim() || null;
                profile.function_area = functionArea;
                profile.current_industry = currentIndustry;

                // Secondary industry (if multi-industry selected)
                if (document.getElementById('multiIndustry').checked) {
                    profile.secondary_industry = document.getElementById('secondaryIndustry').value || null;
                } else {
                    profile.secondary_industry = null;
                }

                // Work authorization
                profile.work_authorization = workAuthorization;

                // Sponsorship required (for visa types)
                const visaTypesRequiringSponsorship = ['h1b', 'h1b_transfer', 'l1', 'opt', 'opt_stem', 'other_visa'];
                if (visaTypesRequiringSponsorship.includes(workAuthorization)) {
                    profile.requires_sponsorship = getSelectedRadioValue('sponsorshipRequired') === 'yes';
                } else {
                    profile.requires_sponsorship = false;
                }

                // Veteran status
                profile.is_veteran = document.getElementById('isVeteran').checked;

                // Compensation
                profile.compensation = {
                    min: parseCurrency(document.getElementById('compMin').value),
                    target: parseCurrency(document.getElementById('compTarget').value),
                    stretch: parseCurrency(document.getElementById('compStretch').value)
                };

                profile.work_arrangement = workArrangements;

                // Location - structured + backward compatible
                const city = document.getElementById('city').value.trim();
                const state = document.getElementById('state').value.trim();
                const country = document.getElementById('country').value;

                // Build current location string for backward compatibility
                let currentLocationStr = '';
                if (city && state) {
                    currentLocationStr = `${city}, ${state}`;
                } else if (city) {
                    currentLocationStr = city;
                }

                profile.location = {
                    current: currentLocationStr,
                    city: city || null,
                    state: state || null,
                    country: country || null,
                    open_to_relocate: getSelectedRadioValue('relocateGroup'),
                    relocate_to: relocateLocations
                };

                // Target industries (What You're Looking For)
                profile.target_industry_primary = document.getElementById('targetIndustryPrimary').value || null;
                profile.target_industry_secondary = document.getElementById('targetIndustrySecondary').value || null;

                profile.situation = {
                    holding_up: document.getElementById('holdingUp').value || null,
                    timeline: document.getElementById('timeline').value || null,
                    confidence: document.getElementById('confidence').value || null
                };

                if (isNewProfile) {
                    profile.created_at = new Date().toISOString();
                }
                profile.updated_at = new Date().toISOString();

                // Save to localStorage as fallback
                localStorage.setItem('userProfile', JSON.stringify(profile));

                // Save to Supabase if available
                if (typeof HenryData !== 'undefined') {
                    const { error } = await HenryData.saveCandidateProfile(profile);
                    if (error) {
                        console.error('Error saving to Supabase:', error);
                    } else {
                        console.log('Profile saved to Supabase');
                    }
                }

                // Initialize tracker if new
                if (!localStorage.getItem('trackedApplications')) {
                    localStorage.setItem('trackedApplications', JSON.stringify([]));
                }

                // Redirect based on whether this is initial profile setup or update
                if (isNewProfile) {
                    // First-time profile setup - go to dashboard for Hey Henry first action prompt
                    window.location.href = 'dashboard.html?from=profile-setup';
                } else {
                    // Existing profile update - go to analyze page
                    window.location.href = 'analyze.html';
                }

            } catch (error) {
                console.error('Save error:', error);
                errorMessage.textContent = 'Failed to save changes: ' + error.message;
                errorMessage.classList.add('show');
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        });

        // Reset Profile handlers
        const resetModal = document.getElementById('resetModal');
        const resetConfirmInput = document.getElementById('resetConfirmInput');
        const confirmResetBtn = document.getElementById('confirmResetBtn');

        document.getElementById('resetProfileBtn').addEventListener('click', () => {
            resetConfirmInput.value = '';
            confirmResetBtn.disabled = true;
            resetModal.classList.add('show');
            resetConfirmInput.focus();
        });

        // Enable reset button only when user types "RESET"
        resetConfirmInput.addEventListener('input', () => {
            confirmResetBtn.disabled = resetConfirmInput.value.trim().toUpperCase() !== 'RESET';
        });

        document.getElementById('cancelResetBtn').addEventListener('click', () => {
            resetModal.classList.remove('show');
            resetConfirmInput.value = '';
        });

        document.getElementById('confirmResetBtn').addEventListener('click', async () => {
            if (resetConfirmInput.value.trim().toUpperCase() !== 'RESET') return;

            try {
                // Clear Supabase data if available
                if (typeof HenryData !== 'undefined') {
                    const session = await HenryAuth.getSession();
                    if (session) {
                        // Delete all applications
                        await HenryData.deleteAllApplications();
                        // Delete candidate profile
                        await HenryData.deleteCandidateProfile();
                        console.log('Cleared Supabase data');
                    }
                }

                // Clear localStorage
                localStorage.removeItem('userProfile');
                localStorage.removeItem('trackedApplications');
                localStorage.removeItem('upcomingInterviews');
                localStorage.removeItem('completedInterviews');
                localStorage.removeItem('resumeConversation');
                localStorage.removeItem('celebratedMilestones');
                localStorage.removeItem('interventionState');
                // Clear analysis_ and documents_ prefixed items
                for (let i = localStorage.length - 1; i >= 0; i--) {
                    const key = localStorage.key(i);
                    if (key && (key.startsWith('analysis_') || key.startsWith('documents_'))) {
                        localStorage.removeItem(key);
                    }
                }
                sessionStorage.clear();

                // Mark as needing onboarding and redirect
                localStorage.setItem('henryai_needs_onboarding', 'true');
                window.location.href = 'profile-edit.html';
            } catch (error) {
                console.error('Reset error:', error);
                errorMessage.textContent = 'Failed to reset profile: ' + error.message;
                errorMessage.classList.add('show');
                resetModal.classList.remove('show');
            }
        });

        resetModal.addEventListener('click', (e) => {
            if (e.target === resetModal) {
                resetModal.classList.remove('show');
                resetConfirmInput.value = '';
            }
        });

        // Delete Account handlers - Two-step confirmation
        const deleteFinalModal = document.getElementById('deleteFinalModal');
        const deleteConfirmInput = document.getElementById('deleteConfirmInput');
        const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');

        document.getElementById('deleteAccountBtn').addEventListener('click', () => {
            deleteModal.classList.add('show');
        });

        document.getElementById('cancelDeleteBtn').addEventListener('click', () => {
            deleteModal.classList.remove('show');
        });

        // Step 1: User clicks "Yes, Delete My Account" -> Show final confirmation
        document.getElementById('proceedDeleteBtn').addEventListener('click', () => {
            deleteModal.classList.remove('show');
            deleteConfirmInput.value = '';
            confirmDeleteBtn.disabled = true;
            deleteFinalModal.classList.add('show');
            deleteConfirmInput.focus();
        });

        // Enable delete button only when user types "DELETE MY ACCOUNT"
        deleteConfirmInput.addEventListener('input', () => {
            confirmDeleteBtn.disabled = deleteConfirmInput.value.trim().toUpperCase() !== 'DELETE MY ACCOUNT';
        });

        document.getElementById('cancelDeleteFinalBtn').addEventListener('click', () => {
            deleteFinalModal.classList.remove('show');
            deleteConfirmInput.value = '';
        });

        // Step 2: Final deletion
        document.getElementById('confirmDeleteBtn').addEventListener('click', async () => {
            if (deleteConfirmInput.value.trim().toUpperCase() !== 'DELETE MY ACCOUNT') return;

            try {
                // Clear Supabase data if available
                if (typeof HenryData !== 'undefined' && typeof HenryAuth !== 'undefined') {
                    const session = await HenryAuth.getSession();
                    if (session) {
                        // Delete all applications
                        await HenryData.deleteAllApplications();
                        // Delete candidate profile
                        await HenryData.deleteCandidateProfile();
                        // Sign out and delete user (note: full account deletion requires admin API)
                        await HenryAuth.signOut();
                        console.log('Signed out and cleared Supabase data');
                    }
                }

                // Clear all localStorage
                localStorage.clear();
                sessionStorage.clear();

                // Redirect to landing page
                window.location.href = 'index.html';
            } catch (error) {
                console.error('Delete account error:', error);
                errorMessage.textContent = 'Failed to delete account: ' + error.message;
                errorMessage.classList.add('show');
                deleteFinalModal.classList.remove('show');
            }
        });

        // Close modals on overlay click
        deleteModal.addEventListener('click', (e) => {
            if (e.target === deleteModal) {
                deleteModal.classList.remove('show');
            }
        });

        deleteFinalModal.addEventListener('click', (e) => {
            if (e.target === deleteFinalModal) {
                deleteFinalModal.classList.remove('show');
                deleteConfirmInput.value = '';
            }
        });

        // Initialize will be called after Supabase is loaded
    </script>

    <!-- Auth scripts - must load before initialization -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/supabase-client.js"></script>
    <script>
        // Initialize after Supabase is available
        (async function() {
            // Check authentication
            if (typeof HenryAuth !== 'undefined') {
                const session = await HenryAuth.getSession();
                if (!session) {
                    // Not logged in, redirect to login
                    window.location.href = 'login.html';
                    return;
                }
            }

            // Now load the profile
            await loadProfile();

            // Load multi-resume list
            await loadResumes();
        })();
    </script>
    <script src="components/analytics.js"></script>
<script src="components/hey-henry.js"></script>
    <script src="components/strategy-nav.js"></script>
    <script src="components/status-banner.js"></script>

    <!-- LinkedIn Upload Feature -->
    <link rel="stylesheet" href="css/linkedin.css">
    <script src="js/linkedin-upload.js"></script>
    <script>
        // Initialize LinkedIn section on profile page
        document.addEventListener('DOMContentLoaded', () => {
            if (window.linkedInUpload) {
                window.linkedInUpload.renderProfileSection('linkedin-profile-status');
            }
        });
    </script>
<script src="components/top-nav.js"></script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document Library | HenryHQ</title>

    <!-- PWA Meta Tags -->
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#000000">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="HenryHQ">
    <link rel="apple-touch-icon" href="/assets/icons/icon-192x192.svg">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Instrument+Serif:ital@0;1&family=DM+Sans:opsz,wght@9..40,400;9..40,500;9..40,600&display=swap" rel="stylesheet">

    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/supabase-client.js"></script>

    <style>
        :root {
            --color-bg: #0a0a0b;
            --color-surface: #141416;
            --color-surface-elevated: #1c1c1f;
            --color-border: rgba(255, 255, 255, 0.08);
            --color-border-hover: rgba(255, 255, 255, 0.15);
            --color-text: #fafafa;
            --color-text-secondary: #a1a1aa;
            --color-text-muted: #52525b;
            --color-accent: #22d3ee;
            --color-accent-muted: rgba(34, 211, 238, 0.15);
            --color-success: #4ade80;
            --color-warning: #fbbf24;
            --color-error: #f87171;
            --font-display: 'Instrument Serif', Georgia, serif;
            --font-body: 'DM Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: var(--font-body);
            background: var(--color-bg);
            color: var(--color-text);
            min-height: 100vh;
        }

        .page-container {
            max-width: 900px;
            margin: 0 auto;
            padding: 40px 24px 80px;
        }

        .page-header {
            margin-bottom: 40px;
        }

        .page-title {
            font-family: var(--font-display);
            font-size: 2rem;
            font-weight: 400;
            margin-bottom: 8px;
        }

        .page-subtitle {
            color: var(--color-text-secondary);
            font-size: 0.95rem;
            line-height: 1.5;
        }

        .doc-count {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            margin-top: 12px;
            padding: 6px 12px;
            background: var(--color-accent-muted);
            color: var(--color-accent);
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        /* Document Cards */
        .doc-grid {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .doc-card {
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: 12px;
            padding: 24px;
            transition: border-color 0.2s;
        }

        .doc-card:hover {
            border-color: var(--color-border-hover);
        }

        .doc-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 16px;
        }

        .doc-card-company {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--color-text);
        }

        .doc-card-role {
            color: var(--color-text-secondary);
            font-size: 0.9rem;
            margin-top: 2px;
        }

        .doc-card-date {
            color: var(--color-text-muted);
            font-size: 0.8rem;
            white-space: nowrap;
        }

        .doc-card-badges {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
        }

        .doc-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .doc-badge-resume {
            background: rgba(34, 211, 238, 0.1);
            color: #22d3ee;
        }

        .doc-badge-cover {
            background: rgba(74, 222, 128, 0.1);
            color: #4ade80;
        }

        .doc-badge-icon {
            font-size: 0.9rem;
        }

        .doc-card-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .doc-action-btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            border: none;
            transition: all 0.2s;
            text-decoration: none;
        }

        .doc-action-btn-primary {
            background: var(--color-accent);
            color: #000;
        }

        .doc-action-btn-primary:hover {
            opacity: 0.9;
        }

        .doc-action-btn-secondary {
            background: var(--color-surface-elevated);
            color: var(--color-text);
            border: 1px solid var(--color-border);
        }

        .doc-action-btn-secondary:hover {
            border-color: var(--color-border-hover);
        }

        /* Fit Score */
        .doc-card-fit {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .fit-high { background: rgba(74, 222, 128, 0.15); color: #4ade80; }
        .fit-medium { background: rgba(251, 191, 36, 0.15); color: #fbbf24; }
        .fit-low { background: rgba(248, 113, 113, 0.15); color: #f87171; }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 80px 24px;
        }

        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .empty-state-title {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .empty-state-text {
            color: var(--color-text-secondary);
            font-size: 0.9rem;
            line-height: 1.5;
            margin-bottom: 24px;
            max-width: 400px;
            margin-left: auto;
            margin-right: auto;
        }

        .empty-state-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 12px 24px;
            background: var(--color-accent);
            color: #000;
            border: none;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            text-decoration: none;
            transition: opacity 0.2s;
        }

        .empty-state-btn:hover {
            opacity: 0.9;
        }

        /* Loading State */
        .loading-state {
            text-align: center;
            padding: 60px 24px;
            color: var(--color-text-secondary);
        }

        .loading-spinner {
            width: 32px;
            height: 32px;
            border: 3px solid var(--color-border);
            border-top-color: var(--color-accent);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin: 0 auto 16px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .page-container { padding: 24px 16px 80px; }
            .page-title { font-size: 1.5rem; }
            .doc-card { padding: 16px; }
            .doc-card-header { flex-direction: column; gap: 4px; }
            .doc-card-actions { flex-direction: column; }
            .doc-action-btn { justify-content: center; }
        }
    </style>
    <link rel="stylesheet" href="css/mobile.css">
    <!-- Beta Access Gate -->
    <script>
        if (localStorage.getItem('beta_verified') !== 'true') {
            window.location.href = '/beta-access';
        }
    </script>
</head>
<body>
    <div class="page-container">
        <div class="page-header">
            <h1 class="page-title">Document Library</h1>
            <p class="page-subtitle">Your tailored resumes and cover letters, organized by role.</p>
        </div>

        <div id="libraryContent">
            <div class="loading-state">
                <div class="loading-spinner"></div>
                <div>Loading your documents...</div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const container = document.getElementById('libraryContent');
            let apps = [];

            try {
                // Primary: load from Supabase
                if (typeof HenryData !== 'undefined') {
                    apps = await HenryData.getApplications();
                }
            } catch (err) {
                console.warn('Could not load from Supabase:', err);
            }

            // Fallback: load from localStorage
            if (apps.length === 0) {
                try {
                    const stored = localStorage.getItem('applications');
                    if (stored) {
                        apps = JSON.parse(stored);
                    }
                } catch (e) { /* skip */ }
            }

            // Filter to apps that have documents
            const appsWithDocs = apps.filter(app => {
                // Check Supabase documentsData
                if (app.documentsData && Object.keys(app.documentsData).length > 0) {
                    return true;
                }
                // Check localStorage for documents key
                const company = app.company || '';
                const role = app.role || '';
                if (company && role) {
                    const docKey = `documents_${company}_${role}`.toLowerCase().replace(/[^a-z0-9_]/g, '_');
                    if (localStorage.getItem(docKey)) {
                        return true;
                    }
                }
                return false;
            });

            if (appsWithDocs.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìÑ</div>
                        <div class="empty-state-title">No documents generated yet</div>
                        <div class="empty-state-text">
                            Analyze a role to create tailored resumes and cover letters. Each analysis generates ATS-optimized documents specific to the role.
                        </div>
                        <a href="/analyze" class="empty-state-btn">Analyze a Role</a>
                    </div>
                `;
                return;
            }

            // Sort by most recent first (documentsData may have a date, otherwise use dateApplied)
            appsWithDocs.sort((a, b) => {
                const dateA = a.documentsData?.generated_at || a.dateApplied || '';
                const dateB = b.documentsData?.generated_at || b.dateApplied || '';
                return dateB.localeCompare(dateA);
            });

            // Render header count
            let html = `<div class="doc-count">üìÑ ${appsWithDocs.length} role${appsWithDocs.length !== 1 ? 's' : ''} with documents</div>`;
            html += '<div class="doc-grid" style="margin-top: 20px;">';

            appsWithDocs.forEach(app => {
                const company = app.company || 'Unknown Company';
                const role = app.role || 'Unknown Role';
                const fitScore = app.fitScore || app.fit_score;
                const dateApplied = app.dateApplied || app.date_applied || '';

                // Determine which documents are available
                const hasResume = !!(app.documentsData?.resume || app.documentsData?.canonical_document);
                const hasCoverLetter = !!(app.documentsData?.cover_letter);

                // If we can't tell from documentsData, check localStorage
                let hasLocalDocs = false;
                if (!hasResume && !hasCoverLetter) {
                    const docKey = `documents_${company}_${role}`.toLowerCase().replace(/[^a-z0-9_]/g, '_');
                    hasLocalDocs = !!localStorage.getItem(docKey);
                }

                // Fit score badge
                let fitBadge = '';
                if (fitScore) {
                    const score = typeof fitScore === 'object' ? fitScore.score : fitScore;
                    if (score) {
                        const fitClass = score >= 70 ? 'fit-high' : score >= 50 ? 'fit-medium' : 'fit-low';
                        fitBadge = `<span class="doc-card-fit ${fitClass}">${score}% fit</span>`;
                    }
                }

                // Format date
                let dateStr = '';
                if (dateApplied) {
                    try {
                        const d = new Date(dateApplied);
                        dateStr = d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                    } catch (e) {
                        dateStr = dateApplied;
                    }
                }

                // Build analysis key for navigation
                const analysisKey = app.analysisKey || app.id || '';

                html += `
                    <div class="doc-card">
                        <div class="doc-card-header">
                            <div>
                                <div class="doc-card-company">${escapeHtml(company)} ${fitBadge}</div>
                                <div class="doc-card-role">${escapeHtml(role)}</div>
                            </div>
                            ${dateStr ? `<div class="doc-card-date">${dateStr}</div>` : ''}
                        </div>
                        <div class="doc-card-badges">
                            ${(hasResume || hasLocalDocs) ? '<span class="doc-badge doc-badge-resume"><span class="doc-badge-icon">üìù</span> Resume</span>' : ''}
                            ${(hasCoverLetter || hasLocalDocs) ? '<span class="doc-badge doc-badge-cover"><span class="doc-badge-icon">‚úâÔ∏è</span> Cover Letter</span>' : ''}
                        </div>
                        <div class="doc-card-actions">
                            <button class="doc-action-btn doc-action-btn-primary" onclick="viewDocument('${escapeAttr(analysisKey)}', '${escapeAttr(company)}', '${escapeAttr(role)}', 'resume')">
                                View Resume
                            </button>
                            <button class="doc-action-btn doc-action-btn-secondary" onclick="viewDocument('${escapeAttr(analysisKey)}', '${escapeAttr(company)}', '${escapeAttr(role)}', 'coverLetter')">
                                View Cover Letter
                            </button>
                        </div>
                    </div>
                `;
            });

            html += '</div>';
            container.innerHTML = html;
        });

        function viewDocument(analysisKey, company, role, docType) {
            // Load analysis data into sessionStorage
            if (analysisKey) {
                const analysisData = localStorage.getItem(analysisKey);
                if (analysisData) {
                    sessionStorage.setItem('analysisData', analysisData);
                }
            }

            // Load documents data into sessionStorage
            const docKey = `documents_${company}_${role}`.toLowerCase().replace(/[^a-z0-9_]/g, '_');
            const docData = localStorage.getItem(docKey);
            if (docData) {
                sessionStorage.setItem('documentsData', docData);
            }

            // Set tab preference if cover letter
            if (docType === 'coverLetter') {
                sessionStorage.setItem('switchToTab', 'coverLetter');
            } else {
                sessionStorage.removeItem('switchToTab');
            }

            window.location.href = '/documents';
        }

        function escapeHtml(str) {
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }

        function escapeAttr(str) {
            return str.replace(/'/g, "\\'").replace(/"/g, '&quot;');
        }
    </script>
<script src="components/analytics.js"></script>
<script src="components/hey-henry.js"></script>
<script src="components/admin-alerts.js"></script>
<script src="components/strategy-nav.js"></script>
    <script src="components/status-banner.js"></script>
<script src="components/top-nav.js"></script>
</body>
</html>
